Attribute VB_Name = "repRecibos"
Option Explicit

'Global Const Version = "2.01"
'Global Const FechaModificacion = "28/03/2006"
'Global Const UltimaModificacion = " " '

'Global Const Version = "2.02"
'Global Const FechaModificacion = "17/04/2006"
'Global Const UltimaModificacion = " " '

'Global Const Version = "2.03"
'Global Const FechaModificacion = "19/04/2006"
'Global Const UltimaModificacion = " " '

'Global Const Version = "2.04"
'Global Const FechaModificacion = "20/04/2006"
'Global Const UltimaModificacion = " " 'La 1 columna del confrep se puede configurar como un concepto o un acumulador (Sueldo).

'Global Const Version = "2.05"
'Global Const FechaModificacion = "21/04/2006"
'Global Const UltimaModificacion = " " 'La 1 columna del confrep se puede configurar como un concepto o un acumulador (Sueldo).

'Global Const Version = "2.06"
'Global Const FechaModificacion = "24/04/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 42.

'Global Const Version = "2.07"
'Global Const FechaModificacion = "02/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 43 - BNP Paribas Argentina.

'Global Const Version = "2.08"
'Global Const FechaModificacion = "10/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 44 - Liggett

'Global Const Version = "2.09"
'Global Const FechaModificacion = "11/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 45 - REDEPA.

'Global Const Version = "2.10"
'Global Const FechaModificacion = "19/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 46 - Distribuidora Metropolitana S.R.L

'Global Const Version = "2.11"
'Global Const FechaModificacion = "29/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 48 - Codere

'Global Const Version = "2.12"
'Global Const FechaModificacion = "31/05/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 49 - Tetra Nueva version

'Global Const Version = "2.13"
'Global Const FechaModificacion = "01/06/2006"
'Global Const UltimaModificacion = " " 'Se modifico el recibo 41 paolini: fecha alta reconocidad y alta

'Global Const Version = "2.14"
'Global Const FechaModificacion = "03/06/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 50 - Divino - Uruguay - nueva version

'Global Const Version = "2.15"
'Global Const FechaModificacion = "07/06/2006"
'Global Const UltimaModificacion = " " 'Se agrego un nuevo recibo de Sueldo 51 - Darmex

'Global Const Version = "2.16"
'Global Const FechaModificacion = "14/06/2006"
'Global Const UltimaModificacion = " " 'Retoques al recibo de Sueldo 13 - Halliburton

'Global Const Version = "2.17"
'Global Const FechaModificacion = "20/06/2006"
'Global Const UltimaModificacion = " " 'Retoques al recibo de Sueldo 12 - IHSA

'Global Const Version = "2.17"
'Global Const FechaModificacion = "20/06/2006"
'Global Const UltimaModificacion = " " 'Retoques al recibo de Sueldo 12 - IHSA, Agregado de logs

'Global Const Version = "2.18"
'Global Const FechaModificacion = "04/07/2006"
'Global Const UltimaModificacion = " " 'FAF - Se agrego un nuevo recibo de Sueldo 52 - Aadi-Capif

'Global Const Version = "2.19"
'Global Const FechaModificacion = "05/07/2006"
'Global Const UltimaModificacion = " " 'NF - Modificaciones a recibo de Sueldo 51 - Darmex

'Global Const Version = "2.20"
'Global Const FechaModificacion = "06/07/2006"
'Global Const UltimaModificacion = " " 'FAF - Modificaciones a recibo de Sueldo 39 - Marsh

'Global Const Version = "2.21"
'Global Const FechaModificacion = "11/07/2006"
'Global Const UltimaModificacion = " " 'FAF - Modificaciones a recibo de Sueldo 42 - Megatone
                                      ' Se agrego mid(direccion, 1, 100) y mid(localidad, 1, 100) de todos los modelos
                                      ' Se agrego la ultima sql ejecutada en el log de todos los modelos
'Global Const Version = "2.22"
'Global Const FechaModificacion = "14/07/2006"
'Global Const UltimaModificacion = " " 'FAF - Modificaciones al recibo de Sueldo 39 - Marsh -
                                      ' La fecha de baja sale de la ultima fase marcada como real.
'Global Const Version = "2.23"
'Global Const FechaModificacion = "17/07/2006"
'Global Const UltimaModificacion = " " 'FAF - Modificaciones al recibo de Sueldo 40 - BIA -
'                                      ' Se cambio el tipo de estructura para Departamento. De Categoria a Departamento.

'Global Const Version = "2.24"
'Global Const FechaModificacion = "17/07/2006"
'Global Const UltimaModificacion = " " 'FGZ - Modificaciones en sub main:
                                      ' Cint() por Clng()
                                      ' mensajes de log con cada parametro

'Global Const Version = "2.25"
'Global Const FechaModificacion = "01/08/2006"
'Global Const UltimaModificacion = " " 'LA. - Modificaciones al recibo de Sueldo 50 - Divino - Uruguay - Se le saco la coma a los numeros decimales, se hicieron chequeos de variables y vhora se calcula con info de col44 en lugar de 43

'Global Const Version = "2.26"
'Global Const FechaModificacion = "04/08/2006"
'Global Const UltimaModificacion = " " 'LA. - Modificaciones al recibo de Sueldo 50 - Divino - Uruguay - Los Tipos de Documento  RUC y BPS se pasan a traves del confrep y se saacaron los tipos de documentos MISS y BSE

'Global Const Version = "2.27"
'Global Const FechaModificacion = "09/08/2006"
'Global Const UltimaModificacion = " " 'FAF - Modificaciones al recibo de Sueldo 52 - Se cambio la fecha de pago por la fecha planeada

'Global Const Version = "2.28"
'Global Const FechaModificacion = "14/08/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro en el modelo 37 telearte se busco la desc del periodo

'Global Const Version = "2.29"
'Global Const FechaModificacion = "17/08/2006"
'Global Const UltimaModificacion = " " 'FGZ - Modificaciones al recibo de Sueldo 20 - DTT" -
'                                      ' ahora controlo por nulo o vacio - If Not EsNulo(rsConsult!ctabnro) Then

'Global Const Version = "2.30"
'Global Const FechaModificacion = "17/08/2006"
'Global Const UltimaModificacion = " " 'HDS - Se agregaron Flog.writeline para verificar contenido
                                      'de la variable CuentaBancaria

'Global Const Version = "2.31"
'Global Const FechaModificacion = "18/08/2006"
'Global Const UltimaModificacion = " " 'FAF - Se agregaron 3 columnas en el confrep 90 91 92
                                      
'Global Const Version = "2.32"
'Global Const FechaModificacion = "23/08/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Se creo el modelo 53 para mercado Central

'Global Const Version = "2.33"
'Global Const FechaModificacion = "15/09/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Se creo el modelo 54 para Union de Paris

'Global Const Version = "2.34"
'Global Const FechaModificacion = "13/09/2006"
'Global Const UltimaModificacion = " " 'Leticia A. - Se modifico Recibo 50 - Divino - Uruguay - se especificaron las cols 42-43-44 para tickets-v. hora - sueldo

'Global Const Version = "2.35"
'Global Const FechaModificacion = "26/09/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Recibo 54 - Buscar la direccion del empleado

'Global Const Version = "2.36"
'Global Const FechaModificacion = "27/09/2006"
'Global Const UltimaModificacion = " " 'FAF - Se creo el modelo 55 para CCU
'                                      'FAF - Se creo el modelo 56 para Finca

'Global Const Version = "2.37"
'Global Const FechaModificacion = "02/10/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Modelo 01 - Agregue en direccion de la empresa piso y dpto
                                      
'Global Const Version = "2.38"
'Global Const FechaModificacion = "05/10/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - modelo 54 - Agregue en direccion de la empresa piso y dpto
                                      
'Global Const Version = "2.39"
'Global Const FechaModificacion = "18/10/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - modelo 19 - Agregue en direccion de la empresa piso y dpto
                                      
'Global Const Version = "2.40"
'Global Const FechaModificacion = "19/10/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Se creo Modelo de 57 para Latin3

'Global Const Version = "2.41"
'Global Const FechaModificacion = "24/10/2006"
'Global Const UltimaModificacion = " " 'Diego Rosso - Se creo Modelo de 58 para horvath
                                      
'Global Const Version = "2.42"
'Global Const FechaModificacion = "26/10/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Se creo Modelo de 59 para Praxair a partir del 50
                                      
'Global Const Version = "2.43"
'Global Const FechaModificacion = "03/11/2006"
'Global Const UltimaModificacion = " " 'Martin Ferraro - Se creo Modelo de 60 para gedas
                                      
'Global Const Version = "2.44"
'Global Const FechaModificacion = "05/11/2006"
'Global Const UltimaModificacion = " " 'Diego Rosso - Se creo Modelo de 61 para AGD
                                      
'Global Const Version = "2.45"
'Global Const FechaModificacion = "17/11/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se modifico el modelo de 56. Calculo del Sueldo Basico.
                                      
'Global Const Version = "2.46"
'Global Const FechaModificacion = "20/11/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se modifico el modelo 56. No salia el Banco de Pago.
                                      
'Global Const Version = "2.47"
'Global Const FechaModificacion = "23/11/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se agrego el modelo 62 para A.C.A.R.A.
                                      
'Global Const Version = "2.48"
'Global Const FechaModificacion = "23/11/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se modifico el modelo 46. Se agrego OS elegida y el Nro de recibo (cliqnro).
                                      
'Global Const Version = "2.49"
'Global Const FechaModificacion = "12/12/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se agrego el modelo 63 para EKI.

'Global Const Version = "2.50"
'Global Const FechaModificacion = "15/01/2006"
'Global Const UltimaModificacion = " " 'Fernando Favre - Se agrego el modelo 64 para Gorina.

Global Const Version = "2.51"
Global Const FechaModificacion = "06/02/2006"
Global Const UltimaModificacion = " " 'Fernando Favre - Se agrego el modelo 65 para Teleperformance Chile.
'--------------------------------------------------------------------------------------
'--------------------------------------------------------------------------------------

Dim fs, f
'Global Flog

'11/03/2004 - Scarpa D. - Correccion al buscar el monto del sueldo

Dim NroLinea As Long
Dim crpNro As Long
Dim RegLeidos As Long
Dim RegError As Long
Dim RegFecha As Date
Dim NroProceso As Long

Global Path As String
Global NArchivo As String
Global Rta
Global HuboErrores As Boolean
Global EmpErrores As Boolean
Global arrTipoConc(1 To 1000) As Long

Global tenro1 As Long
Global estrnro1 As Long
Global tenro2 As Long
Global estrnro2 As Long
Global tenro3 As Long
Global estrnro3 As Long
Global fecEstr As String
Global tipoRecibo As Long
Global acumSubTotalRemun As Long
Global zonaDomicilio0
Global zonaDomicilio1
Global zonaDomicilio2
Global Tickets As Long
Global Gratificacion As Long
Global SueldoRecibo As Long
Global esSueldoRecibo As Long
Global esTicketsConc As Long
Global esSueldoConc As Long
Global esGratificacionConc As Long

Global tidDNRP

Global acumGrupo1(1 To 100) As Long
Global acumGrupo2(1 To 100) As Long
Global acumGrupo3(1 To 100) As Long
Global cantAcumGrupo1 As Long
Global cantAcumGrupo2 As Long
Global cantAcumGrupo3 As Long

Global acumHaberesConAp
Global acumNetoImp
Global acumRetImpuesto
Global acumAuxDeci1
Global acumAuxDeci2
Global acumAuxDeci3

Global concnroVacPend As Long
Global paramVacPend As Long

Global arrFormaPago(1 To 1000) As Long

Private Sub Main()

Dim NombreArchivo As String
Dim Directorio As String
Dim CArchivos
Dim archivo
Dim Folder
Dim strCmdLine As String
Dim Nombre_Arch As String

Dim StrSql As String
Dim objRs As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim objRs3 As New ADODB.Recordset
Dim fechadesde
Dim fechahasta
Dim tipoDepuracion
Dim historico As Boolean
Dim param
Dim listapronro
Dim Pronro
Dim ternro
Dim arrpronro
Dim rsEmpl As New ADODB.Recordset
Dim acunroSueldo
Dim I
Dim totalEmpleados
Dim cantRegistros
Dim PID As String
Dim tituloReporte As String
Dim parametros As String
Dim ArrParametros
Dim strTempo As String
Dim orden
Dim generoRecibo As Boolean

    On Error GoTo CE

    strCmdLine = Command()
    ArrParametros = Split(strCmdLine, " ", -1)
    If UBound(ArrParametros) > 0 Then
        If IsNumeric(ArrParametros(0)) Then
            NroProcesoBatch = ArrParametros(0)
            Etiqueta = ArrParametros(1)
        Else
            Exit Sub
        End If
    Else
        
        If IsNumeric(strCmdLine) Then
            NroProcesoBatch = strCmdLine
        Else
            Exit Sub
        End If
    End If
    
    NroProceso = NroProcesoBatch
    
    ' carga las configuraciones basicas, formato de fecha, string de conexion,
    ' tipo de BD y ubicacion del archivo de log
    Call CargarConfiguracionesBasicas
    tituloReporte = ""

    TiempoInicialProceso = GetTickCount

    OpenConnection strconexion, objConn
    
    HuboErrores = False
    
    Nombre_Arch = PathFLog & "RecibosSueldo" & "-" & NroProceso & ".log"
    
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set Flog = fs.CreateTextFile(Nombre_Arch, True)
    
    'Obtengo la cantidad de empledos a procesar
    StrSql = "SELECT * FROM batch_proceso WHERE bpronro = " & NroProceso
    OpenRecordset StrSql, objRs
    
    cantRegistros = CLng(objRs!bprcempleados)
    totalEmpleados = cantRegistros
    
    objRs.Close
   
    Flog.writeline "Inicio Proceso de Recibos de Sueldo : " & Now
    Flog.writeline "Cambio el estado del proceso a Procesando"
    
    'Obtengo el Process ID
    PID = GetCurrentProcessId
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline "Version = " & Version
    Flog.writeline "Modificacion = " & UltimaModificacion
    Flog.writeline "Fecha = " & FechaModificacion
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline
    
    
    'Cambio el estado del proceso a Procesando
    StrSql = "UPDATE batch_proceso SET bprchorainicioej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecinicioej = " & ConvFecha(Date) & ", bprcestado = 'Procesando', bprcprogreso = 0, bprcpid = " & PID & " WHERE bpronro = " & NroProceso
    objConn.Execute StrSql, , adExecuteNoRecords
    
    Flog.writeline "Obtengo los datos del proceso"
    
    TiempoAcumulado = GetTickCount
    
    'Obtengo los datos del proceso
    StrSql = "SELECT * FROM batch_proceso WHERE bpronro = " & NroProceso
    OpenRecordset StrSql, objRs
    
    If Not objRs.EOF Then
       'Obtengo los parametros del proceso
       parametros = objRs!bprcparam
       
       Flog.writeline "Parametros del proceso: " & parametros
       
       ArrParametros = Split(parametros, "@")
       
       'Obtengo la lista de procesos
       listapronro = ArrParametros(0)
       
       tipoRecibo = CLng(ArrParametros(1))
       
       tenro1 = CLng(ArrParametros(2))
       estrnro1 = CLng(ArrParametros(3))
       tenro2 = CLng(ArrParametros(4))
       estrnro2 = CLng(ArrParametros(5))
       tenro3 = CLng(ArrParametros(6))
       estrnro3 = CLng(ArrParametros(7))
       fecEstr = ArrParametros(8)
       
       'Armo el titulo del reporte
       strTempo = ArrParametros(9)
       
       ArrParametros = Split(strTempo, "<br>")
       If UBound(ArrParametros) >= 1 Then
          tituloReporte = ArrParametros(1)
       Else
          tituloReporte = ""
       End If
       
       ArrParametros = Split(ArrParametros(0), "- Periodos")
       tituloReporte = ArrParametros(0) & tituloReporte
       
       'EMPIEZA EL PROCESO
       
       'Busco la configuracion del confrep
       Flog.writeline "Obtengo los datos del confrep"
       
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60"
       OpenRecordset StrSql, objRs2
       If objRs2.EOF Then
          Flog.writeline "No esta configurado el ConfRep"
          Exit Sub
       End If

       acunroSueldo = 0
       zonaDomicilio0 = 1
       zonaDomicilio1 = 1
       zonaDomicilio2 = 1
       tidDNRP = 0
       cantAcumGrupo1 = 0
       cantAcumGrupo2 = 0
       cantAcumGrupo3 = 0
       
       concnroVacPend = 0
       paramVacPend = 0
       
       esTicketsConc = True
       Tickets = 0
       esGratificacionConc = True
       Gratificacion = 0
       
       esSueldoRecibo = True
       SueldoRecibo = 0
       
       acumHaberesConAp = 0
       acumNetoImp = 0
       acumRetImpuesto = 0
       
       acumAuxDeci1 = 0
       acumAuxDeci2 = 0
       acumAuxDeci3 = 0
       
       Do Until objRs2.EOF
          Flog.writeline "Columna " & objRs2!confnrocol
          Select Case objRs2!confnrocol
             Case 1
                'Busco en el confrep el numero de cuenta que se va a usar para
                'buscar el valor del sueldo
                If objRs2!conftipo = "CO" Then
                   esSueldoConc = True
                  
                    StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     acunroSueldo = 0
                   Else
                     acunroSueldo = objRs3!concnro
                   End If
                  
                   objRs3.Close
                Else
                   esSueldoConc = False
                   acunroSueldo = objRs2!confval
                End If
             
             Case 30
                'zonaDomicilio 0
                zonaDomicilio0 = objRs2!confval
             Case 31
                'zonaDomicilio 1
                zonaDomicilio1 = objRs2!confval
             Case 32
                'zonaDomicilio 2
                zonaDomicilio2 = objRs2!confval
             Case 41
                'Nro. de tipo de documento del DNRP
                tidDNRP = objRs2!confval
             
             Case 42
                'Concepto o Acum de Tickets
                If objRs2!conftipo = "CO" Then
                   esTicketsConc = True
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     Tickets = 0
                   Else
                     Tickets = objRs3!concnro
                   End If
                  
                   objRs3.Close
                Else
                   esTicketsConc = False
                   Tickets = objRs2!confval
                End If
             
             Case 43
                'Concepto o Acum de Gratificaciones
                Gratificacion = objRs2!confval2
                If objRs2!conftipo = "CO" Then
                   esGratificacionConc = True
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     Gratificacion = 0
                   Else
                     Gratificacion = objRs3!concnro
                   End If
                  
                   objRs3.Close
                Else
                   esGratificacionConc = False
                   Gratificacion = objRs2!confval
                End If
             Case 44
                'Concepto o Acum de Sueldo
                SueldoRecibo = objRs2!confval2
                If objRs2!conftipo = "CO" Then
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     SueldoRecibo = 0
                   Else
                     SueldoRecibo = objRs3!concnro
                   End If
                  
                   objRs3.Close
                Else
                   esSueldoRecibo = False
                   SueldoRecibo = objRs2!confval
                End If
             Case 50
                'acumGrupo 1
                cantAcumGrupo1 = cantAcumGrupo1 + 1
                acumGrupo1(cantAcumGrupo1) = objRs2!confval
             Case 51
                'acumGrupo 2
                cantAcumGrupo2 = cantAcumGrupo2 + 1
                acumGrupo2(cantAcumGrupo2) = objRs2!confval
             Case 52
                'acumGrupo 3
                cantAcumGrupo3 = cantAcumGrupo3 + 1
                acumGrupo3(cantAcumGrupo3) = objRs2!confval
             Case 53
                  'Busco el concnro del concepto
                  StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                  If Not EsNulo(objRs2!confval2) Then
                    StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  End If
                  OpenRecordset StrSql, objRs3
                  
                  If objRs3.EOF Then
                     concnroVacPend = 0
                  Else
                     concnroVacPend = objRs3!concnro
                  End If
                  
                  objRs3.Close
             Case 54
                  paramVacPend = objRs2!confval
             
             Case 60
                'Busco el acumulador de haberes con aportes
                acumHaberesConAp = objRs2!confval
                
             Case 61
                'Busco el acumulador de netos imponibles
                acumNetoImp = objRs2!confval
                
             Case 62
                'Busco el acumulador de ret. impuesto
                acumRetImpuesto = objRs2!confval
                
             Case 80
                'Busco el acumulador de acumAuxDeci1
                acumAuxDeci1 = objRs2!confval

             Case 81
                'Busco el acumulador de acumAuxDeci2
                acumAuxDeci2 = objRs2!confval
    
             Case 82
                'Busco el acumulador de acumAuxDeci3
                acumAuxDeci3 = objRs2!confval
                
          End Select
       
          objRs2.MoveNext
       Loop
       
       objRs2.Close
       
       'Inicializo los tipos de conceptos
       For I = 1 To 1000
           arrTipoConc(I) = 0
       Next

       Flog.writeline "Busco el tipo de cada concepto "
       'Busco el tipo de cada concepto
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60 "
       OpenRecordset StrSql, objRs2
       acumSubTotalRemun = 0

       Do Until objRs2.EOF
           Flog.writeline "Tipo encontrado " & objRs2!conftipo & " en Columna: " & objRs2!confnrocol
           Select Case objRs2!conftipo
              'Remunerativo
              Case "RE"
                 arrTipoConc(objRs2!confval) = 1
              'No Remunerativo
              Case "NR"
                 arrTipoConc(objRs2!confval) = 2
              'Descuento
              Case "DS"
                 arrTipoConc(objRs2!confval) = 3
              'Sub. Total Remunerativo
              Case "ST"
                 acumSubTotalRemun = objRs2!confval
           End Select
        
           objRs2.MoveNext
        Loop
        
        objRs2.Close
        
       'Inicializo las forma de pago
       For I = 1 To 1000
           arrFormaPago(I) = 0
       Next

       'Busco el tipo de cada concepto
       
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60 AND confnrocol >= 60"

       OpenRecordset StrSql, objRs2
       
       acumSubTotalRemun = 0

       Do Until objRs2.EOF
           
           If objRs2!conftipo = "FP" Then
              Flog.writeline "FP encontrada en Columna " & objRs2!confnrocol & " con valor " & objRs2!confval2
              arrFormaPago(objRs2!confval) = objRs2!confval2
           End If
        
           objRs2.MoveNext
       Loop
       objRs2.Close
        
        
       'Obtengo los empleados sobre los que tengo que generar los recibos
       Flog.writeline "Obtengo los empleados sobre los que tengo que generar los recibos"
       Call CargarEmpleados(NroProceso, rsEmpl)
       
       Flog.writeline "Inicializo progreso"
       StrSql = "UPDATE batch_proceso SET bprcprogreso = 0 " & _
                   ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                   ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
       objConn.Execute StrSql, , adExecuteNoRecords
       
       orden = 0
       
       Flog.writeline "Genero por cada empleado un recibo de sueldo"
       'Genero por cada empleado un recibo de sueldo
       Do Until rsEmpl.EOF
          Flog.writeline "Lista de procesos " & listapronro
          Flog.writeline "tercero " & rsEmpl!ternro
          
          arrpronro = Split(listapronro, ",")
          EmpErrores = False
          ternro = rsEmpl!ternro
          generoRecibo = False
                    
          'Genero un recibo de sueldo para el empleado por cada proceso
          Flog.writeline "Genero un recibo de sueldo para el empleado por cada proceso"
          For I = 0 To UBound(arrpronro)
             Pronro = arrpronro(I)
             
             If tieneConceptosImprimibles(ternro, Pronro) Then
                Flog.writeline "Generando recibo de sueldo para el tercero " & ternro & " para el proceso " & Pronro
                generoRecibo = True
             
                'De acuerdo al tipo del recibo son los datos que se guardan en la tabla
                Flog.writeline "Tipo de recibo: " & tipoRecibo
                Select Case tipoRecibo
                 Case 1
                    'Generacion del recibo estandar
                    Call generarDatosRecibo01(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 2
                    'Generacion del recibo para Temaiken
                    Call generarDatosRecibo02(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 3
                    'Generacion del recibo para Accor
                    Call generarDatosRecibo03(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 4
                    'Generacion del recibo para Jugos
                    Call generarDatosRecibo04(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 5
                    'Generacion del recibo para Citrusvil
                    Call generarDatosRecibo05(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 6
                    'Generacion del recibo para Dabra
                    Call generarDatosRecibo06(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 7
                    'Generacion del recibo para TelePerformance
                    Call generarDatosRecibo07(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 8
                    'Generacion del recibo para Norton
                    Call generarDatosRecibo08(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 9
                    'Generacion del recibo para Deloitte - con Zona Domicilio 0
                    Call generarDatosRecibo09(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 10
                    'Generacion del recibo para Deloitte - con Zona Domicilio 1
                    Call generarDatosRecibo09(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio1)
                 Case 11
                    'Generacion del recibo para Deloitte - con Zona Domicilio 2
                    Call generarDatosRecibo09(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio2)
                 Case 12
                    'Generacion del recibo para Gestion Compartida
                    Call generarDatosRecibo12(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 13
                    'Generacion del recibo para Halliburton
                    Call generarDatosRecibo13(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 14
                    'Generacion del recibo de Indura
                    Call generarDatosRecibo14(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 15
                    'Generacion del recibo para Roche - con Zona Domicilio 0
                    Call generarDatosRecibo15(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 16
                    'Generacion del recibo para Roche - con Zona Domicilio 1
                    Call generarDatosRecibo15(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio1)
                 Case 17
                    'Generacion del recibo para Roche - con Zona Domicilio 2
                    Call generarDatosRecibo15(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio2)
                 Case 18
                    'Generacion del recibo para Estrada
                    Call generarDatosRecibo18(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 19
                    'Generacion del recibo para IMSA
                    Call generarDatosRecibo19(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 20
                    'Generacion del recibo para Roche 2
                    Call generarDatosRecibo20(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 21
                    'Generacion del recibo para Flecha Bus
                    Call generarDatosRecibo21(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 22
                    'Generacion del recibo para Uruguay
                    Call generarDatosRecibo22(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 23
                    'Generacion del recibo para Deloitte Personal
                    Call generarDatosRecibo23(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 24
                    'Generacion del recibo para Las Lenas
                    Call generarDatosRecibo24(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 25
                    'Generacion del recibo para TTI
                    Call generarDatosRecibo25(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 26
                    'Generacion del recibo para Schering
                    Call generarDatosRecibo26(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 27
                    'Generacion del recibo para Indra
                    Call generarDatosRecibo27(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 28
                    'Generacion del recibo para TTI - Edenor
                    Call generarDatosRecibo28(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 29
                    'Generacion del recibo para Glencore
                    Call generarDatosRecibo29(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 30
                    'Generacion del recibo para Tetrapak
                    Call generarDatosRecibo30(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 31
                    'Generacion del recibo para Cia. Alimentos
                    Call generarDatosRecibo31(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 32
                    'Generacion del recibo para Sitel
                    Call generarDatosRecibo32(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 33
                    'Generacion del recibo para Bazar Avenida
                    Call generarDatosRecibo33(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 34
                    'Generacion del recibo para Ampacet
                    Call generarDatosRecibo34(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 35
                    'Generacion del recibo para Andreani Logistica
                    Call generarDatosRecibo35(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 36
                    'Generacion del recibo para Wella
                    Call generarDatosRecibo36(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 37
                    'Generacion del recibo para Telearte
                    Call generarDatosRecibo37(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 38
                    'Generacion del recibo para Carsa
                    Call generarDatosRecibo38(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 39
                    'Generacion del recibo para Marsh
                    Call generarDatosRecibo39(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 40
                    'Generacion del recibo para BIA (Banco Industrial Azul)
                    Call generarDatosRecibo40(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 41
                    'Generacion del recibo para Paolini
                    Call generarDatosRecibo41(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 42
                    'Generacion del recibo para Red Megatone
                    Call generarDatosRecibo42(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 43
                    'Generacion del recibo para BNP Paribas Argentina
                    Call generarDatosRecibo43(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 44
                    'Generacion del recibo para LIGGETT
                    Call generarDatosRecibo44(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 45
                    'Generacion del recibo para REDEPA
                    Call generarDatosRecibo45(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 46
                    'Generacion del recibo para Distribuidora Metropolitana
                    Call generarDatosRecibo46(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 48
                    'Generacion del recibo para Codere
                    Call generarDatosRecibo48(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 49
                    'Generacion del recibo para nueva version tetra
                    Call generarDatosRecibo49(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 50
                    'Generacion del recibo para Divino - Uruguay
                    Call generarDatosRecibo50(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 51
                    'Generacion del recibo para Darmex
                    Call generarDatosRecibo51(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 52
                    'Generacion del recibo para Aadi-Capif
                    Call generarDatosRecibo52(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 53
                    'Generacion del recibo para Mercado Central
                    Call generarDatosRecibo53(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 54
                    'Generacion del recibo para L'Union de Paris
                    Call generarDatosRecibo54(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 55
                    'Generacion del recibo para CCU
                    Call generarDatosRecibo55(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 56
                    'Generacion del recibo para CCU - Finca
                    Call generarDatosRecibo56(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 57
                    'Generacion del recibo para Latin
                    Call generarDatosRecibo57(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 58
                    'Generacion del recibo de Horvath
                    Call generarDatosRecibo58(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 59
                    'Generacion del recibo de Praxair
                    Call generarDatosRecibo59(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 60
                    'Generacion del recibo de Gedas
                    Call generarDatosRecibo60(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 61
                    'Generacion del recibo de AGD
                    Call generarDatosRecibo61(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 62
                    'Generacion del recibo de A.C.A.R.A.
                    Call generarDatosRecibo62(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 63
                    'Generacion del recibo de EKI
                    Call generarDatosRecibo63(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 64
                    'Generacion del recibo de Gorina
                    Call generarDatosRecibo64(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case 65
                    'Generacion del recibo para TelePerformance Chile
                    Call generarDatosRecibo65(Pronro, ternro, acunroSueldo, tituloReporte, orden)
                 Case Else
                    Flog.writeline "No se encontro el modelo [" & tipoRecibo & "]"
                 End Select
            Else
                Flog.writeline "El tercero " & ternro & " no tiene conceptos imprimibles para el proceso " & Pronro
            End If
             
        Next
          
        If generoRecibo Then
            orden = orden + 1
        End If
             
        'Actualizo el estado del proceso
        TiempoAcumulado = GetTickCount
           
        cantRegistros = cantRegistros - 1
        
        StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Fix(((totalEmpleados - cantRegistros) * 100) / totalEmpleados) & _
                    ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                    ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
           
        objConn.Execute StrSql, , adExecuteNoRecords
         
        'Si se generaron todos los recibos de sueldo del empleado correctamente lo borro
        If Not EmpErrores Then
              StrSql = " DELETE FROM batch_empleado "
              StrSql = StrSql & " WHERE bpronro = " & NroProceso
              StrSql = StrSql & " AND ternro = " & ternro
    
              objConn.Execute StrSql, , adExecuteNoRecords
        End If
        rsEmpl.MoveNext
    Loop
Else
    Exit Sub
End If
   
    If Not HuboErrores Then
        'Actualizo el estado del proceso
        StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Procesado' WHERE bpronro = " & NroProceso
    Else
        StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Incompleto' WHERE bpronro = " & NroProceso
    End If
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    Flog.writeline "Fin :" & Now
    Flog.Close

    Exit Sub
    
CE:
    HuboErrores = True
    Flog.writeline "************************************************************"
    Flog.writeline " Error: " & Err.Description & Now
    Flog.writeline " Ultimo sql ejecutado: " & StrSql
    Flog.writeline "************************************************************"
End Sub


Public Sub bus_Anti0(ternro, pliqanio, pliqmes, ByRef dia As Integer, ByRef mes As Integer, ByRef Anio As Integer)

Dim q As Integer

Dim FechaAux As Date

    Bien = False
    Valor = 0
        
    If pliqmes = 12 Then
        FechaAux = CDate("1/1/" & pliqanio + 1) - 1
    Else
        FechaAux = CDate("01/" & pliqmes + 1 & "/" & pliqanio) - 1
    End If
        
    Call bus_Antiguedad(ternro, "REAL", FechaAux, dia, mes, Anio, q)
    
End Sub


Public Sub bus_Antiguedad(ByVal ternro As Integer, ByVal TipoAnt As String, ByVal fechafin As String, ByRef dia As Integer, ByRef mes As Integer, ByRef Anio As Integer, ByRef DiasHabiles As Integer)

Dim aux1 As Long
Dim aux2 As Long
Dim aux3 As Long
Dim fecalta As Date
Dim fecbaja As Date
Dim seguir As Date
Dim q As Integer

Dim NombreCampo As String

Dim rs_Fases As New ADODB.Recordset

NombreCampo = ""
DiasHabiles = 0

Select Case UCase(TipoAnt)
Case "SUELDO":
    NombreCampo = "sueldo"
Case "INDEMNIZACION":
    NombreCampo = "indemnizacion"
Case "VACACIONES":
    NombreCampo = "vacaciones"
Case "REAL":
    NombreCampo = "real"
Case Else
End Select


' FGZ -27/01/2004
StrSql = "SELECT * FROM fases WHERE empleado = " & ternro & _
         " AND " & NombreCampo & " = -1 " & _
         " AND not altfec is null " & _
         " AND not (bajfec is null AND estado = 0)" & _
         " AND altfec <= " & ConvFecha(fechafin)

OpenRecordset StrSql, rs_Fases

Do While Not rs_Fases.EOF
    fecalta = rs_Fases!altfec
    
    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
    If rs_Fases!estado Then
        fecbaja = fechafin ' solo es un alta, tomar el fecha-fin
    ElseIf rs_Fases!bajfec <= fechafin Then
        fecbaja = rs_Fases!bajfec  ' se trata de un registro completo
    Else
        fecbaja = fechafin ' hasta la fecha ingresada
    End If
    
    Call DIF_FECHAS2(fecalta, fecbaja, aux1, aux2, aux3)
    
    If rs_Fases.RecordCount = 1 Then
        dia = aux1
        mes = aux2
        Anio = aux3
    Else
        dia = dia + aux1
        mes = mes + aux2 + Int(dia / 30)
        Anio = Anio + aux3 + Int(mes / 12)
        dia = dia Mod 30
        mes = mes Mod 12
    End If
        
    If Anio = 0 Then
        Call DiasTrab(ternro, fecalta, fecbaja, aux1)
        DiasHabiles = DiasHabiles + aux1
    End If
    
siguiente:
    rs_Fases.MoveNext
Loop

If Anio <> 0 Then
    DiasHabiles = 0
End If

' Cierro todo y Libero
If rs_Fases.State = adStateOpen Then rs_Fases.Close
Set rs_Fases = Nothing

End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos
'--------------------------------------------------------------------
Sub generarDatosRecibo01(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!piso) Then
        Direccion = Direccion & " P. " & rsConsult!piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



Public Sub DiasTrab(ByVal ternro As Integer, ByVal Desde As Date, ByVal Hasta As Date, ByRef DiasH As Long)
' ---------------------------------------------------------------------------------------------
' Descripcion: Calcula la cantidad de dias trabajados de acuerdo al turno en que se trabaja y
'              de acuerdo a los dias que figuran como feriados en la tabla de feriados.
' Autor      : FGZ
' Fecha      :
' Ultima Mod.:
' Descripcion:
' ---------------------------------------------------------------------------------------------

Dim d1 As Integer
Dim d2 As Integer
Dim aux As Integer
Dim aux2 As Integer
Dim dxsem As Integer

Dim rs_pais As New ADODB.Recordset
Dim rs_feriados As New ADODB.Recordset

    dxsem = 5
    
    d1 = Weekday(Desde)
    d2 = Weekday(Hasta)
    
    aux = DateDiff("d", Desde, Hasta) + 1
    If aux < 7 Then
        DiasH = Minimo(aux, dxsem)
    Else
        If aux = 7 Then
            DiasH = dxsem
        Else
            aux2 = 8 - d1 + d2
            If aux2 < 7 Then
                aux2 = Minimo(aux2, dxsem)
            Else
                If aux2 = 7 Then
                    aux2 = dxsem
                End If
            End If
            
            If aux2 >= 7 Then
                aux2 = Abs(aux2 - 7) + Int(aux2 / 7) * dxsem
            Else
                aux2 = aux2 + Int((aux2 - aux2) / 7) * dxsem
            End If
        End If
    End If
    
    aux = 0
    
    StrSql = "SELECT * FROM pais INNER JOIN tercero ON tercero.paisnro = pais.paisnro WHERE tercero.ternro = " & ternro
    OpenRecordset StrSql, rs_pais
    
    If Not rs_pais.EOF Then
        ' Resto los Feriados Nacionales
        StrSql = "SELECT * FROM feriado WHERE tipferinro = 2 " & _
                 " AND fericodext = " & rs_pais!paisnro & _
                 " AND ferifecha >= " & ConvFecha(Desde) & _
                 " AND ferifecha < " & ConvFecha(Hasta)
        OpenRecordset StrSql, rs_feriados
        
        Do While Not rs_feriados.EOF
            If Weekday(rs_feriados!ferifecha) > 1 Then
                DiasH = DiasH - 1
            End If
            
            ' Siguiente Feriado
            rs_feriados.MoveNext
        Loop
    End If


    ' Resto los feriados por Convenio
    StrSql = "SELECT * FROM empleado INNER JOIN his_estructura ON empleado.ternro = his_estructura.ternro " & _
             " INNER JOIN fer_estr ON fer_estr.tenro = his_estructura.tenro " & _
             " INNER JOIN feriado ON fer_estr.ferinro = feriado.ferinro " & _
             " WHERE empleado.ternro = " & ternro & _
             " AND feriado.tipferinro = 2" & _
             " AND feriado.ferifecha >= " & ConvFecha(Desde) & _
             " AND feriado.ferifecha < " & ConvFecha(Hasta)
    OpenRecordset StrSql, rs_feriados
    
    Do While Not rs_feriados.EOF
        If Weekday(rs_feriados!ferifecha) > 1 Then
            DiasH = DiasH - 1
        End If
        
        ' Siguiente Feriado
        rs_feriados.MoveNext
    Loop
    
    
    ' cierro todo y libero
    If rs_pais.State = adStateOpen Then rs_pais.Close
    If rs_feriados.State = adStateOpen Then rs_feriados.Close
        
    Set rs_feriados = Nothing
    Set rs_pais = Nothing

End Sub


'--------------------------------------------------------------------
' Se encarga de generar un ResultSet de los empleados a cambiar
' si el RS es vacio significa que hay que aplicarlo sobre todos
'--------------------------------------------------------------------
Sub CargarEmpleados(NroProc, ByRef rsEmpl As ADODB.Recordset)

Dim StrEmpl As String

    If tipoRecibo = 20 Then
       StrEmpl = " SELECT DISTINCT empleado.ternro, empleado.empleg, empleado.terape, nestact1.estrdext AS nestr1, nestact2.estrcodext AS nestr2"
       StrEmpl = StrEmpl & " From batch_empleado"
       StrEmpl = StrEmpl & " INNER JOIN empleado ON batch_empleado.ternro = empleado.ternro AND batch_empleado.bpronro = " & NroProc
       StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON empleado.ternro = estact1.ternro AND estact1.tenro = 6 "
       StrEmpl = StrEmpl & "      AND (estact1.htetdesde <= " & ConvFecha(fecEstr)
       StrEmpl = StrEmpl & "      AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
       StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON empleado.ternro = estact2.ternro AND estact2.tenro = 5 "
       StrEmpl = StrEmpl & "      AND (estact2.htetdesde<=" & ConvFecha(fecEstr)
       StrEmpl = StrEmpl & "      AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
       StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro"
       StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro"
       StrEmpl = StrEmpl & " Where batch_empleado.bpronro = " & NroProc
       StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2,terape "
    
    Else
       StrEmpl = "SELECT * FROM batch_empleado WHERE bpronro = " & NroProc & " ORDER BY progreso,estado "
       
    End If
    
    OpenRecordset StrEmpl, rsEmpl
End Sub

Function numberForSQL(Str)
   
  numberForSQL = Replace(Str, ",", ".")

End Function

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Temaiken, Deloitte
'--------------------------------------------------------------------
Sub generarDatosRecibo02(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & "From ctabancaria"
     StrSql = StrSql & "INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & "LEFT JOIN banco ON banco.ternro =  ctabancaria.banco"
     StrSql = StrSql & "WHERE ctabancaria.ternro=" & ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Accor
'--------------------------------------------------------------------
Sub generarDatosRecibo03(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim Modelo
Dim LugarPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*,tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 30) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Modelo, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Jugos
'--------------------------------------------------------------------
Sub generarDatosRecibo04(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Documento
Dim regHorario
Dim Sector
Dim DNRP
Dim antiguedad

Dim dia As Long
Dim mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regHorario = ""

If Not rsConsult.EOF Then
   regHorario = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del reg. horario"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call bus_Anti0(ternro, pliqanio, pliqmes, dia, mes, Anio)

Call antigfec(ternro, pliqanio, pliqmes, dia, mes, Anio)

antiguedad = " A&ntilde;os&nbsp;" & Anio & "&nbsp;Meses&nbsp;" & mes & "&nbsp;D&iacute;as&nbsp;" & dia

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del subtotal remunerativo
'------------------------------------------------------------------

StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumSubTotalRemun
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   subTotalRemun = rsConsult!almonto
Else
   Flog.writeline "No se encontro el subtotal remunerativo"
   subTotalRemun = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro=30) "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   DNRP = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(regHorario, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & antiguedad & "'"
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & "," & numberForSQL(subTotalRemun)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Public Function Minimo(ByVal X, ByVal Y)
    If X <= Y Then
        Minimo = X
    Else
        Minimo = Y
    End If
End Function

'--------------------------------------------------------------------
' Se encarga de generar los datos para Citrusvil
'--------------------------------------------------------------------
Sub generarDatosRecibo05(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 36 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Condicion = ""
If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdabr
Else
'    Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & Condicion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub antigfec(ternro, Anio, mes, ByRef antdia As Long, ByRef antmes As Long, ByRef antanio As Long)

Dim sql As String
Dim rs1 As New ADODB.Recordset
Dim acum
Dim auxiliar
Dim tipo

sql = "SELECT * FROM confrep WHERE repnro=87 "

OpenRecordset sql, rs1

tipo = 1
acum = 0

Do Until rs1.EOF
   Select Case rs1!confnrocol
      Case 1
        acum = CInt(rs1!confval)
      Case 2
        tipo = CInt(rs1!confval)
   End Select

   rs1.MoveNext
Loop

rs1.Close

If tipo = 1 Then
   sql = " SELECT sum(ammonto) as suma "
Else
   sql = " SELECT sum(amcant) as suma "
End If

sql = sql & " FROM acu_mes "
sql = sql & " WHERE ternro = " & ternro
sql = sql & "   AND acunro = " & acum
sql = sql & "   AND ( amanio < " & Anio
sql = sql & "    OR ( ammes <= " & mes
sql = sql & "   AND amanio = " & Anio
sql = sql & "   ) ) "
  
OpenRecordset sql, rs1
  
If rs1.EOF Then
   antdia = 0
Else
   If IsNull(rs1!Suma) Then
      antdia = 0
   Else
      antdia = CLng(rs1!Suma)
   End If
End If

rs1.Close

auxiliar = antdia
If antdia > 0 Then
    ' calcular ao
     If antdia > 360 Then
        antanio = Int(antdia / 360)
        antdia = antdia - 360 * antanio
     End If
     If antdia > 30 Then
        antmes = Int(antdia / 30)
        antdia = antdia - Int(antmes * 30)
     Else
        antdia = antdia
     End If
End If

End Sub


Function sinDatos(Str)

  If IsNull(Str) Then
     sinDatos = True
  Else
     If Trim(Str) = "" Then
        sinDatos = True
     Else
        sinDatos = False
     End If
  End If

End Function

' Recibo de Sueldo para Dabra. En vez de mostrar el puesto, se muestra la sucursal.

Sub generarDatosRecibo06(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa TelePerformance
'--------------------------------------------------------------------
Sub generarDatosRecibo07(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecBaja
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim BancoEmpl As String
Dim CuentaEmpl As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      rsConsult.Close
      
      'Me fijo si fue dado de baja en la empresa
      StrSql = "SELECT his_estructura.estrnro,his_estructura.htethasta, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & ternro & _
            " AND his_estructura.tenro  = 10"
      
      OpenRecordset StrSql, rsConsult
      
      If rsConsult.EOF Then
         empFecBaja = "null"
      Else
         If Not IsNull(rsConsult!htethasta) Then
            empFecBaja = "'" & rsConsult!htethasta & "'"
         Else
            empFecBaja = "null"
         End If
      End If
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & ternro

OpenRecordset StrSql, rsConsult

BancoEmpl = ""
CuentaEmpl = ""

If Not rsConsult.EOF Then
   BancoEmpl = rsConsult!Bandesc
   CuentaEmpl = rsConsult!ctabnro
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & BancoEmpl & "'"
StrSql = StrSql & ",'" & CuentaEmpl & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Norton
'--------------------------------------------------------------------
Sub generarDatosRecibo08(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim dia As Long
Dim mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de deloitte, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo09(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "  "
    Localidad = "  "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Gestion Compartida
'--------------------------------------------------------------------
Sub generarDatosRecibo12(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Function tieneConceptosImprimibles(ternro, Pronro)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'--------------------------------------------------------------------
'Controlo si el empleado tiene conceptos imprimibles para el proceso
'--------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

tieneConceptosImprimibles = Not rsConsult.EOF

rsConsult.Close

End Function


'--------------------------------------------------------------------
' Se encarga de generar los datos para Halliburton
'--------------------------------------------------------------------
Sub generarDatosRecibo13(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim LocDireccion
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la localidad de la sucursal
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   LocDireccion = rsConsult!calle & " " & rsConsult!Nro & " - " & rsConsult!codigopostal & " " & rsConsult!locdesc
Else
   Localidad = "  "
   LocDireccion = "  "
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    
    If esSueldoConc Then
    
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
        
    Else
    
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    End If
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

Puesto = ""

'If Not rsConsult.EOF Then
'   Puesto = rsConsult!estrdabr
'Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
'End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago. Caso especial para Halliburton!!
'------------------------------------------------------------------
StrSql = " SELECT pago.ctabnro,formapago.fpagdescabr,ctabancaria.ctabsucdesc,formapago.fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN ctabancaria ON ctabancaria.cbnro = pago.cbnro"
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabsucdesc & "<br>" & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & "<br>(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LocDireccion, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Indura
'--------------------------------------------------------------------
Sub generarDatosRecibo14(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim convenio
Dim CajaJubilacion
Dim AntigDias As Integer
Dim AntigMeses As Integer
Dim AntigAnios As Integer

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

convenio = ""

If Not rsConsult.EOF Then
   convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la caja de jubilacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = ""

If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la caja de jubilacion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxdeci1, auxdeci2, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & convenio & "'"
StrSql = StrSql & ",'" & CajaJubilacion & "'"
StrSql = StrSql & "," & AntigDias
StrSql = StrSql & "," & AntigMeses
StrSql = StrSql & "," & AntigAnios
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de roche, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo15(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim DiasVacTomados
Dim Diasvac

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------------------------------------------
' Busco las vacaciones pendientes
'------------------------------------------------------------------------------------------------------
' busco los dias que le corresponden de vacaciones
StrSql = "SELECT sum(vacdiascor.vdiascorcant) suma FROM vacdiascor "
StrSql = StrSql & " INNER JOIN vacacion ON vacacion.vacnro = vacdiascor.vacnro "
StrSql = StrSql & " WHERE vacdiascor.ternro =" & ternro
StrSql = StrSql & " AND vacacion.vacanio <= " & Year(pliqhasta)
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Diasvac = IIf(Not EsNulo(rsConsult!Suma), rsConsult!Suma, 0)
End If
rsConsult.Close

DiasVacTomados = Diasvac

'Se le descuenta los dias de vacaciones que ya se tomo
StrSql = "SELECT * FROM emp_lic "
StrSql = StrSql & " INNER JOIN lic_vacacion ON lic_vacacion.emp_licnro = emp_lic.emp_licnro "
StrSql = StrSql & " INNER JOIN vacacion ON vacacion.vacnro = lic_vacacion.vacnro "
StrSql = StrSql & " WHERE (empleado = " & ternro & " )"
StrSql = StrSql & " AND (tdnro = 2) "
StrSql = StrSql & " AND elfechahasta < " & ConvFecha(pliqhasta)
OpenRecordset StrSql, rsConsult
    
Do While Not rsConsult.EOF
'    If rsConsult!vacanio = Year(pliqhasta) Then
        DiasVacTomados = DiasVacTomados - rsConsult!elcantdias
'    Else
'        If rsConsult!vacanio + 1 = Year(pliqhasta) Then
'            Diasvactomados = Diasvactomados - rsConsult!elcantdias
'        End If
'    End If
        
    rsConsult.MoveNext
Loop

rsConsult.Close

Diasvac = DiasVacTomados
    
Diasvac = IIf(Fix(Diasvac) = Diasvac, Diasvac, Fix(Diasvac + 1))
If Diasvac < 0 Then
    Diasvac = 0
End If
Flog.writeline "Vacaciones pendientes: " & Diasvac & " das "

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & Diasvac
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Estrada
'--------------------------------------------------------------------
Sub generarDatosRecibo18(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Documento
Dim Sector
Dim DNRP
Dim Seccion
Dim LugarDePago

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim dia As Long
Dim mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta y baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecAlta = "null"
   empFecBaja = "null"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT fpagdescabr"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro= " & tidDNRP & ") "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!nrodoc) Then
      If Len(rsConsult!nrodoc) < 4 Then
         DNRP = Mid(rsConsult!nrodoc, 1, Len(rsConsult!nrodoc))
      Else
         DNRP = Mid(rsConsult!nrodoc, 1, 4)
      End If
   End If
Else
'   Flog.writeline "Error al obtener los datos del DNRP"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la seccion
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Seccion = ""

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!estrcodext) Then
      If Len(rsConsult!estrcodext) >= 3 Then
         Seccion = Mid(rsConsult!estrcodext, 1, 3)
      End If
   End If
End If

rsConsult.Close

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 32 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!estrcodext) Then
      If Len(rsConsult!estrcodext) >= 1 Then
         Seccion = Seccion & Mid(rsConsult!estrcodext, 1, 1)
      End If
   End If
End If

rsConsult.Close
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & ",'" & Seccion & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para IMSA
'--------------------------------------------------------------------
Sub generarDatosRecibo19(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Integer
Dim Banco As String
Dim Cuenta As String
Dim clase As String
Dim grupo As String

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripcin del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 36 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Condicion = ""
If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdabr
Else
'    Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor del clase de empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=48 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   clase = rsConsult!estrdabr
Else: clase = ""
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor del grupo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=32 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   grupo = rsConsult!estrdabr
Else: grupo = ""
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    Cuenta = rsConsult!ctabnro
    Banco = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    Cuenta = ""
    Banco = ""
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
'Martin Ferraro - 18/10/2006 - Agregue CP y provincia
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, provincia.provdesc, codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!provdesc) Then
        EmpDire = EmpDire & ", Pcia. de " & rs_Domicilio!provdesc
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1 , auxdeci2, auxdeci3,auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & clase & "'"
StrSql = StrSql & ",'" & grupo & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de roche 2, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo20(Pronro, ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String
Dim Cont As Long

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim DiasVacTomados
Dim DivPersonal
Dim Departamento
Dim LugarDeTrabajo
Dim Banco
Dim CuentaBancaria
Dim PagoMonto
Dim FormaDePagoNro

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext, estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Division de personal (Gerencia)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=6 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

DivPersonal = ""
If Not rsConsult.EOF Then
   DivPersonal = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la div de personal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Departamento (Sector)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del departamento"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Lugar de Trabajo(Sucursal)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=1 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

LugarDeTrabajo = ""
If Not rsConsult.EOF Then
   LugarDeTrabajo = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Lugar de Trabajo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT pago.fpagnro, ctabnro,ctabcbu,bandesc,pago.pagomonto,fpagdescabr "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   FormaPago = rsConsult!fpagdescabr
   If Not EsNulo(rsConsult!ctabnro) Then
       CuentaBancaria = rsConsult!ctabnro
       If IsNull(rsConsult!Bandesc) Then
          Banco = ""
       Else
          Banco = rsConsult!Bandesc
       End If
   Else
       CuentaBancaria = rsConsult!ctabcbu
       Banco = "CBU"
   End If
   PagoMonto = rsConsult!PagoMonto
   FormaDePagoNro = rsConsult!fpagnro
Else
   Flog.writeline "Fin de archivo en Formas de Pago"
   FormaPago = ""
   CuentaBancaria = ""
   PagoMonto = 0
   FormaDePagoNro = 1000
   Banco = ""
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

Flog.writeline "Contenido de CuentaBancaria = " & CuentaBancaria

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " - " & rs_Domicilio!codigopostal & " " & rs_Domicilio!barrio & " - " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------------------------------------------
' Busco las vacaciones pendientes
'------------------------------------------------------------------------------------------------------

StrSql = " SELECT DISTINCT * "
StrSql = StrSql & " FROM novemp "
StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " AND novemp.tpanro = " & paramVacPend
StrSql = StrSql & " AND concnro = " & concnroVacPend
StrSql = StrSql & " AND nedesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ORDER BY nedesde DESC "

OpenRecordset StrSql, rsConsult

DiasVacTomados = 0
If Not rsConsult.EOF Then
    DiasVacTomados = rsConsult!nevalor
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxdeci1, auxchar1, auxchar2, auxchar3,auxchar4,auxchar5,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & numberForSQL(DiasVacTomados)
StrSql = StrSql & ",'" & DivPersonal & "'"
StrSql = StrSql & ",'" & Departamento & "'"
StrSql = StrSql & ",'" & LugarDeTrabajo & "'"
StrSql = StrSql & ",'" & CuentaBancaria & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & numberForSQL(PagoMonto)
StrSql = StrSql & "," & numberForSQL(arrFormaPago(FormaDePagoNro))
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo1
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
              StrSql = StrSql & "," & rsConsult!concnro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo1(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'1')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 2
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo2
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
              StrSql = StrSql & "," & rsConsult!concnro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo2(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'2')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next


'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 3
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo3
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
              StrSql = StrSql & "," & rsConsult!concnro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo3(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'3')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Flecha Bus
'--------------------------------------------------------------------
Sub generarDatosRecibo21(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim calif_pers

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,fpagbanc, pago.banternro "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If CInt(rsConsult!fpagbanc) = -1 Then
    StrSql = " SELECT * "
    StrSql = StrSql & " FROM banco "
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " WHERE banco.ternro = " & rsConsult!banternro
       
    OpenRecordset StrSql, rsConsult2
    
    If Not rsConsult2.EOF Then
       FormaPago = rsConsult!fpagdescabr & " " & rsConsult!ctabnro
    End If
    rsConsult2.Close
    
  Else
    FormaPago = "Pago Efectivo"
  End If
Else
  FormaPago = " "
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Uruguay
'--------------------------------------------------------------------
Sub generarDatosRecibo22(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpMISS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'Consulta para obtener el MISS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 28)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el MISS de la Empresa"
    'Exit Sub
    EmpMISS = "  "
Else
    EmpMISS = rs_cuit!nrodoc
End If

'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 13)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!nrodoc
End If

'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!nrodoc
End If

'Consulta para obtener el BSE de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 29)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el BSE de la Empresa"
    'Exit Sub
    EmpBSE = "  "
Else
    EmpBSE = rs_cuit!nrodoc
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMISS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Deloitte Personal
'--------------------------------------------------------------------
Sub generarDatosRecibo23(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim regimenHor
Dim Gerencia
Dim reportaa
Dim empreporta
Dim grupoSeguridad
Dim Sucursal

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta y baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la gerencia
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Gerencia = ""

If Not rsConsult.EOF Then
   Gerencia = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la gerencia"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ctabestado=-1 AND ternro = " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From ctabancaria"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN banco ON banco.ternro =  ctabancaria.banco"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & "&nbsp;&nbsp;&nbsp;&nbsp;" & rsConsult!terrazsoc & "&nbsp;&nbsp;&nbsp;&nbsp;Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     'Me fijo si la ctabancaria no tiene asociado un banco, o sea es en efectivo
     StrSql = "SELECT fpagdescabr "
     StrSql = StrSql & " From ctabancaria"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
     
     rsConsult.Close
     OpenRecordset StrSql, rsConsult
     
     If Not rsConsult.EOF Then
        FormaPago = rsConsult!fpagdescabr
     Else
        Flog.writeline "Error, no se encuentra la forma de pago del empleado"
     End If
     
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,piso,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " Piso " & rs_Domicilio!piso & "<br>" & rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Gerencia, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sucursal, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Las Lenas
'--------------------------------------------------------------------
Sub generarDatosRecibo24(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de TTI
'--------------------------------------------------------------------
Sub generarDatosRecibo25(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Schering
'--------------------------------------------------------------------
Sub generarDatosRecibo26(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

   Direccion = ""
   Localidad = Direccion

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " (" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0
    
EmpFirma = ""
EmpFirmaAlto = 0
EmpFirmaAncho = 0

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Indra
'--------------------------------------------------------------------
Sub generarDatosRecibo27(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valorAcumHaberesConAp
Dim valorAcumNetoImp
Dim valorAcumRetImpuesto
Dim Sector
Dim AntigAnios  As Integer
Dim AntigMeses As Integer
Dim AntigDias As Integer
Dim convenio
Dim Documento

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Haberes con aportes
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumHaberesConAp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumHaberesConAp = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de haberes con aportes"
   valorAcumHaberesConAp = 0
   'GoTo MError
End If

'Neto Imp.
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumNetoImp = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de netos imp."
   valorAcumNetoImp = 0
   'GoTo MError
End If


StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumRetImpuesto
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumRetImpuesto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de ret. impuesto."
   valorAcumRetImpuesto = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

convenio = ""

If Not rsConsult.EOF Then
   convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!terrazsoc & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " (" & rs_Domicilio!codigopostal & " ) " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxdeci1,auxdeci2,auxdeci3,auxdeci4,auxdeci5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & convenio & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & numberForSQL(AntigAnios)
StrSql = StrSql & "," & numberForSQL(AntigMeses)
StrSql = StrSql & "," & numberForSQL(valorAcumHaberesConAp)
StrSql = StrSql & "," & numberForSQL(valorAcumNetoImp)
StrSql = StrSql & "," & numberForSQL(valorAcumRetImpuesto)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Edenor
'--------------------------------------------------------------------
Sub generarDatosRecibo28(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim regimenHor
Dim LugarPago
Dim lugartrabajo
Dim convenio
Dim ConvenioNro
Dim modalidad
Dim modalidadNro
Dim minutosjor

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim EmpActividad

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Sector
Dim AntigAnios  As Integer
Dim AntigMeses As Integer
Dim AntigDias As Integer
Dim Documento

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
   
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If CBool(rsConsult!fpagbanc) Then
        FormaPago = "01"
    Else
        FormaPago = "02"
End If

Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empactiv " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
    EmpActividad = rs_estructura!EmpActiv
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " (" & rs_Domicilio!codigopostal & " ) " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext, his_estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

convenio = ""

If Not rsConsult.EOF Then
     convenio = rsConsult!estrcodext
     ConvenioNro = rsConsult!estrnro
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
' Modalidad de Trabajo
'------------------------------------------------------------------
  StrSql = " SELECT estrdabr, estrcodext "
  StrSql = StrSql & " From his_estructura"
  StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
  StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 47 And his_estructura.ternro = " & ternro
  
  OpenRecordset StrSql, rsConsult
  
  If Not rsConsult.EOF Then
   modalidad = rsConsult!estrcodext
   modalidadNro = rsConsult!estrnro
  Else
   '   Flog.writeline "Error al obtener los datos de la modalidad de trabajo"
   '   GoTo MError
  End If
  rsConsult.Close
  
'------------------------------------------------------------------
'Obtiene la Cantidad de Minutos segn la escala apropiada
'------------------------------------------------------------------
  StrSql = "SELECT valgrilla.vgrvalor"
  StrSql = StrSql & " FROM valgrilla"
  StrSql = StrSql & " WHERE valgrilla.vgrcoor_1 =" & ConvenioNro & "  AND valgrilla.vgrcoor_2 = " & modalidadNro & " AND cgrnro=18"
  
  OpenRecordset StrSql, rsConsult
  If Not rsConsult.EOF Then
   minutosjor = CInt(rsConsult(0)) / 60
  Else
   minutosjor = 1440 'Minutos que hay en un dia
  End If
  rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxchar2,auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ",'" & EmpActividad & "'"
StrSql = StrSql & ",'" & convenio & "'"
StrSql = StrSql & ",'" & minutosjor & "'"
StrSql = StrSql & ",'" & modalidad & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos Glencore
'--------------------------------------------------------------------
Sub generarDatosRecibo29(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CategoriaCodExt
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim PuestoCodExt

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim EmpActividad
Dim modeloProc
Dim pliqDesc
Dim estadoCivil

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim tituloCategoria
Dim valorCategoria

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,estcivdesabr "
StrSql = StrSql & " FROM empleado INNER JOIN tercero ON empleado.ternro= tercero.ternro "
StrSql = StrSql & " INNER JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
StrSql = StrSql & " WHERE empleado.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   estadoCivil = rsConsult!estcivdesabr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   modeloProc = rsConsult!tprocdesc
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'------------------------------------------------------------------
'Busco el valor del tipo de estructura 32
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 32 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    
    If rsConsult!estrcodext <> "17" Then
    
        rsConsult.Close
        
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        
        OpenRecordset StrSql, rsConsult
    
        If Not rsConsult.EOF Then
           Sueldo = rsConsult!almonto
        Else
           Sueldo = 0
        End If
        
   Else
        Sueldo = 0
   End If
Else
   Sueldo = 0
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""

If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
CategoriaCodExt = ""

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaCodExt = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""
PuestoCodExt = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   PuestoCodExt = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

tituloCategoria = ""
valorCategoria = ""

If Puesto <> "" And PuestoCodExt <> "1" Then
   tituloCategoria = "Puesto"
Else
   tituloCategoria = "Categoria"
End If

If Categoria <> "" And CategoriaCodExt <> "1" Then
   valorCategoria = Categoria
Else
   If Puesto <> "" And PuestoCodExt <> "1" Then
      valorCategoria = Puesto
   Else
      valorCategoria = ""
   End If
End If

Categoria = valorCategoria

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empactiv " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"

OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
    EmpActividad = rs_estructura!EmpActiv
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(EmpActividad, 1, 100) & "'"
StrSql = StrSql & ",'" & tituloCategoria & "'"
StrSql = StrSql & ",'" & estadoCivil & "'"
StrSql = StrSql & ",'" & modeloProc & "'"
StrSql = StrSql & ",'" & pliqDesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos Tetrapak
'--------------------------------------------------------------------
Sub generarDatosRecibo30(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim LugarPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Cia. Alimentos
'--------------------------------------------------------------------
Sub generarDatosRecibo31(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago
Dim ObraSocial

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim dia As Long
Dim mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Sitel
'--------------------------------------------------------------------
Sub generarDatosRecibo32(Pronro, ternro, acunroSueldo, tituloReporte, orden)

'Codigo de forma de liq quincenal
Const quincenal1 = 553
Const quincenal2 = 555

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim empFecAltarec2
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim quincena As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
 ' Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de liquidacion del empleado para ver si es quincenal
'------------------------------------------------------------------
quincena = " "

StrSql = "SELECT his_estructura.estrnro " & _
    " From his_estructura" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 22"
OpenRecordset StrSql, rs_estructura

If Not rs_estructura.EOF Then
    
    If (rs_estructura!estrnro = quincenal1) Or (rs_estructura!estrnro = quincenal2) Then
        'Miro que quincena es
        StrSql = " SELECT proceso.pronro, proceso.tprocnro, tprocdesc"
        StrSql = StrSql & " From Proceso"
        StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro"
        StrSql = StrSql & " Where Proceso.pronro = " & Pronro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!tprocdesc) Then
                quincena = Left(rsConsult!tprocdesc, 1)
            End If
        End If
        rsConsult.Close
    End If

End If

rs_estructura.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Baja Reconocida 2.
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND estado = 0 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltarec2 = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltarec2 = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltarec2 & "'"
StrSql = StrSql & ",'" & quincena & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Bazar Avenida
'--------------------------------------------------------------------
Sub generarDatosRecibo33(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim fasrecofec

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la fecha baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta para la antiguedad
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & " AND fasrecofec = -1" & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      fasrecofec = "'" & rsConsult!altfec & "'"
   Else
      fasrecofec = "null"
   End If
Else
   fasrecofec = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!provdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pafo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 24 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & "," & fasrecofec
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Ampacet
'--------------------------------------------------------------------
Sub generarDatosRecibo34(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim proFecplan
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String


Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecplan, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   proFecplan = rsConsult!proFecplan
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & proFecplan & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Wella
'--------------------------------------------------------------------
Sub generarDatosRecibo36(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago
Dim ObraSocial

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valoracumAuxDeci1
Dim valoracumAuxDeci2
Dim valoracumAuxDeci3
Dim dia As Long
Dim mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Nro), "", rsConsult!Nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'AcumAuxDeci1
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci1
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci1 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci1 = 0
   'GoTo MError
End If

'AcumAuxDeci2
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci2
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci2 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci2 = 0
   'GoTo MError
End If

'AcumAuxDeci3
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci3
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci3 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci3 = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci1)
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci2)
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci3)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Andreani Logistica
'--------------------------------------------------------------------
Sub generarDatosRecibo35(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim antiguedad
Dim Documento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim dia As Integer
Dim mes As Integer
Dim Anio As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   If IsNull(rsConsult!empremu) Then
'      Sueldo = 0
'   Else
'      Sueldo = rsConsult!empremu
'   End If
         Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 AND estado= -1"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase +
'antigua con real en true.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & ternro & " order by altfec ASC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   antiguedad = rsConsult!altfec
   Flog.writeline "    Fecha de Alta del Empleado Fase + antigua OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado Fase + antigua"
   antiguedad = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripcin del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
   Flog.writeline "    los datos de la localidad OK"
Else
   Direccion = ""
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "    los datos del sector OK"
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Banco = rsConsult!Bandesc
   Cuenta = rsConsult!ctabnro
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Carsa
'--------------------------------------------------------------------
Sub generarDatosRecibo38(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim funciones

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de Funciones
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
   funciones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de Funciones"
'   GoTo MError
    funciones = ""
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
Puesto = ""
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close
'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND real= -1"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
   Flog.writeline "la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase +
'antigua con real en true.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & ternro & " order by altfec ASC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    Fecha de Alta del Empleado Fase + antigua OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado Fase + antigua"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(funciones, 1, 60) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Telearte
'--------------------------------------------------------------------
Sub generarDatosRecibo37(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim funciones

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim pliqDesc As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult
pliqDesc = ""
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = IIf(EsNulo(rsConsult!pliqDesc), "", rsConsult!pliqDesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de Funciones
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
   funciones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de Funciones"
'   GoTo MError
    funciones = ""
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
Puesto = ""
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(pliqDesc, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Marsh
'--------------------------------------------------------------------
Sub generarDatosRecibo39(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim Banco
Dim Cuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado = " & ternro & " AND fases.real = -1 "
StrSql = StrSql & " ORDER BY altfec DESC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!bajfec) Then
        empFecBaja = rsConsult!bajfec
    Else
        empFecBaja = "  "
    End If
Else
    empFecBaja = "  "
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   'CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,ctabcbu,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr
    Banco = rsConsult!terrazsoc
    If Not EsNulo(rsConsult!ctabcbu) Then
        Cuenta = rsConsult!ctabcbu
    Else
        Cuenta = rsConsult!ctabnro
    End If
  Else
    FormaPago = rsConsult!fpagdescabr
    Banco = rsConsult!terrazsoc
    If Not EsNulo(rsConsult!ctabcbu) Then
        Cuenta = rsConsult!ctabcbu
    Else
        Cuenta = rsConsult!ctabnro
    End If
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para BIA (Banco Industrial Azul)
'--------------------------------------------------------------------
Sub generarDatosRecibo40(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim antReconocida
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim regimenJub
Dim Contrato
Dim LugarPago
Dim Departamento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim MontoTickets As Double

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "No se encontraron los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    If IsNull(rsConsult!empremu) Then
        Sueldo = 0
    Else
        Sueldo = rsConsult!empremu
    End If
   
    StrSql = "SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado = " & ternro & " AND real = -1 "
    OpenRecordset StrSql, rs_Fases
    If Not rs_Fases.EOF Then
        empFecAlta = rs_Fases!altfec
    Else
        empFecAlta = rsConsult!empfaltagr
    End If
    rs_Fases.Close
    
Else
    Flog.writeline "No se encontraron los datos del empleado."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "No se encontraron los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Antigedad reconocida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 44 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

antReconocida = ""

If Not rsConsult.EOF Then
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases"
    StrSql = StrSql & " WHERE fases.empleado = " & ternro & " AND fases.estado = 0"
    OpenRecordset StrSql, rs_Fases
    If Not rs_Fases.EOF Then
        antReconocida = rs_Fases!altfec
    End If
    rs_Fases.Close
Else
    Flog.writeline "No se encontro la Antigedad reconocida del empleado."
'    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Cuil = rsConsult!nrodoc
Else
    Flog.writeline "No se encontraron los datos del cuil."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos de la categora."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos del puesto."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos del sector."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del departamento."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Forma de Contratacin (Contrato Actual)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=18 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""
If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Contrato Actual."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""
If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Rgimen Jubilatorio."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""
If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Lugar de Pago."
'   GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabancaria.ctabnro, formapago.fpagdescabr, formapago.fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " INNER JOIN ctabancaria on pago.cbnro = ctabancaria.cbnro"

OpenRecordset StrSql, rsConsult

FormaPago = "Forma de Pago: Dep&oacute;sito Bancario"
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Forma de Pago: " & rsConsult!fpagdescabr & " - Cuenta N&deg; " & rsConsult!ctabnro
    End If
Else
   Flog.writeline "No se encontraron los datos de la forma de pago."
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(antReconocida, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenJub, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Paolini
'--------------------------------------------------------------------
Sub generarDatosRecibo41(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim Sector
Dim Contrato
Dim empFecBaja
Dim empFecAltaReal

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim tipo80 As String
Dim tipo81 As String
Dim Cod80Acum As Long
Dim Cod81Acum As Long
Dim Cod80Conc As String
Dim Cod81Conc As String
Dim valor80 As Double
Dim valor81 As Double

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta de fase activa
'------------------------------------------------------------------
empFecAltaReal = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & ternro
StrSql = StrSql & " AND fases.bajfec is null  "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaReal = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columna 80 y 81 para del confrep para imp. adicional y Asig rem"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 80 OR confnrocol = 81)"
OpenRecordset StrSql, rsConsult

tipo80 = ""
tipo81 = ""
valor80 = 0
valor81 = 0

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 80
             If rsConsult!conftipo = "AC" Then
                tipo80 = "AC"
                Cod80Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo80 = "CO"
                Cod80Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna80: " & tipo80 & " concepto: " & Cod80Conc & " acumulador: " & Cod80Acum
      Case 81
             If rsConsult!conftipo = "AC" Then
                tipo81 = "AC"
                Cod81Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo81 = "CO"
                Cod81Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna81: " & tipo81 & " concepto: " & Cod81Conc & " acumulador: " & Cod81Acum
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE cabdom.domdefault = -1 AND"
StrSql = StrSql & " cabdom.ternro = " & ternro

OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la columna 80 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
valor80 = 0
Select Case tipo80
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor80 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod80Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor80 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la columna 81 del confrep, ASIGN. REM.
'------------------------------------------------------------------
valor81 = 0
Select Case tipo81
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod81Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor81 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod81Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor81 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen = " & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " (" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0
    
EmpFirma = ""
EmpFirmaAlto = 0
EmpFirmaAncho = 0

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxdeci1, auxdeci2, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & "," & valor80
StrSql = StrSql & "," & valor81
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecAltaReal, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Megatone
'--------------------------------------------------------------------
Sub generarDatosRecibo42(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim Calificacion
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim Contrato
Dim LugarPago
Dim Sucursal
Dim Departamento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfecalta,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la fecha de ingreso
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases WHERE empleado = " & ternro & " AND real = -1 AND estado = -1 " & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult
empFecAlta = ""
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la fecha de ingreso. Verificar que tenga una fase marcada como REAL y ACTIVA"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " AND detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo. Se puede configurar de tipo concepto (CO) o de cualquier otro tipo y se considera como acumulador"
   Sueldo = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la calificacion Profecional. Puesto (4)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult
Puesto = " "
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la calificacin profesional (Puesto)"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del la contratacion (Contrato Actual)"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Lugar de Pago"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""

If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Departamento"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT * FROM ctabancaria WHERE ctabestado=-1 AND ternro = " & ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'  If rsConsult.RecordCount = 1 Then
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
'     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'     StrSql = StrSql & " From ctabancaria"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
'     StrSql = StrSql & " LEFT JOIN banco ON banco.ternro =  ctabancaria.banco"
'     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
'  Else
'     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'     StrSql = StrSql & " From pago"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'  End If
'  rsConsult.Close
'  OpenRecordset StrSql, rsConsult
'  If Not rsConsult.EOF Then
'     If CBool(rsConsult!fpagbanc) Then
'        FormaPago = rsConsult!fpagdescabr
'     Else
'        FormaPago = rsConsult!fpagdescabr
'     End If
'  Else
     'Me fijo si la ctabancaria no tiene asociado un banco, o sea es en efectivo
'     StrSql = "SELECT fpagdescabr "
'     StrSql = StrSql & " From ctabancaria"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
'     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
'     rsConsult.Close
'     OpenRecordset StrSql, rsConsult
'     If Not rsConsult.EOF Then
'        FormaPago = rsConsult!fpagdescabr
'     Else
'        Flog.writeline "Error, no se encuentra la forma de pago del empleado"
'     End If
'  End If
'Else
'   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
'End If
'rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,piso,codigopostal, provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON provincia.provnro = localidad.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " " & rs_Domicilio!locdesc & " - " & rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para BNP Paribas Argentina
'--------------------------------------------------------------------
Sub generarDatosRecibo43(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim DiasPtes
Dim CabliqNumero
Dim Ticket
Dim MontoTickets
Dim CantTickets

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
   Categoria = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de los Dias Pendientes de Licencia de vacaciones
'------------------------------------------------------------------
StrSql = " SELECT vdiascorcant "
StrSql = StrSql & " FROM vacdiascor "
StrSql = StrSql & " WHERE ternro = " & ternro
OpenRecordset StrSql, rsConsult

DiasPtes = 0
Do Until rsConsult.EOF
   DiasPtes = DiasPtes + rsConsult!vdiascorcant
   rsConsult.MoveNext
Loop
rsConsult.Close


StrSql = " SELECT vdiapedcant "
StrSql = StrSql & " FROM vacdiasped "
StrSql = StrSql & " WHERE ternro = " & ternro
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
   DiasPtes = DiasPtes - rsConsult!vdiapedcant
   rsConsult.MoveNext
Loop
rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT concepto.conccod AS codigo, concepto.concabr AS descripcion, detliq.dlimonto AS valor, detliq.dlicant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro "
Else
    StrSql = " SELECT acumulador.acunro AS codigo, acumulador.acudesabr AS descripcion, acu_liq.almonto AS valor, acu_liq.alcant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro "
End If
    
OpenRecordset StrSql, rsConsult

CabliqNumero = 0
Ticket = "&nbsp;"
MontoTickets = 0
CantTickets = 0

If Not rsConsult.EOF Then
    CabliqNumero = rsConsult!cliqnro
    Ticket = rsConsult!codigo & " " & rsConsult!descripcion
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    If Not IsNull(rsConsult!Cantidad) Then
       CantTickets = CantTickets + CDbl(rsConsult!Cantidad)
    End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxdeci1, auxchar1, auxdeci2, auxchar2, auxdeci3, auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & DiasPtes
StrSql = StrSql & ",'" & pliqDesc & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & ",'" & Ticket & "'"
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & CantTickets
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para LIGGETT
'--------------------------------------------------------------------
Sub generarDatosRecibo44(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim tprocdesc
Dim CabliqNumero
Dim vhora
Dim bonos

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
   tprocdesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del V.HORA/BASICO."
   vhora = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de los bonos, definido en la columna 43 del confrep
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   bonos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos de los BONOS."
   bonos = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el cod externo del sector
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el cod externo de la forma de liquidacion
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!estrcodext = 2 Or rsConsult!estrcodext = 4 Then
        pliqDesc = Mid(tprocdesc, 1, 12) & " " & pliqmes & "-" & pliqanio
    End If
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxdeci1, auxdeci2 )"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & pliqDesc & "'"
StrSql = StrSql & "," & vhora
StrSql = StrSql & "," & bonos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Bazar REDEPA
'--------------------------------------------------------------------
Sub generarDatosRecibo45(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim fasrecofec

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim tipo90 As String
Dim tipo91 As String
Dim Cod90Acum As Long
Dim Cod91Acum As Long
Dim Cod90Conc As String
Dim Cod91Conc As String
Dim valor90 As Double
Dim valor91 As Double


Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Buscando columna 90 y 91 para del confrep para imp. adicional y antig"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 90 or confnrocol = 91)"
OpenRecordset StrSql, rsConsult

tipo90 = ""
tipo91 = ""
valor90 = 0
valor91 = 0

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 90
             If rsConsult!conftipo = "AC" Then
                tipo90 = "AC"
                Cod90Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo90 = "CO"
                Cod90Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna90: " & tipo90 & " concepto: " & Cod90Conc & " acumulador: " & Cod90Acum
      Case 91
             If rsConsult!conftipo = "AC" Then
                tipo91 = "AC"
                Cod91Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo91 = "CO"
                Cod91Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna91: " & tipo91 & " concepto: " & Cod91Conc & " acumulador: " & Cod91Acum
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la columna 90 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
valor90 = 0
Select Case tipo90
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod90Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor90 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod90Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor90 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la columna 91 del confrep, Antig.
'------------------------------------------------------------------
valor91 = 0
Select Case tipo91
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod91Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor91 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod91Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor91 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco la fecha baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta para la antiguedad
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & " AND fasrecofec = -1" & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      fasrecofec = "'" & rsConsult!altfec & "'"
   Else
      fasrecofec = "null"
   End If
Else
   fasrecofec = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!provdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pafo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 24 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, "
StrSql = StrSql & " auxdeci1, auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & "," & fasrecofec
StrSql = StrSql & "," & valor90
StrSql = StrSql & "," & valor91
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Codere
'--------------------------------------------------------------------
Sub generarDatosRecibo48(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CabliqNumero

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim LugarPago As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del lugar de pago"
   LugarPago = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If Sueldo = 0 Then
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo."
       Sueldo = 0
       'GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!terrazsoc & " Cuenta: " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.Writeline "Error al obtener los datos de la forma de pago."
'   FormaPago = "&nbsp;"
''   GoTo MError
'End If
'
'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa."
    EmpNombre = "&nbsp;"
'    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If
'
''Consulta para obtener la direccion de la empresa
'StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal From cabdom " & _
'    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_Domicilio
'If rs_Domicilio.EOF Then
'    Flog.Writeline "No se encontr el domicilio de la empresa."
'    'Exit Sub
    EmpDire = "&nbsp;"
'Else
'    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
'End If
'
''Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.Writeline "No se encontr el CUIT de la Empresa."
'    'Exit Sub
    EmpCuit = "&nbsp;"
'Else
'    EmpCuit = rs_cuit!nrodoc
'End If
'
''Consulta para buscar el logo de la empresa
'StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
'    " From ter_imag " & _
'    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
'    " AND ter_imag.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_logo
'If rs_logo.EOF Then
'    Flog.Writeline "No se encontr el Logo de la Empresa."
'    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
'Else
'    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
'    EmpLogoAlto = rs_logo!tipimaltodef
'    EmpLogoAncho = rs_logo!tipimanchodef
'End If
'
''Consulta para buscar la firma de la empresa
'StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
'    " From ter_imag " & _
'    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
'    " AND ter_imag.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_firma
'If rs_firma.EOF Then
'    Flog.Writeline "No se encontr el Firma de la Empresa."
'    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
'Else
'    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
'    EmpFirmaAlto = rs_firma!tipimaltodef
'    EmpFirmaAncho = rs_firma!tipimanchodef
'End If
'
'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqDesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Distribuidora Metropolitana
'--------------------------------------------------------------------
Sub generarDatosRecibo46(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CabliqNumero
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el sector, en realidad Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social elegida."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!terrazsoc & " Cuenta: " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & pliqDesc & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & " ," & cliqnro
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Tetra
'--------------------------------------------------------------------
Sub generarDatosRecibo49(Pronro, ternro, acunroSueldo, tituloReporte, orden)

'Codigo de forma de liq quincenal
Const quincenal1 = 553
Const quincenal2 = 555

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim empFecAltarec2
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim quincena As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
Direccion = ""
Localidad = ""

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

'---LOG---
Flog.writeline "Buscando datos de la direccion de la sucursal"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de liquidacion del empleado para ver si es quincenal
'------------------------------------------------------------------
quincena = " "

StrSql = "SELECT his_estructura.estrnro " & _
    " From his_estructura" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 22"
OpenRecordset StrSql, rs_estructura

If Not rs_estructura.EOF Then
    
    If (rs_estructura!estrnro = quincenal1) Or (rs_estructura!estrnro = quincenal2) Then
        'Miro que quincena es
        StrSql = " SELECT proceso.pronro, proceso.tprocnro, tprocdesc"
        StrSql = StrSql & " From Proceso"
        StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro"
        StrSql = StrSql & " Where Proceso.pronro = " & Pronro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!tprocdesc) Then
                quincena = Left(rsConsult!tprocdesc, 1)
            End If
        End If
        rsConsult.Close
    End If

End If

rs_estructura.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Baja Reconocida 2.
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND estado = 0 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltarec2 = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltarec2 = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 28) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltarec2 & "'"
StrSql = StrSql & ",'" & quincena & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



' ***************************

'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de Divino - Uruguay
'--------------------------------------------------------------------
Sub generarDatosRecibo50(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTickets As Double
Dim vhora

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMISS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

' _____________________________________________________________________________
' Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS
' _____________________________________________________________________________

Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If

rsConsult.Close

' _________________________________________________________________________

       


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   ' el sueldo se saca del concepto 01000
   Sueldo = 0
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Cuil = " "
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'Se cambio -- Sueldo se busca en la columna 44
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo (en los datos del empleado setee la variable Sueldo=0)

'If Sueldo = 0 Then
'    If esSueldoConc Then
'        StrSql = " SELECT detliq.dlimonto valor "
'        StrSql = StrSql & " FROM detliq "
'        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
'    Else
'        StrSql = " SELECT almonto valor"
'        StrSql = StrSql & " From acu_liq"
'        StrSql = StrSql & " Where acunro = " & acunroSueldo
'        StrSql = StrSql & " AND cliqnro = " & cliqnro
'    End If
    
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!Valor
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo (col 1)."
'       Sueldo = 0
       'GoTo MError
'    End If
'End If



'------------------------------------------------------------------
'Busco el valor del Monto Tickets, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
    
        'CabliqNumero = rsConsult!cliqnro
        If Not IsNull(rsConsult!Valor) Then
            MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
        End If
    
        rsConsult.MoveNext
    Loop
Else
      Flog.writeline " No se encontraron datos de MONTO TICKETS (col42)."

End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 43 del confrep
' Se cometa porque en BA se uso la columna 44 para vhora
'Se cambio -- se usa col 43 para v. hora.
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

vhora = 0
If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de V.HORA/BASICO. (col43)"
   vhora = 0
   'GoTo MError
End If


'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

Sueldo = 0
If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult
Categoria = " "
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult
CentroCosto = " "
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult
FormaPago = " "

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = " "
If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para obtener el MISS de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 28)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontr el MISS de la Empresa"
'    EmpMISS = "  "
'Else
'    EmpMISS = rs_cuit!nrodoc
'End If
 EmpMISS = "  "

' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!nrodoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!nrodoc
End If


' -------------------------------------------------------------------------
'Consulta para obtener el BSE de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 29)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontr el BSE de la Empresa"
'    EmpBSE = "  "
'Else
'    EmpBSE = rs_cuit!nrodoc
'End If
'rs_estructura.Close
 EmpBSE = "  "


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
'Flog.Writeline "======================================================================================================================================="
'Flog.Writeline ":::INSERTO EN REP_RECIBO::: "
'Flog.Writeline "Sueldo=" & Sueldo
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden "
StrSql = StrSql & " , auxchar1, auxchar2, auxchar3, auxchar4 "
StrSql = StrSql & " , auxdeci1, auxdeci2 "
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMISS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & "," & numberForSQL(MontoTickets)
StrSql = StrSql & "," & numberForSQL(vhora)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Darmex
'--------------------------------------------------------------------
Sub generarDatosRecibo51(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Long
Dim Banco
Dim Cuenta
Dim Sector
Dim antiguedad
Dim Documento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpRazSoc As String
Dim EmpDire As String
Dim EmpProv As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim dia As Integer
Dim mes As Integer
Dim Anio As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   If IsNull(rsConsult!empremu) Then
'      Sueldo = 0
'   Else
'      Sueldo = rsConsult!empremu
'   End If
         Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    Flog.writeline "    la Fecha de Alta del Empleado OK - alta fase"
Else
    rsConsult.Close
    StrSql = " SELECT empfaltagr "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro = " & ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!empfaltagr
        Flog.writeline "    la Fecha de Alta del Empleado OK - empaltagr"
    Else
        Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = ""
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase +
'antigua con real en true.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & ternro & " order by altfec ASC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   antiguedad = rsConsult!altfec
   Flog.writeline "    Fecha de Alta del Empleado Fase + antigua OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado Fase + antigua"
   antiguedad = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripcin del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro
   Localidad = rsConsult!locdesc
   Flog.writeline "    los datos de la localidad OK"
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

'sector = ""

'If Not rsConsult.EOF Then
'   sector = rsConsult!estrdabr
'   Flog.Writeline "    los datos del sector OK"
'Else
'   Flog.Writeline "Error al obtener los datos del sector"
'   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   'CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
Cuenta = ""

StrSql = " SELECT estructura.estrdabr, ctabancaria.ctabnro "
StrSql = StrSql & " FROM ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = banco.estrnro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Banco = rsConsult!estrdabr
    Cuenta = rsConsult!ctabnro
    Flog.writeline "    los datos de Cuenta + Banco OK [<" & Cuenta & "><" & Banco & ">]"
Else
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, tercero.terrazsoc " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " INNER JOIN tercero ON tercero.ternro = empresa.ternro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
    EmpRazSoc = rs_estructura!terrazsoc
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,provincia.provdesc FROM cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON localidad.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
    EmpProv = rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpRazSoc & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & antiguedad & "'"
StrSql = StrSql & ",'" & EmpProv & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Aadi-Capif
'--------------------------------------------------------------------
Sub generarDatosRecibo52(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim tprocdesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CajaJubilacion
Dim Adicsinapo As Double
Dim Msr As Double
Dim Dtos As Double

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "    Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "    Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripcin del proceso
'------------------------------------------------------------------
StrSql = " SELECT periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,periodo.pliqDesc,periodo.pliqhasta,proceso.prodesc,tipoproc.tprocdesc,tipoproc.tprocnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " LEFT JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    ProcDesc = rsConsult!proDesc
    tprocdesc = "  "
    If EsNulo(rsConsult!tprocnro) Then
        Flog.writeline "    El tipo del proceso no esta definido para el proceso. SQL ==> " & StrSql
    Else
        If rsConsult!tprocnro <> 3 Then
            tprocdesc = rsConsult!tprocdesc
        Else
            tprocdesc = rsConsult!pliqDesc
        End If
    End If
Else
   Flog.writeline "    Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Cuil = "  "
   Flog.writeline "    Error al obtener los datos del CUIL del Empleado"
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "  "
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrnro
Else
   Flog.writeline "    Error al obtener los datos del puesto a la fecha " & pliqhasta
End If

'------------------------------------------------------------------
'Busco el valor de la caja de Jubilacin
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = "  "
If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
   Flog.writeline "    Error al obtener los datos de la Caja de Jubilacion a la fecha " & pliqhasta
End If

'------------------------------------------------------------------
'Busco el valor del sueldo neto
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acunroSueldo
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener los datos del sueldo neto. Columna 1 de la configuracin"
   Sueldo = 0
End If

'------------------------------------------------------------------
'Busco el valor del los descuentos
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumRetImpuesto
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Dtos = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con Descuentos. Columna 62 de la configuracin"
   Dtos = 0
End If

'------------------------------------------------------------------
'Busco el valor del msr
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Msr = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con Msr. Columna 61 de la configuracin"
   Msr = 0
End If

'------------------------------------------------------------------
'Busco el valor del adicsinapo
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumHaberesConAp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Adicsinapo = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con AdicSinAp. Columna 60 de la configuracin"
   Adicsinapo = 0
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "    No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " WHERE cabdom.domdefault = -1 "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "    No se encontr el domicilio indicado como default de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & " Piso " & rs_Domicilio!piso
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & Tickets & ")" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "    No se encontr el CUIT de la Empresa"
    If esTicketsConc Then
        Flog.writeline "       El paramtro 42 esta definido de TIPO 'CO'. Cambielo por otro tipo distinto"
    End If
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0

'Consulta para buscar la firma de la empresa
EmpFirma = ""
EmpFirmaAlto = 0
EmpFirmaAncho = 0

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "  "
   pliqfecdep = "  "
   pliqbco = "  "
   Flog.writeline "    No se encontraron los datos de las cargas sociales"
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & numberForSQL(EmpLogoAlto)
StrSql = StrSql & "," & numberForSQL(EmpLogoAncho)
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & numberForSQL(EmpFirmaAlto)
StrSql = StrSql & "," & numberForSQL(EmpFirmaAncho)
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(CajaJubilacion, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(tprocdesc, 1, 100) & "'"
StrSql = StrSql & "," & numberForSQL(Adicsinapo)
StrSql = StrSql & "," & numberForSQL(Msr)
StrSql = StrSql & "," & numberForSQL(Dtos)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para mercado central
'--------------------------------------------------------------------
Sub generarDatosRecibo53(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para L'Union de Paris
'--------------------------------------------------------------------
Sub generarDatosRecibo54(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto"
StrSql = StrSql & " From tercero "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = tercero.ternro AND tercero.ternro = " & ternro
StrSql = StrSql & " AND cabdom.domdefault = -1 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
'05/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir
If Not rsConsult.EOF Then
    'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
    Direccion = rsConsult!calle & " " & rsConsult!Nro
    
    If Not EsNulo(rsConsult!piso) Then
        Direccion = Direccion & " P. " & rsConsult!piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CCU
'--------------------------------------------------------------------
Sub generarDatosRecibo55(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim nrodoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux
Dim meses_aux
Dim antiguedad
Dim CentroCosto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Perodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
If Fecha_aux < empFecAlta Then
    antiguedad = "Aos: 0 Meses: 0"
Else
    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
        anios_aux = anios_aux - 1
    End If
    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
        meses_aux = meses_aux - 1
    End If
    antiguedad = "Aos: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    rsConsult.Close
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nrodoc = rsConsult!tidsigla & "-" & rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   nrodoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categora."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 10 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!Nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Bsico
'------------------------------------------------------------------
Sueldo = 0
If Tickets <> 0 Then
    'Columna 42
    If esTicketsConc Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Tickets & " AND novemp.tpanro = 1"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Sueldo = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Bsico se obtuvo de la novedad para el concepto (concnro=" & Tickets & ") y parmetro 1."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 1"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   Sueldo = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Bsico se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parmetro 1."
                End If
           Else
                Flog.writeline "Error al obtener el valor del Bsico. La columna 43 del confrep debe ser un concepto, de tipo 'CO'."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor del Bsico. La columna 42 del confrep debe ser un concepto, de tipo 'CO'."
    End If
    
Else
    Flog.writeline "Error al obtener el valor del Bsico. No esta configurado el concepto en la columna 42 del confrep."
End If
    
    
If Sueldo = 0 Then
    'Buscar en la escala de Bsicos
    
    'Determinar la sucursal del empleado. Ya la tengo
    If SucursalNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Sucursal para determinar la escala del Bsico."
    End If
    
    'Determinar el Convenio del empleado.
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       ConvenioNro = rsConsult!estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Bsico."
       ConvenioNro = 0
    '   GoTo MError
    End If
    
    'Determinar la categoria del empleado. Ya la tengo
    If CategoriaNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categora para determinar la escala del Bsico."
    End If
    
    'Determinar la Forma de Liquidacion
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       FormaLiqNro = rsConsult!estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidacin para determinar la escala del Bsico."
       FormaLiqNro = 0
    '   GoTo MError
    End If
    
    StrSql = " SELECT vgrvalor FROM valgrilla "
    StrSql = StrSql & " WHERE cgrnro = 4 "
    StrSql = StrSql & " AND vgrcoor_1 = " & SucursalNro
    StrSql = StrSql & " AND vgrcoor_2 = " & ConvenioNro
    StrSql = StrSql & " AND vgrcoor_3 = " & CategoriaNro
    StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!vgrvalor
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Bsico. No se encontro. SQL --> " & StrSql
    End If
    
End If

If Sueldo = 0 And acumHaberesConAp <> 0 Then
    'Columna 60
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acumHaberesConAp
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
       Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Bsico se obtuvo del acumulador " & acumHaberesConAp
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la Antigedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parmetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parmetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
           
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & antiguedad & "'"
StrSql = StrSql & ",'" & nrodoc & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CCU - Finca
'--------------------------------------------------------------------
Sub generarDatosRecibo56(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim nrodoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux
Dim meses_aux
Dim antiguedad
Dim CentroCosto
Dim BancoPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim AntigGrilla
Dim salir

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Perodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
If Fecha_aux < empFecAlta Then
    antiguedad = "Aos: 0 Meses: 0"
Else
    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
        anios_aux = anios_aux - 1
    End If
    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
        meses_aux = meses_aux - 1
    End If
    antiguedad = "Aos: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    rsConsult.Close
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nrodoc = rsConsult!tidsigla & "-" & rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   nrodoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categora."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 10 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!Nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Bsico
'------------------------------------------------------------------
Sueldo = 0
If concnroVacPend <> 0 Then
    StrSql = " SELECT novemp.nevalor valor "
    StrSql = StrSql & " FROM novemp "
    StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & concnroVacPend & " AND novemp.tpanro = 1"
    OpenRecordset StrSql, rsConsult
     
    If Not rsConsult.EOF Then
        Sueldo = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Bsico se obtuvo de la novedad para el concepto (concnro=" & concnroVacPend & ") y parmetro 1."
    Else
        'Buscar en la escala de Bsicos
        
        'Determinar el Convenio del empleado.
        StrSql = " SELECT his_estructura.estrnro "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           ConvenioNro = rsConsult!estrnro
        Else
           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Bsico."
           ConvenioNro = 0
        End If
        
        'Determinar la categoria del empleado. Ya la tengo
        If CategoriaNro = 0 Then
           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categora para determinar la escala del Bsico."
        End If
        
        'Determinar la Antiguedad, columna 90 del confrep
        StrSql = " SELECT * FROM confrep "
        StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 90"
        OpenRecordset StrSql, rsConsult
        If rsConsult.EOF Then
            Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Antigedad para determinar la escala del Bsico. No esta configurada la columna 90. Tipo posibles AC (acumulador), CAN (cantidad del concepto), MON (monto del concepto)."
            AntigGrilla = 0
        Else
            If rsConsult!conftipo = "AC" Then
                StrSql = " SELECT almonto valor"
                StrSql = StrSql & " From acu_liq"
                StrSql = StrSql & " Where acunro = " & rsConsult!confval
                StrSql = StrSql & " AND cliqnro = " & cliqnro
                OpenRecordset StrSql, rs_estructura
                
                If Not rs_estructura.EOF Then
                   AntigGrilla = rs_estructura!Valor
                End If
                
                rs_estructura.Close
            Else
                StrSql = "SELECT detliq.dlicant, detliq.dlimonto "
                StrSql = StrSql & " FROM concepto INNER JOIN detliq ON concepto.concnro = detliq.concnro"
                StrSql = StrSql & " WHERE conccod = " & rsConsult!confval
                If Not EsNulo(rsConsult!confval2) Then
                    StrSql = StrSql & " OR conccod = '" & rsConsult!confval2 & "'"
                End If
                StrSql = StrSql & " AND detliq.cliqnro = " & cliqnro
                OpenRecordset StrSql, rs_estructura
              
                If rsConsult!conftipo = "CAN" Then
                    AntigGrilla = rs_estructura!dlicant
                Else
                    AntigGrilla = rs_estructura!dlimonto
                End If
                
                rs_estructura.Close
            End If
        End If
        
        'Determinar la Forma de Liquidacion
        StrSql = " SELECT his_estructura.estrnro "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & ternro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           FormaLiqNro = rsConsult!estrnro
        Else
           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidacin para determinar la escala del Bsico."
           FormaLiqNro = 0
        End If
        
        StrSql = " SELECT vgrcoor_3, vgrvalor FROM valgrilla "
        StrSql = StrSql & " WHERE cgrnro = 45 "
        StrSql = StrSql & " AND vgrcoor_1 = " & ConvenioNro
        StrSql = StrSql & " AND vgrcoor_2 = " & CategoriaNro
        StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
        StrSql = StrSql & " ORDER BY vgrcoor_3 DESC"
        OpenRecordset StrSql, rsConsult
        salir = False
        Do Until rsConsult.EOF Or salir
            If (AntigGrilla >= rsConsult!vgrcoor_3) Then
                salir = True
                Sueldo = rsConsult!vgrvalor
            End If
            rsConsult.MoveNext
        Loop
        
        If Not salir Then
           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Bsico. No se encontro. SQL --> " & StrSql
        End If

    End If
Else
     Flog.writeline "Error al obtener el valor de la Antigedad. La columna 53 del confrep debe ser un concepto."
End If
    
'------------------------------------------------------------------
'Busco el valor de la Antigedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parmetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parmetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
    BancoPago = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    BancoPago = "&nbsp;"
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
   BancoPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & antiguedad & "'"
StrSql = StrSql & ",'" & nrodoc & "'"
StrSql = StrSql & ",'" & Mid(BancoPago, 1, 100) & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Latin 3
'--------------------------------------------------------------------
Sub generarDatosRecibo57(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Horvath
'--------------------------------------------------------------------
Sub generarDatosRecibo58(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim convenio
Dim CajaJubilacion
Dim AntigDias As Integer
Dim AntigMeses As Integer
Dim AntigAnios As Integer

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

convenio = ""

If Not rsConsult.EOF Then
   convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la caja de jubilacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = ""

If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la caja de jubilacion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxdeci1, auxdeci2, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & convenio & "'"
StrSql = StrSql & ",'" & CajaJubilacion & "'"
StrSql = StrSql & "," & AntigDias
StrSql = StrSql & "," & AntigMeses
StrSql = StrSql & "," & AntigAnios
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de Praxair
'--------------------------------------------------------------------
Sub generarDatosRecibo59(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTickets As Double
Dim vhora

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMTSS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

' _____________________________________________________________________________
' Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS
' _____________________________________________________________________________

Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estrctura BSE (col 113)."
Else
    If rsConsult!conftipo = "TE" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

' _________________________________________________________________________

       


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   ' el sueldo se saca del concepto 01000
   Sueldo = 0
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Cuil = " "
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'Se cambio -- Sueldo se busca en la columna 44
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo (en los datos del empleado setee la variable Sueldo=0)

'If Sueldo = 0 Then
'    If esSueldoConc Then
'        StrSql = " SELECT detliq.dlimonto valor "
'        StrSql = StrSql & " FROM detliq "
'        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
'    Else
'        StrSql = " SELECT almonto valor"
'        StrSql = StrSql & " From acu_liq"
'        StrSql = StrSql & " Where acunro = " & acunroSueldo
'        StrSql = StrSql & " AND cliqnro = " & cliqnro
'    End If
    
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!Valor
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo (col 1)."
'       Sueldo = 0
       'GoTo MError
'    End If
'End If



'------------------------------------------------------------------
'Busco el valor del Monto Tickets, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
    
        'CabliqNumero = rsConsult!cliqnro
        If Not IsNull(rsConsult!Valor) Then
            MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
        End If
    
        rsConsult.MoveNext
    Loop
Else
      Flog.writeline " No se encontraron datos de MONTO TICKETS (col42)."

End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 43 del confrep
' Se cometa porque en BA se uso la columna 44 para vhora
'Se cambio -- se usa col 43 para v. hora.
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

vhora = 0
If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de V.HORA/BASICO. (col43)"
   vhora = 0
   'GoTo MError
End If


'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

Sueldo = 0
If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult
Categoria = " "
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult
CentroCosto = " "
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult
FormaPago = " "

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = " "
If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, paisdesc  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " left JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " ORDER BY domdefault "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


' -------------------------------------------------------------------------
'Consulta para obtener el MTSS de la empresa
Flog.writeline "Buscando el MTSS tipo de doc " & CodMTSS
StrSql = " SELECT *"
StrSql = StrSql & " From ter_doc"
StrSql = StrSql & " Where ter_doc.ternro = " & rs_estructura!ternro & " And ter_doc.tidnro = " & CodMTSS
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el MTSS"
    EmpMTSS = "  "
Else
    Flog.writeline "MTSS = " & rs_cuit!nrodoc
    EmpMTSS = IIf(EsNulo(rs_cuit!nrodoc), " ", rs_cuit!nrodoc)
End If



' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!nrodoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!nrodoc
End If


' -------------------------------------------------------------------------
'Consulta para obtener el BSE del empleado
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = " SELECT his_estructura.estrnro, estrdabr, estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro= " & CodBSE & " AND his_estructura.ternro=" & ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontr el BSE"
    EmpBSE = " "
Else
    Flog.writeline "BSE = " & rsConsult!estrnro & " " & rsConsult!estrdabr & "COD Externo " & rsConsult!estrcodext
    EmpBSE = IIf(EsNulo(rsConsult!estrcodext), " ", rsConsult!estrcodext)
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
'Flog.Writeline "======================================================================================================================================="
'Flog.Writeline ":::INSERTO EN REP_RECIBO::: "
'Flog.Writeline "Sueldo=" & Sueldo
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden "
StrSql = StrSql & " , auxchar1, auxchar2, auxchar3, auxchar4 "
StrSql = StrSql & " , auxdeci1, auxdeci2 "
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMTSS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & "," & numberForSQL(MontoTickets)
StrSql = StrSql & "," & numberForSQL(vhora)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Gedas
'--------------------------------------------------------------------
Sub generarDatosRecibo60(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial As String
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim pliqDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CodCAT As Long
Dim CodDPTO As Long

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = IIf(EsNulo(rsConsult!proFecPago), "", rsConsult!proFecPago)
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'Dpto---------------------------------------------------------------------------------
CodCAT = 0
CodDPTO = 0

Flog.writeline "Buscando el valor de campo Dpto recibo en columna 100."
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estrctura DPTO (col 100)."
Else
    If rsConsult!conftipo = "TE" Then
        CodDPTO = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
    Else
        Flog.writeline " El Tipo de Columna 100 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

'CAT---------------------------------------------------------------------------------
Flog.writeline "Buscando el valor de campo CAT recibo en columna 101."
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estrctura CAT (col 101)."
Else
    If rsConsult!conftipo = "TE" Then
        CodCAT = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
    Else
        Flog.writeline " El Tipo de Columna 101 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = IIf(EsNulo(rsConsult!empfaltagr), "", rsConsult!empfaltagr)
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = IIf(EsNulo(rsConsult!pliqDesc), "", rsConsult!pliqDesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = IIf(EsNulo(rsConsult!nrodoc), "", rsConsult!nrodoc)
Else
   Cuil = ""
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro
    
    If Not EsNulo(rsConsult!piso) Then
        Direccion = Direccion & " P. " & rsConsult!piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la DPTO (confrep 100)
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & CodDPTO & " And his_estructura.ternro = " & ternro
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
   Flog.writeline "No se encontro Dpto."
End If


'------------------------------------------------------------------
'Busco el valor del CAT (confrep 101)
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro =  " & CodCAT & "  And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
   Flog.writeline "No se encontro CAT."
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro, estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
OpenRecordset StrSql, rs_estructura

ObraSocial = ""
Puesto = ""
If Not rs_estructura.EOF Then
    ObraSocial = IIf(EsNulo(rs_estructura!estrdabr), "", rs_estructura!estrdabr)
   
    'Busco el codigo SIJP de la obra social
    StrSql = "SELECT * FROM estr_cod WHERE estrnro =" & rs_estructura!estrnro
    StrSql = StrSql & " AND tcodnro = 1"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Puesto = IIf(EsNulo(rsConsult!nrocod), "", rsConsult!nrocod)
    Else
        Flog.writeline "No se encontr el codigo SIJP para Obra social"
        Puesto = ""
    End If
   
   
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT banco.bansucdesc, formapago.fpagdescabr, ctabancaria.ctabnro"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
If Not rsConsult.EOF Then
    FormaPago = IIf(EsNulo(rsConsult!bansucdesc), "", rsConsult!bansucdesc)
    FormaPago = FormaPago & " " & IIf(EsNulo(rsConsult!fpagdescabr), "", rsConsult!fpagdescabr)
    FormaPago = FormaPago & " " & IIf(EsNulo(rsConsult!ctabnro), "", rsConsult!ctabnro)
Else
   Flog.writeline "No se encontro los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = IIf(EsNulo(rs_estructura!empnom), "", rs_estructura!empnom)
    EmpEstrnro = rs_estructura!estrnro
End If


'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " WHERE cabdom.domdefault = -1 "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    EmpDire = ""
    Localidad = ""
Else
    EmpDire = IIf(EsNulo(rs_Domicilio!calle), "", rs_Domicilio!calle)
    Localidad = EmpDire
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " (" & rs_Domicilio!codigopostal & ")"
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = IIf(EsNulo(rs_cuit!nrodoc), "", rs_cuit!nrodoc)
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = IIf(EsNulo(rsConsult!periodoant), "", rsConsult!periodoant)
   pliqfecdep = IIf(EsNulo(rsConsult!Fecha), "", rsConsult!Fecha)
   pliqbco = IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Mid(Apellido, 1, 50) & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & Mid(pliqdepant, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(pliqfecdep, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(pliqbco, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Cuil, 1, 30) & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proFecPago, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(EmpNombre, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpDire, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpCuit, 1, 30) & "'"
StrSql = StrSql & ",'" & Mid(EmpLogo, 1, 100) & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & Mid(EmpFirma, 1, 100) & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 60) & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Mid(pliqDesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de AGD
'--------------------------------------------------------------------
Sub generarDatosRecibo61(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Art
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim Cuenta
Dim RegJub

Dim empFecBaja

Dim Condicion

Dim empreporta
Dim CalifProfe
Dim Planta
Dim Suc

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim Bandesc
Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf

Dim SueldoConvenio
Dim esSueldoConvenioCon
Dim valorSueldoConvConf

Dim Familiar
Dim valorFamiliarConf
Dim esFamiliarCon

Dim SuelTotEmp
Dim esSuelTotEmpCon
Dim valorSuelTotEmp

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = IIf(EsNulo(rsConsult!empFecBaja), "", rsConsult!empFecBaja)
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = IIf(EsNulo(rsConsult!estrnro), "", rsConsult!estrnro)
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor Basico de Convenio empresa, definido en la columna 100 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esSueldoConvenioCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorSueldoConvConf = 0
        Else
          valorSueldoConvConf = rsConsult2!concnro
        End If
        rsConsult2.Close
    Else
        esSueldoConvenioCon = False
        valorSueldoConvConf = rsConsult!confval
    End If
    
    SueldoConvenio = 0

    If esSueldoConvenioCon Then
      
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & valorSueldoConvConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SueldoConvenio = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & valorSueldoConvConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SueldoConvenio = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto Sueldo Basico de Convenio (col 100)."

End If


'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!concnro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If

  
'------------------------------------------------------------------
'Busco el valor de Sueldo total empresa, definido en la columna 102 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 102 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esSuelTotEmpCon = True
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorSuelTotEmp = 0
        Else
          valorSuelTotEmp = rsConsult2!concnro
        End If
        rsConsult2.Close

    Else
        esSuelTotEmpCon = False
        valorSuelTotEmp = rsConsult!confval
    End If
    
    SuelTotEmp = 0

    If esSuelTotEmpCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & valorSuelTotEmp
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SuelTotEmp = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & valorSuelTotEmp
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SuelTotEmp = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto Sueldo total empresa  (col 102)."

End If


'------------------------------------------------------------------
'Busco el valor Total de Asignaciones Familiares, definido en la columna 103 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esFamiliarCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorFamiliarConf = 0
        Else
          valorFamiliarConf = rsConsult2!concnro
        End If
        rsConsult2.Close
    Else
        esFamiliarCon = False
        valorFamiliarConf = rsConsult!confval
    End If
    
    Familiar = 0

    If esFamiliarCon Then
      
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro & " AND detliq.concnro = " & valorFamiliarConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Familiar = rsConsult!Valor
        End If
    Else
        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & ternro & " AND acu_liq.acunro = " & valorFamiliarConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Familiar = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto de Total de Asignaciones Familiares (col 103)."
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del la Calif. Profesional.
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

CalifProfe = ""

If Not rsConsult.EOF Then
   CalifProfe = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la calificacion profesional"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Reg Jub
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

RegJub = ""

If Not rsConsult.EOF Then
   RegJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Reg Jub"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor para campo Condicion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 31 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Condicion = ""

If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del "
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Art
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=40 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult
 
Art = ""

If Not rsConsult.EOF Then
   Art = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la ART"
'   GoTo MError
End If




'------------------------------------------------------------------
'Busco el valor de la Planta
'------------------------------------------------------------------

StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=35 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult
 
Planta = ""

If Not rsConsult.EOF Then
   Planta = rsConsult!estrcodext
Else
   'Flog.writeline "Error al obtener los datos de la Planta"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Sucursal (Lugar de pago)
'------------------------------------------------------------------

StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=1 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult
 
Suc = ""

If Not rsConsult.EOF Then
   Suc = rsConsult!estrcodext
Else
   'Flog.writeline "Error al obtener los datos de la Sucursal"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
     Cuenta = rsConsult!ctabnro
     Bandesc = rsConsult!Bandesc
  Else
      Cuenta = ""
      Bandesc = ""
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = ""
If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr la Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1,auxdeci2,auxdeci3,auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Art, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & RegJub & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Suc & "'"
StrSql = StrSql & ",'" & Mid(Bandesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Condicion, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Planta, 1, 15) & "'"
StrSql = StrSql & ",'" & Mid(CalifProfe, 1, 100) & "'"
StrSql = StrSql & "," & SueldoConvenio
StrSql = StrSql & "," & SuelTotEmp
StrSql = StrSql & "," & Familiar
StrSql = StrSql & "," & FuturosAumentos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para A.C.A.R.A.
'--------------------------------------------------------------------
Sub generarDatosRecibo62(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim nrodoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Perodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
If EsNulo(empFecAlta) Then
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & ternro & " AND fasrecofec = -1 "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
    Else
        rsConsult.Close
        StrSql = " SELECT altfec "
        StrSql = StrSql & " FROM fases "
        StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            empFecAlta = rsConsult!altfec
        Else
            Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
            empFecAlta = "&nbsp;"
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categora."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!Nro
    If Not EsNulo(rsConsult!piso) Then
        Direccion = Direccion & " " & rsConsult!piso & " piso"
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc
   
    Localidad = Direccion
   
'   Localidad = rsConsult!locdesc
'   Flog.writeline "    los datos de la localidad OK"
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
    If Not EsNulo(rs_Domicilio!piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

''Consulta para buscar el logo de la empresa
'StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
'    " From ter_imag " & _
'    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
'    " AND ter_imag.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_logo
'If rs_logo.EOF Then
'    Flog.writeline "No se encontr el Logo de la Empresa."
'    'Exit Sub
'    EmpLogo = ""
'    EmpLogoAlto = 0
'    EmpLogoAncho = 0
'Else
'    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
'    EmpLogoAlto = rs_logo!tipimaltodef
'    EmpLogoAncho = rs_logo!tipimanchodef
'End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para EKI
'--------------------------------------------------------------------
Sub generarDatosRecibo63(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim nrodoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Long
Dim CtaNro As String
Dim CtaBanco As String
Dim netoPesos
Dim netoBonos

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
'   If IsNull(rsConsult!empremu) Then
'      Sueldo = 0
'   Else
'      Sueldo = rsConsult!empremu
'   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqDesc = rsConsult!pliqDesc
   tprocdesc = rsConsult!tprocdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Perodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado.
'------------------------------------------------------------------
empFecBaja = "&nbsp;"
If Not empest Then
    StrSql = " SELECT bajfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecBaja = rsConsult!bajfec
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Baja del Empleado"
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la Forma de Liquidacion
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!estrcodext = 2 Or rsConsult!estrcodext = 4 Then
        pliqDesc = Mid(tprocdesc, 1, 12) & "    " & FormatNumber(pliqmes, 2) & "-" & FormatNumber(pliqanio, 4)
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Gerencia
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Gerencia."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Tienda
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Tienda (Sucursal)."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Convenio para determinar la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    If rsConsult!estrcodext <> 2 Then
        'Busco la categoria para los dentro de convenio
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
            Puesto = rsConsult!estrdabr
        End If
    Else
        'Busco el puesto para los fuera de convenio
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
            Puesto = rsConsult!estrdabr
        End If
    End If
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del convenio para determinar la Categora."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Pesos
'------------------------------------------------------------------
netoPesos = 0
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   netoPesos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto en Pesos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Bonos
'------------------------------------------------------------------
netoBonos = 0
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   netoBonos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto en Bonos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

FormaPago = "&nbsp;"
CtaNro = "&nbsp;"
CtaBanco = "&nbsp;"
If Not rsConsult.EOF Then
    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 23"
    OpenRecordset StrSql, rs_cuit
    If Not rs_cuit.EOF Then
        CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
    Else
        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 12"
        OpenRecordset StrSql, rs_cuit
        If Not rs_cuit.EOF Then
            CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
        End If
    End If
    
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
    Else
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
    End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!Nro
    Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
    If Not EsNulo(rs_Domicilio!piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1,auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(pliqDesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaNro, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaBanco, 1, 100) & "'"
StrSql = StrSql & "," & netoPesos
StrSql = StrSql & "," & netoBonos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para GORINA
'--------------------------------------------------------------------
Sub generarDatosRecibo64(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqDesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim nrodoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Afjp As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqDesc = rsConsult!pliqDesc
    If empest = 0 Then
        proDesc = rsConsult!tprocdesc
    End If
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Perodo actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado.
'------------------------------------------------------------------
'empFecBaja = "&nbsp;"
'If Not empest Then
'    StrSql = " SELECT bajfec "
'    StrSql = StrSql & " FROM fases "
'    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'        empFecBaja = rsConsult!bajfec
'    Else
'        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Baja del Empleado"
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Centro Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de AFJP
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Afjp = "&nbsp;"
If Not rsConsult.EOF Then
    Afjp = rsConsult!estrdabr
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Tienda
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   Sector = rsConsult!estrdabr
'Else
'   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Tienda (Sucursal)."
'   Sector = "&nbsp;"
'   GoTo MError
'End If
'rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If

''------------------------------------------------------------------
''Busco los datos de la forma de pago
''------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'FormaPago = "&nbsp;"
'CtaNro = "&nbsp;"
'CtaBanco = "&nbsp;"
'If Not rsConsult.EOF Then
'    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
'    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 23"
'    OpenRecordset StrSql, rs_cuit
'    If Not rs_cuit.EOF Then
'        CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'    Else
'        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 12"
'        OpenRecordset StrSql, rs_cuit
'        If Not rs_cuit.EOF Then
'            CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'        End If
'    End If
'
'    If rsConsult!fpagbanc = "-1" Then
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
'    Else
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'    End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
''   GoTo MError
'End If
'
'rsConsult.Close

''------------------------------------------------------------------
''Busco el valor de la direccion y localidad
''------------------------------------------------------------------
'StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'OpenRecordset StrSql, rsConsult
'Direccion = "&nbsp;"
'Localidad = "&nbsp;"
'If Not rsConsult.EOF Then
'    Direccion = rsConsult!calle & " " & rsConsult!Nro
'    Localidad = Direccion
'Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   'GoTo MError
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
    EmpLocalidad = rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpLocalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Afjp, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa TelePerformance Chile
'--------------------------------------------------------------------
Sub generarDatosRecibo65(Pronro, ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecBaja
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim BancoEmpl As String
Dim CuentaEmpl As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      rsConsult.Close
      
      'Me fijo si fue dado de baja en la empresa
      StrSql = "SELECT his_estructura.estrnro,his_estructura.htethasta, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & ternro & _
            " AND his_estructura.tenro  = 10"
      
      OpenRecordset StrSql, rsConsult
      
      If rsConsult.EOF Then
         empFecBaja = "null"
      Else
         If Not IsNull(rsConsult!htethasta) Then
            empFecBaja = "'" & rsConsult!htethasta & "'"
         Else
            empFecBaja = "null"
         End If
      End If
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!nrodoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del S. Bsico"
       Sueldo = 0
    '   GoTo MError
    End If
    
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & ternro

OpenRecordset StrSql, rsConsult

BancoEmpl = ""
CuentaEmpl = ""

If Not rsConsult.EOF Then
   BancoEmpl = rsConsult!Bandesc
   CuentaEmpl = rsConsult!ctabnro
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontr la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontr el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontr el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!nrodoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontr el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontr el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & BancoEmpl & "'"
StrSql = StrSql & ",'" & CuentaEmpl & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
    StrSql = StrSql & "," & rsConsult!concnro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "ltima SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


