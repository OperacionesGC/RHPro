Attribute VB_Name = "repLibroLey"

''Global Const Version = "1.02"
''Global Const FechaModificacion = "20/03/2006"
''Global Const UltimaModificacion = " " 'Version inicial + Avisa cuando es un empleado de agencia

'Global Const Version = "1.02.1"
'Global Const FechaModificacion = "29/03/2006"
'Global Const UltimaModificacion = " "   'FAF - Nuevo Modelo 19.

'Global Const Version = "1.03"
'Global Const FechaModificacion = "30/03/2006"
'Global Const UltimaModificacion = " "   'FGZ - Modelo 16. Problemas con el campo agencia. Treae vacio, 0 y nro de agencias

'Global Const Version = "1.04"
'Global Const FechaModificacion = "21/04/2006"
'Global Const UltimaModificacion = " "   'Se agrego el modelo 20 para Litoral Gas

'Global Const Version = "1.05"
'Global Const FechaModificacion = "16/06/2006"
'Global Const UltimaModificacion = " "   'Se le agrego al estandar la posibilidad de tirar empleados de agencia.

'Global Const Version = "1.06"
'Global Const FechaModificacion = "18/06/2006"
'Global Const UltimaModificacion = " "   'Se le agrego al libro de ley de Deloitte (modelo = 16) que distinga si son empleados de agencia.

'Global Const Version = "1.07"
'Global Const FechaModificacion = "05/05/2006"
'Global Const UltimaModificacion = " "   'Correccion para cuando se seleciona empleados de agencia. Duplicaba los datos. Si no es de agencia puede tener null o 0 (se agrego que validara por 0)
                                        ' Se permiten n acumuladores. Deben definirse en el confrep de tipo 'AG'

'Global Const Version = "1.08"
'Global Const FechaModificacion = "09/06/2006"
'Global Const UltimaModificacion = " "   'Se le agrego al libro de ley de Darmex (modelo = 21)

'Global Const Version = "1.09"
'Global Const FechaModificacion = "12/06/2006"
'Global Const UltimaModificacion = " "   'Se le agrego al libro de ley de CODERE (modelo = 22)
'                                        'Correccion al obtener parametros
'Global Const Version = "1.20"
'Global Const FechaModificacion = "13/06/2006"
'Global Const UltimaModificacion = " "   'Se le agrego al libro de ley de HILERET (modelo = 23)
                                    
'Global Const Version = "1.21"
'Global Const FechaModificacion = "29/06/2006"
'Global Const UltimaModificacion = " "   'Modif en el modelo de Hileret (23)
                                    
'Global Const Version = "1.22"
'Global Const FechaModificacion = "03/07/2006"
'Global Const UltimaModificacion = " "   'Modif en el modelo 20 de LG para empleados de agencia
'                                        'creacion del modelo generarDatosEmpAge20 para procesar
'                                        'empleados de agencia de LG
'                                        'Se cambio la forma de buscar empleados de agencia POR ESTRUCT
'    OJO CON D E L O I T T E  P E R S O N A L  QUE ESTA USANDO EL MODELO DE EMPLEADO DE AGENCIA DE LA
'    Tabla Empleado
                                        
'Global Const Version = "1.23"
'Global Const FechaModificacion = "10/07/2006"
'Global Const UltimaModificacion = " "   'Correccion al insertar los detalles en el modelo 20

'Global Const Version = "1.24"
'Global Const FechaModificacion = "20/07/2006"
'Global Const UltimaModificacion = " "   'Cambio en el domicilio en el modelo 20
                                        
                                    
'Global Const Version = "1.25"
'Global Const FechaModificacion = "20/07/2006" 'FGZ
'Global Const UltimaModificacion = " "   'Se le agrego log al libro de ley de astra (modelo = 9)
                                  
'Global Const Version = "1.26"
'Global Const FechaModificacion = "07/08/2006"
'Global Const UltimaModificacion = " "   'Se le agrego log al main,
''                                           en el ME: se le agregó el ultimo SQL ej.
''                                           en el modelo 9: cuando inserta conceptos sin tipo configurado
                                    
'Global Const Version = "1.27" ' Lisandro Moro
'Global Const FechaModificacion = "05/09/2006"
'Global Const UltimaModificacion = " Nuevo modelo 24 para Apex"
                                  
'Global Const Version = "1.27" ' Lisandro Moro
'Global Const FechaModificacion = "13/09/2006"
'Global Const UltimaModificacion = " Se agregaron algunas modificaciones pedidas por el cliente en el modelo 24 para Apex"

'Global Const Version = "1.28" ' Martin Ferraro
'Global Const FechaModificacion = "02/10/2006"
'Global Const UltimaModificacion = "" 'Se agrego piso y dpto a la dir del la empresa

'Global Const Version = "1.29" ' Lisandro Moro
'Global Const FechaModificacion = "18/10/2006"
'Global Const UltimaModificacion = "" 'Nuevo modelo 25 Mercado Central

'Global Const Version = "1.30" ' Lisandro Moro
'Global Const FechaModificacion = "15/11/2006"
'Global Const UltimaModificacion = "Modelo 26 GEDAS"

'Global Const Version = "1.31" ' Gustavo Ring
'Global Const FechaModificacion = "09/03/2007"
'Global Const UltimaModificacion = "Modelo 27 AGD"

'Global Const Version = "1.32" ' Lisandro Moro
'Global Const FechaModificacion = "20/04/2007"
'Global Const UltimaModificacion = "Modificacion al modelo 20 Litoral gas, Datos de Agencia"


'Global Const Version = "1.33" ' Diego Rosso
'Global Const FechaModificacion = "13/07/2007"
'Global Const UltimaModificacion = "Se creo el modelo 28 para REDEPA"

'Global Const Version = "1.34" ' Diego Rosso
'Global Const FechaModificacion = "04/10/2007"
'Global Const UltimaModificacion = "Se creo el modelo 29 para PapelBril" 'Se genero a partir del Standard

'Global Const Version = "1.35" ' Lisandro Moro
'Global Const FechaModificacion = "02/11/2007"
'Global Const UltimaModificacion = "Se creo el modelo 30 para Horwath" 'Se genero a partir del Standard

'Global Const Version = "1.36" ' Gustavo Ring
'Global Const FechaModificacion = "02/01/2008"
'Global Const UltimaModificacion = "Se modifico modelo 30 para Horwath"

'Global Const Version = "1.37" ' Gustavo Ring
'Global Const FechaModificacion = "02/01/2008"
'Global Const UltimaModificacion = "Se creo el modelo 31 para Duke" ' Se genero a partir del modelo 1

'Global Const Version = "1.38" ' Martin Ferraro
'Global Const FechaModificacion = "15/04/2008"
'Global Const UltimaModificacion = "Ant Rec en estandar" '

'Global Const Version = "1.39" ' Gustavo Ring
'Global Const FechaModificacion = "12/05/2008"
'Global Const UltimaModificacion = "Se creo el modelo 32 para Andreani" ' Se genero a partir del modelo 1

'Global Const Version = "1.40" ' Gustavo Ring
'Global Const FechaModificacion = "13/01/2009"
'Global Const UltimaModificacion = "Se creo el modelo 33 Altaplastica" ' Se genero a partir del modelo 1

'Global Const Version = "1.41" ' Hatsembiller Octavio
'Global Const FechaModificacion = "30/01/2009"
'Global Const UltimaModificacion = "Se creo el modelo 34 para Vital" ' Se genero a partir del modelo 9

'Global Const Version = "1.42" ' Hatsembiller Octavio
'Global Const FechaModificacion = "01/06/2009"
'Global Const UltimaModificacion = "Se creo el modelo 35 para Actionline" ' Se genero a partir del modelo 34

'Global Const Version = "1.43" ' Hatsembiller Octavio
'Global Const FechaModificacion = "02/06/2009"
'Global Const UltimaModificacion = "Se creo el modelo 36 para TPS" ' Se genero a partir del modelo 35

'Global Const Version = "1.44" ' Hatsembiller Octavio
'Global Const FechaModificacion = "01/07/2009"
'Global Const UltimaModificacion = "Se creo el modelo 37 para Administradora Sanatorial" ' Se genero a partir del modelo 34

'Global Const Version = "1.45" ' Hatsembiller Octavio
'Global Const FechaModificacion = "28/07/2009"
'Global Const UltimaModificacion = "Se creo el modelo 1 para Dalkia" ' Se genero a partir del modelo 1

'Global Const Version = "1.46" ' Cesar Stankunas
'Global Const FechaModificacion = "07/08/2009"
'Global Const UltimaModificacion = ""    'Encriptacion de string connection

'Global Const Version = "1.47" ' Hatsembiller Octavio
'Global Const FechaModificacion = "07/10/2009"
'Global Const UltimaModificacion = "Se creo el modelo 39 para Grupo Cargo" ' Se genero a partir del modelo 1

'Global Const Version = "1.48" ' Hatsembiller Octavio
'Global Const FechaModificacion = "07/12/2009"
'Global Const UltimaModificacion = "Se creo el modelo 1 para Medicus" ' Se genero a partir del modelo 1

'Global Const Version = "1.49" ' Cesar Stankunas
'Global Const FechaModificacion = "25/01/2010"
'Global Const UltimaModificacion = "Se modifico el modelo 37 (se agrego la busqueda de sexo)"

'Global Const Version = "1.50" ' Cesar Stankunas
'Global Const FechaModificacion = "01/02/2010"
'Global Const UltimaModificacion = "Se modifico el modelo 37 (Se guarda la Antiguedad Reconocida en el campo auxchar5 y se agregó la búsqueda del campo 'famfec')"

'Global Const Version = "1.51" ' Domingo Pacheco
'Global Const FechaModificacion = "19/03/2010"
'Global Const UltimaModificacion = "se agregó el modelo 41 para price"

'Global Const Version = "1.52" ' Cesar Stankunas
'Global Const FechaModificacion = "26/03/2010"
'Global Const UltimaModificacion = "Se modifica el modelo 40 de Medicus"

'Global Const Version = "1.53" ' Domingo Pacheco
'Global Const FechaModificacion = "16/04/2010"
'Global Const UltimaModificacion = "Se modificó para que incluya la obra social en un campo auxiliar"

'Global Const Version = "1.54" ' Lisandro Moro
'Global Const FechaModificacion = "16/06/2010"
'Global Const UltimaModificacion = "Modificaciones al modelo 39 Grupo Cargo"

'Global Const Version = "1.55" ' Stankunas Cesar
'Global Const FechaModificacion = "18/06/2010"
'Global Const UltimaModificacion = "Se modifico la función 'BuscarDatosEmpresa' para que agregue el Codigo Postal cuando sea el modelo 41 ()"

'Global Const Version = "1.56" ' Lisandro Moro
'Global Const FechaModificacion = "08/07/2010"
'Global Const UltimaModificacion = "Modificaciones al modelo 39 Grupo Cargo, se agrego el acumulador no remunerativo"

'Global Const Version = "1.57" ' Dimatz Rafael
'Global Const FechaModificacion = "23/08/2010"
'Global Const UltimaModificacion = "Se agrego la funcion buscardatosempresametroma, para obtener la informacion necesaria en el encabezado y se agrego generardatosempleado42"

'Global Const Version = "1.58" ' Stankunas Cesar
'Global Const FechaModificacion = "27/08/2010"
'Global Const UltimaModificacion = "se agregó el modelo 43 para Molinos Canepa (Copia del Modelo 15 - Los Grobo)"

'Global Const Version = "1.59" ' Stankunas Cesar
'Global Const FechaModificacion = "11/02/2011"
'Global Const UltimaModificacion = "se agregó el modelo 44 para Freddo-Armoa Cafe (Copia del Modelo 1)"

'Global Const Version = "1.60" ' Verónica Bogado
'Global Const FechaModificacion = "15/04/2011"
'Global Const UltimaModificacion = "se agregó el modelo 45 para Hospital Británico (Copia del Modelo 1)"

'Global Const Version = "1.61" ' Verónica Bogado
'Global Const FechaModificacion = "30/05/2011"
'Global Const UltimaModificacion = "Se agregó el modelo 46 para Edeste"

'Global Const Version = "1.62" ' Dimatz Rafael
'Global Const FechaModificacion = "09/06/2011"
'Global Const UltimaModificacion = "Se modifico para que muestre la fecha de inicio del familiar y el sexo del empleado"

'Global Const Version = "1.63" ' Dimatz Rafael
'Global Const FechaModificacion = "30/06/2011"
'Global Const UltimaModificacion = "Se agrego modelo 47 para Farmografica"

'Global Const Version = "1.64" ' Stremel Sebastian
'Global Const FechaModificacion = "19/07/2011"
'Global Const UltimaModificacion = "se reciben nuevos parametros como tope y tomo que se insertan en rep_libroley para modelo standar"
                                                        
'Global Const Version = "1.65" ' Dimatz Rafael
'Global Const FechaModificacion = "25/07/2011"
'Global Const UltimaModificacion = "Se creo el Modelo 48 para General Mills"

'Global Const Version = "1.66" ' Dimatz Rafael
'Global Const FechaModificacion = "25/08/2011"
'Global Const UltimaModificacion = "Se modifico el modelo 46 Edeste y se agrego en el main RT Retenciones"

'Global Const Version = "1.67" ' Dimatz Rafael
'Global Const FechaModificacion = "30/08/2011"
'Global Const UltimaModificacion = "Se modifico el modelo 46 Edeste se agrego la provincia en la direccion"
                                                        
'Global Const Version = "1.68" ' Quintero Carmen
'Global Const FechaModificacion = "12/10/2011"
'Global Const UltimaModificacion = "Se creo el Modelo 49 para Horwath Rosario, tambien se corrigio error de parametros tomo y tope"
                                                        
'Global Const Version = "1.69" ' FGZ
'Global Const FechaModificacion = "20/10/2011"
'Global Const UltimaModificacion = "Se cambió la validacion de version"

'Global Const Version = "1.70" ' Quintero Carmen
'Global Const FechaModificacion = "24/10/2011"
'Global Const UltimaModificacion = "Se modificó en el modelo 44 la manera de mostrar la fecha de baja del empleado"

'Global Const Version = "1.71" ' Dimatz Rafael
'Global Const FechaModificacion = "24/10/2011"
'Global Const UltimaModificacion = "Se creo el modelo 50 para Coop. Seguros porque se tuvo que cambiar centro de costo para que muestre Descripcion Recibo"
                                                    
'Global Const Version = "1.72" ' Dimatz Rafael
'Global Const FechaModificacion = "23/10/2011"
'Global Const UltimaModificacion = "Se creo el modelo 51 para Timbo para que muestre domicilio de la Sucursal 1254"
                                                    
'Global Const Version = "1.73" ' Dimatz Rafael
'Global Const FechaModificacion = "15/12/2011"
'Global Const UltimaModificacion = "Se modifico el modelo 51 porque no traia bien la direccion de la Sucursal 1254"
                                                    
'Global Const Version = "1.74" ' Dimatz Rafael
'Global Const FechaModificacion = "15/12/2011"
'Global Const UltimaModificacion = "Se modifico el modelo 51 para que traiga la Obra Social"

'Global Const Version = "1.75" ' Dimatz Rafael
'Global Const FechaModificacion = "17/01/2012"
'Global Const UltimaModificacion = "Se modifico el modelo 48 Daba error en un campo al hacer una busqueda de fase"

'Global Const Version = "1.76" ' Dimatz Rafael
'Global Const FechaModificacion = "17/01/2012"
'Global Const UltimaModificacion = "Se modifico el modelo 51 no mostraba bien la direccion"

'Global Const Version = "1.77" ' Deluchi Ezequiel
'Global Const FechaModificacion = "08/02/2012"
'Global Const UltimaModificacion = "Se modifico el Modelo 49 para Horwath Rosario, mostraba antiguedad en lugar de regimen horario (columna auxchar5)"

'Global Const Version = "1.78" ' Dimatz Rafael
'Global Const FechaModificacion = "23/02/2012"
'Global Const UltimaModificacion = "Se modifico el Modelo 41 para que guarde el nro de Inscripcion configurado por confrep"

'Global Const Version = "1.79" ' Dimatz Rafael
'Global Const FechaModificacion = "23/02/2012"
'Global Const UltimaModificacion = "Se modifico el Modelo 41 para que guarde 0 si no existe el numero de Inscripcion"

'Global Const Version = "1.80" ' Dimatz Rafael
'Global Const FechaModificacion = "23/02/2012"
'Global Const UltimaModificacion = "Se modifico el Modelo 41 para que guarde bien el numero de inscripcion"

'Global Const Version = "1.81" ' Dimatz Rafael
'Global Const FechaModificacion = "29/03/2012"
'Global Const UltimaModificacion = "Se creo un modelo nuevo 52 para Mimo Vestiditos"

'Global Const Version = "1.82" ' Deluchi Ezequiel
'Global Const FechaModificacion = "30/03/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 41, se agrego Tomo y chequeos de errores"

'Global Const Version = "1.83" ' Deluchi Ezequiel
'Global Const FechaModificacion = "17/04/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 41, se agrego Tope (paghasta) "

'Global Const Version = "1.84" ' Dimatz Rafael
'Global Const FechaModificacion = "18/04/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 52, Se cambio Mensual Jornal para que traiga la estructura 22 "

'Global Const Version = "1.85" ' Sebastian Stremel
'Global Const FechaModificacion = "23/04/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 49, Se buscan los totales no remunerativos. "

'Global Const Version = "1.86" ' Sebastian Stremel
'Global Const FechaModificacion = "03/05/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 49, se van sumando los conceptos no remunerativos y luego actualizo la tabla "
'rep_libroley en el campo asi_flia donde coloco la suma de los NR --- nro de caso:CAS-15595 - HORWATH Litoral - Error en impresion de libro ley
                                                    
'Global Const Version = "1.87" ' Sebastian Stremel
'Global Const FechaModificacion = "04/05/2012"
'Global Const UltimaModificacion = "Se Modifico el modelo 49, se quito update sobre rep_libroley"

'Global Const Version = "1.88" ' Zamarbide Juan
'Global Const FechaModificacion = "29/05/2012"
'Global Const UltimaModificacion = "Se creo el modelo N° 53 como Custom para SOS, con el además se creó la función generarDatosEmpleado53 "
                                  ' Caso: CAS-15866 - SOS - LIBRO LEY
                                                    
'Global Const Version = "1.89" ' Zamarbide Juan
'Global Const FechaModificacion = "30/05/2012"
'Global Const UltimaModificacion = "Se modificó el modelo N° 53, en el mismo se comentó la búsqueda de la AntiguedadReconocida, ya que no se utilizaba " & _
'                                  " y arrojaba un error en el proceso. CAS-15866 - SOS - LIBRO LEY"
                                                    
'Global Const Version = "1.90" ' Dimatz Rafael
'Global Const FechaModificacion = "18/06/2012"
'Global Const UltimaModificacion = "Se modifico del modelo 48 el insert del rep_libroley_det el conctipo y se puso un arreglo"

'Global Const Version = "1.91" ' Dimatz Rafael
'Global Const FechaModificacion = "22/06/2012"
'Global Const UltimaModificacion = "15421 - Se agrego al modelo 01 Numero de Inscripcion "

'Global Const Version = "1.92" ' Dimatz Rafael
'Global Const FechaModificacion = "12/07/2012"
'Global Const UltimaModificacion = " 16314 - Se creo un modelo nuevo 54 para OSDOP "

'Global Const Version = "1.93" ' Dimatz Rafael
'Global Const FechaModificacion = "15/08/2012"
'Global Const UltimaModificacion = " 14201 - Se modifico el proceso 51 para verificar si es NULL el Cuil, Estado Civil y el documento, ademas se corrigio para que salga Modelo 51 "

'Global Const Version = "1.94" ' Dimatz Rafael
'Global Const FechaModificacion = "16/08/2012"
'Global Const UltimaModificacion = " 15421 - Se modifico el proceso 01 la parte de Inscripcion para que muestre el numero segun la empresa que se liquida "

'Global Const Version = "1.95" ' Sebastian Stremel
'Global Const FechaModificacion = "06/09/2012"
'Global Const UltimaModificacion = " agrego tomo y tope al modelo 14 para oleaginosa."

'Global Const Version = "1.96" ' Lisandro Moro
'Global Const FechaModificacion = "08/03/2013"
'Global Const UltimaModificacion = " Correccion bug - si tiene piso pisa el domicilio - modelo 32 "
                                                   
'Global Const Version = "1.97" ' Dimatz Rafael
'Global Const FechaModificacion = "25/03/2013"
'Global Const UltimaModificacion = " CAS 18929 - HORWATH LITORAL - Cambio Legal Libro de Ley - Modelo 49 Horwath - Se agrego Nacionalidad y Sexo"

'Global Const Version = "1.98" ' Dimatz Rafael
'Global Const FechaModificacion = "27/03/2013"
'Global Const UltimaModificacion = " CAS 18766 - NGA Galicia - Modelo 32 - Repetia el nombre de la calle, estaba 2 veces, saque una"

'Global Const Version = "1.99" ' Dimatz Rafael
'Global Const FechaModificacion = "08/04/2013"
'Global Const UltimaModificacion = " CAS 18766 - NGA Galicia - Modelo 32 - Mostraba mal el Documento, estaba mal la query"

'Global Const Version = "2.00" ' Dimatz Rafael
'Global Const FechaModificacion = "31/07/2013"
'Global Const UltimaModificacion = " CAS 20508 - Horwath Litoral AMR - Modelo 55 - Se creo Modelo nuevo para Horwath Litoral AMR"

'Global Const Version = "2.01" ' Dimatz Rafael
'Global Const FechaModificacion = "22/08/2013"
'Global Const UltimaModificacion = " CAS 20410 - BDO - GE - Modelo 56 - Se creo Modelo nuevo para BDO - GE"

'Global Const Version = "2.02" ' Dimatz Rafael
'Global Const FechaModificacion = "05/09/2013"
'Global Const UltimaModificacion = " CAS 20889 - Aluflex - Modelo 57 - Se creo Modelo nuevo para la empresa Aluflex"

'Global Const Version = "2.03" ' Dimatz Rafael
'Global Const FechaModificacion = "10/09/2013"
'Global Const UltimaModificacion = " CAS 21173 - SGS - Modelo 58 - Se creo Modelo nuevo para la empresa SGS"

'Global Const Version = "2.04" ' Dimatz Rafael
'Global Const FechaModificacion = "12/09/2013"
'Global Const UltimaModificacion = " CAS 21173 - SGS - Modelo 58 - Se agrego Actividad del Empleado"

'Global Const Version = "2.05" ' Dimatz Rafael
'Global Const FechaModificacion = "25/10/2013"
'Global Const UltimaModificacion = " CAS 21687 - Multivoice - Modelo 1 - Se agrego una condicion en la query direccion y cuit agencia que esta en generarDatosEmpAge01"

'Global Const Version = "2.06" ' Dimatz Rafael
'Global Const FechaModificacion = "11/12/2013"
'Global Const UltimaModificacion = " CAS 22798 - OSDOP - Modelo 54 - Se agrego en la variable empresa el nombre de la empresa"

'Global Const Version = "2.07" ' Carmen Quintero
'Global Const FechaModificacion = "22/08/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley - Modelo 59 - Se creo un nuevo modelo para el cliente de santana"

'Global Const Version = "2.08" ' Carmen Quintero
'Global Const FechaModificacion = "19/09/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 2] - Modelo 59 - Se modificó las consultas que obtiene el contrato y la fecha de ingreso, cuando es liquidación es final"

'Global Const Version = "2.09" ' Carmen Quintero
'Global Const FechaModificacion = "02/10/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 3] - Modelo 59 - Se modificó las consultas que obtiene el contrato y la fecha de ingreso, cuando es liquidación es final"

'Global Const Version = "2.10" ' Carmen Quintero
'Global Const FechaModificacion = "10/10/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 4] - Modelo 59 - Se modificó las consultas que obtiene el contrato, fecha de ingreso y fecha de egreso, cuando es liquidación no es final"

'Global Const Version = "2.11"
'Global Const FechaModificacion = "15/10/2014"
'Global Const UltimaModificacion = " " 'Fernandez, Matias -CAS-27515 - NORTHGATE ARINSO - ERROR EN TOTALES DE LIBRO LEY - control de valores nulos en modelo 41

'Global Const Version = "2.12" ' Carmen Quintero
'Global Const FechaModificacion = "17/10/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 5] - Modelo 59 - Se modificó las consultas que obtiene el contrato y fecha de egreso, cuando la liquidación no es primera quincena"

'Global Const Version = "2.13" ' Mauricio Zwenger
'Global Const FechaModificacion = "04/11/2014"
'Global Const UltimaModificacion = " CAS-27164 - Se creo modelo 60 para San Miguel (NGA) basado en modelo 52 mimo vestiditos"

'Global Const Version = "2.14" ' Carmen Quintero
'Global Const FechaModificacion = "20/11/2014"
'Global Const UltimaModificacion = " CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 6] - Modelo 59 - Se modificó la consulta que obtiene fecha de ingreso, cuando la liquidación es primera quincena"

'Global Const Version = "2.15" ' Mauricio Zwenger
'Global Const FechaModificacion = "02/12/2014"
'Global Const UltimaModificacion = " CAS-27164 - se agrego auxchar5 a tabla rep_libroley, se utiliza en modelo 60 para pasar antiguedad"

'Global Const Version = "2.16" ' Sebastian Stremel
'Global Const FechaModificacion = "29/12/2014"
'Global Const UltimaModificacion = " CAS-27164 - Se corrige modelo para que salgan los NR y DS se utiliza en modelo 60 para pasar antiguedad"

'Global Const Version = "2.17" ' Borrelli Facundo
'Global Const FechaModificacion = "13/01/2015"
'Global Const UltimaModificacion = "CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 7] - Modelo 59 - Se modificaron las consultas que obtienen la fecha de ingreso y el contrato, cuando es liquidación es final"

'Global Const Version = "2.18" ' Miriam Ruiz
'Global Const FechaModificacion = "27/01/2015"
'Global Const UltimaModificacion = "CAS-27164 - NGA - Críticos - Libro de Sueldos y Recibo de haberes San Miguel [Entrega 4]- Se agregó el modelo de liquidación"

'Global Const Version = "2.19" ' LM
'Global Const FechaModificacion = "04/02/2015"
'Global Const UltimaModificacion = "CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 8] - mods modelo 59 - profecini-fin altas , estados y contratos."

'Global Const Version = "2.20" ' LM
'Global Const FechaModificacion = "09/02/2015"
'Global Const UltimaModificacion = "CAS-26542 - SANTANA - Error en datos de Libro Ley [Entrega 9] - mods modelo 59 - fin altas y estados."

'Global Const Version = "2.21" ' Fernandez, Matias
'Global Const FechaModificacion = "01/04/2015"
'Global Const UltimaModificacion = "CAS-26542 - SANTANA - Error en datos de Libro Ley . - correccion modelo 59 fecha ingreso  para segunda quincena"

'Global Const Version = "2.22" ' Fernandez, Matias
'Global Const FechaModificacion = "29/04/2015"
'Global Const UltimaModificacion = "CAS-26542 - SANTANA - Error en datos de Libro Ley . - correccion modelo 59 fecha de egreso para liquidaciones finales"

'Global Const Version = "2.23" ' Dimatz Rafael
'Global Const FechaModificacion = "20/01/2016"
'Global Const UltimaModificacion = "CAS-35160 - LA CAJA - Libro Ley microficha cambios - Se creo Modelo 61. Es una copia del Modelo 53 y se agregan mas campos"

'Global Const Version = "2.24" ' Dimatz Rafael
'Global Const FechaModificacion = "22/01/2016"
'Global Const UltimaModificacion = "CAS-35160 - LA CAJA - Libro Ley microficha cambios - Se modifico para que se guarde el Centro de Costo"

Global Const Version = "2.25" ' Borrelli Facundo
Global Const FechaModificacion = "19/02/2016"
Global Const UltimaModificacion = "CAS-35239 - FAMOGRAFICA - Bug en libro ley - Se modifico el modelo 47 para que se guarde la lista de tipos de conceptos"

'--------------------------------------------------------------

'--------------------------------------------------------------
Option Explicit

Dim fs, f
'Global Flog

Dim NroLinea As Long
Dim crpNro As Long
Dim RegLeidos As Long
Dim RegError As Long
Dim RegFecha As Date
Dim NroProceso As Long

Global Path As String
Global NArchivo As String
Global Rta
Global HuboErrores As Boolean
Global EmpErrores As Boolean

Global cod_Msr As Integer
Global cod_Neto As Integer
Global cod_Basico As Integer
Global cod_Asi_flia As Integer
Global cod_Dtos As Integer
Global cod_Bruto As Integer
Global cod_Bruto_Acum As Integer
Global cod_acum_noremunerativo As Integer
Global cod_Remu As Integer
Global es_Acum_Msr As Boolean
Global es_Acum_Neto As Boolean
Global es_Acum_Basico As Boolean
Global es_Acum_Asi_flia As Boolean
Global es_Acum_Dtos As Boolean
Global es_Acum_Bruto As Boolean
Global es_Acum_Bruto_Acum As Boolean
Global es_Acum_Remu As Boolean

Global Pagina As Long
Global tipoModelo As Integer
Global arrTipoConc(1000) As Integer

Global tenro1 As Integer
Global estrnro1 As Integer
Global tenro2 As Integer
Global estrnro2 As Integer
Global tenro3 As Integer
Global estrnro3 As Integer
Global fecEstr As String
Global tipoFamiliares
Global NroBusqProg As Long
Global NroBusqProg2 As Long
Global NroBusqProg3 As Long
Global TipDocNroInscr As Long
Global empresa
Global emprNro
Global emprActiv
Global emprTer
Global emprDire
Global emprTel
Global emprProv
Global CodPostal
Global emprCuit
Global zonaDomicilio
Global concFamiliar01
Global concFamiliar02
Global concFamiliar03
Global param_empresa
Global listapronro
Global l_orden
Global filtro
Global totalEmpleados
Global cantRegistros
Global acumSueldoJornal
Global acumEmplAgencia
Global listaAcumEmplAgencia
Global incluyeAgencia As Integer

Global acumGrupo1(100) As Long
Global acumGrupo2(100) As Long
Global acumGrupo3(100) As Long
Global cantAcumGrupo1 As Long
Global cantAcumGrupo2 As Long
Global cantAcumGrupo3 As Long
Global tomo As Long
Global tope As Long
Public Function ValidarV(ByVal Version As String) As Boolean
    ' ---------------------------------------------------------------------------------------------
    ' Descripcion: Funcion que determina si el proceso esta en condiciones de ejecutarse.
    ' Autor      : sebastian stremel
    ' Fecha      : 19/07/2011
    ' ---------------------------------------------------------------------------------------------
    Dim V As Boolean
    Dim Texto As String
    Dim rs As New ADODB.Recordset
    
    On Error GoTo ME_Version
    
    V = True
    
     If Version > "1.64" Then
        Texto = "version incorrecta"
        Texto = "Revisar los campos: rep_libroley.pagHasta, rep_libroley.tomo "
        
        StrSql = "Select rep_libroley.pagHasta, rep_libroley.tomo from rep_libroley "
        OpenRecordset StrSql, rs
        
        V = True
     End If
     
    ValidarV = V
    
    Exit Function
    
ME_Version:
        Flog.writeline
        Flog.writeline Espacios(Tabulador * 1) & "Estructura de BD incompatible con la version del proceso."
        Flog.writeline Espacios(Tabulador * 1) & Texto
        Flog.writeline
        V = False
End Function

Private Sub Main()

Dim NombreArchivo As String
Dim directorio As String
Dim CArchivos
Dim archivo
Dim Folder
Dim strCmdLine As String
Dim Nombre_Arch As String

Dim StrSql As String
Dim objRs As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim objRs3 As New ADODB.Recordset
Dim fechadesde
Dim fechahasta
Dim tipoDepuracion
Dim historico As Boolean
Dim param
Dim Pronro
Dim Ternro
Dim arrpronro
Dim rsEmpl As New ADODB.Recordset
Dim rsAge As New ADODB.Recordset
Dim rsEmpresas As New ADODB.Recordset
Dim rsPeriodo As New ADODB.Recordset
Dim acunroSueldo
Dim I
Dim PID As String
Dim tituloReporte As String

Dim parametros As String
Dim ArrParametros
Dim strTempo As String
Dim orden
Dim ord
    
Dim arrpliqnro
Dim listapliqnro
Dim pliqnro

    strCmdLine = Command()
    ArrParametros = Split(strCmdLine, " ", -1)
    If UBound(ArrParametros) > 1 Then
        If IsNumeric(ArrParametros(0)) Then
            NroProceso = ArrParametros(0)
            Etiqueta = ArrParametros(1)
            EncriptStrconexion = CBool(ArrParametros(2))
            c_seed = ArrParametros(2)
        Else
             Exit Sub
        End If
    Else
        If UBound(ArrParametros) > 0 Then
            If IsNumeric(ArrParametros(0)) Then
                NroProceso = ArrParametros(0)
                Etiqueta = ArrParametros(1)
            Else
                Exit Sub
            End If
        Else
            If IsNumeric(strCmdLine) Then
                NroProceso = strCmdLine
            Else
                Exit Sub
            End If
        End If
    End If
    
    ' carga las configuraciones basicas, formato de fecha, string de conexion,
    ' tipo de BD y ubicacion del archivo de log
    Call CargarConfiguracionesBasicas
    
    HuboErrores = False
    
    Nombre_Arch = PathFLog & "ReporteLibroLey" & "-" & NroProceso & ".log"
    
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set Flog = fs.CreateTextFile(Nombre_Arch, True)
    
    Flog.writeline "Inicio Proceso de Libro Ley : " & Now
    Flog.writeline "Cambio el estado del proceso a Procesando"
    
    ' Obtengo el Process ID
    PID = GetCurrentProcessId
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline "Version = " & Version
    Flog.writeline "Modificacion = " & UltimaModificacion
    Flog.writeline "Fecha = " & FechaModificacion
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline
    Flog.writeline "PID = " & PID
    
    TiempoInicialProceso = GetTickCount
    On Error Resume Next
    OpenConnection strconexion, objConn
    If Err.Number <> 0 Or Error_Encrypt Then
        Flog.writeline Espacios(Tabulador * 0) & "Problemas en la conexion"
        Exit Sub
    End If
    On Error GoTo CE
    
    'Cambio el estado del proceso a Procesando
    StrSql = "UPDATE batch_proceso SET bprchorainicioej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecinicioej = " & ConvFecha(Date) & ", bprcestado = 'Procesando', bprcpid = " & PID & " WHERE bpronro = " & NroProceso
    objConn.Execute StrSql, , adExecuteNoRecords
    
    Flog.writeline "Obtengo los datos del proceso"
    
    TiempoAcumulado = GetTickCount
    
    'Obtengo los datos del proceso
    StrSql = "SELECT * FROM batch_proceso WHERE bpronro = " & NroProceso
    OpenRecordset StrSql, objRs
    
    If Not objRs.EOF Then
       
'       'Obtengo los parametros del proceso
'       parametros = objRs!bprcparam
'       ArrParametros = Split(parametros, "@")
'
'       'Obtengo la lista de procesos
'       listapronro = ArrParametros(0)
'
'       'Obtengo el modelo a usar para obtener los datos
'       tipoModelo = ArrParametros(1)
'
'       'Obtengo el nro de la ultima pagina impresa
'       Pagina = CLng(ArrParametros(2))
'
'       'Obtengo el tipo de familiares
'       tipoFamiliares = ArrParametros(3)
'
'       'Obtengo los cortes de estructura
'       tenro1 = CInt(ArrParametros(4))
'       estrnro1 = CInt(ArrParametros(5))
'       tenro2 = CInt(ArrParametros(6))
'       estrnro2 = CInt(ArrParametros(7))
'       tenro3 = CInt(ArrParametros(8))
'       estrnro3 = CInt(ArrParametros(9))
'       fecEstr = ArrParametros(10)
'
'       'Obtengo el titulo del reporte
'       tituloReporte = ArrParametros(11)
'
'       'Obtengo si incluye agencia o no
'       incluyeAgencia = ArrParametros(12)
       
       
   'Obtengo los parametros del proceso

       parametros = objRs!bprcparam
       Flog.writeline " parametros --> " & parametros
       ArrParametros = Split(parametros, "@")

       Flog.writeline " limite del array --> " & UBound(ArrParametros)

       'Obtengo la lista de procesos
       listapronro = ArrParametros(0)

       'Obtengo el modelo a usar para obtener los datos
       tipoModelo = ArrParametros(1)

    'FGZ - 20/10/2011 --------- Control de versiones ------
    Version_Valida = ValidarV(Version)
    If Not Version_Valida Then
        'Actualizo el progreso
        MyBeginTrans
            StrSql = "UPDATE batch_proceso SET bprchorainicioej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecinicioej = " & ConvFecha(Date) & ", bprcprogreso = 0, bprcestado = 'Error de Version', bprcpid = " & PID & " WHERE bpronro = " & NroProceso
            objconnProgreso.Execute StrSql, , adExecuteNoRecords
        MyCommitTrans
        Flog.writeline
        GoTo Fin
    End If
    'FGZ - 20/10/2011 --------- Control de versiones ------



       'Obtengo el nro de la ultima pagina impresa
       Pagina = CLng(ArrParametros(2))

       
       'Obtengo el tipo de familiares
       tipoFamiliares = ArrParametros(3)

       
       'Obtengo los cortes de estructura
       tenro1 = CInt(ArrParametros(4))
       estrnro1 = CInt(ArrParametros(5))

       tenro2 = CInt(ArrParametros(6))
       estrnro2 = CInt(ArrParametros(7))

       tenro3 = CInt(ArrParametros(8))
       estrnro3 = CInt(ArrParametros(9))

       If UBound(ArrParametros) > 9 Then
        fecEstr = ArrParametros(10)
       End If

       'Obtengo el titulo del reporte
       If UBound(ArrParametros) > 10 Then
        tituloReporte = ArrParametros(11)
       Else
        tituloReporte = ""
       End If

      
       'Obtengo si incluye agencia o no
       If UBound(ArrParametros) >= 12 Then
            If ArrParametros(12) <> "undefined" Then
                incluyeAgencia = ArrParametros(12)
            Else
                incluyeAgencia = 0
            End If
       Else
        incluyeAgencia = 0
       End If

       If UBound(ArrParametros) > 12 Then
            'obtengo el parametro tope
            tope = ArrParametros(13)
       
       End If
       
       If UBound(ArrParametros) > 13 Then
              'obtengo el parametro tomo
              tomo = ArrParametros(14)
       End If
       
       'obtengo el parametro tope
       'tope = ArrParametros(13) 'comento carmen 12/10/2011
       
       'obtengo el parametro tomo
       'tomo = ArrParametros(14) 'comento carmen 12/10/2011
       
       'Obtengo el nro. de Empresa
       ' Si param_empresa = "", entonces se ejecuta el proceso normalmente (se obtiene la empresa con buscarDatosEmpresa original)
       ' Si param_empresa = 0, entonces se ejecuta el proceso para todas las empresas
       ' Si param_empresa = 1169 (un estrnro cualquiera), entonces se ejecuta el proceso para esa empresa en particular
       'param_empresa = ArrParametros(12)
       
       'Obtengo el filtro del reporte
       'filtro = ArrParametros(12)
       
       'Obtengo el orden de la busqueda del reporte
       'l_orden = ArrParametros(13)
       
       
       'EMPIEZA EL PROCESO
       Flog.writeline "Generando el modelo " & tipoModelo
       
       'Busco en el confrep el numero de cuenta que se va a usar para
       ' buscar el valor del sueldo
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 61 "
      
       OpenRecordset StrSql, objRs2
       
        cod_Msr = 0
        cod_Neto = 0
        cod_Basico = 0
        cod_Asi_flia = 0
        cod_Dtos = 0
        cod_Bruto = 0
        cod_Bruto_Acum = 0
        es_Acum_Msr = True
        es_Acum_Neto = True
        es_Acum_Basico = True
        es_Acum_Asi_flia = True
        es_Acum_Dtos = True
        es_Acum_Bruto = True
        es_Acum_Bruto_Acum = True
       
        If objRs2.EOF Then
          Flog.writeline "No esta configurado el ConfRep"
          Exit Sub
        End If
       
        Flog.writeline "Obtengo los datos del confrep"
       
       TipDocNroInscr = 0
       NroBusqProg = 0
       NroBusqProg2 = 0
       NroBusqProg3 = 0
       zonaDomicilio = 3
       concFamiliar01 = 0
       concFamiliar02 = 0
       concFamiliar03 = 0
       
       cantAcumGrupo1 = 0
       cantAcumGrupo2 = 0
       cantAcumGrupo3 = 0
       
       acumSueldoJornal = 0
       
       acumEmplAgencia = 0
       
       Do Until objRs2.EOF
       
          Select Case objRs2!confnrocol
             Case 1
                
                If objRs2!conftipo = "CO" Then
                   es_Acum_Msr = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Msr = 0
                   Else
                     cod_Msr = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Msr = True
                   cod_Msr = objRs2!confval
                End If
             
             Case 2
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Neto = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Neto = 0
                   Else
                     cod_Neto = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Neto = True
                   cod_Neto = objRs2!confval
                End If
             
             Case 3
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Basico = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Basico = 0
                   Else
                     cod_Basico = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Basico = True
                   cod_Basico = objRs2!confval
                End If
             
             Case 4
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Asi_flia = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Asi_flia = 0
                   Else
                     cod_Asi_flia = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Asi_flia = True
                   cod_Asi_flia = objRs2!confval
                End If
             
             Case 5
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Dtos = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Dtos = 0
                   Else
                     cod_Dtos = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Dtos = True
                   cod_Dtos = objRs2!confval
                End If
             
             Case 6
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Bruto = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Bruto = 0
                   Else
                     cod_Bruto = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Bruto = True
                   cod_Bruto = objRs2!confval
                End If

             Case 10
                  NroBusqProg = objRs2!confval
             Case 11
                  TipDocNroInscr = objRs2!confval
             Case 12
                  NroBusqProg2 = objRs2!confval
             Case 15
                  zonaDomicilio = objRs2!confval
             Case 16
                  'Busco el concnro del concepto
                  StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                  StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                  OpenRecordset StrSql, objRs3
                  
                  If objRs3.EOF Then
                     concFamiliar01 = 0
                  Else
                     concFamiliar01 = objRs3!ConcNro
                  End If
                  
                  objRs3.Close
                  
             Case 17
                  'Busco el concnro del concepto
                  StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                  StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                  OpenRecordset StrSql, objRs3
                  
                  If objRs3.EOF Then
                     concFamiliar02 = 0
                  Else
                     concFamiliar02 = objRs3!ConcNro
                  End If
                  
                  objRs3.Close
                  
             Case 50
                'acumGrupo 1
                cantAcumGrupo1 = cantAcumGrupo1 + 1
                acumGrupo1(cantAcumGrupo1) = objRs2!confval
             Case 51
                'acumGrupo 2
                cantAcumGrupo2 = cantAcumGrupo2 + 1
                acumGrupo2(cantAcumGrupo2) = objRs2!confval
             Case 52
                'acumGrupo 3
                cantAcumGrupo3 = cantAcumGrupo3 + 1
                acumGrupo3(cantAcumGrupo3) = objRs2!confval
                
             Case 60
                'Acumulador de Sueldo/Jornal
                acumSueldoJornal = objRs2!confval
                  
             Case 61
                'Bruto Acumulado
             
                If objRs2!conftipo = "CO" Then
                   es_Acum_Bruto_Acum = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Bruto_Acum = 0
                   Else
                     cod_Bruto_Acum = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   es_Acum_Bruto_Acum = True
                   cod_Bruto_Acum = objRs2!confval
                End If

             Case 62
                  NroBusqProg3 = objRs2!confval
                  
             Case 63
                  'Busco el concnro del concepto
                  StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                  StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                  OpenRecordset StrSql, objRs3
                  
                  If objRs3.EOF Then
                     concFamiliar03 = 0
                  Else
                     concFamiliar03 = objRs3!ConcNro
                  End If
                  
                  objRs3.Close
                  
             Case 65
                  acumEmplAgencia = objRs2!confval

             Case 70
                If objRs2!conftipo = "CO" Then
                   es_Acum_Remu = False
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                   StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     cod_Remu = 0
                   Else
                     cod_Remu = objRs3!ConcNro
                   End If
                  
                Else
                   es_Acum_Remu = True
                   cod_Msr = objRs2!confval
                End If
 
          End Select
       
          objRs2.MoveNext
       Loop

       'Busco el tipo de cada concepto
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 61 "

       OpenRecordset StrSql, objRs2
       listaAcumEmplAgencia = 0
       Do Until objRs2.EOF
           
           Select Case objRs2!conftipo
              'Remunerativo
              Case "RE"
                 arrTipoConc(objRs2!confval) = 1
              'No Remunerativo
              Case "NR"
                 arrTipoConc(objRs2!confval) = 2
              'Descuento
              Case "DS"
                 arrTipoConc(objRs2!confval) = 3
              'Asignaciones Familiares
              Case "AF"
                 arrTipoConc(objRs2!confval) = 4
              'Retenciones
              Case "RT"
                 arrTipoConc(objRs2!confval) = 5
              'Acumuladores para Empleados de Agencia
              Case "AG"
                 listaAcumEmplAgencia = listaAcumEmplAgencia & "," & objRs2!confval
                 
           End Select
        
           objRs2.MoveNext
       Loop
        
       objRs2.Close
        
       'Obtengo los empleados sobre los que tengo que generar los recibos
       If param_empresa = "" Then
           CargarEmpleados NroProceso, rsEmpl, 0
           If incluyeAgencia = -1 Then
              CargarEmpleadosAgencia NroProceso, rsAge, 0
           End If
            StrSql = "UPDATE batch_proceso SET bprcprogreso = 0 " & _
                        ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                        ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
            
            objConn.Execute StrSql, , adExecuteNoRecords
       End If
       
       
       'Obtengo la lista de procesos
       arrpronro = Split(listapronro, ",")
       
       'Chequeo el parametro empresa y ejecuto de acuerdo a su valor
       If param_empresa = "" Then
       ' Ejecuto el procedimiento normalmente (sin considerar empresa)
          
               'Obtengo los datos de la empresa
                If tipoModelo <> 18 Then
                   Call buscarDatosEmpresa(NroProceso, arrpronro(0))
                Else
                   Call buscarDatosEmpresaSecure(NroProceso, arrpronro(0))
                End If
                
               'Genero por cada empleado un registro
               Do Until rsEmpl.EOF
                  arrpronro = Split(listapronro, ",")
                  EmpErrores = False
                  Ternro = rsEmpl!Ternro
                  orden = rsEmpl!estado
                  
                  'Genero una entrada para el empleado por cada proceso
                  For I = 0 To UBound(arrpronro)
                     Pronro = arrpronro(I)
                     Flog.writeline "Generando datos empleado " & Ternro & " para el proceso " & Pronro
                     Flog.writeline "******************************************************************"
                     'De acuerdo al modelo es la forma de calcular los datos
                     Select Case tipoModelo
                        'Modelo usado para estantar y Deloitte
                        Case 1
                           'FGZ - 20/10/2011 ---------------------------
                           Call generarDatosEmpleado01(Pronro, Ternro, tituloReporte, orden)
                           
                           ''ValidarV (Version, proNro)
                           'Version_Valida = ValidarV(Version)
                           'If Version_Valida Then
                           ' Call generarDatosEmpleado01(proNro, Ternro, tituloReporte, orden)
                           'End If
                           'FGZ - 20/10/2011 ---------------------------
                           
                        'Modelo usado para Temaiken
                        Case 2
                           Call generarDatosEmpleado02(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo usado para Accor
                        Case 3
                           Call generarDatosEmpleado03(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo usado para Citrusvil
                        Case 4
                           Call generarDatosEmpleado04(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo usado para Jugos
                        Case 5
                           Call generarDatosEmpleado05(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo usado para Roche
                        Case 6
                           Call generarDatosEmpleado06(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo usado para Teleperformance
                        Case 7
                           Call generarDatosEmpleado07(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo usado para Promofilm
                        Case 8
                           Call generarDatosEmpleado08(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo usado para Arena Argentina
                        Case 9
                           Call generarDatosEmpleado09(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para EMC
                        Case 10
                           Call generarDatosEmpleado10(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para UTE
                        Case 11
                           Call generarDatosEmpleado11(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Schering
                        Case 12
                           Call generarDatosEmpleado12(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Schering
                        Case 13
                           Call generarDatosEmpleado13(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo usado para Glencore
                        Case 14
                           Call generarDatosEmpleado14(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Los Grobo
                        Case 15
                           Call generarDatosEmpleado15(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Deloitte Personal
                        Case 16
                           Call generarDatosEmpleado16(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Norton
                        Case 17
                           Call generarDatosEmpleado17(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo usado para Secure Bag
                        Case 18
                           Call generarDatosEmpleado18(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo Banco Industrial Azul (BIA)
                        Case 19
                           Call generarDatosEmpleado19(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo Litoral Gas
                        Case 20
                           Call generarDatosEmpleado20(Pronro, Ternro, tituloReporte, orden)
                     
                        'Modelo Darmex
                        Case 21
                           Call generarDatosEmpleado21(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo CODERE
                        Case 22
                           Call generarDatosEmpleado22(Pronro, Ternro, tituloReporte, orden)
                           
                        'Modelo HILERET
                        Case 23
                           Call generarDatosEmpleado23(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo Apex
                        Case 24
                            Call generarDatosEmpleado24(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo Mercado Central
                        Case 25
                            Call generarDatosEmpleado25(Pronro, Ternro, tituloReporte, orden)
                        
                        'Modelo Gedas
                        Case 26
                            Call generarDatosEmpleado26(Pronro, Ternro, tituloReporte, orden)
                       
                       'Modelo AGD
                        Case 27
                            Call generarDatosEmpleado27(Pronro, Ternro, tituloReporte, orden)
                        'Modelo Redepa
                        Case 28
                            Call generarDatosEmpleado28(Pronro, Ternro, tituloReporte, orden)
                        'Modelo PapelBril
                        Case 29
                            Call generarDatosEmpleado29(Pronro, Ternro, tituloReporte, orden)
                        'Horwath
                        Case 30
                            Call generarDatosEmpleado30(Pronro, Ternro, tituloReporte, orden)
                        'Duke
                        Case 31
                            Call generarDatosEmpleado31(Pronro, Ternro, tituloReporte, orden)
                        'Andreani
                        Case 32
                            Call generarDatosEmpleado32(Pronro, Ternro, tituloReporte, orden)
                        'Altaplastica
                        Case 33
                            Call generarDatosEmpleado33(Pronro, Ternro, tituloReporte, orden)
                        'Vital
                        Case 34
                            Call generarDatosEmpleado34(Pronro, Ternro, tituloReporte, orden)
                        'ActionLine
                        Case 35
                            Call generarDatosEmpleado35(Pronro, Ternro, tituloReporte, orden)
                        'TPS
                        Case 36
                            Call generarDatosEmpleado36(Pronro, Ternro, tituloReporte, orden)
                        'Administradora Sanatorial
                        Case 37
                            Call generarDatosEmpleado37(Pronro, Ternro, tituloReporte, orden)
                        'Dalkia
                        Case 38
                            Call generarDatosEmpleado38(Pronro, Ternro, tituloReporte, orden)
                        'Grupo Cargo
                        Case 39
                            Call generarDatosEmpleado39(Pronro, Ternro, tituloReporte, orden)
                        'Medicus
                        Case 40
                            Call generarDatosEmpleado40(Pronro, Ternro, tituloReporte, orden)
                        'Price
                        Case 41
                           Call generarDatosEmpleado41(Pronro, Ternro, tituloReporte, orden)
                        'Metalurgica Roma
                        Case 42
                           Call generarDatosEmpleado42(Pronro, Ternro, tituloReporte, orden)
                        'Molinos Canepa
                        Case 43
                           Call generarDatosEmpleado43(Pronro, Ternro, tituloReporte, orden)
                        'Freddo - Aroma Cafe
                        Case 44
                           Call generarDatosEmpleado44(Pronro, Ternro, tituloReporte, orden)
                        Case 45
                           Call generarDatosEmpleado45(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Edeste
                        Case 46
                           Call generarDatosEmpleado46(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para farmografica
                        Case 47
                           Call generarDatosEmpleado47(Pronro, Ternro, tituloReporte, orden)
                        Case 48
                           Call generarDatosEmpleado48(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Horwath Rosario
                        Case 49
                            Call generarDatosEmpleado49(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Coop. Seguros
                        Case 50
                            Call generarDatosEmpleado50(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Timbo
                        Case 51
                            Call generarDatosEmpleado51(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Mimo Vestiditos
                        Case 52
                            Call generarDatosEmpleado52(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para SOS
                        Case 53
                            Call generarDatosEmpleado53(Pronro, Ternro, tituloReporte, orden)
                        Case 54
                            Call generarDatosEmpleado54(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Horwath Litoral AMR
                        Case 55
                            Call generarDatosEmpleado55(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para BDO -GE
                        Case 56
                            Call generarDatosEmpleado56(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Aluflex
                        Case 57
                            Call generarDatosEmpleado57(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para SGS
                        Case 58
                            Call generarDatosEmpleado58(Pronro, Ternro, tituloReporte, orden)
                        'Modelo para Santana
                        Case 59
                            Call generarDatosEmpleado59(Pronro, Ternro, tituloReporte, orden)
                          'Modelo para San Miguel
                        Case 60
                            Call generarDatosEmpleado60(Pronro, Ternro, tituloReporte, orden)
                          'Modelo para La Caja
                        Case 61
                            Call generarDatosEmpleado61(Pronro, Ternro, tituloReporte, orden)
                     End Select
                  Next
                  
                  'Actualizo el estado del proceso
                  TiempoAcumulado = GetTickCount
                  
                  cantRegistros = cantRegistros - 1
                  
                  StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Fix(((totalEmpleados - cantRegistros) * 100) / totalEmpleados) & _
                           ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                           ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
                     
                  objConn.Execute StrSql, , adExecuteNoRecords
                  
                  'Si se generaron todos los datos del empleado correctamente lo borro
                  If Not EmpErrores Then
                      StrSql = " DELETE FROM batch_empleado "
                      StrSql = StrSql & " WHERE bpronro = " & NroProceso
                      StrSql = StrSql & " AND ternro = " & Ternro
            
                      objConn.Execute StrSql, , adExecuteNoRecords
                  End If
                  
                  rsEmpl.MoveNext
               Loop
               
               If incluyeAgencia = -1 Then
                   StrSql = " SELECT DISTINCT periodo.* " & _
                            " FROM periodo INNER JOIN proceso ON periodo.pliqnro = proceso.pliqnro " & _
                            " WHERE proceso.pronro IN ( " & listapronro & ")"
                   OpenRecordset StrSql, rsPeriodo
                   
                   Do Until rsAge.EOF
                        EmpErrores = False
                        Ternro = rsAge!Ternro
                        orden = rsAge!estado
                              
                        'Genero una entrada para el empleado por cada periodo
                        ' En realidad siempre es un unico periodo, ya que en el filtro del asp,
                        ' se valida que el periodo desde sea igual al periodo hasta
                        rsPeriodo.MoveFirst
                        Do Until rsPeriodo.EOF
                            Flog.writeline "Generando datos empleado de agencia " & Ternro & " para el periodo " & rsPeriodo!pliqnro
                                 
                            'De acuerdo al modelo es la forma de calcular los datos
                            Select Case tipoModelo
                                'Modelo usado para estantar y Deloitte
                                Case 1
                                    Call generarDatosEmpAge01(rsPeriodo!pliqnro, rsPeriodo!pliqmes, rsPeriodo!pliqanio, rsPeriodo!pliqdesc, rsPeriodo!pliqdesde, rsPeriodo!pliqhasta, Ternro, tituloReporte, 1)
                                Case 16
                                    'Call generarDatosEmpleado16(pliqNro, ternro, tituloReporte, orden)
                                Case 20
                                    Call generarDatosEmpAge20(rsPeriodo!pliqnro, rsPeriodo!pliqmes, rsPeriodo!pliqanio, rsPeriodo!pliqdesc, rsPeriodo!pliqdesde, rsPeriodo!pliqhasta, Ternro, tituloReporte, orden)
                                    
                            End Select
                                 
                            rsPeriodo.MoveNext
                        Loop
                        
                        'Actualizo el estado del proceso
                        TiempoAcumulado = GetTickCount
                              
                        cantRegistros = cantRegistros - 1
                              
                        StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Fix(((totalEmpleados - cantRegistros) * 100) / totalEmpleados) & _
                                 ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                                 ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
                                 
                        objConn.Execute StrSql, , adExecuteNoRecords
                              
                        'Si se generaron todos los datos del empleado correctamente lo borro
                        If Not EmpErrores Then
                            StrSql = " DELETE FROM batch_empleado "
                            StrSql = StrSql & " WHERE bpronro = " & NroProceso
                            StrSql = StrSql & " AND ternro = " & Ternro
                        
                            objConn.Execute StrSql, , adExecuteNoRecords
                        End If
                              
                        rsAge.MoveNext
                   Loop
                    
                   rsAge.Close
                   
               End If
               
       Else
       ' param_empresa <> ""
               
               StrSql = "SELECT * FROM empresa "
               If CLng(param_empresa) > 0 Then
                    StrSql = StrSql & "WHERE estrnro = " & CLng(param_empresa)
               End If
               StrSql = StrSql & "ORDER BY estrnro "
            
               OpenRecordset StrSql, rsEmpresas
       
                ' Actualizo el estado del proceso
               If CLng(param_empresa) > 0 Then
                      StrSql = "UPDATE batch_proceso SET bprcprogreso = 0 " & _
                    ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                    ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
            
                   objConn.Execute StrSql, , adExecuteNoRecords
               Else
               
                      cantRegistros = rsEmpresas.RecordCount
                      totalEmpleados = cantRegistros
                    
                      StrSql = "UPDATE batch_proceso SET bprcprogreso = 0 " & _
                    ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                    ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
            
                   objConn.Execute StrSql, , adExecuteNoRecords
 
               End If
               
               Do Until rsEmpresas.EOF
       
                    'Obtengo los datos de la empresa
                    Call buscarDatosEmpresaDada(rsEmpresas!Estrnro, rsEmpresas!Ternro, rsEmpresas!empnom, rsEmpresas!empactiv)
                    
                    ' Cargo los empleados para la empresa
                    CargarEmpleados 0, rsEmpl, CLng(rsEmpresas!Estrnro)
                    
                    ord = 0
        
                    'Genero por cada empleado un registro
                    Do Until rsEmpl.EOF
                       arrpronro = Split(listapronro, ",")
                       EmpErrores = False
                       Ternro = rsEmpl!Ternro
                       orden = ord
                       
                       'Genero una entrada para el empleado por cada proceso
                       For I = 0 To UBound(arrpronro)
                          Pronro = arrpronro(I)
                          Flog.writeline "Generando datos empleado " & Ternro & " para el proceso " & Pronro
                          
                          'De acuerdo al modelo es la forma de calcular los datos
                          Select Case tipoModelo
                             'Modelo usado para estantar y Deloitte
                             Case 1
                                Call generarDatosEmpleado01(Pronro, Ternro, tituloReporte, orden)
                             
                             'Modelo usado para Temaiken
                             Case 2
                                Call generarDatosEmpleado02(Pronro, Ternro, tituloReporte, orden)
                             
                             'Modelo usado para Accor
                             Case 3
                                Call generarDatosEmpleado03(Pronro, Ternro, tituloReporte, orden)
                             
                             'Modelo usado para Citrusvil
                             Case 4
                                Call generarDatosEmpleado04(Pronro, Ternro, tituloReporte, orden)
                          
                             'Modelo usado para Jugos
                             Case 5
                                Call generarDatosEmpleado05(Pronro, Ternro, tituloReporte, orden)
                          
                             'Modelo usado para Roche
                             Case 6
                                Call generarDatosEmpleado06(Pronro, Ternro, tituloReporte, orden)
                          
                             'Modelo usado para Teleperformance
                             Case 7
                                Call generarDatosEmpleado07(Pronro, Ternro, tituloReporte, orden)
                          
                             'Modelo usado para Promofilm
                             Case 8
                                Call generarDatosEmpleado08(Pronro, Ternro, tituloReporte, orden)
                          End Select
                          
                       Next
                       
                       'Actualizo el estado del proceso
                       TiempoAcumulado = GetTickCount
                       
                       cantRegistros = cantRegistros - 1
                       
                       StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Fix(((totalEmpleados - cantRegistros) * 100) / totalEmpleados) & _
                                ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                                ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
                          
                       objConn.Execute StrSql, , adExecuteNoRecords
                       
                       ord = ord + 1
                       rsEmpl.MoveNext
                    Loop
                    
                    rsEmpresas.MoveNext
               
               Loop
        
               rsEmpresas.Close
                       
       End If ' (param_empresa = "")
    
    Else
        Exit Sub
    End If
   
    'Actualizo el estado del proceso
    If Not HuboErrores Then
       StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Procesado' WHERE bpronro = " & NroProceso
    Else
       StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Incompleto' WHERE bpronro = " & NroProceso
    End If
    objConn.Execute StrSql, , adExecuteNoRecords
    
Fin:
    Flog.writeline "Fin :" & Now
    Flog.Close

    Exit Sub
    
CE:
    HuboErrores = True
    Flog.writeline " Error: " & Err.Description & Now
    Flog.writeline " Ultimo SQL: " & StrSql
End Sub

Function controlNull(Str)
  If Trim(Str) = "" Then
     controlNull = "null"
  Else
     controlNull = "'" & Str & "'"
  End If
End Function


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y ACTIONLINE
'--------------------------------------------------------------------
Sub generarDatosEmpleado35(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 1"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrnro AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"


OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y dalkia
'--------------------------------------------------------------------
Sub generarDatosEmpleado38(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 38"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Grupo Cargo
'--------------------------------------------------------------------
Sub generarDatosEmpleado39(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim edad As Long
Dim Nacionalidad As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim noremunerativo As Double

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 39"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato - En contrato gualdo la forma de liquidacion mas abajo.
 'If IsNull(rsConsult!contrato) Then
 '  contrato = ""
 'Else
 '  contrato = rsConsult!contrato
 'End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select nacionaldes FROM empleado INNER JOIN tercero  "
StrSql = StrSql & "  ON empleado.ternro= tercero.ternro  "
StrSql = StrSql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   Nacionalidad = rsConsult!nacionaldes

Else
   Nacionalidad = ""
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la edad del empleado
'------------------------------------------------------------------
StrSql = " select DATEDIFF(year,terfecnac,getdate()) as edad from tercero "
StrSql = StrSql & " where ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   edad = rsConsult!edad
Else
   edad = 0
End If

' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'MSR
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"
OpenRecordset sql, rsConsult
If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If
rsConsult.Close


''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Acumulador no remunerativo
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND confnrocol = 13 "
OpenRecordset sql, rsConsult
If rsConsult.EOF Then
   cod_acum_noremunerativo = 0
Else
   cod_acum_noremunerativo = rsConsult!confval
End If
rsConsult.Close

sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & cod_acum_noremunerativo
sql = sql & " AND cliqnro =  " & cliqnro
'---LOG---
Flog.writeline "Buscando datos del acumulador no remunerativo"
OpenRecordset sql, rsConsult
If rsConsult.EOF Then
   noremunerativo = 0
Else
   noremunerativo = rsConsult!almonto
End If
rsConsult.Close

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Asig. Familia
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If
'---LOG---
Flog.writeline "Buscando datos de la asig. familia"
OpenRecordset sql, rsConsult
If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If
rsConsult.Close

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Descuentos
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If
'---LOG---
Flog.writeline "Buscando datos de los descuentos"
OpenRecordset sql, rsConsult
If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If
rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

'Select Case zonaDomicilio
'   'Direccion de la sucursal
'   Case 1
'
'        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
'        sql = sql & " From his_estructura"
'        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'        '---LOG---
'        Flog.writeline "Buscando datos de la direccion de la sucursal"
'
'        OpenRecordset sql, rsConsult
'
'        If Not rsConsult.EOF Then
'           direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
'        End If
'
'        rsConsult.Close
'
'  'Direccion de la empresa
'  Case 2
'
'        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
'            " From his_estructura" & _
'            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
'            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
'            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
'            " AND his_estructura.ternro = " & ternro & _
'            " AND his_estructura.tenro  = 10"
'
'        OpenRecordset sql, rsConsult
'
'        EmpTernro = 0
'
'        If Not rsConsult.EOF Then
'            EmpTernro = rsConsult!ternro
'        End If
'
'        rsConsult.Close
'
'        'Consulta para obtener la direccion de la empresa
'        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
'            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
'            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
'
'        '---LOG---
'        Flog.writeline "Buscando datos de la direccion de la empresa"
'
'        OpenRecordset sql, rsConsult
'
'        If Not rsConsult.EOF Then
'           direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
'        End If
'
'        rsConsult.Close
'
'  'Direccion del empleado
'  Case 3
'
'        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
'        sql = sql & " FROM  cabdom "
'        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
'        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
'
'        '---LOG---
'        Flog.writeline "Buscando datos de la direccion del empleado"
'
'        OpenRecordset sql, rsConsult
'
'        If Not rsConsult.EOF Then
'           direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
'        End If
'
'        rsConsult.Close
'
'End Select

'------------------------------------------------------------------
'Direccion del empleado
'------------------------------------------------------------------

sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
sql = sql & " FROM  cabdom "
sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la direccion del empleado"

OpenRecordset sql, rsConsult

If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la Forma de liquidacion
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la forma de liquidacion"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
StrSql = StrSql & " AND his_estructura.tenro = 22 AND his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    contrato = rsConsult!estrdabr
Else
    contrato = ""
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5, auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & "," & edad
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & numberForSQL(noremunerativo)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Medicus
'--------------------------------------------------------------------
Sub generarDatosEmpleado40(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 40"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Norton
'--------------------------------------------------------------------
Sub generarDatosEmpleadoAgencia(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim emprCuitActual
Dim emprDireActual
Dim emprTelActual
Dim empresaActual

Dim agenciaTernro

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 1"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,agencia "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   agenciaEmpleado = rsConsult!agencia
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Si es un empleado de agencia busco la direccion y el cuit de la agencia
'------------------------------------------------------------------

If Not IsNull(agenciaEmpleado) Then

    StrSql = " SELECT agencia.ternro, estrdabr FROM agencia "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = agencia.estrnro "
    StrSql = StrSql & " WHERE "
    StrSql = StrSql & " estructura.estrnro = " & agenciaEmpleado
        
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       agenciaTernro = rsConsult!Ternro
       empresaActual = rsConsult!estrdabr
    Else
       agenciaTernro = 0
       empresaActual = " "
       Flog.writeline "No se encontro la agencia"
    End If
    
    'Consulta para obtener la direccion de la agencia
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & agenciaTernro & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la agencia"
        'Exit Sub
        emprDireActual = "   "
        emprTelActual = "   "
    Else
        emprDireActual = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
        emprTelActual = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
    End If
   
    rsConsult.Close
    
    'Consulta para obtener el cuit de la agencia
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & agenciaTernro
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Agencia"
        'Exit Sub
        emprCuitActual = "  "
    Else
        emprCuitActual = rsConsult!NroDoc
    End If
    
    rsConsult.Close
    
Else
    empresaActual = empresa
    emprDireActual = emprDire
    emprTelActual = emprTel
    emprCuitActual = emprCuit
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If


StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresaActual & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuitActual & "'"
StrSql = StrSql & ",'" & emprDireActual & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

If IsNull(agenciaEmpleado) Then

    'No es un empleado de agencia

    StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
        " FROM cabliq " & _
        " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
        " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
        " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
        " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
        " ORDER BY concepto.conccod "
    
    '---LOG---
    Flog.writeline "Buscando datos del detalle de liquidacion"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!concabr & "'"
      StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
      StrSql = StrSql & "," & rsConsult!ConcNro
      StrSql = StrSql & "," & rsConsult!concimp
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
      StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close
    
Else

    'Es un empleado de agencia
    
    StrSql = " SELECT acu_mes.acunro,acudesabr,ammonto,amcant " & _
        " FROM acu_mes" & _
        " INNER JOIN acumulador ON acumulador.acunro = acu_mes.acunro AND acu_mes.ternro = " & Ternro & _
        " Where acu_mes.ternro = " & Ternro & _
        "   AND acu_mes.amanio = " & pliqanio & _
        "   AND acu_mes.ammes  = " & pliqmes & _
        "   AND acumulador.acunro = " & acumEmplAgencia
    
    '---LOG---
    Flog.writeline "Buscando datos del detalle de liquidacion"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!acudesabr & "'"
      StrSql = StrSql & ",'" & rsConsult!acuNro & "'"
      StrSql = StrSql & "," & rsConsult!acuNro
      StrSql = StrSql & ",-1"
      StrSql = StrSql & "," & numberForSQL(rsConsult!amcant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!ammonto)
      StrSql = StrSql & ",'0'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If
    

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Temaiken
'--------------------------------------------------------------------
Sub generarDatosEmpleado02(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim cliqnro
Dim acuSueldo
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 2"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no esta en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"
 

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
 If IsNull(rsConsult!empfecbaja) Then
    fecbaja = ""
 Else
    fecbaja = rsConsult!empfecbaja
 End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If

 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------


sql = "SELECT calle,nro,cabdom.domdefault,locdesc "
sql = sql & " FROM detdom INNER JOIN cabdom ON detdom.domnro=cabdom.domnro "
sql = sql & " INNER JOIN tipodomi ON cabdom.tidonro=tipodomi.tidonro AND tipodomi.tidonro=2 "
sql = sql & " LEFT JOIN localidad on localidad.locnro = detdom.locnro"
sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro=" & Ternro
    
'---LOG---
Flog.writeline "Buscando datos de la direccion"
    
OpenRecordset sql, rsConsult

Direccion = ""
If Not rsConsult.EOF Then
       Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos de los documentos"

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos del sueldo
'--------------------------------------------------------------------------

If IsNull(Sueldo) Then
    sql = " SELECT * FROM confrep "
    sql = sql & " WHERE repnro = 61 "
    sql = sql & " AND confnrocol = 9 "
    
    OpenRecordset sql, rsConsult

    If rsConsult.EOF Then
       acuSueldo = 0
    Else
       acuSueldo = rsConsult!confvalº
    End If

    rsConsult.Close
       
    'Sueldo
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & acuSueldo
    sql = sql & " AND cliqnro =  " & cliqnro
    
    '---LOG---
    Flog.writeline "Buscando datos del sueldo"
    
    OpenRecordset sql, rsConsult
    
    If rsConsult.EOF Then
       Sueldo = 0
    Else
       Sueldo = rsConsult!almonto
    End If
    
    rsConsult.Close
   
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxdeci1,auxchar1, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,tipofam) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Sexo & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & tipoFamiliares
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.parenro=2 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
          
      End If
    
      If GuardarFam Then
    
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If


Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Accor
'--------------------------------------------------------------------
Sub generarDatosEmpleado03(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim Nacionalidad
Dim causaEgreso
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 3"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso."
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
' If IsNull(rsConsult!empfecbaja) Then
'    fecbaja = ""
' Else
'    fecbaja = rsConsult!empfecbaja
' End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
sql = sql & " From his_estructura"
sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
'---LOG---
Flog.writeline "Buscando datos de la direccion"
    
OpenRecordset sql, rsConsult

Direccion = ""
If Not rsConsult.EOF Then
       Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del documento"

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes " & _
    " FROM tercero " & _
    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la fecha de baja y la causa de egreso
'--------------------------------------------------------------------------

causaEgreso = ""
fecbaja = ""

'---LOG---
Flog.writeline "Buscando datos de la causa de egreso"

 StrSql = " SELECT altfec, bajfec, caudes, estado, empatareas "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro=empant.empantnro "
 StrSql = StrSql & " LEFT JOIN causa ON fases.caunro=causa.caunro "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
     Flog.writeline "No se encontró la causa de egreso"
 '    Exit Sub
 Else
    If Not CBool(rsConsult!estado) Then
       fecbaja = rsConsult!bajfec
       causaEgreso = rsConsult!caudes
    End If
 End If
 
 rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Or (pliqfecdep = "") Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxchar1,auxchar2,auxchar3,auxchar4, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & causaEgreso & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & controlNull(emprActiv)
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
   
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Citrusvil
'--------------------------------------------------------------------
Sub generarDatosEmpleado04(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim nroInscripcion

Dim CentroCosto

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 4"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
 If IsNull(rsConsult!empfecbaja) Then
    fecbaja = ""
 Else
    fecbaja = rsConsult!empfecbaja
 End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la condicion"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=36 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

contrato = ""

If Not rsConsult.EOF Then
   contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
sql = sql & " From his_estructura"
sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
'---LOG---
Flog.writeline "Buscando datos de la direccion"

OpenRecordset sql, rsConsult

Direccion = ""
If Not rsConsult.EOF Then
       Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'Consulta para obtener el nro. de inscripcion de la empresa
StrSql = "SELECT nrodoc FROM tercero " & _
         " INNER JOIN ter_doc ON (tercero.ternro = ter_doc.ternro and ter_doc.tidnro = " & TipDocNroInscr & ")" & _
         " Where tercero.ternro =" & emprTer

'---LOG---
Flog.writeline "Buscando datos del nro. de inscripcion de la empresa"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontró el nro. de inscripcion de la Empresa"
    'Exit Sub
    nroInscripcion = "  "
Else
    nroInscripcion = rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & nroInscripcion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
    
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
      
      End If
        
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar un ResultSet de los empleados a cambiar
' si el RS es vacio significa que hay que aplicarlo sobre todos
'--------------------------------------------------------------------
Sub CargarEmpleados(ByVal NroProc, ByRef rsEmpl As ADODB.Recordset, ByVal empresa As Long)

Dim StrEmpl As String

    If NroProc > 0 Then
        
        StrEmpl = "SELECT * FROM batch_empleado "
        StrEmpl = StrEmpl & " INNER JOIN empleado ON empleado.ternro = batch_empleado.ternro "
        'If incluyeAgencia = -1 Then
           StrEmpl = StrEmpl & " AND (agencia is null OR agencia = 0)"
        'End If
        StrEmpl = StrEmpl & " WHERE bpronro = " & NroProc
        StrEmpl = StrEmpl & " ORDER BY progreso,estado"
    
    Else

        If tenro3 <> 0 Then ' esto ocurre solo cuando se seleccionan los tres niveles
                StrEmpl = " SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, " & _
                " estact2.tenro AS tenro2, estact2.estrnro AS estrnro2, estact3.tenro AS tenro3, estact3.estrnro AS estrnro3, nestact1.estrdabr AS nestr1, nestact2.estrdabr AS nestr2, nestact3.estrdabr AS nestr3  "
                StrEmpl = StrEmpl & " FROM cabliq "
                If listapronro = "" Or listapronro = "0" Then
                    StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                Else
                    StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                 StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If empresa > 0 Then
                 StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                End If
                
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                 StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro1 <> 0 Then   'cuando se le asigna un valor al nivel 1
                    StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON v_empleado.ternro = estact2.ternro  AND estact2.tenro  = " & tenro2
                 StrEmpl = StrEmpl & " AND (estact2.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro2 <> 0 Then   'cuando se le asigna un valor al nivel 2
                    StrEmpl = StrEmpl & " AND estact2.estrnro =" & estrnro2
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact3 ON v_empleado.ternro = estact3.ternro  AND estact3.tenro  = " & tenro3 & _
                 " AND (estact3.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact3.htethasta is null or estact3.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro3 <> 0 Then   'cuando se le asigna un valor al nivel 3
                    StrEmpl = StrEmpl & " AND estact3.estrnro =" & estrnro3
                End If
                
                If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                    StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro "
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact3 ON nestact3.estrnro = estact3.estrnro "
                 StrEmpl = StrEmpl & " WHERE " & filtro
                 StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2,nestr3," & l_orden
        
        Else
                If tenro2 <> 0 Then   ' ocurre cuando se selecciono hasta el segundo nivel
                    
                    StrEmpl = "SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, " & _
                        " estact2.tenro AS tenro2, estact2.estrnro AS estrnro2, nestact1.estrdabr AS nestr1, nestact2.estrdabr AS nestr2 "
                    StrEmpl = StrEmpl & " FROM cabliq "
                    
                    If listapronro = "" Or listapronro = "0" Then
                        StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                    Else
                        StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                    StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                    If empresa > 0 Then
                     StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                    End If
                
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                    StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                    
                    If estrnro1 <> 0 Then
                         StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON v_empleado.ternro = estact2.ternro  AND estact2.tenro  = " & tenro2 & _
                    " AND (estact2.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
                    
                    If estrnro2 <> 0 Then
                        StrEmpl = StrEmpl & " AND estact2.estrnro =" & estrnro2
                    End If
                    
                    If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                        StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                    StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro "
                    StrEmpl = StrEmpl & " WHERE " & filtro
                    StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2," & l_orden
        
                Else
                    If tenro1 <> 0 Then   ' Cuando solo selecionamos el primer nivel
                        StrEmpl = "SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, nestact1.estrdabr AS nestr1"
                        StrEmpl = StrEmpl & " FROM cabliq "
                        
                        If listapronro = "" Or listapronro = "0" Then
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                        Else
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                        StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                        If empresa > 0 Then
                         StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                        End If
                
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                        StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                        
                        If estrnro1 <> 0 Then
                            StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                        End If
                        
                        If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                            StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                        StrEmpl = StrEmpl & " WHERE " & filtro
                        StrEmpl = StrEmpl & " ORDER BY nestr1," & l_orden
        
                    Else ' cuando no hay nivel de estructura seleccionado
                        StrEmpl = " SELECT DISTINCT v_empleado.ternro, empleg, terape FROM cabliq "
                        
                        If listapronro = "" Or listapronro = "0" Then
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                        Else
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                        StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                        If empresa > 0 Then
                         StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                        End If
                                                
                        If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                            StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                        End If
                        
                        StrEmpl = StrEmpl & " WHERE " & filtro
                        StrEmpl = StrEmpl & " ORDER BY " & l_orden
                    End If
                
                End If
        
        End If
    
    End If
   
    OpenRecordset StrEmpl, rsEmpl
    
    cantRegistros = rsEmpl.RecordCount
    totalEmpleados = cantRegistros
    
End Sub

'--------------------------------------------------------------------
' Se encarga de generar un ResultSet de los empleados de agencias
'--------------------------------------------------------------------
Sub CargarEmpleadosAgencia(ByVal NroProc, ByRef rsAge As ADODB.Recordset, ByVal empresa As Long)

Dim StrEmpl As String

    If NroProc > 0 Then
        
'        StrEmpl = "SELECT * FROM empleado "
        'If incluyeAgencia = -1 Then
'           StrEmpl = StrEmpl & " WHERE (agencia is not null AND agencia <> 0)"
        'End If
'        StrEmpl = StrEmpl & " WHERE bpronro = " & NroProc
'        StrEmpl = StrEmpl & " ORDER BY progreso,estado"
        
        StrEmpl = "SELECT * FROM batch_empleado "
        StrEmpl = StrEmpl & " INNER JOIN empleado ON empleado.ternro = batch_empleado.ternro "
        'If incluyeAgencia = -1 Then
           'StrEmpl = StrEmpl & " AND (agencia is not null AND agencia <> 0)"
        'End If
        
        'Martin Ferraro - Cambio en la forma de buscar empleados de agencia. Es por estructura
        StrEmpl = StrEmpl & " INNER JOIN his_estructura agen ON agen.ternro = empleado.ternro AND agen.tenro = 28 "
        StrEmpl = StrEmpl & " AND (agen.htetdesde<=" & ConvFecha(fecEstr) & " AND (agen.htethasta is null OR agen.htethasta>=" & ConvFecha(fecEstr) & "))"
        
        StrEmpl = StrEmpl & " WHERE bpronro = " & NroProc
        StrEmpl = StrEmpl & " ORDER BY progreso, estado"
    Else

        If tenro3 <> 0 Then ' esto ocurre solo cuando se seleccionan los tres niveles
                StrEmpl = " SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, " & _
                " estact2.tenro AS tenro2, estact2.estrnro AS estrnro2, estact3.tenro AS tenro3, estact3.estrnro AS estrnro3, nestact1.estrdabr AS nestr1, nestact2.estrdabr AS nestr2, nestact3.estrdabr AS nestr3  "
                StrEmpl = StrEmpl & " FROM cabliq "
                If listapronro = "" Or listapronro = "0" Then
                    StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                Else
                    StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                 StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If empresa > 0 Then
                 StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                End If
                
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                 StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro1 <> 0 Then   'cuando se le asigna un valor al nivel 1
                    StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON v_empleado.ternro = estact2.ternro  AND estact2.tenro  = " & tenro2
                 StrEmpl = StrEmpl & " AND (estact2.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro2 <> 0 Then   'cuando se le asigna un valor al nivel 2
                    StrEmpl = StrEmpl & " AND estact2.estrnro =" & estrnro2
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN his_estructura estact3 ON v_empleado.ternro = estact3.ternro  AND estact3.tenro  = " & tenro3 & _
                 " AND (estact3.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact3.htethasta is null or estact3.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                If estrnro3 <> 0 Then   'cuando se le asigna un valor al nivel 3
                    StrEmpl = StrEmpl & " AND estact3.estrnro =" & estrnro3
                End If
                
                If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                    StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                End If
                 
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro "
                 StrEmpl = StrEmpl & " INNER JOIN estructura nestact3 ON nestact3.estrnro = estact3.estrnro "
                 StrEmpl = StrEmpl & " WHERE " & filtro
                 StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2,nestr3," & l_orden
        
        Else
                If tenro2 <> 0 Then   ' ocurre cuando se selecciono hasta el segundo nivel
                    
                    StrEmpl = "SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, " & _
                        " estact2.tenro AS tenro2, estact2.estrnro AS estrnro2, nestact1.estrdabr AS nestr1, nestact2.estrdabr AS nestr2 "
                    StrEmpl = StrEmpl & " FROM cabliq "
                    
                    If listapronro = "" Or listapronro = "0" Then
                        StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                    Else
                        StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                    StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                    If empresa > 0 Then
                     StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                    End If
                
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                    StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                    
                    If estrnro1 <> 0 Then
                         StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON v_empleado.ternro = estact2.ternro  AND estact2.tenro  = " & tenro2 & _
                    " AND (estact2.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
                    
                    If estrnro2 <> 0 Then
                        StrEmpl = StrEmpl & " AND estact2.estrnro =" & estrnro2
                    End If
                    
                    If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                        StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                    End If
                    
                    StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                    StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro "
                    StrEmpl = StrEmpl & " WHERE " & filtro
                    StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2," & l_orden
        
                Else
                    If tenro1 <> 0 Then   ' Cuando solo selecionamos el primer nivel
                        StrEmpl = "SELECT DISTINCT v_empleado.ternro, empleg, terape, estact1.tenro AS tenro1, estact1.estrnro AS estrnro1, nestact1.estrdabr AS nestr1"
                        StrEmpl = StrEmpl & " FROM cabliq "
                        
                        If listapronro = "" Or listapronro = "0" Then
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                        Else
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                        StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                        If empresa > 0 Then
                         StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                        End If
                
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON v_empleado.ternro = estact1.ternro  AND estact1.tenro  = " & tenro1
                        StrEmpl = StrEmpl & " AND (estact1.htetdesde<=" & ConvFecha(fecEstr) & " AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
                        
                        If estrnro1 <> 0 Then
                            StrEmpl = StrEmpl & " AND estact1.estrnro =" & estrnro1
                        End If
                        
                        If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                            StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro "
                        StrEmpl = StrEmpl & " WHERE " & filtro
                        StrEmpl = StrEmpl & " ORDER BY nestr1," & l_orden
        
                    Else ' cuando no hay nivel de estructura seleccionado
                        StrEmpl = " SELECT DISTINCT v_empleado.ternro, empleg, terape FROM cabliq "
                        
                        If listapronro = "" Or listapronro = "0" Then
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado "
                        Else
                            StrEmpl = StrEmpl & " INNER JOIN v_empleado ON v_empleado.ternro = cabliq.empleado AND cabliq.pronro IN (" & listapronro & ") "
                        End If
                        
                        StrEmpl = StrEmpl & " INNER JOIN his_estructura ON his_estructura.ternro = v_empleado.ternro AND his_estructura.tenro = 10 "
                        StrEmpl = StrEmpl & " AND (his_estructura.htetdesde<=" & ConvFecha(fecEstr) & " AND (his_estructura.htethasta is null OR his_estructura.htethasta>=" & ConvFecha(fecEstr) & "))"
                
                        If empresa > 0 Then
                         StrEmpl = StrEmpl & " AND his_estructura.estrnro = " & empresa
                        End If
                                                
                        If Trim(l_orden) = "ter_doc.nrodoc" Then  'EL RESTO DE LOS FILTROS (1)EMPRESA
                            StrEmpl = StrEmpl & " INNER JOIN ter_doc ON ter_doc.ternro = v_empleado.ternro AND ter_doc.tidnro=10"
                        End If
                        
                        StrEmpl = StrEmpl & " WHERE " & filtro
                        StrEmpl = StrEmpl & " ORDER BY " & l_orden
                    End If
                
                End If
        
        End If
    
    End If
   
    OpenRecordset StrEmpl, rsAge
    
    cantRegistros = cantRegistros + rsAge.RecordCount
    totalEmpleados = cantRegistros
    
End Sub


Function numberForSQL(Str)
   
  numberForSQL = Replace(Str, ",", ".")

End Function


Function strForSQL(Str)
   
  If IsNull(Str) Then
     strForSQL = "NULL"
  Else
     strForSQL = Str
  End If

End Function


Public Function HayAsignacionesFliares(pliqdesde As Date, pliqhasta As Date, Ternro, ternroFamiliar, Busqueda, cliqnro, concepto)
' ---------------------------------------------------------------------------------------------
' Descripcion: Asignaciones Familiares
' Autor      : FGZ
' Fecha      : 15/04/2004
' Ultima Mod.:
' Descripcion:
' ---------------------------------------------------------------------------------------------
Dim Incapacitado As Boolean         '-1 (True) / 0 (False)
Dim edad As Integer                 'cant de años o nulo o vacio
Dim Sexo As Integer                 '1(Masc) / 2 (Fem) / 3 (Todos)
Dim Estudia As Integer              '1(si) / 2 (no) / 3 (indefinido)
Dim Ayuda_Escolar As Integer        '1(si) / 2 (no) / 3 (indefinido)
Dim Suma_FliaNumerosa As Integer    'Siempre viene 1. No se usa mas
Dim Paga_FliaNumerosa As Integer    'siempre viene 1. No se usa mas
Dim Trabaja_Conyuge As Integer      '1(si) / 2 (no) / 3 (no importa)
Dim Retroactivo_Prenatal As Boolean '-1(TRUE) / 0(FALSE)
Dim Nivel_Estudio As String         'nivnro,nivnro,....
Dim Periodo_Escolar As Integer      'nro del periodo escolar
Dim Parentesco As Integer           'codigo del parentesco
                            
Dim Fam_niv_est     As Integer
Dim Fam_peri_escol  As Integer
Dim Fam_estudia     As Integer
Dim Fecha_vto_asig  As Date
Dim Fin_periodo_liq As Date
Dim Par_asig        As Integer

Dim suma_fn As Integer
Dim paga_fn As Integer
Dim edad_f As Integer
Dim conyuge As Integer
Dim pagaxhijo As Boolean
Dim niv_est_interno As Boolean
Dim interesa_estu As Boolean
Dim sexo_conyuge As Integer
Dim conyuge_trabaja As Integer
Dim Opcion_Fecha_Hasta
Dim Fecha_Hasta_Edad

Dim Param_cur As New ADODB.Recordset
Dim rs_PeriodoEsc As New ADODB.Recordset
Dim rs_Familiar As New ADODB.Recordset
Dim rs_Tercero As New ADODB.Recordset
Dim rs_estudio_actual As New ADODB.Recordset
Dim rs_Nivest As New ADODB.Recordset
Dim rs_Concepto As New ADODB.Recordset

Dim Salida As Boolean
  
'inicializo
Par_asig = 31
conyuge = False
pagaxhijo = False
suma_fn = 0
paga_fn = 0

    Bien = False
    HayAsignacionesFliares = False
    Salida = False
    
    ' Obtener los parametros de la Busqueda
    StrSql = "SELECT * FROM programa WHERE progarchest = -1 AND prognro = " & CStr(Busqueda)
    OpenRecordset StrSql, Param_cur
    
    If Not Param_cur.EOF Then
        Incapacitado = Param_cur!Auxint4
        edad = Param_cur!Auxint1
        Sexo = Param_cur!Auxint5
        Estudia = Param_cur!Auxchar2
        Ayuda_Escolar = Param_cur!Auxchar3
        Suma_FliaNumerosa = True
        Paga_FliaNumerosa = True
        Trabaja_Conyuge = Param_cur!Auxchar5
        Retroactivo_Prenatal = Param_cur!Auxint2
        Nivel_Estudio = IIf(EsNulo(Param_cur!Auxchar1), 0, Param_cur!Auxchar1)
        Periodo_Escolar = Param_cur!Auxint3
        Parentesco = Param_cur!Auxchar4
        
        Opcion_Fecha_Hasta = Param_cur!Auxchar
        
        If IsNull(Opcion_Fecha_Hasta) Then
           Opcion_Fecha_Hasta = 1
        End If
        
        Select Case CInt(Opcion_Fecha_Hasta)
        Case 1:
            'a mes actual
            Fecha_Hasta_Edad = pliqhasta
            
        Case 2:
            'al mes anterior
            Fecha_Hasta_Edad = DateAdd("d", -1, pliqdesde)
            
        Case 3:
            'a fin de año
            Fecha_Hasta_Edad = CDate("31/12/" & Year(pliqhasta))
            
        Case 4:
            'a principio de año
            Fecha_Hasta_Edad = CDate("01/01/" & Year(pliqhasta))
            
        Case Else:
            'Default. a fin de mes
            Fecha_Hasta_Edad = pliqhasta
            
        End Select
        
    Else
        Flog.writeline "Error: No se encuentra o no esta generada la busqueda de familiares nro " & Busqueda & "."
        Exit Function
    End If

    ' VALIDAR SI AL EMPLEADO CORRESPONDE PAGARLE ASIGNACIONES FAMILIARES
    ' en funcion : dias trabajados en el mes
    
    'AYUDA ESCOLAR
    If Ayuda_Escolar = 1 Then
        StrSql = "SELECT * FROM edu_periodoesc WHERE edu_periodoesc.perescnro =" & Periodo_Escolar
        OpenRecordset StrSql, rs_PeriodoEsc
        If rs_PeriodoEsc.EOF Then
            Flog.writeline "Error: Periodo Escolar Incorrecto."
            Exit Function
        End If
    End If
        
    'FECHAS LIMITES DE VENCIMENTOS DE CERTIFICADOS
    Fecha_vto_asig = pliqdesde
    Fin_periodo_liq = pliqhasta


    StrSql = "SELECT * FROM familiar INNER JOIN tercero ON tercero.ternro = familiar.ternro"
    StrSql = StrSql & " WHERE (familiar.empleado =" & Ternro
    StrSql = StrSql & " AND familiar.parenro = " & Parentesco
    StrSql = StrSql & " AND familiar.famest = -1"
    StrSql = StrSql & " AND familiar.famsalario = -1"
    StrSql = StrSql & " AND familiar.ternro = " & ternroFamiliar & ")"
    StrSql = StrSql & " AND (familiar.famfecvto >=" & ConvFecha(Fecha_vto_asig) & " OR familiar.famfecvto is null)"
    StrSql = StrSql & " Order by tercero.terfecnac DESC"
    OpenRecordset StrSql, rs_Familiar
             
    Do While Not rs_Familiar.EOF
        If rs_Familiar!parenro = 2 Then 'hijo
            'calculo la edad del familiar
             edad_f = Calcular_Edad(rs_Familiar!terfecnac, Fecha_Hasta_Edad)
             
            conyuge = 3
            sexo_conyuge = 3
            conyuge_trabaja = 3
        End If
                             
        'en los conyuges no interesa si estudia o no
        interesa_estu = True  'el default es que interese
        
        If rs_Familiar!parenro = 3 Then 'conyuge
            sexo_conyuge = IIf(CBool(rs_Familiar!tersex), 1, 2)
            conyuge_trabaja = IIf(CBool(rs_Familiar!famtrab), 1, 2)
            If (rs_Familiar!tersex) And (rs_Familiar!faminc) And (Not rs_Familiar!famtrab) Then
                conyuge = False
            Else
                If (Not rs_Familiar!tersex) And rs_Familiar!famtrab Then
                    conyuge = True
                Else
                    conyuge = False
                End If
            End If
        
            If (sexo_conyuge = 1 And conyuge_trabaja = 1) Then 'Conyuge masculino y trabaja
               GoTo SiguienteFamiliar
            End If
            interesa_estu = False
            edad_f = 0
        Else
            conyuge = 3
            sexo_conyuge = 3
            conyuge_trabaja = 3
        End If
        
        'buscar el nivel de estudio
        Fam_estudia = False
        StrSql = "SELECT * FROM estudio_actual WHERE ternro = " & rs_Familiar!Ternro
        OpenRecordset StrSql, rs_estudio_actual
        If Not rs_estudio_actual.EOF Then
            If Not EsNulo(rs_estudio_actual!nivnro) Then
                StrSql = "SELECT * FROM nivest WHERE nivnro =" & rs_estudio_actual!nivnro
                OpenRecordset StrSql, rs_Nivest
                If Not rs_Nivest.EOF Then
                    niv_est_interno = rs_Nivest!nivsist
                    Fam_niv_est = rs_Nivest!nivnro
                    Fam_estudia = IIf(EsNulo(rs_estudio_actual!nivnro), 2, 1)
                Else
                    niv_est_interno = False
                End If
            End If
        End If
            
            
        'ACA SE PODRIA VALIDAR LA VALIDEZ DEL CERTIFICADO ESCOLAR
        'INICIO
        'FIN
        'SI NO ES VALIDO EL CERTIFICADO, ASIGNAR A FAM-NIV-EST = ?
        'FAM-ESTUDIA = (estudio_actual.nivnro <> ?)
                   
        If (CBool(Incapacitado) = CBool(rs_Familiar!faminc)) Then
            If (Parentesco = rs_Familiar!parenro) And (edad_f <= edad Or EsNulo(edad)) And _
                ((Sexo = 1 And CBool(rs_Familiar!tersex)) Or (Sexo = 2 And Not CBool(rs_Familiar!tersex)) Or Sexo = 3) Then
                If (conyuge_trabaja = Trabaja_Conyuge Or Trabaja_Conyuge = 3) Then
                    If (Estudia = Fam_estudia Or Estudia = 3 Or (Not interesa_estu)) Then
                        If (InStr(1, Nivel_Estudio, Fam_niv_est) <> 0 Or EsNulo(Nivel_Estudio) Or (Not niv_est_interno)) Then
                            If (((Ayuda_Escolar = 1) And InStr(1, Nivel_Estudio, Fam_niv_est) <> 0) Or ((Ayuda_Escolar = 3) And _
                                    Not Retroactivo_Prenatal)) Then
                                Salida = True
                            End If
                        End If
                    End If
                End If
            End If
        End If
       
       
    If Salida Then
       'Controlo si tiene el concepto de familiares liquidado
       StrSql = " SELECT * FROM detliq WHERE cliqnro = " & cliqnro
       StrSql = StrSql & " AND concnro = " & concepto
       
       OpenRecordset StrSql, rs_Concepto
       
       Salida = Not rs_Concepto.EOF
        
       rs_Concepto.Close
    End If
       
    HayAsignacionesFliares = Salida
    
SiguienteFamiliar:
        rs_Familiar.MoveNext
    Loop
    
    Bien = True
    
'Cierro todo y libero
If Param_cur.State = adStateOpen Then Param_cur.Close
Set Param_cur = Nothing

If rs_estudio_actual.State = adStateOpen Then rs_estudio_actual.Close
Set rs_estudio_actual = Nothing

If rs_PeriodoEsc.State = adStateOpen Then rs_PeriodoEsc.Close
Set rs_PeriodoEsc = Nothing

If rs_Familiar.State = adStateOpen Then rs_Familiar.Close
Set rs_Familiar = Nothing

If rs_Nivest.State = adStateOpen Then rs_Nivest.Close
Set rs_Nivest = Nothing

If rs_Tercero.State = adStateOpen Then rs_Tercero.Close
Set rs_Tercero = Nothing

End Function


Public Function Calcular_Edad(ByVal Fecha As Date, ByVal Hasta As Date) As Integer
'...........................................................................
' Archivo       : edad.i                              fecha ini. : 20/01/92
' Nombre progr. :
' tipo programa : FGZ
' Descripcion   :
'...........................................................................
Dim años  As Integer
Dim ALaFecha As Date

    ALaFecha = C_Date(Hasta)
    
    años = Year(ALaFecha) - Year(Fecha)
    If Month(ALaFecha) < Month(Fecha) Then
       años = años - 1
    Else
        If Month(ALaFecha) = Month(Fecha) Then
            If Day(ALaFecha) < Day(Fecha) Then
                años = años - 1
            End If
        End If
    End If
    Calcular_Edad = años
End Function


Sub buscarDatosEmpresa(NroProc, Pronro)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim Ternro
Dim proFecPago
If tipoModelo = 42 Then
    Call buscarDatosEmpresaMetRoma(NroProc, Pronro)
Else
    empresa = ""
    emprNro = 0
    emprActiv = ""
    emprTer = 0
    emprCuit = ""
    emprDire = ""
    emprTel = ""

    ' -------------------------------------------------------------------------
    'Busco a un empleado para saber a que empresa pertenece
    ' -------------------------------------------------------------------------
    
    StrSql = "SELECT * FROM batch_empleado WHERE bpronro = " & NroProc
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
       Ternro = 0
       Flog.writeline "Error: Buscando datos de la empresa: al obtener el empleado"
    Else
       Ternro = rsConsult!Ternro
    End If
    
    rsConsult.Close
    
    '------------------------------------------------------------------
    'Busco los datos del proceso
    '------------------------------------------------------------------
    StrSql = " SELECT * FROM proceso "
    StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       proFecPago = rsConsult!proFecPago
    Else
       Flog.writeline "Error: Buscando datos de la empresa: al obtener los datos del proceso"
    End If
    
    rsConsult.Close

    ' -------------------------------------------------------------------------
    ' Busco los datos de la empresa
    '--------------------------------------------------------------------------
    
    StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom,empresa.empactiv " & _
        " From his_estructura " & _
        " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro " & _
        " WHERE his_estructura.htetdesde <= " & ConvFecha(proFecPago) & " AND " & _
        " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
        " AND his_estructura.ternro = " & Ternro & _
        " AND his_estructura.tenro  = 10"
    
    '---LOG---
    Flog.writeline "Buscando datos de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    emprNro = 0
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró la empresa"
        Exit Sub
    Else
        empresa = rsConsult!empnom
        emprNro = rsConsult!Estrnro
        emprActiv = rsConsult!empactiv
        emprTer = rsConsult!Ternro
    End If
    
    rsConsult.Close
    
    'Consulta para obtener la direccion de la empresa
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro, detdom.piso, detdom.oficdepto, localidad.provnro, detdom.codigopostal From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la empresa"
        'Exit Sub
        emprDire = "   "
    Else
        emprDire = rsConsult!calle & " " & rsConsult!nro
        '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
        If Not EsNulo(rsConsult!piso) Then
            emprDire = emprDire & " P. " & rsConsult!piso
        End If
        If Not EsNulo(rsConsult!oficdepto) Then
            emprDire = emprDire & " Dpto. " & rsConsult!oficdepto
        End If
        
        If tipoModelo = 41 Then
            emprDire = emprDire & " - "
            If Not EsNulo(rsConsult!codigopostal) Then
                emprDire = emprDire & "(" & rsConsult!codigopostal & ") "
            End If
            emprDire = emprDire & rsConsult!locdesc
        Else
            emprDire = emprDire & " - " & rsConsult!locdesc
        End If
        
        emprTel = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
        If Not EsNulo(rsConsult!provnro) Then
            emprProv = rsConsult!provnro
        Else
            emprProv = 0
        End If
        
    End If
   
    rsConsult.Close
    
    'Consulta para obtener el cuit de la empresa
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & emprTer
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Empresa"
        'Exit Sub
        emprCuit = "  "
    Else
        emprCuit = rsConsult!NroDoc
    End If
    
    rsConsult.Close
End If
End Sub

Sub buscarDatosEmpresaMetRoma(NroProc, Pronro)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim Ternro
Dim proFecPago
Dim emprLocPost
Dim emprPathAdi

    empresa = ""
    emprNro = 0
    emprActiv = ""
    emprTer = 0
    emprCuit = ""
    emprDire = ""
    emprTel = ""

    ' -------------------------------------------------------------------------
    'Busco a un empleado para saber a que empresa pertenece
    ' -------------------------------------------------------------------------
    
    StrSql = "SELECT * FROM batch_empleado WHERE bpronro = " & NroProc
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
       Ternro = 0
       Flog.writeline "Error: Buscando datos de la empresa: al obtener el empleado"
    Else
       Ternro = rsConsult!Ternro
    End If
    
    rsConsult.Close
    
    '------------------------------------------------------------------
    'Busco los datos del proceso
    '------------------------------------------------------------------
    StrSql = " SELECT * FROM proceso "
    StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       proFecPago = rsConsult!proFecPago
    Else
       Flog.writeline "Error: Buscando datos de la empresa: al obtener los datos del proceso"
    End If
    
    rsConsult.Close

    ' -------------------------------------------------------------------------
    ' Busco los datos de la empresa
    '--------------------------------------------------------------------------
    
    StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom,empresa.empactiv, empresa.pathadi " & _
        " From his_estructura " & _
        " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro " & _
        " WHERE his_estructura.htetdesde <= " & ConvFecha(proFecPago) & " AND " & _
        " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
        " AND his_estructura.ternro = " & Ternro & _
        " AND his_estructura.tenro  = 10"
    
    '---LOG---
    Flog.writeline "Buscando datos de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    emprNro = 0
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró la empresa"
        Exit Sub
    Else
        empresa = rsConsult!empnom
        emprNro = rsConsult!Estrnro
        emprActiv = "Actividad Principal: " & rsConsult!empactiv
        emprTer = rsConsult!Ternro
        emprPathAdi = rsConsult!pathadi
    End If
    
    rsConsult.Close
    
    'Consulta para obtener la direccion de la empresa
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro, detdom.piso, detdom.oficdepto, localidad.provnro, detdom.codigopostal From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.tidonro = 1 AND cabdom.ternro =" & emprTer & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.tipotel = 4 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la empresa"
        'Exit Sub
        emprDire = "   "
    Else
        emprDire = rsConsult!calle & " " & rsConsult!nro
        '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
        If Not EsNulo(rsConsult!piso) Then
            emprDire = emprDire & " P. " & rsConsult!piso
        End If
        If Not EsNulo(rsConsult!oficdepto) Then
            emprDire = emprDire & " Dpto. " & rsConsult!oficdepto
        End If
        
        If tipoModelo = 41 Then
            emprDire = emprDire & " - "
            If Not EsNulo(rsConsult!codigopostal) Then
                emprDire = emprDire & "(" & rsConsult!codigopostal & ") "
            End If
            emprDire = emprDire & rsConsult!locdesc
        Else
            'emprDire = emprDire '& " - " & rsConsult!locdesc
            If Not EsNulo(rsConsult!codigopostal) Then
                emprLocPost = rsConsult!codigopostal
            End If
            If Not EsNulo(rsConsult!locdesc) Then
                emprLocPost = emprLocPost & " - " & rsConsult!locdesc
            End If
        End If
        
        emprTel = IIf(EsNulo(rsConsult!telnro), "", "TEL: " & rsConsult!telnro)
        If Not EsNulo(rsConsult!provnro) Then
            emprProv = rsConsult!provnro
        Else
            emprProv = 0
        End If
        
    End If
    'empresa = empresa & "<br>" & emprDire
    emprDire = emprDire & "<br>" & emprLocPost & "<br>" & emprTel
    emprActiv = emprActiv & "<br>" & emprPathAdi
    rsConsult.Close
    
    'Consulta para obtener el cuit de la empresa
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & emprTer
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Empresa"
        'Exit Sub
        emprCuit = "  "
    Else
        emprCuit = "CUIT: " & rsConsult!NroDoc
    End If
    
    rsConsult.Close

End Sub



Sub buscarDatosEmpresaSecure(NroProc, Pronro)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim Ternro
Dim proFecPago

    empresa = ""
    emprNro = 0
    emprActiv = ""
    emprTer = 0
    emprCuit = ""
    emprDire = ""
    emprTel = ""

    ' -------------------------------------------------------------------------
    'Busco a un empleado para saber a que empresa pertenece
    ' -------------------------------------------------------------------------
    
    StrSql = "SELECT * FROM batch_empleado WHERE bpronro = " & NroProc
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
       Ternro = 0
       Flog.writeline "Error: Buscando datos de la empresa: al obtener el empleado"
    Else
       Ternro = rsConsult!Ternro
    End If
    
    rsConsult.Close
    
    '------------------------------------------------------------------
    'Busco los datos del proceso
    '------------------------------------------------------------------
    StrSql = " SELECT * FROM proceso "
    StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       proFecPago = rsConsult!proFecPago
    Else
       Flog.writeline "Error: Buscando datos de la empresa: al obtener los datos del proceso"
    End If
    
    rsConsult.Close

    ' -------------------------------------------------------------------------
    ' Busco los datos de la empresa
    '--------------------------------------------------------------------------
    
    StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom,empresa.empactiv " & _
        " From his_estructura " & _
        " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro " & _
        " WHERE his_estructura.htetdesde <= " & ConvFecha(proFecPago) & " AND " & _
        " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
        " AND his_estructura.ternro = " & Ternro & _
        " AND his_estructura.tenro  = 10"
    
    '---LOG---
    Flog.writeline "Buscando datos de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    emprNro = 0
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró la empresa"
        Exit Sub
    Else
        empresa = rsConsult!empnom
        emprNro = rsConsult!Estrnro
        emprActiv = rsConsult!empactiv
        emprTer = rsConsult!Ternro
    End If
    
    rsConsult.Close
    
    'Consulta para obtener la direccion de la empresa
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro, " & _
             " detdom.piso,detdom.codigopostal,detdom.oficdepto " & _
             " From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       emprDire = rsConsult!calle & " " & rsConsult!nro
       If rsConsult!piso <> "" Then
          emprDire = emprDire & " Piso " & rsConsult!piso
       End If
       emprDire = emprDire & " " & rsConsult!oficdepto
           
       CodPostal = rsConsult!codigopostal & " - " & rsConsult!locdesc
    Else
       Flog.writeline "No se encontró el domicilio de la empresa"
       'Exit Sub
       emprDire = "   "
    End If
    
    rsConsult.Close
    
    'Consulta para obtener el cuit de la empresa
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & emprTer
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Empresa"
        'Exit Sub
        emprCuit = "  "
    Else
        emprCuit = rsConsult!NroDoc
    End If
    
    rsConsult.Close

End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Jugos
'--------------------------------------------------------------------
Sub generarDatosEmpleado05(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim regimenHorario
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 5"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuetra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
 If IsNull(rsConsult!empfecbaja) Then
    fecbaja = ""
 Else
    fecbaja = rsConsult!empfecbaja
 End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del regimen horario"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=21 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHorario = ""

If Not rsConsult.EOF Then
   regimenHorario = rsConsult!estrdabr
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!piso), "", rsConsult!piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & regimenHorario & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Roche
'--------------------------------------------------------------------
Sub generarDatosEmpleado06(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cont As Long

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim Nacionalidad
Dim causaEgreso
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 6"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
' If IsNull(rsConsult!empfecbaja) Then
'    fecbaja = ""
' Else
'    fecbaja = rsConsult!empfecbaja
' End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la direccion del empleado"

OpenRecordset StrSql, rsConsult

Direccion = " "

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!piso & " " & rsConsult!oficdepto & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del documento"

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

If IsNull(Sueldo) Then
   Sueldo = bruto
End If

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes " & _
    " FROM tercero " & _
    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la fecha de baja y la causa de egreso
'--------------------------------------------------------------------------

causaEgreso = ""
fecbaja = ""

'---LOG---
Flog.writeline "Buscando datos de la causa de egreso"

 StrSql = " SELECT altfec, bajfec, caudes, estado, empatareas "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro=empant.empantnro "
 StrSql = StrSql & " LEFT JOIN causa ON fases.caunro=causa.caunro "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
     Flog.writeline "No se encontró la causa de egreso"
 '    Exit Sub
 Else
    If Not CBool(rsConsult!estado) Then
       fecbaja = rsConsult!bajfec
       causaEgreso = rsConsult!caudes
    End If
 End If
 
 rsConsult.Close

'------------------------------------------------------------------
'Busco la direccion de la empresa
'------------------------------------------------------------------
 
 'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    emprDire = "   "
Else
    emprDire = rsConsult!calle & " " & rsConsult!nro & "<br>" & rsConsult!codigopostal & " " & rsConsult!barrio & " - " & rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Or (pliqfecdep = "") Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxchar1,auxchar2,auxchar3,auxchar4, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & causaEgreso & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & controlNull(emprActiv)
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo1

    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
        
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'1')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 2
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo2
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'2')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next


'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 3
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo3
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'3')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
   
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub
Function sinDatos(Str)

  If IsNull(Str) Then
     sinDatos = True
  Else
     If Trim(Str) = "" Then
        sinDatos = True
     Else
        sinDatos = False
     End If
  End If

End Function


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y Deloitte
'--------------------------------------------------------------------
Sub generarDatosEmpleado07(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim ObraSocial

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 7"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4, auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Promofilm
'--------------------------------------------------------------------
Sub generarDatosEmpleado08(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim ObraSocial

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 8"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado=" & Ternro
StrSql = StrSql & " AND altfec <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ORDER BY altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    fecalta = ""
Else
    If Not IsNull(rsConsult!altfec) Then
        fecalta = rsConsult!altfec
    Else
        fecalta = ""
    End If
End If

If rsConsult.State = adStateOpen Then rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado=" & Ternro
StrSql = StrSql & " AND altfec <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND ( bajfec >= " & ConvFecha(pliqdesde) & " OR bajfec is null)"
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    fecbaja = ""
Else
    If Not IsNull(rsConsult!bajfec) Then
        If rsConsult!bajfec <= pliqhasta Then
            fecbaja = rsConsult!bajfec
        Else
            fecbaja = ""
        End If
    Else
        fecbaja = ""
    End If
End If

If rsConsult.State = adStateOpen Then rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4, auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


Sub buscarDatosEmpresaDada(ByVal Estrnro As Long, ByVal Ternro As Long, ByVal empnom As String, empactiv)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

    empresa = ""
    emprNro = 0
    emprActiv = ""
    emprTer = 0
    emprCuit = ""
    emprDire = ""

    '---LOG---
    Flog.writeline "Buscando datos de la empresa"
    
    If Estrnro = 0 Then
        Flog.writeline "No se encontró la empresa"
        Exit Sub
    Else
        empresa = empnom
        emprNro = Estrnro
        emprActiv = empactiv
        emprTer = Ternro
    End If
    
    'Consulta para obtener la direccion de la empresa
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la empresa"
        'Exit Sub
        emprDire = "   "
    Else
        emprDire = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    End If
   
    rsConsult.Close
    
    'Consulta para obtener el cuit de la empresa
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & emprTer
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la empresa"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Empresa"
        'Exit Sub
        emprCuit = "  "
    Else
        emprCuit = rsConsult!NroDoc
    End If
    
    rsConsult.Close

End Sub


Sub generarDatosEmpleado09(Pronro, Ternro, descripcion, orden)
' ---------------------------------------------------------------------------------------------
' Se encarga de generar los datos para Arena Argentina
' Descripcion: modelo 9.
' Autor      :
' Fecha      :
' Ultima Mod.: 20/07/2006 - FGZ - agregados de log
' Ultima Mod.: 07/08/2006 - FGZ - Agergado de log cuando inserta conceptos sin tipo configurado
' ---------------------------------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim empfbajaprev
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 9"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfbajaprev "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empfbajaprev = rsConsult!empfbajaprev
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & empfbajaprev & "'"
StrSql = StrSql & ")"
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Insertando ... " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontraron datos del detalle de liquidacion. SQL: " & StrSql
End If
Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  objConn.Execute StrSql, , adExecuteNoRecords
  
  If arrTipoConc(rsConsult!tconnro) = 0 Then
    Flog.writeline ""
    Flog.writeline "    Concepto " & rsConsult!ConcCod & " tipo " & rsConsult!tconnro & " no configurado en Libro ley"
    Flog.writeline ""
  End If
  Flog.writeline "insertando... concepto: " & rsConsult!ConcCod & "(" & rsConsult!tconnro & ") monto: " & rsConsult!dlimonto & " [" & StrSql & "]"

  rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontraron datos de Fliares. SQL: " & StrSql
    End If
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          Flog.writeline "Insertando datos de Fliares. SQL: " & StrSql
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline "SQl: " & StrSql
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


Sub generarDatosEmpleado09_old(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim empfbajaprev
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 9"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfbajaprev "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empfbajaprev = rsConsult!empfbajaprev
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & empfbajaprev & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
      StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para EMC
'--------------------------------------------------------------------
Sub generarDatosEmpleado10(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim Antiguedad
Dim FechaAntig
Dim Sexo
Dim SueldoJornal

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 10"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empfaltagr,empremu,tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro "
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sexo = rsConsult!tersex
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec ASC"

 OpenRecordset StrSql, rsConsult

 If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    End If
 End If
 
 rsConsult.Close
  
' -------------------------------------------------------------------------
' Busco la fecha de antiguedad
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de antiguedad"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE fasrecofec = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 FechaAntig = ""
  
 If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!altfec) Then
       FechaAntig = rsConsult!altfec
    End If
 End If
 
 rsConsult.Close
 
 If FechaAntig <> "" Then
    Antiguedad = DateDiff("yyyy", CDate(FechaAntig), CDate(pliqhasta))
    If Antiguedad < 0 Then
       Antiguedad = 0
    End If
 Else
    If fecalta <> "" Then
       FechaAntig = fecalta
       Antiguedad = DateDiff("yyyy", CDate(FechaAntig), CDate(pliqhasta))
       If Antiguedad < 0 Then
          Antiguedad = 0
       End If
    Else
       Antiguedad = 0
    End If
 End If
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Acumulador de sueldo jornal
sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & acumSueldoJornal
sql = sql & " AND cliqnro =  " & cliqnro

'---LOG---
Flog.writeline "Buscando datos del acumulador de sueldo/jornal"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   SueldoJornal = 0
Else
   SueldoJornal = rsConsult!almonto
End If

rsConsult.Close

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5,auxdeci1, auxdeci2, auxdeci3) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & FechaAntig & "'"
StrSql = StrSql & "," & numberForSQL(Antiguedad)
StrSql = StrSql & "," & numberForSQL(Sexo)
StrSql = StrSql & "," & numberForSQL(SueldoJornal)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Schering
'--------------------------------------------------------------------
Sub generarDatosEmpleado12(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim Nacionalidad As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim bruto_Acum As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""


Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empfaltagr,empremu,nacionaldes "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON empleado.ternro = tercero.ternro "
StrSql = StrSql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro "
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

Nacionalidad = ""
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Nacionalidad = rsConsult!nacionaldes
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
'-------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'Bruto Acumulado
If es_Acum_Bruto_Acum Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto_Acum
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto_Acum
End If

'---LOG---
Flog.writeline "Buscando datos del bruto acumulado"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto_Acum = 0
Else
   bruto_Acum = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, auxdeci1, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & "," & numberForSQL(bruto_Acum)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    'Resume Next
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Casino Club (UTE)
'--------------------------------------------------------------------
Sub generarDatosEmpleado11(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim Convenio
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim Antiguedad
Dim FechaAntig
Dim Sexo
Dim SueldoJornal

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 11"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empfaltagr,empremu,tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro "
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sexo = rsConsult!tersex
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrcodext AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real=-1 AND fases.empleado=" & Ternro & " order by altfec ASC"

 OpenRecordset StrSql, rsConsult

 If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    End If
 End If
 
 rsConsult.Close
  
' -------------------------------------------------------------------------
' Busco la fecha de antiguedad
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de antiguedad"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE fasrecofec = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 FechaAntig = ""
  
 If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!altfec) Then
       FechaAntig = rsConsult!altfec
    End If
 End If
 
 rsConsult.Close
 
 If FechaAntig <> "" Then
    Antiguedad = DateDiff("yyyy", CDate(FechaAntig), CDate(pliqhasta))
    If Antiguedad < 0 Then
       Antiguedad = 0
    End If
 Else
    If fecalta <> "" Then
       FechaAntig = fecalta
       Antiguedad = DateDiff("yyyy", CDate(FechaAntig), CDate(pliqhasta))
       If Antiguedad < 0 Then
          Antiguedad = 0
       End If
    Else
       Antiguedad = 0
    End If
 End If
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del convenio"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=19 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

rsConsult.Close

   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la nacionalidad
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

sql = " SELECT nacionaldes "
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

If Not rsConsult.EOF Then
   documento = documento & " " & UCase(Mid(rsConsult!nacionaldes, 1, 1))
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Acumulador de sueldo jornal
sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & acumSueldoJornal
sql = sql & " AND cliqnro =  " & cliqnro

'---LOG---
Flog.writeline "Buscando datos del acumulador de sueldo/jornal"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   SueldoJornal = 0
Else
   SueldoJornal = rsConsult!almonto
End If

rsConsult.Close

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provcodext "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           If IsNull(rsConsult!provcodext) Then
              If IsNull(rsConsult!codigopostal) Then
                 Direccion = rsConsult!calle & "@" & rsConsult!nro & "@" & rsConsult!locdesc & "@@"
              Else
                 Direccion = rsConsult!calle & "@" & rsConsult!nro & "@" & rsConsult!locdesc & "@@" & rsConsult!codigopostal
              End If
           Else
              If IsNull(rsConsult!codigopostal) Then
                 Direccion = rsConsult!calle & "@" & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!provcodext & "@"
              Else
                 Direccion = rsConsult!calle & "@" & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!provcodext & "@" & rsConsult!codigopostal
              End If
           End If
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5,auxdeci1, auxdeci2, auxdeci3) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & FechaAntig & "'"
StrSql = StrSql & "," & numberForSQL(Antiguedad)
StrSql = StrSql & "," & numberForSQL(Sexo)
StrSql = StrSql & "," & numberForSQL(SueldoJornal)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE parentesco.parenro = 2 AND familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Cia. Alimentos
'--------------------------------------------------------------------
Sub generarDatosEmpleado13(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro
Dim regimenHorario

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 13"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult


 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de Alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecalta = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del regimen horario"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=21 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHorario = ""

If Not rsConsult.EOF Then
   regimenHorario = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & regimenHorario & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub




'--------------------------------------------------------------------
' Se encarga de generar los datos para glencore
'--------------------------------------------------------------------
Sub generarDatosEmpleado14(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3


Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 14"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco el valor del lugar de trabajo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del lugar de trabajo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Lug_Trab = ""

If Not rsConsult.EOF Then
   Lug_Trab = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
         StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & emprTel & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
             If Not GuardarFam Then
                GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg3, cliqnro, concFamiliar03)
             End If
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


Sub generarDatosEmpleado16(Pronro, Ternro, descripcion, orden)
'--------------------------------------------------------------------
' Se encarga de generar los datos para Deloitte Personal
'--------------------------------------------------------------------
'
'Ultima Modificacion: FGZ - 30/03/2006
'                     Problemas con el campo agencia. Treae vacio, 0 y nro de agencias
'Ultima Modificacion: FGZ - 16/05/2006
'                     Se le agrego al estandar la posibilidad de tirar empleados de agencia.
'Ultima Modificacion: FGZ - 19/05/2006
'                     Problemas con el campo agencia. Treae vacio, 0 y nro de agencias
'--------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

Dim agencia As Long

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 16"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,agencia "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   agenciaEmpleado = Trim(rsConsult!agencia)
   If agenciaEmpleado = "0" Then
        agenciaEmpleado = ""
   End If
   
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = IIf(Not EsNulo(rsConsult!nrocuil), rsConsult!nrocuil, "")
   documento = IIf(Not EsNulo(rsConsult!sigladoc), rsConsult!sigladoc, "DNI") & "-" & IIf(Not EsNulo(rsConsult!NroDoc), rsConsult!NroDoc, "")
   fecha_nac = IIf(Not EsNulo(rsConsult!terfecnac), rsConsult!terfecnac, "")
   est_civil = IIf(Not EsNulo(rsConsult!estcivdesabr), rsConsult!estcivdesabr, 0)
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
   GoTo MError
End If

rsConsult.Close

'18-05-2006 - Se agrego para que ponga la direccion de la agencia

'------------------------------------------------------------------
'Si es un empleado de agencia busco la direccion y el cuit de la agencia
'------------------------------------------------------------------
Dim agenciaTernro As Long
Dim empresaActual As String
Dim emprDireActual As String
Dim emprTelActual As String
Dim emprCuitActual As String

'If Not IsNull(agenciaEmpleado) Then
If Not EsNulo(agenciaEmpleado) Then
    StrSql = " SELECT agencia.ternro, estrdabr FROM agencia "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = agencia.estrnro "
    StrSql = StrSql & " WHERE "
    StrSql = StrSql & " estructura.estrnro = " & agenciaEmpleado
        
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       agenciaTernro = rsConsult!Ternro
       empresaActual = rsConsult!estrdabr
    Else
       agenciaTernro = 0
       empresaActual = " "
       Flog.writeline "No se encontro la agencia"
    End If
    
    'Consulta para obtener la direccion de la agencia
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & agenciaTernro & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la agencia"
        'Exit Sub
        emprDireActual = "   "
        emprTelActual = "   "
    Else
        emprDireActual = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
        emprTelActual = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
    End If
   
    rsConsult.Close
    
    'Consulta para obtener el cuit de la agencia
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & agenciaTernro
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Agencia"
        'Exit Sub
        emprCuitActual = "  "
    Else
        emprCuitActual = rsConsult!NroDoc
    End If
    
    rsConsult.Close
    
Else
    empresaActual = empresa
    emprDireActual = emprDire
    emprTelActual = emprTel
    emprCuitActual = emprCuit
End If




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

If EsNulo(agenciaEmpleado) Then
   agencia = 0
Else
   agencia = -1
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresaActual & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuitActual & "'"
StrSql = StrSql & ",'" & emprDireActual & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & "," & agencia
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

'If IsNull(agenciaEmpleado) Then
If EsNulo(agenciaEmpleado) Then

    'No es un empleado de agencia
    agencia = 0
    StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
        " FROM cabliq " & _
        " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
        " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
        " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
        " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
        " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
    '---LOG---
    Flog.writeline "Buscando datos del detalle de liquidacion"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!concabr & "'"
      StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
      StrSql = StrSql & "," & rsConsult!ConcNro
      StrSql = StrSql & "," & rsConsult!concimp
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
      StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close
    
Else

    'Es un empleado de agencia
    Flog.writeline "Es un empleado de agencia"
    
    agencia = -1
    StrSql = " SELECT acu_mes.acunro,acudesabr,ammonto,amcant " & _
        " FROM acu_mes" & _
        " INNER JOIN acumulador ON acumulador.acunro = acu_mes.acunro AND acu_mes.ternro = " & Ternro & _
        " Where acu_mes.ternro = " & Ternro & _
        "   AND acu_mes.amanio = " & pliqanio & _
        "   AND acu_mes.ammes  = " & pliqmes & _
        "   AND acumulador.acunro = " & acumEmplAgencia
    
    '---LOG---
    Flog.writeline "    Buscando datos del Acu_Mes, acumulador " & acumEmplAgencia & " mes: " & pliqmes & " año: " & pliqanio
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!acudesabr & "'"
      StrSql = StrSql & ",'" & rsConsult!acuNro & "'"
      StrSql = StrSql & "," & rsConsult!acuNro
      StrSql = StrSql & ",-1"
      StrSql = StrSql & "," & numberForSQL(rsConsult!amcant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!ammonto)
      StrSql = StrSql & ",'0'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para el Los Grobo
'--------------------------------------------------------------------
Sub generarDatosEmpleado15(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim EmpTernro
Dim formaliquidacion
Dim Sector

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 15"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr categoria, estr2.estrdabr contrato, estr3.estrdabr puesto, estr4.estrdabr regprev, estr5.estrdabr sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult


 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de Alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecalta = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc nrocuil, docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & "  " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del sector"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=21 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Forma de Liquidación
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Forma de Liquidación"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=22 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

formaliquidacion = ""

If Not rsConsult.EOF Then
   formaliquidacion = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & formaliquidacion & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Norton
'--------------------------------------------------------------------
Sub generarDatosEmpleado17(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim emprCuitActual
Dim emprDireActual
Dim emprTelActual
Dim empresaActual

Dim agenciaTernro

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 17"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,agencia "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   agenciaEmpleado = rsConsult!agencia
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Si es un empleado de agencia busco la direccion y el cuit de la agencia
'------------------------------------------------------------------

If Not IsNull(agenciaEmpleado) Then

    StrSql = " SELECT agencia.ternro, estrdabr FROM agencia "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = agencia.estrnro "
    StrSql = StrSql & " WHERE "
    StrSql = StrSql & " estructura.estrnro = " & agenciaEmpleado
        
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       agenciaTernro = rsConsult!Ternro
       empresaActual = rsConsult!estrdabr
    Else
       agenciaTernro = 0
       empresaActual = " "
       Flog.writeline "No se encontro la agencia"
    End If
    
    'Consulta para obtener la direccion de la agencia
    StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro From cabdom " & _
        " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & agenciaTernro & _
        " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
        " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
    '---LOG---
    Flog.writeline "Buscando datos de la direccion de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el domicilio de la agencia"
        'Exit Sub
        emprDireActual = "   "
        emprTelActual = "   "
    Else
        emprDireActual = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
        emprTelActual = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
    End If
   
    rsConsult.Close
    
    'Consulta para obtener el cuit de la agencia
    StrSql = "SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
             " Where tercero.ternro =" & agenciaTernro
    
    '---LOG---
    Flog.writeline "Buscando datos del cuit de la agencia"
    
    OpenRecordset StrSql, rsConsult
    
    If rsConsult.EOF Then
        Flog.writeline "No se encontró el CUIT de la Agencia"
        'Exit Sub
        emprCuitActual = "  "
    Else
        emprCuitActual = rsConsult!NroDoc
    End If
    
    rsConsult.Close
    
Else
    empresaActual = empresa
    emprDireActual = emprDire
    emprTelActual = emprTel
    emprCuitActual = emprCuit
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If


StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresaActual & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuitActual & "'"
StrSql = StrSql & ",'" & emprDireActual & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

If IsNull(agenciaEmpleado) Then

    'No es un empleado de agencia

    StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
        " FROM cabliq " & _
        " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
        " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
        " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
        " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
        " ORDER BY concepto.conccod "
    
    '---LOG---
    Flog.writeline "Buscando datos del detalle de liquidacion"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!concabr & "'"
      StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
      StrSql = StrSql & "," & rsConsult!ConcNro
      StrSql = StrSql & "," & rsConsult!concimp
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
      StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close
    
Else

    'Es un empleado de agencia
    
    StrSql = " SELECT acu_mes.acunro,acudesabr,ammonto,amcant " & _
        " FROM acu_mes" & _
        " INNER JOIN acumulador ON acumulador.acunro = acu_mes.acunro AND acu_mes.ternro = " & Ternro & _
        " Where acu_mes.ternro = " & Ternro & _
        "   AND acu_mes.amanio = " & pliqanio & _
        "   AND acu_mes.ammes  = " & pliqmes & _
        "   AND acumulador.acunro = " & acumEmplAgencia
    
    '---LOG---
    Flog.writeline "Buscando datos del detalle de liquidacion"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!acudesabr & "'"
      StrSql = StrSql & ",'" & rsConsult!acuNro & "'"
      StrSql = StrSql & "," & rsConsult!acuNro
      StrSql = StrSql & ",-1"
      StrSql = StrSql & "," & numberForSQL(rsConsult!amcant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!ammonto)
      StrSql = StrSql & ",'0'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If
    

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'-----------------------------------------------------------------------------------
' Se encarga de generar los datos para empleados de Agencia. Proceso Standart
'-----------------------------------------------------------------------------------
Sub generarDatosEmpAge01(pliqnro, pliqmes, pliqanio, pliqdesc, pliqdesde, pliqhasta, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim proFecPago
Dim proDesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim GuardarFam As Boolean
Dim agenciaEmpleado

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim emprCuitActual
Dim emprDireActual
Dim emprTelActual
Dim empresaActual

Dim agenciaTernro

'Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo Empleados de Agencia 1 - Standart"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,agencia "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado de Agencia"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   agenciaEmpleado = rsConsult!agencia
Else
   Flog.writeline "Error al obtener los datos del empleado de Agencia"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 StrSql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr categoria, estr2.estrdabr contrato, estr3.estrdabr puesto, estr4.estrdabr regprev, estr5.estrdabr sucursal, estr6.estrdabr ccosto "
 StrSql = StrSql & " FROM empleado "
 'Busco la categoria
 StrSql = StrSql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 StrSql = StrSql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 StrSql = StrSql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 StrSql = StrSql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 StrSql = StrSql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el centro de costo
 StrSql = StrSql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his5.tenro = 5 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
    
 StrSql = StrSql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset StrSql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 'Centro de costo
 If IsNull(rsConsult!ccosto) Then
   CentroCosto = ""
 Else
   CentroCosto = rsConsult!ccosto
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
'-------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
'---LOG---
'Flog.writeline "Buscando datos del centro de costo"
'
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
'
'OpenRecordset StrSql, rsConsult
'
'centroCosto = ""
'
'If Not rsConsult.EOF Then
'   centroCosto = rsConsult!estrdabr
'Else
''   Flog.writeline "Error al obtener los datos del centro de costo"
''   GoTo MError
'End If
'
'rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de los documentos"

StrSql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------
Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        StrSql = StrSql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Si es un empleado de agencia busco la direccion y el cuit de la agencia
'------------------------------------------------------------------
If Not IsNull(agenciaEmpleado) Or agenciaEmpleado <> "" Then ' Dimatz Rafael - CAS 21687 Se agrega esta condicion para que no de error la query
    StrSql = " SELECT agencia.ternro, estrdabr FROM agencia "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = agencia.estrnro "
    StrSql = StrSql & " WHERE estructura.estrnro = " & agenciaEmpleado
            
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
       agenciaTernro = rsConsult!Ternro
       empresaActual = rsConsult!estrdabr
    Else
       agenciaTernro = 0
       empresaActual = " "
       Flog.writeline "No se encontro la agencia"
    End If
Else
    agenciaTernro = 0
    empresaActual = " "
End If

'Consulta para obtener la direccion de la agencia
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro From cabdom " & _
         " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & agenciaTernro & _
         " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
         " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
'---LOG---
Flog.writeline "Buscando datos de la dirección de la agencia"
    
OpenRecordset StrSql, rsConsult
    
If rsConsult.EOF Then
   Flog.writeline "No se encontró el domicilio de la agencia"
   'Exit Sub
   emprDireActual = "   "
   emprTelActual = "   "
Else
   emprDireActual = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
   emprTelActual = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
End If
   
rsConsult.Close
    
'Consulta para obtener el cuit de la agencia
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & agenciaTernro
    
'---LOG---
Flog.writeline "Buscando datos del CUIT de la agencia"
    
OpenRecordset StrSql, rsConsult
    
If rsConsult.EOF Then
   Flog.writeline "No se encontró el CUIT de la Agencia"
   'Exit Sub
   emprCuitActual = "  "
Else
   emprCuitActual = rsConsult!NroDoc
End If
    
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresaActual & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",' '"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",' '"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",null"
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuitActual & "'"
StrSql = StrSql & ",'" & emprDireActual & "'"
StrSql = StrSql & ",''"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",-1"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle en acu_age para el empleado de agencia
'------------------------------------------------------------------
StrSql = " SELECT acu_age.acunro,acudesabr,acagmonto,acagcant " & _
         " FROM acu_age" & _
         " INNER JOIN acumulador ON acumulador.acunro = acu_age.acunro " & _
         " WHERE acu_age.empage = " & Ternro & _
         "   AND acu_age.acunro IN (" & listaAcumEmplAgencia & ")" & _
         "   AND acu_age.pliqnro = " & pliqnro & _
         " ORDER BY acu_age.acunro "
    
'---LOG---
Flog.writeline "Buscando datos de los acumuladores informados para el empleado de Agencia"
    
OpenRecordset StrSql, rsConsult
    
Do Until rsConsult.EOF
    
   StrSql = " INSERT INTO rep_libroley_det "
   StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
   StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
   StrSql = StrSql & " dlimonto,conctipo) "
   StrSql = StrSql & " VALUES "
   StrSql = StrSql & "(" & NroProceso
   StrSql = StrSql & "," & Ternro
   StrSql = StrSql & "," & pliqnro
   StrSql = StrSql & ",'" & rsConsult!acudesabr & "'"
   StrSql = StrSql & ",'" & rsConsult!acuNro & "'"
   StrSql = StrSql & "," & rsConsult!acuNro
   StrSql = StrSql & ",-1"
   StrSql = StrSql & "," & numberForSQL(rsConsult!acagcant)
   StrSql = StrSql & "," & numberForSQL(rsConsult!acagmonto)
   StrSql = StrSql & ",'0'"
   StrSql = StrSql & ")"
      
   objConn.Execute StrSql, , adExecuteNoRecords
    
   rsConsult.MoveNext
      
Loop
    
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------
If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc, tercero.ternro,terape,ternom,terfecnac,tersex, " & _
          " famest,famtrab,faminc,famDGIdesde,famsalario,famfecvto,famCargaDGI,famDGIdesde,famDGIhasta,famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"

    OpenRecordset StrSql, rsConsult

    Do Until rsConsult.EOF

        If IsNull(rsConsult!terfecnac) Then
           terfecnac = "NULL"
        Else
           terfecnac = ConvFecha(rsConsult!terfecnac)
        End If

        If IsNull(rsConsult!famfecvto) Then
           famfecvto = "NULL"
        Else
           famfecvto = ConvFecha(rsConsult!famfecvto)
        End If

        If IsNull(rsConsult!famDGIdesde) Then
           famDGIdesde = "NULL"
        Else
           famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
        End If

        If IsNull(rsConsult!famDGIhasta) Then
           famDGIhasta = "NULL"
        Else
           famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
        End If

        StrSql = " INSERT INTO rep_libroley_fam "
        StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
        StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
        StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
        StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
        StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
        StrSql = StrSql & " ) "
        StrSql = StrSql & " VALUES "
        StrSql = StrSql & "(" & NroProceso
        StrSql = StrSql & "," & Ternro
        StrSql = StrSql & "," & pliqnro
        StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
        StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
        StrSql = StrSql & "," & rsConsult!Ternro
        StrSql = StrSql & ",'" & rsConsult!terape & "'"
        StrSql = StrSql & ",'" & rsConsult!ternom & "'"
        StrSql = StrSql & "," & terfecnac
        StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
        StrSql = StrSql & "," & strForSQL(rsConsult!famest)
        StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
        StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
        StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
        StrSql = StrSql & "," & famfecvto
        StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
        StrSql = StrSql & "," & famDGIdesde
        StrSql = StrSql & "," & famDGIhasta
        StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
        StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
        StrSql = StrSql & ")"

        objConn.Execute StrSql, , adExecuteNoRecords

        rsConsult.MoveNext

    Loop

    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline "Ultima SQl ejecutada: " & StrSql
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'-----------------------------------------------------------------------------------
' Se encarga de generar los datos para empleados de Agencia. Proceso Litoral Gas
'-----------------------------------------------------------------------------------
Sub generarDatosEmpAge20(pliqnro, pliqmes, pliqanio, pliqdesc, pliqdesde, pliqhasta, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim proFecPago
Dim proDesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim GuardarFam As Boolean
Dim agenciaEmpleado
Dim acuAge As Double
Dim CuitAgencia As String
Dim NroHabAgencia As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim emprCuitActual
Dim emprDireActual
Dim emprTelActual
Dim empresaActual

Dim agenciaTernro

'Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo Empleados de Agencia 20 - Litoral Gas"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,agencia "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado de Agencia"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'agenciaEmpleado = rsConsult!agencia
Else
   Flog.writeline "Error al obtener los datos del empleado de Agencia"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 StrSql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr categoria, estr2.estrdabr contrato, estr3.estrdabr puesto , estr4.estrnro nroagencia "
 StrSql = StrSql & " FROM empleado "
 'Busco la categoria
 StrSql = StrSql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco la tarea
 StrSql = StrSql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 48 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco la calificacion profesional
 StrSql = StrSql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 52 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco la agencia
 StrSql = StrSql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 28 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
     
 StrSql = StrSql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset StrSql, rsConsult

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Tarea
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Calificacion profesional
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'agencia
 If IsNull(rsConsult!nroagencia) Then
   agenciaEmpleado = 0
 Else
   agenciaEmpleado = rsConsult!nroagencia
 End If
  
 estado = rsConsult!empest
 
 rsConsult.Close
 
'-------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de fecha de alta y baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = "00/00/00"
      fecalta = "00/00/00"
      Flog.writeline "No encontró fase."
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = Format(CDate(rsConsult!bajfec), "dd/mm/yy")
    Else
        fecbaja = "00/00/00"
        Flog.writeline "Fecha de baja nula. "
    End If
    
    If Not IsNull(rsConsult!altfec) Then
       fecalta = Format(CDate(rsConsult!altfec), "dd/mm/yy")
    Else
        fecalta = "00/00/00"
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor doc y tipo doc
'------------------------------------------------------------------
'---LOG---
Flog.writeline "Buscando datos de los documentos"

StrSql = " SELECT tercero.terfecnac, docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc"
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   documento = rsConsult!sigladoc & " " & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------
Direccion = ""


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
   pliqfecdep = ""

'------------------------------------------------------------------
'Si es un empleado de agencia busco la direccion y el cuit de la agencia
'------------------------------------------------------------------
StrSql = " SELECT agencia.ternro, estrdabr FROM agencia "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = agencia.estrnro "
StrSql = StrSql & " WHERE estructura.estrnro = " & agenciaEmpleado
        
OpenRecordset StrSql, rsConsult
    
If Not rsConsult.EOF Then
   agenciaTernro = rsConsult!Ternro
   empresaActual = rsConsult!estrdabr
Else
   agenciaTernro = 0
   empresaActual = " "
   Flog.writeline "No se encontro la agencia"
End If
    
'Consulta para obtener la direccion de la agencia
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, telefono.telnro From cabdom " & _
         " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & agenciaTernro & _
         " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
         " LEFT JOIN telefono ON detdom.domnro = telefono.domnro and telefono.teldefault = -1 "
    
'---LOG---
Flog.writeline "Buscando datos de la dirección de la agencia"
    
OpenRecordset StrSql, rsConsult
    
If rsConsult.EOF Then
   Flog.writeline "No se encontró el domicilio de la agencia"
   'Exit Sub
   emprDireActual = "   "
   emprTelActual = "   "
Else
   emprDireActual = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
   emprTelActual = IIf(EsNulo(rsConsult!telnro), "", rsConsult!telnro)
End If
   
rsConsult.Close
    
emprCuitActual = "  "

'----------------------------------------------------------------
'Busco el CUIT de la agencia
'----------------------------------------------------------------
StrSql = " SELECT docu.nrodoc nrodoc"
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro= tercero.ternro and docu.tidnro = 6 "
StrSql = StrSql & " WHERE tercero.ternro= " & agenciaTernro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CuitAgencia = CStr(rsConsult!NroDoc)
Else
    Flog.writeline "No se encuentra el cuit de la agencia(" & agenciaTernro & ")"
    CuitAgencia = ""
End If
rsConsult.Close

'----------------------------------------------------------------
'Busco el codigo de habilitacion de la agencia
'----------------------------------------------------------------
Dim nroConfRefAg As Integer
Flog.writeline "Buscando config de familiares en el confrep"

StrSql = " SELECT * FROM confrep "
    StrSql = StrSql & " WHERE repnro = 61 "
StrSql = StrSql & " AND confnrocol = 68 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    nroConfRefAg = CLng(rsConsult!confval)
    rsConsult.Close
    
    'Busco el codigo asociado a la estructura de la agencia
    StrSql = " SELECT nrocod FROM estr_cod "
    StrSql = StrSql & " WHERE tcodnro = " & nroConfRefAg
    StrSql = StrSql & " AND estrnro = " & agenciaEmpleado 'agenciaTernro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        NroHabAgencia = CStr(rsConsult!nrocod)
    Else
        Flog.writeline "No se encuentra configurado Cod. de habilitacion de la empresa en las estructuras."
        NroHabAgencia = ""
    End If
    rsConsult.Close
Else
    Flog.writeline "No se encuentra configurado Cod. de habilitacion de la empresa en el confrep 61."
    NroHabAgencia = ""
    rsConsult.Close
End If



'------------------------------------------------------------------
'Busco el detalle en acu_age para el empleado de agencia
'------------------------------------------------------------------
StrSql = " SELECT acu_age.acunro,acudesabr,acagmonto,acagcant " & _
         " FROM acu_age" & _
         " INNER JOIN acumulador ON acumulador.acunro = acu_age.acunro " & _
         " WHERE acu_age.empage = " & Ternro & _
         "   AND acu_age.acunro IN (" & listaAcumEmplAgencia & ")" & _
         "   AND acu_age.pliqnro = " & pliqnro & _
         " ORDER BY acu_age.acunro "
    
'---LOG---
Flog.writeline "Buscando datos de los acumuladores informados para el empleado de Agencia"
    
OpenRecordset StrSql, rsConsult

acuAge = 0
Do Until rsConsult.EOF
    
   'StrSql = StrSql & "," & numberForSQL(rsConsult!acagmonto)
   acuAge = acuAge + rsConsult!acagmonto
   rsConsult.MoveNext
      
Loop
    
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5,auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresaActual & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",' '"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & "," & numberForSQL(acuAge)
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",0"
StrSql = StrSql & ",' '"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",null"
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
'StrSql = StrSql & ",'" & emprCuitActual & "'"
StrSql = StrSql & ",'" & CuitAgencia & "'"
StrSql = StrSql & ",'" & emprDireActual & "'"
StrSql = StrSql & ",''"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & NroHabAgencia & "'"
StrSql = StrSql & ",-1"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle en acu_age para el empleado de agencia
'------------------------------------------------------------------
StrSql = " SELECT acu_age.acunro,acudesabr,acagmonto,acagcant " & _
         " FROM acu_age" & _
         " INNER JOIN acumulador ON acumulador.acunro = acu_age.acunro " & _
         " WHERE acu_age.empage = " & Ternro & _
         "   AND acu_age.acunro IN (" & listaAcumEmplAgencia & ")" & _
         "   AND acu_age.pliqnro = " & pliqnro & _
         " ORDER BY acu_age.acunro "
    
'---LOG---
Flog.writeline "Buscando datos de los acumuladores informados para el empleado de Agencia"
    
OpenRecordset StrSql, rsConsult
    
Do Until rsConsult.EOF
    
   StrSql = " INSERT INTO rep_libroley_det "
   StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
   StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
   StrSql = StrSql & " dlimonto,conctipo) "
   StrSql = StrSql & " VALUES "
   StrSql = StrSql & "(" & NroProceso
   StrSql = StrSql & "," & Ternro
   StrSql = StrSql & "," & pliqnro
   StrSql = StrSql & ",'" & rsConsult!acudesabr & "'"
   StrSql = StrSql & ",'" & rsConsult!acuNro & "'"
   StrSql = StrSql & "," & rsConsult!acuNro
   StrSql = StrSql & ",-1"
   StrSql = StrSql & "," & numberForSQL(rsConsult!acagcant)
   StrSql = StrSql & "," & numberForSQL(rsConsult!acagmonto)
   StrSql = StrSql & ",'0'"
   StrSql = StrSql & ")"
      
   objConn.Execute StrSql, , adExecuteNoRecords
    
   rsConsult.MoveNext
      
Loop
    
rsConsult.Close
'------------------------------------------------------------------
'------------------------------------------------------------------
Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline "Ultima SQl ejecutada: " & StrSql
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Secure Bag
'--------------------------------------------------------------------
Sub generarDatosEmpleado18(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Localidad As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 18"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Localidad & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & CodPostal & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para BIA
'--------------------------------------------------------------------
Sub generarDatosEmpleado19(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim Nacionalidad
Dim causaEgreso
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 19"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso."
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Fecha Baja
'------------------------------------------------------------------
StrSql = " SELECT bajfec FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro & " AND altfec <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If IsNull(rsConsult!bajfec) Then
       fecbaja = ""
   Else
       fecbaja = rsConsult!bajfec
   End If
Else
   fecbaja = ""
   Flog.writeline "No se encontraron la fecha de Baja"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 StrSql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 StrSql = StrSql & " FROM empleado "
 'Busco la categoria
 StrSql = StrSql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 StrSql = StrSql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 StrSql = StrSql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 StrSql = StrSql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 StrSql = StrSql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 StrSql = StrSql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 StrSql = StrSql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 OpenRecordset StrSql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.codigopostal"
'strsql = strsql & " From his_estructura"
'strsql = strsql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
StrSql = StrSql & " From cabdom"
'strsql = strsql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE cabdom.ternro = " & Ternro & " AND cabdom.domdefault = -1"
    
'---LOG---
Flog.writeline "Buscando datos de la direccion"
    
OpenRecordset StrSql, rsConsult

Direccion = ""
If Not rsConsult.EOF Then
       Direccion = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!codigopostal & " " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del documento"

OpenRecordset StrSql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Basico
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Neto
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Msr
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Asi_flia
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Dtos
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    StrSql = " SELECT almonto,acunro "
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & cod_Bruto
    StrSql = StrSql & " AND cliqnro =  " & cliqnro
Else
    StrSql = " SELECT detliq.dlimonto AS almonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

'StrSql = "SELECT nacionaldes " & _
'    " FROM tercero " & _
'    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & ternro

'---LOG---
'Flog.writeline "Buscando datos de la nacionalidad"

'OpenRecordset StrSql, rsConsult

Nacionalidad = ""

'If rsConsult.EOF Then
'    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
'Else
'    nacionalidad = rsConsult!nacionaldes
'End If

'rsConsult.Close

' -------------------------------------------------------------------------
' Busco la fecha de baja y la causa de egreso
'--------------------------------------------------------------------------

'causaEgreso = ""
'fecbaja = ""

'---LOG---
'Flog.writeline "Buscando datos de la causa de egreso"

' StrSql = " SELECT altfec, bajfec, caudes, estado, empatareas "
' StrSql = StrSql & " FROM fases "
' StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro=empant.empantnro "
' StrSql = StrSql & " LEFT JOIN causa ON fases.caunro=causa.caunro "
' StrSql = StrSql & " WHERE fases.empleado=" & ternro & " order by altfec DESC"

' OpenRecordset StrSql, rsConsult

' If rsConsult.EOF Then
'     Flog.writeline "No se encontró la causa de egreso"
 '    Exit Sub
' Else
'    If Not CBool(rsConsult!estado) Then
'       fecbaja = rsConsult!bajfec
'       causaEgreso = rsConsult!caudes
'    End If
' End If
 
' rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Or (pliqfecdep = "") Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxchar1,auxchar2,auxchar3,auxchar4, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & causaEgreso & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & controlNull(emprActiv)
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
   
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline "Ultima sql ejecutada: " & StrSql
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Litoral Gas
'--------------------------------------------------------------------
'03/07/2006 - Martin Ferraro - Se agrego en el campo auxdeci1=0 al insertar en
'rep_libroley para identificar a los empleados de agencia

Sub generarDatosEmpleado20(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnrof
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecalta1 As String
Dim fecbaja As String
Dim califprof As String
Dim Categoria As String
Dim actividad As String
Dim Direccion As String
Dim lugarpago As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim ObraSocial As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim pliqnro
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim Nacionalidad
Dim Cali_prof As String
Dim Sexo
Dim TareaDes
Dim EmpTernro
Dim formaliquidacion
Dim Sector
Dim tipo_conc

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim hijo As Long
Dim conyuge As Long
Dim codigoZona As String


Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 20"

Flog.writeline "Buscando config de familiares en el confrep"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 61 "
StrSql = StrSql & " AND confnrocol = 66 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    hijo = rsConsult!confval
Else
    Flog.writeline "No se encuentra configurado el hijo en el confrep 61."
    hijo = 0
End If
rsConsult.Close


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 61 "
StrSql = StrSql & " AND confnrocol = 67 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    conyuge = rsConsult!confval
Else
    Flog.writeline "No se encuentra configurado el conyuge en el confrep 61."
    conyuge = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr actividad, estr2.estrdabr califprof, estr3.estrdabr lugarpago, estr4.estrdabr obrasocial, estr5.estrdabr tareades,estr6.estrdabr categoria "
 sql = sql & " FROM empleado "
 'Busco la Actividad
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 29 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco Calificacion Profecional
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 52 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el Lugar de Pago
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 20 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el Obra Social
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 17 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco Tarea Desempeñada
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 48 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
  'Busco Categoria
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 3 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult


 'COD-NRO.JUB.
 If IsNull(rsConsult!califprof) Then
   califprof = ""
   Flog.writeline "No encontró califprof"
 Else
   califprof = rsConsult!califprof
   Flog.writeline ""
 End If
  'Actividad
 If IsNull(rsConsult!actividad) Then
   actividad = ""
   Flog.writeline "No encontró actividad"
 Else
   actividad = rsConsult!actividad
 End If
 'Lugar de Pago
 If IsNull(rsConsult!lugarpago) Then
   lugarpago = ""
   Flog.writeline "No encontróLugar de Pago"
 Else
   lugarpago = rsConsult!lugarpago
 End If
 'Tarea_Des
 If IsNull(rsConsult!TareaDes) Then
   TareaDes = ""
   Flog.writeline "No encontró TareaDes"
 Else
   TareaDes = rsConsult!TareaDes
 End If
  'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
  'Obra Social
 If IsNull(rsConsult!ObraSocial) Then
   ObraSocial = ""
 Else
   ObraSocial = rsConsult!ObraSocial
 End If
  
 
  
 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de Alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecalta = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de alta F.ANT1
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado=" & Ternro
StrSql = StrSql & " AND altfec <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ORDER BY altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    fecalta1 = ""
Else
    If Not IsNull(rsConsult!altfec) Then
        fecalta1 = rsConsult!altfec
    Else
        fecalta1 = ""
    End If
End If

If rsConsult.State = adStateOpen Then rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc nrocuil, docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = ""

If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!nrocuil) Then
        cuil = rsConsult!nrocuil
    End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la zona de la sucursal
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la zona de la sucursal del empleado"

StrSql = " SELECT zona.zonacod "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN zona ON zona.zonanro = detdom.zonanro"
OpenRecordset StrSql, rsConsult
                
codigoZona = ""
If Not rsConsult.EOF Then
    codigoZona = rsConsult!zonacod
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------
Direccion = ""
Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.codigopostal"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        If Not rsConsult.EOF Then
            If IsNull(rsConsult!codigopostal) Then
               Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "  "
            Else
               Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!codigopostal
            End If
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.codigopostal From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
            If IsNull(rsConsult!codigopostal) Then
               Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "  "
            Else
               Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!codigopostal
            End If
        End If
        
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provcodext "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           If IsNull(rsConsult!provcodext) Then
              If IsNull(rsConsult!codigopostal) Then
                 Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "  "
              Else
                 Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!codigopostal
              End If
           Else
              If IsNull(rsConsult!codigopostal) Then
                 Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & " "
              Else
                 Direccion = rsConsult!calle & " " & rsConsult!nro & "@" & rsConsult!locdesc & "@" & rsConsult!codigopostal
              End If
           End If
           
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Forma de Liquidación
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Forma de Liquidación"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=22 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

formaliquidacion = ""

If Not rsConsult.EOF Then
   formaliquidacion = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1, estrdabr2, estrdabr3, tedabr1, tedabr2, tedabr3, orden, auxchar4, auxchar5, auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & codigoZona & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & lugarpago & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & califprof & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & ",'" & actividad & "'"
StrSql = StrSql & ",'" & TareaDes & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & lugarpago & "'"
StrSql = StrSql & ",0)"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
  'Para el orde en que se muestran en el asp
  Select Case arrTipoConc(rsConsult!tconnro)
    Case 1
        tipo_conc = "1"
    Case 2
        tipo_conc = "3"
    Case 3
        tipo_conc = "2"
    Case Else
        tipo_conc = ""
  End Select
  
  
  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & tipo_conc & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc, familiar.parenro, tercero.terfecestciv, tercero.terfecnac " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          'La fecha de alta del fam va de acuerdo a si es hijo o conyuge
          Select Case rsConsult!parenro
            Case hijo
                'Poner fecha de nacimiento
                If IsNull(rsConsult!terfecnac) Then
                   famDGIdesde = "NULL"
                Else
                   famDGIdesde = ConvFecha(rsConsult!terfecnac)
                End If
            Case conyuge
                'Poner fecha de estado civil
                If IsNull(rsConsult!terfecestciv) Then
                   famDGIdesde = "NULL"
                Else
                   famDGIdesde = ConvFecha(rsConsult!terfecestciv)
                End If
            Case Else
                famDGIdesde = "NULL"
          End Select
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    'Resume Next
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Darmex
'--------------------------------------------------------------------
Sub generarDatosEmpleado21(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long

Dim CentroCosto
Dim EmpTernro
Dim ObraSocial

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 21 - Darmex"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If
 
'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1, auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para CODERE
'--------------------------------------------------------------------
Sub generarDatosEmpleado22(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim Nacionalidad

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 22"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes " & _
    " FROM tercero " & _
    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close
 

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Hileret
'--------------------------------------------------------------------
Sub generarDatosEmpleado23(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cont As Long

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim Nacionalidad
Dim causaEgreso
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 23"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
' If IsNull(rsConsult!empfecbaja) Then
'    fecbaja = ""
' Else
'    fecbaja = rsConsult!empfecbaja
' End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la direccion del empleado"

OpenRecordset StrSql, rsConsult

Direccion = " "

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!piso & " " & rsConsult!oficdepto & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del documento"

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = IIf(EsNulo(rsConsult!estcivdesabr), "", rsConsult!estcivdesabr)
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

If IsNull(Sueldo) Then
   Sueldo = bruto
End If

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes " & _
    " FROM tercero " & _
    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la fecha de baja y la causa de egreso
'--------------------------------------------------------------------------

causaEgreso = ""
fecbaja = ""

'---LOG---
Flog.writeline "Buscando datos de la causa de egreso"

 StrSql = " SELECT altfec, bajfec, caudes, estado, empatareas "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro=empant.empantnro "
 StrSql = StrSql & " LEFT JOIN causa ON fases.caunro=causa.caunro "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
     Flog.writeline "No se encontró la causa de egreso"
 '    Exit Sub
 Else
    If Not CBool(rsConsult!estado) Then
       fecbaja = rsConsult!bajfec
       causaEgreso = rsConsult!caudes
    End If
 End If
 
 rsConsult.Close

'------------------------------------------------------------------
'Busco la direccion de la empresa
'------------------------------------------------------------------
 
 'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    emprDire = "   "
Else
    emprDire = rsConsult!calle & " " & rsConsult!nro & "<br>" & rsConsult!codigopostal & " " & rsConsult!barrio & " - " & rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Or (pliqfecdep = "") Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxchar1,auxchar2,auxchar3,auxchar4, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & causaEgreso & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & controlNull(emprActiv)
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo1

    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
        
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              'StrSql = StrSql & ",'1')"
              StrSql = StrSql & ",'3')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 2
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo2
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              'StrSql = StrSql & ",'2')"
              StrSql = StrSql & ",'1')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next


'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 3
'---------------------------------------------------------------------------

For cont = 1 To cantAcumGrupo3
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_libroley_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_libroley_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
              StrSql = StrSql & " dlimonto, conctipo) "
              StrSql = StrSql & " VALUES "
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & acumGrupo1(cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              'StrSql = StrSql & ",'3')"
              StrSql = StrSql & ",'2')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
   
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Apex
'--------------------------------------------------------------------
Sub generarDatosEmpleado24(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim reg_horario As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long

Dim CentroCosto
Dim Nacionalidad As String
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 24"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " , estr6.estrdabr AS reghorario "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el Regimen Horario
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 21 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 'Reg. Horario
 If IsNull(rsConsult!reghorario) Then
   reg_horario = ""
 Else
   reg_horario = rsConsult!reghorario
 End If
 
 
 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
''------------------------------------------------------------------
''Busco el valor del centro de costo - Se reemplazo por la nacionalidad
''------------------------------------------------------------------
'
''---LOG---
'Flog.writeline "Buscando datos del centro de costo"
'
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
'
'OpenRecordset StrSql, rsConsult
'
'centroCosto = ""
'
'If Not rsConsult.EOF Then
'   centroCosto = rsConsult!estrdabr
'Else
''   Flog.writeline "Error al obtener los datos del centro de costo"
''   GoTo MError
'End If
'
'rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Nacionalidad
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro

StrSql = " SELECT nacionaldes "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " INNER JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " Where Tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If Not rsConsult.EOF Then
    Nacionalidad = rsConsult!nacionaldes
Else
    Nacionalidad = ""
'   Flog.writeline "Error al obtener los datos de la nacionalidad"
'   GoTo MError
End If

rsConsult.Close
   
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

'        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
'        sql = sql & " FROM  cabdom "
'        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
'        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & ternro
'
'        '---LOG---
'        Flog.writeline "Buscando datos de la direccion del empleado"
'
'        OpenRecordset sql, rsConsult
'
'        If Not rsConsult.EOF Then
'           direccion = rsConsult!calle & " " & rsConsult!Nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
'        End If
        
        sql = "SELECT his_estructura.estrnro, estructura.estrdabr "
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN estructura ON his_estructura.estrnro = estructura.estrnro"
        sql = sql & " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND "
        sql = sql & " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)"
        sql = sql & " AND his_estructura.ternro = " & Ternro
        sql = sql & " AND his_estructura.tenro  = 12" '<----- nro localizacion

        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado por estructura"
        
        OpenRecordset sql, rsConsult
        If Not rsConsult.EOF Then
           Direccion = rsConsult!estrdabr
        End If

        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco la direccion de la empresa solicitada por el cliente.
'------------------------------------------------------------------
StrSql = " SELECT estrdabr FROM estructura WHERE estrnro = 429 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    emprDire = rsConsult!estrdabr
Else
    'Mantengo la actual
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1, auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Nacionalidad & "'" 'ex centroCosto
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & Left(reg_horario, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'.........
Sub generarDatosEmpleado25(Pronro, Ternro, descripcion, orden)
' ---------------------------------------------------------------------------------------------
' Se encarga de generar los datos para Mercado Central
' Descripcion: modelo 25.
' Autor      : Lisandro Moro
' Fecha      :
' ---------------------------------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim empfbajaprev
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 25"
'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfbajaprev "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empfbajaprev = rsConsult!empfbajaprev
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & empfbajaprev & "'"
StrSql = StrSql & ")"
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Insertando ... " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontraron datos del detalle de liquidacion. SQL: " & StrSql
End If
Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  objConn.Execute StrSql, , adExecuteNoRecords
  
  If arrTipoConc(rsConsult!tconnro) = 0 Then
    Flog.writeline ""
    Flog.writeline "    Concepto " & rsConsult!ConcCod & " tipo " & rsConsult!tconnro & " no configurado en Libro ley"
    Flog.writeline ""
  End If
  Flog.writeline "insertando... concepto: " & rsConsult!ConcCod & "(" & rsConsult!tconnro & ") monto: " & rsConsult!dlimonto & " [" & StrSql & "]"

  rsConsult.MoveNext
Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline "SQl: " & StrSql
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Gedas
'--------------------------------------------------------------------
Sub generarDatosEmpleado26(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cont As Long

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro As Integer
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado As Integer
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim Sexo
Dim Sueldo
Dim Nacionalidad
Dim causaEgreso
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 26"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
'---LOG---
Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = rsConsult!empremu
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro
 
'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
' If IsNull(rsConsult!empfecbaja) Then
'    fecbaja = ""
' Else
'    fecbaja = rsConsult!empfecbaja
' End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la direccion del empleado"

OpenRecordset StrSql, rsConsult

Direccion = " "

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!piso & " " & rsConsult!oficdepto & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del documento"

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

If IsNull(Sueldo) Then
   Sueldo = bruto
End If

' -------------------------------------------------------------------------
' Busco la nacionalidad
'--------------------------------------------------------------------------

StrSql = "SELECT nacionaldes " & _
    " FROM tercero " & _
    " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro AND tercero.ternro = " & Ternro

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If rsConsult.EOF Then
    Flog.writeline "No se encontró la nacionalidad"
'    Exit Sub
Else
    Nacionalidad = rsConsult!nacionaldes
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la fecha de baja y la causa de egreso
'--------------------------------------------------------------------------

causaEgreso = ""
fecbaja = ""

'---LOG---
Flog.writeline "Buscando datos de la causa de egreso"

 StrSql = " SELECT altfec, bajfec, caudes, estado, empatareas "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro=empant.empantnro "
 StrSql = StrSql & " LEFT JOIN causa ON fases.caunro=causa.caunro "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
     Flog.writeline "No se encontró la causa de egreso"
 '    Exit Sub
 Else
    If Not CBool(rsConsult!estado) Then
       fecbaja = rsConsult!bajfec
       causaEgreso = rsConsult!caudes
    End If
 End If
 
 rsConsult.Close

'------------------------------------------------------------------
'Busco la direccion de la empresa
'------------------------------------------------------------------
 
 'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & emprTer & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    emprDire = "   "
Else
    emprDire = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!codigopostal & " " & rsConsult!barrio & " - " & rsConsult!locdesc
    CodPostal = rsConsult!codigopostal
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Or (pliqfecdep = "") Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr,auxchar1,auxchar2,auxchar3,auxchar4, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & CodPostal & "'"
StrSql = StrSql & ",'" & causaEgreso & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & controlNull(emprActiv)
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close



'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
   
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'-----------------------------------------------------------------------
' Modelo 27 - Libro Ley de A.G.D
'-----------------------------------------------------------------------

Sub generarDatosEmpleado27(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim reg_horario As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim tipodocumento As String
Dim Localidad As String
Dim CentroCosto
Dim Nacionalidad As String
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 27"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " , estr6.estrdabr AS reghorario "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el Regimen Horario
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 21 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 'Reg. Horario
 If IsNull(rsConsult!reghorario) Then
   reg_horario = ""
 Else
   reg_horario = rsConsult!reghorario
 End If
 
 
 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
''------------------------------------------------------------------
''Busco el valor del centro de costo - Se reemplazo por la nacionalidad
''------------------------------------------------------------------
'
''---LOG---
'Flog.writeline "Buscando datos del centro de costo"
'
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro
'
'OpenRecordset StrSql, rsConsult
'
'centroCosto = ""
'
'If Not rsConsult.EOF Then
'   centroCosto = rsConsult!estrdabr
'Else
''   Flog.writeline "Error al obtener los datos del centro de costo"
''   GoTo MError
'End If
'
'rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Nacionalidad
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la nacionalidad"

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & ternro

StrSql = " SELECT nacionaldes "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " INNER JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " Where Tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Nacionalidad = ""

If Not rsConsult.EOF Then
    Nacionalidad = rsConsult!nacionaldes
Else
    Nacionalidad = ""
'   Flog.writeline "Error al obtener los datos de la nacionalidad"
'   GoTo MError
End If

rsConsult.Close
   
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
'   Cuil = rsConsult!nrocuil
   If Not IsNull(rsConsult!sigladoc) Then
        tipodocumento = rsConsult!sigladoc
   End If
   
   If Not IsNull(rsConsult!NroDoc) Then
        documento = rsConsult!NroDoc
   End If
   
   If Not IsNull(rsConsult!terfecnac) Then
           fecha_nac = rsConsult!terfecnac
   End If
   
   If Not IsNull(rsConsult!estcivdesabr) Then
              est_civil = rsConsult!estcivdesabr
   End If
   
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.codigopostal From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " " & rsConsult!piso & " " & rsConsult!oficdepto
           Localidad = rsConsult!codigopostal & " " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    

'--------------------------------
'Busco la direccion de la empresa
'--------------------------------

        emprDire = ""
    
        'Direccion de la empresa
        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.codigopostal From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "----------------------------------------------"
        Flog.writeline "Buscando datos de la direccion de la empresa"
        Flog.writeline "----------------------------------------------"
        OpenRecordset sql, rsConsult
        Direccion = ""
        
        If Not rsConsult.EOF Then
           emprDire = rsConsult!calle & " " & rsConsult!nro
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
        
'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Asigno las variables especificas del libro ley A.G.D
'------------------------------------------------------------------
Dim Auxchar4
Dim Auxchar5
Auxchar4 = Localidad
Auxchar5 = tipodocumento

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1, auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(emprDire, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & Localidad & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Nacionalidad & "'" 'ex centroCosto
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & Auxchar5 & "')"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para REDEPA
'--------------------------------------------------------------------
Sub generarDatosEmpleado28(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3


Dim NivelEst
Dim Grado

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 28"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado."


OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Flog.writeline "   Datos Obtenidos"
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo para el empleado"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo   no lo uso
'------------------------------------------------------------------
CentroCosto = ""
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
   Flog.writeline "   Datos Obtenidos"
Else
    Flog.writeline "   NO se encontraron los datos de los documentos"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
   Flog.writeline "   No Encotrado"
Else
   basico = rsConsult!almonto
   Flog.writeline "   Dato Obtenido"
End If

rsConsult.Close


'Neto
   neto = 0

'MSR
   msr = 0

'Asig. Familia
   asi_flia = 0


'Descuentos
   dtos = 0


'Bruto
   bruto = 0

'------------------------------------------------------------------
'Busco el valor de la direccion. No lo usa
'------------------------------------------------------------------

Direccion = ""

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "   Datos de las cargas sociales obtenidos"
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

Flog.writeline "Insertando en libro ley"

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords
Flog.writeline "Inserto el registro: " & StrSql

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
    
      StrSql = " INSERT INTO rep_libroley_det "
      StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
      StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
      StrSql = StrSql & " dlimonto,conctipo) "
      StrSql = StrSql & " VALUES "
      StrSql = StrSql & "(" & NroProceso
      StrSql = StrSql & "," & Ternro
      StrSql = StrSql & "," & Pronro
      StrSql = StrSql & ",'" & rsConsult!concabr & "'"
      StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
      StrSql = StrSql & "," & rsConsult!ConcNro
      StrSql = StrSql & "," & rsConsult!concimp
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
      StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
      StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
      StrSql = StrSql & ")"
      
      objConn.Execute StrSql, , adExecuteNoRecords
    
      rsConsult.MoveNext
      
    Loop
    Flog.writeline "GRABO datos del detalle de liquidacion"
Else
    Flog.writeline "El empleado no tiene conceptos liquidados"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta,  " & _
          " paredesc, estactgra grado, nivest.nivdesc nivel " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " LEFT JOIN estudio_actual on estudio_actual.ternro =familiar.ternro " & _
          " LEFT JOIN nivest on nivest.nivnro =estudio_actual.nivnro" & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro & " AND familiar.famsalario=-1 " 'Paga salario

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          If IsNull(rsConsult!Grado) Then
             Grado = 0
          Else
             Grado = rsConsult!Grado
          End If
          If IsNull(rsConsult!Nivel) Then
             NivelEst = ""
          Else
             NivelEst = Left(rsConsult!Nivel, 4) 'Cantidad de caracteres que muestra
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & NivelEst & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & Grado
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
     Flog.writeline ""
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Papelbril
'--------------------------------------------------------------------
Sub generarDatosEmpleado29(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 29"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Horwath
'--------------------------------------------------------------------
Sub generarDatosEmpleado30(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim noremunerativo
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim fecaltrec As Date
Dim l_fecalta As Date
Dim l_fecbaja As Date

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 30"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Acumulador no remunerativo
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & cod_acum_noremunerativo
sql = sql & " AND cliqnro =  " & cliqnro

'---LOG---
Flog.writeline "Buscando datos del acumulador no remunerativo"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   noremunerativo = 0
Else
   noremunerativo = rsConsult!almonto
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & AntiguedadReconocida & "'" 'ex centroCosto, no utilizado en el asp
StrSql = StrSql & ",0,"
StrSql = StrSql & noremunerativo & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Duke
'--------------------------------------------------------------------
Sub generarDatosEmpleado31(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim noremunerativo
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 31"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Acumulador no remunerativo
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & cod_acum_noremunerativo
sql = sql & " AND cliqnro =  " & cliqnro

'---LOG---
Flog.writeline "Buscando datos del acumulador no remunerativo"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   noremunerativo = CDbl(0)
Else
   noremunerativo = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0," & noremunerativo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub
'--------------------------------------------------------------------
' Libro Ley Andreani.- Gustavo Ring
'--------------------------------------------------------------------

Sub generarDatosEmpleado32(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim rsConsult3 As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim emprProvDesc
Dim CentroCosto
Dim EmpTernro
Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim Sexo
Dim Nacionalidad
Dim nacimiento
Dim direccionemp
Dim alta
Dim sql As String
Dim Sector
Dim cc
Dim dpto
Dim estadocivil
Dim tipo_conc

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 32. Centro de Costo Andreani"

'-------------------------------------------------------------------------------------------------
' Busco la provincia de la empresa
'-------------------------------------------------------------------------------------------------

Flog.writeline "Búsqueda de datos de la provincia de la empresa "

StrSql = " SELECT  provdesc FROM provincia"
StrSql = StrSql & " WHERE provnro = " & emprProv

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   emprProvDesc = rsConsult!provdesc
Else
   Flog.writeline "Error al obtener los datos de la provincia de la empresa "
'   GoTo MError
End If

rsConsult.Close

'--------------------------------------------------------------------------------------------------
'Busco los datos del empleado.- Apellido y Nombre, Domicilio, Nacionalidad, Sexo, Fecha Nac
'Sigla y documento, Fecha de ingreso.
'--------------------------------------------------------------------------------------------------

StrSql = " SELECT empleg,tercero.terape,tercero.terape2,tercero.ternom,tercero.ternom2,empfaltagr,empremu,tidsigla,nrodoc,nacionaldes "
StrSql = StrSql & ",calle,nro,piso,oficdepto,torre,manzana,locdesc, tersex,terfecnac,estcivdesabr, empest "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro"
StrSql = StrSql & " INNER JOIN nacionalidad ON nacionalidad.nacionalnro = tercero.nacionalnro"
StrSql = StrSql & " LEFT  JOIN ter_doc ON tercero.ternro = ter_doc.ternro "
StrSql = StrSql & " INNER  JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro and tipodocu.tidnro <= 5 "
StrSql = StrSql & " LEFT  JOIN cabdom ON cabdom.ternro = tercero.ternro "
StrSql = StrSql & " LEFT  JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & Ternro
StrSql = StrSql & " LEFT  JOIN localidad ON detdom.locnro = localidad.locnro "
StrSql = StrSql & " LEFT  JOIN estcivil  ON estcivil.estcivnro = tercero.estcivnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro '& " AND agencia is null "
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC "

Flog.writeline "Comienzo de Búsqueda de datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   
   documento = ""
   
   If Not (IsNull(rsConsult!tidsigla)) Then
        documento = rsConsult!tidsigla '& " " & rsConsult!nrodoc
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene la sigla del documento"
   End If
   If Not (IsNull(rsConsult!NroDoc)) Then
       documento = documento & " " & rsConsult!NroDoc
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene el nro del documento"
   End If
   
   Flog.writeline "Se obtuvo con exito los datos del empleado:" & Legajo & " - " & Apellido
    
   direccionemp = ""
    
   If Not (IsNull(rsConsult!calle)) Then
        direccionemp = rsConsult!calle
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene la calle del domicilio "
   End If
   If Not (IsNull(rsConsult!nro)) Then
       direccionemp = direccionemp & " " & rsConsult!nro
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene nro del domicilio "
   End If
   If Not (IsNull(rsConsult!piso)) Then
        direccionemp = direccionemp & " " & rsConsult!piso
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene el piso del domicilio "
   End If
   If Not (IsNull(rsConsult!torre)) Then
       direccionemp = direccionemp & " " & rsConsult!torre
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene la torre del domicilio "
   End If
   If Not (IsNull(rsConsult!locdesc)) Then
       direccionemp = direccionemp & "," & rsConsult!locdesc
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " el domicilio no tiene asociada localidad "
   End If

   If rsConsult!tersex = -1 Then
        Sexo = "MASC"
   Else
        Sexo = "FEM"
   End If
   If Not (IsNull(rsConsult!empfaltagr)) Then
        alta = rsConsult!empfaltagr
   Else
        alta = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene fecha de alta "
   End If
   If Not (IsNull(rsConsult!terfecnac)) Then
        terfecnac = rsConsult!terfecnac
   Else
        terfecnac = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene fecha de nacimiento "
   End If
   If Not (IsNull(rsConsult!estcivdesabr)) Then
        estadocivil = rsConsult!estcivdesabr
   Else
        estadocivil = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene estadocivil "
   End If
   If Not (IsNull(rsConsult!nacionaldes)) Then
        Nacionalidad = rsConsult!nacionaldes
   Else
        Nacionalidad = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene nacionalidad "
   End If

   If Not (IsNull(rsConsult!empest)) Then
        estado = rsConsult!empest
   Else
        estado = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene estado "
   End If
   
    'Fecha Alta
    If IsNull(rsConsult!empfaltagr) Then
       fecalta = ""
       Flog.writeline "El empleado:" & Legajo & " - " & Apellido & " no tiene fecha alta "
    Else
       fecalta = rsConsult!empfaltagr
    End If
 
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

 
'--------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco código externo de depto
'------------------------------------------------------------------

Flog.writeline "Buscando datos del depto "

StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=9 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

dpto = ""

If Not rsConsult.EOF Then
   dpto = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del departamento "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco código externo del sector
'------------------------------------------------------------------

Flog.writeline "Buscando datos del sector "

StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del sector "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco código externo del CC
'------------------------------------------------------------------

Flog.writeline "Buscando datos del CC "

StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

cc = ""

If Not rsConsult.EOF Then
   cc = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del cc "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco código interno de la estructura categoria
'------------------------------------------------------------------

Flog.writeline "Buscando datos de la categoria "

StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=3 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""

If Not rsConsult.EOF Then
   Categoria = rsConsult!Estrnro
Else
   Flog.writeline "Error al obtener los datos de la categoria "
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, "
StrSql = StrSql & " fecalta , fecbaja, "
StrSql = StrSql & " direccion , fecha_nac,"
StrSql = StrSql & " est_civil ,documento , descripcion, cuil,"
StrSql = StrSql & " pliqbco , puesto, categoria, neto,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5,ultima_pag_impr, pliqdesc "
StrSql = StrSql & " , prodesc, auxdeci1, pliqmes, pliqanio, estado "
StrSql = StrSql & " ,basico , msr, asi_flia, dtos, bruto "
StrSql = StrSql & " ) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & Mid(direccionemp, 1, 50) & "'"
StrSql = StrSql & ",'" & terfecnac & "'"
StrSql = StrSql & ",'" & estadocivil & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & dpto & "'" 'cuil
StrSql = StrSql & ",'" & Sector & "'" 'pliqbco
StrSql = StrSql & ",'" & cc & "'" 'puesto
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & ",'" & Sexo & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprProvDesc & "'"
StrSql = StrSql & ", " & Pagina
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ", 0 "
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & estado
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
'StrSql = StrSql & ",'" & dpto & "'" 'campo puesto
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

'Para el orde en que se muestran en el asp

Do Until rsConsult.EOF
    Select Case arrTipoConc(rsConsult!tconnro)
        Case 1
            tipo_conc = "1"
        Case 2
            tipo_conc = "3"
        Case 3
            tipo_conc = "2"
        Case Else
            tipo_conc = ""
    End Select

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & tipo_conc & "'"
  StrSql = StrSql & ")"

  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext

Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------
'Dim cont As Long
'For cont = 1 To cantAcumGrupo1
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'1')"
'              StrSql = StrSql & ",'3')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next
'
''---------------------------------------------------------------------------
''Obtengo los datos del los conceptos del empleado, de la columna 2
''---------------------------------------------------------------------------
'
'For cont = 1 To cantAcumGrupo2
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'2')"
'              StrSql = StrSql & ",'1')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next
'
'
''---------------------------------------------------------------------------
''Obtengo los datos del los conceptos del empleado, de la columna 3
''---------------------------------------------------------------------------
'
'For cont = 1 To cantAcumGrupo3
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'3')"
'              StrSql = StrSql & ",'2')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next






'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub




'--------------------------------------------------------------------
' Libro Ley Alta Plástica.- Gustavo Ring
'--------------------------------------------------------------------

Sub generarDatosEmpleado33(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim rsConsult3 As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final
Dim Legajo As Long
Dim Sector As String
Dim Puesto As String
Dim ingresoegreso As String
Dim Categoria As String
Dim remuneracion As String
Dim sucursal As String
Dim contrato As String
Dim cajadejubilacion As String
Dim formaliquidacion As String
Dim nacimiento As String
Dim estadocivil As String
Dim domicilio As String
Dim provincia As String
Dim cuil As String
Dim documento As String
Dim terfecnac As String


Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim msr As String
Dim neto As Double
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim sql As String
Dim tipo_conc
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String

On Error GoTo MError

Flog.writeline "Modelo 33. Centro de Costo Alta Plástica"

'--------------------------------------------------------------------------------------------------
'Busco los datos básicos del empleado
'--------------------------------------------------------------------------------------------------

StrSql = " SELECT empleg,tercero.terape,tercero.terape2,tercero.ternom,tercero.ternom2, "
StrSql = StrSql & "docutipo.tidsigla as sigladocumento,documento.nrodoc as nrodocumento, "
StrSql = StrSql & "cuiltipo.tidsigla as siglacuil,cuil.nrodoc as nrocuil, provdesc "
StrSql = StrSql & ",calle,nro,piso,oficdepto,torre,manzana, terfecnac,estcivdesabr "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro"
StrSql = StrSql & " INNER  JOIN ter_doc documento ON tercero.ternro = documento.ternro "
StrSql = StrSql & " INNER  JOIN tipodocu docutipo ON documento.tidnro = docutipo.tidnro AND docutipo.tidnro<=5 "
StrSql = StrSql & " INNER  JOIN ter_doc cuil ON cuil.ternro = tercero.ternro "
StrSql = StrSql & " INNER  JOIN tipodocu cuiltipo ON cuil.tidnro = cuiltipo.tidnro AND cuiltipo.tidnro = 10 "
StrSql = StrSql & " INNER  JOIN cabdom ON cabdom.ternro = tercero.ternro "
StrSql = StrSql & " INNER  JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & Ternro
StrSql = StrSql & " INNER  JOIN localidad ON detdom.locnro = localidad.locnro "
StrSql = StrSql & " INNER  JOIN provincia ON provincia.provnro = localidad.provnro "
StrSql = StrSql & " INNER  JOIN estcivil  ON estcivil.estcivnro = tercero.estcivnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

Flog.writeline "Comienzo de búsqueda de datos basicos del empleado" & Ternro
Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   
   ' Calculo el legajo del empleado

   Legajo = rsConsult!empleg
   
   ' Calculo el nombre del empleado
   
    Apellido = rsConsult!terape
    If Not (IsNull(rsConsult!terape2)) Then
         apellido2 = rsConsult!terape2
    End If
    Nombre = rsConsult!ternom
    If Not (IsNull(rsConsult!ternom2)) Then
        nombre2 = rsConsult!ternom2
    End If
    
   ' Calculo la fecha de nacimiento
   
   If Not (IsNull(rsConsult!terfecnac)) Then
        nacimiento = rsConsult!terfecnac
   Else
        nacimiento = ""
        Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene fecha de nacimiento "
   End If

   ' Calculo el estado civil del empleado
   
   If Not (IsNull(rsConsult!estcivdesabr)) Then
       estadocivil = rsConsult!estcivdesabr
   Else
       estadocivil = ""
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene estado civil "
   End If
   
   'Calculo la dirección del empleado
    
   domicilio = ""
    
   If Not (IsNull(rsConsult!calle)) Then
        domicilio = rsConsult!calle
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene la calle del domicilio "
   End If
   
   If Not (IsNull(rsConsult!nro)) Then
       domicilio = domicilio & " " & rsConsult!nro
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene nro del domicilio "
   End If
   
   If Not (IsNull(rsConsult!piso)) Then
        domicilio = domicilio & " " & rsConsult!piso
   End If
   
   If Not (IsNull(rsConsult!torre)) Then
       domicilio = domicilio & " " & rsConsult!torre
   End If
      
   ' Calculo la provincia del empleado
   
   If Not (IsNull(rsConsult!provdesc)) Then
       provincia = rsConsult!provdesc
   Else
       provincia = " "
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene provincia "
   End If
      
   ' Calculo el cuil del empleado
   
   cuil = ""
   
   If Not (IsNull(rsConsult!siglacuil)) Then
        cuil = rsConsult!siglacuil
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene la sigla del cuil"
   End If
   
   If Not (IsNull(rsConsult!nrocuil)) Then
       cuil = cuil & " " & rsConsult!nrocuil
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene el nro del cuil"
   End If
    
   ' Calculo el documento del empleado
   
   documento = ""
   
   If Not (IsNull(rsConsult!sigladocumento)) Then
        documento = rsConsult!sigladocumento
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene la sigla del documento"
   End If
   
   If Not (IsNull(rsConsult!nrodocumento)) Then
       documento = documento & " " & rsConsult!nrodocumento
   Else
       Flog.writeline "El empleado:" & Legajo & " - " & Nombre & " no tiene el nro del documento"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado básico del empleado " & Legajo
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
  ' fecpago = rsConsult!profecpago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado " & Legajo & " no se encuentra en el proceso"
   Exit Sub
End If

'------------------------------------------------------------------
' Busco la descripción del sector (sección)
'------------------------------------------------------------------

Flog.writeline "Buscando datos del sector "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector del empleado " & Legajo
End If


'------------------------------------------------------------------
' Busco la descripción del puesto (calificación profesional)
'------------------------------------------------------------------

Flog.writeline "Buscando datos del puesto "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=4 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto del empleado " & Legajo
End If

'------------------------------------------------------------------
' Busco la descripción de la categoria
'------------------------------------------------------------------

Flog.writeline "Buscando datos del categoria "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=3 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

Categoria = ""

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria del empleado " & Legajo
End If

'------------------------------------------------------------------
' Busco la descripción de la sucursal (lugar de trabajo)
'------------------------------------------------------------------

Flog.writeline "Buscando datos de la sucursal "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=1 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

sucursal = ""

If Not rsConsult.EOF Then
   sucursal = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la sucursal del empleado " & Legajo
End If

'------------------------------------------------------------------
' Busco la descripción de la caja de jubilacion (Reg. Previsional)
'------------------------------------------------------------------

Flog.writeline "Buscando datos de la caja "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=15 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

cajadejubilacion = ""

If Not rsConsult.EOF Then
   cajadejubilacion = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la cajadejubilacion del empleado " & Legajo
End If

'------------------------------------------------------------------
' Busco la descripción de la forma de liquidación (mensual/jornal)
'------------------------------------------------------------------

Flog.writeline "Buscando datos de la forma de liquidación "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=22 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

formaliquidacion = ""

If Not rsConsult.EOF Then
   formaliquidacion = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la forma de liquidación del empleado " & Legajo
End If

'------------------------------------------------------------------
' Busco la descripción del contrato
'------------------------------------------------------------------

Flog.writeline "Buscando datos del contrato "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ) AND his_estructura.tenro=18 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

contrato = ""

If Not rsConsult.EOF Then
   contrato = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del contrato del empleado " & Legajo
End If


'-------------------------------------------------------------------------------------------
' Busco la fecha de Ingreso/Egreso
'-------------------------------------------------------------------------------------------

Flog.writeline "Buscando datos de Ingreso/Egreso "

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE fases.empleado=" & Ternro
 StrSql = StrSql & " AND altfec <= " & ConvFecha(pliqhasta) & " order by altfec DESC"
 
 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      ingresoegreso = ""
      Flog.writeline "No encontró fase anterior al periodo de liquidación"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       ingresoegreso = rsConsult!altfec & " - " & rsConsult!bajfec
    Else
       ingresoegreso = rsConsult!altfec
    End If
 End If

'------------------------------------------------------------------
'Busco los datos de la remuneracion
'------------------------------------------------------------------

'remuneracion
If es_Acum_Remu Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Remu
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Remu
End If

Flog.writeline "Buscando datos de la remuneración "

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   remuneracion = 0
Else
   remuneracion = rsConsult!almonto
End If

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Neto
If es_Acum_Remu Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------

StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, "
StrSql = StrSql & " direccion , fecha_nac,"
StrSql = StrSql & " est_civil ,documento, descripcion, cuil,"
StrSql = StrSql & " tipofam,puesto, categoria,lug_trab,reg_prev, estrdabr1 , neto, bruto,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5,ultima_pag_impr, pliqdesc "
StrSql = StrSql & " ,prodesc, auxdeci1, pliqmes, pliqanio, estado "
StrSql = StrSql & " ,basico , msr, asi_flia, dtos "
StrSql = StrSql & " ) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & Mid(domicilio, 1, 50) & "'"
StrSql = StrSql & ",'" & nacimiento & "'"
StrSql = StrSql & ",'" & estadocivil & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & " " & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & ",'" & tipoFamiliares & "'"
StrSql = StrSql & ",'" & Puesto & "'" 'puesto
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & sucursal & "'"
StrSql = StrSql & ",'" & cajadejubilacion & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(remuneracion)
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & formaliquidacion & "'"
StrSql = StrSql & ",'" & ingresoegreso & "'"
StrSql = StrSql & ",'" & provincia & "'"
StrSql = StrSql & ",'" & domicilio & "'"
StrSql = StrSql & ", " & Pagina
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ", 0 "
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",-1"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
StrSql = StrSql & ", 0"
'StrSql = StrSql & ",'" & dpto & "'" 'campo puesto
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

'Para el orde en que se muestran en el asp

Do Until rsConsult.EOF
    Select Case arrTipoConc(rsConsult!tconnro)
        Case 1
            tipo_conc = "1"
        Case 2
            tipo_conc = "3"
        Case 3
            tipo_conc = "2"
        Case Else
            tipo_conc = ""
    End Select

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & tipo_conc & "'"
  StrSql = StrSql & ")"

  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext

Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------
'Dim cont As Long
'For cont = 1 To cantAcumGrupo1
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'1')"
'              StrSql = StrSql & ",'3')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next
'
''---------------------------------------------------------------------------
''Obtengo los datos del los conceptos del empleado, de la columna 2
''---------------------------------------------------------------------------
'
'For cont = 1 To cantAcumGrupo2
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'2')"
'              StrSql = StrSql & ",'1')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next
'
'
''---------------------------------------------------------------------------
''Obtengo los datos del los conceptos del empleado, de la columna 3
''---------------------------------------------------------------------------
'
'For cont = 1 To cantAcumGrupo3
'
'    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'    StrSql = StrSql & " FROM cabliq "
'    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & proNro
'    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & ternro
'    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(cont)
'    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'    OpenRecordset StrSql, rsConsult
'
'    Do Until rsConsult.EOF
'
'        StrSql = " SELECT ternro FROM rep_libroley_det "
'        StrSql = StrSql & " WHERE bpronro = " & NroProceso
'        StrSql = StrSql & " AND ternro = " & ternro
'        StrSql = StrSql & " AND pronro = " & proNro
'        StrSql = StrSql & " AND concnro = " & rsConsult!concnro
'
'        OpenRecordset StrSql, rsConsult2
'
'        If rsConsult2.EOF Then
'
'              StrSql = " INSERT INTO rep_libroley_det "
'              StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
'              StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
'              StrSql = StrSql & " dlimonto, conctipo) "
'              StrSql = StrSql & " VALUES "
'              StrSql = StrSql & "(" & NroProceso
'              StrSql = StrSql & "," & ternro
'              StrSql = StrSql & "," & proNro
'              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'              StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'              StrSql = StrSql & "," & rsConsult!concnro
'              StrSql = StrSql & "," & acumGrupo1(cont)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'              'StrSql = StrSql & ",'3')"
'              StrSql = StrSql & ",'2')"
'
'              objConn.Execute StrSql, , adExecuteNoRecords
'
'        End If
'
'        rsConsult2.Close
'
'        rsConsult.MoveNext
'
'    Loop
'
'    rsConsult.Close
'
'Next






'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'----------------------------------------------------------------------------------
'-- Calcula la antiguedad de la fase
'----------------------------------------------------------------------------------
Sub DiferenciaFase(ByVal fechaalta As Date, ByVal fechabaja As Date, ByRef diaF As Integer, ByRef mesF As Integer, ByRef anioF As Integer)
    Dim dia1, Mes1, Anio1, dia2, Mes2, Anio2, diames As Integer
    
    dia1 = Day(fechaalta)
    Mes1 = Month(fechaalta)
    Anio1 = Year(fechaalta)
    dia2 = Day(fechabaja)
    Mes2 = Month(fechabaja)
    Anio2 = Year(fechabaja)
    
    anioF = Anio2 - Anio1
    
    If Mes2 > Mes1 Then
        mesF = Mes2 - Mes1 - 1
    End If
    
    If Mes2 < Mes1 Then
        mesF = 12 + Mes2 - Mes1 - 1
        anioF = anioF - 1
    End If
    
    If Mes2 = Mes1 Then
        mesF = -1
    End If
    
    If (Mes1 = 2) And ((Anio1 Mod 4) = 0) Then
        diames = 29
    End If
    
    If (Mes1 = 2) And ((Anio1 Mod 4) > 0) Then
        diames = 28
    End If
    
    If (Mes1 = 4) Or (Mes1 = 6) Or (Mes1 = 9) Or (Mes1 = 11) Then
        diames = 30
    End If
                
    If (Mes1 = 1) Or (Mes1 = 3) Or (Mes1 = 5) Or (Mes1 = 7) Or (Mes1 = 8) Or (Mes1 = 10) Or (Mes1 = 12) Then
        diames = 31
    End If
    
    If (Mes2 = 2) And ((Anio2 Mod 4) = 0) And (dia2 = 29) Then
        dia2 = 0
        mesF = mesF + 1
    End If
    
    If (Mes2 = 2) And ((Anio2 Mod 4) > 0) And (dia2 = 28) Then
        dia2 = 0
        mesF = mesF + 1
    End If
    
    If ((Mes2 = 4) Or (Mes2 = 6) Or (Mes2 = 9) Or (Mes2 = 11)) And (dia2 = 30) Then
        dia2 = 0
        mesF = mesF + 1
    End If
                
    If ((Mes2 = 1) Or (Mes2 = 3) Or (Mes2 = 5) Or (Mes2 = 7) Or (Mes2 = 8) Or (Mes2 = 10) Or (Mes2 = 12)) And (dia2 = 31) Then
        dia2 = 0
        mesF = mesF + 1
    End If
    
    diaF = dia2 + diames - dia1 + 1
    
    If (diaF >= 29) And (diames = 29) Then
        mesF = mesF + 1
        diaF = diaF - 29
    End If
    If (diaF >= 28) And (diames = 28) Then
        mesF = mesF + 1
        diaF = diaF - 28
    End If
    If (diames = 30) And (diaF >= 30) Then
        mesF = mesF + 1
        diaF = diaF - 30
    End If
    If (diames = 31) And (diaF >= 31) Then
        mesF = mesF + 1
        diaF = diaF - 31
    End If
    If mesF >= 12 Then
        mesF = mesF - 12
        anioF = anioF + 1
    End If
    If mesF = -1 Then
        mesF = 11
        anioF = anioF - 1
    End If
    
    'dia = diaF
    'mes = mesF
    'anio = anioF
    
End Sub


'----------------------------------------------------------------------------------
'-- Calcula la suma de dos fases
'----------------------------------------------------------------------------------
Sub SumarFases(ByVal Mes As Integer, ByVal Anio As Integer, ByVal dia1 As Integer, ByVal Mes1 As Integer, ByVal Anio1 As Integer, ByRef dia2 As Integer, ByRef Mes2 As Integer, ByRef Anio2 As Integer)
    
    Anio2 = Anio2 + Anio1
    Mes2 = Mes2 + Mes1
    dia2 = dia2 + dia1
    
    If (dia2 >= 30) And ((Mes = 4) Or (Mes = 6) Or (Mes = 9) Or (Mes = 11)) Then
        dia2 = dia2 - 30
        Mes2 = Mes2 + 1
    Else
       If (dia2 >= 31) And ((Mes = 1) Or (Mes = 3) Or (Mes = 5) Or (Mes = 7) Or (Mes = 8) Or (Mes = 10) Or (Mes = 12)) Then
            dia2 = dia2 - 31
            Mes2 = Mes2 + 1
       Else
         If (dia2 >= 28) And (Mes = 2) And (Anio Mod 4 > 0) Then
                 dia2 = dia2 - 28
                 Mes2 = Mes2 + 1
         Else
            If (dia2 >= 29) And (Mes = 2) And (Anio Mod 4 = 0) Then
                 dia2 = dia2 - 29
                 Mes2 = Mes2 + 1
            End If
         End If
       End If
    End If
    
    If Mes2 >= 12 Then
        Mes2 = Mes2 - 12
        Anio2 = Anio2 + 1
    End If
    
    'diaT = dia2
    'mesT = mes2
    'anioT = anio2
End Sub


Sub antigfec(Ternro, fechafin, antdia, antmes, antanio, diashab)

Dim fecalta, fecbaja, Seguir, q, sql, rs, a1, m1
Dim ultima, auxiliar
Dim anioT As Integer
Dim mesT As Integer
Dim diaT As Integer
Dim Anio As Integer
Dim Mes As Integer
Dim Dia As Integer
Dim rsConsult As New Recordset
Dim StrSql As String
Dim l_antrec As Boolean
l_antrec = False
fecalta = ""
fecbaja = ""

StrSql = " SELECT * "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado = " & Ternro & " AND fases.real = -1 "
StrSql = StrSql & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
        If rsConsult("fasrecofec") = -1 And l_antrec = False Then
            l_antrec = True
        End If
        If l_antrec = True Then
            fecalta = rsConsult("altfec")
            fecbaja = rsConsult("bajfec") ' se trata de un registro completo
        
            If Not IsNull(fecbaja) Then
               'FASES CERRADAS --------------------------------------------
                 DiferenciaFase fecalta, fecbaja, Dia, Mes, Anio
                 m1 = Month(fecalta)
                 a1 = Year(fecalta)
                 SumarFases m1, a1, Dia, Mes, Anio, diaT, mesT, anioT
                'response.write("antdia cerrada")
                'response.write(antdia)
            Else
               'FASES ABIERTAS --------------------------------------------
                DiferenciaFase fecalta, fechafin, Dia, Mes, Anio
                m1 = Month(fecalta)
                a1 = Year(fecalta)
                SumarFases m1, a1, Dia, Mes, Anio, diaT, mesT, anioT
                'response.write("antdia abierta")
                'response.write(antdia)
            End If
        ultima = fecbaja
        End If
        rsConsult.MoveNext
    Loop
End If
rsConsult.Close
Set rsConsult = Nothing
antdia = diaT
antmes = mesT
antanio = anioT
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y vital
'--------------------------------------------------------------------
Sub generarDatosEmpleado34(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 34"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y Administradora Sanatorial.
'--------------------------------------------------------------------
Sub generarDatosEmpleado37(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famfec
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Sexo
Dim Sector
Dim Tiprodesc

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 37"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro '& " AND agencia is null "
Flog.writeline "Buscando datos del empleado"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   
   If CInt(rsConsult!tersex) = -1 Then
      Sexo = 1 ' Masculino
   Else
      Sexo = 0 ' Femenino
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
     
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If



    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor el tipo de modelo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " select tprocdesc from tipoproc a join proceso b "
sql = sql & "  on(a.tprocnro= b.tprocnro) "
sql = sql & " where b.pronro= " & Pronro

OpenRecordset sql, rsConsult


If Not rsConsult.EOF Then
   Tiprodesc = rsConsult!tprocdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del sector"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
End If

rsConsult.Close
'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Tiprodesc & "'"
StrSql = StrSql & "," & Sexo
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famfec, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfec) Then 'Se agregó la búsqueda del campo "famfec"
             famfec = "NULL"
          Else
             famfec = ConvFecha(rsConsult!famfec)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famfec    'Se cambio famDGIdesde por famfec
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y TPS
'--------------------------------------------------------------------
Sub generarDatosEmpleado36(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Sector
Dim Tiprodesc

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 36"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
     
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If



    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor el tipo de modelo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " select tprocdesc from tipoproc a join proceso b "
sql = sql & "  on(a.tprocnro= b.tprocnro) "
sql = sql & " where b.pronro= " & Pronro

OpenRecordset sql, rsConsult


If Not rsConsult.EOF Then
   Tiprodesc = rsConsult!tprocdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del sector"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
End If

rsConsult.Close
'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Tiprodesc & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub




'--------------------------------------------------------------------
' Se encarga de generar los datos para el Standar y vital
'--------------------------------------------------------------------
Sub generarDatosEmpleado01(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Inscripcion

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 1"
Flog.writeline Ternro

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro and empresa.estrnro= " & emprNro
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
Flog.writeline StrSql
Flog.writeline "NStrSql"

rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



Sub generarDatosEmpleado42(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 42"



'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Price
'--------------------------------------------------------------------
Sub generarDatosEmpleado41(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset
'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim OSocial As String
Dim Inscripcion
Dim Modelo

Dim sql As String
    
On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 41"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Flog.writeline "                Legajo: " & rsConsult!empleg
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro,tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
Flog.writeline "Buscando datos Obra Social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
If Not rsConsult.EOF Then
    OSocial = rsConsult!estrdabr
Else
    OSocial = ""
End If
rsConsult.Close

 
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
  If Not IsNull(rsConsult!terfecnac) Then 'mdf
   fecha_nac = rsConsult!terfecnac
  Else
    fecha_nac = ""
  End If
  If Not IsNull(rsConsult!estcivdesabr) Then 'mdf
     est_civil = rsConsult!estcivdesabr
  Else
    est_civil = ""
  End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
            Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro "
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,auxdeci2,paghasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & OSocial & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'Flog.writeline StrSql
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          Flog.writeline "Buscando datos de los familiares antes de insertar"
           
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Molinos Canepa (Copia del 15 - Los Grobo)
'--------------------------------------------------------------------
Sub generarDatosEmpleado43(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date

Dim EmpTernro
Dim formaliquidacion
Dim Sector

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 43"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr categoria, estr2.estrdabr contrato, estr3.estrdabr puesto, estr4.estrdabr regprev, estr5.estrdabr sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult


 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de Alta
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de alta"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecalta = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!altfec) Then
       fecalta = rsConsult!altfec
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc nrocuil, docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & "  " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del sector"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=21 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Forma de Liquidación
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Forma de Liquidación"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=22 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

formaliquidacion = ""

If Not rsConsult.EOF Then
   formaliquidacion = rsConsult!estrdabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & formaliquidacion & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc nrodoc, tipodocu.tidsigla sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Freddo-Aroma Cafe
'--------------------------------------------------------------------
Sub generarDatosEmpleado44(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim l_meses As Long

Dim ObraSocial
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 44"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

'Modificacion para el CAS-14152 - NORTHGATEARINSO - BUG en fechas de Egreso en Reporte Libro ley
'Inicio
 StrSql = "SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"
 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
    fecbaja = ""
    Flog.writeline "No encontró fase real"
 Else
    If Not IsNull(rsConsult!bajfec) Then
        'Modificacion para que la fecha de baja quede vacia si la fecha hasta del periodo
        'es menor a esta
        l_meses = DateDiff("m", pliqhasta, rsConsult!bajfec)
        If l_meses > 0 Then
           fecbaja = ""
        Else
           fecbaja = rsConsult!bajfec
        End If
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 rsConsult.Close
'Fin
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del la Obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Obra Social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Hospital Británico (Replica de Modelo 1)
'--------------------------------------------------------------------
Sub generarDatosEmpleado45(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 45"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Edeste
'--------------------------------------------------------------------
Sub generarDatosEmpleado46(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim nomEmpre
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

Dim tersex

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 46"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr,tercero.tersex"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
   tersex = rsConsult!tersex
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND confnrocol = 17 "
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
StrSql = "SELECT concnro FROM concepto WHERE tconnro = " & rsConsult!confval
                  StrSql = StrSql & " OR tconnro = '" & rsConsult!confval2 & "'"
    Flog.writeline " Entro"
End If




'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,provincia.provdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON provincia.provnro = localidad.provnro"
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc & " , " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empdesc " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
            nomEmpre = rsConsult!empdesc
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, provincia.provdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            " INNER JOIN provincia ON provincia.provnro = localidad.provnro"

        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc & ", " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,tipofam) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & nomEmpre & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ",'" & tersex & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"
'Flog.writeline "Consulta del detalle: " & StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords
  
  'Linea de control
  'Flog.writeline "Ingresa en detalle: " & StrSql
  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc,famfec " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          'If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          'Else
          '   famfecvto = ConvFecha(rsConsult!famfecvto)
          'End If
          If IsNull(rsConsult!famfec) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfec)
          End If
                  
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
                 
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Farmografica
'--------------------------------------------------------------------
Sub generarDatosEmpleado47(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim ObraSocial
Dim Convenio
Dim Nacionalidad
Dim Sexo
Dim direccionemp
Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 47"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
Flog.writeline StrSql
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del convenio"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=19 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select nacionaldes FROM empleado INNER JOIN tercero  "
StrSql = StrSql & "  ON empleado.ternro= tercero.ternro  "
StrSql = StrSql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   Nacionalidad = rsConsult!nacionaldes

Else
   Nacionalidad = ""
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
  
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,detdom.codigopostal,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc & " - " & rsConsult!codigopostal
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & Sexo & "'" 'nacionalidad
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  'StrSql = StrSql & ",'" & rsConsult!tconnro & "'"
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para General Mills
'--------------------------------------------------------------------
Sub generarDatosEmpleado48(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim ObraSocial
Dim Convenio
Dim Nacionalidad
Dim Sexo
Dim direccionemp
Dim sql As String

Dim fecaltamax As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 48"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
Flog.writeline StrSql
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del convenio"

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=19 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del convenio" & StrSql
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select nacionaldes FROM empleado INNER JOIN tercero  "
StrSql = StrSql & "  ON empleado.ternro= tercero.ternro  "
StrSql = StrSql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   Nacionalidad = rsConsult!nacionaldes

Else
   Nacionalidad = ""
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrcodext AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by bajfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de alta primera fase
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja1"

 StrSql = " SELECT min(altfec) afec"
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by afec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
     fecalta = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!afec) Then
       fecalta = rsConsult!afec
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la fecha de alta ultima fase
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja2"

 StrSql = " SELECT max(altfec) afec1 "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by afec1 DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecaltamax = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!afec1) Then
       fecaltamax = rsConsult!afec1
    Else
        Flog.writeline "Fecha de alta nula. "
    End If
 End If
 
 rsConsult.Close
 
 
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
  
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,provincia.provdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            " INNER JOIN provincia ON provincia.provnro = localidad.provnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           emprDire = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc & ", " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,detdom.codigopostal,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc & " - " & rsConsult!codigopostal
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & ",'" & fecaltamax & "'"
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & Sexo & "'" 'nacionalidad
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
 StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Horwath Rosario
'--------------------------------------------------------------------
Sub generarDatosEmpleado49(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim regimenHorario As String
Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim Sexo
Dim Nacionalidad
'variable sebastian stremel 23/04/2012
Dim noremunerativo

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 49"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empfaltagr,empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If CInt(rsConsult!tersex) = -1 Then
     Sexo = "M"
   Else
     Sexo = "F"
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS reghorario "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el regimen horario
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 21 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
    
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 'Regimen Horario
 If IsNull(rsConsult!reghorario) Then
   regimenHorario = ""
 Else
   regimenHorario = rsConsult!reghorario
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close


'sebastian stremel 23/04/2012 conceptos no remunerativos
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Acumulador no remunerativo
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sql = " SELECT almonto,acunro "
sql = sql & " FROM acu_liq"
sql = sql & " WHERE acunro = " & cod_acum_noremunerativo
sql = sql & " AND cliqnro =  " & cliqnro

'---LOG---
Flog.writeline "Buscando datos del acumulador no remunerativo"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   noremunerativo = 0
Else
   noremunerativo = rsConsult!almonto
End If

rsConsult.Close


'hasta aca





'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select

'Obtengo la direccion de la empresa
sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"

OpenRecordset sql, rsConsult

EmpTernro = 0

If Not rsConsult.EOF Then
    EmpTernro = rsConsult!Ternro
End If

rsConsult.Close

'Consulta para obtener la direccion de la empresa
sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "

'---LOG---
Flog.writeline "Buscando datos de la direccion de la empresa"

OpenRecordset sql, rsConsult

If Not rsConsult.EOF Then
   emprDire = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select nacionaldes FROM empleado INNER JOIN tercero  "
StrSql = StrSql & "  ON empleado.ternro= tercero.ternro  "
StrSql = StrSql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro= tercero.nacionalnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   Nacionalidad = rsConsult!nacionaldes

Else
   Nacionalidad = ""
End If

rsConsult.Close




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar5,auxchar4,auxdeci1,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & regimenHorario & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
'StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(noremunerativo) 'sebastian stremel 23/04/2012
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Sexo & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
'StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult
Dim totalNR As Double
totalNR = 0
Do Until rsConsult.EOF

    'sebastian stremel - sumo los no remunerativos
    If rsConsult!tconnro = 9 Then
        totalNR = totalNR + rsConsult!dlimonto
        Flog.writeline "Sumando valores NR concepto tipo " & rsConsult!tconnro & " numero " & rsConsult!ConcCod & ""
    Else
        Flog.writeline "concepto tipo " & rsConsult!tconnro & " numero " & rsConsult!ConcCod & ""
    End If
    'hasta aca

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close
'Sebastian Stremel 03/05/2012
'Flog.writeline " update rep_libroley "
'StrSql = " UPDATE rep_libroley "
'StrSql = StrSql & " SET asi_flia=" & totalNR
'StrSql = StrSql & " WHERE bpronro=" & NroProceso
'objConn.Execute StrSql, , adExecuteNoRecords
'Flog.writeline " fin update rep_libroley "
'hasta aca
'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Coop. Seguros
'--------------------------------------------------------------------
Sub generarDatosEmpleado50(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 50"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=45 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Timbo
'--------------------------------------------------------------------
Sub generarDatosEmpleado51(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro
Dim ObraSocial

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 51"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close
   
   
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!nrocuil) Then
        cuil = rsConsult!nrocuil
   End If
   If Not IsNull(rsConsult!NroDoc) Then
        documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   End If
   If Not IsNull(rsConsult!terfecnac) Then
        fecha_nac = rsConsult!terfecnac
   End If
   If Not IsNull(rsConsult!estcivdesabr) Then
        est_civil = rsConsult!estcivdesabr
   End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select

sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
sql = sql & " From his_estructura"
sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ")"
sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
sql = sql & " WHERE his_estructura.tenro=1 AND his_estructura.estrnro=1254"

'---LOG---
Flog.writeline "Buscando datos de la direccion de la sucursal"

OpenRecordset sql, rsConsult

If Not rsConsult.EOF Then
   emprDire = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close

'StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
'    " From his_estructura" & _
'    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
'    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
'    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
'    " AND his_estructura.ternro = " & Ternro & _
'    " AND his_estructura.tenro  = 1 AND his_estructura.estrnro = 1254"
'OpenRecordset StrSql, rsConsult
'
'If rsConsult.EOF Then
'    Flog.writeline "No se encontró la empresa"
'    Exit Sub
'Else
'    'EmpNombre = rs_estructura!empnom
'    emprDire = rsConsult!Estrnro
'End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Mimo Vestiditos
'--------------------------------------------------------------------
Sub generarDatosEmpleado52(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim ObraSocial
Dim Convenio
Dim Nacionalidad
Dim Sexo
Dim direccionemp
Dim sql As String
Dim seccion As String
Dim Men_Jor As String
Dim provincia As String


On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 52"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
Flog.writeline StrSql
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del convenio"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=19 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select provdesc FROM tercero INNER JOIN cabdom  "
StrSql = StrSql & "  ON cabdom.ternro= tercero.ternro  "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro = detdom.provnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   provincia = rsConsult!provdesc

Else
   provincia = ""
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS seccion, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS categoria, estr7.estrdabr AS Men_jor "
 sql = sql & " FROM empleado "
 'Busco la Seccion
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 2 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el categoria
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 3 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
 'Busco el Mensual Jornal
 sql = sql & " LEFT JOIN his_estructura his7 ON his7.ternro = empleado.ternro AND his7.tenro = 22 AND empleado.ternro= " & Ternro & " AND his7.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his7.htethasta IS NULL OR his7.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr7 ON estr7.estrnro = his7.estrnro "
    
    
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Seccion
 If IsNull(rsConsult!seccion) Then
   seccion = ""
 Else
   seccion = rsConsult!seccion
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If
 
 'Categoria
 If IsNull(rsConsult!Puesto) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If

 'Mensual Jornal
 If IsNull(rsConsult!Puesto) Then
   Men_Jor = ""
 Else
   Men_Jor = rsConsult!Men_Jor
 End If


 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
  
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        Flog.writeline sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        Flog.writeline "Empresa" & sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,detdom.codigopostal,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        Flog.writeline "Empresa" & sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           direccionemp = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc & " - " & rsConsult!codigopostal
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close

        'Consulta para obtener la direccion de la empresa
sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
Flog.writeline "Buscando datos de la direccion de la empresa"
Flog.writeline "Empresa" & EmpTernro & sql
OpenRecordset sql, rsConsult
        
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Men_Jor & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & direccionemp & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & provincia & "'"
StrSql = StrSql & ",'" & Sexo & "'" 'nacionalidad
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & seccion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & rsConsult!tconnro & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'---------------------------------------------------------------------------------------------------
' Se encarga de generar los datos para SOS
'---------------------------------------------------------------------------------------------------
Sub generarDatosEmpleado53(Pronro, Ternro, descripcion, orden)
'---------------------------------------------------------------------------------------------------
' Descripción: Procedimiento que se encarga de generar los datos para el Modelo Nº 53 de SOS, el mismo
'              se creó a partir del modelo Nº 41 generado para Price. CAS-15866 - SOS - LIBRO LEY
' Fecha: 24/05/2012
' Autor: Zamarbide Juan
' Modificación: 30/05/2012 - Zamarbide Juan - Se comentó la búsqueda de la AntiguedadReconocida, ya que no se utilizaba
'                                             y arrojaba un error en el proceso. CAS-15866 - SOS - LIBRO LEY
'---------------------------------------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset
'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim formaPago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim Lug_Pago As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim OSocial As String
Dim Inscripcion
Dim Modelo

Dim sql As String
    
On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 53"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Flog.writeline "                Legajo: " & rsConsult!empleg
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro,tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS lugarpago "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el Lugar de Pago
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 20 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
 
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If
 
 'Lugar de Pago
 If IsNull(rsConsult!lugarpago) Then
   Lug_Pago = ""
 Else
   Lug_Pago = rsConsult!lugarpago
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
'Flog.writeline "Buscando datos de la Antigüedad Reconocida "

'Dim l_texto As String
'Dim l_dia, l_mes, l_anio, l_hab

'l_dia = 0
'l_mes = 0
'l_anio = 0
'l_texto = ""
AntiguedadReconocida = ""

'Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
'If l_anio = "" Or l_anio = 0 Then
'    If l_mes = "" Or l_mes = 0 Then
'        l_texto = l_dia & " día/s."
'    Else
'        l_texto = l_mes & " mes/es " & l_dia & " día/s."
'    End If
'Else
'    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
'End If
'AntiguedadReconocida = l_texto
 
 
Flog.writeline "Buscando datos Obra Social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
If Not rsConsult.EOF Then
    OSocial = rsConsult!estrdabr
Else
    OSocial = ""
End If
rsConsult.Close

 
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr "
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
            Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select
'------------------------------------------------------------------
'Busco los datos de la Cuenta Bancaria
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la Cuenta Bancaria"

StrSql = " SELECT ctabnro, fpagdescabr, bandesc FROM ctabancaria "
StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro"
StrSql = StrSql & " WHERE "
StrSql = StrSql & " ctabancaria.ctabestado = -1 "
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

formaPago = ""
If Not rsConsult.EOF Then
    If rsConsult!bandesc <> "" Then
        formaPago = rsConsult!bandesc
    End If
    formaPago = formaPago & " - "
    Select Case UCase(rsConsult!fpagdescabr)
        Case "CUENTA CORRIENTE":
            formaPago = formaPago & "CC "
        Case "CAJA DE AHORRO":
            formaPago = formaPago & "CA "
    End Select
    If rsConsult!ctabnro <> "" Then
        formaPago = formaPago & rsConsult!ctabnro
    End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"

StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro "
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,auxdeci2, "
StrSql = StrSql & " paghasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
'StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & ",'" & Lug_Pago & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & OSocial & "'"
StrSql = StrSql & ",0"
'StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ",'" & formaPago & "'"
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'Flog.writeline StrSql
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          Flog.writeline "Buscando datos de los familiares antes de insertar"
           
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para OSDOP
'--------------------------------------------------------------------
Sub generarDatosEmpleado54(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset
'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim OSocial As String
Dim Inscripcion
Dim Modelo
Dim Estrdescext

Dim sql As String
    
On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 54"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Flog.writeline "                Legajo: " & rsConsult!empleg
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro,tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
Flog.writeline "Buscando datos Obra Social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
If Not rsConsult.EOF Then
    OSocial = rsConsult!estrdabr
Else
    OSocial = ""
End If
rsConsult.Close

 
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
            Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

Flog.writeline " Cargas Sociales " & StrSql

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Estructura Descripcion Extendida
'------------------------------------------------------------------
StrSql = "SELECT estrdext, estrdabr "
StrSql = StrSql & " From his_estructura "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
StrSql = StrSql & " WHERE his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10 "
Flog.writeline " Descripcion Extendida " & StrSql
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Estrdescext = rsConsult!Estrdext
    empresa = rsConsult!estrdabr
Else
    Estrdescext = " "
    empresa = " "
    Flog.writeline " No se Encontro Estructura Descripcion Extendida "
End If


rsConsult.Close
           
'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro "
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,auxdeci2,paghasta,tomo) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Mid(Estrdescext, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & OSocial & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ")"

'Flog.writeline StrSql
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          Flog.writeline "Buscando datos de los familiares antes de insertar"
           
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Horwath Litoral AMR
'--------------------------------------------------------------------
Sub generarDatosEmpleado55(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConfrep As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Inscripcion

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim AcuRem
Dim AcuNoRem
Dim AcuDtos

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 55"
Flog.writeline Ternro

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Confrep Acumulador Remunerativo
'------------------------------------------------------------------
AcuRem = 0
sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND confnrocol = 18"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & rsConsult!confval
    sql = sql & " AND cliqnro =  " & cliqnro
    OpenRecordset sql, rsConfrep
    If Not rsConfrep.EOF Then
        AcuRem = rsConfrep!almonto
    End If
    rsConfrep.Close
Else
        Flog.writeline " o tiene configurada la Columna Nro 18 con el Acumulador "
End If

rsConsult.Close

'------------------------------------------------------------------
' Confrep Acumulador No Remunerativo
'------------------------------------------------------------------
AcuNoRem = 0
sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND confnrocol = 23 "
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & rsConsult!confval
    sql = sql & " AND cliqnro =  " & cliqnro
    OpenRecordset sql, rsConfrep
    If Not rsConfrep.EOF Then
        AcuNoRem = rsConfrep!almonto
    End If
    rsConfrep.Close
Else
        Flog.writeline " o tiene configurada la Columna Nro 23 con el Acumulador "
End If

rsConsult.Close

'------------------------------------------------------------------
' Confrep Acumulador Descuentos
'------------------------------------------------------------------
AcuDtos = 0
sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND confnrocol = 22"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & rsConsult!confval
    sql = sql & " AND cliqnro =  " & cliqnro
    OpenRecordset sql, rsConfrep
    If Not rsConfrep.EOF Then
        AcuDtos = rsConfrep!almonto
    End If
    rsConfrep.Close
Else
    Flog.writeline " o tiene configurada la Columna Nro 22 con el Acumulador "
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro and empresa.estrnro= " & emprNro
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
Flog.writeline StrSql
Flog.writeline "NStrSql"

rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo,auxdeci2,auxdeci3,auxdeci4,auxdeci5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & "," & AcuRem
StrSql = StrSql & "," & AcuNoRem
StrSql = StrSql & "," & AcuDtos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion" & StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para BDO - GE
'--------------------------------------------------------------------
Sub generarDatosEmpleado56(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim nroInscripcion

Dim CentroCosto

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim Cod_Contrato

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 56"
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Fecha Baja
 If IsNull(rsConsult!empfecbaja) Then
    fecbaja = ""
 Else
    fecbaja = rsConsult!empfecbaja
 End If

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 61 "
StrSql = StrSql & " AND confnrocol = 103 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
   Cod_Contrato = 0
   Flog.writeline "No esta configurado el confrep"
Else
   Cod_Contrato = rsConsult!confval
End If
rsConsult.Close

'---LOG---
Flog.writeline "Buscando datos de la condicion"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro= " & Cod_Contrato
StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

contrato = ""

If Not rsConsult.EOF Then
   contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
 
 
'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
sql = sql & " From his_estructura"
sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
'---LOG---
Flog.writeline "Buscando datos de la direccion"

OpenRecordset sql, rsConsult

Direccion = ""
If Not rsConsult.EOF Then
       Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'Consulta para obtener el nro. de inscripcion de la empresa
StrSql = "SELECT nrodoc FROM tercero " & _
         " INNER JOIN ter_doc ON (tercero.ternro = ter_doc.ternro and ter_doc.tidnro = " & TipDocNroInscr & ")" & _
         " Where tercero.ternro =" & emprTer

'---LOG---
Flog.writeline "Buscando datos del nro. de inscripcion de la empresa"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No se encontró el nro. de inscripcion de la Empresa"
    'Exit Sub
    nroInscripcion = "  "
Else
    nroInscripcion = rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   pliqfecdep = ConvFecha(pliqfecdep)
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & nroInscripcion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro
          
    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
    
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
      
      End If
        
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa AluFlex
'--------------------------------------------------------------------
Sub generarDatosEmpleado57(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Inscripcion

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 57"
Flog.writeline Ternro

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro and empresa.estrnro= " & emprNro
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
Flog.writeline StrSql
Flog.writeline "NStrSql"

rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa SGS
'--------------------------------------------------------------------
Sub generarDatosEmpleado58(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Inscripcion

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim Empleado_Actividad

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 58"
Flog.writeline Ternro

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS actividad "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco la Actividad
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 29 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "



 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If

 'Actividad
 If IsNull(rsConsult!actividad) Then
   Empleado_Actividad = ""
 Else
   Empleado_Actividad = rsConsult!actividad
 End If
 estado = rsConsult!empest
 
 rsConsult.Close
 
 
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   fecbaja = ""
   Flog.writeline "No encontró fase real"
Else
   If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
   Else
        Flog.writeline "Fecha de baja nula. "
   End If
End If

rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   cuil = rsConsult!nrocuil
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro and empresa.estrnro= " & emprNro
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
Flog.writeline StrSql
Flog.writeline "NStrSql"

rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Empleado_Actividad & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Santana
'--------------------------------------------------------------------
Sub generarDatosEmpleado59(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String
Dim Inscripcion

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim final As Integer
Dim tprocnro As Integer
Dim profecini As Date
Dim profecfin As Date

Dim sql As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 59"
Flog.writeline Ternro

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro, "
StrSql = StrSql & " tipoproc.final, tipoproc.tprocnro, proceso.profecini, proceso.profecfin FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   final = rsConsult!final
   tprocnro = rsConsult!tprocnro
   profecini = rsConsult!profecini
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If
Flog.writeline "Buscando datos del proceso: " & Pronro
Flog.writeline "Periodo ini:" & pliqdesde & " - Fin:" & pliqhasta
Flog.writeline "Proceso ini:" & profecini & " - Fin:" & profecfin
rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr categoria, estr2.estrdabr contrato, estr3.estrdabr puesto, estr4.estrdabr regprev, estr5.estrdabr sucursal "
sql = sql & " FROM empleado "
'Busco la categoria
sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 3 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
'Busco el contrato
sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
'Busco el puesto
sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
'Busco el regimen previsional
sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
'Busco la sucursal
sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
   
sql = sql & " WHERE empleado.ternro = " & Ternro

OpenRecordset sql, rsConsult
 
If final = -1 Then
 
    Flog.writeline "Buscando datos del empleado cuando la liquidacion es final"
    
    'Estado
    Flog.writeline "Buscando datos del estado del empleado"
    estado = 0
    
    'Fecha baja (Egreso)
    Flog.writeline "Buscando datos de fecha de baja"
    
    Dim rsEgreso As New ADODB.Recordset
    
    StrSql = " SELECT bajfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE fases.empleado=" & Ternro
    'StrSql = StrSql & " AND fases.estado = 0 order by bajfec DESC"
    StrSql = StrSql & " AND fases.estado = 0 and bajfec <=" & ConvFecha(profecfin) & "order by bajfec  DESC"
    
    OpenRecordset StrSql, rsEgreso
    
    If rsEgreso.EOF Then
       fecbaja = ""
       Flog.writeline "No encontró fecha de Egreso"
    Else
       If Not IsNull(rsEgreso!bajfec) Then
            fecbaja = rsEgreso!bajfec
       Else
            fecbaja = ""
            Flog.writeline "Fecha de baja nula. "
       End If
    End If
    rsEgreso.Close
    
    'Fecha Alta (Ingreso)
    Flog.writeline "Buscando datos de alta del empleado"
    'If IsNull(rsConsult!empfaltagr) Then
    '   fecalta = ""
    'Else
    '   fecalta = rsConsult!empfaltagr
    'End If
    
     Dim rsIngreso As New ADODB.Recordset
     StrSql = " SELECT altfec, bajfec "
     StrSql = StrSql & " FROM fases "
     StrSql = StrSql & " WHERE fases.Empleado = " & Ternro
     If fecbaja = "" Then
       StrSql = StrSql & " AND fases.altfec <= " & ConvFecha(profecfin) 'lam
     Else 'mdf
       StrSql = StrSql & " AND fases.altfec <= " & ConvFecha(fecbaja) 'mdf
     End If 'mdf
     StrSql = StrSql & " AND fases.real = -1 " 'lam
     StrSql = StrSql & " AND fases.estado = 0 ORDER BY bajfec DESC " 'lm estado
     
     ''FB - 13/01/2015 - Se descomento la siguiente SQL para buscar la fecha de ingreso en funcion a la fase
     'StrSql = " SELECT altfec, bajfec "
     'StrSql = StrSql & " FROM fases "
     'StrSql = StrSql & " WHERE fases.Empleado = " & Ternro
     'StrSql = StrSql & " ORDER BY bajfec DESC "
     ''02/10/2014
     ''StrSql = "SELECT htetdesde altfec "
     ''StrSql = StrSql & " FROM his_estructura "
     ''StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
     ''StrSql = StrSql & " AND (htetdesde <= " & ConvFecha(pliqhasta) & " AND htethasta <= " & ConvFecha(pliqhasta) & ")"
     ''StrSql = StrSql & " AND his_estructura.tenro = 18 AND his_estructura.ternro = " & Ternro
     ''StrSql = StrSql & " ORDER BY htethasta DESC"
     OpenRecordset StrSql, rsIngreso
     If rsIngreso.EOF Then
         fecalta = ""
         Flog.writeline "No encontró fecha de Ingreso"
     Else
       If Not IsNull(rsIngreso!altfec) Then
          fecalta = rsIngreso!altfec
       Else
           fecalta = ""
           Flog.writeline "Fecha de alta nula. "
       End If
     End If
     rsIngreso.Close
    Flog.writeline "Fecha ingreso = " & fecalta
    
    'Contrato (Contratacion)
    Flog.writeline "Buscando datos del contrato del empleado"
    'If IsNull(rsConsult!contrato) Then
    '   contrato = ""
    'Else
    '   contrato = rsConsult!contrato
    'End If
    
    Dim rsContrato As New ADODB.Recordset
    'LM - 04/02/2015 cuac
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
    ''FB - 13/01/2015 - Se descomenta la siguiente SQL para obtener el contrato.
    'StrSql = " SELECT estrdabr "
    'StrSql = StrSql & " From his_estructura"
    'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
    ''02/10/2014
    ''StrSql = " SELECT estrdabr "
    ''StrSql = StrSql & " From his_estructura "
    ''StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    ''StrSql = StrSql & " AND (htetdesde <= " & ConvFecha(pliqhasta) & " AND htethasta <= " & ConvFecha(pliqhasta) & ") "
    ''StrSql = StrSql & " AND his_estructura.tenro = 18 AND his_estructura.ternro = " & Ternro
    ''StrSql = StrSql & " ORDER BY htethasta DESC"
       
    Flog.writeline "SQL de contrato: " & StrSql
    OpenRecordset StrSql, rsContrato

    contrato = ""

    If Not rsContrato.EOF Then
       contrato = rsContrato!estrdabr
    End If
    rsContrato.Close

Else 'No final
    
    Flog.writeline "Buscando datos del empleado cuando la liquidacion no es final"
    'Estado
    Flog.writeline "Buscando datos del estado del empleado (No final Activo)"
    estado = -1 'rsConsult!empest
    
    If tprocnro = 1 Then
    
        Flog.writeline "Buscando datos del empleado para la primera quincena"
        'Fecha alta (Ingreso)
        Flog.writeline "Buscando datos de fecha de alta"
        
        Dim rs As New ADODB.Recordset
        'Comentado 20/11/2014
        'StrSql = " SELECT altfec, bajfec "
        'StrSql = StrSql & " FROM fases "
        'StrSql = StrSql & " WHERE bajfec IS NOT NULL AND fases.empleado=" & Ternro & " order by altfec DESC"
        
        'StrSql = "SELECT altfec, bajfec "
        'StrSql = StrSql & " FROM fases "
        'StrSql = StrSql & " WHERE bajfec IS NULL "
        'StrSql = StrSql & " AND fases.empleado=" & Ternro
        'StrSql = StrSql & " AND estado = -1 "
        'StrSql = StrSql & " ORDER BY altfec DESC "
        StrSql = " SELECT altfec, bajfec "
        StrSql = StrSql & " FROM fases "
        StrSql = StrSql & " WHERE fases.Empleado = " & Ternro
        StrSql = StrSql & " AND fases.altfec <= " & ConvFecha(profecfin) 'lam
        StrSql = StrSql & " AND fases.real = -1 " 'lam
        StrSql = StrSql & " ORDER BY bajfec DESC " 'lm estado
        OpenRecordset StrSql, rs
        If rs.EOF Then
           fecalta = ""
           Flog.writeline "Fecha de alta vacia "
        Else
            fecalta = rs!altfec
        End If
        rs.Close
        
        'Fecha baja (Egreso)
        Flog.writeline "Buscando datos de fecha de baja"
        fecbaja = ""
        Flog.writeline "Fecha de Vacia para liquidaciones no finales. "
'        StrSql = " SELECT altfec, bajfec "
'        StrSql = StrSql & " FROM fases "
'        StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"
'        OpenRecordset StrSql, rs
'        If rs.EOF Then
'           fecbaja = ""
'           Flog.writeline "No encontró fase real"
'        Else
'           If Not IsNull(rs!bajfec) Then
'               'fecbaja = rs!bajfec
'               fecbaja = ""
'               Flog.writeline "Fecha de Vacia par liquidaciones no finales. "
'           Else
'                fecbaja = ""
'                Flog.writeline "Fecha de baja nula. "
'           End If
'        End If
'        rs.Close
    
        Flog.writeline "Buscando datos del contrato del empleado"
    
        'StrSql = " SELECT estrdabr "
        'StrSql = StrSql & " From his_estructura "
        'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        'StrSql = StrSql & " AND (htetdesde <= " & ConvFecha(pliqhasta) & " OR htethasta <= " & ConvFecha(pliqhasta) & ") "
        'StrSql = StrSql & " AND his_estructura.tenro = 18 AND his_estructura.ternro = " & Ternro
        'StrSql = StrSql & " ORDER BY htethasta DESC"
        
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=18 AND his_estructura.ternro=" & Ternro
        OpenRecordset StrSql, rsContrato
        Flog.writeline "SQL de contrato: " & StrSql

        contrato = ""

        If Not rsContrato.EOF Then
           contrato = rsContrato!estrdabr
        End If
        rsContrato.Close
        
        'Estado activo 1º15º SIEMPRE si no es final
        'estado = -1
        
    End If 'tprocnro = 1
    
    If tprocnro <> 1 Then
        Flog.writeline "Buscando datos del empleado para otra quincena"
        'Fecha baja (Egreso)
        Flog.writeline "Buscando datos de fecha de baja"
        fecbaja = ""
'        Flog.writeline "Fecha de Vacia par liquidaciones no finales. "
'        StrSql = " SELECT altfec, bajfec "
'        StrSql = StrSql & " FROM fases "
'        StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"
'        OpenRecordset StrSql, rs
'        If rs.EOF Then
'           fecbaja = ""
'           Flog.writeline "No encontró fase real"
'        Else
'           If Not IsNull(rs!bajfec) Then
'               fecbaja = rs!bajfec
'           Else
'                fecbaja = ""
'                Flog.writeline "Fecha de baja nula. "
'           End If
'        End If
'        rs.Close
        
        'Fecha Alta (Ingreso)
        Flog.writeline "Buscando datos de fecha de ingreso"
       '------------------------------------- MDF
        'StrSql = " SELECT altfec, bajfec "
        'StrSql = StrSql & " FROM fases "
        'StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"
        StrSql = " SELECT altfec, bajfec "
        StrSql = StrSql & " FROM fases "
        StrSql = StrSql & " WHERE fases.Empleado = " & Ternro
        StrSql = StrSql & " AND fases.altfec <= " & ConvFecha(profecfin) 'lam
        StrSql = StrSql & " AND fases.real = -1 " 'lam
        StrSql = StrSql & " ORDER BY bajfec DESC " 'lm estado
        OpenRecordset StrSql, rs
        
        '------------------------------------- MDF
        
        
        
        If rs.EOF Then
             fecalta = ""
             Flog.writeline "No encontró fase real"
         Else
           If Not IsNull(rs!altfec) Then
              fecalta = rs!altfec
           Else
               fecalta = ""
               Flog.writeline "Fecha de alta nula. "
           End If
        End If
        rs.Close
        
        'Contrato (Contratacion)
        Flog.writeline "Buscando datos del contrato del empleado"
        
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=18 AND his_estructura.ternro=" & Ternro
        OpenRecordset StrSql, rs
        Flog.writeline "SQL de contrato: " & StrSql
        
        contrato = ""
        If Not rs.EOF Then
           contrato = rs!estrdabr
        End If
        
        rs.Close
    End If 'tprocnro<>1

End If 'final
 
 ' Comentado 22/08/2014
 'Fecha Alta
 'If IsNull(rsConsult!empfaltagr) Then
 '   fecalta = ""
 'Else
 '   fecalta = rsConsult!empfaltagr
 'End If
 
' 'Contrato
' If IsNull(rsConsult!contrato) Then
'   contrato = ""
' Else
'   contrato = rsConsult!contrato
' End If
' fin

 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If
 
 ' Comentado 22/08/2014
 'Estado
 'estado = rsConsult!empest
 'fin
 
 rsConsult.Close
 
'Comentado 22/08/2014
' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
'Flog.writeline "Buscando datos de fecha de baja"

'StrSql = " SELECT altfec, bajfec "
'StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"
'
'OpenRecordset StrSql, rsConsult
'
'If rsConsult.EOF Then
'   fecbaja = ""
'   Flog.writeline "No encontró fase real"
'Else
'   If Not IsNull(rsConsult!bajfec) Then
'       fecbaja = rsConsult!bajfec
'   Else
'        Flog.writeline "Fecha de baja nula. "
'   End If
'End If
'
'rsConsult.Close
' fin

' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " & l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
 
'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!nrocuil) Then
        cuil = rsConsult!nrocuil
   End If
   
   If Not IsNull(rsConsult!NroDoc) Then
        documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   End If
   
   If Not IsNull(rsConsult!terfecnac) Then
        fecha_nac = rsConsult!terfecnac
   End If
   
   If Not IsNull(rsConsult!estcivdesabr) Then
        est_civil = rsConsult!estcivdesabr
   End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro and empresa.estrnro= " & emprNro
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
Flog.writeline StrSql
Flog.writeline "NStrSql"

rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,pagHasta,tomo,auxdeci2) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Trab & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para San Miguel (NGA)
'--------------------------------------------------------------------
Sub generarDatosEmpleado60(Pronro, Ternro, descripcion, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim fecini As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3

Dim ObraSocial
Dim Convenio
Dim Nacionalidad
Dim Sexo
Dim direccionemp
Dim sql As String
Dim seccion As String
Dim Men_Jor As String
Dim provincia As String
Dim Modelo As String

On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 60"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,tercero.tersex "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = empleado.ternro AND empleado.ternro= " & Ternro
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro,tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la obra social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
Flog.writeline StrSql
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del convenio"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=19 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la nacionalidad del empleado
'------------------------------------------------------------------
StrSql = " select provdesc FROM tercero INNER JOIN cabdom  "
StrSql = StrSql & "  ON cabdom.ternro= tercero.ternro  "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro = detdom.provnro "
StrSql = StrSql & " where tercero.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Buscando datos de las cargas sociales"
If Not rsConsult.EOF Then
   provincia = rsConsult!provdesc

Else
   provincia = ""
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS seccion, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS categoria, estr7.estrdabr AS Men_jor "
 sql = sql & " FROM empleado "
 'Busco la Seccion
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 2 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco la obra social de empleado   --- antes traia el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 17 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el categoria
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 3 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
 'Busco el Mensual Jornal
 sql = sql & " LEFT JOIN his_estructura his7 ON his7.ternro = empleado.ternro AND his7.tenro = 22 AND empleado.ternro= " & Ternro & " AND his7.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his7.htethasta IS NULL OR his7.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr7 ON estr7.estrnro = his7.estrnro "
    
    
    
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 
 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 
 'Seccion
 If IsNull(rsConsult!seccion) Then
   seccion = ""
 Else
   seccion = rsConsult!seccion
 End If
 
 'Puesto
 If IsNull(rsConsult!Puesto) Then
   Puesto = ""
 Else
   Puesto = rsConsult!Puesto
 End If
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If
 
 'Categoria
 If IsNull(rsConsult!Puesto) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If

 'Mensual Jornal
 If IsNull(rsConsult!Puesto) Then
   Men_Jor = ""
 Else
   Men_Jor = rsConsult!Men_Jor
 End If


 estado = rsConsult!empest
 
 rsConsult.Close
 
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
  
    fecalta = rsConsult!altfec
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
    rsConsult.MoveLast
    fecini = rsConsult!altfec
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de la Antigüedad Reconocida "

Dim l_texto As String
Dim l_dia, l_mes, l_anio, l_hab

l_dia = 0
l_mes = 0
l_anio = 0
l_texto = ""
AntiguedadReconocida = ""

Call antigfec(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
    
If l_anio = "" Or l_anio = 0 Then
    If l_mes = "" Or l_mes = 0 Then
        l_texto = l_dia & " día/s."
    Else
        l_texto = l_mes & " mes/es " & l_dia & " día/s."
    End If
Else
    l_texto = l_anio & " año/s " & l_mes & " mes/es " '& l_dia & " día/s."
End If
AntiguedadReconocida = l_texto
 
  
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, estcivil.estcivdesabr"
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   fecha_nac = rsConsult!terfecnac
   est_civil = rsConsult!estcivdesabr
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        Flog.writeline sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        Flog.writeline "Empresa" & sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,detdom.codigopostal,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        Flog.writeline "Empresa" & sql
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           direccionemp = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc & " - " & rsConsult!codigopostal
        End If
        
        rsConsult.Close
    
End Select


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close

        'Consulta para obtener la direccion de la empresa
sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
Flog.writeline "Buscando datos de la direccion de la empresa"
Flog.writeline "Empresa" & EmpTernro & sql
OpenRecordset sql, rsConsult
        
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
End If

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,auxchar6,auxchar7) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & fecini & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Men_Jor & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & direccionemp & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & provincia & "'"
StrSql = StrSql & ",'" & Sexo & "'" 'nacionalidad
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & seccion & "'"
StrSql = StrSql & ",'" & AntiguedadReconocida & "'"
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  'StrSql = StrSql & ",'" & rsConsult!tconnro & "'"
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  
  'arrTipoConc (rsConsult!tconnro)
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
        
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para La Caja
'--------------------------------------------------------------------

Sub generarDatosEmpleado61(Pronro, Ternro, descripcion, orden)
'Es una copia del Modelo 53 Estandar con algunos campos que se agregaron para La Caja

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsInscripcion As New ADODB.Recordset
'Variables donde se guardan los datos del INSERT final

Dim Legajo As Long
Dim Apellido As String
Dim apellido2 As String
Dim Nombre As String
Dim nombre2 As String
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim fecpago As String
Dim formaPago As String
Dim empFecAlta
Dim fecalta As String
Dim fecbaja As String
Dim contrato As String
Dim Categoria As String
Dim Direccion As String
Dim Puesto As String
Dim documento  As String
Dim fecha_nac As String
Dim est_civil As String
Dim cuil As String
Dim estado
Dim reg_prev As String
Dim Lug_Trab  As String
Dim Lug_Pago As String
Dim basico As String
Dim neto As String
Dim msr As String
Dim asi_flia As String
Dim dtos As String
Dim bruto As String
Dim proFecPago
Dim proDesc
Dim pliqdesc
Dim pliqfecdep
Dim pliqbco
Dim terfecnac
Dim famfecvto
Dim famDGIdesde
Dim famDGIhasta
Dim cliqnro
Dim GuardarFam As Boolean
Dim pliqdesde As Date
Dim pliqhasta As Date
Dim agenciaEmpleado As Long
Dim AntiguedadReconocida As String

Dim Nacionalidad
Dim Sexo

Dim CentroCosto
Dim EmpTernro

Dim estrnomb1
Dim estrnomb2
Dim estrnomb3
Dim tenomb1
Dim tenomb2
Dim tenomb3
Dim OSocial As String
Dim Inscripcion
Dim Modelo

Dim sql As String
    
On Error GoTo MError

estrnomb1 = ""
estrnomb2 = ""
estrnomb3 = ""
tenomb1 = ""
tenomb2 = ""
tenomb3 = ""

Flog.writeline "Modelo 61"

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro '& " AND agencia is null "

Flog.writeline "Buscando datos del empleado"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Flog.writeline "                Legajo: " & rsConsult!empleg
   Nombre = rsConsult!ternom
   If IsNull(rsConsult!ternom2) Then
      nombre2 = ""
   Else
      nombre2 = rsConsult!ternom2
   End If
   Apellido = rsConsult!terape
   If IsNull(rsConsult!terape2) Then
      apellido2 = ""
   Else
      apellido2 = rsConsult!terape2
   End If
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecpago, proceso.prodesc, cabliq.cliqnro,tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND cabliq.empleado= " & Ternro

'---LOG---
Flog.writeline "Buscando datos del periodo"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   fecpago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecPago
   proDesc = rsConsult!proDesc
   pliqdesc = rsConsult!pliqdesc
   cliqnro = rsConsult!cliqnro
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "El empleado no se encuentra en el proceso"
   Exit Sub
End If

rsConsult.Close

'------------------------------------------------------------------
' Obtengo los datos de las estructuras
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de las estructuras"

 sql = " SELECT empfaltagr, empleado.empest, empfecbaja,estr1.estrdabr AS categoria, estr2.estrdabr AS contrato, estr3.estrdabr AS puesto, estr4.estrdabr AS regprev, estr5.estrdabr AS sucursal, estr6.estrdabr AS lugarpago "
 sql = sql & " FROM empleado "
 'Busco la categoria
 sql = sql & " LEFT JOIN his_estructura his1 ON his1.ternro = empleado.ternro AND his1.tenro = 304 AND empleado.ternro= " & Ternro & " AND his1.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his1.htethasta IS NULL OR his1.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr1 ON estr1.estrnro = his1.estrnro "
 'Busco el contrato
 sql = sql & " LEFT JOIN his_estructura his2 ON his2.ternro = empleado.ternro AND his2.tenro = 18 AND empleado.ternro= " & Ternro & " AND his2.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his2.htethasta IS NULL OR his2.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr2 ON estr2.estrnro = his2.estrnro "
 'Busco el puesto
 sql = sql & " LEFT JOIN his_estructura his3 ON his3.ternro = empleado.ternro AND his3.tenro = 4 AND empleado.ternro= " & Ternro & " AND his3.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his3.htethasta IS NULL OR his3.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr3 ON estr3.estrnro = his3.estrnro "
 'Busco el regimen previsional
 sql = sql & " LEFT JOIN his_estructura his4 ON his4.ternro = empleado.ternro AND his4.tenro = 15 AND empleado.ternro= " & Ternro & " AND his4.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his4.htethasta IS NULL OR his4.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr4 ON estr4.estrnro = his4.estrnro "
 'Busco la sucursal
 sql = sql & " LEFT JOIN his_estructura his5 ON his5.ternro = empleado.ternro AND his5.tenro = 1 AND empleado.ternro= " & Ternro & " AND his5.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his5.htethasta IS NULL OR his5.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr5 ON estr5.estrnro = his5.estrnro "
 'Busco el Lugar de Pago
 sql = sql & " LEFT JOIN his_estructura his6 ON his6.ternro = empleado.ternro AND his6.tenro = 20 AND empleado.ternro= " & Ternro & " AND his6.htetdesde <= " & ConvFecha(pliqhasta) & " AND (his6.htethasta IS NULL OR his6.htethasta >= " & ConvFecha(pliqhasta) & ") "
 sql = sql & " LEFT JOIN estructura estr6 ON estr6.estrnro = his6.estrnro "
 
 sql = sql & " WHERE empleado.ternro = " & Ternro

 OpenRecordset sql, rsConsult

 'Fecha Alta
 If IsNull(rsConsult!empfaltagr) Then
    fecalta = ""
 Else
    fecalta = rsConsult!empfaltagr
 End If
 Flog.writeline "Estructura Fecha de Alta: " & fecalta

 'Contrato
 If IsNull(rsConsult!contrato) Then
   contrato = ""
 Else
   contrato = rsConsult!contrato
 End If
 Flog.writeline "Estructura Contrato: " & contrato
 
 'Categoria
 If IsNull(rsConsult!Categoria) Then
   Categoria = ""
 Else
   Categoria = rsConsult!Categoria
 End If
 Flog.writeline "Estructura Categoria: " & Categoria
 
 'Reg. Prev.
 If IsNull(rsConsult!regprev) Then
   reg_prev = ""
 Else
   reg_prev = rsConsult!regprev
 End If
 Flog.writeline "Estructura Reg. Prev.: " & reg_prev
 
 'Sucursal
 If IsNull(rsConsult!sucursal) Then
   Lug_Trab = ""
 Else
   Lug_Trab = rsConsult!sucursal
 End If
 Flog.writeline "Estructura Lugar de Trabajo: " & Lug_Trab
 
 'Lugar de Pago
 If IsNull(rsConsult!lugarpago) Then
   Lug_Pago = ""
 Else
   Lug_Pago = rsConsult!lugarpago
 End If
 Flog.writeline "Estructura Lugar de Pago: " & Lug_Pago

 estado = rsConsult!empest
 Flog.writeline "Estado del Empleado: " & estado

 rsConsult.Close
 
 ' -------------------------------------------------------------------------
' Busco la fecha de baja
'--------------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de fecha de baja"

 StrSql = " SELECT altfec, bajfec "
 StrSql = StrSql & " FROM fases "
 StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec DESC"

 OpenRecordset StrSql, rsConsult

 If rsConsult.EOF Then
      fecbaja = ""
      Flog.writeline "No encontró fase real"
  Else
    If Not IsNull(rsConsult!bajfec) Then
       fecbaja = rsConsult!bajfec
    Else
        Flog.writeline "Fecha de baja nula. "
    End If
 End If
 
 rsConsult.Close
 
' -------------------------------------------------------------------------
' Busco la Antiguedad Reconocida
' Basado en las fases del tablero del empleado
'--------------------------------------------------------------------------

AntiguedadReconocida = ""
 
Flog.writeline "Buscando datos Obra Social"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
If Not rsConsult.EOF Then
    OSocial = rsConsult!estrdabr
Else
    OSocial = ""
End If
 Flog.writeline "Estructura Obra Social: " & OSocial

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos del centro de costo"

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
End If
 Flog.writeline "Estructura Centro de Costo: " & CentroCosto

rsConsult.Close
   
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 1"

If tenro1 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro1
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro1 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro1
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb1 = rsConsult!estrdabr
       tenomb1 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 2"

If tenro2 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro2
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro2 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro2
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb2 = rsConsult!estrdabr
       tenomb2 = rsConsult!tedabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos estructura 3"

If tenro3 <> 0 Then
    
    StrSql = " SELECT estrdabr, tedabr "
    StrSql = StrSql & " FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro "
    StrSql = StrSql & "    AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro = " & tenro3
    StrSql = StrSql & "    AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
    
    If estrnro3 <> 0 Then
        StrSql = StrSql & " AND estructura.estrnro = " & estrnro3
    End If
    
    StrSql = StrSql & "  INNER JOIN tipoestructura ON tipoestructura.tenro = his_estructura.tenro "
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       estrnomb3 = rsConsult!estrdabr
       tenomb3 = rsConsult!tedabr
    End If
End If
    
'------------------------------------------------------------------
'Busco el valor del fecha nac, cuil, doc y tipo doc
'------------------------------------------------------------------

'---LOG---
Flog.writeline "Buscando datos de los documentos"

sql = " SELECT tercero.terfecnac, cuil.nrodoc AS nrocuil, docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc, "
sql = sql & " estcivil.estcivdesabr, tersex, nacionalidad.nacionaldes "
sql = sql & " FROM tercero "
sql = sql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
sql = sql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
sql = sql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
sql = sql & " LEFT JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
sql = sql & " LEFT JOIN nacionalidad ON nacionalidad.nacionalnro=tercero.nacionalnro "
sql = sql & " WHERE tercero.ternro= " & Ternro

OpenRecordset sql, rsConsult

cuil = ""
documento = ""
fecha_nac = ""
est_civil = 0
Nacionalidad = ""

If Not rsConsult.EOF Then
   If IsNull(rsConsult!nrocuil) Then
        cuil = ""
   Else
        cuil = rsConsult!nrocuil
   End If
   Flog.writeline "Cuil del Empleado: " & cuil

   documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
   Flog.writeline "Documento del Empleado: " & documento

   fecha_nac = rsConsult!terfecnac
   Flog.writeline "Fecha de Nacimiento del Empleado: " & fecha_nac

   est_civil = rsConsult!estcivdesabr
   Flog.writeline "Estado Civil del Empleado: " & est_civil
   
   Sexo = rsConsult!tersex
   Flog.writeline "Sexo del Empleado: " & Sexo
   
   Nacionalidad = rsConsult!nacionaldes
   Flog.writeline "Nacionalidad del Empleado" & Nacionalidad

End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los acumuladores
'------------------------------------------------------------------

'Basico
If es_Acum_Basico Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Basico
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Basico
End If

'---LOG---
Flog.writeline "Buscando datos del basico"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   basico = 0
Else
   basico = rsConsult!almonto
End If
Flog.writeline "Basico del Empleado: " & basico

rsConsult.Close

'Neto
If es_Acum_Neto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Neto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Neto
End If

'---LOG---
Flog.writeline "Buscando datos del neto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   neto = 0
Else
   neto = rsConsult!almonto
End If
Flog.writeline "Neto del Empleado: " & neto

rsConsult.Close

'MSR
If es_Acum_Msr Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Msr
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Msr
End If
'---LOG---
Flog.writeline "Buscando datos del msr"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   msr = 0
Else
   msr = rsConsult!almonto
End If
Flog.writeline "MSR del Empleado: " & msr

rsConsult.Close

'Asig. Familia
If es_Acum_Asi_flia Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Asi_flia
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Asi_flia
End If

'---LOG---
Flog.writeline "Buscando datos de la asig. familia"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   asi_flia = 0
Else
   asi_flia = rsConsult!almonto
End If
Flog.writeline "Asignaciones Familiares del Empleado: " & asi_flia

rsConsult.Close

'Descuentos
If es_Acum_Dtos Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Dtos
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Dtos
End If

'---LOG---
Flog.writeline "Buscando datos de los descuentos"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   dtos = 0
Else
   dtos = rsConsult!almonto
End If
Flog.writeline "Descuentos del Empleado: " & dtos

rsConsult.Close

'Bruto
If es_Acum_Bruto Then
    sql = " SELECT almonto,acunro "
    sql = sql & " FROM acu_liq"
    sql = sql & " WHERE acunro = " & cod_Bruto
    sql = sql & " AND cliqnro =  " & cliqnro
Else
    sql = " SELECT detliq.dlimonto AS almonto "
    sql = sql & " FROM cabliq "
    sql = sql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    sql = sql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    sql = sql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & cod_Bruto
End If

'---LOG---
Flog.writeline "Buscando datos del bruto"

OpenRecordset sql, rsConsult

If rsConsult.EOF Then
   bruto = 0
Else
   bruto = rsConsult!almonto
End If
Flog.writeline "Bruto del Empleado: " & bruto

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

Direccion = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        sql = sql & " From his_estructura"
        sql = sql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(fecpago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecpago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        sql = sql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
            Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        sql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(fecEstr) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(fecEstr) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset sql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        sql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        sql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio,provincia.provdesc "
        sql = sql & " FROM  cabdom "
        sql = sql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        sql = sql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        sql = sql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
        sql = sql & " WHERE cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset sql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc & " - " & rsConsult!provdesc
        End If
        
        rsConsult.Close
    
End Select
Flog.writeline "Direccion: " & Direccion

'------------------------------------------------------------------
'Busco los datos de la Cuenta Bancaria
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la Cuenta Bancaria"

StrSql = " SELECT ctabnro, fpagdescabr, bandesc FROM ctabancaria "
StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro"
StrSql = StrSql & " WHERE "
StrSql = StrSql & " ctabancaria.ctabestado = -1 "
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

formaPago = ""
If Not rsConsult.EOF Then
    If rsConsult!bandesc <> "" Then
        formaPago = rsConsult!bandesc
    End If
    formaPago = formaPago & " - "
    Select Case UCase(rsConsult!fpagdescabr)
        Case "CUENTA CORRIENTE":
            formaPago = formaPago & "CC "
        Case "CAJA DE AHORRO":
            formaPago = formaPago & "CA "
    End Select
    If rsConsult!ctabnro <> "" Then
        formaPago = formaPago & rsConsult!ctabnro
    End If
End If
Flog.writeline "Forma de Pago: " & formaPago

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"

StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & emprNro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "Datos de las Cargas Sociales: " & pliqfecdep & " " & pliqbco
Else
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
' Numero de Inscripcion
'------------------------------------------------------------------

sql = " SELECT * FROM confrep "
sql = sql & " WHERE repnro = 61 "
sql = sql & " AND conftipo = 'TD'"
OpenRecordset sql, rsConsult
If Not rsConsult.EOF Then
    StrSql = " select nrodoc from ter_doc"
    StrSql = StrSql & " inner join tipodocu ON tipodocu.tidnro=ter_doc.tidnro"
    StrSql = StrSql & " inner join empresa ON empresa.ternro=ter_doc.ternro "
    StrSql = StrSql & " inner join estructura on estructura.estrnro = empresa.estrnro "
    StrSql = StrSql & " Where tipodocu.tidnro = '" & rsConsult!confval & "'"
    Flog.writeline "Se encontro Nro de Inscripcion"
Else
    StrSql = ""
    Inscripcion = 0
    Flog.writeline "No se encontro Nro de Inscripcion"
End If
rsConsult.Close

If StrSql <> "" Then
    OpenRecordset StrSql, rsInscripcion
    If Not rsInscripcion.EOF Then
        Inscripcion = rsInscripcion!NroDoc
        Flog.writeline "Nro de Inscripcion"
        Flog.writeline " Nro Inscripcion: " & Inscripcion
    Else
        Inscripcion = 0
        Flog.writeline "No Existe Nro de Inscripcion"
    End If
    rsInscripcion.Close
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

If IsNull(pliqfecdep) Then
   pliqfecdep = "NULL"
Else
   If Trim(pliqfecdep) = "" Then
      pliqfecdep = "NULL"
   Else
      pliqfecdep = ConvFecha(pliqfecdep)
   End If
End If

StrSql = " INSERT INTO rep_libroley "
StrSql = StrSql & " (bpronro , Legajo, ternro, pronro,"
StrSql = StrSql & " apellido , apellido2, nombre, nombre2,"
StrSql = StrSql & " empresa , emprnro, pliqnro, fecpago,"
StrSql = StrSql & " fecalta , fecbaja, contrato, categoria,"
StrSql = StrSql & " direccion , puesto, documento, fecha_nac,"
StrSql = StrSql & " est_civil , cuil, estado, reg_prev,"
StrSql = StrSql & " lug_trab , basico, neto, msr,"
StrSql = StrSql & " asi_flia , dtos, bruto, "
StrSql = StrSql & " prodesc , descripcion, pliqdesc, pliqmes, "
StrSql = StrSql & " pliqanio , profecpago, pliqfecdep, pliqbco,ultima_pag_impr, auxchar1, auxchar2, auxchar3, "
StrSql = StrSql & " estrdabr1,estrdabr2,estrdabr3,tedabr1,tedabr2,tedabr3,orden,auxchar4,auxdeci1,auxchar5,auxdeci2, "
StrSql = StrSql & " paghasta,tomo, auxchar6, auxdeci3) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & apellido2 & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & nombre2 & "'"
StrSql = StrSql & ",'" & empresa & "'"
StrSql = StrSql & "," & emprNro
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & ",'" & fecpago & "'"
StrSql = StrSql & ",'" & fecalta & "'"
StrSql = StrSql & ",'" & fecbaja & "'"
StrSql = StrSql & ",'" & contrato & "'"
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 50) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & documento & "'"
StrSql = StrSql & ",'" & fecha_nac & "'"
StrSql = StrSql & ",'" & est_civil & "'"
StrSql = StrSql & ",'" & cuil & "'"
StrSql = StrSql & "," & estado
StrSql = StrSql & ",'" & reg_prev & "'"
StrSql = StrSql & ",'" & Lug_Pago & "'"
StrSql = StrSql & "," & numberForSQL(basico)
StrSql = StrSql & "," & numberForSQL(neto)
StrSql = StrSql & "," & numberForSQL(msr)
StrSql = StrSql & "," & numberForSQL(asi_flia)
StrSql = StrSql & "," & numberForSQL(dtos)
StrSql = StrSql & "," & numberForSQL(bruto)
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Mid(descripcion, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & "," & ConvFecha(proFecPago)
StrSql = StrSql & "," & pliqfecdep
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & "," & Pagina
StrSql = StrSql & ",'" & emprCuit & "'"
StrSql = StrSql & ",'" & emprDire & "'"
StrSql = StrSql & ",'" & emprActiv & "'"
StrSql = StrSql & "," & controlNull(estrnomb1)
StrSql = StrSql & "," & controlNull(estrnomb2)
StrSql = StrSql & "," & controlNull(estrnomb3)
StrSql = StrSql & "," & controlNull(tenomb1)
StrSql = StrSql & "," & controlNull(tenomb2)
StrSql = StrSql & "," & controlNull(tenomb3)
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",0"
StrSql = StrSql & ",'" & formaPago & "'"
StrSql = StrSql & "," & Inscripcion
StrSql = StrSql & "," & tope
StrSql = StrSql & "," & tomo
StrSql = StrSql & ",'" & Nacionalidad & "'"
StrSql = StrSql & "," & Sexo
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Busco el detalle de la liquidacion
'------------------------------------------------------------------

StrSql = " SELECT concepto.concabr, concepto.conccod, concepto.concnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,concepto.tconnro " & _
    " FROM cabliq " & _
    " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND proceso.pronro = " & Pronro & _
    " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro " & _
    " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & _
    " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 " & _
    " ORDER BY concepto.conccod "

'---LOG---
Flog.writeline "Buscando datos del detalle de liquidacion"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

  StrSql = " INSERT INTO rep_libroley_det "
  StrSql = StrSql & " (bpronro, ternro, pronro, concabr,"
  StrSql = StrSql & " conccod ,concnro , concimp , dlicant,"
  StrSql = StrSql & " dlimonto,conctipo) "
  StrSql = StrSql & " VALUES "
  StrSql = StrSql & "(" & NroProceso
  StrSql = StrSql & "," & Ternro
  StrSql = StrSql & "," & Pronro
  StrSql = StrSql & ",'" & rsConsult!concabr & "'"
  StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
  StrSql = StrSql & "," & rsConsult!ConcNro
  StrSql = StrSql & "," & rsConsult!concimp
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
  StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
  StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "'"
  StrSql = StrSql & ")"
  
  objConn.Execute StrSql, , adExecuteNoRecords

  rsConsult.MoveNext
  
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de los familiares
'------------------------------------------------------------------

If (tipoFamiliares = "1") Or (tipoFamiliares = "2") Then

    StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc,tercero.ternro,tercero.terape, tercero.ternom, tercero.terfecnac, tercero.tersex, famest,famtrab,faminc,famDGIdesde " & _
          " famsalario, famfecvto, famCargaDGI, famDGIdesde, famDGIhasta, famemergencia, " & _
          " paredesc " & _
          " FROM  tercero INNER JOIN familiar ON tercero.ternro=familiar.ternro " & _
          " LEFT JOIN parentesco ON familiar.parenro=parentesco.parenro " & _
          " LEFT JOIN ter_doc docu ON (docu.ternro= familiar.ternro and docu.tidnro>0 and docu.tidnro<5) " & _
          " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro " & _
          " WHERE familiar.famest = -1 AND familiar.empleado = " & Ternro

    '---LOG---
    Flog.writeline "Buscando datos de los familiares"
    
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
    
      GuardarFam = True
    
      If (tipoFamiliares = "2") Then
          GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg, cliqnro, concFamiliar01)
          If Not GuardarFam Then
             GuardarFam = HayAsignacionesFliares(pliqdesde, pliqhasta, Ternro, rsConsult!Ternro, NroBusqProg2, cliqnro, concFamiliar02)
          End If
      End If
    
      If GuardarFam Then
      
          If IsNull(rsConsult!terfecnac) Then
             terfecnac = "NULL"
          Else
             terfecnac = ConvFecha(rsConsult!terfecnac)
          End If
        
          If IsNull(rsConsult!famfecvto) Then
             famfecvto = "NULL"
          Else
             famfecvto = ConvFecha(rsConsult!famfecvto)
          End If
        
          If IsNull(rsConsult!famDGIdesde) Then
             famDGIdesde = "NULL"
          Else
             famDGIdesde = ConvFecha(rsConsult!famDGIdesde)
          End If
          
          If IsNull(rsConsult!famDGIhasta) Then
             famDGIhasta = "NULL"
          Else
             famDGIhasta = ConvFecha(rsConsult!famDGIhasta)
          End If
          
          Flog.writeline "Buscando datos de los familiares antes de insertar"
           
          StrSql = " INSERT INTO rep_libroley_fam "
          StrSql = StrSql & " (bpronro, ternro , pronro, nrodoc,"
          StrSql = StrSql & " sigladoc, ternrofam, terape, ternom,"
          StrSql = StrSql & " terfecnac , tersex, famest, famtrab,"
          StrSql = StrSql & " faminc, famsalario, famfecvto, famCargaDGI,"
          StrSql = StrSql & " famDGIdesde , famDGIhasta, famemergencia, paredesc"
          StrSql = StrSql & " ) "
          StrSql = StrSql & " VALUES "
          StrSql = StrSql & "(" & NroProceso
          StrSql = StrSql & "," & Ternro
          StrSql = StrSql & "," & Pronro
          StrSql = StrSql & ",'" & rsConsult!NroDoc & "'"
          StrSql = StrSql & ",'" & rsConsult!sigladoc & "'"
          StrSql = StrSql & "," & rsConsult!Ternro
          StrSql = StrSql & ",'" & rsConsult!terape & "'"
          StrSql = StrSql & ",'" & rsConsult!ternom & "'"
          StrSql = StrSql & "," & terfecnac
          StrSql = StrSql & "," & strForSQL(rsConsult!tersex)
          StrSql = StrSql & "," & strForSQL(rsConsult!famest)
          StrSql = StrSql & "," & strForSQL(rsConsult!famtrab)
          StrSql = StrSql & "," & strForSQL(rsConsult!faminc)
          StrSql = StrSql & "," & strForSQL(rsConsult!famsalario)
          StrSql = StrSql & "," & famfecvto
          StrSql = StrSql & "," & strForSQL(rsConsult!famCargaDGI)
          StrSql = StrSql & "," & famDGIdesde
          StrSql = StrSql & "," & famDGIhasta
          StrSql = StrSql & "," & strForSQL(rsConsult!famemergencia)
          StrSql = StrSql & ",'" & rsConsult!paredesc & "'"
          StrSql = StrSql & ")"
          
          objConn.Execute StrSql, , adExecuteNoRecords
          
      End If
    
      rsConsult.MoveNext
      
    Loop
    
    rsConsult.Close

End If

Exit Sub

MError:
    Flog.writeline "Error en empleado: " & Legajo & " Error: " & Err.Description
    HuboErrores = True
    EmpErrores = True
    Exit Sub
End Sub

