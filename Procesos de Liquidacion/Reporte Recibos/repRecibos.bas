Attribute VB_Name = "repRecibos"
        Option Explicit

' Las versiones se llevaron al modulo de versiones(local en la carpeta del recibos)
'--------------------------------------------------------------------------------------
'--------------------------------------------------------------------------------------

Dim fs, f
'Global Flog

'11/03/2004 - Scarpa D. - Correccion al buscar el monto del sueldo


Dim NroLinea As Long
Dim crpNro As Long
Dim RegLeidos As Long
Dim RegError As Long
Dim RegFecha As Date
Global NroProceso As Long

Global Path As String
Global NArchivo As String
Global Rta
Global HuboErrores As Boolean
Global EmpErrores As Boolean
Global arrTipoConc(1 To 1000) As Long
Global arrtipoestructura(1 To 100) As Long

Global tenro1 As Long
Global estrnro1 As Long
Global tenro2 As Long
Global estrnro2 As Long
Global tenro3 As Long
Global estrnro3 As Long
Global fecEstr As String
Global tipoRecibo As Long
Global acumSubTotalRemun As Long
Global zonaDomicilio0
Global zonaDomicilio1
Global zonaDomicilio2
Global ConcImpIRPF
Global ConcImpDescuentoIRPF
Global Tickets As Long
Global Gratificacion As Long
Global ValNetoTalon As Long
Global SueldoRecibo As Long
Global esSueldoRecibo As Long
Global esTicketsConc As Long
Global esSueldoConc As Long
Global esGratificacionConc As Long
Global TicketsNeto
Global TicketsBruto

Global tidDNRP

Global acumGrupo1(1 To 100) As Long
Global acumGrupo2(1 To 100) As Long
Global acumGrupo3(1 To 100) As Long
Global cantAcumGrupo1 As Long
Global cantAcumGrupo2 As Long
Global cantAcumGrupo3 As Long

Global acumHaberesConAp
Global acumNetoImp
Global acumRetImpuesto

Global ConceptoHsExtra
Global ConcBaseTributable
Global SueldoDelMes
Global ConcDiasTrabajados
Global ConcAFC_Empresa
Global ConcPactado_ISAPRE

Global acumAuxDeci1
Global acumAuxDeci2
Global acumAuxDeci3

Global concnroVacPend As Long
Global paramVacPend As Long

Global arrFormaPago(1 To 1000) As Long
'28/04/2008 - Martin Ferraro - Se paso a global
Global generoRecibo As Boolean

Global acunroPlanSalud
Global acunroBruto
Global acunroImponible
Global acunroTributable
Global acunroDescLegales
Global acunroOtrosDesc
Global acunroTotDesc
Global acunroSueldoLiq

Global concPorcDesa

Global esPlanSaludConc
Global esBrutoConc
Global esImponibleConc
Global esTributableConc
Global esDescLegalesConc
Global esOtrosDescConc
Global esTotDescConc
Global esSueldoLiqConc

'05/09/2011 -Carmen Quintero - Recibo de Sueldo Portugal
Global conCantidadHoras As String
Global acuValorDevolver
Global conRegMesAnterior As String
Global acuTotalBaseIrs
Global acuIrsSujeto
Global acuIrsRetenido
'19/03/2012 - Gonzalez Nicolás - Recibo de Sueldo Portugal
Global SegSocAcum
Global IRSAcumulado
Global QuotaSindical
'26/03/2012 - Gonzalez Nicolás - Recibo de Sueldo Portugal
Global QtdeGFerias

'19/09/2011 - sebastian stremel - recibo de sueldo deloitte
Global cargo
Global sBase
Global esSueldoBase
'11/07/2014 - Carmen Quintero - Recibo de punto farma
Global TipoEstrConf

'==============================================================================================
'==============================================================================================

Private Sub Main()

Dim NombreArchivo As String
Dim directorio As String
Dim CArchivos
Dim archivo
Dim Folder
Dim strCmdLine As String
Dim Nombre_Arch As String

Dim StrSql As String
Dim objRs As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim objRs3 As New ADODB.Recordset
Dim fechadesde
Dim fechahasta
Dim tipoDepuracion
Dim historico As Boolean
Dim param
Dim listapronro
Dim Pronro
Dim Ternro
Dim arrpronro
Dim rsEmpl As New ADODB.Recordset
Dim acunroSueldo
Dim I
Dim totalEmpleados
Dim cantRegistros
Dim PID As String
Dim tituloReporte As String
Dim parametros As String
Dim ArrParametros
Dim strTempo As String
Dim orden
    
    strCmdLine = Command()
    ArrParametros = Split(strCmdLine, " ", -1)
    If UBound(ArrParametros) > 1 Then
        If IsNumeric(ArrParametros(0)) Then
            NroProcesoBatch = ArrParametros(0)
            Etiqueta = ArrParametros(1)
            EncriptStrconexion = CBool(ArrParametros(2))
            c_seed = ArrParametros(2)
        Else
            Exit Sub
        End If
    Else
        If UBound(ArrParametros) > 0 Then
            If IsNumeric(ArrParametros(0)) Then
                NroProcesoBatch = ArrParametros(0)
                Etiqueta = ArrParametros(1)
            Else
                Exit Sub
            End If
        Else
            If IsNumeric(strCmdLine) Then
                NroProcesoBatch = strCmdLine
            Else
                Exit Sub
            End If
        End If
    End If

    
    NroProceso = NroProcesoBatch
    

    ' carga las configuraciones basicas, formato de fecha, string de conexion,
    ' tipo de BD y ubicacion del archivo de log
    Call CargarConfiguracionesBasicas
    tituloReporte = ""

    TiempoInicialProceso = GetTickCount

    Nombre_Arch = PathFLog & "RecibosSueldo" & "-" & NroProceso & ".log"
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set Flog = fs.CreateTextFile(Nombre_Arch, True)
    
    Flog.writeline "Inicio Proceso de Recibos de Sueldo : " & Now
    Flog.writeline "Cambio el estado del proceso a Procesando"
   
    'Obtengo el Process ID
    PID = GetCurrentProcessId
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline "Version = " & Version
    Flog.writeline "Modificacion = " & UltimaModificacion
    Flog.writeline "Fecha = " & FechaModificacion
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline

    On Error Resume Next
    OpenConnection strconexion, objConn
    If Err.Number <> 0 Or Error_Encrypt Then
        Flog.writeline Espacios(Tabulador * 0) & "Problemas en la conexion"
        Exit Sub
    End If

    OpenConnection strconexion, objconnProgreso
    If Err.Number <> 0 Or Error_Encrypt Then
        Flog.writeline Espacios(Tabulador * 0) & "Problemas en la conexion"
        Exit Sub
    End If

    HuboErrores = False
    On Error GoTo CE
    
    'Obtengo la cantidad de empledos a procesar
    StrSql = "SELECT * FROM batch_proceso WHERE bpronro = " & NroProceso
    OpenRecordset StrSql, objRs
    
    cantRegistros = CLng(objRs!bprcempleados)
    totalEmpleados = cantRegistros
    
    objRs.Close
   
    
    
    'Cambio el estado del proceso a Procesando
    StrSql = "UPDATE batch_proceso SET bprchorainicioej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecinicioej = " & ConvFecha(Date) & ", bprcestado = 'Procesando', bprcprogreso = 0, bprcpid = " & PID & " WHERE bpronro = " & NroProceso
    objConn.Execute StrSql, , adExecuteNoRecords
    
    Flog.writeline "Obtengo los datos del proceso"
    
    TiempoAcumulado = GetTickCount
    
    'Obtengo los datos del proceso
    StrSql = "SELECT * FROM batch_proceso WHERE bpronro = " & NroProceso
    OpenRecordset StrSql, objRs
    
    If Not objRs.EOF Then
       'Obtengo los parametros del proceso
       parametros = objRs!bprcparam
       
       Flog.writeline "Parametros del proceso: " & parametros
       
       ArrParametros = Split(parametros, "@")
       
       'Obtengo la lista de procesos
       listapronro = ArrParametros(0)
       
       tipoRecibo = CLng(ArrParametros(1))
       
       tenro1 = CLng(ArrParametros(2))
       estrnro1 = CLng(ArrParametros(3))
       tenro2 = CLng(ArrParametros(4))
       estrnro2 = CLng(ArrParametros(5))
       tenro3 = CLng(ArrParametros(6))
       estrnro3 = CLng(ArrParametros(7))
       fecEstr = ArrParametros(8)
       
       'Armo el titulo del reporte
       strTempo = ArrParametros(9)
       
       ArrParametros = Split(strTempo, "<br>")
       If UBound(ArrParametros) >= 1 Then
          tituloReporte = ArrParametros(1)
       Else
          tituloReporte = ""
       End If
       
       ArrParametros = Split(ArrParametros(0), "- Periodos")
       tituloReporte = ArrParametros(0) & tituloReporte
       
       'EMPIEZA EL PROCESO
       
       'Busco la configuracion del confrep
       Flog.writeline "Obtengo los datos del confrep"
       
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60"
       OpenRecordset StrSql, objRs2
       If objRs2.EOF Then
          Flog.writeline "No esta configurado el ConfRep"
          Exit Sub
       End If

       acunroSueldo = 0
       zonaDomicilio0 = 1
       zonaDomicilio1 = 1
       zonaDomicilio2 = 1
       tidDNRP = 0
       cantAcumGrupo1 = 0
       cantAcumGrupo2 = 0
       cantAcumGrupo3 = 0
       
       concnroVacPend = 0
       paramVacPend = 0
       
       esTicketsConc = True
       TicketsBruto = 0
       TicketsNeto = 0
       Tickets = 0
       esGratificacionConc = True
       Gratificacion = 0
       
       ValNetoTalon = 0
       
       esSueldoRecibo = True
       SueldoRecibo = 0
       
       acumHaberesConAp = 0
       acumNetoImp = 0
       acumRetImpuesto = 0
       
       acumAuxDeci1 = 0
       acumAuxDeci2 = 0
       acumAuxDeci3 = 0
       
       '11/07/2014 recibo de punto farma
       TipoEstrConf = ""
       

       
       Do Until objRs2.EOF
          Flog.writeline "Columna " & objRs2!confnrocol
          Select Case objRs2!confnrocol
             Case 1
                'Busco en el confrep el numero de cuenta que se va a usar para
                'buscar el valor del sueldo
                If objRs2!conftipo = "CO" Then
                   esSueldoConc = True
                  
                    StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     acunroSueldo = 0
                   Else
                     acunroSueldo = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   esSueldoConc = False
                   acunroSueldo = objRs2!confval
                End If
             
             Case 30
                'zonaDomicilio 0
                zonaDomicilio0 = objRs2!confval
             Case 31
                'zonaDomicilio 1
                zonaDomicilio1 = objRs2!confval
             Case 32
                'zonaDomicilio 2
                zonaDomicilio2 = objRs2!confval
             Case 37
                'Concepto de Monto Imponible para IRPF
                ConcImpIRPF = objRs2!confval2
             Case 38
                'Concepto de Monto Imponible para Deducciones IRPF
                ConcImpDescuentoIRPF = objRs2!confval2
             Case 39
                'Concepto de Tickets Bruto
                TicketsBruto = objRs2!confval2
             Case 40
                'Concepto de Tickets Neto
                TicketsNeto = objRs2!confval2
             Case 41
                'Nro. de tipo de documento del DNRP
                tidDNRP = objRs2!confval
             Case 42
                'Concepto o Acum de Tickets
                If objRs2!conftipo = "CO" Then
                   esTicketsConc = True
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     Tickets = 0
                   Else
                     Tickets = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   esTicketsConc = False
                   Tickets = objRs2!confval
                End If
             
             Case 43
                'Concepto o Acum de Gratificaciones
                Gratificacion = objRs2!confval2
                If objRs2!conftipo = "CO" Then
                   esGratificacionConc = True
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     Gratificacion = 0
                   Else
                     Gratificacion = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   esGratificacionConc = False
                   Gratificacion = objRs2!confval
                End If
             Case 44
                'Concepto o Acum de Sueldo
                SueldoRecibo = objRs2!confval2
                If objRs2!conftipo = "CO" Then
                  
                   StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    If Not EsNulo(objRs2!confval2) Then
                        StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                    End If
                   OpenRecordset StrSql, objRs3
                  
                   If objRs3.EOF Then
                     SueldoRecibo = 0
                   Else
                     SueldoRecibo = objRs3!ConcNro
                   End If
                  
                   objRs3.Close
                Else
                   esSueldoRecibo = False
                   SueldoRecibo = objRs2!confval
                End If
             Case 45
                'Concepto o Acum de Neto de Talon
                ValNetoTalon = objRs2!confval
             Case 46
                'Nro de Concepto de HS Extras
                ConceptoHsExtra = objRs2!confval
             Case 47
                'Nro de Concepto de la Base Tributable
                ConcBaseTributable = objRs2!confval2
             Case 48
                'Nro de Concepto del Sueldo del Mes
                SueldoDelMes = objRs2!confval2
             Case 49
                'Busco el Concepto de Dias Trabajados
                ConcDiasTrabajados = objRs2!confval2
             Case 50
                'acumGrupo 1
                cantAcumGrupo1 = cantAcumGrupo1 + 1
                acumGrupo1(cantAcumGrupo1) = objRs2!confval
             Case 51
                'acumGrupo 2
                cantAcumGrupo2 = cantAcumGrupo2 + 1
                acumGrupo2(cantAcumGrupo2) = objRs2!confval
             Case 52
                'acumGrupo 3
                cantAcumGrupo3 = cantAcumGrupo3 + 1
                acumGrupo3(cantAcumGrupo3) = objRs2!confval
             Case 53
                  'Busco el concnro del concepto
                  StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                  If Not EsNulo(objRs2!confval2) Then
                    StrSql = StrSql & " OR conccod = '" & objRs2!confval2 & "'"
                  End If
                  OpenRecordset StrSql, objRs3
                  
                  If objRs3.EOF Then
                     concnroVacPend = 0
                  Else
                     concnroVacPend = objRs3!ConcNro
                  End If
                  
                  objRs3.Close
             Case 54
                paramVacPend = objRs2!confval
             Case 55
                ConcPactado_ISAPRE = objRs2!confval2
             Case 56
                ConcAFC_Empresa = objRs2!confval2
             Case 60
                'Busco el acumulador de haberes con aportes
                acumHaberesConAp = objRs2!confval
                
             Case 61
                'Busco el acumulador de netos imponibles
                acumNetoImp = objRs2!confval
                
             Case 62
                'Busco el acumulador de ret. impuesto
                acumRetImpuesto = objRs2!confval
                
             Case 80
                'Busco el acumulador de acumAuxDeci1
                acumAuxDeci1 = objRs2!confval
                
             Case 81
                'Busco el acumulador de acumAuxDeci2
                acumAuxDeci2 = objRs2!confval
                
             Case 82
                'Busco el acumulador de acumAuxDeci3
                acumAuxDeci3 = objRs2!confval
                
             Case 90
                'Busco el valor de la cantidad de horas para portugal
                If objRs2!conftipo = "CO" Then
                    StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & objRs2!confval2 & "'"
                    OpenRecordset StrSql, objRs3
                    
                    If objRs3.EOF Then
                      conCantidadHoras = 0
                    Else
                      conCantidadHoras = objRs3!ConcNro
                    End If
                    objRs3.Close
                End If
                
             Case 91
                'Busco el acumulador de valor a devolver para portugal
                If objRs2!conftipo = "AC" Then
                    acuValorDevolver = objRs2!confval
                End If
                
             Case 92
                'Busco el acumulador del reg. mes anterior para portugal
                If objRs2!conftipo = "CO" Then
                    StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & objRs2!confval2 & "'"
                    OpenRecordset StrSql, objRs3
                    
                    If objRs3.EOF Then
                      conRegMesAnterior = 0
                    Else
                      conRegMesAnterior = objRs3!ConcNro
                    End If
                    objRs3.Close
                End If
                
             Case 93
                'Busco el acumulador del total isr para portugal
                If objRs2!conftipo = "AC" Then
                    acuTotalBaseIrs = objRs2!confval
                End If
                
             Case 94
                'Busco el acumulador del isr sujeto para portugal
                 If objRs2!conftipo = "AC" Then
                    acuIrsSujeto = objRs2!confval
                End If
                
             Case 95
                'Busco el acumulador del isr retenido para portugal
                If objRs2!conftipo = "AC" Then
                    acuIrsRetenido = objRs2!confval
                End If
             Case 96
                'AC - Seg. Social Acum - Portugal
                If objRs2!conftipo = "AC" Then
                    SegSocAcum = objRs2!confval
                End If
                
            Case 97
                'AC - IRS Acumulado - Portugal
                If objRs2!conftipo = "AC" Then
                    IRSAcumulado = objRs2!confval
                End If
            Case 98
                'AC - Quota Sindical - Portugal
                If objRs2!conftipo = "AC" Then
                    QuotaSindical = objRs2!confval
                End If
                
            Case 99
                'AC - Qtde gozo Férias - Portugal
                If objRs2!conftipo = "AC" Then
                    QtdeGFerias = objRs2!conftipo & "@" & objRs2!confval
                ElseIf objRs2!conftipo = "CO" Then
                    'QtdeGFerias = objRs2!conftipo & "@" & objRs2!confval2
                    QtdeGFerias = objRs2!conftipo
                '16/08/2012 NG
                    StrSql = "SELECT concnro FROM concepto WHERE conccod = " & objRs2!confval
                    OpenRecordset StrSql, objRs3
                    If objRs3.EOF Then
                        QtdeGFerias = QtdeGFerias & "@0"
                    Else
                        QtdeGFerias = QtdeGFerias & "@" & objRs3!ConcNro
                    End If
                '----
                End If
            Case 356
                'Busco el tipo de estructura a mostrar en el recibo de punto farma
                '11/07/2014 Carmen Quintero
                 If objRs2!conftipo = "TE" Then
                    TipoEstrConf = objRs2!confval
                End If
                
          End Select
       
          objRs2.MoveNext
       Loop
       
       objRs2.Close
       
       'Inicializo los tipos de conceptos
       For I = 1 To 1000
           arrTipoConc(I) = 0
       Next

       Flog.writeline "Busco el tipo de cada concepto "
       'Busco el tipo de cada concepto
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60 "
       OpenRecordset StrSql, objRs2
       acumSubTotalRemun = 0

       Do Until objRs2.EOF
           Flog.writeline "Tipo encontrado " & objRs2!conftipo & " en Columna: " & objRs2!confnrocol
           Select Case objRs2!conftipo
              'Remunerativo
              Case "RE"
                 arrTipoConc(objRs2!confval) = 1
              'No Remunerativo
              Case "NR"
                 arrTipoConc(objRs2!confval) = 2
              'Descuento
              Case "DS"
                 arrTipoConc(objRs2!confval) = 3
              'Sub. Total Remunerativo
              Case "ST"
                 acumSubTotalRemun = objRs2!confval
              Case "TL"
                 arrTipoConc(objRs2!confval) = 4
           End Select
        
           objRs2.MoveNext
        Loop
        
        objRs2.Close
        
       'Inicializo las forma de pago
       For I = 1 To 1000
           arrFormaPago(I) = 0
       Next

       'Busco el tipo de cada concepto
       
       StrSql = " SELECT * FROM confrep "
       StrSql = StrSql & " WHERE repnro = 60 AND confnrocol >= 60"

       OpenRecordset StrSql, objRs2
       
       acumSubTotalRemun = 0

       Do Until objRs2.EOF
           
           If objRs2!conftipo = "FP" Then
              Flog.writeline "FP encontrada en Columna " & objRs2!confnrocol & " con valor " & objRs2!confval2
              arrFormaPago(objRs2!confval) = objRs2!confval2
           End If
        
           objRs2.MoveNext
       Loop
       objRs2.Close
        
        
       'Obtengo los empleados sobre los que tengo que generar los recibos
       Flog.writeline "Obtengo los empleados sobre los que tengo que generar los recibos"
       Call CargarEmpleados(NroProceso, rsEmpl)
       
       Flog.writeline "Inicializo progreso"
       StrSql = "UPDATE batch_proceso SET bprcprogreso = 0 " & _
                   ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                   ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
       objconnProgreso.Execute StrSql, , adExecuteNoRecords
       
       orden = 0
       
       Flog.writeline "Genero por cada empleado un recibo de sueldo"
       'Genero por cada empleado un recibo de sueldo
       Do Until rsEmpl.EOF
          Flog.writeline "Lista de procesos " & listapronro
          Flog.writeline "tercero " & rsEmpl!Ternro
          
          arrpronro = Split(listapronro, ",")
          EmpErrores = False
          Ternro = rsEmpl!Ternro
          generoRecibo = False
                    
          'Genero un recibo de sueldo para el empleado por cada proceso
          Flog.writeline "Genero un recibo de sueldo para el empleado por cada proceso"
          'Flog.writeline "Tipo de reciboooooooo: " & tipoRecibo & UBound(arrpronro)
          For I = 0 To UBound(arrpronro)
             Pronro = arrpronro(I)
             
             If tieneConceptosImprimibles(Ternro, Pronro) Then
                Flog.writeline "Generando recibo de sueldo para el tercero " & Ternro & " para el proceso " & Pronro
                generoRecibo = True
             
                'De acuerdo al tipo del recibo son los datos que se guardan en la tabla
                Flog.writeline "Tipo de recibo: " & tipoRecibo
                Select Case tipoRecibo
                 Case 1
                    'Generacion del recibo estandar
                    Call generarDatosRecibo01(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 2
                    'Generacion del recibo para Temaiken
                    Call generarDatosRecibo02(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 3
                    'Generacion del recibo para Accor
                    Call generarDatosRecibo03(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 4
                    'Generacion del recibo para Jugos
                    Call generarDatosRecibo04(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 5
                    'Generacion del recibo para Citrusvil
                    Call generarDatosRecibo05(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 6
                    'Generacion del recibo para Dabra
                    Call generarDatosRecibo06(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 7
                    'Generacion del recibo para TelePerformance
                    Call generarDatosRecibo07(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 8
                    'Generacion del recibo para Norton
                    Call generarDatosRecibo08(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 9
                    'Generacion del recibo para Deloitte - con Zona Domicilio 0
                    Call generarDatosRecibo09(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 10
                    'Generacion del recibo para Deloitte - con Zona Domicilio 1
                    Call generarDatosRecibo09(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio1)
                 Case 11
                    'Generacion del recibo para Deloitte - con Zona Domicilio 2
                    Call generarDatosRecibo09(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio2)
                 Case 12
                    'Generacion del recibo para Gestion Compartida
                    Call generarDatosRecibo12(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 13
                    'Generacion del recibo para Halliburton
                    Call generarDatosRecibo13(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 14
                    'Generacion del recibo de Indura
                    Call generarDatosRecibo14(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 15
                    'Generacion del recibo para Roche - con Zona Domicilio 0
                    Call generarDatosRecibo15(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 16
                    'Generacion del recibo para Roche - con Zona Domicilio 1
                    Call generarDatosRecibo15(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio1)
                 Case 17
                    'Generacion del recibo para Roche - con Zona Domicilio 2
                    Call generarDatosRecibo15(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio2)
                 Case 18
                    'Generacion del recibo para Estrada
                    Call generarDatosRecibo18(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 19
                    'Generacion del recibo para IMSA
                    Call generarDatosRecibo19(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 20
                    'Generacion del recibo para Roche 2
                    Call generarDatosRecibo20(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                 Case 21
                    'Generacion del recibo para Flecha Bus
                    Call generarDatosRecibo21(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 22
                    'Generacion del recibo para Uruguay
                    Call generarDatosRecibo22(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 23
                    'Generacion del recibo para Deloitte Personal
                    Call generarDatosRecibo23(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 24
                    'Generacion del recibo para Las Lenas
                    Call generarDatosRecibo24(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 25
                    'Generacion del recibo para TTI
                    Call generarDatosRecibo25(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 26
                    'Generacion del recibo para Schering
                    Call generarDatosRecibo26(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 27
                    'Generacion del recibo para Indra
                    Call generarDatosRecibo27(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 28
                    'Generacion del recibo para TTI - Edenor
                    Call generarDatosRecibo28(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 29
                    'Generacion del recibo para Glencore
                    Call generarDatosRecibo29(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 30
                    'Generacion del recibo para Tetrapak
                    Call generarDatosRecibo30(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 31
                    'Generacion del recibo para Cia. Alimentos
                    Call generarDatosRecibo31(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 32
                    'Generacion del recibo para Sitel
                    Call generarDatosRecibo32(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 33
                    'Generacion del recibo para Bazar Avenida
                    Call generarDatosRecibo33(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 34
                    'Generacion del recibo para Ampacet
                    Call generarDatosRecibo34(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 35
                    'Generacion del recibo para Andreani Logistica
                    Call generarDatosRecibo35(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 36
                    'Generacion del recibo para Wella
                    Call generarDatosRecibo36(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 37
                    'Generacion del recibo para Telearte
                    Call generarDatosRecibo37(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 38
                    'Generacion del recibo para Carsa
                    Call generarDatosRecibo38(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 39
                    'Generacion del recibo para Marsh
                    Call generarDatosRecibo39(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 40
                    'Generacion del recibo para BIA (Banco Industrial Azul)
                    Call generarDatosRecibo40(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 41
                    'Generacion del recibo para Paolini
                    Call generarDatosRecibo41(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 42
                    'Generacion del recibo para Red Megatone
                    Call generarDatosRecibo42(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 43
                    'Generacion del recibo para BNP Paribas Argentina
                    Call generarDatosRecibo43(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 44
                    'Generacion del recibo para LIGGETT
                    Call generarDatosRecibo44(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 45
                    'Generacion del recibo para REDEPA
                    Call generarDatosRecibo45(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 46
                    'Generacion del recibo para Distribuidora Metropolitana
                    Call generarDatosRecibo46(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 48
                    'Generacion del recibo para Codere
                    Call generarDatosRecibo48(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 49
                    'Generacion del recibo para nueva version tetra
                    Call generarDatosRecibo49(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 50
                    'Generacion del recibo para Divino - Uruguay
                    Call generarDatosRecibo50(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 51
                    'Generacion del recibo para Darmex
                    Call generarDatosRecibo51(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 52
                    'Generacion del recibo para Aadi-Capif
                    Call generarDatosRecibo52(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 53
                    'Generacion del recibo para Mercado Central
                    Call generarDatosRecibo53(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 54
                    'Generacion del recibo para L'Union de Paris
                    Call generarDatosRecibo54(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 55
                    'Generacion del recibo para CCU
                    Call generarDatosRecibo55(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 56
                    'Generacion del recibo para CCU - Finca
                    Call generarDatosRecibo56(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 57
                    'Generacion del recibo para Latin
                    Call generarDatosRecibo57(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 58
                    'Generacion del recibo de Horvath
                    Call generarDatosRecibo58(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 59
                    'Generacion del recibo de Praxair
                    Call generarDatosRecibo59(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 60
                    'Generacion del recibo de Gedas
                    Call generarDatosRecibo60(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 61
                    'Generacion del recibo de AGD
                    Call generarDatosRecibo61(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 62
                    'Generacion del recibo de A.C.A.R.A.
                    Call generarDatosRecibo62(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 63
                    'Generacion del recibo de EKI
                    Call generarDatosRecibo63(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 64
                    'Generacion del recibo de Gorina
                    Call generarDatosRecibo64(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 65
                    'Generacion del recibo de APEX
                    Call generarDatosRecibo65(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 66
                    'Generacion del recibo de TELEPERFORMANCE CHILE
                    Call generarDatosRecibo66(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 67
                    'Generacion del recibo de PRAXAIR ARG
                    Call generarDatosRecibo67(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 68
                    'Generacion del recibo de PHA
                    Call generarDatosRecibo68(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 69
                    'Generacion del recibo de San Martin de Tabacal
                    Call generarDatosRecibo69(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 70
                    'Generacion del recibo de Provincia Seguros
                    Call generarDatosRecibo70(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 71
                    'Generacion del recibo de Alta Plastica
                    Call generarDatosRecibo71(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 72
                    'Generacion del recibo de Zarcam
                    Call generarDatosRecibo72(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 73
                    'Generacion del recibo de PapelBril
                    Call generarDatosRecibo73(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 74
                    'Generacion del recibo de Praxail Chile
                    Call generarDatosRecibo74(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 75
                      'Generacion del recibo de Arlei
                    Call generarDatosRecibo75(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 76
                      'Generacion del recibo de Santana
                    Call generarDatosRecibo76(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 77
                      'Generacion del recibo de Repsa
                    Call generarDatosRecibo77(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 78
                      'Generacion del recibo de AMIA
                    Call generarDatosRecibo78(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 79
                      'Generacion del recibo de Vittal
                    Call generarDatosRecibo79(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 80
                      'Generacion del recibo de RIM
                    Call generarDatosRecibo80(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 81 'aca
                      'Generacion del recibo de SANTILLANA
                    Call generarDatosRecibo81(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 82
                      'Generacion del recibo de SANTILLANA
                    Call generarDatosRecibo82(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 83
                      'Generacion del recibo de Administradora Sanatorial
                    Call generarDatosRecibo83(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 84
                      'Generacion del recibo de Actionline
                    Call generarDatosRecibo84(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 85
                      'Generacion del recibo de TPS
                    Call generarDatosRecibo85(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 86
                      'Generacion del recibo de SuperCanal
                    Call generarDatosRecibo86(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 87
                      'Generacion del recibo de Grupo Cargo
                    Call generarDatosRecibo87(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 88
                      'Generacion del recibo de Medicus
                    Call generarDatosRecibo88(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 89
                      'Generacion del recibo de Price
                    Call generarDatosRecibo89(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 90
                      'Generacion del recibo de Radio Continental
                    Call generarDatosRecibo90(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 91
                      'Generacion del recibo de Grupo Cargo
                    Call generarDatosRecibo91(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 92
                      'Generacion del recibo de Multivoice
                    Call generarDatosRecibo92(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 93
                      'Generacion del recibo de Golden Peanut
                    Call generarDatosRecibo93(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 94
                      'Generacion del recibo de Teletech
                    Call generarDatosRecibo94(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 95
                      'Generacion del recibo de Teletech
                    Call generarDatosRecibo95(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 96
                      'Generacion del recibo de Monresa
                    Call generarDatosRecibo96(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 97
                      'Generacion del recibo de Multivoice Colombia
                    Call generarDatosRecibo97(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 98
                      'Generacion del recibo de Freddo
                    Call generarDatosRecibo98(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 99
                      'Genera el recibo para Fundicion San Cayetano
                      Call generarDatosRecibo99(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 100
                      'Genera el recibo para Sidersa
                      Call generarDatosRecibo100(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 101
                      'Genera el recibo para Sidersa
                      Call generarDatosRecibo101(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 102
                      'Genera el recibo para Sykes (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo102(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 103
                      'Genera el recibo para MAE (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo103(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 104
                      'Genera el recibo para MAE (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo104(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 105
                      'Genera el recibo para Merck Sharp Down (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo105(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 106
                      'Genera el recibo para Farmografica (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo106(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 107
                      'Genera el recibo para INDAP (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo107(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 108
                      'Genera el recibo para General Mills (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo108(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 109
                      'Genera el recibo "Adicional" para Merck Sharp Down (En Módulo aparte - "repRecibos2")
                      Call generarDatosRecibo109(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 110
                    'Generacion del recibo para Coop. Seguros
                    Call generarDatosRecibo110(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                 Case 111
                      'Generacion del recibo de Portugal
                    Call generarDatosRecibo111(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 112
                      'Generacion del recibo de Horwath Rosario
                    Call generarDatosRecibo112(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 113
                      'Generacion del recibo de Met Roma
                    Call generarDatosRecibo113(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
   
                Case 114
                      'Generacion del recibo de deloitte
                    Call generarDatosRecibo114(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 115
                      'Generacion del recibo Mensual y de Vacaciones para APEX S.A Paraguay
                    Call generarDatosRecibo115(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 116
                      'Generacion del recibo final por Termino de Contrato para APEX S.A Paraguay
                    Call generarDatosRecibo116(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 117
                      'Generacion del recibo de Cardif
                    Call generarDatosRecibo117(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 118
                      'Generacion del recibo de PKF
                    Call generarDatosRecibo118(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 119
                      'Generacion del recibo de Medicus (Nuevo)
                    Call generarDatosRecibo119(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 120
                      'Generacion del recibo de Kraft (Uruguay)
                    Call generarDatosRecibo120(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 121
                    'Generacion del recibo para OSDOP
                    Call generarDatosRecibo121(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 122
                    'Generacion del recibo para Mimo Vestiditos
                    Call generarDatosRecibo122(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 123
                    'Generacion del recibo para Mimo Vestiditos
                    Call generarDatosRecibo123(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 124
                    'Generacion del recibo para Clinica San Camilo
                    Call generarDatosRecibo124(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 125
                    'Generacion del recibo para Paradigma
                    Call generarDatosRecibo125(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 126
                      'Genera el recibo para (PERU)
                      Call generarDatosRecibo126(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                        
                Case 127
                      'Genera el recibo para CCU Sidra
                      Call generarDatosRecibo127(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                
                Case 128
                      'Genera el recibo para Apex honduras
                      Call generarDatosRecibo128(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 129
                      'Genera el recibo para EDESTE
                      Call generarDatosRecibo129(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 130
                      'Genera el recibo para Kraft chile
                      Call generarDatosRecibo130(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 131
                      'Generacion del recibo de Express Beer
                    Call generarDatosRecibo131(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 132
                      'Generacion del recibo de TATA
                    Call generarDatosRecibo132(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 133
                      'Generacion del recibo de Sedamil
                    Call generarDatosRecibo133(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 134
                      'Generacion del recibo de HB VISION OUTSOURCES
                    Call generarDatosRecibo134(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 135
                      'Generacion del recibo Mensual y de Vacaciones para Paraguay
                    Call generarDatosRecibo135(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 136
                      'Generacion del recibo de Multivoice Colombia
                    Call generarDatosRecibo136(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 137
                    'Generacion del recibo mensual de NGA.
                    Call generarDatosRecibo137(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 138
                      'Generacion del recibo de Diaz 21-12-12
                    Call generarDatosRecibo138(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 139
                      'Generacion del recibo de CDA 05-02-13
                    Call generarDatosRecibo139(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 140
                      'Generacion del recibo de Ecuador 03-04-2013
                    Call generarDatosRecibo140(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 141
                      'Generacion del recibo Horwath Litoral - AMR
                    Call generarDatosRecibo141(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 142
                      'Generacion del recibo distribucion de utilidades
                    Call generarDatosRecibo142(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 143
                      'Generacion del recibo Chacomer 24-04-2013
                    Call generarDatosRecibo143(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 144
                      'Generacion del recibo Venezuela 02/05/2013
                    Call generarDatosRecibo144(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 145
                      'Generacion del recibo de Paraguay - CAS-19634 - PayrollPy - Axion - Recibo de Sueldo
                    Call generarDatosRecibo145(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 146
                      'Generacion del recibo de COLOMBIA NVS - CAS-19398 - 30-05-13
                    Call generarDatosRecibo146(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 147
                      'Generacion del recibo de Novartis - CAS-19976 - 19-06-2013
                    Call generarDatosRecibo147(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 148
                      'Generacion del recibo - CAS-19829 - HORWATH LITORAL - GEMPLAST - Recibo Blue - 04-07-2013
                    Call generarDatosRecibo148(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 149
                      'Generacion del recibo - CAS-18991 - Raffo - Adecuaciones LIQ - Recibo de Sueldo
                    Call generarDatosRecibo149(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 150
                      'Generacion del recibo - CAS-20087 - Horwath Litoral Gemplast - Recibo - 11-07-2013
                    Call generarDatosRecibo150(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 151
                      'Generacion del recibo - CAS-17053 - Brasil - Recibo - 12-07-2013
                    Call generarDatosRecibo151(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 152
                      'Generacion del recibo - CAS-20224 - CDA - RECIBO DE HABERES CHILE Y PERU - 23-07-2013
                    Call generarDatosRecibo152(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 153
                      'Generacion del recibo - CAS-20224 - CDA - RECIBO DE HABERES CHILE Y PERU - 05-08-2013
                    Call generarDatosRecibo153(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 154
                      'Generacion del recibo - CAS-14302 - Plusamar - 22-08-2013
                    Call generarDatosRecibo154(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 155
                      'Generacion del recibo - CAS-20702 - CDA - Recibo de haberes Mexico
                    Call generarDatosRecibo155(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 156
                      'Generacion del recibo - CAS-21142 - CDA - Recibo de Haberes España
                    Call generarDatosRecibo156(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 157
                      'Generacion del recibo - CAS-21426 - SGS - Modificaciones Recibo de Haberes modelo 71
                    Call generarDatosRecibo157(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 158
                      'Generacion del recibo - CAS 21442 - BDO GE - Recibo Modelo 158 tomado del 123 21-10-13
                    Call generarDatosRecibo158(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 159
                      'Generacion del recibo - CAS-21897 - BDO - Custom de Recibo de Haberes - Recibo Modelo 159
                    Call generarDatosRecibo159(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                    
                Case 160
                      'Generacion del recibo - CAS 21817 - Colombia Zoetis - Recibo Modelo 160
                    Call generarDatosRecibo160(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                    
                Case 161
                      'Generacion del recibo - CAS 22135 - Chile Zoetis - Recibo Modelo 161
                    Call generarDatosRecibo161(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 162
                      'Generacion del recibo - CAS 22200 - Deloitte - Recibo Modelo 162 Deloitte
                    Call generarDatosRecibo162(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 163
                      'Generacion del recibo - CAS 23377 - HIRSCH - Recibo 163 HIRSCH
                    Call generarDatosRecibo163(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 164
                      'Generacion del recibo - CAS-23790 - PLA SA
                    Call generarDatosRecibo164(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 165
                      'Generacion del recibo - CAS-23857 - UTDT - Custom Recibo de sueldo
                    Call generarDatosRecibo165(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 166
                      'CAS-24323 - MEGATLON - Recibo de Haberes
                    Call generarDatosRecibo166(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 167
                      'CAS-25276 - 5CA - Modificaciones en recibo de haberes
                    Call generarDatosRecibo167(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 168
                      'CAS-25506 - PUIG - Reporte de Recibo de Haberes - modificación
                    Call generarDatosRecibo168(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 169
                      'CAS-26315 - Punto Farma - Modificación de Recibo de Haberes
                    Call generarDatosRecibo169(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 170
                      'CAS-25918 - Clarín - Modificación recibo de haberes
                    Call generarDatosRecibo170(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 171
                      'CAS-26571 - VSO - Interpack - Recibos de Sueldo - MODELO 1
                    Call generarDatosRecibo171(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 172
                      'CAS-26571 - VSO - Interpack - Recibos de Sueldo - MODELO 2
                    Call generarDatosRecibo172(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 173
                      'CAS-26571 - VSO - Interpack - Recibos de Sueldo - MODELO 3  Jornales Interpack
                    Call generarDatosRecibo173(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 174
                      'CAS-26571 - VSO - Interpack - Recibos de Sueldo - MODELO 3  Celomat
                    Call generarDatosRecibo174(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 175
                    'Generacion del recibo para CCU
                    Call generarDatosRecibo175(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 176
                    'Generacion del recibo para Telefax - Santander URU
                    Call generarDatosRecibo176(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 177
                    'Generacion del recibo para Festo
                    Call generarDatosRecibo177(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 178
                    'Generacion del recibo para San Miguel (NGA)
                    Call generarDatosRecibo178(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 179
                    'Generacion del recibo para IMECON
                    Call generarDatosRecibo179(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                    'Generacion del recibo nuevo de ASMSA
                Case 180
                    Call generarDatosRecibo180(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 181
                    Call generarDatosRecibo181(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 182
                    Call generarDatosRecibo182(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio0)
                    'Generacion del recibo nuevo de Dalkia
                Case 183
                    Call generarDatosRecibo183(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 184
                    Call generarDatosRecibo184(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 185
                    Call generarDatosRecibo185(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 186
                    Call generarDatosRecibo186(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 187
                    'Generacion del recibo para Peru
                    Call generarDatosRecibo187(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 188
                    'Generacion del recibo para IHLSA
                    Call generarDatosRecibo188(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 189
                    'Generacion del recibo para PERSONAL
                    Call generarDatosRecibo189(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 500
                      'Generacion de Boleta de Pago SYKES - SV
                    Call generarDatosRecibo500(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 501
                      'Generacion de Comprobante de Pago SYKES - SV
                    Call generarDatosRecibo501(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 502
                      'Generacion de Comprobante de Pago SYKES - SV
                    Call generarDatosRecibo502(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 503
                      'Generacion de Comprobante de Pago Bolivia
                    Call generarDatosRecibo503(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 504
                      'Generacion de Comprobante de Pago Bolivia
                    Call generarDatosRecibo504(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                Case 505
                      'Generacion de Comprobante de Pago Bolivia
                    Call generarDatosRecibo505(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
                
                Case Else
                    Flog.writeline "No se encontro el modelo [" & tipoRecibo & "]"
                End Select
            Else
                Flog.writeline "El tercero " & Ternro & " no tiene conceptos imprimibles para el proceso " & Pronro
            End If
        Next
          
        If generoRecibo Then
            orden = orden + 1
        End If
             
        'Actualizo el estado del proceso
        TiempoAcumulado = GetTickCount
           
        cantRegistros = cantRegistros - 1
        
        StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Fix(((totalEmpleados - cantRegistros) * 100) / totalEmpleados) & _
                    ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & "'" & _
                    ", bprcempleados ='" & CStr(cantRegistros) & "' WHERE bpronro = " & NroProceso
           
        objConn.Execute StrSql, , adExecuteNoRecords
         
        'Si se generaron todos los recibos de sueldo del empleado correctamente lo borro
        If Not EmpErrores Then
              StrSql = " DELETE FROM batch_empleado "
              StrSql = StrSql & " WHERE bpronro = " & NroProceso
              StrSql = StrSql & " AND ternro = " & Ternro
    
              objConn.Execute StrSql, , adExecuteNoRecords
        End If
        rsEmpl.MoveNext
    Loop
Else
    Exit Sub
End If
   
    If Not HuboErrores Then
        'Actualizo el estado del proceso
        StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Procesado' WHERE bpronro = " & NroProceso
    Else
        StrSql = "UPDATE batch_proceso SET  bprcprogreso =100, bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Incompleto' WHERE bpronro = " & NroProceso
    End If
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    Flog.writeline "Fin :" & Now
    Flog.Close

    Exit Sub
    
CE:
    HuboErrores = True
    Flog.writeline "************************************************************"
    Flog.writeline " Error: " & Err.Description & Now
    Flog.writeline " Ultimo sql ejecutado: " & StrSql
    Flog.writeline "************************************************************"
End Sub


Public Sub bus_Anti0(Ternro, pliqanio, pliqmes, ByRef Dia As Integer, ByRef Mes As Integer, ByRef Anio As Integer)

Dim q As Integer

Dim FechaAux As Date

    Bien = False
    Valor = 0
        
    If pliqmes = 12 Then
        FechaAux = CDate("1/1/" & pliqanio + 1) - 1
    Else
        FechaAux = CDate("01/" & pliqmes + 1 & "/" & pliqanio) - 1
    End If
        
    Call bus_Antiguedad(Ternro, "REAL", FechaAux, Dia, Mes, Anio, q)
    
End Sub


Public Sub bus_Antiguedad(ByVal Ternro As Long, ByVal TipoAnt As String, ByVal fechafin As String, ByRef Dia As Integer, ByRef Mes As Integer, ByRef Anio As Integer, ByRef DiasHabiles As Integer)

Dim aux1 As Long
Dim aux2 As Long
Dim aux3 As Long
Dim fecalta As Date
Dim fecbaja As Date
Dim seguir As Date
Dim q As Integer

Dim NombreCampo As String

Dim rs_Fases As New ADODB.Recordset

NombreCampo = ""
DiasHabiles = 0

Select Case UCase(TipoAnt)
Case "SUELDO":
    NombreCampo = "sueldo"
Case "INDEMNIZACION":
    NombreCampo = "indemnizacion"
Case "VACACIONES":
    NombreCampo = "vacaciones"
Case "REAL":
    NombreCampo = "real"
Case "RECONOCIDA":
    NombreCampo = "fasrecofec"

Case Else

End Select


' FGZ -27/01/2004
StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro & _
         " AND " & NombreCampo & " = -1 " & _
         " AND not altfec is null " & _
         " AND not (bajfec is null AND estado = 0)" & _
         " AND altfec <= " & ConvFecha(fechafin)

OpenRecordset StrSql, rs_Fases

Do While Not rs_Fases.EOF
    fecalta = rs_Fases!altfec
    
    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
    If rs_Fases!estado Then
        fecbaja = fechafin ' solo es un alta, tomar el fecha-fin
    ElseIf rs_Fases!bajfec <= CDate(fechafin) Then
        fecbaja = rs_Fases!bajfec  ' se trata de un registro completo
    Else
        fecbaja = fechafin ' hasta la fecha ingresada
    End If
    
    If CDate(fecalta) = CDate(fecbaja) Then 'MDF --- 05/08/2015
      aux1 = 1
      aux2 = 0
      aux3 = 0
    Else
      Call DIF_FECHAS2(fecalta, fecbaja, aux1, aux2, aux3)
    End If
    
    If rs_Fases.RecordCount = 1 Then
        Dia = aux1
        Mes = aux2
        Anio = aux3
    Else
        Dia = Dia + aux1
        Mes = Mes + aux2 + Int(Dia / 30)
        Anio = Anio + aux3 + Int(Mes / 12)
        Dia = Dia Mod 30
        Mes = Mes Mod 12
    End If
        
    If Anio = 0 Then
        Call DiasTrab(Ternro, fecalta, fecbaja, aux1)
        DiasHabiles = DiasHabiles + aux1
    End If
    
siguiente:
    rs_Fases.MoveNext
Loop

If Anio <> 0 Then
    DiasHabiles = 0
End If

' Cierro todo y Libero
If rs_Fases.State = adStateOpen Then rs_Fases.Close
Set rs_Fases = Nothing


If UCase(TipoAnt) = "RECONOCIDA" Then
    
    If CInt(Dia) = 0 And CInt(Mes) = 0 And CInt(Anio) = 0 Then
        Flog.writeline "No se encontraron faces para el tercero " & Ternro & " marcadas como Fecha de Alta Reconocida. Se buscan marcadas como Real!"
        Call bus_Antiguedad(Ternro, "REAL", fechafin, Dia, Mes, Anio, DiasHabiles)
    End If
End If


End Sub



'busqueda de antiguedad desde fase con marca de fecha de alta reconocida
'teniendo en cuenta cortes en la continuidad de las fases
Public Sub bus_AntiguedadReconocida(ByVal Ternro As Long, ByVal TipoAnt As String, ByVal fechafin As String, ByRef Dia As Integer, ByRef Mes As Integer, ByRef Anio As Integer, ByRef DiasHabiles As Integer)

Dim aux1 As Long
Dim aux2 As Long
Dim aux3 As Long
Dim fecalta As Date
Dim fecbaja As Date
Dim seguir As Date
Dim q As Integer
Dim Inicio As Boolean


Dim NombreCampo As String

Dim rs_Fases As New ADODB.Recordset

NombreCampo = ""
DiasHabiles = 0

Select Case UCase(TipoAnt)
Case "SUELDO":
    NombreCampo = "sueldo"
Case "INDEMNIZACION":
    NombreCampo = "indemnizacion"
Case "VACACIONES":
    NombreCampo = "vacaciones"
Case "REAL":
    NombreCampo = "real"
Case Else

End Select


' MDZ - 05-09-2014
StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro & _
         " AND " & NombreCampo & " = -1 " & _
         " AND not altfec is null " & _
         " AND not (bajfec is null AND estado = 0)" & _
         " AND altfec <= " & ConvFecha(fechafin) & _
         " order by altfec"

OpenRecordset StrSql, rs_Fases

Inicio = False

Do While Not rs_Fases.EOF
    
    If Not Inicio And rs_Fases!fasrecofec = -1 Then
        Inicio = True
    End If
    
    If Inicio Then
        fecalta = rs_Fases!altfec
        
        ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
        If rs_Fases!estado Then
            fecbaja = fechafin ' solo es un alta, tomar el fecha-fin
        ElseIf rs_Fases!bajfec <= CDate(fechafin) Then
            fecbaja = rs_Fases!bajfec  ' se trata de un registro completo
        Else
            fecbaja = fechafin ' hasta la fecha ingresada
        End If
        
        Call DIF_FECHAS2(fecalta, fecbaja, aux1, aux2, aux3)
        
        If rs_Fases.RecordCount = 1 Then
            Dia = aux1
            Mes = aux2
            Anio = aux3
        Else
            Dia = Dia + aux1
            Mes = Mes + aux2 + Int(Dia / 30)
            Anio = Anio + aux3 + Int(Mes / 12)
            Dia = Dia Mod 30
            Mes = Mes Mod 12
        End If
            
        If Anio = 0 Then
            Call DiasTrab(Ternro, fecalta, fecbaja, aux1)
            DiasHabiles = DiasHabiles + aux1
        End If
    End If
    
siguiente:
    rs_Fases.MoveNext
Loop

If Anio <> 0 Then
    DiasHabiles = 0
End If

' Cierro todo y Libero
If rs_Fases.State = adStateOpen Then rs_Fases.Close
Set rs_Fases = Nothing


If CInt(Dia) = 0 And CInt(Mes) = 0 And CInt(Anio) = 0 Then
     Flog.writeline "No se encontraron faces para el tercero " & Ternro & " marcadas como Fecha de Alta Reconocida. Se buscan marcadas como Real!"
     Call bus_Antiguedad(Ternro, "REAL", fechafin, Dia, Mes, Anio, DiasHabiles)
End If



End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos
'--------------------------------------------------------------------
Sub generarDatosRecibo01(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ObraSocial

Dim LugarDePago

Dim tidnroRST As String
Dim codResolucion As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

StrSql = "SELECT * "
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
    FormaPago = " "
    Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'--------------------------------------------------------------------
'Obtengo la configuracion del tipo de documento resolucion 23/05/2015
'--------------------------------------------------------------------
StrSql = " SELECT confval FROM confrep WHERE repnro = 60 AND confnrocol = 358 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    tidnroRST = rsConsult!confval
    Flog.writeline "Codigo de tipo de documento Resolucion encontrado."
Else
    tidnroRST = 0
    Flog.writeline "Codigo de tipo de documento Resolucion No encontrado."
End If

'Consulta para buscar el numero de resolucion de la empresa
StrSql = "SELECT nrodoc FROM ter_doc " & _
         " Where ternro =" & rs_estructura!Ternro & " AND ter_doc.tidnro = " & tidnroRST
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró nro de resolucion de la empresa"
    'Exit Sub
    codResolucion = 0
Else
    codResolucion = rsConsult!NroDoc
End If
'--------------------------------------------------------------------
'Obtengo la configuracion del tipo de documento resolucion 23/05/2015
'--------------------------------------------------------------------


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc & "@" & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxdeci1, auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarDePago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ",'" & codResolucion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Public Sub DiasTrab(ByVal Ternro As Long, ByVal Desde As Date, ByVal Hasta As Date, ByRef DiasH As Long)
' ---------------------------------------------------------------------------------------------
' Descripcion: Calcula la cantidad de dias trabajados de acuerdo al turno en que se trabaja y
'              de acuerdo a los dias que figuran como feriados en la tabla de feriados.
' Autor      : FGZ
' Fecha      :
' Ultima Mod.:
' Descripcion:
' ---------------------------------------------------------------------------------------------

Dim d1 As Integer
Dim d2 As Integer
Dim aux As Integer
Dim aux2 As Integer
Dim dxsem As Integer

Dim rs_pais As New ADODB.Recordset
Dim rs_feriados As New ADODB.Recordset

    dxsem = 5
    
    d1 = Weekday(Desde)
    d2 = Weekday(Hasta)
    
    aux = DateDiff("d", Desde, Hasta) + 1
    If aux < 7 Then
        DiasH = Minimo(aux, dxsem)
    Else
        If aux = 7 Then
            DiasH = dxsem
        Else
            aux2 = 8 - d1 + d2
            If aux2 < 7 Then
                aux2 = Minimo(aux2, dxsem)
            Else
                If aux2 = 7 Then
                    aux2 = dxsem
                End If
            End If
            
            If aux2 >= 7 Then
                aux2 = Abs(aux2 - 7) + Int(aux2 / 7) * dxsem
            Else
                aux2 = aux2 + Int((aux2 - aux2) / 7) * dxsem
            End If
        End If
    End If
    
    aux = 0
    
    StrSql = "SELECT * FROM pais INNER JOIN tercero ON tercero.paisnro = pais.paisnro WHERE tercero.ternro = " & Ternro
    OpenRecordset StrSql, rs_pais
    
    If Not rs_pais.EOF Then
        ' Resto los Feriados Nacionales
        StrSql = "SELECT * FROM feriado WHERE tipferinro = 2 " & _
                 " AND fericodext = " & rs_pais!paisnro & _
                 " AND ferifecha >= " & ConvFecha(Desde) & _
                 " AND ferifecha < " & ConvFecha(Hasta)
        OpenRecordset StrSql, rs_feriados
        
        Do While Not rs_feriados.EOF
            If Weekday(rs_feriados!ferifecha) > 1 Then
                DiasH = DiasH - 1
            End If
            
            ' Siguiente Feriado
            rs_feriados.MoveNext
        Loop
    End If


    ' Resto los feriados por Convenio
    StrSql = "SELECT * FROM empleado INNER JOIN his_estructura ON empleado.ternro = his_estructura.ternro " & _
             " INNER JOIN fer_estr ON fer_estr.tenro = his_estructura.tenro " & _
             " INNER JOIN feriado ON fer_estr.ferinro = feriado.ferinro " & _
             " WHERE empleado.ternro = " & Ternro & _
             " AND feriado.tipferinro = 2" & _
             " AND feriado.ferifecha >= " & ConvFecha(Desde) & _
             " AND feriado.ferifecha < " & ConvFecha(Hasta)
    OpenRecordset StrSql, rs_feriados
    
    Do While Not rs_feriados.EOF
        If Weekday(rs_feriados!ferifecha) > 1 Then
            DiasH = DiasH - 1
        End If
        
        ' Siguiente Feriado
        rs_feriados.MoveNext
    Loop
    
    
    ' cierro todo y libero
    If rs_pais.State = adStateOpen Then rs_pais.Close
    If rs_feriados.State = adStateOpen Then rs_feriados.Close
        
    Set rs_feriados = Nothing
    Set rs_pais = Nothing

End Sub


'--------------------------------------------------------------------
' Se encarga de generar un ResultSet de los empleados a cambiar
' si el RS es vacio significa que hay que aplicarlo sobre todos
'--------------------------------------------------------------------
Sub CargarEmpleados(NroProc, ByRef rsEmpl As ADODB.Recordset)

Dim StrEmpl As String

    If tipoRecibo = 20 Then
       StrEmpl = " SELECT DISTINCT empleado.ternro, empleado.empleg, empleado.terape, nestact1.estrdext AS nestr1, nestact2.estrcodext AS nestr2"
       StrEmpl = StrEmpl & " From batch_empleado"
       StrEmpl = StrEmpl & " INNER JOIN empleado ON batch_empleado.ternro = empleado.ternro AND batch_empleado.bpronro = " & NroProc
       StrEmpl = StrEmpl & " INNER JOIN his_estructura estact1 ON empleado.ternro = estact1.ternro AND estact1.tenro = 6 "
       StrEmpl = StrEmpl & "      AND (estact1.htetdesde <= " & ConvFecha(fecEstr)
       StrEmpl = StrEmpl & "      AND (estact1.htethasta is null or estact1.htethasta>=" & ConvFecha(fecEstr) & "))"
       StrEmpl = StrEmpl & " INNER JOIN his_estructura estact2 ON empleado.ternro = estact2.ternro AND estact2.tenro = 5 "
       StrEmpl = StrEmpl & "      AND (estact2.htetdesde<=" & ConvFecha(fecEstr)
       StrEmpl = StrEmpl & "      AND (estact2.htethasta is null or estact2.htethasta>=" & ConvFecha(fecEstr) & "))"
       StrEmpl = StrEmpl & " INNER JOIN estructura nestact1 ON nestact1.estrnro = estact1.estrnro"
       StrEmpl = StrEmpl & " INNER JOIN estructura nestact2 ON nestact2.estrnro = estact2.estrnro"
       StrEmpl = StrEmpl & " Where batch_empleado.bpronro = " & NroProc
       StrEmpl = StrEmpl & " ORDER BY nestr1,nestr2,terape "
    
    Else
       StrEmpl = "SELECT * FROM batch_empleado WHERE bpronro = " & NroProc & " ORDER BY progreso,estado "
       
    End If
    
    OpenRecordset StrEmpl, rsEmpl
End Sub

Function numberForSQL(Str)
   
  numberForSQL = Replace(Str, ",", ".")

End Function

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Temaiken, Deloitte
'--------------------------------------------------------------------
Sub generarDatosRecibo02(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsultConfrep As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim MemoConfrep1() As String
Dim MemoConfrep2() As String
Dim MemoConfrep3() As String
On Error GoTo MError
Dim I, j As Integer
Dim Convenio(1 To 3) As Integer
Dim leyenda(1 To 3) As Boolean
Dim encontre As Boolean
ReDim Preserve MemoConfrep1(1)
ReDim Preserve MemoConfrep2(1)
ReDim Preserve MemoConfrep3(1)
Dim Memoconfrep As String
Dim ConvenioNro As Long
Dim Suma1, Suma2, Suma3, MostrarPie As Boolean
Suma1 = False
Suma2 = False
Suma3 = False
MostrarPie = False
MemoConfrep1(1) = "A"
MemoConfrep2(1) = "A"
MemoConfrep3(1) = "A"
EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0
leyenda(1) = False
leyenda(2) = False
leyenda(3) = False


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empfaltagr,empfbajaprev,empleg,terape,terape2,ternom,ternom2,empremu,empreporta"
StrSql = StrSql & " FROM empleado"
StrSql = StrSql & " WHERE ternro= " & Ternro
' Stankunas Cesar - 21/05/2009 - Se modificó la consulta que traía "empfecbaja" por "empfbajaprev"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empfbajaprev
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria "
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = ctabancaria.banco"
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
StrSql = StrSql & " AND ctabestado = -1"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

    If CBool(rsConsult!fpagbanc) Then
       FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
    Else
       FormaPago = rsConsult!fpagdescabr
    End If
  
Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'-------------------------------------------------------------------------------------------------------------
'BUSCO LOS DATOS DE LOS CONCEPTOS CONFIGURADOS POR CONFREP PARA SER SUMADOS SEGUN SEA EL CONVENIO DEL EMPLEADO
'-------------------------------------------------------------------------------------------------------------
'Agregado por DNN el 28/04/2009

'Primero busco en el confrep los convenios y acumuladores/conceptos asociados
'Hasta el momento será posible configurar tres tipos distintos de convenios (registros de mi memoria interna)

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'CCO' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                encontre = True
                Exit For
            End If
        Next
        If Not encontre Then
            j = j + 1
            Convenio(j) = rsConsultConfrep!confval
        End If
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF Or j = 3
Else
   Flog.writeline "No esta configurado el ConfRep para recibos por convenios"
   GoTo NoCambiar 'No se configuró el confrep, por lo cual el proceso debe funcionar como antes (Deloite)
   'Exit Sub
End If
'En la memoria convenio tengo los tres posibles convenios configurados
'Cada uno de estos convenios será una fila de mi memoria MemoConfrepX
rsConsultConfrep.MoveFirst
Do
    For I = 1 To 3
        If rsConsultConfrep!confval = Convenio(I) Then
            Select Case I
                Case 1
                    If MemoConfrep1(1) <> "A" Then
                        j = UBound(MemoConfrep1) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep1(j)
                    MemoConfrep1(j) = rsConsultConfrep!confval2
                Case 2
                    If MemoConfrep2(1) <> "A" Then
                        j = UBound(MemoConfrep2) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep2(j)
                    MemoConfrep2(j) = rsConsultConfrep!confval2
                Case 3
                    If MemoConfrep3(1) <> "A" Then
                        j = UBound(MemoConfrep3) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep3(j)
                    MemoConfrep3(j) = rsConsultConfrep!confval2
            End Select
        End If
    Next
    rsConsultConfrep.MoveNext
Loop Until rsConsultConfrep.EOF

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ConvenioNro = rsConsult!Estrnro
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'Ahora me fijo en el arreglo de convenios si tengo al convenio del empleado
For I = 1 To 3
    Select Case I
        Case 1
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep1)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep1(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep1(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep1)
                ReDim Preserve MemoConfrep1(j + 1)
                Suma1 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep1(j + 1) = 0
                Else
                    MemoConfrep1(j + 1) = rsConsult(0)
                End If
            End If
        Case 2
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep2)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep2(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep2(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep2)
                ReDim Preserve MemoConfrep2(j + 1)
                Suma2 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep2(j + 1) = 0
                Else
                    MemoConfrep2(j + 1) = rsConsult(0)
                End If
            End If
        
        Case 3
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep3)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep3(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep3(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep3)
                ReDim Preserve MemoConfrep3(j + 1)
                Suma3 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep3(j + 1) = 0
                Else
                    MemoConfrep3(j + 1) = rsConsult(0)
                End If
            End If
    End Select
Next

'En Caso que el empleado pertenezca al primer convenio configurado poner el segundo campo auxiliar de decimales en 1
'El primer convenio configurado debe ser siempre el convenio para el cual se configura un pie de recibo
'If convenio(1) = ConvenioNro Then
'    MostrarPie = True
'End If


'Busco los convenios para los cuales se necesita que aparezca una leyenda al pie del recibo

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'LEY' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                If UCase(rsConsultConfrep!confval2) = "SI" Then
                    leyenda(I) = True
                End If
                Exit For
            End If
        Next
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF
End If
For I = 1 To 3
    If ConvenioNro = Convenio(I) Then
        If leyenda(I) Then MostrarPie = True
    End If
Next
'-------------------------------------------------------------------------------------------------------------
NoCambiar:


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Auxchar5, Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & ",auxdeci1"
End If
If MostrarPie Then
    StrSql = StrSql & ",auxdeci2"
End If
StrSql = StrSql & ") VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & "," & MemoConfrep1(j)
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & "," & MemoConfrep2(j)
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & "," & MemoConfrep3(j)
End If
If MostrarPie Then
    StrSql = StrSql & "," & 1
End If
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Accor
'--------------------------------------------------------------------
Sub generarDatosRecibo03(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim Modelo
Dim LugarPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*,tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 30) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Modelo, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Jugos
'--------------------------------------------------------------------
Sub generarDatosRecibo04(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Documento
Dim regHorario
Dim Sector
Dim DNRP
Dim Antiguedad

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regHorario = ""

If Not rsConsult.EOF Then
   regHorario = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del reg. horario"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call bus_Anti0(ternro, pliqanio, pliqmes, dia, mes, Anio)

Call antigfec(Ternro, pliqanio, pliqmes, Dia, Mes, Anio)

Antiguedad = " A&ntilde;os&nbsp;" & Anio & "&nbsp;Meses&nbsp;" & Mes & "&nbsp;D&iacute;as&nbsp;" & Dia

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del subtotal remunerativo
'------------------------------------------------------------------

StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumSubTotalRemun
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   subTotalRemun = rsConsult!almonto
Else
   Flog.writeline "No se encontro el subtotal remunerativo"
   subTotalRemun = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro=30) "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!Ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   DNRP = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(regHorario, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & "," & numberForSQL(subTotalRemun)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Public Function Minimo(ByVal X, ByVal Y)
    If X <= Y Then
        Minimo = X
    Else
        Minimo = Y
    End If
End Function

'--------------------------------------------------------------------
' Se encarga de generar los datos para Citrusvil
'--------------------------------------------------------------------
Sub generarDatosRecibo05(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 36 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Condicion = ""
If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdabr
Else
'    Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & Condicion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub antigfec(Ternro, Anio, Mes, ByRef antdia As Long, ByRef antmes As Long, ByRef antanio As Long)

Dim sql As String
Dim rs1 As New ADODB.Recordset
Dim acum
Dim auxiliar
Dim tipo

sql = "SELECT * FROM confrep WHERE repnro=87 "

OpenRecordset sql, rs1

tipo = 1
acum = 0

Do Until rs1.EOF
   Select Case rs1!confnrocol
      Case 1
        acum = CInt(rs1!confval)
      Case 2
        tipo = CInt(rs1!confval)
   End Select

   rs1.MoveNext
Loop

rs1.Close

If tipo = 1 Then
   sql = " SELECT sum(ammonto) as suma "
Else
   sql = " SELECT sum(amcant) as suma "
End If

sql = sql & " FROM acu_mes "
sql = sql & " WHERE ternro = " & Ternro
sql = sql & "   AND acunro = " & acum
sql = sql & "   AND ( amanio < " & Anio
sql = sql & "    OR ( ammes <= " & Mes
sql = sql & "   AND amanio = " & Anio
sql = sql & "   ) ) "
  
OpenRecordset sql, rs1
  
If rs1.EOF Then
   antdia = 0
Else
   If IsNull(rs1!suma) Then
      antdia = 0
   Else
      antdia = CLng(rs1!suma)
   End If
End If

rs1.Close

auxiliar = antdia
If antdia > 0 Then
    ' calcular año
     If antdia > 360 Then
        antanio = Int(antdia / 360)
        antdia = antdia - 360 * antanio
     End If
     If antdia > 30 Then
        antmes = Int(antdia / 30)
        antdia = antdia - Int(antmes * 30)
     Else
        antdia = antdia
     End If
End If

End Sub


Function sinDatos(Str)

  If IsNull(Str) Then
     sinDatos = True
  Else
     If Trim(Str) = "" Then
        sinDatos = True
     Else
        sinDatos = False
     End If
  End If

End Function

' Recibo de Sueldo para Dabra. En vez de mostrar el puesto, se muestra la sucursal.

Sub generarDatosRecibo06(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa TelePerformance
'--------------------------------------------------------------------
Sub generarDatosRecibo07(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecBaja
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim bancoempl As String
Dim cuentaempl As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      rsConsult.Close
      
      'Me fijo si fue dado de baja en la empresa
      StrSql = "SELECT his_estructura.estrnro,his_estructura.htethasta, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
      
      OpenRecordset StrSql, rsConsult
      
      If rsConsult.EOF Then
         empFecBaja = "null"
      Else
         If Not IsNull(rsConsult!htethasta) Then
            empFecBaja = "'" & rsConsult!htethasta & "'"
         Else
            empFecBaja = "null"
         End If
      End If
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & bancoempl & "'"
StrSql = StrSql & ",'" & cuentaempl & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Norton
'--------------------------------------------------------------------
Sub generarDatosRecibo08(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago
Dim Labor
Dim UbicGeo


Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del labor
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
StrSql = StrSql & " And his_estructura.tenro = 63 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult


Labor = ""

If Not rsConsult.EOF Then
   Labor = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del Ubicación Geográfica
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
StrSql = StrSql & " And his_estructura.tenro = 65 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult


UbicGeo = ""

If Not rsConsult.EOF Then
   UbicGeo = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3,"
StrSql = StrSql & " orden, auxchar1, auxchar2,auxchar3,auxchar4,auxchar5 )"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Labor & "'"
StrSql = StrSql & ",'" & UbicGeo & "'"
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de deloitte, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo09(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "  "
    Localidad = "  "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Grupo Cargo
'--------------------------------------------------------------------
Sub generarDatosRecibo87(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Function tieneConceptosImprimibles(Ternro, Pronro)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset

'--------------------------------------------------------------------
'Controlo si el empleado tiene conceptos imprimibles para el proceso
'--------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

tieneConceptosImprimibles = Not rsConsult.EOF

rsConsult.Close

End Function


'--------------------------------------------------------------------
' Se encarga de generar los datos para Halliburton
'--------------------------------------------------------------------
Sub generarDatosRecibo13(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim LocDireccion
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la localidad de la sucursal
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   LocDireccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!codigopostal & " " & rsConsult!locdesc
Else
   Localidad = "  "
   LocDireccion = "  "
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    
    If esSueldoConc Then
    
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
        
    Else
    
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    End If
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

Puesto = ""

'If Not rsConsult.EOF Then
'   Puesto = rsConsult!estrdabr
'Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
'End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago. Caso especial para Halliburton!!
'------------------------------------------------------------------
StrSql = " SELECT pago.ctabnro,formapago.fpagdescabr,ctabancaria.ctabsucdesc,formapago.fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN ctabancaria ON ctabancaria.cbnro = pago.cbnro"
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabsucdesc & "<br>" & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LocDireccion, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Indura
'--------------------------------------------------------------------
Sub generarDatosRecibo14(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Convenio
Dim CajaJubilacion
Dim AntigDias As Integer
Dim AntigMeses As Integer
Dim AntigAnios As Integer

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(Ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la caja de jubilacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = ""

If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la caja de jubilacion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxdeci1, auxdeci2, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & CajaJubilacion & "'"
StrSql = StrSql & "," & AntigDias
StrSql = StrSql & "," & AntigMeses
StrSql = StrSql & "," & AntigAnios
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de roche, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo15(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim DiasVacTomados
Dim Diasvac

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------------------------------------------
' Busco las vacaciones pendientes
'------------------------------------------------------------------------------------------------------
' busco los dias que le corresponden de vacaciones
StrSql = "SELECT sum(vacdiascor.vdiascorcant) suma FROM vacdiascor "
StrSql = StrSql & " INNER JOIN vacacion ON vacacion.vacnro = vacdiascor.vacnro "
StrSql = StrSql & " WHERE vacdiascor.ternro =" & Ternro
StrSql = StrSql & " AND vacacion.vacanio <= " & Year(pliqhasta)
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Diasvac = IIf(Not EsNulo(rsConsult!suma), rsConsult!suma, 0)
End If
rsConsult.Close

DiasVacTomados = Diasvac

'Se le descuenta los dias de vacaciones que ya se tomo
StrSql = "SELECT * FROM emp_lic "
StrSql = StrSql & " INNER JOIN lic_vacacion ON lic_vacacion.emp_licnro = emp_lic.emp_licnro "
StrSql = StrSql & " INNER JOIN vacacion ON vacacion.vacnro = lic_vacacion.vacnro "
StrSql = StrSql & " WHERE (empleado = " & Ternro & " )"
StrSql = StrSql & " AND (tdnro = 2) "
StrSql = StrSql & " AND elfechahasta < " & ConvFecha(pliqhasta)
OpenRecordset StrSql, rsConsult
    
Do While Not rsConsult.EOF
'    If rsConsult!vacanio = Year(pliqhasta) Then
        DiasVacTomados = DiasVacTomados - rsConsult!elcantdias
'    Else
'        If rsConsult!vacanio + 1 = Year(pliqhasta) Then
'            Diasvactomados = Diasvactomados - rsConsult!elcantdias
'        End If
'    End If
        
    rsConsult.MoveNext
Loop

rsConsult.Close

Diasvac = DiasVacTomados
    
Diasvac = IIf(Fix(Diasvac) = Diasvac, Diasvac, Fix(Diasvac + 1))
If Diasvac < 0 Then
    Diasvac = 0
End If
Flog.writeline "Vacaciones pendientes: " & Diasvac & " días "

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & Diasvac
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Estrada
'--------------------------------------------------------------------
Sub generarDatosRecibo18(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Documento
Dim Sector
Dim DNRP
Dim seccion
Dim LugarDePago

Dim empFecBaja
Dim empFecRec '04-06-07 Diego Rosso

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_Telefono As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta y baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecAlta = "null"
   empFecBaja = "null"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la fecha de alta reconocida                         04-06-07
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " and fasrecofec=-1 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecRec = rsConsult!altfec
Else
   empFecRec = ""
   Flog.writeline "No se encontro la fecha de alta reconocida"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT fpagdescabr"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT cabdom.domnro,detdom.calle,detdom.nro,detdom.piso,detdom.codigopostal,localidad.locdesc,pais.paisdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " WHERE cabdom.domdefault = -1"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If rs_Domicilio!Piso <> "" And Not IsNull(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " Piso " & rs_Domicilio!Piso
    End If
    ' Telefono principal
    StrSql = "SELECT telnro FROM telefono " & _
        "WHERE domnro = " & rs_Domicilio!domnro & " AND teldefault = -1 "
    OpenRecordset StrSql, rs_Telefono
    If Not rs_Telefono.EOF Then
        EmpDire = EmpDire & " Tel. " & rs_Telefono!telnro
    End If
    ' FAX
    StrSql = "SELECT telnro FROM telefono " & _
        "WHERE domnro = " & rs_Domicilio!domnro & " AND telfax = -1 "
    OpenRecordset StrSql, rs_Telefono
    If Not rs_Telefono.EOF Then
        EmpDire = EmpDire & " Fx. " & rs_Telefono!telnro
    End If
    EmpDire = EmpDire & "<br>" & rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " - " & rs_Domicilio!paisdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro= " & tidDNRP & ") "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!Ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!NroDoc) Then
      If Len(rsConsult!NroDoc) < 4 Then
         DNRP = Mid(rsConsult!NroDoc, 1, Len(rsConsult!NroDoc))
      Else
         DNRP = Mid(rsConsult!NroDoc, 1, 4)
      End If
   End If
Else
'   Flog.writeline "Error al obtener los datos del DNRP"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la seccion
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

seccion = ""

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!estrcodext) Then
      If Len(rsConsult!estrcodext) >= 3 Then
         seccion = Mid(rsConsult!estrcodext, 1, 3)
      End If
   End If
End If

rsConsult.Close

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 32 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!estrcodext) Then
      If Len(rsConsult!estrcodext) >= 1 Then
         seccion = seccion & Mid(rsConsult!estrcodext, 1, 1)
      End If
   End If
End If

rsConsult.Close
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & ",'" & seccion & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & empFecRec & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para IMSA
'--------------------------------------------------------------------
Sub generarDatosRecibo19(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
'se cambio la definicion de cabliqNumero de entero a long.
'Dim CabliqNumero As Integer
Dim CabliqNumero As Long
Dim Banco As String
Dim Cuenta As String
Dim clase As String
Dim grupo As String

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la condicion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 36 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Condicion = ""
If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdabr
Else
'    Flog.writeline "Error al obtener los datos de la condicion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor del clase de empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=48 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   clase = rsConsult!estrdabr
Else: clase = ""
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor del grupo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=32 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   grupo = rsConsult!estrdabr
Else: grupo = ""
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    Cuenta = rsConsult!ctabnro
    Banco = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    Cuenta = ""
    Banco = ""
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
'Martin Ferraro - 18/10/2006 - Agregue CP y provincia
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, provincia.provdesc, codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!provdesc) Then
        EmpDire = EmpDire & ", Pcia. de " & rs_Domicilio!provdesc
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1 , auxdeci2, auxdeci3,auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & clase & "'"
StrSql = StrSql & ",'" & grupo & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para las distintas versiones de los
' recibos de roche 2, de acuerdo a la zona de domicilio
'--------------------------------------------------------------------
Sub generarDatosRecibo20(Pronro, Ternro, acunroSueldo, tituloReporte, orden, zonaDomicilio)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String
Dim Cont As Long

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim ValorHora
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim EmpTernro

Dim DiasVacTomados
Dim DivPersonal
Dim Departamento
Dim LugarDeTrabajo
Dim Banco
Dim CuentaBancaria
Dim PagoMonto
Dim FormaDePagoNro

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

Direccion = ""
Localidad = ""

Select Case zonaDomicilio
   'Direccion de la sucursal
   Case 1

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
        StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
    
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la sucursal"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion de la empresa
  Case 2

        StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(proFecPago) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(proFecPago) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
        
        OpenRecordset StrSql, rsConsult
        
        EmpTernro = 0
        
        If Not rsConsult.EOF Then
            EmpTernro = rsConsult!Ternro
        End If
        
        rsConsult.Close
        
        'Consulta para obtener la direccion de la empresa
        StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
            " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
            " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
        
        '---LOG---
        Flog.writeline "Buscando datos de la direccion de la empresa"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
  'Direccion del empleado
  Case 3

        StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
        StrSql = StrSql & " FROM  cabdom "
        StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
        StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
        StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
        '---LOG---
        Flog.writeline "Buscando datos de la direccion del empleado"
        
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
           Localidad = rsConsult!locdesc
        End If
        
        rsConsult.Close
    
End Select

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext, estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Division de personal (Gerencia)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=6 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

DivPersonal = ""
If Not rsConsult.EOF Then
   DivPersonal = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la div de personal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Departamento (Sector)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del departamento"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Lugar de Trabajo(Sucursal)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=1 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

LugarDeTrabajo = ""
If Not rsConsult.EOF Then
   LugarDeTrabajo = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Lugar de Trabajo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT pago.fpagnro, ctabnro,ctabcbu,bandesc,pago.pagomonto,fpagdescabr "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   FormaPago = rsConsult!fpagdescabr
   If Not EsNulo(rsConsult!ctabnro) Then
       CuentaBancaria = rsConsult!ctabnro
       If IsNull(rsConsult!Bandesc) Then
          Banco = ""
       Else
          Banco = rsConsult!Bandesc
       End If
   Else
       CuentaBancaria = rsConsult!ctabcbu
       Banco = "CBU"
   End If
   PagoMonto = rsConsult!PagoMonto
   FormaDePagoNro = rsConsult!fpagnro
Else
   Flog.writeline "Fin de archivo en Formas de Pago"
   FormaPago = ""
   CuentaBancaria = ""
   PagoMonto = 0
   FormaDePagoNro = 1000
   Banco = ""
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

Flog.writeline "Contenido de CuentaBancaria = " & CuentaBancaria

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " - " & rs_Domicilio!codigopostal & " " & rs_Domicilio!barrio & " - " & rs_Domicilio!locdesc
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------------------------------------------
' Busco las vacaciones pendientes
'------------------------------------------------------------------------------------------------------

StrSql = " SELECT DISTINCT * "
StrSql = StrSql & " FROM novemp "
StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " AND novemp.tpanro = " & paramVacPend
StrSql = StrSql & " AND concnro = " & concnroVacPend
StrSql = StrSql & " AND nedesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " ORDER BY nedesde DESC "

OpenRecordset StrSql, rsConsult

DiasVacTomados = 0
If Not rsConsult.EOF Then
    DiasVacTomados = rsConsult!nevalor
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la hora según la escala
'------------------------------------------------------------------

StrSql = "SELECT vgrvalor from ("
StrSql = StrSql & "  SELECT * from("
StrSql = StrSql & "  SELECT tipoestructura.tenro as tenroA, tedabr as tedabrA, estrdabr as estrdabrA, teorden as teordenA, "
StrSql = StrSql & "  estructura.estrnro as estrnroA,his_estructura.ternro as ternroA "
StrSql = StrSql & " FROM his_estructura INNER JOIN tipoestructura "
StrSql = StrSql & " ON his_estructura.tenro = tipoestructura.tenro INNER JOIN estructura"
StrSql = StrSql & " ON estructura.estrnro = his_estructura.estrnro INNER JOIN claseestructura"
StrSql = StrSql & " ON tipoestructura.cenro = claseestructura.cenro LEFT JOIN adptte_estr "
StrSql = StrSql & " ON tipoestructura.tenro = adptte_estr.tenro AND tplatenro = 30"
StrSql = StrSql & " WHERE his_estructura.tenro =3 ) a"
StrSql = StrSql & " inner join ("
StrSql = StrSql & " SELECT tipoestructura.tenro as tenroB, tedabr as tedabrB, estrdabr as estrdabrB, teorden as teordenB,"
StrSql = StrSql & " estructura.estrnro as estrnroB,his_estructura.ternro as ternroB"
StrSql = StrSql & " FROM his_estructura INNER JOIN tipoestructura"
StrSql = StrSql & " ON his_estructura.tenro = tipoestructura.tenro INNER JOIN estructura"
StrSql = StrSql & " ON estructura.estrnro = his_estructura.estrnro INNER JOIN claseestructura"
StrSql = StrSql & " ON tipoestructura.cenro = claseestructura.cenro LEFT JOIN adptte_estr"
StrSql = StrSql & " ON tipoestructura.tenro = adptte_estr.tenro AND tplatenro = 30"
StrSql = StrSql & " WHERE his_estructura.tenro =19 and estructura.estrnro=627  ) b"
StrSql = StrSql & "  on a.ternroA = b.ternroB ) c "
StrSql = StrSql & " join (select * from valgrilla where cgrnro = 22 and vgrcoor_1= 627) d"
StrSql = StrSql & " on d.vgrcoor_1 =c.estrnrob and d.vgrcoor_2 =c.estrnroa"
StrSql = StrSql & " where c.ternroA = " & Ternro

       
OpenRecordset StrSql, rsConsult

ValorHora = 0
If Not rsConsult.EOF Then
   ValorHora = rsConsult!vgrvalor
Else
   ValorHora = 0
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxdeci1, auxchar1, auxchar2, auxchar3,"
StrSql = StrSql & " auxchar4,auxchar5,auxdeci2,auxdeci3,auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & numberForSQL(DiasVacTomados)
StrSql = StrSql & ",'" & DivPersonal & "'"
StrSql = StrSql & ",'" & Departamento & "'"
StrSql = StrSql & ",'" & LugarDeTrabajo & "'"
StrSql = StrSql & ",'" & CuentaBancaria & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & numberForSQL(PagoMonto)
StrSql = StrSql & "," & numberForSQL(arrFormaPago(FormaDePagoNro))
StrSql = StrSql & "," & numberForSQL(ValorHora)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 1
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo1
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo1(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo1(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'1')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 2
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo2
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo2(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo2(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'2')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next


'---------------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado, de la columna 3
'---------------------------------------------------------------------------

For Cont = 1 To cantAcumGrupo3
    
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " INNER JOIN con_acum ON concepto.concnro = con_acum.concnro AND con_acum.acunro = " & acumGrupo3(Cont)
    StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
        
    OpenRecordset StrSql, rsConsult
    
    Do Until rsConsult.EOF
      
        StrSql = " SELECT ternro FROM rep_recibo_det "
        StrSql = StrSql & " WHERE bpronro = " & NroProceso
        StrSql = StrSql & " AND ternro = " & Ternro
        StrSql = StrSql & " AND pronro = " & Pronro
        StrSql = StrSql & " AND concnro = " & rsConsult!ConcNro
        
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
            
              StrSql = " INSERT INTO rep_recibo_det "
              StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
              StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
              StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
              StrSql = StrSql & " VALUES"
              StrSql = StrSql & "(" & NroProceso
              StrSql = StrSql & "," & Ternro
              StrSql = StrSql & "," & Pronro
              StrSql = StrSql & "," & rsConsult!cliqnro
              StrSql = StrSql & ",'" & rsConsult!concabr & "'"
              StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
              StrSql = StrSql & "," & rsConsult!ConcNro
              StrSql = StrSql & "," & rsConsult!tconnro
              StrSql = StrSql & "," & acumGrupo3(Cont)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
              StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
              StrSql = StrSql & ",'3')"
              
              objConn.Execute StrSql, , adExecuteNoRecords
              
        End If
        
        rsConsult2.Close
        
        rsConsult.MoveNext
    
    Loop
    
    rsConsult.Close

Next

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Flecha Bus
'--------------------------------------------------------------------
Sub generarDatosRecibo21(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim calif_pers

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,fpagbanc, pago.banternro "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If CInt(rsConsult!fpagbanc) = -1 Then
    StrSql = " SELECT * "
    StrSql = StrSql & " FROM banco "
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " WHERE banco.ternro = " & rsConsult!banternro
       
    OpenRecordset StrSql, rsConsult2
    
    If Not rsConsult2.EOF Then
       FormaPago = rsConsult!fpagdescabr & " " & rsConsult!ctabnro
    End If
    rsConsult2.Close
    
  Else
    FormaPago = "Pago Efectivo"
  End If
Else
  FormaPago = " "
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Uruguay
'--------------------------------------------------------------------
Sub generarDatosRecibo22(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpMISS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'Consulta para obtener el MISS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 28)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MISS de la Empresa"
    'Exit Sub
    EmpMISS = "  "
Else
    EmpMISS = rs_cuit!NroDoc
End If

'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 13)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If

'Consulta para obtener el BSE de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 29)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BSE de la Empresa"
    'Exit Sub
    EmpBSE = "  "
Else
    EmpBSE = rs_cuit!NroDoc
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMISS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Deloitte Personal
'--------------------------------------------------------------------
Sub generarDatosRecibo23(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim oSocial
Dim Gerencia
Dim reportaa
Dim empreporta
Dim grupoSeguridad
Dim Sucursal

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer

Dim RRHHFirma As String
Dim RRHHFirmaAlto As Integer
Dim RRHHFirmaAncho As Integer
    
Dim proDesc As String
Dim tidnroRST As String
Dim codResolucion As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta y baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If




'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'buscar el valor del sueldo


StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acunroSueldo
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del sueldo"
   Sueldo = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

oSocial = ""

If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la gerencia
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Gerencia = ""

If Not rsConsult.EOF Then
   Gerencia = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la gerencia"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ctabestado=-1 AND ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From ctabancaria"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN banco ON banco.ternro =  ctabancaria.banco"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & "&nbsp;&nbsp;&nbsp;&nbsp;" & rsConsult!terrazsoc & "&nbsp;&nbsp;&nbsp;&nbsp;Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     'Me fijo si la ctabancaria no tiene asociado un banco, o sea es en efectivo
     StrSql = "SELECT fpagdescabr "
     StrSql = StrSql & " From ctabancaria"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
     
     rsConsult.Close
     OpenRecordset StrSql, rsConsult
     
     If Not rsConsult.EOF Then
        FormaPago = rsConsult!fpagdescabr
     Else
        Flog.writeline "Error, no se encuentra la forma de pago del empleado"
     End If
     
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,piso,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " Piso " & rs_Domicilio!Piso & "<br>" & rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'------------------------------------------------------------------
'Obtengo la configuracion del tipo de documento resolucion
'------------------------------------------------------------------
StrSql = " SELECT confval FROM confrep WHERE repnro = 60 AND confnrocol = 358 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    tidnroRST = rsConsult!confval
    Flog.writeline "Codigo de tipo de documento Resolucion encontrado."
Else
    tidnroRST = 0
    Flog.writeline "Codigo de tipo de documento Resolucion No encontrado."
End If

'Consulta para buscar el numero de resolucion de la empresa
StrSql = "SELECT nrodoc FROM ter_doc " & _
         " Where ternro =" & rs_estructura!Ternro & " AND ter_doc.tidnro = " & tidnroRST
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró nro de resolucion de la empresa"
    'Exit Sub
    codResolucion = 0
Else
    codResolucion = rsConsult!NroDoc
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'Consulta para buscar la firma del responsable de RRHH
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 15 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
    
    OpenRecordset StrSql, rs_firma
    
If rs_firma.EOF Then
    Flog.writeline "No se encontró la firma del responsable de RRHH"
    'Exit Sub
    RRHHFirma = ""
    RRHHFirmaAlto = 0
    RRHHFirmaAncho = 0
Else
    RRHHFirma = rs_firma!tipimdire & rs_firma!terimnombre
    RRHHFirmaAlto = rs_firma!tipimaltodef
    RRHHFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar6, auxdeci1, auxdeci2, auxchar7 )"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(oSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Gerencia, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sucursal, 1, 100) & "'"
StrSql = StrSql & ",'" & RRHHFirma & "'"
StrSql = StrSql & "," & RRHHFirmaAlto
StrSql = StrSql & "," & RRHHFirmaAncho
StrSql = StrSql & ",'" & codResolucion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de TTI
'--------------------------------------------------------------------
Sub generarDatosRecibo25(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Schering
'--------------------------------------------------------------------
Sub generarDatosRecibo26(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

   Direccion = ""
   Localidad = Direccion

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " (" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0
    
EmpFirma = ""
EmpFirmaAlto = 0
EmpFirmaAncho = 0

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Indra
'--------------------------------------------------------------------
Sub generarDatosRecibo27(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valorAcumHaberesConAp
Dim valorAcumNetoImp
Dim valorAcumRetImpuesto
Dim Sector
Dim AntigAnios  As Integer
Dim AntigMeses As Integer
Dim AntigDias As Integer
Dim Convenio
Dim Documento

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
' Busco el menor tidnro para el ternro que viene por parametro
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
'StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
StrSql = StrSql & " AND docu.tidnro in (SELECT MIN(tidnro) from ter_doc where ter_doc.ternro = " & Ternro & ")"
OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(Ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Haberes con aportes
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumHaberesConAp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumHaberesConAp = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de haberes con aportes"
   valorAcumHaberesConAp = 0
   'GoTo MError
End If

'Neto Imp.
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumNetoImp = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de netos imp."
   valorAcumNetoImp = 0
   'GoTo MError
End If


StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumRetImpuesto
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumRetImpuesto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de ret. impuesto."
   valorAcumRetImpuesto = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!terrazsoc & "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " (" & rs_Domicilio!codigopostal & " ) " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxdeci1,auxdeci2,auxdeci3,auxdeci4,auxdeci5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & numberForSQL(AntigAnios)
StrSql = StrSql & "," & numberForSQL(AntigMeses)
StrSql = StrSql & "," & numberForSQL(valorAcumHaberesConAp)
StrSql = StrSql & "," & numberForSQL(valorAcumNetoImp)
StrSql = StrSql & "," & numberForSQL(valorAcumRetImpuesto)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Edenor
'--------------------------------------------------------------------
Sub generarDatosRecibo28(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim regimenHor
Dim LugarPago
Dim lugartrabajo
Dim Convenio
Dim ConvenioNro
Dim Modalidad
Dim modalidadNro
Dim minutosjor

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim EmpActividad

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Sector
Dim AntigAnios  As Integer
Dim AntigMeses As Integer
Dim AntigDias As Integer
Dim Documento

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(Ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
   
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If CBool(rsConsult!fpagbanc) Then
        FormaPago = "01"
    Else
        FormaPago = "02"
End If

Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empactiv " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpActividad = rs_estructura!empactiv
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " (" & rs_Domicilio!codigopostal & " ) " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext, his_estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
     Convenio = rsConsult!estrcodext
     ConvenioNro = rsConsult!Estrnro
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
' Modalidad de Trabajo
'------------------------------------------------------------------
  StrSql = " SELECT estrdabr, estrcodext "
  StrSql = StrSql & " From his_estructura"
  StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
  StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 47 And his_estructura.ternro = " & Ternro
  
  OpenRecordset StrSql, rsConsult
  
  If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrcodext
   modalidadNro = rsConsult!Estrnro
  Else
   '   Flog.writeline "Error al obtener los datos de la modalidad de trabajo"
   '   GoTo MError
  End If
  rsConsult.Close
  
'------------------------------------------------------------------
'Obtiene la Cantidad de Minutos según la escala apropiada
'------------------------------------------------------------------
  StrSql = "SELECT valgrilla.vgrvalor"
  StrSql = StrSql & " FROM valgrilla"
  StrSql = StrSql & " WHERE valgrilla.vgrcoor_1 =" & ConvenioNro & "  AND valgrilla.vgrcoor_2 = " & modalidadNro & " AND cgrnro=18"
  
  OpenRecordset StrSql, rsConsult
  If Not rsConsult.EOF Then
   minutosjor = CInt(rsConsult(0)) / 60
  Else
   minutosjor = 1440 'Minutos que hay en un dia
  End If
  rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxchar2,auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ",'" & EmpActividad & "'"
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & minutosjor & "'"
StrSql = StrSql & ",'" & Modalidad & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos Glencore
'--------------------------------------------------------------------
Sub generarDatosRecibo29(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CategoriaCodExt
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim PuestoCodExt

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim EmpActividad
Dim modeloProc
Dim pliqdesc
Dim estadoCivil

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim tituloCategoria
Dim valorCategoria

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleado.empleg,empleado.terape,empleado.terape2,empleado.ternom,empleado.ternom2,empleado.empfaltagr,empleado.empremu,estcivdesabr "
StrSql = StrSql & " FROM empleado INNER JOIN tercero ON empleado.ternro= tercero.ternro "
StrSql = StrSql & " INNER JOIN estcivil ON estcivil.estcivnro= tercero.estcivnro "
StrSql = StrSql & " WHERE empleado.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   estadoCivil = rsConsult!estcivdesabr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   modeloProc = rsConsult!tprocdesc
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'------------------------------------------------------------------
'Busco el valor del tipo de estructura 32
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 32 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    
    If rsConsult!estrcodext <> "17" Then
    
        rsConsult.Close
        
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        
        OpenRecordset StrSql, rsConsult
    
        If Not rsConsult.EOF Then
           Sueldo = rsConsult!almonto
        Else
           Sueldo = 0
        End If
        
   Else
        Sueldo = 0
   End If
Else
   Sueldo = 0
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""

If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
CategoriaCodExt = ""

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaCodExt = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""
PuestoCodExt = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   PuestoCodExt = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

tituloCategoria = ""
valorCategoria = ""

If Puesto <> "" And PuestoCodExt <> "1" Then
   tituloCategoria = "Puesto"
Else
   tituloCategoria = "Categoria"
End If

If Categoria <> "" And CategoriaCodExt <> "1" Then
   valorCategoria = Categoria
Else
   If Puesto <> "" And PuestoCodExt <> "1" Then
      valorCategoria = Puesto
   Else
      valorCategoria = ""
   End If
End If

Categoria = valorCategoria

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empactiv " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpActividad = rs_estructura!empactiv
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5) "
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(EmpActividad, 1, 100) & "'"
StrSql = StrSql & ",'" & tituloCategoria & "'"
StrSql = StrSql & ",'" & estadoCivil & "'"
StrSql = StrSql & ",'" & modeloProc & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos Tetrapak
'--------------------------------------------------------------------
Sub generarDatosRecibo30(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim LugarPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Cia. Alimentos
'--------------------------------------------------------------------
Sub generarDatosRecibo31(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago
Dim ObraSocial

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Sitel
'--------------------------------------------------------------------
Sub generarDatosRecibo32(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

'Codigo de forma de liq quincenal
Const quincenal1 = 553
Const quincenal2 = 555

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim empFecAltarec2
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim quincena As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
 ' Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de liquidacion del empleado para ver si es quincenal
'------------------------------------------------------------------
quincena = " "

StrSql = "SELECT his_estructura.estrnro " & _
    " From his_estructura" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 22"
OpenRecordset StrSql, rs_estructura

If Not rs_estructura.EOF Then
    
    If (rs_estructura!Estrnro = quincenal1) Or (rs_estructura!Estrnro = quincenal2) Then
        'Miro que quincena es
        StrSql = " SELECT proceso.pronro, proceso.tprocnro, tprocdesc"
        StrSql = StrSql & " From Proceso"
        StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro"
        StrSql = StrSql & " Where Proceso.pronro = " & Pronro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!tprocdesc) Then
                quincena = Left(rsConsult!tprocdesc, 1)
            End If
        End If
        rsConsult.Close
    End If

End If

rs_estructura.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Baja Reconocida 2.
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = 0 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltarec2 = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltarec2 = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltarec2 & "'"
StrSql = StrSql & ",'" & quincena & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Bazar Avenida
'--------------------------------------------------------------------
Sub generarDatosRecibo33(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim fasrecofec

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la fecha baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta para la antiguedad
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & " AND fasrecofec = -1" & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      fasrecofec = "'" & rsConsult!altfec & "'"
   Else
      fasrecofec = "null"
   End If
Else
   fasrecofec = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!provdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pafo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 24 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & "," & fasrecofec
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Ampacet
'--------------------------------------------------------------------
Sub generarDatosRecibo34(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim proFecplan
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String


Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecplan, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   proFecplan = rsConsult!proFecplan
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & proFecplan & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Wella
'--------------------------------------------------------------------
Sub generarDatosRecibo36(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim regimenHor
Dim Puesto
Dim Documento
Dim Sector
Dim LugarDePago
Dim ObraSocial

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valoracumAuxDeci1
Dim valoracumAuxDeci2
Dim valoracumAuxDeci3
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'AcumAuxDeci1
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci1
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci1 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci1 = 0
   'GoTo MError
End If

'AcumAuxDeci2
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci2
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci2 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci2 = 0
   'GoTo MError
End If

'AcumAuxDeci3
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci3
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valoracumAuxDeci3 = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del Acumulador"
   valoracumAuxDeci3 = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarDePago = ""

If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenHor & "'"
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci1)
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci2)
StrSql = StrSql & "," & numberForSQL(valoracumAuxDeci3)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Andreani Logistica
'--------------------------------------------------------------------
Sub generarDatosRecibo35(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim codResolucion As String
Dim tidnroRST As String

Dim rs_confrep As New ADODB.Recordset
Dim rs_resolucion As New ADODB.Recordset
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0


'------------------------------------------------------------------
'Obtengo la configuracion del tipo de documento resolucion
'------------------------------------------------------------------
StrSql = " SELECT confval FROM confrep WHERE repnro = 60 AND confnrocol = 358 "
OpenRecordset StrSql, rs_confrep
If Not rs_confrep.EOF Then
    tidnroRST = rs_confrep!confval
    Flog.writeline "Codigo de tipo de documento Resolucion encontrado."
Else
    tidnroRST = 0
    Flog.writeline "Codigo de tipo de documento Resolucion No encontrado."
End If


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

SueldoRemu = 0
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
   Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la ultima Fecha de Alta del empleado de la fase
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If


'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "SUELDO", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del tipo
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 57 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!estrcodext
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    
    Sueldo = 0
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'Si no encuentra el sueldo asigno el del tablero del empleado
If Sueldo = 0 Then Sueldo = SueldoRemu
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "    los datos del sector OK"
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = ""
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el numero de resolucion de la empresa
StrSql = "SELECT nrodoc FROM ter_doc " & _
         " Where ternro =" & rs_estructura!Ternro & " AND ter_doc.tidnro = " & tidnroRST
OpenRecordset StrSql, rs_resolucion
If rs_resolucion.EOF Then
    Flog.writeline "No se encontró nro de resolucion de la empresa"
    'Exit Sub
    codResolucion = 0
Else
    codResolucion = rs_resolucion!NroDoc
End If



'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5,auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & codResolucion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Carsa
'--------------------------------------------------------------------
Sub generarDatosRecibo38(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim funciones

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de Funciones
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
   funciones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de Funciones"
'   GoTo MError
    funciones = ""
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
Puesto = ""
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close
'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND real= -1"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
   Flog.writeline "la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase +
'antigua con real en true.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec ASC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    Fecha de Alta del Empleado Fase + antigua OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado Fase + antigua"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(funciones, 1, 60) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Telearte
'--------------------------------------------------------------------
Sub generarDatosRecibo37(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim funciones

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim pliqdesc As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult
pliqdesc = ""
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = IIf(EsNulo(rsConsult!pliqdesc), "", rsConsult!pliqdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de Funciones
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
   funciones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de Funciones"
'   GoTo MError
    funciones = ""
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
Puesto = ""
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Marsh
'--------------------------------------------------------------------
Sub generarDatosRecibo39(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim Banco
Dim Cuenta
Dim Sucursal


Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fases.empleado = " & Ternro & " AND fases.real = -1 "
StrSql = StrSql & " ORDER BY altfec DESC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!bajfec) Then
        empFecBaja = rsConsult!bajfec
    Else
        empFecBaja = "  "
    End If
Else
    empFecBaja = "  "
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la Sucursal
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la Sucursal del empleado"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la sucursal del empleado"
   Sucursal = ""
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   'CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
 

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,ctabcbu,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr
    Banco = rsConsult!terrazsoc
    If Not EsNulo(rsConsult!ctabcbu) And (rsConsult!ctabcbu <> "0") Then
        Cuenta = rsConsult!ctabcbu
    Else
        Cuenta = rsConsult!ctabnro
    End If
  Else
    FormaPago = rsConsult!fpagdescabr
    Banco = rsConsult!terrazsoc
    If Not EsNulo(rsConsult!ctabcbu) Then
        Cuenta = rsConsult!ctabcbu
    Else
        Cuenta = rsConsult!ctabnro
    End If
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,formapago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para BIA (Banco Industrial Azul)
'--------------------------------------------------------------------
Sub generarDatosRecibo40(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim antReconocida
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim regimenJub
Dim Contrato
Dim LugarPago
Dim Departamento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim MontoTickets As Double

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "No se encontraron los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    If IsNull(rsConsult!empremu) Then
        Sueldo = 0
    Else
        Sueldo = rsConsult!empremu
    End If
   
    StrSql = "SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado = " & Ternro & " AND real = -1 "
    OpenRecordset StrSql, rs_Fases
    If Not rs_Fases.EOF Then
        empFecAlta = rs_Fases!altfec
    Else
        empFecAlta = rsConsult!empfaltagr
    End If
    rs_Fases.Close
    
Else
    Flog.writeline "No se encontraron los datos del empleado."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "No se encontraron los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Antigüedad reconocida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 39 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

antReconocida = ""

If Not rsConsult.EOF Then
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases"
    StrSql = StrSql & " WHERE fases.empleado = " & Ternro & " AND fases.estado = 0"
    OpenRecordset StrSql, rs_Fases
    If Not rs_Fases.EOF Then
        antReconocida = rs_Fases!altfec
    End If
    rs_Fases.Close
Else
    Flog.writeline "No se encontro la Antigüedad reconocida del empleado."
'    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "No se encontraron los datos del cuil."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos de la categoría."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos del puesto."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "No se encontraron los datos del sector."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del departamento."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Forma de Contratación (Contrato Actual)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=18 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""
If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Contrato Actual."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""
If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Régimen Jubilatorio."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""
If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos del Lugar de Pago."
'   GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabancaria.ctabnro, formapago.fpagdescabr, formapago.fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " INNER JOIN ctabancaria on pago.cbnro = ctabancaria.cbnro"

OpenRecordset StrSql, rsConsult

FormaPago = "Forma de Pago: Dep&oacute;sito Bancario"
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Forma de Pago: " & rsConsult!fpagdescabr & " - Cuenta N&deg; " & rsConsult!ctabnro
    End If
Else
   Flog.writeline "No se encontraron los datos de la forma de pago."
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(antReconocida, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenJub, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Paolini
'--------------------------------------------------------------------
Sub generarDatosRecibo41(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim Sector
Dim Contrato
Dim empFecBaja
Dim empFecAltaReal

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim tipo80 As String
Dim tipo81 As String
Dim Cod80Acum As Long
Dim Cod81Acum As Long
Dim Cod80Conc As String
Dim Cod81Conc As String
Dim valor80 As Double
Dim valor81 As Double

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta reconocida
'------------------------------------------------------------------
empFecAlta = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de alta de fase activa
'------------------------------------------------------------------
empFecAltaReal = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.bajfec is null  "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaReal = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columna 80 y 81 para del confrep para imp. adicional y Asig rem"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 80 OR confnrocol = 81)"
OpenRecordset StrSql, rsConsult

tipo80 = ""
tipo81 = ""
valor80 = 0
valor81 = 0

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 80
             If rsConsult!conftipo = "AC" Then
                tipo80 = "AC"
                Cod80Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo80 = "CO"
                Cod80Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna80: " & tipo80 & " concepto: " & Cod80Conc & " acumulador: " & Cod80Acum
      Case 81
             If rsConsult!conftipo = "AC" Then
                tipo81 = "AC"
                Cod81Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo81 = "CO"
                Cod81Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna81: " & tipo81 & " concepto: " & Cod81Conc & " acumulador: " & Cod81Acum
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   Else
      empFecBaja = ""
   End If
Else
   empFecBaja = ""
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE cabdom.domdefault = -1 AND"
StrSql = StrSql & " cabdom.ternro = " & Ternro

OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la columna 80 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
valor80 = 0
Select Case tipo80
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor80 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod80Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor80 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la columna 81 del confrep, ASIGN. REM.
'------------------------------------------------------------------
valor81 = 0
Select Case tipo81
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod81Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor81 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod81Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor81 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen = " & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " (" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0
    
' 12/06/2007 - G. Bauer - N. Trillo - Se agrego la consulta para que vaya a buscar la firma de la empresa y salga en el recibo modelo 41 para Paolini.
'EmpFirma = ""
'EmpFirmaAlto = 0
'EmpFirmaAncho = 0

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, "
StrSql = StrSql & " auxchar1, auxdeci1, auxdeci2, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & "," & valor80
StrSql = StrSql & "," & valor81
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecAltaReal, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Megatone
'--------------------------------------------------------------------
Sub generarDatosRecibo42(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim Calificacion
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim empFecBaja
Dim Contrato
Dim LugarPago
Dim Sucursal
Dim Departamento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfecalta,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la fecha de ingreso
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases WHERE empleado = " & Ternro & " AND real = -1 AND estado = -1 " & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult
empFecAlta = ""
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la fecha de ingreso. Verificar que tenga una fase marcada como REAL y ACTIVA"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " AND detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo. Se puede configurar de tipo concepto (CO) o de cualquier otro tipo y se considera como acumulador"
   Sueldo = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la calificacion Profecional. Puesto (4)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
Puesto = " "
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la calificación profesional (Puesto)"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del la contratacion (Contrato Actual)"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Lugar de Pago"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""

If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Departamento"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT * FROM ctabancaria WHERE ctabestado=-1 AND ternro = " & ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'  If rsConsult.RecordCount = 1 Then
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
'     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'     StrSql = StrSql & " From ctabancaria"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
'     StrSql = StrSql & " LEFT JOIN banco ON banco.ternro =  ctabancaria.banco"
'     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
'  Else
'     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'     StrSql = StrSql & " From pago"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'  End If
'  rsConsult.Close
'  OpenRecordset StrSql, rsConsult
'  If Not rsConsult.EOF Then
'     If CBool(rsConsult!fpagbanc) Then
'        FormaPago = rsConsult!fpagdescabr
'     Else
'        FormaPago = rsConsult!fpagdescabr
'     End If
'  Else
     'Me fijo si la ctabancaria no tiene asociado un banco, o sea es en efectivo
'     StrSql = "SELECT fpagdescabr "
'     StrSql = StrSql & " From ctabancaria"
'     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
'     StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & ternro
'     rsConsult.Close
'     OpenRecordset StrSql, rsConsult
'     If Not rsConsult.EOF Then
'        FormaPago = rsConsult!fpagdescabr
'     Else
'        Flog.writeline "Error, no se encuentra la forma de pago del empleado"
'     End If
'  End If
'Else
'   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
'End If
'rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,piso,codigopostal, provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON provincia.provnro = localidad.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " " & rs_Domicilio!locdesc & " - " & rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para BNP Paribas Argentina
'--------------------------------------------------------------------
Sub generarDatosRecibo43(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim DiasPtes
Dim CabliqNumero
Dim Ticket
Dim MontoTickets
Dim CantTickets

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
   Categoria = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de los Dias Pendientes de Licencia de vacaciones
'------------------------------------------------------------------
StrSql = " SELECT vdiascorcant "
StrSql = StrSql & " FROM vacdiascor "
StrSql = StrSql & " WHERE ternro = " & Ternro
OpenRecordset StrSql, rsConsult

DiasPtes = 0
Do Until rsConsult.EOF
   DiasPtes = DiasPtes + rsConsult!vdiascorcant
   rsConsult.MoveNext
Loop
rsConsult.Close


StrSql = " SELECT vdiapedcant "
StrSql = StrSql & " FROM vacdiasped "
StrSql = StrSql & " WHERE ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
   DiasPtes = DiasPtes - rsConsult!vdiapedcant
   rsConsult.MoveNext
Loop
rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT concepto.conccod AS codigo, concepto.concabr AS descripcion, detliq.dlimonto AS valor, detliq.dlicant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro "
Else
    StrSql = " SELECT acumulador.acunro AS codigo, acumulador.acudesabr AS descripcion, acu_liq.almonto AS valor, acu_liq.alcant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro "
End If
    
OpenRecordset StrSql, rsConsult

CabliqNumero = 0
Ticket = "&nbsp;"
MontoTickets = 0
CantTickets = 0

If Not rsConsult.EOF Then
    CabliqNumero = rsConsult!cliqnro
    Ticket = rsConsult!codigo & " " & rsConsult!Descripcion
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    If Not IsNull(rsConsult!Cantidad) Then
       CantTickets = CantTickets + CDbl(rsConsult!Cantidad)
    End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxdeci1, auxchar1, auxdeci2, auxchar2, auxdeci3, auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & DiasPtes
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & ",'" & Ticket & "'"
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & CantTickets
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para LIGGETT
'--------------------------------------------------------------------
Sub generarDatosRecibo44(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim tprocdesc
Dim CabliqNumero
Dim vhora
Dim bonos

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
   tprocdesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del V.HORA/BASICO."
   vhora = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de los bonos, definido en la columna 43 del confrep
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   bonos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos de los BONOS."
   bonos = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el cod externo del sector
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el cod externo de la forma de liquidacion
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!estrcodext = 2 Or rsConsult!estrcodext = 4 Then
        pliqdesc = Mid(tprocdesc, 1, 12) & " " & pliqmes & "-" & pliqanio
    End If
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxdeci1, auxdeci2 )"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & vhora
StrSql = StrSql & "," & bonos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Bazar REDEPA
'--------------------------------------------------------------------
Sub generarDatosRecibo45(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim fasrecofec

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim tipo90 As String
Dim tipo91 As String
Dim Cod90Acum As Long
Dim Cod91Acum As Long
Dim Cod90Conc As String
Dim Cod91Conc As String
Dim valor90 As Double
Dim valor91 As Double


Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Buscando columna 90 y 91 para del confrep para imp. adicional y antig"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 90 or confnrocol = 91)"
OpenRecordset StrSql, rsConsult

tipo90 = ""
tipo91 = ""
valor90 = 0
valor91 = 0

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 90
             If rsConsult!conftipo = "AC" Then
                tipo90 = "AC"
                Cod90Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo90 = "CO"
                Cod90Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna90: " & tipo90 & " concepto: " & Cod90Conc & " acumulador: " & Cod90Acum
      Case 91
             If rsConsult!conftipo = "AC" Then
                tipo91 = "AC"
                Cod91Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo91 = "CO"
                Cod91Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna91: " & tipo91 & " concepto: " & Cod91Conc & " acumulador: " & Cod91Acum
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la columna 90 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
valor90 = 0
Select Case tipo90
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod90Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor90 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod90Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor90 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la columna 91 del confrep, Antig.
'------------------------------------------------------------------
valor91 = 0
Select Case tipo91
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod91Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor91 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod91Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor91 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco la fecha baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de alta para la antiguedad
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & " AND fasrecofec = -1" & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      fasrecofec = "'" & rsConsult!altfec & "'"
   Else
      fasrecofec = "null"
   End If
Else
   fasrecofec = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!provdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pafo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
'   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 24 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, "
StrSql = StrSql & " auxdeci1, auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & "," & fasrecofec
StrSql = StrSql & "," & valor90
StrSql = StrSql & "," & valor91
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Codere
'--------------------------------------------------------------------
Sub generarDatosRecibo48(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CabliqNumero

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim LugarPago As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del lugar de pago"
   LugarPago = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If Sueldo = 0 Then
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo."
       Sueldo = 0
       'GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!terrazsoc & " Cuenta: " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.Writeline "Error al obtener los datos de la forma de pago."
'   FormaPago = "&nbsp;"
''   GoTo MError
'End If
'
'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
'    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If
'
''Consulta para obtener la direccion de la empresa
'StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal From cabdom " & _
'    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_Domicilio
'If rs_Domicilio.EOF Then
'    Flog.Writeline "No se encontró el domicilio de la empresa."
'    'Exit Sub
    EmpDire = "&nbsp;"
'Else
'    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!Nro
'End If
'
''Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.Writeline "No se encontró el CUIT de la Empresa."
'    'Exit Sub
    EmpCuit = "&nbsp;"
'Else
'    EmpCuit = rs_cuit!nrodoc
'End If
'
''Consulta para buscar el logo de la empresa
'StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
'    " From ter_imag " & _
'    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
'    " AND ter_imag.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_logo
'If rs_logo.EOF Then
'    Flog.Writeline "No se encontró el Logo de la Empresa."
'    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
'Else
'    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
'    EmpLogoAlto = rs_logo!tipimaltodef
'    EmpLogoAncho = rs_logo!tipimanchodef
'End If
'
''Consulta para buscar la firma de la empresa
'StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
'    " From ter_imag " & _
'    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
'    " AND ter_imag.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_firma
'If rs_firma.EOF Then
'    Flog.Writeline "No se encontró el Firma de la Empresa."
'    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
'Else
'    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
'    EmpFirmaAlto = rs_firma!tipimaltodef
'    EmpFirmaAncho = rs_firma!tipimanchodef
'End If
'
'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Distribuidora Metropolitana
'--------------------------------------------------------------------
Sub generarDatosRecibo46(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CabliqNumero
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el sector, en realidad Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social elegida."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!terrazsoc & " Cuenta: " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & " ," & cliqnro
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Tetra
'--------------------------------------------------------------------
Sub generarDatosRecibo49(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

'Codigo de forma de liq quincenal
Const quincenal1 = 553
Const quincenal2 = 555

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim dni
Dim empFecAlta
Dim empFecAltaRec
Dim empFecAltarec2
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim quincena As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT dni.nrodoc " & _
         " FROM tercero LEFT JOIN ter_doc dni ON tercero.ternro = dni.ternro and dni.tidnro = 1 " & _
         " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   dni = rsConsult!NroDoc
Else
    dni = ""
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
Direccion = ""
Localidad = ""

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

'---LOG---
Flog.writeline "Buscando datos de la direccion de la sucursal"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de liquidacion del empleado para ver si es quincenal
'------------------------------------------------------------------
quincena = " "

StrSql = "SELECT his_estructura.estrnro " & _
    " From his_estructura" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 22"
OpenRecordset StrSql, rs_estructura

If Not rs_estructura.EOF Then
    
    If (rs_estructura!Estrnro = quincenal1) Or (rs_estructura!Estrnro = quincenal2) Then
        'Miro que quincena es
        StrSql = " SELECT proceso.pronro, proceso.tprocnro, tprocdesc"
        StrSql = StrSql & " From Proceso"
        StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro"
        StrSql = StrSql & " Where Proceso.pronro = " & Pronro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!tprocdesc) Then
                quincena = Left(rsConsult!tprocdesc, 1)
            End If
        End If
        rsConsult.Close
    End If

End If

rs_estructura.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Baja Reconocida 2.
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = 0 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltarec2 = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltarec2 = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 28) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltarec2 & "'"
StrSql = StrSql & ",'" & quincena & "'"
StrSql = StrSql & ",'" & dni & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



' ***************************

'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de Divino - Uruguay
'--------------------------------------------------------------------
Sub generarDatosRecibo50(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTickets As Double
Dim vhora

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMISS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

' _____________________________________________________________________________
' Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS
' _____________________________________________________________________________

Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If

rsConsult.Close

' _________________________________________________________________________

       


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   ' el sueldo se saca del concepto 01000
   Sueldo = 0
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = " "
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'Se cambio -- Sueldo se busca en la columna 44
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo (en los datos del empleado setee la variable Sueldo=0)

'If Sueldo = 0 Then
'    If esSueldoConc Then
'        StrSql = " SELECT detliq.dlimonto valor "
'        StrSql = StrSql & " FROM detliq "
'        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
'    Else
'        StrSql = " SELECT almonto valor"
'        StrSql = StrSql & " From acu_liq"
'        StrSql = StrSql & " Where acunro = " & acunroSueldo
'        StrSql = StrSql & " AND cliqnro = " & cliqnro
'    End If
    
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!Valor
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo (col 1)."
'       Sueldo = 0
       'GoTo MError
'    End If
'End If



'------------------------------------------------------------------
'Busco el valor del Monto Tickets, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
    
        'CabliqNumero = rsConsult!cliqnro
        If Not IsNull(rsConsult!Valor) Then
            MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
        End If
    
        rsConsult.MoveNext
    Loop
Else
      Flog.writeline " No se encontraron datos de MONTO TICKETS (col42)."

End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 43 del confrep
' Se cometa porque en BA se uso la columna 44 para vhora
'Se cambio -- se usa col 43 para v. hora.
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

vhora = 0
If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de V.HORA/BASICO. (col43)"
   vhora = 0
   'GoTo MError
End If


'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

Sueldo = 0
If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
Categoria = " "
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
CentroCosto = " "
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult
FormaPago = " "

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = " "
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para obtener el MISS de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 28)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el MISS de la Empresa"
'    EmpMISS = "  "
'Else
'    EmpMISS = rs_cuit!nrodoc
'End If
 EmpMISS = "  "

' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If


' -------------------------------------------------------------------------
'Consulta para obtener el BSE de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 29)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el BSE de la Empresa"
'    EmpBSE = "  "
'Else
'    EmpBSE = rs_cuit!nrodoc
'End If
'rs_estructura.Close
 EmpBSE = "  "


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
'Flog.Writeline "======================================================================================================================================="
'Flog.Writeline ":::INSERTO EN REP_RECIBO::: "
'Flog.Writeline "Sueldo=" & Sueldo
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden "
StrSql = StrSql & " , auxchar1, auxchar2, auxchar3, auxchar4 "
StrSql = StrSql & " , auxdeci1, auxdeci2 "
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMISS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & "," & numberForSQL(MontoTickets)
StrSql = StrSql & "," & numberForSQL(vhora)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Darmex
'--------------------------------------------------------------------
Sub generarDatosRecibo51(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Long
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpRazSoc As String
Dim EmpDire As String
Dim EmpProv As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   If IsNull(rsConsult!empremu) Then
'      Sueldo = 0
'   Else
'      Sueldo = rsConsult!empremu
'   End If
         Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    Flog.writeline "    la Fecha de Alta del Empleado OK - alta fase"
Else
    rsConsult.Close
    StrSql = " SELECT empfaltagr "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!empfaltagr
        Flog.writeline "    la Fecha de Alta del Empleado OK - empaltagr"
    Else
        Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = ""
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase +
'antigua con real en true.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE real = -1 AND fases.empleado=" & Ternro & " order by altfec ASC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Antiguedad = rsConsult!altfec
   Flog.writeline "    Fecha de Alta del Empleado Fase + antigua OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado Fase + antigua"
   Antiguedad = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
   Localidad = rsConsult!locdesc
   Flog.writeline "    los datos de la localidad OK"
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

'sector = ""

'If Not rsConsult.EOF Then
'   sector = rsConsult!estrdabr
'   Flog.Writeline "    los datos del sector OK"
'Else
'   Flog.Writeline "Error al obtener los datos del sector"
'   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   'CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
Cuenta = ""

StrSql = " SELECT estructura.estrdabr, ctabancaria.ctabnro "
StrSql = StrSql & " FROM ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = banco.estrnro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Banco = rsConsult!estrdabr
    Cuenta = rsConsult!ctabnro
    Flog.writeline "    los datos de Cuenta + Banco OK [<" & Cuenta & "><" & Banco & ">]"
Else
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, tercero.terrazsoc " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " INNER JOIN tercero ON tercero.ternro = empresa.ternro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpRazSoc = rs_estructura!terrazsoc
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,provincia.provdesc FROM cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON localidad.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    EmpProv = rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpRazSoc & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & EmpProv & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Aadi-Capif
'--------------------------------------------------------------------
Sub generarDatosRecibo52(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim tprocdesc
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CajaJubilacion
Dim Adicsinapo As Double
Dim Msr As Double
Dim Dtos As Double

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "    Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "    Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,periodo.pliqDesc,periodo.pliqhasta,proceso.prodesc,tipoproc.tprocdesc,tipoproc.tprocnro FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " LEFT JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    ProcDesc = rsConsult!proDesc
    tprocdesc = "  "
    If EsNulo(rsConsult!tprocnro) Then
        Flog.writeline "    El tipo del proceso no esta definido para el proceso. SQL ==> " & StrSql
    Else
        If rsConsult!tprocnro <> 3 Then
            tprocdesc = rsConsult!tprocdesc
        Else
            tprocdesc = rsConsult!pliqdesc
        End If
    End If
Else
   Flog.writeline "    Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = "  "
   Flog.writeline "    Error al obtener los datos del CUIL del Empleado"
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "  "
If Not rsConsult.EOF Then
   Puesto = rsConsult!Estrnro
Else
   Flog.writeline "    Error al obtener los datos del puesto a la fecha " & pliqhasta
End If

'------------------------------------------------------------------
'Busco el valor de la caja de Jubilación
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = "  "
If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
   Flog.writeline "    Error al obtener los datos de la Caja de Jubilacion a la fecha " & pliqhasta
End If

'------------------------------------------------------------------
'Busco el valor del sueldo neto
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acunroSueldo
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener los datos del sueldo neto. Columna 1 de la configuración"
   Sueldo = 0
End If

'------------------------------------------------------------------
'Busco el valor del los descuentos
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumRetImpuesto
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Dtos = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con Descuentos. Columna 62 de la configuración"
   Dtos = 0
End If

'------------------------------------------------------------------
'Busco el valor del msr
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Msr = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con Msr. Columna 61 de la configuración"
   Msr = 0
End If

'------------------------------------------------------------------
'Busco el valor del adicsinapo
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumHaberesConAp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Adicsinapo = rsConsult!almonto
Else
   Flog.writeline "    Error al obtener el acumulador con AdicSinAp. Columna 60 de la configuración"
   Adicsinapo = 0
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "    No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " WHERE cabdom.domdefault = -1 "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "    No se encontró el domicilio indicado como default de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " Piso " & rs_Domicilio!Piso
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & Tickets & ")" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "    No se encontró el CUIT de la Empresa"
    If esTicketsConc Then
        Flog.writeline "       El paramétro 42 esta definido de TIPO 'CO'. Cambielo por otro tipo distinto"
    End If
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
EmpLogo = ""
EmpLogoAlto = 0
EmpLogoAncho = 0

'Consulta para buscar la firma de la empresa
EmpFirma = ""
EmpFirmaAlto = 0
EmpFirmaAncho = 0

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "  "
   pliqfecdep = "  "
   pliqbco = "  "
   Flog.writeline "    No se encontraron los datos de las cargas sociales"
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & numberForSQL(EmpLogoAlto)
StrSql = StrSql & "," & numberForSQL(EmpLogoAncho)
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & numberForSQL(EmpFirmaAlto)
StrSql = StrSql & "," & numberForSQL(EmpFirmaAncho)
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(CajaJubilacion, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(tprocdesc, 1, 100) & "'"
StrSql = StrSql & "," & numberForSQL(Adicsinapo)
StrSql = StrSql & "," & numberForSQL(Msr)
StrSql = StrSql & "," & numberForSQL(Dtos)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para mercado central
'--------------------------------------------------------------------
Sub generarDatosRecibo53(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para L'Union de Paris
'--------------------------------------------------------------------
Sub generarDatosRecibo54(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto"
StrSql = StrSql & " From tercero "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = tercero.ternro AND tercero.ternro = " & Ternro
StrSql = StrSql & " AND cabdom.domdefault = -1 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
'05/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir
If Not rsConsult.EOF Then
    'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CCU
'--------------------------------------------------------------------
Sub generarDatosRecibo55(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Neto
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
'    rsConsult.Close
'    StrSql = " SELECT altfec "
'    StrSql = StrSql & " FROM fases "
'    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'        empFecAlta = rsConsult!altfec
'    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
'    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)

Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
'CAS-02416 - Rotacion empresa
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux

End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " LEFT JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " LEFT JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " LEFT JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If Tickets <> 0 Then
    'Columna 42
    If esTicketsConc Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Tickets & " AND novemp.tpanro = 1"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Sueldo = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Tickets & ") y parámetro 1."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 1"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   Sueldo = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 1."
                End If
           Else
                Flog.writeline "Error al obtener el valor del Básico. La columna 43 del confrep debe ser un concepto, de tipo 'CO'."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor del Básico. La columna 42 del confrep debe ser un concepto, de tipo 'CO'."
    End If
    
Else
    Flog.writeline "Error al obtener el valor del Básico. No esta configurado el concepto en la columna 42 del confrep."
End If
    
    
If Sueldo = 0 Then
    'Buscar en la escala de Básicos
    
    'Determinar la sucursal del empleado. Ya la tengo
    If SucursalNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Sucursal para determinar la escala del Básico."
    End If
    
    'Determinar el Convenio del empleado.
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       ConvenioNro = rsConsult!Estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
       ConvenioNro = 0
    '   GoTo MError
    End If
    
    'Determinar la categoria del empleado. Ya la tengo
    If CategoriaNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría para determinar la escala del Básico."
    End If
    
    'Determinar la Forma de Liquidacion
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       FormaLiqNro = rsConsult!Estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidación para determinar la escala del Básico."
       FormaLiqNro = 0
    '   GoTo MError
    End If
    
    StrSql = " SELECT vgrvalor FROM valgrilla "
    StrSql = StrSql & " WHERE cgrnro = 4 "
    StrSql = StrSql & " AND vgrcoor_1 = " & SucursalNro
    StrSql = StrSql & " AND vgrcoor_2 = " & ConvenioNro
    StrSql = StrSql & " AND vgrcoor_3 = " & CategoriaNro
    StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!vgrvalor
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Básico. No se encontro. SQL --> " & StrSql
    End If
    
End If

If Sueldo = 0 And acumHaberesConAp <> 0 Then
    'Columna 60
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acumHaberesConAp
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
       Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo del acumulador " & acumHaberesConAp
    End If
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Neto = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Neto = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto a ensobrar. Se debe configurar en la columna 1 del confrep."
   Neto = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

''------------------------------------------------------------------
''Busco el valor de la Antigüedad
''------------------------------------------------------------------
'valorAntig = 0
'If SueldoRecibo <> 0 Then
'    'Columna 42
'    If esSueldoRecibo Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           valorAntig = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   valorAntig = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
'           End If
'           'FIN MENSUALES
'
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
'        valorAntig = 0
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
'    valorAntig = 0
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1, auxdeci2,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & "," & Neto & ",'" & Sector
StrSql = StrSql & "')"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CCU - Finca
'--------------------------------------------------------------------
Sub generarDatosRecibo56(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto
Dim BancoPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim AntigGrilla
Dim salir
Dim Contrato

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
'    rsConsult.Close
'    StrSql = " SELECT altfec "
'    StrSql = StrSql & " FROM fases "
'    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'        empFecAlta = rsConsult!altfec
'    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
'    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)

'FB - 17/06/2014 - Se corrige el cálculo de la antiguedad
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)


If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
   Contrato = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Básico. Se debe configurar en la columna 1 del confrep."
   Sueldo = 0
'   GoTo MError
End If


'If concnroVacPend <> 0 Then
'    StrSql = " SELECT novemp.nevalor valor "
'    StrSql = StrSql & " FROM novemp "
'    StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & concnroVacPend & " AND novemp.tpanro = 1"
'    OpenRecordset StrSql, rsConsult
'
'    If Not rsConsult.EOF Then
'        Sueldo = rsConsult!Valor
'        Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & concnroVacPend & ") y parámetro 1."
'    Else
'        'Buscar en la escala de Básicos
'
'        'Determinar el Convenio del empleado.
'        StrSql = " SELECT his_estructura.estrnro "
'        StrSql = StrSql & " From his_estructura"
'        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & ternro
'        OpenRecordset StrSql, rsConsult
'        If Not rsConsult.EOF Then
'           ConvenioNro = rsConsult!estrnro
'        Else
'           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
'           ConvenioNro = 0
'        End If
'
'        'Determinar la categoria del empleado. Ya la tengo
'        If CategoriaNro = 0 Then
'           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría para determinar la escala del Básico."
'        End If
'
'        'Determinar la Antiguedad, columna 90 del confrep
'        StrSql = " SELECT * FROM confrep "
'        StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 90"
'        OpenRecordset StrSql, rsConsult
'        If rsConsult.EOF Then
'            Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Antigüedad para determinar la escala del Básico. No esta configurada la columna 90. Tipo posibles AC (acumulador), CAN (cantidad del concepto), MON (monto del concepto)."
'            AntigGrilla = 0
'        Else
'            If rsConsult!conftipo = "AC" Then
'                StrSql = " SELECT almonto valor"
'                StrSql = StrSql & " From acu_liq"
'                StrSql = StrSql & " Where acunro = " & rsConsult!confval
'                StrSql = StrSql & " AND cliqnro = " & cliqnro
'                OpenRecordset StrSql, rs_estructura
'
'                If Not rs_estructura.EOF Then
'                   AntigGrilla = rs_estructura!Valor
'                End If
'
'                rs_estructura.Close
'            Else
'                StrSql = "SELECT detliq.dlicant, detliq.dlimonto "
'                StrSql = StrSql & " FROM concepto INNER JOIN detliq ON concepto.concnro = detliq.concnro"
'                StrSql = StrSql & " WHERE conccod = " & rsConsult!confval
'                If Not EsNulo(rsConsult!confval2) Then
'                    StrSql = StrSql & " OR conccod = '" & rsConsult!confval2 & "'"
'                End If
'                StrSql = StrSql & " AND detliq.cliqnro = " & cliqnro
'                OpenRecordset StrSql, rs_estructura
'
'                If rsConsult!conftipo = "CAN" Then
'                    AntigGrilla = rs_estructura!dlicant
'                Else
'                    AntigGrilla = rs_estructura!dlimonto
'                End If
'
'                rs_estructura.Close
'            End If
'        End If
'
'        'Determinar la Forma de Liquidacion
'        StrSql = " SELECT his_estructura.estrnro "
'        StrSql = StrSql & " From his_estructura"
'        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & ternro
'        OpenRecordset StrSql, rsConsult
'        If Not rsConsult.EOF Then
'           FormaLiqNro = rsConsult!estrnro
'        Else
'           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidación para determinar la escala del Básico."
'           FormaLiqNro = 0
'        End If
'
'        StrSql = " SELECT vgrcoor_3, vgrvalor FROM valgrilla "
'        StrSql = StrSql & " WHERE cgrnro = 45 "
'        StrSql = StrSql & " AND vgrcoor_1 = " & ConvenioNro
'        StrSql = StrSql & " AND vgrcoor_2 = " & CategoriaNro
'        StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
'        StrSql = StrSql & " ORDER BY vgrcoor_3 DESC"
'        OpenRecordset StrSql, rsConsult
'        salir = False
'        Do Until rsConsult.EOF Or salir
'            If (AntigGrilla >= rsConsult!vgrcoor_3) Then
'                salir = True
'                Sueldo = rsConsult!vgrvalor
'            End If
'            rsConsult.MoveNext
'        Loop
'
'        If Not salir Then
'           Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Básico. No se encontro. SQL --> " & StrSql
'        End If
'
'    End If
'Else
'     Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 53 del confrep debe ser un concepto."
'End If
    
'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
    BancoPago = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    BancoPago = "&nbsp;"
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
   BancoPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & Mid(BancoPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Latin 3
'--------------------------------------------------------------------
Sub generarDatosRecibo57(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 57"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Horvath
'--------------------------------------------------------------------
Sub generarDatosRecibo58(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Convenio
Dim CajaJubilacion
Dim AntigDias As Integer
Dim AntigMeses As Integer
Dim AntigAnios As Integer

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call antigfec(ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)
Call bus_Anti0(Ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del convenio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Convenio = ""

If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del convenio"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la caja de jubilacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

CajaJubilacion = ""

If Not rsConsult.EOF Then
   CajaJubilacion = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la caja de jubilacion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    'FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
     FormaPago = rsConsult!fpagdescabr & "  Nro Cta: " & rsConsult!ctabnro & " - " & rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxdeci1, auxdeci2, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 100) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & CajaJubilacion & "'"
StrSql = StrSql & "," & AntigDias
StrSql = StrSql & "," & AntigMeses
StrSql = StrSql & "," & AntigAnios
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de Praxair
'--------------------------------------------------------------------
Sub generarDatosRecibo59(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTickets As Double
Dim vhora

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMTSS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim GrupoActividad As Double
Dim SubGrupoActividad As Double

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

' _____________________________________________________________________________
' Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS
' _____________________________________________________________________________

Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura BSE (col 113)."
Else
    If rsConsult!conftipo = "TE" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

' _________________________________________________________________________

       


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   ' el sueldo se saca del concepto 01000
   Sueldo = 0
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = " "
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'Se cambio -- Sueldo se busca en la columna 44
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo (en los datos del empleado setee la variable Sueldo=0)

'If Sueldo = 0 Then
'    If esSueldoConc Then
'        StrSql = " SELECT detliq.dlimonto valor "
'        StrSql = StrSql & " FROM detliq "
'        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
'    Else
'        StrSql = " SELECT almonto valor"
'        StrSql = StrSql & " From acu_liq"
'        StrSql = StrSql & " Where acunro = " & acunroSueldo
'        StrSql = StrSql & " AND cliqnro = " & cliqnro
'    End If
    
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!Valor
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo (col 1)."
'       Sueldo = 0
       'GoTo MError
'    End If
'End If



'------------------------------------------------------------------
'Busco el valor del Monto Tickets, definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

If Not rsConsult.EOF Then
    Do Until rsConsult.EOF
    
        'CabliqNumero = rsConsult!cliqnro
        If Not IsNull(rsConsult!Valor) Then
            MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
        End If
    
        rsConsult.MoveNext
    Loop
Else
      Flog.writeline " No se encontraron datos de MONTO TICKETS (col42)."

End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del v.hora/basico, definido en la columna 43 del confrep
' Se cometa porque en BA se uso la columna 44 para vhora
'Se cambio -- se usa col 43 para v. hora.
'------------------------------------------------------------------
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

vhora = 0
If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de V.HORA/BASICO. (col43)"
   vhora = 0
   'GoTo MError
End If


'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

Sueldo = 0
If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
Categoria = " "
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
CentroCosto = " "
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult
FormaPago = " "

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = " "
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, paisdesc  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " left JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " ORDER BY domdefault "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


' -------------------------------------------------------------------------
'Consulta para obtener el MTSS de la empresa
Flog.writeline "Buscando el MTSS tipo de doc " & CodMTSS
StrSql = " SELECT *"
StrSql = StrSql & " From ter_doc"
StrSql = StrSql & " Where ter_doc.ternro = " & rs_estructura!Ternro & " And ter_doc.tidnro = " & CodMTSS
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MTSS"
    EmpMTSS = "  "
Else
    Flog.writeline "MTSS = " & rs_cuit!NroDoc
    EmpMTSS = IIf(EsNulo(rs_cuit!NroDoc), " ", rs_cuit!NroDoc)
End If



' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    'Exit Sub
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    'Exit Sub
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If


' -------------------------------------------------------------------------
'Consulta para obtener el BSE del empleado
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = " SELECT his_estructura.estrnro, estrdabr, estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro= " & CodBSE & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el BSE"
    EmpBSE = " "
Else
    Flog.writeline "BSE = " & rsConsult!Estrnro & " " & rsConsult!estrdabr & "COD Externo " & rsConsult!estrcodext
    EmpBSE = IIf(EsNulo(rsConsult!estrcodext), " ", rsConsult!estrcodext)
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Diego Rosso - 27-04-2007-------------------------------------------------------------------
'------------------------------------------------------------------
'Busco el valor del Grupo de actividad
'------------------------------------------------------------------
Flog.writeline "  Busco el valor del grupo de actividad "

StrSql = "SELECT estr_cod.nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN empresa on empresa.estrnro = estr_cod.estrnro "
StrSql = StrSql & " Where empresa.ternro = " & rs_estructura!Ternro
StrSql = StrSql & " AND tcodnro = 38" 'Fijo se configuro en el cliente
OpenRecordset StrSql, rsConsult
GrupoActividad = 0
If Not rsConsult.EOF Then
    If IsNumeric(rsConsult!nrocod) Then
        GrupoActividad = rsConsult!nrocod
    Else
       Flog.writeline "ERROR el Grupo de actividad debe ser numerico "
    End If
Else
       Flog.writeline "No se encontraron los datos del Grupo de actividad "
'   GoTo MError
End If
'------------------------------------------------------------------
'Busco el valor del Subgrupo de actividad
'------------------------------------------------------------------
Flog.writeline "  Busco el valor del Subgrupo de actividad "

StrSql = "SELECT estr_cod.nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN empresa on empresa.estrnro = estr_cod.estrnro "
StrSql = StrSql & " Where empresa.ternro = " & rs_estructura!Ternro
StrSql = StrSql & " AND tcodnro = 39" 'Fijo se configuro en el cliente
OpenRecordset StrSql, rsConsult
SubGrupoActividad = 0
If Not rsConsult.EOF Then
    If IsNumeric(rsConsult!nrocod) Then
        SubGrupoActividad = rsConsult!nrocod
    Else
       Flog.writeline "ERROR el SubGrupo de actividad debe ser numerico "
    End If
Else
       Flog.writeline "No se encontraron los datos del SubGrupo de actividad "
'   GoTo MError
End If
'-----------------------------------------------------------------------------------------


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
'Flog.Writeline "======================================================================================================================================="
'Flog.Writeline ":::INSERTO EN REP_RECIBO::: "
'Flog.Writeline "Sueldo=" & Sueldo
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden "
StrSql = StrSql & " , auxchar1, auxchar2, auxchar3, auxchar4 "
StrSql = StrSql & " , auxdeci1, auxdeci2, auxdeci3, auxdeci4 "
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & EmpMTSS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & "," & numberForSQL(MontoTickets)
StrSql = StrSql & "," & numberForSQL(vhora)
StrSql = StrSql & "," & numberForSQL(GrupoActividad)
StrSql = StrSql & "," & numberForSQL(SubGrupoActividad)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Gedas
'--------------------------------------------------------------------
Sub generarDatosRecibo60(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'Ult. Mod:  N. Trillo - 29/03/2007
'           Se cambió la fecha hasta para buscar las estructuras
'           Antes a la fecha hasta del periodo
'           Ahora a la fecha de fin del proceso
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial As String
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim pliqdesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CodCAT As Long
Dim CodDPTO As Long

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = IIf(EsNulo(rsConsult!proFecPago), "", rsConsult!proFecPago)
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'Dpto---------------------------------------------------------------------------------
CodCAT = 0
CodDPTO = 0

Flog.writeline "Buscando el valor de campo Dpto recibo en columna 100."
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estrctura DPTO (col 100)."
Else
    If rsConsult!conftipo = "TE" Then
        CodDPTO = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
    Else
        Flog.writeline " El Tipo de Columna 100 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

'CAT---------------------------------------------------------------------------------
Flog.writeline "Buscando el valor de campo CAT recibo en columna 101."
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Estrctura CAT (col 101)."
Else
    If rsConsult!conftipo = "TE" Then
        CodCAT = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
    Else
        Flog.writeline " El Tipo de Columna 101 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = IIf(EsNulo(rsConsult!empfaltagr), "", rsConsult!empfaltagr)
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.profecfin FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   'N. Trillo - 29/03/2007 ---------------------------
   'cambié esto
   'pliqhasta = rsConsult!pliqhasta
   ' por esto
   pliqhasta = rsConsult!profecfin
   'N. Trillo - 29/03/2007 ---------------------------
   pliqdesc = IIf(EsNulo(rsConsult!pliqdesc), "", rsConsult!pliqdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
   Cuil = ""
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la DPTO (confrep 100)
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & CodDPTO & " And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
   Flog.writeline "No se encontro Dpto."
End If


'------------------------------------------------------------------
'Busco el valor del CAT (confrep 101)
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro =  " & CodCAT & "  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
   Flog.writeline "No se encontro CAT."
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro, estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rs_estructura

ObraSocial = ""
Puesto = ""
If Not rs_estructura.EOF Then
    ObraSocial = IIf(EsNulo(rs_estructura!estrdabr), "", rs_estructura!estrdabr)
   
    'Busco el codigo SIJP de la obra social
    StrSql = "SELECT * FROM estr_cod WHERE estrnro =" & rs_estructura!Estrnro
    StrSql = StrSql & " AND tcodnro = 1"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Puesto = IIf(EsNulo(rsConsult!nrocod), "", rsConsult!nrocod)
    Else
        Flog.writeline "No se encontró el codigo SIJP para Obra social"
        Puesto = ""
    End If
   
   
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT banco.bansucdesc, formapago.fpagdescabr, ctabancaria.ctabnro"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
If Not rsConsult.EOF Then
    FormaPago = IIf(EsNulo(rsConsult!bansucdesc), "", rsConsult!bansucdesc)
    FormaPago = FormaPago & " " & IIf(EsNulo(rsConsult!fpagdescabr), "", rsConsult!fpagdescabr)
    FormaPago = FormaPago & " " & IIf(EsNulo(rsConsult!ctabnro), "", rsConsult!ctabnro)
Else
   Flog.writeline "No se encontro los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = IIf(EsNulo(rs_estructura!empnom), "", rs_estructura!empnom)
    EmpEstrnro = rs_estructura!Estrnro
End If


'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " WHERE cabdom.domdefault = -1 "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = ""
    Localidad = ""
Else
    EmpDire = IIf(EsNulo(rs_Domicilio!calle), "", rs_Domicilio!calle)
    Localidad = EmpDire
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " (" & rs_Domicilio!codigopostal & ")"
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = IIf(EsNulo(rs_cuit!NroDoc), "", rs_cuit!NroDoc)
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = IIf(EsNulo(rsConsult!periodoant), "", rsConsult!periodoant)
   pliqfecdep = IIf(EsNulo(rsConsult!Fecha), "", rsConsult!Fecha)
   pliqbco = IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Mid(Apellido, 1, 50) & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & Mid(pliqdepant, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(pliqfecdep, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(pliqbco, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Cuil, 1, 30) & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proFecPago, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(EmpNombre, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpDire, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpCuit, 1, 30) & "'"
StrSql = StrSql & ",'" & Mid(EmpLogo, 1, 100) & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & Mid(EmpFirma, 1, 100) & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 60) & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de AGD
'--------------------------------------------------------------------
Sub generarDatosRecibo61(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Art
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim Cuenta
Dim RegJub

Dim Condicion

Dim empreporta
Dim CalifProfe
Dim Planta
Dim Suc

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim Bandesc
Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf
Dim valorTotNOSujApor
Dim TotRemNOSuj

Dim SueldoConvenio
Dim esSueldoConvenioCon
Dim valorSueldoConvConf

Dim Familiar
Dim valorFamiliarConf
Dim esFamiliarCon

Dim SuelTotEmp
Dim esTotRemSueAporCon
Dim esTotRemNOSueAporCon
Dim esSuelTotEmpCon
Dim valorSuelTotEmp
Dim valorTotSujApor

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empremu, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empreporta = rsConsult!empreporta
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Ultima fase activa
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
    empFecAlta = "&nbsp;"
End If

'------------------------------------------------------------------

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = IIf(EsNulo(rsConsult!Estrnro), "", rsConsult!Estrnro)
        End If
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If


'------------------------------------------------------------------
'Busco el valor Basico de Convenio empresa, definido en la columna 100 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esSueldoConvenioCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorSueldoConvConf = 0
        Else
          valorSueldoConvConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
    Else
        esSueldoConvenioCon = False
        valorSueldoConvConf = rsConsult!confval
    End If
    
    SueldoConvenio = 0

    If esSueldoConvenioCon Then
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorSueldoConvConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SueldoConvenio = rsConsult!Valor
        End If
    Else
        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorSueldoConvConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SueldoConvenio = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto Sueldo Basico de Convenio (col 100)."
End If


'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If

  
'------------------------------------------------------------------
'Busco el valor de Sueldo total empresa, definido en la columna 102 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 102 "

OpenRecordset StrSql, rsConsult

SuelTotEmp = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esSuelTotEmpCon = True
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorSuelTotEmp = 0
        Else
          valorSuelTotEmp = rsConsult2!ConcNro
        End If
        rsConsult2.Close

    Else
        esSuelTotEmpCon = False
        valorSuelTotEmp = rsConsult!confval
    End If
    
 

    If esSuelTotEmpCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorSuelTotEmp
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SuelTotEmp = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorSuelTotEmp
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            SuelTotEmp = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto Sueldo total empresa  (col 102)."

End If


'------------------------------------------------------------------
'Busco el valor Total de Asignaciones Familiares, definido en la columna 103 del confrep
'------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 103 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esFamiliarCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorFamiliarConf = 0
        Else
          valorFamiliarConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
    Else
        esFamiliarCon = False
        valorFamiliarConf = rsConsult!confval
    End If
    
    Familiar = 0

    If esFamiliarCon Then
      
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFamiliarConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Familiar = rsConsult!Valor
        End If
    Else
        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFamiliarConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Familiar = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto de Total de Asignaciones Familiares (col 103)."
End If

'---------------------------------------------------------------------------------------
'Busco el TOTAL de Remuneracion sujeta a aportes, definido en la columna 104 del confrep
'---------------------------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 104 "
OpenRecordset StrSql, rsConsult
  
Sueldo = 0 'Reutilizo el campo

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esTotRemSueAporCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorTotSujApor = 0
        Else
          valorTotSujApor = rsConsult2!ConcNro
        End If
        rsConsult2.Close
    Else
        esTotRemSueAporCon = False
        valorTotSujApor = rsConsult!confval
    End If
    
  
    If esTotRemSueAporCon Then
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorTotSujApor
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Sueldo = rsConsult!Valor
        End If
    Else
        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorTotSujApor
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            Sueldo = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el Total de Remuneracion Sujeta a Aportes (col 104)."
End If


'---------------------------------------------------------------------------------------
'Busco el TOTAL de Remuneracion NO sujeta a aportes, definido en la columna 105 del confrep
'---------------------------------------------------------------------------------------


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 105 "
OpenRecordset StrSql, rsConsult

TotRemNOSuj = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
          
        esTotRemNOSueAporCon = True
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          valorTotNOSujApor = 0
        Else
          valorTotNOSujApor = rsConsult2!ConcNro
        End If
        rsConsult2.Close
    Else
        esTotRemNOSueAporCon = False
        valorTotNOSujApor = rsConsult!confval
    End If
    

    If esTotRemNOSueAporCon Then
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorTotNOSujApor
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            TotRemNOSuj = rsConsult!Valor
        End If
    Else
        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorTotNOSujApor
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            TotRemNOSuj = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el Total de Remuneracion NO Sujeta a Aportes (col 105)."
End If




'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

  '  If Not rsConsult.EOF Then
   '    Sueldo = rsConsult!almonto
   ' Else
   '    Flog.writeline "Error al obtener los datos del sueldo"
   '    Sueldo = 0
       'GoTo MError
   ' End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del la Calif. Profesional.
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

CalifProfe = ""

If Not rsConsult.EOF Then
   CalifProfe = rsConsult!estrdabr
Else
  Flog.writeline "Error al obtener los datos de la calificacion profesional"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Reg Jub
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

RegJub = ""

If Not rsConsult.EOF Then
   RegJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del Reg Jub"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor para campo Condicion
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
StrSql = " SELECT estrdext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 31 And his_estructura.ternro = " & ternro
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Condicion = ""

If Not rsConsult.EOF Then
   Condicion = rsConsult!estrdext
Else
   Flog.writeline "Error al obtener los datos de la estructura Condicion"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Art
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=40 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
Art = ""

If Not rsConsult.EOF Then
   Art = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la ART"
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco el valor de la Planta
'------------------------------------------------------------------

'StrSql = " SELECT estrcodext "
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=35 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
Planta = ""

If Not rsConsult.EOF Then
'   Planta = rsConsult!estrcodext
    Planta = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Planta"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Sucursal (Lugar de pago)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
'StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=1 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
 
Suc = ""

If Not rsConsult.EOF Then
    Suc = Left(rsConsult!estrdabr, 4)
'   Suc = rsConsult!estrcodext
Else
   'Flog.writeline "Error al obtener los datos de la Sucursal"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
''StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc, formapago.fpagnro"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'OpenRecordset StrSql, rsConsult

'StrSql = " SELECT ctabnro,fpagdescabr,fpagbanc, banco.bandesc, formapago.fpagnro"
StrSql = "SELECT ctabnro,fpagdesext,fpagbanc, banco.bandesc, formapago.fpagnro, ctabsuc,ctabsucdesc"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
'Si la forma de pago es 10--> descripcion de la forma de pago
'Si es 12 --> descripcion + nro de cuenta
  If rsConsult!fpagbanc = "-1" Then
     
     If rsConsult!fpagnro = 10 Then
         Bandesc = rsConsult!fpagdesext
         Cuenta = " Nro. " & rsConsult!ctabnro & " - " & rsConsult!Bandesc & " - " & rsConsult!ctabsuc & " - " & rsConsult!ctabsucdesc
         Flog.writeline "forma de pago obtenida. Fpagnro=10 "
     Else
     '   If rsConsult!fpagnro = 12 And rsConsult!ctabnro <> "" Then
     '       Cuenta = rsConsult!ctabnro
     '       Bandesc = rsConsult!fpagdescabr & " Nro:"
     '       Flog.writeline "forma de pago obtenida. Fpagnro=12, numero de cuenta: " & Cuenta
     '   Else
     '       Bandesc = rsConsult!fpagdescabr
     '       Cuenta = ""
      '      Flog.writeline "forma de pago obtenida. Fpagnro=12, numero de cuenta: Vacio "
             Flog.writeline "La forma de pago es: " & rsConsult!fpagnro & " No la muestra "
        'End If
     End If
  Else
      Flog.writeline "La forma de pago no es bancaria"
      Cuenta = ""
      Bandesc = ""
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpNombre = ""
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, provincia.provdesc, codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON provincia.provnro = localidad.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " - " & rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " - " & rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró la Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1,auxdeci2,auxdeci3,auxdeci4,auxdeci5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Art, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & RegJub & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Suc & "'"
StrSql = StrSql & ",'" & Mid(Bandesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Condicion, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Planta, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CalifProfe, 1, 100) & "'"
StrSql = StrSql & "," & SueldoConvenio
StrSql = StrSql & "," & SuelTotEmp
StrSql = StrSql & "," & Familiar
StrSql = StrSql & "," & FuturosAumentos
StrSql = StrSql & "," & TotRemNOSuj
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para A.C.A.R.A.
'--------------------------------------------------------------------
Sub generarDatosRecibo62(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim bancoempl As String
Dim cuentaempl As String

    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CatExt
Dim CCosto
Dim FPago

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
If EsNulo(empFecAlta) Then
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
    Else
        rsConsult.Close
        StrSql = " SELECT altfec "
        StrSql = StrSql & " FROM fases "
        StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            empFecAlta = rsConsult!altfec
        Else
            Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
            empFecAlta = "&nbsp;"
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrcodext,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CatExt = rsConsult!estrcodext
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CatExt = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline "Centro de Costo"

Flog.writeline StrSql

If Not rsConsult.EOF Then
   CCosto = rsConsult!estrcodext

Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   CCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline "Sector"

Flog.writeline StrSql

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encuentran datos del Sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " " & rsConsult!Piso & " piso"
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc
   
    Localidad = Direccion
   
'   Localidad = rsConsult!locdesc
'   Flog.writeline "    los datos de la localidad OK"
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio

If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " " & rs_Domicilio!locdesc
    End If
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " " & rs_Domicilio!codigopostal
    End If

End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
' Estaba comentado para el modelo de A.C.A.R.A. se descomento para usar en Hospital Britanico, porque sino no mostraba el logo
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    Flog.writeline StrSql
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    Flog.writeline StrSql
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc,pago.ctabnro,banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

'StrSql = " SELECT * FROM confrep WHERE repnro = 60 AND confnrocol = 80"
OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'    FPago = IIf(EsNulo(rsConsult!conftipo), "", rsConsult!conftipo)
                
    'ErrorDiasTrabajados = False
    'Busco el valor del concepto o acumulador configurado
'    Select Case UCase(FPago)
'            Case "TE"

'                StrSql = " SELECT estrdabr"
'                StrSql = StrSql & " From estructura"
'                StrSql = StrSql & " Where tenro= " & rsConsult!confval
                
'                OpenRecordset StrSql, rsConsult
                
                'FormaPago = rsConsult!estrdabr
'    End Select
'Else
'    StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc,pago.ctabcbu,banco.bandesc"
'    StrSql = StrSql & " From pago"
'    StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'    StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!ctabnro & " " & rsConsult!Bandesc
    Else
        FormaPago = rsConsult!fpagdescabr
    End If
Else
   Flog.writeline "No se encuentran datos de la forma de pago"
   'GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CatExt, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & CCosto & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & bancoempl & "'"
StrSql = StrSql & ",'" & cuentaempl & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para EKI
'--------------------------------------------------------------------
Sub generarDatosRecibo63(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Long
Dim CtaNro As String
Dim CtaBanco As String
Dim netoPesos
Dim netoBonos

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
'   If IsNull(rsConsult!empremu) Then
'      Sueldo = 0
'   Else
'      Sueldo = rsConsult!empremu
'   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
   tprocdesc = rsConsult!tprocdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado.
'------------------------------------------------------------------
empFecBaja = "&nbsp;"
If Not empest Then
    StrSql = " SELECT bajfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecBaja = rsConsult!bajfec
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Baja del Empleado"
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la Forma de Liquidacion
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!estrcodext = 2 Or rsConsult!estrcodext = 4 Then
        pliqdesc = Mid(tprocdesc, 1, 12) & "    " & FormatNumber(pliqmes, 2) & "-" & FormatNumber(pliqanio, 4)
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Gerencia
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Gerencia."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Tienda
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Tienda (Sucursal)."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Convenio para determinar la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    If rsConsult!estrcodext <> 2 Then
        'Busco la categoria para los dentro de convenio
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
            Puesto = rsConsult!estrdabr
        End If
    Else
        'Busco el puesto para los fuera de convenio
        StrSql = " SELECT estrdabr "
        StrSql = StrSql & " From his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
            Puesto = rsConsult!estrdabr
        End If
    End If
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del convenio para determinar la Categoría."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Pesos
'------------------------------------------------------------------
netoPesos = 0
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Gratificacion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   netoPesos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto en Pesos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Bonos
'------------------------------------------------------------------
netoBonos = 0
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   netoBonos = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto en Bonos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

FormaPago = "&nbsp;"
CtaNro = "&nbsp;"
CtaBanco = "&nbsp;"
If Not rsConsult.EOF Then
    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & Ternro & " AND tidnro = 23"
    OpenRecordset StrSql, rs_cuit
    If Not rs_cuit.EOF Then
        CtaNro = IIf(EsNulo(rs_cuit!NroDoc), "&nbsp;", rs_cuit!NroDoc)
    Else
        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & Ternro & " AND tidnro = 12"
        OpenRecordset StrSql, rs_cuit
        If Not rs_cuit.EOF Then
            CtaNro = IIf(EsNulo(rs_cuit!NroDoc), "&nbsp;", rs_cuit!NroDoc)
        End If
    End If
    
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
    Else
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
    End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1,auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaNro, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaBanco, 1, 100) & "'"
StrSql = StrSql & "," & netoPesos
StrSql = StrSql & "," & netoBonos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para GORINA
'--------------------------------------------------------------------
Sub generarDatosRecibo64(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Afjp As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    If empest = 0 Then
        proDesc = rsConsult!tprocdesc
    End If
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado.
'------------------------------------------------------------------
'empFecBaja = "&nbsp;"
'If Not empest Then
'    StrSql = " SELECT bajfec "
'    StrSql = StrSql & " FROM fases "
'    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
'    OpenRecordset StrSql, rsConsult
    
'    If Not rsConsult.EOF Then
'        empFecBaja = rsConsult!bajfec
'    Else
'        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Baja del Empleado"
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Centro Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de AFJP
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Afjp = "&nbsp;"
If Not rsConsult.EOF Then
    Afjp = rsConsult!estrdabr
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
   Categoria = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Tienda
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & ternro
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   Sector = rsConsult!estrdabr
'Else
'   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Tienda (Sucursal)."
'   Sector = "&nbsp;"
'   GoTo MError
'End If
'rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If

''------------------------------------------------------------------
''Busco los datos de la forma de pago
''------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'FormaPago = "&nbsp;"
'CtaNro = "&nbsp;"
'CtaBanco = "&nbsp;"
'If Not rsConsult.EOF Then
'    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
'    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 23"
'    OpenRecordset StrSql, rs_cuit
'    If Not rs_cuit.EOF Then
'        CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'    Else
'        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 12"
'        OpenRecordset StrSql, rs_cuit
'        If Not rs_cuit.EOF Then
'            CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'        End If
'    End If
'
'    If rsConsult!fpagbanc = "-1" Then
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
'    Else
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'    End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
''   GoTo MError
'End If
'
'rsConsult.Close

''------------------------------------------------------------------
''Busco el valor de la direccion y localidad
''------------------------------------------------------------------
'StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'OpenRecordset StrSql, rsConsult
'Direccion = "&nbsp;"
'Localidad = "&nbsp;"
'If Not rsConsult.EOF Then
'    Direccion = rsConsult!calle & " " & rsConsult!Nro
'    Localidad = Direccion
'Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   'GoTo MError
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpLocalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Afjp, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos
'--------------------------------------------------------------------
Sub generarDatosRecibo65(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String
Dim profecfin As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

'Variables para los acumuladores
Dim ValorAcumSueldoBruto
Dim valorAcumTotalDesc
Dim valorAcumNoRem
Dim valorAcumNeto

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, proceso.profecfin FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   profecfin = rsConsult!profecfin
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de ingreso y egreso - segun la fecha fin del proceso se buscan los ingresos y egresos.
'------------------------------------------------------------------
StrSql = " SELECT altfec, bajfec FROM fases WHERE empleado = " & Ternro & " AND " & _
         " (altfec <= " & ConvFecha(profecfin) & " AND (bajfec >= " & ConvFecha(profecfin) & " or bajfec is null))"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    
Else
    'busco la fase mas cercana a la fecha hasta del proceso
    StrSql = " SELECT altfec, bajfec FROM fases WHERE empleado = " & Ternro & " AND  bajfec <= " & ConvFecha(profecfin) & _
             " ORDER BY bajfec DESC "
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
        
    Else
        empFecAlta = ""
        
    End If
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Sueldo Bruto
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumHaberesConAp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ValorAcumSueldoBruto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto"
   ValorAcumSueldoBruto = 0
   'GoTo MError
End If

'Total de Descuentos
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   valorAcumTotalDesc = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Descuentos "
   valorAcumTotalDesc = 0
   'GoTo MError
End If

'Haberes Sin Retenciones
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci1
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  valorAcumNoRem = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador de No Remunerativos."
   valorAcumNoRem = 0
   'GoTo MError
End If


'Neto a cobrar
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumAuxDeci2
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  valorAcumNeto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Neto."
   valorAcumNeto = 0
   'GoTo MError
End If





'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & ValorAcumSueldoBruto
StrSql = StrSql & "," & valorAcumTotalDesc
StrSql = StrSql & "," & valorAcumNoRem
StrSql = StrSql & "," & valorAcumNeto
StrSql = StrSql & "," & EmpEstrnro
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa TelePerformance Chile
'--------------------------------------------------------------------
Sub generarDatosRecibo66(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecBaja
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim AFP

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim bancoempl As String
Dim cuentaempl As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim DiasTrabajados As Double
Dim ConfDiasTrabajados As String
Dim TipoDiasTrabajados As String
Dim ErrorDiasTrabajados As Boolean

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      rsConsult.Close
      
      'Me fijo si fue dado de baja en la empresa
      StrSql = "SELECT his_estructura.estrnro,his_estructura.htethasta, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
      
      OpenRecordset StrSql, rsConsult
      
      If rsConsult.EOF Then
         empFecBaja = "null"
      Else
         If Not IsNull(rsConsult!htethasta) Then
            empFecBaja = "'" & rsConsult!htethasta & "'"
         Else
            empFecBaja = "null"
         End If
      End If
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
    Cuil = ""
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   'Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del S. Básico"
       Sueldo = 0
    '   GoTo MError
    End If
    
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & ternro
'
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'   Categoria = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
'Else
'    Categoria = ""
''   Flog.writeline "Error al obtener los datos de la categoria"
''   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    Puesto = ""
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor AFP
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   AFP = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
    AFP = ""
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor Jornada
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = IIf(EsNulo(rsConsult!estrcodext), "", rsConsult!estrcodext)
Else
   Categoria = ""
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    CentroCosto = ""
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
    Localidad = ""
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    Localidad = IIf(EsNulo(rs_Domicilio!locdesc), "", rs_Domicilio!locdesc)
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Busco valor confrep de dias trabajados
DiasTrabajados = 0
ConfDiasTrabajados = 0
Flog.writeline "Buscando Dias trabajados en columna 100 de confrep"
StrSql = " SELECT * FROM confrep WHERE repnro = 60 AND confnrocol = 100"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    TipoDiasTrabajados = IIf(EsNulo(rsConsult!conftipo), "", rsConsult!conftipo)
                
    ErrorDiasTrabajados = False
    'Busco el valor del concepto o acumulador configurado
    Select Case UCase(TipoDiasTrabajados)
            Case "CO"
                ConfDiasTrabajados = IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
                ConfDiasTrabajados = IIf(EsNulo(Trim(ConfDiasTrabajados)), "0", ConfDiasTrabajados)
                StrSql = " SELECT detliq.dlimonto valor "
                StrSql = StrSql & " FROM detliq "
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro And concepto.conccod = " & ConfDiasTrabajados
                StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            Case "AC"
                ConfDiasTrabajados = IIf(EsNulo(rsConsult!confval), "", rsConsult!confval)
                StrSql = " SELECT almonto valor"
                StrSql = StrSql & " From acu_liq"
                StrSql = StrSql & " Where acunro = " & ConfDiasTrabajados
                StrSql = StrSql & " AND cliqnro = " & cliqnro
            Case "PCO"
                ConfDiasTrabajados = IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
                ConfDiasTrabajados = IIf(EsNulo(Trim(ConfDiasTrabajados)), "0", ConfDiasTrabajados)
                StrSql = " SELECT detliq.dlicant valor "
                StrSql = StrSql & " FROM detliq "
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro And concepto.conccod = " & ConfDiasTrabajados
                StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            Case Else
                ErrorDiasTrabajados = True
                Flog.writeline "Error. El tipo de la columna 100 debe ser CO, AC o PCO"
    End Select
    
    rsConsult.Close
    
    If Not ErrorDiasTrabajados Then
        OpenRecordset StrSql, rsConsult
    
        If Not rsConsult.EOF Then
            DiasTrabajados = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        End If
        
        rsConsult.Close
    End If

Else
    Flog.writeline "ERROR. No se encontro la columna 100 de confrep, Dias Trabajados."
    rsConsult.Close
End If

   


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & bancoempl & "'"
StrSql = StrSql & ",'" & cuentaempl & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & ",'" & AFP & "'"
StrSql = StrSql & "," & DiasTrabajados
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para PRAXAIR ARG.
'--------------------------------------------------------------------
Sub generarDatosRecibo67(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial As String
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpFirma As String
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim pliqdesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CodCAT As Long
Dim CodDPTO As Long

Dim Modelo As String
Dim LugarPago As String
Dim codPago As Integer

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = IIf(EsNulo(rsConsult!proFecPago), "", rsConsult!proFecPago)
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Modelo = IIf(EsNulo(rsConsult!tprocdesc), "", rsConsult!tprocdesc)
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = IIf(EsNulo(rsConsult!empfaltagr), "", rsConsult!empfaltagr)
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = IIf(EsNulo(rsConsult!pliqdesc), "", rsConsult!pliqdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
   Cuil = ""
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If


'---------------------------------------------------------------------------------------
'Busco la descripcion abreviada de la estructura configurada en el confrep columna 100
'---------------------------------------------------------------------------------------
codPago = "20" 'codigo de estructura de lugar de pago por default
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para la columna 100."
Else
    If rsConsult!conftipo = "TE" Then
          codPago = rsConsult!confval
    Else
          Flog.writeline " El Tipo de Columna 100 del confrep no es: TE. "
    End If
End If



StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & codPago & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""
If Not rsConsult.EOF Then
   LugarPago = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se encontro un valor para la estructura configurada en la columna 100."
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se encontro CAT."
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro, estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rs_estructura

ObraSocial = ""

If Not rs_estructura.EOF Then
    ObraSocial = IIf(EsNulo(rs_estructura!estrdabr), "", rs_estructura!estrdabr)
Else
   Flog.writeline "Error al obtener los datos de la OS"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de ingreso
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases WHERE empleado = " & Ternro & " AND real = -1 AND estado = -1 " & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult
empFecAlta = ""
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la fecha de ingreso. Verificar que tenga una fase marcada como REAL y ACTIVA"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc Banco, ctabancaria.ctabnro Numcuenta"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
If Not rsConsult.EOF Then
    FormaPago = IIf(EsNulo(rsConsult!Numcuenta), "", rsConsult!Numcuenta)
    FormaPago = FormaPago & ", " & IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   Flog.writeline "No se encontro los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = IIf(EsNulo(rs_estructura!empnom), "", rs_estructura!empnom)
    EmpEstrnro = rs_estructura!Estrnro
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = IIf(EsNulo(rsConsult!periodoant), "", rsConsult!periodoant)
   pliqfecdep = IIf(EsNulo(rsConsult!Fecha), "", rsConsult!Fecha)
   pliqbco = IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,"
StrSql = StrSql & " profecpago,empnombre,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, auxchar3, auxchar4, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Mid(Apellido, 1, 50) & "'"
StrSql = StrSql & ",'" & Mid(Nombre, 1, 50) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & Mid(pliqdepant, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(pliqfecdep, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(pliqbco, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Cuil, 1, 30) & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proFecPago, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(EmpNombre, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpFirma, 1, 100) & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 60) & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Modelo, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de PHA
'--------------------------------------------------------------------
Sub generarDatosRecibo68(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para San Martin De tabacal
'--------------------------------------------------------------------
Sub generarDatosRecibo69(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim LTHoras As Double
Dim LTdesc As String
Dim LTimporte As Double
Dim LCdesc As String
Dim LCimporte As Double
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la Forma Liquidacion
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If CInt(rsConsult!Estrnro) = 756 Or CInt(rsConsult!Estrnro) = 758 Then
        pliqdesc = proDesc
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = "&nbsp;"
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Sector."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la ESC./ANTIG.
'------------------------------------------------------------------
LTHoras = CDbl(0)
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LTHoras = CDbl(rsConsult!Valor)
Else
   Flog.writeline "Error al obtener los datos de la ESC./ANTIG."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Pesos
'------------------------------------------------------------------

LTimporte = 0
LTdesc = "    "
If esGratificacionConc Then
    StrSql = " SELECT detliq.dlimonto valor, concepto.concabr descr "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Gratificacion
Else
    StrSql = " SELECT almonto valor, acumulador.acudesabr descr "
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro"
    StrSql = StrSql & " Where acu_liq.acunro = " & Gratificacion
    StrSql = StrSql & " AND acu_liq.cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LTimporte = rsConsult!Valor
   LTdesc = rsConsult!descr
Else
   Flog.writeline "Error al obtener los datos del Neto en Pesos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Neto en Bonos
'------------------------------------------------------------------
LCimporte = 0
LCdesc = "    "
If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor, concepto.concabr descr "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor, acumulador.acudesabr descr "
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro"
    StrSql = StrSql & " Where acu_liq.acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   LCimporte = rsConsult!Valor
   LCdesc = rsConsult!descr
Else
   Flog.writeline "Error al obtener los datos del Neto en Bonos"
'   GoTo MError
End If

''------------------------------------------------------------------
''Busco los datos de la forma de pago
''------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'FormaPago = "&nbsp;"
'CtaNro = "&nbsp;"
'CtaBanco = "&nbsp;"
'If Not rsConsult.EOF Then
'    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
'    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 23"
'    OpenRecordset StrSql, rs_cuit
'    If Not rs_cuit.EOF Then
'        CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'    Else
'        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 12"
'        OpenRecordset StrSql, rs_cuit
'        If Not rs_cuit.EOF Then
'            CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'        End If
'    End If
'
'    If rsConsult!fpagbanc = "-1" Then
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
'    Else
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'    End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
''   GoTo MError
'End If
'
'rsConsult.Close

''------------------------------------------------------------------
''Busco el valor de la direccion y localidad
''------------------------------------------------------------------
'StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'OpenRecordset StrSql, rsConsult
'Direccion = "&nbsp;"
'Localidad = "&nbsp;"
'If Not rsConsult.EOF Then
'    Direccion = rsConsult!calle & " " & rsConsult!Nro
'    Localidad = Direccion
'Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   'GoTo MError
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LTdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LCdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpLocalidad, 1, 100) & "'"
StrSql = StrSql & "," & LTHoras
StrSql = StrSql & "," & LTimporte
StrSql = StrSql & "," & LCimporte
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub generarDatosRecibo70(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de Provincia Seguros
'Fecha Creacion= 30-05-2007
'Autor= Diego Rosso
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Categoria
Dim Sucursal
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpTernro As Integer


Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim Documento

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 70"

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult
empFecAlta = " "
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'Flog.writeline "Busco la fecha de alta activa"

'StrSql = " SELECT * FROM fases WHERE estado =-1 and  empleado = " & ternro
'StrSql = StrSql & " ORDER BY altfec DESC "
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   empFecAlta = rsConsult!altfec
'Else
'    Flog.writeline "No se encontraron fases"
'    empFecAlta = " "
'End If
'rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil del empleado"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Sucursal
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la Sucursal del empleado"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la sucursal del empleado"
   Sucursal = ""
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
    Categoria = ""
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
End If


Flog.writeline "Consulta para obtener la direccion del empleado"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio del empleado"
    'Exit Sub
    Direccion = "   "
Else
    Direccion = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro & " " & rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
    FormaPago = ""
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
EmpTernro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    'Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpTernro = rs_estructura!Ternro
End If


If Not rs_estructura.EOF Then
    Flog.writeline "Consulta para buscar la firma de la empresa"
    'Consulta para buscar la firma de la empresa
    StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
        " From ter_imag " & _
        " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
        " AND ter_imag.ternro =" & EmpTernro
    OpenRecordset StrSql, rs_firma
    If rs_firma.EOF Then
        Flog.writeline "No se encontró el Firma de la Empresa"
        'Exit Sub
        EmpFirma = ""
        EmpFirmaAlto = 0
        EmpFirmaAncho = 0
    Else
        EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
        EmpFirmaAlto = rs_firma!tipimaltodef
        EmpFirmaAncho = rs_firma!tipimanchodef
    End If
End If
'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sucursal, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Documento, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo71(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de Altaplastica
'Fecha Creacion: 17-07-2007
'Autor: Diego Rosso
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim Banco As String



Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 71."

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
   Flog.writeline "Datos Obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del domicilio del empleado
'------------------------------------------------------------------
StrSql = " SELECT * From cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE domdefault =-1 and ternro= " & Ternro

Flog.writeline "Buscando el domicilio del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error el empleado no tiene un docimicilio marcado como principal"
   Direccion = ""
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
    Flog.writeline "Datos obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del centro de costo"
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
    Flog.writeline "Datos del centro de costo obtenido"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro de Costo."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la categoria"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "Datos de la Categoria Obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Puesto"
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
    Flog.writeline "Datos del Puesto obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = "&nbsp;"
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Basico"
   Sueldo = 0
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.

StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
    empFecAltaRec = ""
    'GoTo MError
End If
If empFecAltaRec = "" Then
    'El empleado no tiene fecha de alta reconocida, por lo que busco la fecha desde
    'de la primera de sus fases
    rsConsult.Close
    StrSql = " SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "Error al obtener la Fecha de Alta de la primer fase del Empleado"
        empFecAltaRec = ""
        'GoTo MError
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la descripción del proceso de liquidación
'------------------------------------------------------------------
StrSql = " SELECT prodesc "
StrSql = StrSql & " FROM proceso "
StrSql = StrSql & " WHERE pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   DescProceso = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener la Descripción del Proceso"
   DescProceso = ""
   'GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
'StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(DescProceso, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Recibo de sueldos ZARCAM
' Autor: Diego Rosso
' Fecha: 24-07-2007
 'Modificacion:
'--------------------------------------------------------------------
Sub generarDatosRecibo72(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
Flog.writeline "Buscando los datos del empleado"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr                        15-01-14 Rafa - CAS 23113 - Se cambio por la Fecha de la Fase Activa
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   Flog.writeline "Datos obtenidos."
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la ultima Fecha de Alta del empleado de la fase
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Flog.writeline "Datos Obtenidos."
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
     
Flog.writeline "Buscando el CUIL del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "Dato obtenido"
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

Flog.writeline "Buscando la direccion del empleado"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    

    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
    Localidad = Direccion
    Flog.writeline "Datos Obtenidos."
Else
   Flog.writeline "Error al obtener los datos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro

Flog.writeline "Buscando datos de la categoria"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la obra Social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro

Flog.writeline "Buscando los datos de la obra social"
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
   Flog.writeline "Datos obtenidos"
Else
   Flog.writeline "Error al obtener los datos de la Obra Social "
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
Flog.writeline "Buscando datos de la empresa"

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    Flog.writeline "Empresa Obtenida"
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Recibo de sueldos Papelbril
' Autor: Diego Rosso
' Fecha: 4-09-2007
' Modificacion:
'              27-09-2007 - Diego Rosso - Categoria tomar del tipo de estructura 3.
'--------------------------------------------------------------------
Sub generarDatosRecibo73(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Ocupacion
Dim Liquidacion

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
Flog.writeline "Buscando los datos del empleado"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   Flog.writeline "Datos obtenidos."
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Flog.writeline "Datos Obtenidos."
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
     
Flog.writeline "Buscando el CUIL del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "Dato obtenido"
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

Flog.writeline "Buscando la direccion del empleado"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    

    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
    Localidad = Direccion
    Flog.writeline "Datos Obtenidos."
Else
   Flog.writeline "Error al obtener los datos"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acunroSueldo
StrSql = StrSql & " AND cliqnro = " & cliqnro
    
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del sueldo"
   Sueldo = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria de empresa
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 45 And his_estructura.ternro = " & ternro
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro

Flog.writeline "Buscando datos de la categoria"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Ocupacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 44 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Ocupacion = ""

If Not rsConsult.EOF Then
   Ocupacion = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Ocupacion"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de forma de liquidacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro

Flog.writeline "Buscando los datos de la obra social"
OpenRecordset StrSql, rsConsult

Liquidacion = ""

If Not rsConsult.EOF Then
   Liquidacion = rsConsult!estrdabr
   Flog.writeline "Datos obtenidos"
Else
   Flog.writeline "Error al obtener los datos del tipo de liquidacion "
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0
Flog.writeline "Buscando datos de la empresa"

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    Flog.writeline "Empresa Obtenida"
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro

    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Liquidacion, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Ocupacion & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Praxair Chile
'--------------------------------------------------------------------
Sub generarDatosRecibo74(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim cargo As String
Dim Ubicacion As String
Dim DiasTr As Double

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del rut
'------------------------------------------------------------------
StrSql = " SELECT rut.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc rut ON (tercero.ternro=rut.ternro and rut.tidnro=1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del RUT."
   NroDoc = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Cargo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

cargo = "&nbsp;"
If Not rsConsult.EOF Then
    cargo = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Cargo."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Ubicacion
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Ubicacion = "&nbsp;"
If Not rsConsult.EOF Then
   Ubicacion = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Ubicación."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Alcance Liquido"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de las Dias tr.
'------------------------------------------------------------------
DiasTr = CDbl(0)
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   DiasTr = CDbl(rsConsult!Valor)
Else
   Flog.writeline "Error al obtener los datos de los Dias tr. Se debe configurar el concepto u acumulador en la columna 42 del confrep."
'   GoTo MError
End If

''------------------------------------------------------------------
''Busco los datos de la forma de pago
''------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'FormaPago = "&nbsp;"
'CtaNro = "&nbsp;"
'CtaBanco = "&nbsp;"
'If Not rsConsult.EOF Then
'    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
'    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 23"
'    OpenRecordset StrSql, rs_cuit
'    If Not rs_cuit.EOF Then
'        CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'    Else
'        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & ternro & " AND tidnro = 12"
'        OpenRecordset StrSql, rs_cuit
'        If Not rs_cuit.EOF Then
'            CtaNro = IIf(EsNulo(rs_cuit!nrodoc), "&nbsp;", rs_cuit!nrodoc)
'        End If
'    End If
'
'    If rsConsult!fpagbanc = "-1" Then
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
'    Else
'        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
'    End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
''   GoTo MError
'End If
'
'rsConsult.Close

''------------------------------------------------------------------
''Busco el valor de la direccion y localidad
''------------------------------------------------------------------
'StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'OpenRecordset StrSql, rsConsult
'Direccion = "&nbsp;"
'Localidad = "&nbsp;"
'If Not rsConsult.EOF Then
'    Direccion = rsConsult!calle & " " & rsConsult!Nro
'    Localidad = Direccion
'Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   'GoTo MError
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
'StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
'    " localidad.locdesc, provincia.provdesc From cabdom " & _
'    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!ternro & _
'    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
'    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
'OpenRecordset StrSql, rs_Domicilio
'If rs_Domicilio.EOF Then
'    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
'    EmpDire = "&nbsp;"
'    EmpLocalidad = "&nbsp;"
'Else
'    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
'    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
'    If Not EsNulo(rs_Domicilio!piso) Then
'        EmpDire = EmpDire & " " & rs_Domicilio!piso
'    End If
'    If Not EsNulo(rs_Domicilio!oficdepto) Then
'        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
'    End If
'End If

'Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
'         " Where tercero.ternro =" & rs_estructura!ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
'    EmpCuit = "&nbsp;"
'Else
'    EmpCuit = rs_cuit!nrodoc
'End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
'StrSql = " SELECT * FROM peri_ccss "
'StrSql = StrSql & " WHERE "
'StrSql = StrSql & " pliqnro = " & pliqnro
'StrSql = StrSql & " AND estrnro = " & EmpEstrnro

'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   pliqdepant = rsConsult!periodoant
'   pliqfecdep = rsConsult!Fecha
'   pliqbco = rsConsult!Banco
'Else
'   pliqdepant = "&nbsp;"
'   pliqfecdep = "&nbsp;"
'   pliqbco = "&nbsp;"
'   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
'End If

'rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(NroDoc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(cargo, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Ubicacion, 1, 100) & "'"
StrSql = StrSql & "," & DiasTr
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
'Descripcion: Se encarga de generar los datos para el recibo de ARLEI
'Autor: Diego Rosso
'Fecha: 14/01/2008
'Modificado:
'--------------------------------------------------------------------
Sub generarDatosRecibo75(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Empieza a procesar al empleado"
Flog.writeline "*******************************"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   Flog.writeline "   Se obtuvieron los datos del empleado"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Flog.writeline "   Se obtuvieron los datos del periodo actual"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "   Se obtuvieron los datos del cuil"
Else
   Flog.writeline "No se encontro los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
   Flog.writeline "   Se obtuvieron los datos de la direccion de la sucursal del empleado"
Else
   Flog.writeline "Error al obtener los datos de la Direccion  de la sucursal del empleado"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el sector del empleado"
Else
   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el puesto del empleado"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el centro de costo del empleado"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa. No se generara el Recibo."
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If



'Consulta para obtener la direccion de la sucursal Comercial del empleado
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro and cabdom.tidonro=1" 'Comercial
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio

If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio comercial de la sucursal"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
   
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If


'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Guardando los datos del empleado en base........."
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Sector, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop
Flog.writeline "   Se Grabo el empleado"
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa Santana
' Autor: Diego Rosso.
' Fecha: 18/01/2008
'--------------------------------------------------------------------
Sub generarDatosRecibo76(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim empFecBaja
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim empFecAltaRec
Dim Convenio

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim bancoempl As String
Dim cuentaempl As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Sebastian Stremel 17/08/2011
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If
        

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

rsConsult.Close

'----------------------------------------------------------------
' Busco el convenio - sebastian stremel
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
If pliqhasta <> "" Then
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
End If
StrSql = StrSql & " AND his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Convenio = rsConsult!estrdabr
Else
    Convenio = " "
End If

rsConsult.Close
'------------------------------------------------------------------

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      rsConsult.Close
      
      'Me fijo si fue dado de baja en la empresa
      StrSql = "SELECT his_estructura.estrnro,his_estructura.htethasta, empresa.ternro, empresa.empnom " & _
            " From his_estructura" & _
            " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
            " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
            " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
            " AND his_estructura.ternro = " & Ternro & _
            " AND his_estructura.tenro  = 10"
      
      OpenRecordset StrSql, rsConsult
      
      If rsConsult.EOF Then
         empFecBaja = "null"
      Else
         If Not IsNull(rsConsult!htethasta) Then
            empFecBaja = "'" & rsConsult!htethasta & "'"
         Else
            empFecBaja = "null"
         End If
      End If
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Localidad = ""

If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If




'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar5,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para la empresa Repsa
' Autor: Fernando Favre.
' Fecha: 24/01/2008
'--------------------------------------------------------------------
Sub generarDatosRecibo77(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Sector
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se configura en el concepto (tipo = CO) o acumulador (tipo = AC) de la columna 1 de la configuración del reporte."
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Sector = "   "
'   Flog.writeline "Error al obtener los datos del Sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
    Categoria = "   "
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = "   "

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    CentroCosto = "   "
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. Debe estar generado el pedido de pago."
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Las AMIA
'--------------------------------------------------------------------
Sub generarDatosRecibo78(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin
Dim empFecBaja
Dim os_eleg
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim Departamento As String
Dim Contrato As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Departamento = ""

If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close





' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar3,auxchar2,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Vittal
'--------------------------------------------------------------------
Sub generarDatosRecibo79(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Lugar_Pago
Dim Modelo
Dim Puesto
Dim profecfin
Dim empFecBaja
Dim os_eleg
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim Departamento As String
Dim Contrato As String
'Dim Categoria

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecBaja = rsConsult!empFecBaja
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Modelo = Trim(rsConsult!tprocdesc)
   Modelo = Left(Modelo, 1)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
StrSql = " SELECT calle,nro,piso,oficdepto FROM detdom "
StrSql = StrSql & " INNER JOIN cabdom ON detdom.domnro=cabdom.domnro"
StrSql = StrSql & " WHERE cabdom.ternro = " & Ternro
StrSql = StrSql & " AND cabdom.domdefault = -1"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
   If Not IsNull(rsConsult!Piso) Then
       Direccion = Direccion & " - Piso " & rsConsult!Piso
   End If
   If Not IsNull(rsConsult!oficdepto) Then
       Direccion = Direccion & " - " & rsConsult!oficdepto
   End If
Else
   Flog.writeline "Error al obtener la dirección del empleado"
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   Categoria = rsConsult!estrdabr
'Else
'   Categoria = ""
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 6 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Departamento = ""
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Contrato = ""
If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
os_eleg = ""
If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, estructura.estrdabr " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro " & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!estrdabr
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
    Localidad = " "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    Localidad = rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = " SELECT cuit.nrodoc FROM tercero"
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = 6)"
StrSql = StrSql & " WHERE tercero.ternro = " & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Lugar_Pago = ""
If Not rsConsult.EOF Then
   Lugar_Pago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener el lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,"
'StrSql = StrSql & " Categoria,"
StrSql = StrSql & " Localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Lugar_Pago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de RIM
'--------------------------------------------------------------------
Sub generarDatosRecibo80(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim ObraSocial
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   'Localidad = Direccion
   Localidad = rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
'  Se encarga de generar los datos para el recibo de SANTILLANA
'--------------------------------------------------------------------
Sub generarDatosRecibo82(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim Periodo_Abonado
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Periodo_Abonado = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Periodo_Abonado & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo81(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial
Dim vhora

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del "Sueldo Base/V.Hora", definido en la columna 42 del confrep
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   vhora = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Sueldo Base/V.Hora."
   vhora = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & "," & vhora
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
'  Se encarga de generar los datos para el recibo de Administradora Sanatorial
'--------------------------------------------------------------------
Sub generarDatosRecibo83(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim Periodo_Abonado
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial
Dim LugarPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antigüedad reconocida del empleado
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases"
StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro = empant.empantnro"
StrSql = StrSql & " LEFT JOIN causa ON fases.caunro = causa.caunro"
StrSql = StrSql & " Where fases.empleado = " & Ternro
StrSql = StrSql & " AND fasrecofec = -1"
StrSql = StrSql & " ORDER BY altfec ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la antigüedad reconocida del empleado"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Periodo_Abonado = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If
'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   LugarPago = RTrim(LTrim(rsConsult!estrdabr))
Else
   LugarPago = ""
End If
If LugarPago = "" Then
      LugarPago = "BUENOS AIRES"
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
'  Se encarga de generar los datos para el recibo de Actionline
'--------------------------------------------------------------------
Sub generarDatosRecibo84(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim Periodo_Abonado
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Periodo_Abonado = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Periodo_Abonado & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de TPS
'--------------------------------------------------------------------
Sub generarDatosRecibo85(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsultConfrep As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim MemoConfrep1() As String
Dim MemoConfrep2() As String
Dim MemoConfrep3() As String
On Error GoTo MError
Dim I, j As Integer
Dim Convenio(1 To 3) As Integer
Dim leyenda(1 To 3) As Boolean
Dim encontre As Boolean
ReDim Preserve MemoConfrep1(1)
ReDim Preserve MemoConfrep2(1)
ReDim Preserve MemoConfrep3(1)
Dim Memoconfrep As String
Dim ConvenioNro As Long
Dim Suma1, Suma2, Suma3, MostrarPie As Boolean
Suma1 = False
Suma2 = False
Suma3 = False
MostrarPie = False
MemoConfrep1(1) = "A"
MemoConfrep2(1) = "A"
MemoConfrep3(1) = "A"
EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0
leyenda(1) = False
leyenda(2) = False
leyenda(3) = False


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empfaltagr,empfbajaprev,empleg,terape,terape2,ternom,ternom2,empremu,empreporta"
StrSql = StrSql & " FROM empleado"
StrSql = StrSql & " WHERE ternro= " & Ternro
' Stankunas Cesar - 21/05/2009 - Se modificó la consulta que traía "empfecbaja" por "empfbajaprev"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empfbajaprev
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,piso"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult



If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria "
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = ctabancaria.banco"
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
StrSql = StrSql & " AND ctabestado = -1"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

    If CBool(rsConsult!fpagbanc) Then
       FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
    Else
       FormaPago = rsConsult!fpagdescabr
    End If
  
Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " Piso " & rs_Domicilio!Piso & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro & _
    " AND terimvalid =-1" & _
    " ORDER BY terimfecha desc "
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'-------------------------------------------------------------------------------------------------------------
'BUSCO LOS DATOS DE LOS CONCEPTOS CONFIGURADOS POR CONFREP PARA SER SUMADOS SEGUN SEA EL CONVENIO DEL EMPLEADO
'-------------------------------------------------------------------------------------------------------------
'Agregado por DNN el 28/04/2009

'Primero busco en el confrep los convenios y acumuladores/conceptos asociados
'Hasta el momento será posible configurar tres tipos distintos de convenios (registros de mi memoria interna)

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'CCO' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                encontre = True
                Exit For
            End If
        Next
        If Not encontre Then
            j = j + 1
            Convenio(j) = rsConsultConfrep!confval
        End If
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF Or j = 3
Else
   Flog.writeline "No esta configurado el ConfRep para recibos por convenios"
   GoTo NoCambiar 'No se configuró el confrep, por lo cual el proceso debe funcionar como antes (Deloite)
   'Exit Sub
End If
'En la memoria convenio tengo los tres posibles convenios configurados
'Cada uno de estos convenios será una fila de mi memoria MemoConfrepX
rsConsultConfrep.MoveFirst
Do
    For I = 1 To 3
        If rsConsultConfrep!confval = Convenio(I) Then
            Select Case I
                Case 1
                    If MemoConfrep1(1) <> "A" Then
                        j = UBound(MemoConfrep1) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep1(j)
                    MemoConfrep1(j) = rsConsultConfrep!confval2
                Case 2
                    If MemoConfrep2(1) <> "A" Then
                        j = UBound(MemoConfrep2) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep2(j)
                    MemoConfrep2(j) = rsConsultConfrep!confval2
                Case 3
                    If MemoConfrep3(1) <> "A" Then
                        j = UBound(MemoConfrep3) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep3(j)
                    MemoConfrep3(j) = rsConsultConfrep!confval2
            End Select
        End If
    Next
    rsConsultConfrep.MoveNext
Loop Until rsConsultConfrep.EOF

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ConvenioNro = rsConsult!Estrnro
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'Ahora me fijo en el arreglo de convenios si tengo al convenio del empleado
For I = 1 To 3
    Select Case I
        Case 1
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep1)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep1(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep1(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep1)
                ReDim Preserve MemoConfrep1(j + 1)
                Suma1 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep1(j + 1) = 0
                Else
                    MemoConfrep1(j + 1) = rsConsult(0)
                End If
            End If
        Case 2
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep2)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep2(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep2(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep2)
                ReDim Preserve MemoConfrep2(j + 1)
                Suma2 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep2(j + 1) = 0
                Else
                    MemoConfrep2(j + 1) = rsConsult(0)
                End If
            End If
        
        Case 3
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep3)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep3(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep3(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep3)
                ReDim Preserve MemoConfrep3(j + 1)
                Suma3 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep3(j + 1) = 0
                Else
                    MemoConfrep3(j + 1) = rsConsult(0)
                End If
            End If
    End Select
Next

'En Caso que el empleado pertenezca al primer convenio configurado poner el segundo campo auxiliar de decimales en 1
'El primer convenio configurado debe ser siempre el convenio para el cual se configura un pie de recibo
'If convenio(1) = ConvenioNro Then
'    MostrarPie = True
'End If


'Busco los convenios para los cuales se necesita que aparezca una leyenda al pie del recibo

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'LEY' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                If UCase(rsConsultConfrep!confval2) = "SI" Then
                    leyenda(I) = True
                End If
                Exit For
            End If
        Next
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF
End If
For I = 1 To 3
    If ConvenioNro = Convenio(I) Then
        If leyenda(I) Then MostrarPie = True
    End If
Next
'-------------------------------------------------------------------------------------------------------------
NoCambiar:


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & ",auxdeci1"
End If
If MostrarPie Then
    StrSql = StrSql & ",auxdeci2"
End If
StrSql = StrSql & ") VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & "," & MemoConfrep1(j)
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & "," & MemoConfrep2(j)
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & "," & MemoConfrep3(j)
End If
If MostrarPie Then
    StrSql = StrSql & "," & 1
End If
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


' Recibo de Sueldo para Dabra. En vez de mostrar el puesto, se muestra la sucursal.

Sub generarDatosRecibo86(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim oSocial
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Antiguedad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=4 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "Importe Depositado en cuenta: " & rsConsult!ctabnro & " Banco: " & rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la fecha de alta de la fase mas antigua del empleado para determinar la Antiguedad Reconocida
'------------------------------------------------------------------

StrSql = " SELECT altfec FROM fases"
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec ASC"
       
OpenRecordset StrSql, rsConsult
Antiguedad = ""
If Not rsConsult.EOF Then
   Antiguedad = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la fecha de alta de la fase mas antigua del empleado"
'   GoTo MError
 
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Gestion Compartida
'--------------------------------------------------------------------
Sub generarDatosRecibo12(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Medicus
'--------------------------------------------------------------------
Sub generarDatosRecibo88(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad
Dim Sector
Dim TipoDocu
Dim NroDocu

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
'   GoTo MError
End If


'------------------------------------------------------------------
'     En "Localidad" se va a grabar el valor de la descripcion
'          estructura del tipo de estructura "Banco" (41)
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr FROM estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " WHERE estructura.tenro = 41"
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
    Localidad = rsConsult!estrdabr
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
    
    'If rsConsult!estrnro = 154 Then
        'Contrato = rsConsult!estrdabr
        '
        'StrSql = " SELECT altfec, bajfec FROM fases"
        'StrSql = StrSql & " Where Empleado = " & ternro
        'StrSql = StrSql & " ORDER BY altfec DESC"
        'OpenRecordset StrSql, rsConsult2
        'If Not rsConsult2.EOF Then
            'Contrato = Contrato & "  " & rsConsult2!altfec & " - " & rsConsult2!bajfec
        'End If
    'Else
        'Contrato = rsConsult!estrdabr
    'End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
    'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Sector = ""
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
    Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & TipoDocu & "'"
StrSql = StrSql & ",'" & NroDocu & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Price
'--------------------------------------------------------------------
Sub generarDatosRecibo89(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol = 44"
StrSql = StrSql & " AND conftipo = 'COP'"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Titulo = objRs2!confetiq
    
    If objRs2!confval = 1 Then
        StrSql = " SELECT estrdabr FROM his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
        StrSql = StrSql & " AND his_estructura.tenro = " & objRs2!confval2
        StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Datos = rsConsult2!estrdabr
        End If
    Else
        If objRs2!confval = 2 Then
            If CDate(Day(Date) & "/" & Month(Date) & "/" & Year(Date)) > CDate(Day(empFecAlta) & "/" & Month(empFecAlta) & "/" & Year(empFecAlta)) Then
                DiasAcum = 0
                Dias = 0
                YaEntro = False
                
                StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro
                StrSql = StrSql & " AND real = -1"
                StrSql = StrSql & " AND NOT altfec is NULL"
                StrSql = StrSql & " AND NOT (bajfec is NULL AND estado = 0)"
                StrSql = StrSql & " AND altfec <= " & ConvFecha(Date)
                StrSql = StrSql & " ORDER BY altfec ASC"
                OpenRecordset StrSql, rs_Fases
                Do While Not rs_Fases.EOF
                    fecalta = rs_Fases!altfec
                    
                    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
                    If rs_Fases!estado Then
                        fecbaja = Date
                    ElseIf rs_Fases!bajfec <= Date Then
                        fecbaja = rs_Fases!bajfec
                    Else
                        fecbaja = Date
                    End If
                    
                    '12/11/2010 - Stankunas Cesar - Se cambió la lógica
                    Dias = DateDiff("d", fecalta, fecbaja)
                    If YaEntro Then
                        FechaAux = DateAdd("d", -(DiasAcum), fecalta)
                        DiasAcum = DiasAcum + Dias + 1
                    Else
                        DiasAcum = Dias + 1
                        FechaAux = fecalta
                    End If
                    YaEntro = True
                    
                    rs_Fases.MoveNext
                Loop
                rs_Fases.Close
                
                Datos = FechaAux
            End If
        End If
    End If
Else
    Flog.writeline "No esta configurado el campo variable en el ConfRep (Columna 44)"
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Sueldo = rsConsult!almonto
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Titulo & "'"
StrSql = StrSql & " ,'" & Datos & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Radio Continental
'--------------------------------------------------------------------
Sub generarDatosRecibo90(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsultConfrep As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Auxchar1

Dim empFecBaja
Dim regimenHor
Dim Sector
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim MemoConfrep1() As String
Dim MemoConfrep2() As String
Dim MemoConfrep3() As String
On Error GoTo MError
Dim I, j As Integer
Dim Convenio(1 To 3) As Integer
Dim leyenda(1 To 3) As Boolean
Dim encontre As Boolean
ReDim Preserve MemoConfrep1(1)
ReDim Preserve MemoConfrep2(1)
ReDim Preserve MemoConfrep3(1)
Dim Memoconfrep As String
Dim ConvenioNro As Long
Dim Suma1, Suma2, Suma3, MostrarPie As Boolean
Suma1 = False
Suma2 = False
Suma3 = False
MostrarPie = False
MemoConfrep1(1) = "A"
MemoConfrep2(1) = "A"
MemoConfrep3(1) = "A"
EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0
leyenda(1) = False
leyenda(2) = False
leyenda(3) = False


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empfaltagr,empfbajaprev,empleg,terape,terape2,ternom,ternom2,empremu,empreporta"
StrSql = StrSql & " FROM empleado"
StrSql = StrSql & " WHERE ternro= " & Ternro
' Stankunas Cesar - 21/05/2009 - Se modificó la consulta que traía "empfecbaja" por "empfbajaprev"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empfbajaprev
   empreporta = rsConsult!empreporta
   
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la direccion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 35 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Auxchar1 = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria "
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = ctabancaria.banco"
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
StrSql = StrSql & " AND ctabestado = -1"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

    If CBool(rsConsult!fpagbanc) Then
       FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
    Else
       FormaPago = rsConsult!fpagdescabr
    End If
  
Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'-------------------------------------------------------------------------------------------------------------
'BUSCO LOS DATOS DE LOS CONCEPTOS CONFIGURADOS POR CONFREP PARA SER SUMADOS SEGUN SEA EL CONVENIO DEL EMPLEADO
'-------------------------------------------------------------------------------------------------------------
'Agregado por DNN el 28/04/2009

'Primero busco en el confrep los convenios y acumuladores/conceptos asociados
'Hasta el momento será posible configurar tres tipos distintos de convenios (registros de mi memoria interna)

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'CCO' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                encontre = True
                Exit For
            End If
        Next
        If Not encontre Then
            j = j + 1
            Convenio(j) = rsConsultConfrep!confval
        End If
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF Or j = 3
Else
   Flog.writeline "No esta configurado el ConfRep para recibos por convenios"
   GoTo NoCambiar 'No se configuró el confrep, por lo cual el proceso debe funcionar como antes (Deloite)
   'Exit Sub
End If
'En la memoria convenio tengo los tres posibles convenios configurados
'Cada uno de estos convenios será una fila de mi memoria MemoConfrepX
rsConsultConfrep.MoveFirst
Do
    For I = 1 To 3
        If rsConsultConfrep!confval = Convenio(I) Then
            Select Case I
                Case 1
                    If MemoConfrep1(1) <> "A" Then
                        j = UBound(MemoConfrep1) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep1(j)
                    MemoConfrep1(j) = rsConsultConfrep!confval2
                Case 2
                    If MemoConfrep2(1) <> "A" Then
                        j = UBound(MemoConfrep2) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep2(j)
                    MemoConfrep2(j) = rsConsultConfrep!confval2
                Case 3
                    If MemoConfrep3(1) <> "A" Then
                        j = UBound(MemoConfrep3) + 1
                    Else
                        j = 1
                    End If
                    ReDim Preserve MemoConfrep3(j)
                    MemoConfrep3(j) = rsConsultConfrep!confval2
            End Select
        End If
    Next
    rsConsultConfrep.MoveNext
Loop Until rsConsultConfrep.EOF

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ConvenioNro = rsConsult!Estrnro
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'Ahora me fijo en el arreglo de convenios si tengo al convenio del empleado
For I = 1 To 3
    Select Case I
        Case 1
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep1)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep1(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep1(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep1)
                ReDim Preserve MemoConfrep1(j + 1)
                Suma1 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep1(j + 1) = 0
                Else
                    MemoConfrep1(j + 1) = rsConsult(0)
                End If
            End If
        Case 2
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep2)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep2(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep2(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep2)
                ReDim Preserve MemoConfrep2(j + 1)
                Suma2 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep2(j + 1) = 0
                Else
                    MemoConfrep2(j + 1) = rsConsult(0)
                End If
            End If
        
        Case 3
            If Convenio(I) = ConvenioNro Then
                
                'Para todos los conceptos de este empleado (memoconfrep) calculo la sumatoria de este convenio
                Memoconfrep = ""
                For j = 1 To UBound(MemoConfrep3)
                    If j <> 1 Then
                        Memoconfrep = Memoconfrep & "," & MemoConfrep3(j)
                    Else
                        Memoconfrep = Memoconfrep & MemoConfrep3(j)
                    End If
                Next
                'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
                StrSql = " SELECT SUM(detliq.dlimonto) "
                'StrSql = " SELECT concepto.conccod "
                StrSql = StrSql & " FROM cabliq "
                StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
                StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
                StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
                StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod IN (" & Memoconfrep & ") "
                OpenRecordset StrSql, rsConsult
                j = UBound(MemoConfrep3)
                ReDim Preserve MemoConfrep3(j + 1)
                Suma3 = True
                If IsNull(rsConsult(0)) Then
                    MemoConfrep3(j + 1) = 0
                Else
                    MemoConfrep3(j + 1) = rsConsult(0)
                End If
            End If
    End Select
Next

'En Caso que el empleado pertenezca al primer convenio configurado poner el segundo campo auxiliar de decimales en 1
'El primer convenio configurado debe ser siempre el convenio para el cual se configura un pie de recibo
'If convenio(1) = ConvenioNro Then
'    MostrarPie = True
'End If


'Busco los convenios para los cuales se necesita que aparezca una leyenda al pie del recibo

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and upper(conftipo) = 'LEY' order by confnrocol"
OpenRecordset StrSql, rsConsultConfrep
If Not rsConsultConfrep.EOF Then
    j = 0
    Do
        encontre = False
        For I = 1 To 3
            If rsConsultConfrep!confval = Convenio(I) Then
                If UCase(rsConsultConfrep!confval2) = "SI" Then
                    leyenda(I) = True
                End If
                Exit For
            End If
        Next
        rsConsultConfrep.MoveNext
    Loop Until rsConsultConfrep.EOF
End If
For I = 1 To 3
    If ConvenioNro = Convenio(I) Then
        If leyenda(I) Then MostrarPie = True
    End If
Next
'-------------------------------------------------------------------------------------------------------------
NoCambiar:


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & ",auxdeci1"
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & ",auxdeci1"
End If
If MostrarPie Then
    StrSql = StrSql & ",auxdeci2"
End If
StrSql = StrSql & ") VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Auxchar1, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
j = UBound(MemoConfrep1)
If Suma1 Then
    StrSql = StrSql & "," & MemoConfrep1(j)
End If
j = UBound(MemoConfrep2)
If Suma2 Then
    StrSql = StrSql & "," & MemoConfrep2(j)
End If
j = UBound(MemoConfrep3)
If Suma3 Then
    StrSql = StrSql & "," & MemoConfrep3(j)
End If
If MostrarPie Then
    StrSql = StrSql & "," & 1
End If
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Grupo Cargo
'--------------------------------------------------------------------
'05/06/2013 - Ana Annese - cambio del numero de columna confrep

Sub generarDatosRecibo91(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja
Dim ConfRepAcuNro
Dim MejorRem

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

SueldoRemu = 0
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
   Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la ultima Fecha de Alta del empleado de la fase
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If


'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "SUELDO", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

'StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
'   Localidad = Direccion
'   Flog.writeline "    los datos de la localidad OK"
'Else
'   Direccion = ""
'   Localidad = ""
'   Flog.writeline "Error al obtener los datos de la localidad"
'   'GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del tipo
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 57 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!estrcodext
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    
    Sueldo = 0
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'Si no encuentra el sueldo asigno el del tablero del empleado
If Sueldo = 0 Then Sueldo = SueldoRemu
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del campo variable (Mejor Remun. Semestre)
'------------------------------------------------------------------
ConfRepAcuNro = 0
MejorRem = 0

StrSql = " SELECT confval FROM confrep"
StrSql = StrSql & " Where repnro = 60"
'StrSql = StrSql & " AND confnrocol = "44" - AA 05/06/2013
StrSql = StrSql & " AND confnrocol = 208"
StrSql = StrSql & " AND conftipo = 'COP'"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ConfRepAcuNro = rsConsult!confval
End If

If ConfRepAcuNro <> 0 And Not IsNull(ConfRepAcuNro) Then
    StrSql = " SELECT almonto From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConfRepAcuNro
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MejorRem = rsConsult!almonto
        Flog.writeline "    Datos del campo variable (Mejor Remun. Semestre) OK"
    Else
        Flog.writeline "No se encontró el monto para el campo variable (Mejor Remun. Semestre)"
        MejorRem = 0
        'GoTo MError
    End If
Else
    Flog.writeline "El campo variable (Mejor Remun. Semestre) está mal configurado en el Configurador de Reportes"
End If


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "    los datos del sector OK"
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   Banco = rsConsult!Bandesc
'   Cuenta = rsConsult!ctabnro
'Flog.writeline "    los datos de Cuenta + Banco (OK)"
'Else
'    Banco = ""
'    Cuenta = ""
'    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
'End If

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = ""
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5,auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & MejorRem
StrSql = StrSql & ")"



'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Multivoice
'--------------------------------------------------------------------
Sub generarDatosRecibo92(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim TipoCuenta As String
Dim Cuenta As String
Dim Banco As String
Dim nroCuenta As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
TipoCuenta = ""
Cuenta = ""

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       TipoCuenta = "CBU"
       Cuenta = rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            TipoCuenta = "Cta. Nro."
            Cuenta = rsConsult!ctabnro
       Else
            TipoCuenta = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    TipoCuenta = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

'Se comento este codigo y se realizo abajo 04-05-13 Dimatz Rafael
'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'    If rsConsult!fpagbanc = "-1" Then
'        FormaPago = "Banco"
'        TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
'        nroCuenta = rsConsult!ctabnro
'        banco = rsConsult!terrazsoc
'    Else
'        FormaPago = "Efectivo"
'        TipoCuenta = ""
'        nroCuenta = ""
'        banco = ""
'    End If
'
'Else
'
'    FormaPago = "" 'banco - efectivo
'    banco = ""
'    nroCuenta = ""
'    TipoCuenta = ""
''   Flog.writeline "Error al obtener los datos de la forma de pago"
''   GoTo MError
'End If
'
'rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco "
StrSql = StrSql & " INNER JOIN formapago on formapago.fpagnro=ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado = -1 And ctabancaria.Ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        TipoCuenta = rsConsult!fpagdescabr
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
    Else
        FormaPago = "Efectivo"
        TipoCuenta = ""
        Banco = ""
        nroCuenta = ""
    End If
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    TipoCuenta = ""
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la obra social elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & TipoCuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Golden Peanut
'--------------------------------------------------------------------
Sub generarDatosRecibo93(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

SueldoRemu = 0
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha REAL.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND real = -1 ORDER BY altfec DESC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0

If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
    
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline "Error al obtener los datos del sueldo"
    'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------
StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
    Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " - " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos de Teletech
'--------------------------------------------------------------------
Sub generarDatosRecibo94(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Modelo
Dim oSocial
Dim Sector
Dim Actividad
Dim FuncionPuesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String


Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del Modelo asociado al proceso
'------------------------------------------------------------------
StrSql = " SELECT tipoproc.tprocdesc"
StrSql = StrSql & " FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro AND proceso.pronro = " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modelo = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social elegida (Estructura 17)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

oSocial = ""

If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
 

'------------------------------------------------------------------
'Busco el valor del Sector (Estructura 2)
'------------------------------------------------------------------
Flog.writeline "Busco la estructura Sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Actividad de la Empresa
'------------------------------------------------------------------
Flog.writeline "Busco la Actividad de la Empresa"
StrSql = " SELECT empresa.empactiv "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " INNER JOIN empresa ON estructura.estrnro=empresa.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & "And his_estructura.tenro = 10 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Actividad = ""

If Not rsConsult.EOF Then
   Actividad = rsConsult!empactiv
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Función del Puesto de Trabajo
'------------------------------------------------------------------

'StrSql = " SELECT estrdabr "
StrSql = " SELECT estrdext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 31 And his_estructura.ternro = " & ternro
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

FuncionPuesto = ""

If Not rsConsult.EOF Then
   FuncionPuesto = rsConsult!estrdext
Else
   Flog.writeline "Error al obtener los datos de la estructura Condicion"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

'StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & ternro
'StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
'OpenRecordset StrSql, rsConsult
'Direccion = ""
'If Not rsConsult.EOF Then
'   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
'    If Not EsNulo(rsConsult!piso) Then
'        Direccion = Direccion & " P. " & rsConsult!piso
'    End If
'    If Not EsNulo(rsConsult!oficdepto) Then
'        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
'    End If
    
'    Direccion = Direccion & ", " & rsConsult!locdesc
   
'   Localidad = Direccion
'Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------

StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
 
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    ' Nota: Separo con @ la forma de pago + el banco y el numero de cuenta para recuperarlos separados
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & "@@" & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el Lugar de Pago (20)
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrdabr LugarPago"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
 
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!LugarPago
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
 
End If

Localidad = Direccion

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & Localidad & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & tituloReporte & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Actividad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & ",'" & FuncionPuesto & "'"
 

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos de Tremac
'--------------------------------------------------------------------
Sub generarDatosRecibo95(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim RUT
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CentroCosto

' OTROS
Dim DiasPtes
Dim CabliqNumero

' --- NUEVOS ---
Dim SueldoMes As Integer
Dim LiquidoPagar As Integer
Dim ISAPRE As String
Dim AFP As String
Dim AFP_nro As Integer
Dim PorcAFP As Integer
Dim DiasTrabajados As Integer
Dim AFC_Empresa As Integer
Dim Pactado_ISAPRE As Integer
Dim Base_Tributable As Integer
Dim Local_Entro As Boolean

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    cliqnro = rsConsult!cliqnro
    proFecPago = rsConsult!proFecPago
    profecini = rsConsult!profecini
    proDesc = rsConsult!proDesc
Else
    Flog.writeline "Error al obtener los datos del proceso."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    empFecAlta = rsConsult!empfaltagr
    If IsNull(rsConsult!empremu) Then
        Sueldo = 0
    Else
        Sueldo = rsConsult!empremu
    End If
Else
    Flog.writeline "Error al obtener los datos del empleado."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
Else
    Flog.writeline "Error al obtener los datos del periodo actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
CentroCosto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del RUT
'------------------------------------------------------------------
StrSql = " SELECT nrodoc FROM ter_doc"
StrSql = StrSql & " WHERE ternro= " & Ternro
StrSql = StrSql & " AND tidnro = 1"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    RUT = rsConsult!NroDoc
Else
    Flog.writeline "No se encontraron los datos del RUT."
    RUT = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Liquido a Pagar
'------------------------------------------------------------------
If acunroSueldo <> 0 And Not IsNull(acunroSueldo) Then
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       LiquidoPagar = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo."
       LiquidoPagar = 0
    End If
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
    Categoria = "&nbsp;"
End If


'------------------------------------------------------------------
'Busco el valor de la ISAPRE
'------------------------------------------------------------------
StrSql = " SELECT estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ISAPRE = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de ISAPRE"
    ISAPRE = "&nbsp;"
End If


'------------------------------------------------------------------
'Busco el valor de la AFP
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, his_estructura.estrnro From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    AFP = rsConsult!estrdabr
    AFP_nro = rsConsult!Estrnro
Else
    Flog.writeline "Error al obtener los datos de la AFP"
    AFP = "&nbsp;"
    AFP_nro = 0
End If

'------------------------------------------------------------------
'Busco el % de la AFP
'------------------------------------------------------------------
If AFP_nro <> 0 Then
    StrSql = " SELECT vgrcoor_1, vgrvalor FROM valgrilla"
    StrSql = StrSql & " WHERE cgrnro = 6" ' La escala en la que debe buscar es la nro 6
    StrSql = StrSql & " AND vgrcoor_1 = " & AFP_nro
    StrSql = StrSql & " ORDER BY vgrcoor_1, vgrorden"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        PorcAFP = rsConsult!vgrvalor
    Else
        Flog.writeline "No hay un escala cargada para la AFP '" & AFP & "' (Se le asigna 0%)"
        PorcAFP = 0
    End If
Else
    Flog.writeline "El empleado no tiene AFP (Se le asigna 0%)"
    PorcAFP = 0
End If

'------------------------------------------------------------------
'Busco el valor de los días trabajados
'------------------------------------------------------------------
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
Else
    DiasTrabajados = 0
End If

'------------------------------------------------------------------
'Busco el valor de AFC Empresa
'------------------------------------------------------------------
If ConcAFC_Empresa <> "" And Not IsNull(ConcAFC_Empresa) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcAFC_Empresa & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        AFC_Empresa = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el AFC de Empresa."
        AFC_Empresa = 0
    End If
Else
    AFC_Empresa = 0
End If

'------------------------------------------------------------------
'Busco el valor Pactado de ISAPRE
'------------------------------------------------------------------
If ConcPactado_ISAPRE <> "" And Not IsNull(ConcPactado_ISAPRE) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcPactado_ISAPRE & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Pactado_ISAPRE = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el valor Pactado de ISAPRE."
        Pactado_ISAPRE = 0
    End If
Else
    Pactado_ISAPRE = 0
End If

'------------------------------------------------------------------
'Busco el valor de Sueldo del Mes
'------------------------------------------------------------------
If SueldoDelMes <> "" And Not IsNull(SueldoDelMes) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & SueldoDelMes & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        SueldoMes = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el valor del Sueldo del Mes."
        SueldoMes = 0
    End If
Else
    SueldoMes = 0
End If

'------------------------------------------------------------------
'Busco el valor de la Base Tributable
'------------------------------------------------------------------
If ConcBaseTributable <> "" And Not IsNull(ConcBaseTributable) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcBaseTributable
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Base_Tributable = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener el valor de la Base Tributable."
       Base_Tributable = 0
    End If
Else
    Base_Tributable = 0
End If

'------------------------------------------------------------------
'Busco el valor de los Dias Pendientes de Licencia de vacaciones
'------------------------------------------------------------------
DiasPtes = 0

StrSql = " SELECT vdiascorcant FROM vacdiascor "
StrSql = StrSql & " WHERE ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    DiasPtes = DiasPtes + rsConsult!vdiascorcant
    rsConsult.MoveNext
Loop
rsConsult.Close

StrSql = " SELECT vdiapedcant FROM vacdiasped "
StrSql = StrSql & " WHERE ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    DiasPtes = DiasPtes - rsConsult!vdiapedcant
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
    Else
        FormaPago = rsConsult!fpagdescabr
    End If
Else
    Flog.writeline "Error al obtener los datos de la forma de pago."
    FormaPago = "&nbsp;"
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
EmpEstrnro = 0

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró la Firma de la Empresa."
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = "&nbsp;"
    pliqfecdep = "&nbsp;"
    pliqbco = "&nbsp;"
    Flog.writeline "No se encontraron los datos de las cargas sociales."
End If
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,centrocosto,"
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & RUT & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

'Deci
StrSql = StrSql & "," & PorcAFP
StrSql = StrSql & "," & ConceptoHsExtra
StrSql = StrSql & "," & LiquidoPagar
StrSql = StrSql & "," & Base_Tributable
StrSql = StrSql & "," & DiasTrabajados

'Char
StrSql = StrSql & ",'" & ISAPRE & "'"
StrSql = StrSql & ",'" & AFP & "'"
StrSql = StrSql & ",'" & AFC_Empresa & "'"
StrSql = StrSql & ",'" & Pactado_ISAPRE & "'"
StrSql = StrSql & ",'" & AFP_nro & "'"

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Local_Entro = False

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    If Not Local_Entro Then
        Local_Entro = True
        
        StrSql = " INSERT INTO rep_recibo_det "
        StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
        StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
        StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
        StrSql = StrSql & " VALUES"
        StrSql = StrSql & "(" & NroProceso
        StrSql = StrSql & "," & Ternro
        StrSql = StrSql & "," & Pronro
        StrSql = StrSql & "," & rsConsult!cliqnro
        StrSql = StrSql & ",'SUELDO DEL MES'"
        StrSql = StrSql & ",'1'"
        StrSql = StrSql & ",0000"
        StrSql = StrSql & ",1"
        StrSql = StrSql & ",-1"
        StrSql = StrSql & ",1"
        StrSql = StrSql & "," & SueldoMes
        StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
    Else
        StrSql = " INSERT INTO rep_recibo_det "
        StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
        StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
        StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
        StrSql = StrSql & " VALUES"
        StrSql = StrSql & "(" & NroProceso
        StrSql = StrSql & "," & Ternro
        StrSql = StrSql & "," & Pronro
        StrSql = StrSql & "," & rsConsult!cliqnro
        StrSql = StrSql & ",'" & rsConsult!concabr & "'"
        StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
        StrSql = StrSql & "," & rsConsult!ConcNro
        StrSql = StrSql & "," & rsConsult!tconnro
        StrSql = StrSql & "," & rsConsult!concimp
        StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
        StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
        StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
        rsConsult.MoveNext
    End If
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de Monresa
'--------------------------------------------------------------------
Sub generarDatosRecibo96(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTicketBruto As Double
Dim MontoTicketNeto As Double
Dim ModeloLiq
Dim ImpIRPF
Dim ImpDescuentoIRPF

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMTSS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim GrupoActividad As Double
Dim SubGrupoActividad As Double

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------------------'
'  Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS  '
'------------------------------------------------------------------------------'
Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura BSE (col 113)."
Else
    If rsConsult!conftipo = "TE" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    cliqnro = rsConsult!cliqnro
    proFecPago = rsConsult!proFecPago
    profecini = rsConsult!profecini
    proDesc = rsConsult!proDesc
Else
    Flog.writeline "Error al obtener los datos del proceso"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    empFecAlta = rsConsult!empfaltagr
    ' el sueldo se saca del concepto 01000
    Sueldo = 0
    'If IsNull(rsConsult!empremu) Then
    '   Sueldo = 0
    'Else
    '   Sueldo = rsConsult!empremu
    'End If
Else
    Flog.writeline "Error al obtener los datos del empleado"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
Else
    Flog.writeline "Error al obtener los datos del periodo actual"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro = 1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Cuil = " "
    Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
    Localidad = Direccion
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsNeto <> "" And Not IsNull(TicketsNeto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsNeto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketNeto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketNeto = 0
    End If
Else
    MontoTicketNeto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsBruto <> "" And Not IsNull(TicketsBruto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsBruto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketBruto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketBruto = 0
    End If
Else
    MontoTicketBruto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para IRPF
'------------------------------------------------------------------
If ConcImpIRPF <> "" And Not IsNull(ConcImpIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para IRPF."
        ImpIRPF = 0
    End If
Else
    ImpIRPF = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para Descuento de IRPF
'------------------------------------------------------------------
If ConcImpDescuentoIRPF <> "" And Not IsNull(ConcImpDescuentoIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpDescuentoIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpDescuentoIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para Descuento de IRPF."
        ImpDescuentoIRPF = 0
    End If
Else
    ImpDescuentoIRPF = 0
End If

'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
Sueldo = 0

If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
    Sueldo = 0
    'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación
'------------------------------------------------------------------
ModeloLiq = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ModeloLiq = rsConsult!tprocdesc
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------
CentroCosto = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
FormaPago = " "

StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    Else
        FormaPago = rsConsult!fpagdescabr
    End If
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
EmpEstrnro = 0
EmpNombre = " "

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, paisdesc  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " left JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " WHERE cabdom.tidonro = 1 " & _
    " ORDER BY domdefault "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio tipo 1 de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para obtener el MTSS de la empresa
Flog.writeline "Buscando el MTSS tipo de doc " & CodMTSS
StrSql = " SELECT *"
StrSql = StrSql & " From ter_doc"
StrSql = StrSql & " Where ter_doc.ternro = " & rs_estructura!Ternro & " And ter_doc.tidnro = " & CodMTSS
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MTSS"
    EmpMTSS = "  "
Else
    Flog.writeline "MTSS = " & rs_cuit!NroDoc
    EmpMTSS = IIf(EsNulo(rs_cuit!NroDoc), " ", rs_cuit!NroDoc)
End If

' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el BSE del empleado
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = " SELECT his_estructura.estrnro, estrdabr, estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro= " & CodBSE & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el BSE"
    EmpBSE = " "
Else
    Flog.writeline "BSE = " & rsConsult!Estrnro & " " & rsConsult!estrdabr & "COD Externo " & rsConsult!estrcodext
    EmpBSE = IIf(EsNulo(rsConsult!estrcodext), " ", rsConsult!estrcodext)
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Grupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del grupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 38)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        GrupoActividad = 0
    Else
        GrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del Grupo de actividad "
    GrupoActividad = 0
End If

'------------------------------------------------------------------
'Busco el valor del Subgrupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del Subgrupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 39)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        SubGrupoActividad = 0
    Else
        SubGrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del SubGrupo de actividad "
    SubGrupoActividad = 0
End If
'-----------------------------------------------------------------------------------------


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5,"
StrSql = StrSql & " auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5"
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & ImpIRPF & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

StrSql = StrSql & ",'" & EmpMTSS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ",'" & ModeloLiq & "'"

StrSql = StrSql & "," & numberForSQL(MontoTicketNeto)
StrSql = StrSql & "," & numberForSQL(MontoTicketBruto)
StrSql = StrSql & "," & numberForSQL(GrupoActividad)
StrSql = StrSql & "," & numberForSQL(SubGrupoActividad)
StrSql = StrSql & "," & numberForSQL(ImpDescuentoIRPF)
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Multivoice Colombia
'--------------------------------------------------------------------
Sub generarDatosRecibo97(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim oSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim TipoCuenta As String
Dim Cuenta As String
Dim Banco As String
Dim BancoDesc As String
Dim nroCuenta As String
Dim FondoDePensiones As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'JPB - Se quito la condicion (Sueldo=0) para que el sueldo no lo tome de la tabla empleado
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
TipoCuenta = ""
Cuenta = ""

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult
'Forma de Pago: (Estas formas de pago fueron tomadas de la forma de pago de la Base de Test)
'3256 - Cheque
'3255 - Cuenta Corriente
'3254 - Cuenta de Ahorros
'3257 - Efectivo
If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
      ' TipoCuenta = "CBU"
       Cuenta = rsConsult!ctabcbu
       BancoDesc = rsConsult!Bandesc
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
           ' TipoCuenta = "Cta. Nro."
            Cuenta = rsConsult!ctabnro
            BancoDesc = rsConsult!Bandesc
       Else
         '   TipoCuenta = ""
            Cuenta = ""
            BancoDesc = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
  '  TipoCuenta = ""
    Cuenta = ""
    BancoDesc = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida (Entidad Promotora de Salud - Estr. 17)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Fondo de Pensiones (Estructura 15)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
FondoDePensiones = ""
If Not rsConsult.EOF Then
   FondoDePensiones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos Fondo de Pensiones "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & oSocial & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & TipoCuenta & "'"
StrSql = StrSql & ",'" & BancoDesc & "'"
StrSql = StrSql & ",'" & FondoDePensiones & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Freddo (MODELO 89 DE EJEMPLO)
'--------------------------------------------------------------------
Sub generarDatosRecibo98(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim HorasTrab

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim CajaJub
Dim Convenio
Dim Sucursal

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

Dim l_bco

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
' Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
' Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
' contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado de la fase marcada como Alta Reconocida."
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
' Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
' Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
' Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
' Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
' Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la direccion de la sucursal (Lugar de Pago)"
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Sueldo = rsConsult!almonto
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal  (Centro de resultado)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la Calificacion Profesional (puesto)"
End If

'------------------------------------------------------------------
'Busco el valor de Caja Jub. AFJP
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
CajaJub = ""
If Not rsConsult.EOF Then
    CajaJub = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la Caja de Jubilacion (AFJP)"
End If

'------------------------------------------------------------------
'Busco el valor del tipo de estructura Banco
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=41 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del banco asociado al empleado en estructura organizacional. "
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT cbnro, ctabestado, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro FROM ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
StrSql = StrSql & " AND ctabestado = -1"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
    Else
        CuentaBancaria = rsConsult!ctabcbu
    End If
Else
    Flog.writeline "Error al obtener la forma de pago asociada a la cuenta bancaria del empleado con estado activa. Ademas Cuenta/CBU "
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If

'------------------------------------------------------------------
'Busco el valor de convenio
'------------------------------------------------------------------
Convenio = 0
StrSql = " SELECT estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Convenio = rsConsult!Estrnro
Else
    Flog.writeline "Error al obtener los datos del convenio"
End If


'------------------------------------------------------------------
'Busco el valor de Horas Extras Acumuladas
'------------------------------------------------------------------
FechaAux = CDate("01" & "/" & Month(pliqhasta) & "/" & Year(pliqhasta))
FechaAux = DateAdd("d", -1, FechaAux)

HorasTrab = CStr(FechaAux)

If esTicketsConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & Tickets
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & Tickets
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    HorasTrab = HorasTrab & ": " & CStr(rsConsult!Valor)
Else
    HorasTrab = HorasTrab & ": "
End If
rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Banco de Cuenta Bancaria
'------------------------------------------------------------------
StrSql = "SELECT bandesc FROM ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON banco.ternro=ctabancaria.banco "
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    l_bco = rsConsult!Bandesc
Else
    l_bco = ""
End If
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1, auxdeci2,auxchar)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro
StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo
StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"
StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"
StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"
StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"
StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden
StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Sucursal & "'"
StrSql = StrSql & " ,'" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & CajaJub & "'"
StrSql = StrSql & " ,'" & HorasTrab & "'"
StrSql = StrSql & " ," & Convenio
StrSql = StrSql & " ," & EmpEstrnro
StrSql = StrSql & " ,'" & l_bco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Fundición San Cayetano
'--------------------------------------------------------------------
Sub generarDatosRecibo99(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Convenio
Dim Antiguedad
Dim Hijos
Dim ObraSocial

'Datos de la empresa
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim TipoCuenta As String
Dim Cuenta As String
Dim Banco As String
Dim BancoDesc As String
Dim nroCuenta As String
Dim FondoDePensiones As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_convenio As New ADODB.Recordset 'Se solicita la impresión del convenio. Va a auxiliar.
Dim rs_antiguedad As New ADODB.Recordset 'Impresión de la antiguedad en años
Dim rs_Hijos As New ADODB.Recordset 'Busca los hijos que tiene cargados (Toda edad)

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM v_empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'        Busco el valor del convenio
'------------------------------------------------------------------
StrSql = "SELECT * FROM his_estructura INNER JOIN estructura "
StrSql = StrSql & " ON his_estructura.estrnro=estructura.estrnro "
StrSql = StrSql & " INNER JOIN v_empleado ON v_empleado.ternro = his_estructura.ternro"
StrSql = StrSql & " Where v_empleado.Ternro = " & Ternro
StrSql = StrSql & " And his_estructura.tenro = 19" '19 es la estructura Convenio
StrSql = StrSql & " AND (his_estructura.htethasta>=' " & Date & "'"
StrSql = StrSql & " OR his_estructura.htethasta IS null)"

OpenRecordset StrSql, rs_convenio
If Not rs_convenio.EOF Then
  Convenio = rs_convenio!estrdabr
Else
  Convenio = "error en Convenio"
End If

'------------------------------------------------------------------
'              Busco datos de Antiguedad
'------------------------------------------------------------------
StrSql = "select empfecalta, empfecbaja from v_empleado"
StrSql = StrSql & " where ternro=" & Ternro
OpenRecordset StrSql, rs_antiguedad
If Not rs_antiguedad.EOF Then
  If Not (IsNull(rs_antiguedad!empFecBaja)) And Not (IsNull(rs_antiguedad!empFecAlta)) Then
    Antiguedad = AnsAntig(rs_antiguedad!empFecAlta, rs_antiguedad!empFecBaja)
  ElseIf IsNull(rs_antiguedad!empFecAlta) Then
    Antiguedad = 0
    Flog.writeline "No se encuentra la fecha de alta del empleado"
  Else
    Antiguedad = AnsAntig(rs_antiguedad!empFecAlta, Date)
  End If
Else
  Antiguedad = 0
  Flog.writeline "No se encuentra la fase activa del empleado"
End If

'------------------------------------------------------------------
'             Busco la cantidad de hijos
'------------------------------------------------------------------
StrSql = "SELECT COUNT(*) tothijos FROM familiar f "
StrSql = StrSql & " INNER JOIN v_empleado ON "
StrSql = StrSql & " f.Empleado = v_empleado.Ternro "
StrSql = StrSql & " INNER JOIN parentesco ON parentesco.parenro = f.parenro "
StrSql = StrSql & " WHERE v_empleado.ternro= " & Ternro & " AND f.parenro=2"
Flog.writeline "Parentesco: " & StrSql
OpenRecordset StrSql, rs_Hijos

If Not rs_Hijos.EOF Then
  Hijos = rs_Hijos!tothijos
Else
  Hijos = 0
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & ""
StrSql = StrSql & "And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ""
StrSql = StrSql & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
TipoCuenta = ""
Cuenta = ""

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult
'Forma de Pago: (Estas formas de pago fueron tomadas de la forma de pago de la Base de Test)
'3256 - Cheque
'3255 - Cuenta Corriente
'3254 - Cuenta de Ahorros
'3257 - Efectivo
If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
      ' TipoCuenta = "CBU"
       Cuenta = rsConsult!ctabcbu
       BancoDesc = rsConsult!Bandesc
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
           ' TipoCuenta = "Cta. Nro."
            Cuenta = rsConsult!ctabnro
            BancoDesc = rsConsult!Bandesc
       Else
         '   TipoCuenta = ""
            Cuenta = ""
            BancoDesc = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
  '  TipoCuenta = ""
    Cuenta = ""
    BancoDesc = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        TipoCuenta = rsConsult!fpagdescabr ' & " "& rsConsult!terrazsoc & " " & rsConsult!ctabnro
        If Not (IsNull(rsConsult!ctabnro)) Then
          nroCuenta = rsConsult!ctabnro
        Else
          nroCuenta = ""
          Flog.writeline "La forma de pago se especifica como Banco, y no se cargó el nro de cuenta"
        End If
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    TipoCuenta = ""
    Flog.writeline "Error al obtener la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida (Entidad Promotora de Salud - Estr. 17)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
ObraSocial = ""
If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------------
'                 Busco datos de la obra social elegida
'------------------------------------------------------------------------
StrSql = "SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = "
StrSql = StrSql & " his_estructura.estrnro"
StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta) & " AND "
StrSql = StrSql & " (htethasta >= " & ConvFecha(pliqhasta) & " OR htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro

OpenRecordset StrSql, objRs

If Not objRs.EOF Then
  ObraSocial = objRs!estrdabr
Else
  ObraSocial = ""
  Flog.writeline "La obra social elegida está vacía"
End If
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5,"
StrSql = StrSql & " auxdeci1, auxdeci2 )"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & TipoCuenta & "'"
StrSql = StrSql & ",'" & BancoDesc & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ", " & Hijos
StrSql = StrSql & ", " & Antiguedad
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Sidersa
'--------------------------------------------------------------------
Sub generarDatosRecibo100(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol = 44"
StrSql = StrSql & " AND conftipo = 'COP'"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Titulo = objRs2!confetiq
    
    If objRs2!confval = 1 Then
        StrSql = " SELECT estrdabr FROM his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
        StrSql = StrSql & " AND his_estructura.tenro = " & objRs2!confval2
        StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Datos = rsConsult2!estrdabr
        End If
    ElseIf objRs2!confval = 2 Then
            If CDate(Day(Date) & "/" & Month(Date) & "/" & Year(Date)) > CDate(Day(empFecAlta) & "/" & Month(empFecAlta) & "/" & Year(empFecAlta)) Then
                DiasAcum = 0
                Dias = 0
                YaEntro = False
                
                StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro
                StrSql = StrSql & " AND real = -1"
                StrSql = StrSql & " AND NOT altfec is NULL"
                StrSql = StrSql & " AND NOT (bajfec is NULL AND estado = 0)"
                StrSql = StrSql & " AND altfec <= " & ConvFecha(Date)
                StrSql = StrSql & " ORDER BY altfec ASC"
                OpenRecordset StrSql, rs_Fases
                Do While Not rs_Fases.EOF
                    fecalta = rs_Fases!altfec
                    
                    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
                    If rs_Fases!estado Then
                        fecbaja = Date
                    ElseIf rs_Fases!bajfec <= Date Then
                        fecbaja = rs_Fases!bajfec
                    Else
                        fecbaja = Date
                    End If
                    
                    '12/11/2010 - Stankunas Cesar - Se cambió la lógica
                    Dias = DateDiff("d", fecalta, fecbaja)
                    If YaEntro Then
                        FechaAux = DateAdd("d", -(DiasAcum), fecalta)
                        DiasAcum = DiasAcum + Dias + 1
                    Else
                        DiasAcum = Dias + 1
                        FechaAux = fecalta
                    End If
                    YaEntro = True
                    
                    rs_Fases.MoveNext
                Loop
                rs_Fases.Close
                
                Datos = FechaAux
            End If
    ElseIf objRs2!confval = 3 Then
      acunroSueldo = CInt(objRs2!confval2)
        '------------------------------------------------------------------
    'Busco el valor del sueldo basico
    '------------------------------------------------------------------
    'Se configuró que el sueldo básico sale de un acumulador por confrep
      StrSql = " SELECT almonto"
      StrSql = StrSql & " From acu_liq"
      StrSql = StrSql & " Where acunro = " & acunroSueldo
      StrSql = StrSql & " AND cliqnro = " & cliqnro
      OpenRecordset StrSql, rsConsult
      If Not rsConsult.EOF Then
        Datos = rsConsult!almonto
      Else
        Flog.writeline "Error al obtener el acumulador configurado en la columna 44 " & Err.Description
        Datos = 0
      End If
    End If
Else
    Flog.writeline "No esta configurado el campo variable en el ConfRep (Columna 44)"
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'Se elimina del modelo por definición
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos del centro de costo"
'End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se reactiva la consulta de descripcion del Banco "bandesc", quito la opción "terrazsoc"
'StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If CInt(rsConsult!fpagnro) = 2 Then 'Caja de ahorro, informo Nro Cuenta
        CuentaBancaria = rsConsult!ctabnro
        Flog.writeline "La forma de pago del empleado es Caja de Ahorro"
    ElseIf CInt(rsConsult!fpagnro) = 24 Then 'CBU, informo el nro
        CuentaBancaria = rsConsult!ctabcbu
        Flog.writeline "La forma de pago del empleado es CBU"
    Else
        CuentaBancaria = ""
        Flog.writeline "Mal configurada la forma de pago. Debe ser CBU o CH"
    End If
    
    'Cargo los datos de descripción del banco
    If Not EsNulo(rsConsult!Bandesc) Then
      Banco = rsConsult!Bandesc
    Else
      Banco = ""
      Flog.writeline "No encontró la descripción del banco"
    End If
    
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, bandesc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
      FormaPago = rsConsult2!fpagdescabr
      'Cargo los datos de la cuenta bancaria
      If CInt(rsConsult2!fpagnro) = 2 Then 'Caja de ahorro, informo Nro Cuenta
          CuentaBancaria = rsConsult2!ctabnro
          Flog.writeline "La forma de pago del empleado es Caja de Ahorro"
      ElseIf CInt(rsConsult2!fpagnro) = 24 Then 'CBU, informo el nro
          CuentaBancaria = rsConsult2!ctabcbu
          Flog.writeline "La forma de pago del empleado es CBU"
      Else
          CuentaBancaria = ""
          Flog.writeline "Mal configurada la forma de pago. Debe ser CBU o CH"
      End If

      If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
          CuentaBancaria = rsConsult2!ctabnro
      Else
          CuentaBancaria = rsConsult2!ctabcbu
      End If
      Banco = rsConsult2!Bandesc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
        Flog.writeline "No se encontró la forma de pago"
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad," 'centrocosto, se eliminó del insert
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Categoria & "'" 'Mid(Categoria, 1, 20) se coloca el campo completo por pedido
'Se eliminó el centro de costo, se elimina el insert para que no haga problema
'StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Titulo & "'"
StrSql = StrSql & " ,'" & Datos & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Modelo 101 para Mundo Maipu. En base al estándar con elementos del 3 y 87
'--------------------------------------------------------------------
Sub generarDatosRecibo101(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta
Dim LugarPago
Dim empFecRec
Dim Documento

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ObraSocial

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la fecha de alta reconocida                         18-04-2011
'------------------------------------------------------------------

StrSql = " SELECT altfec FROM fases WHERE empleado = " & Ternro & _
         " and fasrecofec=-1 order by altfec desc" 'Por fecha de alta descendente para tomar la ultima
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecRec = rsConsult!altfec
Else
   empFecRec = ""
   Flog.writeline "No se encontro la fecha de alta reconocida"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar4, auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
'StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ", '" & LugarPago & "'"
StrSql = StrSql & ", '" & Documento & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


