Attribute VB_Name = "repRecibos2"


'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de MAE
'--------------------------------------------------------------------
Sub generarDatosRecibo103(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

SueldoRemu = 0
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha REAL.
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND real = -1 ORDER BY altfec ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0

If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
    
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline "Error al obtener los datos del sueldo"
    'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------
StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
    Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " - " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Las Lenas
'--------------------------------------------------------------------
Sub generarDatosRecibo104(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
   
   rsConsult.Close
   StrSql = "select almonto from acu_liq where acunro=137 and cliqnro=" & cliqnro
   OpenRecordset StrSql, rsConsult
   
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Las Lenas
'--------------------------------------------------------------------
Sub generarDatosRecibo24(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Met Roma
'--------------------------------------------------------------------
Sub generarDatosRecibo113(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim reg_jub As String
Dim Sector As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec,bajfec,fasrecofec "
StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    empFecBaja = rsConsult!bajfec
    Do While Not rsConsult.EOF
        If rsConsult!fasrecofec = -1 Then
            empFecAlta = rsConsult!altfec
            empFecBaja = rsConsult!bajfec
        End If
        rsConsult.MoveNext
    Loop
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor Regimen Jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

reg_jub = ""

If Not rsConsult.EOF Then
   reg_jub = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Regimen jubilatorio"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"

'StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
'StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"

'Se cambio regimen horario por sector
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
'Se cambio por reporta a
StrSql = StrSql & ",'" & reg_jub & "'"



StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Horwath Rosario
'--------------------------------------------------------------------
Sub generarDatosRecibo112(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Sucursal

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la sucursaal
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ")"
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para MSD (Merck Sharp & Dohme Arg)
'--------------------------------------------------------------------
Sub generarDatosRecibo105(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim DiasPtes
Dim CabliqNumero
Dim Ticket
Dim MontoTickets
Dim CantTickets

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0



'------------------------------------------------------------------
'Busco columna 33  del confrep para traer el tipo de concepto que el recibo no debe tomar en cuenta en la generacion "
'------------------------------------------------------------------
Flog.writeline "Buscando columna 33 del confrep para traer el tipo de concepto que el recibo no debe tomar en cuenta en la generacion "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 33   "
OpenRecordset StrSql, rsConsult

tipo33 = ""
Cod33 = -1
 
Do While Not rsConsult.EOF
   
   tipo33 = "CO"
   Cod33 = rsConsult!confval2

   Flog.writeline "Columna33: " & tipo33 & " concepto: " & Cod33 & " codigo: " & Cod33
  
   rsConsult.MoveNext
Loop
rsConsult.Close

 
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
   Categoria = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Puesto"
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT concepto.conccod AS codigo, concepto.concabr AS descripcion, detliq.dlimonto AS valor, detliq.dlicant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro "
Else
    StrSql = " SELECT acumulador.acunro AS codigo, acumulador.acudesabr AS descripcion, acu_liq.almonto AS valor, acu_liq.alcant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro "
End If
    
OpenRecordset StrSql, rsConsult

CabliqNumero = 0
Ticket = "&nbsp;"
MontoTickets = 0
CantTickets = 0

If Not rsConsult.EOF Then
    CabliqNumero = rsConsult!cliqnro
    Ticket = rsConsult!codigo & " " & rsConsult!Descripcion
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    If Not IsNull(rsConsult!Cantidad) Then
       CantTickets = CantTickets + CDbl(rsConsult!Cantidad)
    End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxdeci2, modelo)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & tipoRecibo
 
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
'JPB - Se agrego en el filtro la condicion que el concepto no sea del tipo especificado en la columna 33 del confrep
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 AND concepto.tconnro <> " & Cod33
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Farmografica
'--------------------------------------------------------------------
Sub generarDatosRecibo106(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim telefono

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset
Dim t

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline "v  Basico" & StrSql
 
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = 0
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
'Titulo = ""
'Datos = ""
'StrSql = " SELECT * FROM confrep"
'StrSql = StrSql & " WHERE repnro = 60"
'StrSql = StrSql & " AND confnrocol = 44"
'StrSql = StrSql & " AND conftipo = 'COP'"
'OpenRecordset StrSql, objRs2
'If Not objRs2.EOF Then
'    Titulo = objRs2!confetiq
'
'    If objRs2!confval = 1 Then
'        StrSql = " SELECT estrdabr FROM his_estructura"
'        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
'        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
'        StrSql = StrSql & " AND his_estructura.tenro = " & objRs2!confval2
'        StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
'        OpenRecordset StrSql, rsConsult2
'        If Not rsConsult2.EOF Then
'            Datos = rsConsult2!estrdabr
'        End If
'    Else
'        If objRs2!confval = 2 Then
'            If CDate(Day(Date) & "/" & Month(Date) & "/" & Year(Date)) > CDate(Day(empFecAlta) & "/" & Month(empFecAlta) & "/" & Year(empFecAlta)) Then
'                DiasAcum = 0
'                dias = 0
'                YaEntro = False
'
'                StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro
'                StrSql = StrSql & " AND real = -1"
'                StrSql = StrSql & " AND NOT altfec is NULL"
'                StrSql = StrSql & " AND NOT (bajfec is NULL AND estado = 0)"
'                StrSql = StrSql & " AND altfec <= " & ConvFecha(Date)
'                StrSql = StrSql & " ORDER BY altfec ASC"
'                OpenRecordset StrSql, rs_Fases
'                Do While Not rs_Fases.EOF
'                    fecalta = rs_Fases!altfec
'
'                    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
'                    If rs_Fases!estado Then
'                        fecbaja = Date
'                    ElseIf rs_Fases!bajfec <= Date Then
'                        fecbaja = rs_Fases!bajfec
'                    Else
'                        fecbaja = Date
'                    End If
'
'                    '12/11/2010 - Stankunas Cesar - Se cambió la lógica
'                    dias = DateDiff("d", fecalta, fecbaja)
'                    If YaEntro Then
'                        FechaAux = DateAdd("d", -(DiasAcum), fecalta)
'                        DiasAcum = DiasAcum + dias + 1
'                    Else
'                        DiasAcum = dias + 1
'                        FechaAux = fecalta
'                    End If
'                    YaEntro = True
'
'                    rs_Fases.MoveNext
'                Loop
'                rs_Fases.Close
'
'                Datos = FechaAux
'            End If
'        End If
'    End If
'Else
'    Flog.writeline "No esta configurado el campo variable en el ConfRep (Columna 44)"
'End If

StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 2"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
 OpenRecordset StrSql, rsConsult2
 If Not rsConsult2.EOF Then
       Datos = rsConsult2!estrdabr
 End If
        
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,telefono.telnro,detdom.codigopostal,pais.paisdesc,cpa"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " "
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=10 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = empresa.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN Telefono ON detdom.domnro=telefono.domnro"
StrSql = StrSql & " INNER JOIN pais ON pais.paisnro=localidad.paisnro "

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult
Direccion = ""
If rsConsult.EOF Then
    Flog.writeline "Error al obtener los datos de la localidad"
End If
t = 1
Do While Not rsConsult.EOF
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If t < 4 Then
        If EsNulo(tel) Then
            tel = "Tel: " & rsConsult!telnro
        Else
            tel = tel & " / " & rsConsult!telnro
            t = t + 1
        End If
    End If
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    'Direccion = Direccion & ", " & rsConsult!locdesc & ","
    'tel = "Tel:" & rsConsult!telnro
    Localidad = rsConsult!cpa & "-" & rsConsult!locdesc & "-" & rsConsult!paisdesc
    
    Flog.writeline Localidad
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

  If esSueldoConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & acunroSueldo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
'    OpenRecordset StrSql, rsConsult
    
    Flog.writeline "Sueldo Basico" & StrSql
    
    If Not rsConsult.EOF Then
        Sueldo = rsConsult!Valor
        Flog.writeline Sueldo
        Flog.writeline StrSql
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
'End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
    Flog.writeline "Obra social:" & ObraSocial
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Sueldo Bruto
'StrSql = " SELECT almonto"
'StrSql = StrSql & " From acu_liq"
'StrSql = StrSql & " Where acunro = " & ValNetoTalon
'StrSql = StrSql & " AND cliqnro = " & cliqnro
'OpenRecordset StrSql, rsConsult

'Flog.writeline StrSql

  If esGratificacionConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & Gratificacion & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & Gratificacion & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ValorAcumSueldoBruto = rsConsult!Valor
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto" & ValorAcumSueldoBruto
Else
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto"
   Flog.writeline StrSql
   ValorAcumSueldoBruto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0

If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        Flog.writeline StrSql
        Flog.writeline rsConsult2!ConcNro
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,auxdeci3,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1 "
StrSql = StrSql & " , auxdeci4, auxdeci5"
StrSql = StrSql & " )"
',auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
'If tel = "" Then
'    StrSql = StrSql & " ," & 0
'Else
'    StrSql = StrSql & " ," & tel
'End If
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & " ,'" & Mid(valorAntig, 1, 25) & "'" 'CentroCosto
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & tel & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Titulo & "'"
StrSql = StrSql & " ,'" & Datos & "'"
StrSql = StrSql & " ," & NetoTalon

StrSql = StrSql & " ," & ValorAcumSueldoBruto
StrSql = StrSql & " ," & FuturosAumentos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    'Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de INDAP
'--------------------------------------------------------------------
Sub generarDatosRecibo107(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja

Dim Desahucio
Dim grado
Dim CalJuridica
Dim Estamento
Dim Departamento
Dim Nivel
Dim InstPrev
Dim InstSalud
Dim Bienios
Dim FecBienio

Dim PlanSalud
Dim Bruto
Dim Imponible
Dim Tributable
Dim DescLegales
Dim OtrosDesc
Dim TotDesc
Dim SueldoLiq
Dim DiasTrabajados
Dim PorcDesa

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
SueldoRemu = 0

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu FROM empleado"
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""

StrSql = " SELECT * FROM fases"
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""

StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha REAL.
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
StrSql = StrSql & " AND real = -1"
StrSql = StrSql & " ORDER BY altfec ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10)"
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0

If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
    StrSql = StrSql & " AND detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor FROM acu_liq"
    StrSql = StrSql & " WHERE acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
    
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline "Error al obtener los datos del sueldo"
    'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------
Documento = ""

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Documento = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos de la Documento"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 4"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta)
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro=20"
StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
End If
rsConsult.Close


'***************************************************
'******************** Desahucio ********************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=76 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Desahucio = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Desahucio"
End If
rsConsult.Close

'***************************************************
'******************** Grado ************************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=49 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   grado = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Grado"
End If
rsConsult.Close

'***************************************************
'******************** Calidad Juridica *************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=54 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CalJuridica = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Calidad Juridica"
End If
rsConsult.Close

'***************************************************
'******************** Estamento ********************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=55 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Estamento = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Estamento"
End If
rsConsult.Close

'***************************************************
'******************** Departamento *****************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=9 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Departamento "
End If
rsConsult.Close

'***************************************************
'******************** Nivel ********************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=53 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nivel = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Nivel"
End If
rsConsult.Close

'***************************************************
'************** Institución Previsional ************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=15 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   InstPrev = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Institución Previsional"
End If
rsConsult.Close

'***************************************************
'************* Institución de Salud ****************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=17 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   InstSalud = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Institución de Salud"
End If
rsConsult.Close

'***************************************************
'******************** Fecha Bienio *****************
'***************************************************
StrSql = " SELECT fechacumple, cantidad FROM emp_bienios"
StrSql = StrSql & " WHERE ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   FecBienio = rsConsult!fechacumple
   Bienios = rsConsult!Cantidad
Else
   Flog.writeline "Error al obtener la Fecha de Bienio"
   Bienios = 0
   FecBienio = ""
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de los días trabajados
'------------------------------------------------------------------
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
Else
    DiasTrabajados = 0
End If

'------------------------------------------------------------------
'Busco el valor del Plan de Salud
'------------------------------------------------------------------
If acunroPlanSalud <> 0 And Not IsNull(acunroPlanSalud) Then
    If esPlanSaludConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroPlanSalud
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroPlanSalud
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       PlanSalud = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Plan de Salud."
       PlanSalud = 0
    End If
Else
    PlanSalud = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total Bruto
'------------------------------------------------------------------
If acunroBruto <> 0 And Not IsNull(acunroBruto) Then
    If esBrutoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroBruto
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroBruto
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Bruto = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Bruto."
       Bruto = 0
    End If
Else
    Bruto = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total Imponible
'------------------------------------------------------------------
If acunroImponible <> 0 And Not IsNull(acunroImponible) Then
    If esImponibleConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroImponible
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Imponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Imponible."
       Imponible = 0
    End If
Else
    Imponible = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total Tributable
'------------------------------------------------------------------
If acunroTributable <> 0 And Not IsNull(acunroTributable) Then
    If esTributableConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroTributable
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroTributable
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Tributable = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Tributable."
       Tributable = 0
    End If
Else
    Tributable = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total de Descuento Legales
'------------------------------------------------------------------
If acunroDescLegales <> 0 And Not IsNull(acunroDescLegales) Then
    If esDescLegalesConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroDescLegales
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroDescLegales
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DescLegales = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total de Descuento Legales."
       DescLegales = 0
    End If
Else
    DescLegales = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total de Otros Descuentos
'------------------------------------------------------------------
If acunroOtrosDesc <> 0 And Not IsNull(acunroOtrosDesc) Then
    If esOtrosDescConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroOtrosDesc
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroOtrosDesc
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       OtrosDesc = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total de Otros Descuentos."
       OtrosDesc = 0
    End If
Else
    OtrosDesc = 0
End If


'------------------------------------------------------------------
'Busco el valor del Total de Descuentos
'------------------------------------------------------------------
If acunroTotDesc <> 0 And Not IsNull(acunroTotDesc) Then
    If esTotDescConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroTotDesc
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroTotDesc
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       TotDesc = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total de Descuentos."
       TotDesc = 0
    End If
Else
    TotDesc = 0
End If


'------------------------------------------------------------------
'Busco el valor del Sueldo Liquido
'------------------------------------------------------------------
If acunroSueldoLiq <> 0 And Not IsNull(acunroSueldoLiq) Then
    If esSueldoLiqConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldoLiq
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldoLiq
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       SueldoLiq = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Sueldo Liquido."
       SueldoLiq = 0
    End If
Else
    SueldoLiq = 0
End If


'------------------------------------------------------------------
'Busco el valor del % de Desahucio
'------------------------------------------------------------------
If concPorcDesa <> "" And Not IsNull(concPorcDesa) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & concPorcDesa & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        PorcDesa = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el valor del Sueldo del Mes."
        PorcDesa = 0
    End If
Else
    PorcDesa = 0
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener el cuit de la empresa (Para Chile se cambio de tidnro 6 a tidnro 1)
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 1)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar6,auxchar7,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxdeci4,auxdeci5,auxdeci6,auxdeci7,auxdeci8,auxdeci9)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Desahucio, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(grado, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CalJuridica, 1, 20) & "'"
StrSql = StrSql & ",'" & Departamento & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

StrSql = StrSql & ",'" & Nivel & "'"
StrSql = StrSql & ",'" & FecBienio & "'"
StrSql = StrSql & ",'" & InstSalud & "'"
StrSql = StrSql & ",'" & PlanSalud & "'"
StrSql = StrSql & ",'" & InstPrev & "'"
StrSql = StrSql & ",'" & DiasTrabajados & "'"
StrSql = StrSql & ",'" & Estamento & "'"

StrSql = StrSql & "," & Bruto
StrSql = StrSql & "," & Imponible
StrSql = StrSql & "," & Tributable
StrSql = StrSql & "," & DescLegales
StrSql = StrSql & "," & OtrosDesc
StrSql = StrSql & "," & TotDesc
StrSql = StrSql & "," & SueldoLiq
StrSql = StrSql & "," & PorcDesa
StrSql = StrSql & "," & Bienios

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos General Mills 108
'--------------------------------------------------------------------
Sub generarDatosRecibo108(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ObraSocial

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If

'If Sueldo = 0 Then
    
    If esSueldoConc Then
    
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
        
    Else
    
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    End If
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro" 'AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    'FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    'FormaPago = rsConsult!terrazsoc & " " & rsConsult!ctabnro
  'Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Buscando los datos de la cuenta del empleado."

'StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'        Banco = rsConsult!Bandesc
'        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
'  Else
'        Banco = ""
'        nroCuenta = ""
'        Flog.writeline "El empleado no tiene cuentas bancarias activas"
'End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       nroCuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            nroCuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            nroCuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    nroCuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener el Lugar de Pago"
   'GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " auxchar3 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar5,auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos del recibo adicional para MSD (Merck Sharp & Dohme Arg)
'--------------------------------------------------------------------
Sub generarDatosRecibo109(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim DiasPtes
Dim CabliqNumero
Dim Ticket
Dim MontoTickets
Dim CantTickets

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columna 33 y 34 para del confrep para traer el tipo de concepto a imprimir y el acum/concepto adicional"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 33 OR confnrocol = 34) "
OpenRecordset StrSql, rsConsult

tipo33 = ""
tipo34 = ""
 
Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 33
             If rsConsult!conftipo = "AC" Then
                tipo33 = "AC"
                Cod33 = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo33 = "CO"
                Cod33 = rsConsult!confval2
             End If
             Flog.writeline "Columna33: " & tipo33 & " concepto: " & Cod33 & " codigo: " & Cod33
      Case 34
             If rsConsult!conftipo = "AC" Then
                tipo34 = "AC"
                Cod34 = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo34 = "CO"
                Cod34 = rsConsult!confval2
             End If
             Flog.writeline "Columna34: " & tipo34 & " concepto: " & Cod34 & " codigo: " & Cod34
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close



'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "No se encontraron los datos del cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del sueldo."
   Sueldo = 0
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
   Categoria = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Puesto"
   Puesto = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then
    StrSql = " SELECT concepto.conccod AS codigo, concepto.concabr AS descripcion, detliq.dlimonto AS valor, detliq.dlicant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    StrSql = StrSql & " INNER JOIN concepto ON detliq.concnro = concepto.concnro "
Else
    StrSql = " SELECT acumulador.acunro AS codigo, acumulador.acudesabr AS descripcion, acu_liq.almonto AS valor, acu_liq.alcant AS cantidad, cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets
    StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro "
End If
    
OpenRecordset StrSql, rsConsult

CabliqNumero = 0
Ticket = "&nbsp;"
MontoTickets = 0
CantTickets = 0

If Not rsConsult.EOF Then
    CabliqNumero = rsConsult!cliqnro
    Ticket = rsConsult!codigo & " " & rsConsult!Descripcion
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    If Not IsNull(rsConsult!Cantidad) Then
       CantTickets = CantTickets + CDbl(rsConsult!Cantidad)
    End If
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = "<b>BANCO: </b>" & rsConsult!terrazsoc & " " & rsConsult!fpagdescabr & "  <b>NRO:</b> " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>" & rs_Domicilio!codigopostal & " " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las cargas sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxdeci2, modelo)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & tipoRecibo
 
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

 

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
 
 
StrSql = " SELECT acumulador.acudesabr concabr, acumulador.acunro conccod, acumulador.acunro concnro, acumulador.tacunro tconnro,  acumulador.acuimponible concimp, "
StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro, proceso.prodesc, periodo.pliqdesc,"
StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,acu_liq.alcant dlicant, acu_liq.almonto dlimonto, 'AC' Tipo"
StrSql = StrSql & "    From cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " inner join acu_liq on acu_liq.cliqnro = cabliq.cliqnro and acu_liq.acunro = " & Cod34
StrSql = StrSql & " inner join acumulador on acu_liq.acunro = acumulador.acunro"
StrSql = StrSql & " Where cabliq.Empleado =  " & Ternro
StrSql = StrSql & " UNION "
StrSql = StrSql & " SELECT  concepto.concabr concabr, concepto.conccod conccod, concepto.concnro concnro, concepto.tconnro tconnro,  concepto.concimp concimp,"
StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro,proceso.prodesc, periodo.pliqdesc,"
StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, detliq.dlicant dlicant, detliq.dlimonto dlimonto, 'CO' Tipo"
StrSql = StrSql & "    From cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado =  " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 and concepto.tconnro = " & Cod33
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.tconnro = " & Cod33

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES "
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Coop. Seguros
'--------------------------------------------------------------------
Sub generarDatosRecibo110(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

'Modificado: 20/09/2012 - Gonzalez Nicolás - Se agregó obra social en auxchar5


Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
'Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ObraSocial 'NG --> Auxchar5

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim FRecibo As Integer

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------


StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
'StrSql = " SELECT altfec "
'StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "

StrSql = " SELECT Max(altfec) as altafecha "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altafecha
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    Flog.writeline StrSql
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult


LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener el Lugar de Pago"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 45 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'---------------------------------------------------------------
'ObraSocial
'---------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult


Flog.writeline StrSql

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Obra Social"
End If

'---------------------------------------------------------------


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Firma Recibo Confrep
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 120 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura Firma Recibo."
Else
    FRecibo = rsConsult!confval
End If
rsConsult.Close

Flog.writeline StrSql

'Firma de Recibo
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=" & FRecibo & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline StrSql

If Not rsConsult.EOF Then
   FirmaRecibo = rsConsult!estrcodext
Else
   FirmaRecibo = 2
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = " & FirmaRecibo & " AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma

Flog.writeline StrSql
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub




'--------------------------------------------------------------------
' Se encarga de generar los datos para Sykes
'--------------------------------------------------------------------
Sub generarDatosRecibo102(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer
Dim Ubicacion As String
Dim Departamento As String
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim ObraSocial
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la estructura "Ubicacion" desde el confrep
'------------------------------------------------------------------
 
'StrSql = " select estrnro,estrdabr from estructura "
'StrSql = StrSql & " where tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=33) "
'StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
'StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=33)) "
'StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " AND proceso.pronro= " & Pronro
'FB
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=33)"
StrSql = StrSql & " AND his_estructura.Ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Ubicacion = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Ubicacion"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la estructura "Departamento" desde el confrep
'------------------------------------------------------------------
 
'StrSql = " select estrnro,estrdabr from estructura "
'StrSql = StrSql & " where tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=34) "
'StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
'StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=34)) "
'FB
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=34)"
StrSql = StrSql & " AND his_estructura.Ternro = " & Ternro
        
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos del Departamento"
   'GoTo MError
End If
 
'------------------------------------------------------------------
'Busco los datos de la Forma de Pago  desde el confrep
'------------------------------------------------------------------

'StrSql = "SELECT estrdabr FROM his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.tenro = his_estructura.tenro "
'StrSql = StrSql & " AND  estructura.estrnro = his_estructura.estrnro "
'StrSql = StrSql & " WHERE his_estructura.Ternro = " & Ternro & " And his_estructura.tenro = 22"
       
StrSql = " SELECT estrnro,estrdabr FROM estructura "
StrSql = StrSql & " WHERE tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=35) "
StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=35)) "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    CodFormaPago = rsConsult!Estrnro
    FormaPago = rsConsult!estrdabr
Else
   CodFormaPago = 0
   FormaPago = ""
   Flog.writeline "Error al obtener los datos de la forma de pago"
'  GoTo MError
End If

rsConsult.Close


'-----------------------------------------------------------------
'Busco el tipo "M" desde el confrep para definir la etiqueta de la forma de pago
'-----------------------------------------------------------------
StrSql = " SELECT confetiq  FROM confrep WHERE conftipo = 'M' AND confval = " & CodFormaPago
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   EtiquetaFormaPago = rsConsult!confetiq
Else
   EtiquetaFormaPago = "Salario"
   Flog.writeline "Error al obtener los datos desde el confrep (tipo=M)"
End If

FormaPago = FormaPago & "@@" & EtiquetaFormaPago

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'FGZ - 25/08/2011 ------------
' se cambio la logica (ahora si tiene valor ==> lo recalcula sino deja el empremu
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If
'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & Ubicacion & "'"
StrSql = StrSql & ",'" & Departamento & "'"
StrSql = StrSql & "," & SalarioNeto


StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
'Descripcion: Se encarga de generar los datos para el recibo de Portugal
'Autor: Carmen Quintero
'Fecha: 01/09/2011
'Modificado: 05/03/2012 - Gonzalez Nicolás - Se modifico Localidad = Direccion POR Localidad = rsConsult!locdesc
'          : 06/03/2012 - Gonzalez Nicolás - Se volvio atrás cambio anterior y se concatenor @ entre direccion y localidad
'          : 12/03/2012 - Gonzalez Nicolás - Se modifico documento CUIT por doc tipo 43 (N° CONTRIBUINTE)
'          : 20/03/2012 - Gonzalez Nicolás - Se agrego nuevas busqueda para los AC. Confrep --> 96,97,98
'          : 26/03/2012 - Gonzalez Nicolás - Se agrego nueva busqueda para el AC/CO. Confrep --> 99 (Qtde. Goza Férias)
'          : 25/04/2012 - Gonzalez Nicolás - Se cambio tenro=2 por tenro = 3, en vez de buscar SECTOR busca CATEGORIA
'          : 23/07/2012 - Gonzalez Nicolás - Se cambio doc 43 por doc 6 de la empresa
'--------------------------------------------------------------------
Sub generarDatosRecibo111(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CantidadHoras
Dim ValorDevolver
Dim RegMesAnterior
Dim TotalBaseIrs
Dim IrsSujeto
Dim IrsRetenido

Dim auxdeci6
Dim auxdeci7
Dim auxdeci8
Dim auxdeci9

Dim QtdeFeriasAux1

auxdeci6 = 0
auxdeci7 = 0
auxdeci8 = 0
auxdeci9 = 0

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

CantidadHoras = 0
ValorDevolver = 0
RegMesAnterior = 0
TotalBaseIrs = 0
IrsSujeto = 0
IrsRetenido = 0

Flog.writeline "Empieza a procesar al empleado"
Flog.writeline "*******************************"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = "SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = "SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
   Flog.writeline "   Se obtuvieron los datos del empleado"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = "SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Flog.writeline "   Se obtuvieron los datos del periodo actual"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = "SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = "SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = "SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "   Se obtuvieron los datos del cuil"
Else
   Flog.writeline "No se encontro los datos del cuil"
End If



'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,detdom.codigopostal,partido.partnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN partido ON detdom.partnro = partido.partnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Apto. " & rsConsult!oficdepto
    End If
    
   'Direccion = Direccion & "@ " & rsConsult!locdesc
   
   ' Se obtiene el codigo postal y el partido
   'Direccion = Direccion & " CP. " & rsConsult!codigopostal & " PT. " & rsConsult!partnom
   
   'LOCDESC
   'Localidad = Direccion
   Localidad = rsConsult!locdesc & "@" & rsConsult!codigopostal & "@" & rsConsult!partnom
   
   Flog.writeline "   Se obtuvieron los datos de la direccion de la sucursal del empleado"
Else
   Flog.writeline "Error al obtener los datos de la Direccion  de la sucursal del empleado"
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la CATEGORIA
'------------------------------------------------------------------

StrSql = "SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el sector del empleado"
Else
   Flog.writeline "Error al obtener los datos del Sector"
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = "SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el puesto del empleado"
Else
   Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = "SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el centro de costo del empleado"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " CTA. " & rsConsult!ctabnro & " BNC. " & rsConsult!Bandesc
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa. No se generara el Recibo."
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If


'------------------------------------------------------------------
'Busco el nombre de la empresa ART
'------------------------------------------------------------------

StrSql = "SELECT estrdabr"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro"
StrSql = StrSql & " INNER JOIN empleado on his_estructura.ternro = empleado.ternro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 40"
StrSql = StrSql & " AND empleado.empleg = " & Legajo
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   EmpNombre = EmpNombre & " Ap. Seg." & rsConsult!estrdabr
   Flog.writeline "   Se obtuvo el ART del empleado"
Else
   Flog.writeline "Error al obtener los datos del la ART"
End If



StrSql = "SELECT estrdabr"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro"
StrSql = StrSql & " INNER JOIN empleado on his_estructura.ternro = empleado.ternro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 42"
StrSql = StrSql & " AND empleado.empleg = " & Legajo
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   EmpNombre = EmpNombre & "- " & rsConsult!estrdabr
End If



'------------------------------------------------------------------
'Consulta para obtener la direccion de la sucursal Comercial del empleado
'------------------------------------------------------------------

StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro and cabdom.tidonro=1" 'Comercial
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio

If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio comercial de la sucursal"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
   
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If


'------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
'------------------------------------------------------------------

StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro

'StrSql = " SELECT cuil.nrodoc "
'StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=6) "
'StrSql = StrSql & " WHERE tercero.ternro= " & EmpEstrnro
'StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    'Flog.writeline "No se encontró el CUIT de la Empresa"
    Flog.writeline "No se encontró el N° de contribuyente"
    EmpCuit = "  "
Else
    If Not EsNulo(rs_cuit!NroDoc) Then
        EmpCuit = rs_cuit!NroDoc
    End If
End If


'------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
'------------------------------------------------------------------

StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
'------------------------------------------------------------------

StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = "SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la cantidad de horas
'------------------------------------------------------------------

StrSql = "SELECT detliq.dlimonto "
StrSql = StrSql & " FROM detliq "
StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
StrSql = StrSql & " AND detliq.concnro = " & conCantidadHoras
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CantidadHoras = rsConsult!dlimonto
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del dato Valor a devolver
'------------------------------------------------------------------
StrSql = "SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acuValorDevolver
StrSql = StrSql & " AND cliqnro = " & cliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ValorDevolver = rsConsult!almonto
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Reg. Mes Anterior
'------------------------------------------------------------------
StrSql = "SELECT detliq.dlimonto "
StrSql = StrSql & " FROM detliq "
StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
StrSql = StrSql & " AND detliq.concnro = " & conRegMesAnterior
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    RegMesAnterior = rsConsult!dlimonto
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del dato Total Base Irs
'------------------------------------------------------------------
StrSql = "SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acuTotalBaseIrs
StrSql = StrSql & " AND cliqnro = " & cliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TotalBaseIrs = rsConsult!almonto
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del dato Irs Sujeto
'------------------------------------------------------------------
StrSql = "SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acuIrsSujeto
StrSql = StrSql & " AND cliqnro = " & cliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    IrsSujeto = rsConsult!almonto
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del dato Irs Retenido
'------------------------------------------------------------------
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acuIrsRetenido
StrSql = StrSql & " AND cliqnro = " & cliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    IrsRetenido = rsConsult!almonto
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del dato Seg. Social Acum
'------------------------------------------------------------------
If Not EsNulo(SegSocAcum) Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SegSocAcum
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        auxdeci6 = rsConsult!almonto
    End If
    rsConsult.Close
Else
    Flog.writeline "Falta configurar la columna N°96 Seg. Social Acum"
End If


'------------------------------------------------------------------
'Busco el valor del dato IRS Acumulado
'------------------------------------------------------------------
If Not EsNulo(IRSAcumulado) Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & IRSAcumulado
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        auxdeci7 = rsConsult!almonto
    End If
    rsConsult.Close
Else
    Flog.writeline "Falta configurar la columna N°97 IRS Acumulado"
End If
'------------------------------------------------------------------
'Busco el valor del dato Quota Sindical
'------------------------------------------------------------------
If Not EsNulo(QuotaSindical) Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & QuotaSindical
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        auxdeci8 = rsConsult!almonto
    End If
    rsConsult.Close
Else
    Flog.writeline "Falta configurar la columna N°98 QuotaSindical"
End If


'------------------------------------------------------------------
'Busco el valor del dato Qtde Gozo Férias
'------------------------------------------------------------------
QtdeFeriasAux1 = Split(QtdeGFerias, "@")
If QtdeFeriasAux1(0) = "AC" Then
    If Not EsNulo(QtdeFeriasAux1(1)) Then
        StrSql = " SELECT alcant"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & QtdeFeriasAux1(1)
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            auxdeci9 = rsConsult!alcant
        End If
        rsConsult.Close
    Else
        Flog.writeline "Falta configurar la columna N°99 Qtde Gozo Férias"
    End If
ElseIf QtdeFeriasAux1(0) = "CO" Then
    
    If Not EsNulo(QtdeFeriasAux1(1)) Then
        StrSql = " SELECT dlicant FROM cabliq"
        StrSql = StrSql & " INNER JOIN proceso ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo ON proceso.pliqnro = periodo.pliqnro"
        StrSql = StrSql & " INNER JOIN detliq  ON cabliq.cliqnro = detliq.cliqnro"
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro =  detliq.concnro"
        StrSql = StrSql & " WHERE cabliq.cliqnro = " & cliqnro
        StrSql = StrSql & " AND cabliq.empleado = " & Ternro
        StrSql = StrSql & " AND concepto.concnro = '" & QtdeFeriasAux1(1) & "'"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            auxdeci9 = rsConsult!dlicant
        End If
        rsConsult.Close
    Else
        Flog.writeline "Falta configurar la columna N°99 Qtde Gozo Férias"
    End If
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Guardando los datos del empleado en base........."
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar5, auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5"


'StrSql = StrSql & ",auxdeci6 , auxchar7, auxchar8"
StrSql = StrSql & ",auxdeci6 , auxdeci7, auxdeci8"
StrSql = StrSql & ",auxdeci9"

StrSql = StrSql & ")"

StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Sector, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & CantidadHoras & "'"
StrSql = StrSql & "," & ValorDevolver
StrSql = StrSql & "," & RegMesAnterior
StrSql = StrSql & "," & TotalBaseIrs
StrSql = StrSql & "," & IrsSujeto
StrSql = StrSql & "," & IrsRetenido

'StrSql = StrSql & ",'" & auxdeci6 & "'"
'StrSql = StrSql & ",'" & auxdeci7 & "'"
'StrSql = StrSql & ",'" & auxdeci8 & "'"
StrSql = StrSql & "," & auxdeci6
StrSql = StrSql & "," & auxdeci7
StrSql = StrSql & "," & auxdeci8
StrSql = StrSql & "," & auxdeci9

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop
Flog.writeline "   Se Grabo el empleado"
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'agrego modelo sebastian stremel
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Deloitte
'--------------------------------------------------------------------
Sub generarDatosRecibo114(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim StrSql1 As String
Dim StrSql2 As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult1 As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'estructura afp y sistema de salud
Dim AFP
Dim Salud

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Documento
Dim regHorario
Dim Sector
Dim DNRP
Dim Antiguedad

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun
'Dim StrSql
Dim objRs2 As New ADODB.Recordset

Dim Bandesc
Dim ctabancaria
Dim esdtrab
Dim DiasTrab

Dim NoImponible
Dim esNoImponibleConc

Dim esAfectoImpConc
Dim acunroAfectoImp

Dim esLiqApagarConc
Dim acunroLiqApagar

Dim acunroDtosPrev
Dim esDtosPrevConc

Dim TEAfp As Long
Dim TEIsapre As Long
Dim NroEscala
Dim Porc As Long
Dim ConcPorc As Long
Dim PMonto As Long
Dim ConcPMonto As Long
Dim CantidadUf As Long
Dim ConcCantidadUf As Long

Dim NConcParam1 As Double
Dim NConcParam2 As Double
Dim NConcParam3 As Double

Dim SumPorcentaje As Double
Dim Valores

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

NConcParam1 = 0
NConcParam2 = 0
NConcParam3 = 0

SumPorcentaje = 0
AFP = ""
Salud = ""

'confrep
'agrego sebastian stremel 19/09/2011
StrSql = " SELECT * FROM confrep "
'StrSql = StrSql & " WHERE repnro = 60 and (confnrocol=12 or confnrocol=10 or confnrocol=16 or confnrocol=105 or confnrocol=106 or confnrocol=107 or confnrocol=108 or confnrocol=109)"
StrSql = StrSql & " WHERE repnro = 60 and confnrocol in (10,12,16,105,106,107,108,109,110,112,113,114,115,116)"
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep"
    Exit Sub
End If

Do Until rsConsult.EOF
    Flog.writeline "Columna " & rsConsult!confnrocol
    Select Case rsConsult!confnrocol
    Case 10
        cargo = rsConsult!confval
    Case 12
        sBase = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esSueldoBase = True
        Else
            esSueldoBase = False
        End If
    Case 16
        dtrab = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esdtrab = True
        Else
            esdtrab = False
        End If
        
    Case 105
        acunroImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esImponibleConc = True
        Else
            esImponibleConc = False
        End If
    
    Case 106
        acunroNoImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esNoImponibleConc = True
        Else
            esNoImponibleConc = False
        End If
    
    Case 107
        acunroAfectoImp = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esAfectoImpConc = True
        Else
            esAfectoImpConc = False
        End If
        
    Case 108
        acunroDtosPrev = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esDtosPrevConc = True
        Else
            esDtosPrevConc = False
        End If
        
    Case 109
        acunroLiqApagar = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esLiqApagarConc = True
        Else
            esLiqApagarConc = False
        End If
        
    ' Agregadas por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
    'Inicio
    Case 110
        If rsConsult!conftipo = "TE" Then
            TEAfp = rsConsult!confval
        Else
            Flog.writeline "La columna 110 AFP debe ser un Tipo de Estructura. "
        End If
                                   
    Case 112
        If rsConsult!conftipo = "TE" Then
            TEIsapre = rsConsult!confval
        Else
            Flog.writeline "La columna 112 ISAPRE debe ser un Tipo de Estructura. "
        End If
        
    Case 113
        If rsConsult!conftipo = "NE" Then
            NroEscala = rsConsult!confval
        Else
            Flog.writeline "La columna 113 Nro de Escala debe ser un Número de Escala. "
        End If
        
    Case 114
        If rsConsult!conftipo = "NPC" Then
            Porc = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPorc = 0
            Else
              ConcPorc = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 114 Parámetro 1 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 115
        If rsConsult!conftipo = "NPC" Then
            PMonto = rsConsult!confval
        
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPMonto = 0
            Else
              ConcPMonto = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 115 Parámetro 2 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 116
        If rsConsult!conftipo = "NPC" Then
            CantidadUf = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcCantidadUf = 0
            Else
              ConcCantidadUf = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 116 Parámetro 3 debe ser un Parámetro de un Concepto. "
        End If
    'Fin
    End Select
    
    rsConsult.MoveNext
Loop
rsConsult.Close
'hasta aca


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   'Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
   Documento = rsConsult!sigladoc & "@" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regHorario = ""

If Not rsConsult.EOF Then
   regHorario = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del reg. horario"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call bus_Anti0(ternro, pliqanio, pliqmes, dia, mes, Anio)

Call antigfec(Ternro, pliqanio, pliqmes, Dia, Mes, Anio)

Antiguedad = " A&ntilde;os&nbsp;" & Anio & "&nbsp;Meses&nbsp;" & Mes & "&nbsp;D&iacute;as&nbsp;" & Dia

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'busco el valor del sueldo base
'------------------------------------------------------------------
If esSueldoBase Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       StrSql = " select * from concepto where conccod=" & sBase 'cambio sebastian stremel
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        sBase = rsConsult2!ConcNro
       End If
       rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & sBase
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        Sueldo = rsConsult2!dlimonto
       Else
        Sueldo = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
Else
    Sueldo = 0
End If
Sueldo = Replace(Sueldo, ",", ".")
rsConsult2.Close

'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco el valor del Total Imponible
'------------------------------------------------------------------
If acunroImponible <> 0 And Not IsNull(acunroImponible) Then
    If esImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Imponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Imponible."
       Imponible = 0
    End If
Else
    Imponible = 0
End If
Imponible = Replace(Imponible, ",", ".")


'------------------------------------------------------------------
'Busco el valor del Total No Imponible
'------------------------------------------------------------------
If acunroNoImponible <> 0 And Not IsNull(acunroNoImponible) Then
    If esNoImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroNoImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroNoImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroNoImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroNoImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       NoImponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total No Imponible."
       NoImponible = 0
    End If
Else
    NoImponible = 0
End If
NoImponible = Replace(NoImponible, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total afecto a impuesto
'------------------------------------------------------------------
If acunroAfectoImp <> 0 And Not IsNull(acunroAfectoImp) Then
    If esAfectoImpConc Then
        StrSql = " select * from concepto where conccod=" & acunroAfectoImp 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroAfectoImp = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroAfectoImp 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroAfectoImp
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       afectoImp = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total afecto a impuesto."
       afectoImp = 0
    End If
Else
    afectoImp = 0
End If
'afectoImp = Replace(afectoImp, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de descuentos previsionales
'------------------------------------------------------------------
If acunroDtosPrev <> 0 And Not IsNull(acunroDtosPrev) Then
    If esDtosPrevConc Then
        StrSql = " select * from concepto where conccod=" & acunroDtosPrev 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroDtosPrev = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroDtosPrev
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroDtosPrev
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       dtosPrev = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       dtosPrev = 0
    End If
Else
    dtosPrev = 0
End If
dtosPrev = Replace(dtosPrev, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de liquido a pagar
'------------------------------------------------------------------
If acunroLiqApagar <> 0 And Not IsNull(acunroLiqApagar) Then
    If esLiqApagarConc Then
        StrSql = " select * from concepto where conccod=" & acunroLiqApagar 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroLiqApagar = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroLiqApagar
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroLiqApagar
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       liqApagar = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       liqApagar = 0
    End If
Else
    liqApagar = 0
End If
liqApagar = Replace(liqApagar, ",", ".")


'------------------------------------------------------------------
'busco los dias trabajados
'------------------------------------------------------------------
If esdtrab Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        StrSql = " select * from concepto where conccod=" & dtrab 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            dtrab = rsConsult2!ConcNro
        End If
        rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & dtrab
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
        DiasTrab = rsConsult!dlimonto
       Else
        DiasTrab = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos de los dias trabajados"
       DiasTrab = 0
       'GoTo MError
    End If
 Else
       StrSql = " SELECT almonto valor"
       StrSql = StrSql & " From acu_liq"
       StrSql = StrSql & " Where acunro = " & dtrab
       StrSql = StrSql & " AND cliqnro = " & cliqnro
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
            dtrab = rsConsult!Valor
       Else
            Flog.writeline "Error al obtener los datos de los dias trabajados"
            DiasTrab = 0
       End If
    
End If

'------------------------------------------------------------------


'------------------------------------------------------------------
' busco el banco y las cuentas
'------------------------------------------------------------------
    StrSql = "SELECT DISTINCT fpagnro from pedidopago "
    StrSql = StrSql & " where pliqnro= " & pliqnro
    OpenRecordset StrSql, rsConsult
    FormaPago = ""
    Do While Not rsConsult.EOF
        StrSql1 = " select top 2 * from ctabancaria "
        StrSql1 = StrSql1 & " Where fpagnro =" & rsConsult!fpagnro & ""
        StrSql1 = StrSql1 & " and ctabestado=-1 and ternro=" & Ternro
        OpenRecordset StrSql1, rsConsult1
        Do While Not rsConsult1.EOF
            ctabancaria = rsConsult1!ctabnro
            StrSql2 = "select * from banco where ternro=" & rsConsult1!Banco
            OpenRecordset StrSql2, rsConsult2
            Bandesc = rsConsult2!Bandesc
            rsConsult1.MoveNext
            FormaPago = FormaPago & Bandesc & "@" & ctabancaria & "@"
        Loop
  
   rsConsult.MoveNext
   Loop

'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del subtotal remunerativo
'------------------------------------------------------------------

StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumSubTotalRemun
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   subTotalRemun = rsConsult!almonto
Else
   Flog.writeline "No se encontro el subtotal remunerativo"
   subTotalRemun = 0
   'GoTo MError
End If
subTotalRemun = Replace(subTotalRemun, ",", ".")

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & cargo & "  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   If Puesto = "" Then
    Puesto = "No Definido"
   End If
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
'End If

'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 1)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro=30) "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!Ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   DNRP = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Agregado por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
'Inicio
Flog.writeline "Busco el nombre de la estructura AFP a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura AFP a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   AFP = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura AFP"
End If
rsConsult.Close

Flog.writeline "Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEIsapre & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Salud = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura Sistema de Salud"
End If
rsConsult.Close

Flog.writeline "Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep"
'------------------------------------------------------------------
'Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep
'------------------------------------------------------------------

StrSql = "SELECT sum(vgrvalor)suma"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
StrSql = StrSql & " INNER JOIN valgrilla ON valgrilla.vgrcoor_1 = estructura.estrnro"
StrSql = StrSql & " WHERE cgrnro = " & NroEscala
StrSql = StrSql & " AND vgrorden in (1,2)"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!suma) Then
        SumPorcentaje = rsConsult!suma
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 1 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parámetro 1 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPorc
StrSql = StrSql & " AND tpanro= " & Porc
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam1 = rsConsult!nevalor
        End If
    Else
        NConcParam1 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 2 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 2 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPMonto
StrSql = StrSql & " AND tpanro= " & PMonto
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam2 = rsConsult!nevalor
        End If
    Else
       NConcParam2 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 3 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 3 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcCantidadUf
StrSql = StrSql & " AND tpanro= " & CantidadUf
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam3 = rsConsult!nevalor
        End If
    Else
        NConcParam3 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Valores = Valores & AFP & "@" & SumPorcentaje & "@" & Salud & "@" & NConcParam3 & "@" & NConcParam1 & "@" & NConcParam2 & "@"

'Fin
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar3, auxchar4, auxchar5, auxdeci1,auxchar1,auxdeci2,auxdeci3,auxdeci4,auxdeci5,auxchar,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(AFP, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Salud, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & "," & numberForSQL(subTotalRemun)
StrSql = StrSql & ",'" & DiasTrab & "'"
StrSql = StrSql & "," & Imponible
StrSql = StrSql & "," & NoImponible
StrSql = StrSql & "," & afectoImp
StrSql = StrSql & "," & dtosPrev
StrSql = StrSql & ",'" & liqApagar & "'"
StrSql = StrSql & ",'" & Valores & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar el recibo Mensual y de Vacaciones para APEX S.A Paraguay
'--------------------------------------------------------------------
Sub generarDatosRecibo115(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta
Dim DiasTrabajados
Dim SalarioDiario

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer
Dim Ubicacion As String
Dim Departamento As String
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
Dim Sum_Vacaciones As Long
Dim ColumnasConfrep As String
Dim tidnroMJT As String
Dim ternroEmpresa As String
Dim nroMJT As String
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim ObraSocial
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

 
 
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If
 
'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
 
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
 

 


'-----------------------------------------------------------------
'Busco el tipo "VAC" desde el confrep para definir el valor de las vacaciones
'-----------------------------------------------------------------
'Flog.writeline "Busco el tipo VAC desde el confrep para definir el valor de las vacaciones"
'StrSql = " SELECT sum(dlimonto) Vacaciones"
'StrSql = StrSql & " FROM cabliq "
'StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
'StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'StrSql = StrSql & " WHERE  concepto.conccod IN (SELECT confetiq  FROM confrep WHERE repnro = 60 AND  conftipo = 'VAC') "
''StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'OpenRecordset StrSql, rsConsult
'
'Sum_Vacaciones = 0
'
'If Not rsConsult.EOF Then
'   If Not IsNull(rsConsult!Vacaciones) Then
'      Sum_Vacaciones = rsConsult!Vacaciones
'   End If
'Else
' Flog.writeline " No hay ninguna entrada en el confrep con el tipo = VAC"
'End If

'rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los días trabajados
'------------------------------------------------------------------
Flog.writeline "Busco el valor de los días trabajados"
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
Else
    DiasTrabajados = 0
End If

'------------------------------------------------------------------
'Busco el valor del Salario Diario
'------------------------------------------------------------------
Flog.writeline "Busco el valor del Salario Diario"
If ConcSalarioDiario <> "" And Not IsNull(ConcSalarioDiario) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcSalarioDiario & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       SalarioDiario = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener Salario Diario."
       SalarioDiario = 0
    End If
Else
    SalarioDiario = 0
End If
  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline "Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    ternroEmpresa = rs_estructura!Ternro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para obtener tipo de documento configurado en el confrep
StrSql = "SELECT confval FROM confrep WHERE repnro = 60 AND confnrocol = 41 "
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encuentra configurado el tipo de documento MJT (columna 41) en el reporte"
    'Exit Sub
    tidnroMJT = 0
Else
    tidnroMJT = rs_cuit!confval
End If


'Consulta para obtener el mjt de la empresa
StrSql = "SELECT nrodoc FROM ter_doc  " & _
         " Where ter_doc.ternro =" & ternroEmpresa & " and tidnro = " & tidnroMJT
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MJT de la Empresa"
    'Exit Sub
    nroMJT = "  "
Else
    nroMJT = rs_cuit!NroDoc
End If



'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
 

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,"
StrSql = StrSql & " empfecalta,"
StrSql = StrSql & " sueldo,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,prodesc,descripcion, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxdeci1,auxchar1, auxchar2, auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
'StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
'StrSql = StrSql & ",'" & pliqdepant & "'"
'StrSql = StrSql & ",'" & pliqfecdep & "'"
'StrSql = StrSql & ",'" & pliqbco & "'"
'StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
'StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
'StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
'StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
'StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
'StrSql = StrSql & ",'" & ObraSocial & "'"
'StrSql = StrSql & ",'" & Banco & "'"
'StrSql = StrSql & ",'" & nroCuenta & "'"
'StrSql = StrSql & ",'" & Ubicacion & "'"
'StrSql = StrSql & "," & Sum_Vacaciones
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ", '" & DiasTrabajados & "'"
StrSql = StrSql & ", '" & SalarioDiario & "'"
StrSql = StrSql & ", '" & nroMJT & "'"


StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"

'Armo parte de la consulta que recupera los Conceptos/Acumuladores que se deberán imprimir (Desde el confrep)
ColumnasConfrep = "Select confval2 from confrep Where confnrocol in (100,101,102,103,104,130,131,132) and repnro = 60"
    
  StrSql = " SELECT acumulador.acudesabr concabr, acumulador.acunro conccod, acumulador.acunro concnro, "
  StrSql = StrSql & " acumulador.tacunro tconnro,  acumulador.acuimponible concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro, proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,acu_liq.alcant dlicant, acu_liq.almonto dlimonto, 'AC' Tipo "
  StrSql = StrSql & "     From cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " inner join acu_liq on acu_liq.cliqnro = cabliq.cliqnro "
  StrSql = StrSql & " inner join acumulador on acu_liq.acunro = acumulador.acunro AND acumulador.acunro IN (" & ColumnasConfrep & ") "
  StrSql = StrSql & " where  cabliq.empleado =  " & Ternro
  StrSql = StrSql & " UNION "
  StrSql = StrSql & " SELECT  concepto.concabr concabr, concepto.conccod conccod, concepto.concnro concnro, concepto.tconnro "
  StrSql = StrSql & " tconnro,  concepto.concimp concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro,proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, detliq.dlicant dlicant, detliq.dlimonto dlimonto, 'CO' Tipo "
  StrSql = StrSql & "   From cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro AND cabliq.empleado =  " & Ternro
  StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro   AND concepto.conccod IN (" & ColumnasConfrep & ") "
  StrSql = StrSql & " WHERE  cabliq.empleado=  " & Ternro
 
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar el recibo final por termino de contrato para APEX S.A Paraguay
'--------------------------------------------------------------------
Sub generarDatosRecibo116(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta
Dim DiasTrabajados
Dim SalarioDiario
Dim empFecBaja
Dim Documento
 

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer
Dim Ubicacion As String
Dim Departamento As String
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
Dim Sum_Vacaciones As Long
Dim ColumnasConfrep As String
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim ObraSocial
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

 
 
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If
 
'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
 
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
 

 


'-----------------------------------------------------------------
'Busco el tipo "VAC" desde el confrep para definir el valor de las vacaciones
'-----------------------------------------------------------------
'Flog.writeline "Busco el tipo VAC desde el confrep para definir el valor de las vacaciones"
'StrSql = " SELECT sum(dlimonto) Vacaciones"
'StrSql = StrSql & " FROM cabliq "
'StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
'StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'StrSql = StrSql & " WHERE  concepto.conccod IN (SELECT confetiq  FROM confrep WHERE repnro = 60 AND  conftipo = 'VAC') "
''StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'OpenRecordset StrSql, rsConsult
'
'Sum_Vacaciones = 0
'
'If Not rsConsult.EOF Then
'   If Not IsNull(rsConsult!Vacaciones) Then
'      Sum_Vacaciones = rsConsult!Vacaciones
'   End If
'Else
' Flog.writeline " No hay ninguna entrada en el confrep con el tipo = VAC"
'End If

'rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los días trabajados
'------------------------------------------------------------------
Flog.writeline "Busco el valor de los días trabajados"
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
Else
    DiasTrabajados = 0
End If

'------------------------------------------------------------------
'Busco el valor del Salario Diario
'------------------------------------------------------------------
Flog.writeline "Busco el valor del Salario Diario"
If ConcSalarioDiario <> "" And Not IsNull(ConcSalarioDiario) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcSalarioDiario & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       SalarioDiario = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener Salario Diario."
       SalarioDiario = 0
    End If
Else
    SalarioDiario = 0
End If
  
  
'------------------------------------------------------------------
'Busco la fecha de alta y baja del empleado
'------------------------------------------------------------------
Flog.writeline "Busco la fecha de alta y baja del empleado desde sus fases"
empFecAlta = ""
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      empFecAlta = rsConsult!altfec
   End If
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If
  
 
 
'------------------------------------------------------------------
'Busco el salario hora extra
'------------------------------------------------------------------
Flog.writeline "Busco el Salario hora extra"
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumNetoImp
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!altfec) Then
      empFecAlta = rsConsult!altfec
   End If
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If
   
 
'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<=5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & " N° " & rsConsult!NroDoc
End If

rsConsult.Close
 
 
 
 
  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline "Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
 

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,"
StrSql = StrSql & " empfecalta,"
StrSql = StrSql & " sueldo,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,prodesc,descripcion, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxdeci1,auxchar1, auxchar2, auxchar3, auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
'StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
'StrSql = StrSql & ",'" & pliqdepant & "'"
'StrSql = StrSql & ",'" & pliqfecdep & "'"
'StrSql = StrSql & ",'" & pliqbco & "'"
'StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
'StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
'StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
'StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
'StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
'StrSql = StrSql & ",'" & ObraSocial & "'"
'StrSql = StrSql & ",'" & Banco & "'"
'StrSql = StrSql & ",'" & nroCuenta & "'"
'StrSql = StrSql & ",'" & Ubicacion & "'"
'StrSql = StrSql & "," & Sum_Vacaciones
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ", '" & empFecAlta & "'"
StrSql = StrSql & ", '" & SalarioDiario & "'"
StrSql = StrSql & ", '" & empFecBaja & "'"
StrSql = StrSql & ", '" & Documento & "'"
 
 


StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"

'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'StrSql = StrSql & " FROM cabliq "
'StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
'StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
    
'Armo parte de la consulta que recupera los Conceptos/Acumuladores que se deberán imprimir (Desde el confrep)
ColumnasConfrep = "Select confval2 from confrep Where confnrocol in (150,151,152,153,154,160,161,162) and repnro = 60"
    
 
 StrSql = " SELECT acumulador.acudesabr concabr, acumulador.acunro conccod, acumulador.acunro concnro, "
  StrSql = StrSql & " acumulador.tacunro tconnro,  acumulador.acuimponible concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro, proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,acu_liq.alcant dlicant, acu_liq.almonto dlimonto, 'AC' Tipo "
  StrSql = StrSql & "     From cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " inner join acu_liq on acu_liq.cliqnro = cabliq.cliqnro "
  StrSql = StrSql & " inner join acumulador on acu_liq.acunro = acumulador.acunro "
  'StrSql = StrSql & "  AND acumulador.acunro IN (" & ColumnasConfrep & ") "
  StrSql = StrSql & " where  cabliq.empleado =  " & Ternro
  StrSql = StrSql & " Union "
  StrSql = StrSql & " SELECT  concepto.concabr concabr, concepto.conccod conccod, concepto.concnro concnro, concepto.tconnro "
  StrSql = StrSql & " tconnro,  concepto.concimp concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro,proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, detliq.dlicant dlicant, detliq.dlimonto dlimonto, 'CO' Tipo "
  StrSql = StrSql & "   From cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro AND cabliq.empleado =  " & Ternro
  StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro   "
  'StrSql = StrSql & "  AND concepto.conccod IN (" & ColumnasConfrep & ") "
  StrSql = StrSql & " WHERE  cabliq.empleado=  " & Ternro
    
 '   Flog.writeline "ACOMULADORES Y CONCEPTOS: " & StrSql
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo117(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de Cardif
'Fecha Creacion: 29-11-2011
'Autor: Fernando Favre
' Se utilizo el modelo 71 como base, modificando el convenio y el departamento
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim Banco As String



Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim Departamento

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 117."

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
'   Flog.writeline "Datos del empleado obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del domicilio del empleado
'------------------------------------------------------------------
StrSql = " SELECT * From cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE domdefault =-1 and ternro= " & Ternro

Flog.writeline "Buscando el domicilio del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error el empleado no tiene un domicilio marcado como principal"
   Direccion = ""
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
'    Flog.writeline "Datos del periodo de liquidacion obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
'   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del centro de costo"
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
'    Flog.writeline "Datos del centro de costo obtenido"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro de Costo."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos Departamento"
OpenRecordset StrSql, rsConsult

Departamento = "&nbsp;"
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
'   Flog.writeline "Datos de Departamento obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de Departamento."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Convenio"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
'   Flog.writeline "Datos del Convenio obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Puesto"
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
'    Flog.writeline "Datos del Puesto obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la Obra Social"
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
'    Flog.writeline "Datos de la Obra Social obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Contrato"
OpenRecordset StrSql, rsConsult

Contrato = "&nbsp;"
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
'    Flog.writeline "Datos del Contrato obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Sueldo Basico. Verificar la columna 1 del confrep"
   Sueldo = 0
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
    empFecAltaRec = ""
    'GoTo MError
End If
If empFecAltaRec = "" Then
    'El empleado no tiene fecha de alta reconocida, por lo que busco la fecha desde
    'de la primera de sus fases
    rsConsult.Close
    StrSql = " SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "Error al obtener la Fecha de Alta de la primer fase del Empleado"
        empFecAltaRec = ""
        'GoTo MError
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
'StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para PKF
'--------------------------------------------------------------------
Sub generarDatosRecibo118(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_digitos_legajo As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If


'Consulta para modificar la cantidad de digitos que se mostraran del legajo
StrSql = "select nrocod from estr_cod"
StrSql = StrSql & " Where tcodnro = 158 And Estrnro = " & EmpEstrnro
OpenRecordset StrSql, rs_digitos_legajo

If (Not rs_estructura.EOF) Then
  If (IsNumeric(rs_digitos_legajo!nrocod)) Then
    Legajo = Right(Legajo, rs_digitos_legajo!nrocod)
  End If
Else
  Flog.writeline "La cantidad de digitos del legajo tiene que ser un entero"
End If


'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Medicus a partir del 21-12-2011
'--------------------------------------------------------------------
Sub generarDatosRecibo119(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'24/05/2012 - Gonzalez Nicolás - Se toma como válida de la tabla empleado la fecha de ingreso de un empleado.
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim diasHab_aux As Integer

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim estrConvenio1 As Integer
Dim estrConvenio2 As Integer
Dim acumulador As Long


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 119"

'---------------------------------------------------------------------------------------
'Busco los datos de las estructuras y el acumulador asociado para calcular la antiguedad
'---------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 117 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    estrConvenio1 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio1 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio1 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    End If
End If
rsConsult.Close

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 118 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    estrConvenio2 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio2 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio2 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'empFecAlta = rsConsult!altfec NG - 24/05/2012
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    'empFecAlta = " " NG - 24/05/2012
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------------------------------------------------
' Calculo la antiguedad si el empleado no tiene las estructuras configuradas en el confrep,
' se calcula segun el alta, sino mediante el acumulador configurado
'------------------------------------------------------------------------------------------------------------
Antiguedad = 0

Flog.writeline "Chequeo que el empleado tenga al menos una de las 2 estructuras configuradas en el confrep"
StrSql = " SELECT estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " WHERE  ( htetdesde <= " & ConvFecha(pliqdesde) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqdesde) & ") "
StrSql = StrSql & " OR htetdesde >= " & ConvFecha(pliqdesde) & " And (htetdesde <= " & ConvFecha(pliqhasta) & "))"
StrSql = StrSql & " And tenro = 19  and ternro = " & Ternro & " And (estrnro = " & estrConvenio1 & " or estrnro = " & estrConvenio2 & ") "

       
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "Calculo la antiguedad, por medio de la fase, el empleado no tiene estructuras configuradas en confrep"
    Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
    Fecha_aux = DateAdd("m", 1, Fecha_aux)
    Fecha_aux = DateAdd("d", -1, Fecha_aux)
    
    If Fecha_aux < empFecAlta Then
        Antiguedad = "0 año/s 0 mes/ses"
    Else
        Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
        Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
    End If
Else
    Flog.writeline "Calculo la antiguedad, por medio del acumulador configurado en confrep"
    'StrSql = " SELECT sum(acu_liq.almonto) monto "
    'StrSql = StrSql & " FROM periodo "
    'StrSql = StrSql & " INNER JOIN proceso ON periodo.pliqnro = proceso.pliqnro " ' and pronro = " & Pronro
    'StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro"
    'StrSql = StrSql & " INNER JOIN acu_liq ON cabliq.cliqnro = acu_liq.cliqnro"
    'StrSql = StrSql & " WHERE cabliq.Empleado = " & Ternro
    'StrSql = StrSql & " AND periodo.pliqmes <= " & pliqmes
    'StrSql = StrSql & " AND periodo.pliqanio <= " & pliqanio
    'StrSql = StrSql & " AND acu_liq.acunro = " & acumulador
    StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
    StrSql = StrSql & " WHERE amanio < " & pliqanio
    StrSql = StrSql & " AND acunro = " & acumulador
    StrSql = StrSql & " AND ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    totalParcialAntiguedad = 0
    If Not rsConsult.EOF Then
       If EsNulo(rsConsult!Monto) Then
           totalParcialAntiguedad = 0
       Else
           totalParcialAntiguedad = CDbl(rsConsult!Monto)
       End If
       
       StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
       StrSql = StrSql & " WHERE amanio = " & pliqanio
       StrSql = StrSql & " AND ammes <= " & pliqmes
       StrSql = StrSql & " AND acunro = " & acumulador
       StrSql = StrSql & " AND ternro = " & Ternro
       OpenRecordset StrSql, rs_aux
       If Not rs_aux.EOF Then
           If Not EsNulo(rs_aux!Monto) Then
               totalParcialAntiguedad = CDbl(totalParcialAntiguedad) + CDbl(rs_aux!Monto)
           End If
       End If
       Antiguedad = CStr(totalParcialAntiguedad) & " Días"
    Else
    '   Flog.writeline "Error al obtener los datos del cuil"
    '   GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Kraft (Uruguay)
'--------------------------------------------------------------------
Sub generarDatosRecibo120(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTicketBruto As Double
Dim MontoTicketNeto As Double
Dim ModeloLiq
Dim ImpIRPF
Dim ImpDescuentoIRPF
Dim SeguroVida

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
 
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim GrupoActividad As Double
Dim SubGrupoActividad As Double

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim grado

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

 '------------------------------------------------------------------------------'
'  Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS  '
'------------------------------------------------------------------------------'
Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close
 

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura BSE (col 113)."
Else
    If rsConsult!conftipo = "TE" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    cliqnro = rsConsult!cliqnro
    proFecPago = rsConsult!proFecPago
    profecini = rsConsult!profecini
    proDesc = rsConsult!proDesc
Else
    Flog.writeline "Error al obtener los datos del proceso"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    empFecAlta = rsConsult!empfaltagr
    ' el sueldo se saca del concepto 01000
    Sueldo = 0
    'If IsNull(rsConsult!empremu) Then
    '   Sueldo = 0
    'Else
    '   Sueldo = rsConsult!empremu
    'End If
Else
    Flog.writeline "Error al obtener los datos del empleado"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
Else
    Flog.writeline "Error al obtener los datos del periodo actual"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro = 1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Cuil = " "
    Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
    Localidad = Direccion
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsNeto <> "" And Not IsNull(TicketsNeto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsNeto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketNeto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketNeto = 0
    End If
Else
    MontoTicketNeto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsBruto <> "" And Not IsNull(TicketsBruto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsBruto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketBruto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketBruto = 0
    End If
Else
    MontoTicketBruto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para IRPF
'------------------------------------------------------------------
If ConcImpIRPF <> "" And Not IsNull(ConcImpIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para IRPF."
        ImpIRPF = 0
    End If
Else
    ImpIRPF = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para Descuento de IRPF
'------------------------------------------------------------------
If ConcImpDescuentoIRPF <> "" And Not IsNull(ConcImpDescuentoIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpDescuentoIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpDescuentoIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para Descuento de IRPF."
        ImpDescuentoIRPF = 0
    End If
Else
    ImpDescuentoIRPF = 0
End If

'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
Sueldo = 0

If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
    Sueldo = 0
    'GoTo MError
End If



'------------------------------------------------------------------------------'
'  Buscar la configuracion del confrep, para el concepto Seguro de Vida  '
'------------------------------------------------------------------------------'
Flog.writeline "Obtengo los datos del confrep para recuperar el cod. del concepto del Seguro de Vida."
SeguroVida = 0

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 211 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el concepto asociado al Seguro de Vida (col 211)."
Else
      If (rsConsult!conftipo = "CO") Then
         StrSql = " SELECT detliq.dlimonto valor "
         StrSql = StrSql & " FROM detliq "
         StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
         StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & rsConsult!confval
         rsConsult.Close
             
         OpenRecordset StrSql, rsConsult
            
         If Not rsConsult.EOF Then
            SeguroVida = rsConsult!Valor
         End If
   
    Else
        Flog.writeline " El Tipo de Columna 211 del confrep no es:Concepto (CO)."
    End If
    
    SeguroVida = Replace(Replace(FormatNumber(SeguroVida, 2), ",", ""), ".", "")
    SeguroVida = Left(SeguroVida, Len(SeguroVida) - 2) & "." & Right(SeguroVida, 2)
End If
rsConsult.Close




'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación
'------------------------------------------------------------------
ModeloLiq = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ModeloLiq = rsConsult!tprocdesc
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------
CentroCosto = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la cuenta bancaria del empleado
'------------------------------------------------------------------
FormaPago = " "
StrSql = " SELECT formapago.fpagdescabr FROM ctabancaria " & _
         " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro " & _
         " WHERE ctabancaria.Ternro = " & Ternro & " AND ctabestado = -1 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
        FormaPago = "IMPORTE DEPOSITADO EN SU " & rsConsult!fpagdescabr
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
EmpEstrnro = 0
EmpNombre = " "

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, paisdesc  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " left JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " WHERE cabdom.tidonro = 1 " & _
    " ORDER BY domdefault "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio tipo 1 de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
 

' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el BSE del empleado
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = " SELECT his_estructura.estrnro, estrdabr, estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro= " & CodBSE & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el BSE"
    EmpBSE = " "
Else
    Flog.writeline "BSE = " & rsConsult!Estrnro & " " & rsConsult!estrdabr & "COD Externo " & rsConsult!estrcodext
    EmpBSE = IIf(EsNulo(rsConsult!estrcodext), " ", rsConsult!estrcodext)
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Grupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del grupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 38)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        GrupoActividad = 0
    Else
        GrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del Grupo de actividad "
    GrupoActividad = 0
End If

'------------------------------------------------------------------
'Busco el valor del Subgrupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del Subgrupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 39)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        SubGrupoActividad = 0
    Else
        SubGrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del SubGrupo de actividad "
    SubGrupoActividad = 0
End If


'***************************************************
'******************** Grado ************************
'***************************************************
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=46 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   grado = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Grado"
End If
rsConsult.Close

'***************************************************




'-----------------------------------------------------------------------------------------


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxchar6 "
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & ImpIRPF & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & SeguroVida
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ",'" & grado & "'"
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de OSDOP
'--------------------------------------------------------------------
Sub generarDatosRecibo121(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim nroCuenta
Dim Banco
Dim reportaa
Dim empreporta
'Dim CentroCosto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC"
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco el valor del Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del centro de costo"
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
'    Flog.writeline "Datos del centro de costo obtenido"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro de Costo."
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener el Lugar de Pago"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr
        Banco = rsConsult!terrazsoc
        nroCuenta = rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
        Banco = ""
        nroCuenta = ""
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close



' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Firma de Recibo
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=52 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   FirmaRecibo = rsConsult!estrcodext
Else
   FirmaRecibo = 2
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = " & FirmaRecibo & " AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Mimo Vestiditos
'--------------------------------------------------------------------
Sub generarDatosRecibo122(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim telefono

'Busquedas
Dim Contrato
Dim Antiguedad
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset
Dim t
Dim seccion
Dim calle

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline "v  Basico" & StrSql
 
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = 0
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 2"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
 OpenRecordset StrSql, rsConsult2
 If Not rsConsult2.EOF Then
       Datos = rsConsult2!estrdabr
 End If
        
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,telefono.telnro,detdom.codigopostal,pais.paisdesc,cpa, provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " "
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=10 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = empresa.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN Telefono ON detdom.domnro=telefono.domnro"
StrSql = StrSql & " INNER JOIN pais ON pais.paisnro=localidad.paisnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=localidad.provnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult
Direccion = ""
If rsConsult.EOF Then
    Flog.writeline "Error al obtener los datos de la localidad"
End If
t = 1
Do While Not rsConsult.EOF
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If t < 4 Then
        If EsNulo(tel) Then
            tel = "Tel: " & rsConsult!telnro
        Else
            tel = tel & " / " & rsConsult!telnro
            t = t + 1
        End If
    End If
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc & " "
    'tel = "Tel:" & rsConsult!telnro
    Localidad = rsConsult!cpa & "-" & rsConsult!locdesc & "-" & rsConsult!paisdesc
    Flog.writeline "Direccion" & Direccion
    Flog.writeline Localidad
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

  If esSueldoConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & acunroSueldo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

Flog.writeline "Basico" & StrSql

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
'    OpenRecordset StrSql, rsConsult

    Flog.writeline "Sueldo Basico" & StrSql
StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro

    If Not rsConsult.EOF Then
        Sueldo = rsConsult!Valor
        Flog.writeline Sueldo
        Flog.writeline StrSql
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
 Flog.writeline "Basico" & StrSql & Sueldo
 

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If

'------------------------------------------------------------------
'Busco el valor del Contratacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 45 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

'------------------------------------------------------------------
'Calcula la direccion del empleado
'------------------------------------------------------------------
StrSql = " SELECT calle,nro,provdesc,locdesc FROM empleado "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro=empleado.ternro "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro=cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON localidad.locnro=detdom.locnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=provincia.provnro "
StrSql = StrSql & " WHERE empleado.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    calle = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!locdesc) Then
          calle = calle & " " & rsConsult!locdesc
    End If
    If Not EsNulo(rsConsult!provdesc) Then
        'calle = calle & " " & rsConsult!provdesc
    End If
Else
    Flog.writeline "No se encontro la direccion del empleado"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
    Flog.writeline "Obra social:" & ObraSocial
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Sueldo Bruto
'StrSql = " SELECT almonto"
'StrSql = StrSql & " From acu_liq"
'StrSql = StrSql & " Where acunro = " & ValNetoTalon
'StrSql = StrSql & " AND cliqnro = " & cliqnro
'OpenRecordset StrSql, rsConsult

'Flog.writeline StrSql

  If esGratificacionConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & Gratificacion & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & Gratificacion & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ValorAcumSueldoBruto = rsConsult!Valor
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto" & ValorAcumSueldoBruto
Else
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto"
   Flog.writeline StrSql
   ValorAcumSueldoBruto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0

If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        Flog.writeline StrSql
        Flog.writeline rsConsult2!ConcNro
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,auxdeci3,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1 "
StrSql = StrSql & " , auxdeci4, auxdeci5, auxchar6"
StrSql = StrSql & " )"

StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro
StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & calle & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
'If tel = "" Then
'    StrSql = StrSql & " ," & 0
'Else
'    StrSql = StrSql & " ," & tel
'End If
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & " ,'" & Mid(valorAntig, 1, 25) & "'" 'CentroCosto
StrSql = StrSql & " ,'" & CentroCosto
StrSql = StrSql & "' ,'" & Mid(Direccion, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"

StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
'StrSql = StrSql & " ,'" & tel & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Sector & "'"
StrSql = StrSql & " ,'" & Contrato & "'"
StrSql = StrSql & " ," & NetoTalon

StrSql = StrSql & " ," & ValorAcumSueldoBruto
StrSql = StrSql & " ," & FuturosAumentos
StrSql = StrSql & " ,'" & Antiguedad & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    'Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Previsora
'--------------------------------------------------------------------
Sub generarDatosRecibo123(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Sucursal
Dim TareaDesempena
Dim Antiguedad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If



'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If


'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la sucursal
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Sucursal, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Clinica San Camilo 24-05-2012
'--------------------------------------------------------------------
Sub generarDatosRecibo124(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim NroSucursal

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If



'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   'Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Busco los datos de la forma de pago"
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
'Flog.writeline StrSql
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
''   GoTo MError
'End If
'
'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma

Flog.writeline StrSql

If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la sucursal
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
    NroSucursal = rsConsult!Estrnro
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        If rsConsult!fpagnro = 10 Then
            nroCuenta = "CTA" & " " & rsConsult!ctabnro
        Else
        If rsConsult!fpagnro = 9 Or rsConsult!fpagnro = 12 Then
            nroCuenta = "Efectivo o Cheque" & " "
        Else
            nroCuenta = "0"
        End If
        End If
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
Else
        nroCuenta = "0"
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

Flog.writeline StrSql

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & l_formapago & "'"
StrSql = StrSql & "," & NroSucursal
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Paradigma 26-06-2012 (basado en el modelo de clinica San Camilo {124})
'--------------------------------------------------------------------
Sub generarDatosRecibo125(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim regimenHor
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim l_formapago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim NroSucursal
Dim Modelo As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Modelo = Trim(rsConsult!tprocdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If



'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   'Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma

Flog.writeline StrSql

If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la sucursal
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
    NroSucursal = rsConsult!Estrnro
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        If rsConsult!fpagnro = 10 Then
            nroCuenta = "CTA" & " " & rsConsult!ctabnro
        Else
        If rsConsult!fpagnro = 9 Or rsConsult!fpagnro = 12 Then
            nroCuenta = "Efectivo o Cheque" & " "
        Else
            nroCuenta = "0"
        End If
        End If
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
Else
        nroCuenta = "0"
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

Flog.writeline StrSql

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2,"
StrSql = StrSql & " auxchar3, auxchar4, auxchar5, auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & regimenHor & "'" 'nroCuenta
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & l_formapago & "'"
StrSql = StrSql & "," & NroSucursal
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo126(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'--------------------------------------------------------------------
' Boleta de Pago - Perú
'--------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim NroDoc

'Fechas de fases
Dim empFecAlta
Dim empFecBaja
'---------------

Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer

'Auxchar
Dim Estructuracargo As String
Dim EstructuraAFP As String

'Dim Ubicacion As String
'-----
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
 
'Auxdeci
Dim HrsTrabajadas
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
'Dim ObraSocial
Dim CarnetAFP

Dim EstructuraUbicacion
Dim EstructuraSede
Dim EstructuraCCosto
Dim EstructuraArea

Dim periodo_vac_desde As String
Dim periodo_vac_hasta As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valorSueldo As Double
Dim codSueldo As String
Dim codAfp As Long
Dim TipoDocRegPat
Dim RegPat
Dim Doc113
Dim TipoDoc113
Dim canthoras
Dim esconcepto
Dim AporteEmp
Dim AporteEmpDesc
Dim NroConcepto
Dim EmpTernro
Dim pliqdesc

codSueldo = "0"

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 126"

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL VALOR DE CARNET AFP
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 243"
StrSql = StrSql & " AND conftipo = 'DOC' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    codAfp = rsConsult!confval
Else
    codAfp = 0
    Flog.writeline " No se configuro la columna 243 como tipo de DOC, es necesaria para obtener el carnet afp "
End If
rsConsult.Close

'------------------------------------------------------------------
'LEVANTO DEL CONFREP LOS VALORES DEL CONCEPTO SUELDO
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 242"
StrSql = StrSql & " AND conftipo = 'CO' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do While Not rsConsult.EOF
        codSueldo = codSueldo & ", " & rsConsult!confval2
    rsConsult.MoveNext
    Loop
Else
    Flog.writeline " No se configuro la columna 242 como tipo de concepto, es necesaria para obtener el suedo "
End If
rsConsult.Close

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidación y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de Alta y Baja de la última fase Activa
'------------------------------------------------------------------
StrSql = "SELECT empleado,altfec,bajfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   empFecBaja = rsConsult!bajfec
   
   '********************************
   'FALTA AGREGAR AL INSERT (BAJFEC)
   '********************************
Else
   Flog.writeline "No existe fase para el empleado ternro:" & Ternro
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la estructura "CARGO" desde el confrep | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=117)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   Estructuracargo = rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos de cargo. Revisar configuración de Columna 117 del confrep"
   'GoTo MError
End If
rsConsult.Close
 
 
'------------------------------------------------------------------
'Busco la estructura "AFP" desde el confrep | COLUMNA FIJA 118 (AFP)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=118)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   EstructuraAFP = rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos de AFP. Revisar configuración de Columna 118 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'BUSCO EL VALOR DEL CAMPO SUELDO DEL RECIBO
'------------------------------------------------------------------
If codSueldo <> "0" Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod IN (" & codSueldo & ")"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       valorSueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener el valor del campo sueldo."
       valorSueldo = 0
    End If
    rsConsult.Close
Else
    valorSueldo = 0
End If
 

'------------------------------------------------------------------
'Busco el valor de los días trabajados | COLUMNA 49
'------------------------------------------------------------------
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "No existen cantidad de dias trabajados."
       DiasTrabajados = 0
    End If
    rsConsult.Close
Else
    DiasTrabajados = 0
End If
 
'------------------------------------------------------------------
'Busco el valor de la cantidad de horas | COLUMNA 90
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 90 "
Flog.writeline "Horas Trabajadas" & StrSql
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        canthoras = rsConsult!confval
        esconcepto = True
    Else
        canthoras = rsConsult!confval2
        esconcepto = False
    End If
End If
rsConsult.Close

If esconcepto Then
    StrSql = "SELECT detliq.dlicant valor"
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
    StrSql = StrSql & " AND concepto.conccod = " & canthoras
Else
     StrSql = " SELECT alcant valor"
     StrSql = StrSql & " From acu_liq"
     StrSql = StrSql & " Where acunro = " & canthoras
     StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
Flog.writeline "Horas Trabajadas" & StrSql
If Not rsConsult.EOF Then
    HrsTrabajadas = rsConsult!Valor
Else
    HrsTrabajadas = 0
 End If
rsConsult.Close

FormaPago = ""

'---------------------sebastian stremel 05/04/2013-----------------

'------------------------------------------------------------------
'Busco la estructura "UBICACION" desde el confrep | COLUMNA FIJA 300 (UBICACION)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=300)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    EstructuraUbicacion = rsConsult!estrdabr
Else
    EstructuraUbicacion = ""
    Flog.writeline "No se pudo obtener los datos de ubicacion. Revisar configuración de Columna 300 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "SEDE" desde el confrep | COLUMNA FIJA 301 (SEDE)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=301)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraSede = rsConsult!estrdabr
Else
    EstructuraSede = ""
    Flog.writeline "No se pudo obtener los datos de sede. Revisar configuración de Columna 301 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "CENTRO DE COSTO" desde el confrep | COLUMNA FIJA 302 (C.COSTO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=302)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraCCosto = rsConsult!estrdabr & rsConsult!estrcodext
Else
    EstructuraCCosto = ""
    Flog.writeline "No se pudo obtener los datos de centro de costo. Revisar configuración de Columna 302 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "AREA" desde el confrep | COLUMNA FIJA 303 (AREA)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=303)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraArea = rsConsult!estrdabr
Else
    EstructuraArea = ""
    Flog.writeline "No se pudo obtener los datos del area. Revisar configuración de Columna 303 del confrep. Si esta configurado no exite Area para esos datos"
    Flog.writeline "Query Area" & StrSql
End If
rsConsult.Close

'-----------------------HASTA ACA---------------------------------

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco Tipo de documento 1 ó 3
'------------------------------------------------------------------
StrSql = " SELECT ter_doc.ternro,ter_doc.tidnro, ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc ON tercero.ternro=ter_doc.ternro"
StrSql = StrSql & " WHERE Tercero.Ternro = " & Ternro
StrSql = StrSql & " AND (ter_doc.tidnro=1 OR ter_doc.tidnro=3)"
StrSql = StrSql & " ORDER BY tidnro ASC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Tipo de documento tipo 7 | CARNET AFP
'------------------------------------------------------------------
StrSql = " SELECT ter_doc.ternro,ter_doc.tidnro, ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc ON tercero.ternro=ter_doc.ternro"
StrSql = StrSql & " WHERE Tercero.Ternro = " & Ternro
StrSql = StrSql & " AND ter_doc.tidnro=" & codAfp
StrSql = StrSql & " ORDER BY tidnro ASC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    CarnetAFP = rsConsult!NroDoc
Else
    CarnetAFP = ""
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
    Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

' ahora si tiene valor ==> lo recalcula sino deja el empremu
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
    rsConsult.Close
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto SALE DE LA COLUMNA 2 DEL CONFREP
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
    rsConsult.Close
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = ""

'------------------------------------------------------------------
'Busco el valor del puesto | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Puesto = ""
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del centro de costo
''------------------------------------------------------------------
CentroCosto = ""
  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpTernro = rs_estructura!Ternro
End If
'rs_estructura.Close

StrSql = " SELECT * FROM ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro=ter_imag.tipimnro "
StrSql = StrSql & " WHERE ternro =" & rs_estructura!Ternro
StrSql = StrSql & " AND ter_imag.tipimnro=1"
OpenRecordset StrSql, rs_Domicilio
If Not rs_Domicilio.EOF Then
    EmpLogo = rs_Domicilio!tipimdire & rs_Domicilio!terimnombre
    EmpLogoAncho = IIf(EsNulo(rs_Domicilio!tipimanchodef), 0, rs_Domicilio!tipimanchodef)
    EmpLogoAlto = IIf(EsNulo(rs_Domicilio!tipimaltodef), 0, rs_Domicilio!tipimaltodef)
    Flog.writeline "Se encontro el logo de la empresa: " & EmpLogo
Else
    EmpLogo = ""
    EmpLogoAncho = 0
    EmpLogoAlto = 0
    Flog.writeline "No se encontro el logo de la empresa"
End If
rs_Domicilio.Close

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.torre, detdom.barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & "@" & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!Piso
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!oficdepto
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    'Sebastian Stremel 19/07/2012
    If Not EsNulo(rs_Domicilio!torre) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!torre
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!barrio) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!barrio
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    'hasta aca
    'EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
End If
rs_Domicilio.Close

'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
'StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 10)" 'sebastian stremel 19/07/2012
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el tipo de documento RUC de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If
rs_cuit.Close

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
Flog.writeline "Cierro Firma"
rs_estructura.Close
rs_firma.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Banco = ""
nroCuenta = ""

'________________________________________________________________
'BUSCO EL PERIODO VACACIONAL
StrSql = " SELECT * FROM emp_lic "
StrSql = StrSql & " INNER JOIN vacpagdesc ON vacpagdesc.emp_licnro = emp_lic.emp_licnro "
StrSql = StrSql & " WHERE Empleado =" & Ternro & " And tdnro = 2 And pliqnro = " & pliqnro
StrSql = StrSql & " AND vacpagdesc.pronro =" & Pronro
StrSql = StrSql & " AND pago_dto in(1,3)" '1 y 3 son los codigos de pago
OpenRecordset StrSql, rs_cuit
If Not rs_cuit.EOF Then
    Flog.writeline "Se encontro el periodo vacacional"
    periodo_vac_desde = rs_cuit!elfechadesde
    periodo_vac_hasta = rs_cuit!elfechahasta
Else
    Flog.writeline "No se encontro el periodo vacacional, query: " & StrSql
    periodo_vac_desde = ""
    periodo_vac_hasta = ""
End If
Flog.writeline "Cierro Periodo Vacacional"
rs_cuit.Close

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL TIPO DOCUMENTO REG. PAT.
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo = 'REG' "
OpenRecordset StrSql, rsConsult
Flog.writeline " REG: PAT. " & StrSql
If Not rsConsult.EOF Then
    TipoDocRegPat = rsConsult!confval
Else
    TipoDocRegPat = 0
    Flog.writeline " No se configuro el tipo de DOC Reg Pat"
End If
rsConsult.Close

'Busco el Tipo de Documento REG. PAT
StrSql = " SELECT tidnom, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & EmpTernro
StrSql = StrSql & " AND ter_doc.tidnro=" & TipoDocRegPat
OpenRecordset StrSql, rsConsult
Flog.writeline " REG: PAT. " & StrSql
If Not rsConsult.EOF Then
    RegPat = rsConsult!NroDoc
Else
    RegPat = 0
End If

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL TIPO DOCUMENTO 113
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo = 'SUP' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDoc113 = rsConsult!confval
Else
    TipoDoc113 = 0
    Flog.writeline " No se configuro el tipo de DOC 113"
End If
rsConsult.Close

'Busco el Tipo de Documento 113
StrSql = " SELECT tidnom, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & EmpTernro
StrSql = StrSql & " AND ter_doc.tidnro=" & TipoDoc113
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Doc113 = rsConsult!NroDoc
Else
    Doc113 = 0
End If

'------------------------------------------------------------------
'Busco el valor de los Aportes del Empleador
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo= 'EMP' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
        NroConcepto = rsConsult!confval
Else
    NroConcepto = 0
End If
rsConsult.Close

StrSql = "SELECT detliq.dlimonto valor, concabr"
StrSql = StrSql & " FROM detliq "
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
StrSql = StrSql & " AND concepto.conccod = " & NroConcepto
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    AporteEmp = Replace(rsConsult!Valor, ",", ".")
    AporteEmpDesc = rsConsult!concabr
Else
    AporteEmp = 0
    AporteEmpDesc = ""
End If
rsConsult.Close

'________________________________________________________________

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " ("
StrSql = StrSql & " bpronro,ternro,pronro"
StrSql = StrSql & " ,apellido,Nombre,direccion,Legajo"
StrSql = StrSql & " ,pliqnro,pliqmes,pliqanio,pliqdepant"
StrSql = StrSql & " ,pliqfecdep,pliqbco,cuil,empfecalta"
StrSql = StrSql & " ,sueldo,categoria,centrocosto,localidad"
StrSql = StrSql & " ,profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma"
StrSql = StrSql & " ,empfirmaalto,empfirmaancho,formapago,prodesc,descripcion "
StrSql = StrSql & " ,tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden"
StrSql = StrSql & " ,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
StrSql = StrSql & " ,auxdeci1,auxdeci2,auxdeci3,auxchar6"
StrSql = StrSql & " ,auxchar7,auxchar8,auxchar9, auxdeci4,auxdeci7,puesto, auxchar10"
StrSql = StrSql & " ) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Replace(Sueldo, ",", ".")
StrSql = StrSql & ",'" & Doc113 & "'" 'Categoria
StrSql = StrSql & ",'" & Mid(EstructuraCCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & RegPat & "'" ' Localidad
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

'Auxchar
StrSql = StrSql & ",'" & CarnetAFP & "'"

StrSql = StrSql & ",'" & periodo_vac_desde & "'"
StrSql = StrSql & ",'" & periodo_vac_hasta & "'"

StrSql = StrSql & ",'" & EstructuraAFP & "'"   'AFP
StrSql = StrSql & ",'" & Estructuracargo & "'" ' CARGO

'Auxdeci
StrSql = StrSql & "," & Replace(SalarioNeto, ",", ".")
StrSql = StrSql & "," & DiasTrabajados
StrSql = StrSql & "," & HrsTrabajadas
StrSql = StrSql & ",'" & IIf(EsNulo(empFecBaja), "", empFecBaja) & "'" 'sebastian stremel

'auxchar
StrSql = StrSql & ",'" & EstructuraUbicacion & "'"
StrSql = StrSql & ",'" & EstructuraSede & "'"
StrSql = StrSql & ",'" & EstructuraArea & "'"
StrSql = StrSql & "," & IIf(EsNulo(valorSueldo), 0, valorSueldo)

'Auxdeci
StrSql = StrSql & "," & AporteEmp
StrSql = StrSql & ",'" & AporteEmpDesc & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Flog.writeline "----------------------------------------------------------------------------------------"
Flog.writeline ""
Flog.writeline ""

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para CCU
'--------------------------------------------------------------------
Sub generarDatosRecibo127(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Neto
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

'sebastian stremel 23/07/2012
Dim acuGarantia
Dim esAcuGarantia As Boolean
Dim acuCtaFut
Dim esAcuCtaFut As Boolean
Dim acuSoeva
Dim esAcuSoeva As Boolean
Dim acuPromedio
Dim esAcuPromedio As Boolean

Dim valorGarantia As Double
Dim valorCtaFut As Double
Dim valorSoeva As Double
Dim valorPromedio As Double




On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'______________________________________________________________________________________________________
'sebastian stremel 23/07/2012 - levanto parametros extras del confrep
StrSql = "SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
Do While Not rsConsult.EOF

    Select Case rsConsult!confnrocol
        Case 300:
            
            If rsConsult!conftipo = "AC" Then
                acuGarantia = rsConsult!confval
                esAcuGarantia = True
            Else
                acuGarantia = rsConsult!confval2
                esAcuGarantia = False
            End If
        
        Case 301:
            
            If rsConsult!conftipo = "AC" Then
                acuCtaFut = rsConsult!confval
                esAcuCtaFut = True
            Else
                acuCtaFut = rsConsult!confval2
                esAcuCtaFut = False
            End If
        
        Case 302:
            
            If rsConsult!conftipo = "AC" Then
                acuSoeva = rsConsult!confval
                
                esAcuSoeva = True
            Else
                acuSoeva = rsConsult!confval2
                esAcuSoeva = False
            End If

        Case 303:
    
            If rsConsult!conftipo = "AC" Then
                acuPromedio = rsConsult!confval
                esAcuPromedio = True
            Else
                acuPromedio = rsConsult!confval2
                esAcuPromedio = False
            End If
    
    End Select
    rsConsult.MoveNext
Loop
End If
rsConsult.Close
'______________________________________________________________________________________________________

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
'    rsConsult.Close
'    StrSql = " SELECT altfec "
'    StrSql = StrSql & " FROM fases "
'    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'        empFecAlta = rsConsult!altfec
'    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
'    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
'CAS-02416 - Rotacion empresa
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " LEFT JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " LEFT JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " LEFT JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If Tickets <> 0 Then
    'Columna 42
    If esTicketsConc Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Tickets & " AND novemp.tpanro = 1"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           Sueldo = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Tickets & ") y parámetro 1."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 1"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   Sueldo = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 1."
                End If
           Else
                Flog.writeline "Error al obtener el valor del Básico. La columna 43 del confrep debe ser un concepto, de tipo 'CO'."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor del Básico. La columna 42 del confrep debe ser un concepto, de tipo 'CO'."
    End If
    
Else
    Flog.writeline "Error al obtener el valor del Básico. No esta configurado el concepto en la columna 42 del confrep."
End If
    
    
If Sueldo = 0 Then
    'Buscar en la escala de Básicos
    
    'Determinar la sucursal del empleado. Ya la tengo
    If SucursalNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Sucursal para determinar la escala del Básico."
    End If
    
    'Determinar el Convenio del empleado.
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       ConvenioNro = rsConsult!Estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
       ConvenioNro = 0
    '   GoTo MError
    End If
    
    'Determinar la categoria del empleado. Ya la tengo
    If CategoriaNro = 0 Then
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría para determinar la escala del Básico."
    End If
    
    'Determinar la Forma de Liquidacion
    StrSql = " SELECT his_estructura.estrnro "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       FormaLiqNro = rsConsult!Estrnro
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidación para determinar la escala del Básico."
       FormaLiqNro = 0
    '   GoTo MError
    End If
    
    StrSql = " SELECT vgrvalor FROM valgrilla "
    StrSql = StrSql & " WHERE cgrnro = 4 "
    StrSql = StrSql & " AND vgrcoor_1 = " & SucursalNro
    StrSql = StrSql & " AND vgrcoor_2 = " & ConvenioNro
    StrSql = StrSql & " AND vgrcoor_3 = " & CategoriaNro
    StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Sueldo = rsConsult!vgrvalor
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Básico. No se encontro. SQL --> " & StrSql
    End If
    
End If

If Sueldo = 0 And acumHaberesConAp <> 0 Then
    'Columna 60
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acumHaberesConAp
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
       Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo del acumulador " & acumHaberesConAp
    End If
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Neto = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Neto = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto a ensobrar. Se debe configurar en la columna 1 del confrep."
   Neto = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

''------------------------------------------------------------------
''Busco el valor de la Antigüedad
''------------------------------------------------------------------
'valorAntig = 0
'If SueldoRecibo <> 0 Then
'    'Columna 42
'    If esSueldoRecibo Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           valorAntig = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   valorAntig = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
'           End If
'           'FIN MENSUALES
'
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
'        valorAntig = 0
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
'    valorAntig = 0
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close


'-------------------------------------------------------------------
'Busco el valor de la garantia
'-------------------------------------------------------------------
valorGarantia = 0
If acuGarantia <> 0 Then
    'Columna 44
    If Not esAcuGarantia Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE concepto.conccod = " & "'" & acuGarantia & "' And detliq.cliqnro = " & cliqnro
        
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acuGarantia & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorGarantia = rsConsult!Valor
        Flog.writeline "Se obtuvo el valor de la garantia"
    Else
        Flog.writeline "Error al obtener el valor de la Garantia."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Garantia. No esta configurado el concepto en la columna 300 del confrep."
    valorGarantia = 0
End If

'------------------------------------------------------------------
'Busco el valor de la cuenta futuros
'------------------------------------------------------------------

valorCtaFut = 0
If acuCtaFut <> 0 Then
    'Columna 44
    If Not esAcuCtaFut Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE concepto.conccod = " & "'" & acuCtaFut & "' And detliq.cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acuCtaFut & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorCtaFut = rsConsult!Valor
        Flog.writeline "Se obtuvo el valor de la Cta Fut"
    Else
        Flog.writeline "Error al obtener el valor de la Cta Fut."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Cta Fut. No esta configurado el concepto en la columna 301 del confrep."
    valorCtaFut = 0
End If


'------------------------------------------------------------------
'Busco el valor de valorSoeva
'------------------------------------------------------------------

valorSoeva = 0
If acuSoeva <> 0 Then
    'Columna 44
    If Not esAcuSoeva Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE concepto.conccod = " & "'" & acuSoeva & "' And detliq.cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acuSoeva & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorSoeva = rsConsult!Valor
        Flog.writeline "Se obtuvo el valor de Soeva"
    Else
        Flog.writeline "Error al obtener el valor de Soeva."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de Soeva. No esta configurado el concepto en la columna 302 del confrep."
    valorSoeva = 0
End If


'------------------------------------------------------------------
'Busco el valor de Promedio
'------------------------------------------------------------------

valorPromedio = 0
If acuPromedio <> 0 Then
    'Columna 44
    If Not esAcuPromedio Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE concepto.conccod = " & "'" & acuPromedio & "' And detliq.cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acuPromedio & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorPromedio = rsConsult!Valor
        Flog.writeline "Se obtuvo el valor de Promedio"
    Else
        Flog.writeline "Error al obtener el valor de Promedio."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de Promedio. No esta configurado el concepto en la columna 303 del confrep."
    valorPromedio = 0
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1, auxdeci2, auxdeci6, auxdeci7, auxdeci8, auxdeci9)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & "," & Neto
StrSql = StrSql & "," & valorGarantia
StrSql = StrSql & "," & valorCtaFut
StrSql = StrSql & "," & valorSoeva
StrSql = StrSql & "," & valorPromedio
StrSql = StrSql & ")"



'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Apex Honduras
'--------------------------------------------------------------------
Sub generarDatosRecibo128(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim telefono

'Busquedas
Dim Contrato
Dim Antiguedad
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset
Dim t
Dim seccion
Dim calle

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline "v  Basico" & StrSql
 
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = 0
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 2"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
 OpenRecordset StrSql, rsConsult2
 If Not rsConsult2.EOF Then
       Datos = rsConsult2!estrdabr
 End If
        
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,telefono.telnro,detdom.codigopostal,pais.paisdesc,cpa, provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " "
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=10 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = empresa.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN Telefono ON detdom.domnro=telefono.domnro"
StrSql = StrSql & " INNER JOIN pais ON pais.paisnro=localidad.paisnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=localidad.provnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult
Direccion = ""
If rsConsult.EOF Then
    Flog.writeline "Error al obtener los datos de la localidad"
End If
t = 1
Do While Not rsConsult.EOF
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If t < 4 Then
        If EsNulo(tel) Then
            tel = "Tel: " & rsConsult!telnro
        Else
            tel = tel & " / " & rsConsult!telnro
            t = t + 1
        End If
    End If
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc & " "
    'tel = "Tel:" & rsConsult!telnro
    Localidad = rsConsult!cpa & "-" & rsConsult!locdesc & "-" & rsConsult!paisdesc
    Flog.writeline "Direccion" & Direccion
    Flog.writeline Localidad
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

  If esSueldoConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & acunroSueldo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

Flog.writeline "Basico" & StrSql

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
'    OpenRecordset StrSql, rsConsult

    Flog.writeline "Sueldo Basico" & StrSql
StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro

    If Not rsConsult.EOF Then
        Sueldo = rsConsult!Valor
        Flog.writeline Sueldo
        Flog.writeline StrSql
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
 Flog.writeline "Basico" & StrSql & Sueldo
 

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If

'------------------------------------------------------------------
'Busco el valor del Contratacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 45 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

'------------------------------------------------------------------
'Calcula la direccion del empleado
'------------------------------------------------------------------
StrSql = " SELECT calle,nro,provdesc,locdesc FROM empleado "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro=empleado.ternro "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro=cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON localidad.locnro=detdom.locnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=provincia.provnro "
StrSql = StrSql & " WHERE empleado.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    calle = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!locdesc) Then
          calle = calle & " " & rsConsult!locdesc
    End If
    If Not EsNulo(rsConsult!provdesc) Then
        'calle = calle & " " & rsConsult!provdesc
    End If
Else
    Flog.writeline "No se encontro la direccion del empleado"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
    Flog.writeline "Obra social:" & ObraSocial
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Sueldo Bruto
'StrSql = " SELECT almonto"
'StrSql = StrSql & " From acu_liq"
'StrSql = StrSql & " Where acunro = " & ValNetoTalon
'StrSql = StrSql & " AND cliqnro = " & cliqnro
'OpenRecordset StrSql, rsConsult

'Flog.writeline StrSql

  If esGratificacionConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & Gratificacion & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & Gratificacion & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ValorAcumSueldoBruto = rsConsult!Valor
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto" & ValorAcumSueldoBruto
Else
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto"
   Flog.writeline StrSql
   ValorAcumSueldoBruto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0

If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        Flog.writeline StrSql
        Flog.writeline rsConsult2!ConcNro
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,auxdeci3,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1 "
StrSql = StrSql & " , auxdeci4, auxdeci5"
StrSql = StrSql & " )"
',auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & calle & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
'If tel = "" Then
'    StrSql = StrSql & " ," & 0
'Else
'    StrSql = StrSql & " ," & tel
'End If
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & " ,'" & Mid(valorAntig, 1, 25) & "'" 'CentroCosto
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & Antiguedad & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & tel & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & TipoDocu & "'"
StrSql = StrSql & " ,'" & NroDocu & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & " ," & ValorAcumSueldoBruto
StrSql = StrSql & " ," & FuturosAumentos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    'Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Gestion Compartida
'--------------------------------------------------------------------
Sub generarDatosRecibo129(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim leyenda

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 129"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
      Sueldo = Replace(Sueldo, ",", ".")
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Sueldo = Replace(Sueldo, ",", ".")
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Busco la configuracion del confrep
Flog.writeline "Buscando columna 40 del confrep para traer el tipo de estructura"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  (confnrocol = 121 OR confnrocol = 122)  "
OpenRecordset StrSql, rsConsult
Flog.writeline "Obtengo los datos del confrep"
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep"
    Exit Sub
Else
    TipoEstr = "0"
    Do Until rsConsult.EOF
        TipoEstr = TipoEstr & "," & rsConsult!confval
        rsConsult.MoveNext
   Loop
   rsConsult.Close
   
   StrSql = "SELECT estrnro "
   StrSql = StrSql & " From his_estructura"
   StrSql = StrSql & " WHERE htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
   StrSql = StrSql & " AND his_estructura.ternro = " & Ternro & " AND estrnro in (" & TipoEstr & ")"
   OpenRecordset StrSql, rsConsult
   If Not rsConsult.EOF Then
        leyenda = " Tarea diferencial Dec. 937/74 "
   Else
        leyenda = " "
   End If
   rsConsult.Close
End If

 
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & leyenda & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'agrego modelo sebastian stremel
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Kraft Chile
'--------------------------------------------------------------------
Sub generarDatosRecibo130(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim StrSql1 As String
Dim StrSql2 As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult1 As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'estructura afp y sistema de salud
Dim AFP
Dim Salud

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Documento
Dim regHorario
Dim Sector
Dim DNRP
Dim Antiguedad

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun
'Dim StrSql
Dim objRs2 As New ADODB.Recordset

Dim Bandesc
Dim ctabancaria
Dim esdtrab
Dim DiasTrab

Dim NoImponible
Dim esNoImponibleConc

Dim esAfectoImpConc
Dim acunroAfectoImp

Dim esLiqApagarConc
Dim acunroLiqApagar

Dim acunroDtosPrev
Dim esDtosPrevConc

Dim TEAfp As Long
Dim TEIsapre As Long
Dim NroEscala
Dim Porc As Long
Dim ConcPorc As Long
Dim PMonto As Long
Dim ConcPMonto As Long
Dim CantidadUf As Long
Dim ConcCantidadUf As Long

Dim NConcParam1 As Double
Dim NConcParam2 As Double
Dim NConcParam3 As Double

Dim SumPorcentaje As Double
Dim Valores

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

NConcParam1 = 0
NConcParam2 = 0
NConcParam3 = 0

SumPorcentaje = 0
AFP = ""
Salud = ""

'confrep
'agrego sebastian stremel 19/09/2011
StrSql = " SELECT * FROM confrep "
'StrSql = StrSql & " WHERE repnro = 60 and (confnrocol=12 or confnrocol=10 or confnrocol=16 or confnrocol=105 or confnrocol=106 or confnrocol=107 or confnrocol=108 or confnrocol=109)"
StrSql = StrSql & " WHERE repnro = 60 and confnrocol in (10,12,16,105,106,107,108,109,110,112,113,114,115,116)"
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep"
    Exit Sub
End If

Do Until rsConsult.EOF
    Flog.writeline "Columna " & rsConsult!confnrocol
    Select Case rsConsult!confnrocol
    Case 10
        cargo = rsConsult!confval
    Case 12
        sBase = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esSueldoBase = True
        Else
            esSueldoBase = False
        End If
    Case 16
        dtrab = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esdtrab = True
        Else
            esdtrab = False
        End If
        
    Case 105
        acunroImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esImponibleConc = True
        Else
            esImponibleConc = False
        End If
    
    Case 106
        acunroNoImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esNoImponibleConc = True
        Else
            esNoImponibleConc = False
        End If
    
    Case 107
        acunroAfectoImp = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esAfectoImpConc = True
        Else
            esAfectoImpConc = False
        End If
        
    Case 108
        acunroDtosPrev = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esDtosPrevConc = True
        Else
            esDtosPrevConc = False
        End If
        
    Case 109
        acunroLiqApagar = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esLiqApagarConc = True
        Else
            esLiqApagarConc = False
        End If
        
    ' Agregadas por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
    'Inicio
    Case 110
        If rsConsult!conftipo = "TE" Then
            TEAfp = rsConsult!confval
        Else
            Flog.writeline "La columna 110 AFP debe ser un Tipo de Estructura. "
        End If
                                   
    Case 112
        If rsConsult!conftipo = "TE" Then
            TEIsapre = rsConsult!confval
        Else
            Flog.writeline "La columna 112 ISAPRE debe ser un Tipo de Estructura. "
        End If
        
    Case 113
        If rsConsult!conftipo = "NE" Then
            NroEscala = rsConsult!confval
        Else
            Flog.writeline "La columna 113 Nro de Escala debe ser un Número de Escala. "
        End If
        
    Case 114
        If rsConsult!conftipo = "NPC" Then
            Porc = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPorc = 0
            Else
              ConcPorc = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 114 Parámetro 1 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 115
        If rsConsult!conftipo = "NPC" Then
            PMonto = rsConsult!confval
        
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPMonto = 0
            Else
              ConcPMonto = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 115 Parámetro 2 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 116
        If rsConsult!conftipo = "NPC" Then
            CantidadUf = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcCantidadUf = 0
            Else
              ConcCantidadUf = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 116 Parámetro 3 debe ser un Parámetro de un Concepto. "
        End If
    'Fin
    End Select
    
    rsConsult.MoveNext
Loop
rsConsult.Close
'hasta aca


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   'Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
   Documento = rsConsult!sigladoc & "@" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regHorario = ""

If Not rsConsult.EOF Then
   regHorario = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del reg. horario"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call bus_Anti0(ternro, pliqanio, pliqmes, dia, mes, Anio)

Call antigfec(Ternro, pliqanio, pliqmes, Dia, Mes, Anio)

Antiguedad = " A&ntilde;os&nbsp;" & Anio & "&nbsp;Meses&nbsp;" & Mes & "&nbsp;D&iacute;as&nbsp;" & Dia

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'busco el valor del sueldo base
'------------------------------------------------------------------
If esSueldoBase Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       StrSql = " select * from concepto where conccod=" & sBase 'cambio sebastian stremel
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        sBase = rsConsult2!ConcNro
       End If
       rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & sBase
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        Sueldo = rsConsult2!dlimonto
       Else
        Sueldo = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
Else
    Sueldo = 0
End If
Sueldo = Replace(Sueldo, ",", ".")
rsConsult2.Close

'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco el valor del Total Imponible
'------------------------------------------------------------------
If acunroImponible <> 0 And Not IsNull(acunroImponible) Then
    If esImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Imponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Imponible."
       Imponible = 0
    End If
Else
    Imponible = 0
End If
Imponible = Replace(Imponible, ",", ".")


'------------------------------------------------------------------
'Busco el valor del Total No Imponible
'------------------------------------------------------------------
If acunroNoImponible <> 0 And Not IsNull(acunroNoImponible) Then
    If esNoImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroNoImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroNoImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroNoImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroNoImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       NoImponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total No Imponible."
       NoImponible = 0
    End If
Else
    NoImponible = 0
End If
NoImponible = Replace(NoImponible, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total afecto a impuesto
'------------------------------------------------------------------
If acunroAfectoImp <> 0 And Not IsNull(acunroAfectoImp) Then
    If esAfectoImpConc Then
        StrSql = " select * from concepto where conccod=" & acunroAfectoImp 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroAfectoImp = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroAfectoImp 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroAfectoImp
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       afectoImp = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total afecto a impuesto."
       afectoImp = 0
    End If
Else
    afectoImp = 0
End If
'afectoImp = Replace(afectoImp, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de descuentos previsionales
'------------------------------------------------------------------
If acunroDtosPrev <> 0 And Not IsNull(acunroDtosPrev) Then
    If esDtosPrevConc Then
        StrSql = " select * from concepto where conccod=" & acunroDtosPrev 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroDtosPrev = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroDtosPrev
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroDtosPrev
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       dtosPrev = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       dtosPrev = 0
    End If
Else
    dtosPrev = 0
End If
dtosPrev = Replace(dtosPrev, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de liquido a pagar
'------------------------------------------------------------------
If acunroLiqApagar <> 0 And Not IsNull(acunroLiqApagar) Then
    If esLiqApagarConc Then
        StrSql = " select * from concepto where conccod=" & acunroLiqApagar 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroLiqApagar = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroLiqApagar
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroLiqApagar
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       liqApagar = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       liqApagar = 0
    End If
Else
    liqApagar = 0
End If
liqApagar = Replace(liqApagar, ",", ".")


'------------------------------------------------------------------
'busco los dias trabajados
'------------------------------------------------------------------
If esdtrab Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        StrSql = " select * from concepto where conccod=" & dtrab 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            dtrab = rsConsult2!ConcNro
        End If
        rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & dtrab
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
        DiasTrab = rsConsult!dlimonto
       Else
        DiasTrab = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos de los dias trabajados"
       DiasTrab = 0
       'GoTo MError
    End If
 Else
       StrSql = " SELECT almonto valor"
       StrSql = StrSql & " From acu_liq"
       StrSql = StrSql & " Where acunro = " & dtrab
       StrSql = StrSql & " AND cliqnro = " & cliqnro
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
            dtrab = rsConsult!Valor
       Else
            Flog.writeline "Error al obtener los datos de los dias trabajados"
            DiasTrab = 0
       End If
    
End If

'------------------------------------------------------------------

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabancaria.ctabnro, formapago.fpagdescabr, formapago.fpagbanc, banco.bandesc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " INNER JOIN ctabancaria on pago.cbnro = ctabancaria.cbnro"
StrSql = StrSql & " INNER JOIN banco on banco.ternro=ctabancaria.banco "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
'FormaPago = "Forma de Pago: Dep&oacute;sito Bancario"
If Not rsConsult.EOF Then
    'If rsConsult!fpagbanc = "-1" Then
        'FormaPago = "Forma de Pago: " & rsConsult!fpagdescabr & " - Cuenta N&deg; " & rsConsult!ctabnro
        FormaPago = FormaPago & rsConsult!Bandesc & "@" & rsConsult!ctabnro & "@"
    'End If
Else
   Flog.writeline "No se encontraron los datos de la forma de pago."
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
' busco el banco y las cuentas
'------------------------------------------------------------------
'    StrSql = "SELECT DISTINCT fpagnro from pedidopago "
'    StrSql = StrSql & " where pliqnro= " & pliqnro
'    OpenRecordset StrSql, rsConsult
'    FormaPago = ""
'    Do While Not rsConsult.EOF
'        StrSql1 = " select top 2 * from ctabancaria "
'        StrSql1 = StrSql1 & " Where fpagnro =" & rsConsult!fpagnro & ""
'        StrSql1 = StrSql1 & " and ctabestado=-1 and ternro=" & Ternro
'        OpenRecordset StrSql1, rsConsult1
'        Do While Not rsConsult1.EOF
'            ctabancaria = rsConsult1!ctabnro
'            StrSql2 = "select * from banco where ternro=" & rsConsult1!Banco
'            OpenRecordset StrSql2, rsConsult2
'            Bandesc = rsConsult2!Bandesc
'            rsConsult1.MoveNext
'            FormaPago = FormaPago & Bandesc & "@" & ctabancaria & "@"
'        Loop
  
'   rsConsult.MoveNext
'   Loop

'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del subtotal remunerativo
'------------------------------------------------------------------

StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumSubTotalRemun
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   subTotalRemun = rsConsult!almonto
Else
   Flog.writeline "No se encontro el subtotal remunerativo"
   subTotalRemun = 0
   'GoTo MError
End If
subTotalRemun = Replace(subTotalRemun, ",", ".")

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & cargo & "  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   If Puesto = "" Then
    Puesto = "No Definido"
   End If
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
'End If

'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 1)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro=30) "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!Ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   DNRP = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Agregado por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
'Inicio
Flog.writeline "Busco el nombre de la estructura AFP a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura AFP a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   AFP = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura AFP"
End If
rsConsult.Close

Flog.writeline "Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEIsapre & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Salud = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura Sistema de Salud"
End If
rsConsult.Close

Flog.writeline "Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep"
'------------------------------------------------------------------
'Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep
'------------------------------------------------------------------

StrSql = "SELECT sum(vgrvalor)suma"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
StrSql = StrSql & " INNER JOIN valgrilla ON valgrilla.vgrcoor_1 = estructura.estrnro"
StrSql = StrSql & " WHERE cgrnro = " & NroEscala
StrSql = StrSql & " AND vgrorden in (1,2)"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!suma) Then
        SumPorcentaje = rsConsult!suma
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 1 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parámetro 1 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPorc
StrSql = StrSql & " AND tpanro= " & Porc
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam1 = rsConsult!nevalor
        End If
    Else
        NConcParam1 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 2 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 2 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPMonto
StrSql = StrSql & " AND tpanro= " & PMonto
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam2 = rsConsult!nevalor
        End If
    Else
       NConcParam2 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 3 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 3 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcCantidadUf
StrSql = StrSql & " AND tpanro= " & CantidadUf
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam3 = rsConsult!nevalor
        End If
    Else
        NConcParam3 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Valores = Valores & AFP & "@" & SumPorcentaje & "@" & Salud & "@" & NConcParam3 & "@" & NConcParam1 & "@" & NConcParam2 & "@"

'Fin
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar3, auxchar4, auxchar5, auxdeci1,auxchar1,auxdeci2,auxdeci3,auxdeci4,auxdeci5,auxchar,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(AFP, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Salud, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & "," & numberForSQL(subTotalRemun)
StrSql = StrSql & ",'" & DiasTrab & "'"
StrSql = StrSql & "," & Imponible
StrSql = StrSql & "," & NoImponible
StrSql = StrSql & "," & afectoImp
StrSql = StrSql & "," & dtosPrev
StrSql = StrSql & ",'" & liqApagar & "'"
StrSql = StrSql & ",'" & Valores & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Express Beer
'--------------------------------------------------------------------
Sub generarDatosRecibo131(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim sueldoBasico
Dim acuSueldoBasico
Dim tipoAcuSueldoBasico

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la ultima fase
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol = 44"
StrSql = StrSql & " AND conftipo = 'COP'"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Titulo = objRs2!confetiq
    
    If objRs2!confval = 1 Then
        StrSql = " SELECT estrdabr FROM his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
        StrSql = StrSql & " AND his_estructura.tenro = " & objRs2!confval2
        StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Datos = rsConsult2!estrdabr
        End If
    Else
        If objRs2!confval = 2 Then
            If CDate(Day(Date) & "/" & Month(Date) & "/" & Year(Date)) > CDate(Day(empFecAlta) & "/" & Month(empFecAlta) & "/" & Year(empFecAlta)) Then
                DiasAcum = 0
                Dias = 0
                YaEntro = False
                
                StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro
                StrSql = StrSql & " AND real = -1"
                StrSql = StrSql & " AND NOT altfec is NULL"
                StrSql = StrSql & " AND NOT (bajfec is NULL AND estado = 0)"
                StrSql = StrSql & " AND altfec <= " & ConvFecha(Date)
                StrSql = StrSql & " ORDER BY altfec ASC"
                OpenRecordset StrSql, rs_Fases
                Do While Not rs_Fases.EOF
                    fecalta = rs_Fases!altfec
                    
                    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
                    If rs_Fases!estado Then
                        fecbaja = Date
                    ElseIf rs_Fases!bajfec <= Date Then
                        fecbaja = rs_Fases!bajfec
                    Else
                        fecbaja = Date
                    End If
                    
                    '12/11/2010 - Stankunas Cesar - Se cambió la lógica
                    Dias = DateDiff("d", fecalta, fecbaja)
                    If YaEntro Then
                        FechaAux = DateAdd("d", -(DiasAcum), fecalta)
                        DiasAcum = DiasAcum + Dias + 1
                    Else
                        DiasAcum = Dias + 1
                        FechaAux = fecalta
                    End If
                    YaEntro = True
                    
                    rs_Fases.MoveNext
                Loop
                rs_Fases.Close
                
                Datos = FechaAux
            End If
        End If
    End If
Else
    Flog.writeline "No esta configurado el campo variable en el ConfRep (Columna 44)"
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        Sueldo = rsConsult!almonto
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico configurable
'------------------------------------------------------------------
'Acumlador configurado en la columna 223 del confrep 60
sueldoBasico = 0
StrSql = " SELECT conftipo, confval2 FROM confrep WHERE confnrocol = 223 AND repnro = 60 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    acuSueldoBasico = rsConsult!confval2
    tipoAcuSueldoBasico = rsConsult!conftipo
Else
    Flog.writeline "No esta configurado la columna 223 del reporte para mostrar el sueldo basico configurable"
End If
If UCase(tipoAcuSueldoBasico) = "COM" Then
    StrSql = " SELECT detliq.dlimonto  FROM periodo " & _
             " INNER JOIN proceso ON periodo.pliqnro = proceso.pliqnro " & _
             " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro AND cabliq.empleado = " & Ternro & _
             " INNER JOIN detliq ON cabliq.cliqnro = detliq.cliqnro AND cabliq.cliqnro = " & cliqnro & _
             " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod='" & acuSueldoBasico & "'" & _
             " WHERE periodo.pliqmes= " & pliqmes & "  AND periodo.pliqanio= " & pliqanio
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        sueldoBasico = rsConsult!dlimonto
    Else
        Flog.writeline "No hay valor para el concepto de la columna 223."
    End If
    
Else
    If UCase(tipoAcuSueldoBasico) = "ACL" Then
        StrSql = " SELECT almonto FROM acu_liq " & _
                 " WHERE acunro = " & acuSueldoBasico & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            sueldoBasico = rsConsult!almonto
        Else
            Flog.writeline "No hay valor para el acumulador de la columna 223."
        End If
    Else
        If UCase(tipoAcuSueldoBasico) = "ACM" Then
        StrSql = " SELECT ammonto FROM acu_mes WHERE ternro = " & Ternro & " AND amanio = " & pliqanio & _
                 " AND ammes = " & pliqmes & " AND acunro = " & acuSueldoBasico
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            sueldoBasico = rsConsult!ammonto
        Else
            Flog.writeline "No hay valor para el acumulador ocnfigurado columna 223."
        End If
            
        Else
            Flog.writeline "Error mal configurado el tipo del acumulador de la columna 223 (ACL o ACM)."
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1, auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Titulo & "'"
StrSql = StrSql & " ,'" & Datos & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & " ," & sueldoBasico
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Recibo de TATA
'--------------------------------------------------------------------
Sub generarDatosRecibo132(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTicketBruto As Double
Dim MontoTicketNeto As Double
Dim ModeloLiq
Dim ImpIRPF As Double
Dim ImpDescuentoIRPF

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMTSS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim GrupoActividad As Double
Dim SubGrupoActividad As Double

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

'variables nuevas 19/10/2012  ---------------------
Dim Banco As String
Dim Cuenta As String
Dim esConceptoResolucion As Boolean
Dim codResolucion As String
Dim valorResolucion As Double

'hasta aca-----------------------------------------
Dim FecAltaRec

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim empFecBaja
Dim causaBaja

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------------------'
'  Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS  '
'------------------------------------------------------------------------------'
Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura BSE (col 113)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo Estructura (TE). "
    End If
End If
rsConsult.Close

'sebastian stremel
'concepto o acum - Resol. 1114/011
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 123 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el confrep para el acum/conc Resol. 1114/011"
Else
    If rsConsult!conftipo = "CO" Then
        esConceptoResolucion = True
        codResolucion = rsConsult!confval2
    Else
        esConceptoResolucion = False
        codResolucion = rsConsult!confval
    End If
End If
rsConsult.Close

'hasta aca

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, proceso.profecplan FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    cliqnro = rsConsult!cliqnro
    'FGZ - 03/02/2015 ------------------------
   'proFecPago = rsConsult!proFecPago
   proFecPago = rsConsult!proFecplan
   'FGZ - 03/02/2015 ------------------------
    profecini = rsConsult!profecini
    proDesc = rsConsult!proDesc
Else
    Flog.writeline "Error al obtener los datos del proceso"
    GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
    empFecAlta = rsConsult!empfaltagr
    ' el sueldo se saca del concepto 01000
    Sueldo = 0
    'If IsNull(rsConsult!empremu) Then
    '   Sueldo = 0
    'Else
    '   Sueldo = rsConsult!empremu
    'End If
Else
    Flog.writeline "Error al obtener los datos del empleado"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
Else
    Flog.writeline "Error al obtener los datos del periodo actual"
    GoTo MError
End If

'FGZ - 03/02/2015  --------------------------------------------
StrSql = " SELECT altfec, bajfec, caudes "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " LEFT JOIN causa ON causa.caunro = fases.caunro "
StrSql = StrSql & " WHERE empleado=" & Ternro & "  ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    'verifico si la fecha de baja corresponde al mes y anio del proceso
    If Not EsNulo(rsConsult!bajfec) Then
        If (Month(rsConsult!bajfec) = pliqmes) And (Year(rsConsult!bajfec) = pliqanio) Then
            empFecBaja = rsConsult!bajfec
            causaBaja = IIf(EsNulo(rsConsult!caudes), "", rsConsult!caudes)
        End If
    Else
        empFecBaja = ""
        causaBaja = ""
    End If
    
Else
    empFecAlta = ""
    empFecBaja = ""
    causaBaja = ""
End If
'FGZ - 03/02/2015  --------------------------------------------

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro = 1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Cuil = " "
    Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
    Localidad = Direccion
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If



'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsNeto <> "" And Not IsNull(TicketsNeto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsNeto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketNeto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketNeto = 0
    End If
Else
    MontoTicketNeto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsBruto <> "" And Not IsNull(TicketsBruto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsBruto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketBruto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketBruto = 0
    End If
Else
    MontoTicketBruto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para IRPF
'------------------------------------------------------------------
If ConcImpIRPF <> "" And Not IsNull(ConcImpIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para IRPF."
        ImpIRPF = 0
    End If
Else
    ImpIRPF = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para Descuento de IRPF
'------------------------------------------------------------------
If ConcImpDescuentoIRPF <> "" And Not IsNull(ConcImpDescuentoIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpDescuentoIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpDescuentoIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para Descuento de IRPF."
        ImpDescuentoIRPF = 0
    End If
Else
    ImpDescuentoIRPF = 0
End If

'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
Sueldo = 0

If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
    Sueldo = 0
    'GoTo MError
End If

'busco valor del concepto/monto resolucion---------------
valorResolucion = 0

If esConceptoResolucion Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & codResolucion
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & codResolucion
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    valorResolucion = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos -   Resol. 1114/011 (col 123)"
    valorResolucion = 0
    'GoTo MError
End If
'hasta aca-----------------------------------------------


'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación
'------------------------------------------------------------------
ModeloLiq = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ModeloLiq = rsConsult!tprocdesc
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------
CentroCosto = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
FormaPago = " "

StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    Else
        FormaPago = rsConsult!fpagdescabr
    End If
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
EmpEstrnro = 0
EmpNombre = " "

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

' -------------------------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, paisdesc  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " left JOIN pais ON detdom.paisnro = pais.paisnro " & _
    " WHERE cabdom.tidonro = 1 " & _
    " ORDER BY domdefault "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio tipo 1 de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If

' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para obtener el MTSS de la empresa
Flog.writeline "Buscando el MTSS tipo de doc " & CodMTSS
StrSql = " SELECT *"
StrSql = StrSql & " From ter_doc"
StrSql = StrSql & " Where ter_doc.ternro = " & rs_estructura!Ternro & " And ter_doc.tidnro = " & CodMTSS
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MTSS"
    EmpMTSS = "  "
Else
    Flog.writeline "MTSS = " & rs_cuit!NroDoc
    EmpMTSS = IIf(EsNulo(rs_cuit!NroDoc), " ", rs_cuit!NroDoc)
End If

' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If

' -------------------------------------------------------------------------
'Consulta para obtener el BSE de la empresa
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = "SELECT nrodoc FROM ter_doc  "
StrSql = StrSql & " WHERE ternro=" & rs_estructura!Ternro
StrSql = StrSql & " AND tidnro =" & CodBSE
'StrSql = StrSql & " INNER JOIN ter_doc bse ON (tercero.ternro = bse.ternro AND bse.tidnro = " & CodBSE & ")"
'StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BSE de la Empresa"
    EmpBSE = "  "
Else
    EmpBSE = rs_cuit!NroDoc
End If

'StrSql = " SELECT his_estructura.estrnro, estrdabr, estrcodext "
'StrSql = StrSql & " FROM his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ")"
'StrSql = StrSql & " AND his_estructura.tenro= " & CodBSE & " AND his_estructura.ternro=" & Ternro
'OpenRecordset StrSql, rsConsult
'If rsConsult.EOF Then
'    Flog.writeline "No se encontró el BSE"
'    EmpBSE = " "
'Else
'    Flog.writeline "BSE = " & rsConsult!Estrnro & " " & rsConsult!estrdabr & "COD Externo " & rsConsult!estrcodext
'    EmpBSE = IIf(EsNulo(rsConsult!estrcodext), " ", rsConsult!estrcodext)
'End If
'rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Grupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del grupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 38)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        GrupoActividad = 0
    Else
        GrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del Grupo de actividad "
    GrupoActividad = 0
End If

'------------------------------------------------------------------
'Busco el valor del Subgrupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del Subgrupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 39)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        SubGrupoActividad = 0
    Else
        SubGrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del SubGrupo de actividad "
    SubGrupoActividad = 0
End If

'------------------------------------------------------------------
'Busco el valor de la fecha de alta reconocida
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta Reconocida del Empleado"
    FecAltaRec = ""
End If

'-----------------------------------------------------------------------------------------


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5,"
StrSql = StrSql & " auxdeci3, auxdeci4, auxdeci5,auxchar6, auxchar7,auxdeci6,auxchar8,auxchar9,auxchar10"
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & "," & Replace(ImpIRPF, ",", ".")
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

StrSql = StrSql & ",'" & EmpMTSS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ",'" & ModeloLiq & "'"

'StrSql = StrSql & "," & numberForSQL(MontoTicketNeto)
'StrSql = StrSql & "," & numberForSQL(MontoTicketBruto)
StrSql = StrSql & "," & numberForSQL(GrupoActividad)
StrSql = StrSql & "," & numberForSQL(SubGrupoActividad)
StrSql = StrSql & "," & numberForSQL(ImpDescuentoIRPF)
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & "," & Replace(valorResolucion, ",", ".")
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & causaBaja & "'"
StrSql = StrSql & ",'" & FecAltaRec & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Sedamil a partir del modelo 119 de Medicus
'--------------------------------------------------------------------
Sub generarDatosRecibo133(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
' CAS-23269 - SEDAMIL - CUSTOM FECHA EN RECIBO DE HABERES [Entrega 2] se cambio la fecja del proceso por la fecha del pedido de pago

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim diasHab_aux As Integer

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_codigo As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim estrConvenio1 As Integer
Dim estrConvenio2 As Integer
Dim acumulador As Long

Dim PeriodoLiquidacion
Dim tipo124 As String
Dim tipo125 As String
Dim Cod124Acum As Long
Dim Cod125Acum As Long
Dim Cod124Conc As String
Dim Cod125Conc As String
Dim valor124 As Double
Dim valor125 As Double
Dim Cod136
Dim PedPago As String
Dim LugarPago As String
Dim EmpResolucion As String

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 133"

'---------------------------------------------------------------------------------------
'Busco los datos de las estructuras y el acumulador asociado para calcular la antiguedad
'---------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 117 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    estrConvenio1 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio1 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio1 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    End If
End If
rsConsult.Close

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 118 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    estrConvenio2 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio2 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio2 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'empFecAlta = rsConsult!altfec NG - 24/05/2012
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    'empFecAlta = " " NG - 24/05/2012
    empFecBaja = " "
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columna 124 y 125 para del confrep para imp. adicional y Asig rem"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 124 OR confnrocol = 125)"
OpenRecordset StrSql, rsConsult

tipo124 = ""
tipo125 = ""
valor124 = 0
valor125 = 0

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 124
             If rsConsult!conftipo = "AC" Then
                tipo124 = "AC"
                Cod124Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo124 = "CO"
                Cod124Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna 124: " & tipo124 & " concepto: " & Cod124Conc & " acumulador: " & Cod124Acum
      Case 125
             If rsConsult!conftipo = "AC" Then
                tipo125 = "AC"
                Cod125Acum = rsConsult!confval
             ElseIf rsConsult!conftipo = "CO" Then
                tipo125 = "CO"
                Cod125Conc = rsConsult!confval2
             End If
             Flog.writeline "Columna 125: " & tipo125 & " concepto: " & Cod125Conc & " acumulador: " & Cod125Acum
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
' Busco la fecha del pedido de pago - proFecPago
'------------------------------------------------------------------
'StrSql = "SELECT ppagfecped from pedidopago "
'StrSql = StrSql & " where pliqnro= " & pliqnro
'Comentado el 10/06/2014
'StrSql = " SELECT ppagfecped "
'StrSql = StrSql & " From pedidopago "
'StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = pedidopago.pliqnro "
'StrSql = StrSql & " INNER JOIN pago ON pago.ppagnro = pedidopago.ppagnro "
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = pago.ternro "
'StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = pedidopago.pliqnro "
'StrSql = StrSql & " WHERE pedidopago.pliqnro = " & pliqnro
'StrSql = StrSql & " AND proceso.pronro = " & Pronro
'StrSql = StrSql & " AND pago.ternro= " & Ternro
'fin
StrSql = " SELECT ppagfecped "
StrSql = StrSql & " FROM pedidopago "
StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = pedidopago.pliqnro "
StrSql = StrSql & " INNER JOIN pago ON pago.ppagnro = pedidopago.ppagnro "
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = pago.ternro "
StrSql = StrSql & " INNER JOIN pedidopago_pro on pedidopago.ppagnro = pedidopago_pro.ppagnro "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pronro = pedidopago_pro.pronro "
StrSql = StrSql & " WHERE pedidopago.pliqnro = " & pliqnro
StrSql = StrSql & " AND proceso.pronro = " & Pronro
StrSql = StrSql & " AND pago.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    PedPago = rsConsult!ppagfecped
Else
    PedPago = ""
    Flog.writeline "No se encontraron los datos del Pedido de Pago"
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha REAL.
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND real = -1 ORDER BY altfec ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

'Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If


'------------------------------------------------------------------
'Busco el valor de la columna 124 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
valor124 = 0
Select Case tipo124
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod124Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor124 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod124Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor124 = rsConsult!almonto
        End If
End Select

'------------------------------------------------------------------
'Busco el valor de la columna 125 del confrep, Antigüedad
'------------------------------------------------------------------
valor125 = 0
Select Case tipo125
    Case "CO"
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod125Conc
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor125 = rsConsult!dlimonto
        End If
    Case "AC"
        StrSql = " SELECT almonto"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & Cod125Acum
        StrSql = StrSql & " AND cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            valor125 = rsConsult!almonto
        End If
End Select


'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
Flog.writeline "Lugar de Pago" & StrSql
If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr
   Flog.writeline " Los datos del Lugar de Pago OK"
Else
   Flog.writeline " Error al obtener los datos del Lugar de Pago"
   LugarPago = ""
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación y le concateno Periodo de liquidacion
'------------------------------------------------------------------
PeriodoLiquidacion = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    PeriodoLiquidacion = rsConsult!tprocdesc & " " & Right("0" & pliqmes, 2) & " - " & pliqanio
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener el codigo resolucion de la empresa"

EmpResolucion = ""
StrSql = "SELECT estr_cod.nrocod "
StrSql = StrSql & " FROM estr_cod "
StrSql = StrSql & " INNER JOIN tipocod   ON tipocod.tcodnro = estr_cod.tcodnro "
StrSql = StrSql & " WHERE estr_cod.Estrnro = " & EmpEstrnro
StrSql = StrSql & " AND tcodsigla='RES'"
OpenRecordset StrSql, rs_codigo
If Not rs_codigo.EOF Then
    EmpResolucion = rs_codigo("nrocod")
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco columna 136 del confrep para traer un concepto no imprimible o un acumulador "
'------------------------------------------------------------------
Flog.writeline "Buscando columna 136 del confrep para traer un concepto no imprimible o un acumulador "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 136 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   'StrSql = "SELECT dlimonto FROM detliq WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
   StrSql = " SELECT detliq.dlimonto "
   StrSql = StrSql & " FROM detliq "
   StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & rsConsult!confval2
   StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
   StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
   
   OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          Cod136 = 0
        Else
          Cod136 = rsConsult2!dlimonto
        End If
        rsConsult2.Close
Else
    Flog.writeline "Debe configurar el Confrep con el Numero de Columna 136"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu,fpagnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult
 
If Not rsConsult.EOF Then
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = rsConsult!ctabnro
            If rsConsult!fpagnro = 10 Then
                FormaPago = "CA"
            Else
                If rsConsult!fpagnro = 11 Then
                    FormaPago = "CC"
                Else
                    If rsConsult!fpagnro = 9 Or rsConsult!fpagnro = 12 Then
                        FormaPago = " Efectivo o Cheque"
                    End If
                End If
            End If
       Else
            Banco = ""
            Cuenta = ""
            FormaPago = "0"
       End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

Flog.writeline "Banco y Cuenta" & Banco & Cuenta

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1, auxdeci2,auxdeci3, auxchar, auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & PedPago & "'" 'proFecPago
StrSql = StrSql & ",'" & Banco & "'" 'Banco de la Forma de Pago
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & Cuenta & "'" 'Cuenta de la Forma de Pago
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(PeriodoLiquidacion, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ",'" & valor124 & "'"
StrSql = StrSql & ",'" & valor125 & "'"
StrSql = StrSql & ",'" & Cod136 & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ",'" & EmpResolucion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para HB VISION OUTSOURCES a partir del modelo 62 de A.C.A.R.A.
'--------------------------------------------------------------------
Sub generarDatosRecibo134(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim bancoempl As String
Dim cuentaempl As String

    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CatExt
Dim CCosto
Dim FPago

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
If EsNulo(empFecAlta) Then
    StrSql = " SELECT altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
    Else
        rsConsult.Close
        StrSql = " SELECT altfec "
        StrSql = StrSql & " FROM fases "
        StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            empFecAlta = rsConsult!altfec
        Else
            Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
            empFecAlta = "&nbsp;"
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrcodext,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CatExt = rsConsult!estrcodext
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CatExt = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline "Centro de Costo"

Flog.writeline StrSql

If Not rsConsult.EOF Then
   CCosto = rsConsult!estrcodext

Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   CCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline "Sector"

Flog.writeline StrSql

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encuentran datos del Sector."
   Sector = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
If Sueldo = 0 Then
    
    If esSueldoConc Then
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroSueldo
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If

End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " " & rsConsult!Piso & " piso"
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc
   
    Localidad = Direccion
   
'   Localidad = rsConsult!locdesc
'   Flog.writeline "    los datos de la localidad OK"
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,detdom.codigopostal From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio

If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " " & rs_Domicilio!locdesc
    End If
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " " & rs_Domicilio!codigopostal
    End If

End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
' Estaba comentado para el modelo de A.C.A.R.A. se descomento para usar en Hospital Britanico, porque sino no mostraba el logo
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    Flog.writeline StrSql
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    Flog.writeline StrSql
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc,pago.ctabnro,banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

'StrSql = " SELECT * FROM confrep WHERE repnro = 60 AND confnrocol = 80"
OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'    FPago = IIf(EsNulo(rsConsult!conftipo), "", rsConsult!conftipo)
                
    'ErrorDiasTrabajados = False
    'Busco el valor del concepto o acumulador configurado
'    Select Case UCase(FPago)
'            Case "TE"

'                StrSql = " SELECT estrdabr"
'                StrSql = StrSql & " From estructura"
'                StrSql = StrSql & " Where tenro= " & rsConsult!confval
                
'                OpenRecordset StrSql, rsConsult
                
                'FormaPago = rsConsult!estrdabr
'    End Select
'Else
'    StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc,pago.ctabcbu,banco.bandesc"
'    StrSql = StrSql & " From pago"
'    StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'    StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!ctabnro & " " & rsConsult!Bandesc
    Else
        FormaPago = rsConsult!fpagdescabr
    End If
Else
   Flog.writeline "No se encuentran datos de la forma de pago"
   'GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CatExt, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ",'" & CCosto & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & bancoempl & "'"
StrSql = StrSql & ",'" & cuentaempl & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar el recibo Mensual y de Vacaciones para APEX S.A Paraguay
'--------------------------------------------------------------------
Sub generarDatosRecibo135(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String
Dim profecfin As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta
Dim DiasTrabajados
Dim SalarioDiario

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer
Dim Ubicacion As String
Dim Departamento As String
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
Dim Sum_Vacaciones As Long
Dim ColumnasConfrep As String
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim ObraSocial

Dim l_tipoDocPatronal
Dim l_nroPatronal
Dim EmpTernro

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, proceso.profecfin FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

 
'------------------------------------------------------------------
'BUSCO DEL CONFREP EL TIPO DE DOCUMENTO A BUSCAR DE LA EMPRESA - Sebastian Stremel 13/02/2013
StrSql = " SELECT confval FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 200 "
StrSql = StrSql & " AND conftipo = 'DOC'"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    l_tipoDocPatronal = rsConsult!confval
Else
    l_tipoDocPatronal = 0
    Flog.writeline "No esta configurada la columna 200, como tipo de documento "
End If

'------------------------------------------------------------------
 
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If
 
'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
 
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
        
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
 

 


'-----------------------------------------------------------------
'Busco el tipo "VAC" desde el confrep para definir el valor de las vacaciones
'-----------------------------------------------------------------
'Flog.writeline "Busco el tipo VAC desde el confrep para definir el valor de las vacaciones"
'StrSql = " SELECT sum(dlimonto) Vacaciones"
'StrSql = StrSql & " FROM cabliq "
'StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
'StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'StrSql = StrSql & " WHERE  concepto.conccod IN (SELECT confetiq  FROM confrep WHERE repnro = 60 AND  conftipo = 'VAC') "
''StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'OpenRecordset StrSql, rsConsult
'
'Sum_Vacaciones = 0
'
'If Not rsConsult.EOF Then
'   If Not IsNull(rsConsult!Vacaciones) Then
'      Sum_Vacaciones = rsConsult!Vacaciones
'   End If
'Else
' Flog.writeline " No hay ninguna entrada en el confrep con el tipo = VAC"
'End If

'rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los días trabajados
'------------------------------------------------------------------
Flog.writeline "Busco el valor de los días trabajados"
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
Else
    DiasTrabajados = 0
End If

'------------------------------------------------------------------
'Busco el valor del Salario Diario
'------------------------------------------------------------------
Flog.writeline "Busco el valor del Salario Diario"
If ConcSalarioDiario <> "" And Not IsNull(ConcSalarioDiario) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcSalarioDiario & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       SalarioDiario = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener Salario Diario."
       SalarioDiario = 0
    End If
Else
    SalarioDiario = 0
End If
  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline "Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpTernro = rs_estructura!Ternro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If


'---------------------------------------------------------
'OBTENGO EL NRO PATRONAL DE LA EMPRESA
'---------------------------------------------------------
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro =" & l_tipoDocPatronal & ")" & _
'        " Where tercero.ternro =" & EmpTernro
         

StrSql = " SELECT his_estructura.estrnro, ter_doc.nrodoc,estructura.estrdabr "
StrSql = StrSql & " From his_estructura "
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = his_estructura.estrnro "
StrSql = StrSql & " INNER JOIN ter_doc on ter_doc.ternro= sucursal.ternro "
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = sucursal.estrnro "
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND "
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 1"
StrSql = StrSql & " AND ter_doc.tidnro=" & l_tipoDocPatronal
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el nro patronal de la Empresa"
    'Exit Sub
    l_nroPatronal = "  "
Else
    l_nroPatronal = rs_cuit!NroDoc
End If
'---------------------------------------------------------


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
 

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,"
StrSql = StrSql & " empfecalta,"
StrSql = StrSql & " sueldo,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,prodesc,descripcion, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxdeci1,auxchar1, auxchar2, auxchar3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
'StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
'StrSql = StrSql & ",'" & pliqdepant & "'"
'StrSql = StrSql & ",'" & pliqfecdep & "'"
'StrSql = StrSql & ",'" & pliqbco & "'"
'StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
'StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
'StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
'StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
'StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
'StrSql = StrSql & ",'" & ObraSocial & "'"
'StrSql = StrSql & ",'" & Banco & "'"
'StrSql = StrSql & ",'" & nroCuenta & "'"
'StrSql = StrSql & ",'" & Ubicacion & "'"
'StrSql = StrSql & "," & Sum_Vacaciones
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ", '" & DiasTrabajados & "'"
StrSql = StrSql & ", '" & SalarioDiario & "'"
StrSql = StrSql & ", '" & l_nroPatronal & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
'Flog.writeline "Obtengo los datos del los conceptos del empleado"

'Armo parte de la consulta que recupera los Conceptos/Acumuladores que se deberán imprimir (Desde el confrep)
ColumnasConfrep = "Select confval2 from confrep Where confnrocol in (100,101,102,103,104,130,131,132) and repnro = 60"
    
    
 
  StrSql = " SELECT acumulador.acudesabr concabr, acumulador.acunro conccod, acumulador.acunro concnro, "
  StrSql = StrSql & " acumulador.tacunro tconnro,  acumulador.acuimponible concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro, proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio,acu_liq.alcant dlicant, acu_liq.almonto dlimonto, 'AC' Tipo "
  StrSql = StrSql & "     From cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " INNER JOIN acu_liq on acu_liq.cliqnro = cabliq.cliqnro "
  StrSql = StrSql & " INNER JOIN acumulador on acu_liq.acunro = acumulador.acunro AND acumulador.acunro IN (" & ColumnasConfrep & ") "
  'StrSql = StrSql & " INNER JOIN acumulador on acu_liq.acunro = acumulador.acunro AND acumulador.acuimpri=-1"
  StrSql = StrSql & " WHERE cabliq.empleado =  " & Ternro
  StrSql = StrSql & " UNION "
  StrSql = StrSql & " SELECT  concepto.concabr concabr, concepto.conccod conccod, concepto.concnro concnro, concepto.tconnro "
  StrSql = StrSql & " tconnro,  concepto.concimp concimp, "
  StrSql = StrSql & " cabliq.cliqnro, cabliq.pronro,proceso.prodesc, periodo.pliqdesc, "
  StrSql = StrSql & " periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, detliq.dlicant dlicant, detliq.dlimonto dlimonto, 'CO' Tipo "
  StrSql = StrSql & " FROM cabliq "
  StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
  StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
  StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro AND cabliq.empleado =  " & Ternro
  'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro   AND concepto.conccod IN (" & ColumnasConfrep & ") "
  StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro   AND concepto.concimp=-1"
  StrSql = StrSql & " WHERE  cabliq.empleado=  " & Ternro
 
    
    
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



'--------------------------------------------------------------------
' Se encarga de generar los datos para Conexia Colombia
'--------------------------------------------------------------------
Sub generarDatosRecibo136(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim oSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim TipoCuenta As String
Dim Cuenta As String
Dim Banco As String
Dim BancoDesc As String
Dim nroCuenta As String
Dim FondoDePensiones As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Cod121Estructura
Dim Cod126Estructura
Dim grupo
Dim Scc

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
'StrSql = " SELECT cuil.nrodoc "
'StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
'StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   Cuil = rsConsult!Nrodoc
'Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
'End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=4) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columna 126 y 121 para del confrep para imp. adicional y Asig rem"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol = 121 OR confnrocol = 126)"
OpenRecordset StrSql, rsConsult

Cod121Estructura = -1
Cod126Estructura = -1

Do While Not rsConsult.EOF
     Select Case rsConsult!confnrocol
      Case 121
             If rsConsult!conftipo = "ES" Then
                Cod121Estructura = rsConsult!confval
                Flog.writeline "Columna 121: " & rsConsult!conftipo & " Estructura: " & Cod121Estructura
             Else
                Flog.writeline "Columna 121: El tipo de la columna 121 debe ser 'ES' por tratarse de una estructura pero se definió '" & rsConsult!conftipo & "'"
             End If
      Case 126
             If rsConsult!conftipo = "ES" Then
                Cod126Estructura = rsConsult!confval
                Flog.writeline "Columna 126: " & rsConsult!conftipo & " Estructura: " & Cod126Estructura
             Else
                Flog.writeline "Columna 126: El tipo de la columna debe ser 'ES' por tratarse de una estructura pero se definió '" & rsConsult!conftipo & "'"
             End If
   End Select
   rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la columna 121 del confrep para el campo "Grupo"
'------------------------------------------------------------------
grupo = ""

If Cod121Estructura <> -1 Then
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " And his_estructura.tenro = " & Cod121Estructura & " And his_estructura.ternro = " & Ternro
       
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
        grupo = rsConsult!estrdabr
    Else
    '   Flog.writeline "Error al obtener los datos del grupo"
    '   GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la columna 126 del confrep para el campo "Scc"
'------------------------------------------------------------------
Scc = ""

If Cod126Estructura <> -1 Then
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " And his_estructura.tenro = " & Cod126Estructura & " And his_estructura.ternro = " & Ternro
       
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
        Scc = rsConsult!estrdabr
    Else
    '   Flog.writeline "Error al obtener los datos de la columna Scc"
    '   GoTo MError
    End If
End If



'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'JPB - Se quito la condicion (Sueldo=0) para que el sueldo no lo tome de la tabla empleado
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
TipoCuenta = ""
Cuenta = ""

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult
'Forma de Pago: (Estas formas de pago fueron tomadas de la forma de pago de la Base de Test)
'3256 - Cheque
'3255 - Cuenta Corriente
'3254 - Cuenta de Ahorros
'3257 - Efectivo
If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
      ' TipoCuenta = "CBU"
       Cuenta = rsConsult!ctabcbu
       BancoDesc = rsConsult!Bandesc
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
           ' TipoCuenta = "Cta. Nro."
            Cuenta = rsConsult!ctabnro
            BancoDesc = rsConsult!Bandesc
       Else
         '   TipoCuenta = ""
            Cuenta = ""
            BancoDesc = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
  '  TipoCuenta = ""
    Cuenta = ""
    BancoDesc = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social elegida (Entidad Promotora de Salud - Estr. 17)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
oSocial = ""
If Not rsConsult.EOF Then
   oSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos oSocial "
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Fondo de Pensiones (Estructura 15)
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
FondoDePensiones = ""
If Not rsConsult.EOF Then
   FondoDePensiones = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos Fondo de Pensiones "
'   GoTo MError
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If


rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, "
StrSql = StrSql & " auxchar3, auxchar4, auxchar5, auxchar6, auxchar7)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & pliqdesde & "'"
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & TipoCuenta & "'"
StrSql = StrSql & ",'" & BancoDesc & "'"
StrSql = StrSql & ",'" & grupo & "'"
StrSql = StrSql & ",'" & Scc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub
Sub generarDatosRecibo137(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'Se encarga de generar los datos para NGA
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
'Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
'Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias
Dim codRes As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_tdcodnro As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      'Sueldo = 0
   Else
      'Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Dim Arr_AuxcharTE(5) As String
Dim AuxContador As Integer
Dim a As Integer
Dim TituloCol44 As String
Dim tipCodRes As String
AuxContador = 0
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol IN (44,129,130,131,132,133,134,357)"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Do While Not objRs2.EOF
        Select Case Trim(objRs2!conftipo)
            Case "AC":
                'BUSCO EL ACUMULADOR CONFIGURADO EN LA COL. 44
                Titulo = objRs2!confetiq
                TituloCol44 = objRs2!confetiq
                StrSql = " SELECT almonto"
                StrSql = StrSql & " From acu_liq"
                StrSql = StrSql & " Where acunro = " & acunroSueldo
                StrSql = StrSql & " AND cliqnro = " & cliqnro
                Flog.writeline StrSql
                OpenRecordset StrSql, rsConsult
                If Not rsConsult.EOF Then
                    Sueldo = rsConsult!almonto
                Else
                    Flog.writeline "No se obtuvieron datos para el AC configurado en la columna 44"
                    Sueldo = 0
                End If
    
            Case "TE":
                '129,130,131,132,133,134
                Titulo = Trim(objRs2!confetiq)
                
                StrSql = " SELECT estrdabr "
                StrSql = StrSql & " FROM his_estructura"
                StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta)
                StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
                StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
                StrSql = StrSql & " AND his_estructura.tenro= " & objRs2!confval
                OpenRecordset StrSql, rsConsult
                If Not rsConsult.EOF Then
                    Arr_AuxcharTE(AuxContador) = Titulo & "@" & rsConsult!estrdabr
                Else
                    If Titulo <> "" Then
                        Arr_AuxcharTE(AuxContador) = Titulo & "@&nbsp;"
                    Else
                        Arr_AuxcharTE(AuxContador) = "&nbsp;@&nbsp;"
                    End If
                    
                    Flog.writeline "Error al obtener los datos de la estructura: " & objRs2!confnrocol & "(" & Trim(objRs2!confetiq) & ")"
                End If
                AuxContador = AuxContador + 1
            Case "RES":
                tipCodRes = Trim(objRs2!confval)
            Case Else
                Flog.writeline "Error de configuración: Revisar columna " & objRs2!confnrocol
        End Select
        objRs2.MoveNext
    Loop
Else
    Flog.writeline ""
    Flog.writeline "Error de Configuración: Revisar columnas 44,127,128,129,130,131,132,133 y 134"
    Flog.writeline ""
End If

If AuxContador > 0 And AuxContador < 6 Then
    Flog.writeline ""
    Flog.writeline "Error de Configuración: Revisar columnas 44,127,128,129,130,131,132,133 y 134"
    Flog.writeline ""
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo
'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'        Sueldo = rsConsult!almonto
'    Else
'        Flog.writeline "Error al obtener los datos del sueldo"
'        Sueldo = 0
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'    Sector = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos del sector"
'End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'    Categoria = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos de la categoria"
'End If
Categoria = ""

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'Puesto = ""
'If Not rsConsult.EOF Then
'    Puesto = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos del puesto"
'End If
Puesto = ""

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos del centro de costo"
'End If
CentroCosto = ""
'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar el nro de resolucion que se informara en el recibo pdf
StrSql = " select nrocod from estr_cod where estrnro = " & EmpEstrnro & " AND tcodnro = " & tipCodRes
OpenRecordset StrSql, rs_tdcodnro
If rs_tdcodnro.EOF Then
    Flog.writeline "No se encontró el numero de resolucion asociado a la empresa"
    codRes = 0
Else
    If IsNumeric(rs_tdcodnro!nrocod) Then
        codRes = rs_tdcodnro!nrocod
    Else
        Flog.writeline "El numero de resolucion asociado a la empresa no es numerico se informa 0"
        codRes = 0
    End If
End If



'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If



'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " ("
StrSql = StrSql & " bpronro,ternro,pronro"
StrSql = StrSql & " ,apellido,Nombre,direccion,Legajo"
StrSql = StrSql & " ,pliqnro,pliqmes,pliqanio,pliqdepant"
StrSql = StrSql & " ,pliqfecdep,pliqbco,cuil,empfecalta"
StrSql = StrSql & " ,sueldo,categoria,centrocosto,localidad"
StrSql = StrSql & " ,profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma"
StrSql = StrSql & " ,empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto"
StrSql = StrSql & " ,tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden"

StrSql = StrSql & " ,auxchar1, auxchar2, auxchar3, auxchar4, auxchar5"

StrSql = StrSql & " ,auxchar6, auxchar7, auxchar8, auxchar9, auxchar"

StrSql = StrSql & " ,auxdeci1"

StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'" 'auxchar1
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'" 'auxchar2
StrSql = StrSql & " ,'" & LugarDePago & "'" 'auxchar3
'StrSql = StrSql & " ,'" & Titulo & "'" 'auxchar4
StrSql = StrSql & " ,'" & TituloCol44 & "'" 'auxchar4


'StrSql = StrSql & " ,'" & Datos & "'"  'auxchar5
'Auxchar 4 al 9
For a = 0 To UBound(Arr_AuxcharTE)
    If Arr_AuxcharTE(a) = "@" Or Arr_AuxcharTE(a) = "" Then
        StrSql = StrSql & " ,'&nbsp;@&nbsp;'"
    Else
        StrSql = StrSql & " ,'" & Arr_AuxcharTE(a) & "'"
    End If
Next

StrSql = StrSql & " ," & codRes  'auxdeci1
'StrSql = StrSql & " ," & NetoTalon 'auxdeci1
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------
Flog.writeline ""
Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

If rs_Fases.State = adStateOpen Then rs_Fases.Close
If rsConsult.State = adStateOpen Then rsConsult.Close
If rsConsult2.State = adStateOpen Then rsConsult2.Close
If rs_estructura.State = adStateOpen Then rs_estructura.Close
If rs_Domicilio.State = adStateOpen Then rs_Domicilio.Close
If rs_cuit.State = adStateOpen Then rs_cuit.Close

If rs_logo.State = adStateOpen Then rs_logo.Close
If rs_tdcodnro.State = adStateOpen Then rs_tdcodnro.Close
If rs_firma.State = adStateOpen Then rs_firma.Close


Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Diaz a partir del 21-12-2012
'--------------------------------------------------------------------
Sub generarDatosRecibo138(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'24/05/2012 - Gonzalez Nicolás - Se toma como válida de la tabla empleado la fecha de ingreso de un empleado.
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim diasHab_aux As Integer

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_pago As New ADODB.Recordset
Dim rs_formapago As New ADODB.Recordset
Dim rs_cuenta As New ADODB.Recordset

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim estrConvenio1 As Integer
Dim estrConvenio2 As Integer
Dim acumulador As Long

Dim LugarPago
Dim Banco
Dim Cuenta

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 138"

'---------------------------------------------------------------------------------------
'Busco los datos de las estructuras y el acumulador asociado para calcular la antiguedad
'---------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 117 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    estrConvenio1 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio1 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio1 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la primer estructura."
    End If
End If
rsConsult.Close

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 118 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    estrConvenio2 = 0
Else
    If rsConsult!conftipo = "EST" Then
        estrConvenio2 = rsConsult!confval
        acumulador = rsConsult!confval2
    Else
        estrConvenio2 = 0
        Flog.writeline "No esta configurado el ConfRep para el Tipo de estructura 19, para la segunda estructura."
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'empFecAlta = rsConsult!altfec NG - 24/05/2012
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    'empFecAlta = " " NG - 24/05/2012
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------------------------------------------------
' Calculo la antiguedad si el empleado no tiene las estructuras configuradas en el confrep,
' se calcula segun el alta, sino mediante el acumulador configurado
'------------------------------------------------------------------------------------------------------------
Antiguedad = 0

Flog.writeline "Chequeo que el empleado tenga al menos una de las 2 estructuras configuradas en el confrep"
StrSql = " SELECT estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " WHERE  ( htetdesde <= " & ConvFecha(pliqdesde) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqdesde) & ") "
StrSql = StrSql & " OR htetdesde >= " & ConvFecha(pliqdesde) & " And (htetdesde <= " & ConvFecha(pliqhasta) & "))"
StrSql = StrSql & " And tenro = 19  and ternro = " & Ternro & " And (estrnro = " & estrConvenio1 & " or estrnro = " & estrConvenio2 & ") "

       
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "Calculo la antiguedad, por medio de la fase, el empleado no tiene estructuras configuradas en confrep"
    Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
    Fecha_aux = DateAdd("m", 1, Fecha_aux)
    Fecha_aux = DateAdd("d", -1, Fecha_aux)
    
    If Fecha_aux < empFecAlta Then
        Antiguedad = "0 año/s 0 mes/ses"
    Else
        Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
        Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
    End If
Else
    Flog.writeline "Calculo la antiguedad, por medio del acumulador configurado en confrep"
    'StrSql = " SELECT sum(acu_liq.almonto) monto "
    'StrSql = StrSql & " FROM periodo "
    'StrSql = StrSql & " INNER JOIN proceso ON periodo.pliqnro = proceso.pliqnro " ' and pronro = " & Pronro
    'StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro"
    'StrSql = StrSql & " INNER JOIN acu_liq ON cabliq.cliqnro = acu_liq.cliqnro"
    'StrSql = StrSql & " WHERE cabliq.Empleado = " & Ternro
    'StrSql = StrSql & " AND periodo.pliqmes <= " & pliqmes
    'StrSql = StrSql & " AND periodo.pliqanio <= " & pliqanio
    'StrSql = StrSql & " AND acu_liq.acunro = " & acumulador
    StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
    StrSql = StrSql & " WHERE amanio < " & pliqanio
    StrSql = StrSql & " AND acunro = " & acumulador
    StrSql = StrSql & " AND ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    totalParcialAntiguedad = 0
    If Not rsConsult.EOF Then
       If EsNulo(rsConsult!Monto) Then
           totalParcialAntiguedad = 0
       Else
           totalParcialAntiguedad = CDbl(rsConsult!Monto)
       End If
       
       StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
       StrSql = StrSql & " WHERE amanio = " & pliqanio
       StrSql = StrSql & " AND ammes <= " & pliqmes
       StrSql = StrSql & " AND acunro = " & acumulador
       StrSql = StrSql & " AND ternro = " & Ternro
       OpenRecordset StrSql, rs_aux
       If Not rs_aux.EOF Then
           If Not EsNulo(rs_aux!Monto) Then
               totalParcialAntiguedad = CDbl(totalParcialAntiguedad) + CDbl(rs_aux!Monto)
           End If
       End If
       Antiguedad = CStr(totalParcialAntiguedad) & " Días"
    Else
    '   Flog.writeline "Error al obtener los datos del cuil"
    '   GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
    Sueldo = Replace(Sueldo, ",", ".")
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 53 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 53 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   Flog.writeline "No se encuentran datos de la Estructura Modalidad 53"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
StrSql = StrSql & " And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Sucursal
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Busco los datos de la forma de pago"
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
'End If

'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rs_pago

Flog.writeline "Lugar de Pago" & StrSql
   
If Not rs_pago.EOF Then
   LugarPago = rs_pago!estrdabr
   Flog.writeline "    los datos del Lugar de Pago OK"
Else
   Flog.writeline "Error al obtener los datos del Lugar de Pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rs_cuenta
 
If Not rs_cuenta.EOF Then
   If Not EsNulo(rs_cuenta!ctabcbu) Then
       Banco = rs_cuenta!Bandesc
       Cuenta = "CBU " & rs_cuenta!ctabcbu
   Else
       If Not EsNulo(rs_cuenta!ctabnro) Then
            Banco = rs_cuenta!Bandesc
            Cuenta = "Cta. Nro. " & rs_cuenta!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

Flog.writeline "Banco y Cuenta" & Banco & Cuenta

'------------------------------------------------------------------
'Busco Forma de Pago
'------------------------------------------------------------------
StrSql = " SELECT fpagnro "
StrSql = StrSql & " FROM pago"
StrSql = StrSql & " WHERE ternro=" & Ternro
       
OpenRecordset StrSql, rs_formapago

Flog.writeline "Forma de Pago" & StrSql

FormaPago = " "

If Not rs_formapago.EOF Then
   If rs_formapago!fpagnro = 10 Then
        FormaPago = "CA"
   Else
        If rs_formapago!fpagnro = 9 Or rs_formapago!fpagnro = 12 Then
            FormaPago = " Efectivo o Cheque"
        End If
   End If
   Flog.writeline "    los datos de Forma de Pago OK"
Else
   Flog.writeline "Error al obtener los datos de Forma de Pago"
'   GoTo MError
End If

Flog.writeline "Forma Pago" & FormaPago

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
'StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CDA
'--------------------------------------------------------------------
Sub generarDatosRecibo139(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto
Dim BancoPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim AntigGrilla
Dim salir
Dim Contrato
Dim area

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso de liquidación."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual de Liquidación."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fasrecofec = -1 AND empleado= " & Ternro '& " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado. Se obtiene de la fase marcada como Fecha Alta Reconocida."
    empFecAlta = "&nbsp;"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------

'Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = CDate(pliqhasta)


If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil, tipo de documento 10."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento, tipo menor o igual a 5."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
   Contrato = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Area
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 120 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   area = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Estructura Area."
   area = " "
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado (Lugar de Pago)."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Básico. Se debe configurar en la columna 1 del confrep."
   Sueldo = 0
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
    BancoPago = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    BancoPago = "&nbsp;"
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. Tiene que estar generado el pedido de pago previamente."
   FormaPago = "&nbsp;"
   BancoPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa asociada al empleado."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró la Firma de la Empresa, tipo de imagen 2."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(area, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & Mid(BancoPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Ecuador
'--------------------------------------------------------------------

Sub generarDatosRecibo140(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim pliqdesde
Dim cuentaempl
Dim DatosCBO

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsconfrep As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

bancoempl = ""
cuentaempl = ""

If Not rsConsult.EOF Then
   bancoempl = rsConsult!Bandesc
   cuentaempl = rsConsult!ctabnro
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------- Rafa 06-08-2013 ----------------------------------------------------------------------

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------

StrSql = " SELECT ctabnro,bandesc,formapago.fpagnro FROM ctabancaria "
StrSql = StrSql & " LEFT JOIN formapago on formapago.fpagnro = ctabancaria.fpagnro "
StrSql = StrSql & " LEFT JOIN banco on banco.ternro = ctabancaria.banco "
StrSql = StrSql & " WHERE ctabancaria.Ternro = " & Ternro & " AND ctabestado = -1 "
  
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagnro = "2" Then
    FormaPago = rsConsult!Bandesc & "AH" & rsConsult!ctabnro
  Else
    If rsConsult!fpagnro = "3" Then
        FormaPago = rsConsult!Bandesc & "CC" & rsConsult!ctabnro
    Else
        FormaPago = rsConsult!Bandesc & " " & rsConsult!ctabnro
    End If
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago"
   Flog.writeline StrSql
'   GoTo MError
End If

rsConsult.Close

'-------------------------------' Busco el codigo de Estructura en el confrep '-----------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 241 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosCBO = rsConsult!estrdabr
    Else
       DatosCBO = " "
       Flog.writeline "No se encontraron datos en el confrep para el CBO"
    '   GoTo MError
    End If
End If
rsConsult.Close
rsconfrep.Close

'--------------------------------------------------------------------------------------------------------------------------

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, auxchar3, orden,auxchar4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & ",'" & pliqdesde & "'"
StrSql = StrSql & ",'" & cuentaempl & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & DatosCBO & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Function controlNull(Str)
   If IsNull(Str) Then
      controlNull = 0
   Else
      If Trim(Str) = "" Then
         controlNull = 0
      Else
         controlNull = CDbl(Str)
      End If
   End If
End Function 'controlNull(str)

Function BuscarGanancia(Pronro, Ternro)

    Dim rsResult As New ADODB.Recordset
    Dim StrSql As String
    Dim l_filas(100) As Long
    Dim l_tope(100) As Double
    Dim l_i
    Dim l_rubro1 As Double
    Dim l_rubro2 As Double
    Dim l_rubro3 As Double
    Dim l_rubro5 As Double
    Dim l_rubro6 As Double
    Dim l_resultado_neto As Double
    Dim l_modelo_proc As Long
    Dim l_profecpago
    Dim l_ganancias As Double
    
    l_rubro1 = 0
    l_rubro3 = 0
    l_rubro5 = 0
    l_ganancias = 0
        
        
    '-----------------------------------------------------------------------
    'Inicializo los arreglos
    '-----------------------------------------------------------------------
    Flog.writeline "Inicializo los arreglos"
    For l_i = 0 To 100
       l_filas(l_i) = 0
       l_tope(l_i) = 0
    Next
    
    '-----------------------------------------------------------------------
    'Busco config del confrep
    '-----------------------------------------------------------------------
    StrSql = "SELECT  repnro, confnrocol, confetiq, confval "
    StrSql = StrSql & "FROM confrep "
    StrSql = StrSql & "WHERE repnro = 114 "
    StrSql = StrSql & "AND confnrocol > 1 "
    StrSql = StrSql & "AND confnrocol < 100 "
    StrSql = StrSql & "AND conftipo = 'ITM' "
    StrSql = StrSql & "ORDER BY confnrocol"
    Flog.writeline "Busco la configuracion del confrep del reporte de ganancias"
    OpenRecordset StrSql, rsResult
    
    If Not rsResult.EOF Then
        Do While Not rsResult.EOF
            l_filas(CLng(rsResult("confnrocol")) - 1) = rsResult("confval")
            rsResult.MoveNext
        Loop
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Ganancia Neta."
        BuscarGanancia = l_ganancias
    End If
    rsResult.Close

    '-----------------------------------------------------------------------
    'Busco los valores de los topes de los items
    '-----------------------------------------------------------------------
    StrSql = " SELECT * "
    StrSql = StrSql & " FROM traza_gan_item_top "
    StrSql = StrSql & " WHERE ternro = " & Ternro
    StrSql = StrSql & "   AND pronro = " & Pronro
    Flog.writeline "Busco los valores de los topes de los items sql = " & StrSql
    OpenRecordset StrSql, rsResult
    
    Do Until rsResult.EOF
       l_tope(CLng(rsResult("itenro"))) = controlNull(rsResult("monto"))
       rsResult.MoveNext
    Loop
    rsResult.Close
    
    'Busco el valor del rubro 1
    l_rubro1 = CDbl(l_tope(CLng(l_filas(1)))) + CDbl(l_tope(CLng(l_filas(2)))) + CDbl(l_tope(CLng(l_filas(3))))
    Flog.writeline "Obtengo el valor del rubro 1 = " & l_rubro1
    
    'Busco el valor del rubro 2
    l_rubro2 = 0
    For l_i = 4 To 13
        l_rubro2 = l_rubro2 + Abs(CDbl(l_tope(CLng(l_filas(l_i)))))
    Next
    Flog.writeline "Obtengo el valor del rubro 2 = " & l_rubro2
    
    'Busco el resultado del neto
    l_resultado_neto = l_rubro1 - l_rubro2
    Flog.writeline "Obtengo el valor del resultado del neto=" & l_resultado_neto
    
    'Busco el valor del rubro 3
    l_rubro3 = (l_resultado_neto) - Abs(CDbl(l_tope(CLng(l_filas(14))))) - Abs(CDbl(l_tope(CLng(l_filas(15)))))
    Flog.writeline "Obtengo el valor del rubro 2 = " & l_rubro2
    
    'Busco el valor del rubro 5
    l_rubro5 = l_rubro3 - Abs(CDbl(l_tope(CLng(l_filas(16)))))
    Flog.writeline "Obtengo el valor del rubro 5 = " & l_rubro5
    
    'Busco el valor del rubro 6
    
    If CDbl(l_rubro5) > 0 Then
      
        'Busco el modelo del proceso
        StrSql = " SELECT proceso.*,tipoproc.final FROM proceso"
        StrSql = StrSql & " INNER JOIN  tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
        StrSql = StrSql & " WHERE pronro = " & Pronro
        Flog.writeline "Busco el modelo del proceso"
        OpenRecordset StrSql, rsResult
        
        If Not rsResult.EOF Then
           l_modelo_proc = rsResult("tprocnro")
           l_profecpago = rsResult("profecpago")
        End If
        rsResult.Close
      
      
        'Busco la escala
        l_escala_ded_porc = 0
        
        StrSql = " SELECT esd_porcentaje "
        StrSql = StrSql & " FROM escala_ded "
        'Si es una liquidacion final la considero a diciembre
        If CLng(l_modelo_proc) = 5 Or CLng(l_modelo_proc) = 10 Then
           StrSql = StrSql & " WHERE esd_topeinf <= " & Int(controlNull(l_rubro5))
           StrSql = StrSql & "   AND esd_topesup >= " & Int(controlNull(l_rubro5))
        Else
           StrSql = StrSql & " WHERE esd_topeinf <= " & Int((controlNull(l_rubro5) / Month(l_profecpago)) * 12)
           StrSql = StrSql & "   AND esd_topesup >= " & Int((controlNull(l_rubro5) / Month(l_profecpago)) * 12)
        End If
        Flog.writeline "Busco la escala"
        OpenRecordset StrSql, rsResult
        
        If Not rsResult.EOF Then
            l_escala_ded_porc = rsResult("esd_porcentaje")
        End If
        
        rsResult.Close
    
    End If
    
    
    l_rubro6 = 0
    For l_i = 17 To 21
        l_rubro6 = l_rubro6 + Abs(CDbl(l_tope(CLng(l_filas(l_i)))))
    Next
    l_rubro6 = l_rubro6 * CDbl(l_escala_ded_porc) / 100
    Flog.writeline "Obtengo el valor del rubro 6 = " & l_rubro6
    
    
    l_ganancias = CDbl(l_rubro5) - CDbl(l_rubro6)
    Flog.writeline "Obtengo el valor de ganancia = " & l_ganancias
    
    BuscarGanancia = l_ganancias
    
End Function

Sub generarDatosRecibo141(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo Horwath Litoral - AMR
'Fecha Creacion: 04-04-2013
'Autor: Carlos Masson
'Se utilizo el modelo 117 como base
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Convenio 'FMD
Dim GananciaNeta
Dim Retenciones
Dim proFecPago
Dim pliqhasta
Dim FormaPago
'Dim Puesto 'FMD
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim Banco As String
Dim empFecAltaReal
Dim SueldoSAC
Dim SNyHabitual


Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim Departamento

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec


Dim teFormaLiquidacion As Integer
Dim formaLiquidacion As String
Dim LocalidadEmpresa As String

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

teFormaLiquidacion = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 141."

'------------------------------------------------------------------
'Levanto datos del confrep
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol=382 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    teFormaLiquidacion = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
    Flog.writeline "Tipo d estructura forma de liquidacion configurada: " & teFormaLiquidacion
Else
    Flog.writeline "No se encontro configurado el Tipo de Estructura Forma de liquidacion, columna 382"
End If
rsConsult.Close
'------------------------------------------------------------------

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
'   Flog.writeline "Datos del empleado obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del domicilio del empleado
'------------------------------------------------------------------
StrSql = " SELECT * From cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE domdefault =-1 and ternro= " & Ternro

Flog.writeline "Buscando el domicilio del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error el empleado no tiene un domicilio marcado como principal"
   Direccion = ""
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
'    Flog.writeline "Datos del periodo de liquidacion obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
'   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

''------------------------------------------------------------------
''Busco la Ganancia Neta
''------------------------------------------------------------------
'StrSql = "Select ganneta from traza_gan "
'StrSql = StrSql & " Where Pronro = " & Pronro
'StrSql = StrSql & " and ternro = " & Ternro
'StrSql = StrSql & " and ganneta is not null"
'
'Flog.writeline "Buscando la Ganancia Neta"
'OpenRecordset StrSql, rsConsult
'
'GananciaNeta = "0"
'If Not rsConsult.EOF Then
'    GananciaNeta = rsConsult!ganneta
'Else
'   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Ganancia Neta."
'End If
'rsConsult.Close

'Agregado el 01/04/2014
Flog.writeline "Buscando la Ganancia Neta"
GananciaNeta = BuscarGanancia(Pronro, Ternro)

'------------------------------------------------------------------
'Busco las Retenciones Anteriores
'------------------------------------------------------------------
StrSql = "Select retenciones from traza_gan "
StrSql = StrSql & " Where Pronro = " & Pronro
StrSql = StrSql & " and ternro = " & Ternro
StrSql = StrSql & " and ganneta is not null"
     
Flog.writeline "Buscando las Retenciones Anteriores"
OpenRecordset StrSql, rsConsult

Retenciones = "0"
If Not rsConsult.EOF Then
    Retenciones = rsConsult!Retenciones
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Ganancia Neta."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Departamento
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 9 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos Departamento"
OpenRecordset StrSql, rsConsult

Departamento = "&nbsp;"
If Not rsConsult.EOF Then
   Departamento = rsConsult!estrdabr
'   Flog.writeline "Datos de Departamento obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de Departamento."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Convenio"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
'   Flog.writeline "Datos del Convenio obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la Categoria"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
'    Flog.writeline "Datos de la Categoria obtenida"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la forma de liquidacion del empleado
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & teFormaLiquidacion & " And his_estructura.ternro = " & Ternro
Flog.writeline "Buscando los datos de la forma de liquidacion"
OpenRecordset StrSql, rsConsult
formaLiquidacion = ""
If Not rsConsult.EOF Then
    formaLiquidacion = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
    Flog.writeline "Datos de la forma de liquidacion obtenido: " & formaLiquidacion
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la forma de liquidacion del empleado."
End If
rsConsult.Close
'--------------------------------------------------------------------

'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la Obra Social"
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
'    Flog.writeline "Datos de la Obra Social obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Contrato"
OpenRecordset StrSql, rsConsult

Contrato = "&nbsp;"
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
'    Flog.writeline "Datos del Contrato obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Sueldo Basico. Verificar la columna 1 del confrep"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco Forma de Pago
'------------------------------------------------------------------
StrSql = " SELECT fpagnro "
StrSql = StrSql & " FROM pago"
StrSql = StrSql & " WHERE ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

Flog.writeline "Forma de Pago" & StrSql

FormaPago = " "

If Not rsConsult.EOF Then
   If rsConsult!fpagnro = 10 Then
        FormaPago = "CA"
   Else
        If rsConsult!fpagnro = 11 Then
            FormaPago = "CC"
        End If
   End If
   Flog.writeline "    los datos de Forma de Pago OK"
Else
   Flog.writeline "Error al obtener los datos de Forma de Pago"
'   GoTo MError
End If

Flog.writeline "Forma Pago" & FormaPago

rsConsult.Close



'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
    LocalidadEmpresa = ""
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    LocalidadEmpresa = IIf(EsNulo(rs_Domicilio!locdesc), "", rs_Domicilio!locdesc)
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la fecha de alta de fase activa
'------------------------------------------------------------------
empFecAltaReal = Null
StrSql = "SELECT fases.fasnro, fases.altfec, fases.bajfec, fases.fasrecofec"
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " AND fases.bajfec is null  "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaReal = rsConsult!altfec
Else
   'Flog.Writeline "Error al obtener los datos del empleado"
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
    empFecAltaRec = ""
    'GoTo MError
End If
If empFecAltaRec = "" Then
    'El empleado no tiene fecha de alta reconocida, por lo que busco la fecha desde
    'de la primera de sus fases
    rsConsult.Close
    StrSql = " SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "Error al obtener la Fecha de Alta de la primer fase del Empleado"
        empFecAltaRec = ""
        'GoTo MError
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del Sualdo para SAC
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador del sueldo para SAC"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 6)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SueldoSAC = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SueldoSAC = 0
       'GoTo MError
    End If
    
    
'------------------------------------------------------------------
'Busco el valor del S.N.y Habitual
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador para S.N.y Habiutual"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 137)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SNyHabitual = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador S.N.y Habiutual"
       SNyHabitual = 0
       'GoTo MError
    End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,auxchar6,"
StrSql = StrSql & " sueldo,categoria,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxchar7, auxchar8, auxchar9)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
'StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltaReal & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Departamento, 1, 100) & "'"
StrSql = StrSql & "," & GananciaNeta
StrSql = StrSql & "," & Retenciones
StrSql = StrSql & "," & SueldoSAC
StrSql = StrSql & "," & SNyHabitual
StrSql = StrSql & ",'" & Mid(formaLiquidacion, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LocalidadEmpresa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Convenio, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'------------------------------------------------------------------
'distribucion de utilidades
'------------------------------------------------------------------
Sub generarDatosRecibo142(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset


'variables para el insert
Dim Apellido As String
Dim Nombre As String
Dim cliqnro As Long
Dim proFecPago As String
Dim profecini As String
Dim proDesc As String
Dim proFecPlaneada As String

Dim pliqnro As Long
Dim pliqmes As Integer
Dim pliqanio As Integer
Dim pliqhasta As Long
Dim pliqdesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim dividendos As String
Dim porcentaje As String
Dim diasTotales As String
Dim diasEmpleado As String
Dim remEmpleado As String
Dim RemTotal As String
Dim formulaA As String
Dim formulaB As String


Dim Valordividendos As Double
Dim Valorporcentaje As Integer
Dim ValordiasTotales As Long
Dim ValordiasEmpleado As Long
Dim ValorremEmpleado As Double
Dim ValorremTotal As Double
Dim ValorformulaA As Double
Dim ValorformulaB As Double

Dim NroDoc As String
Dim EmpNombre As String
Dim EmpEstrnro As Long
Dim EmpCuit As String
Dim EmpDire As String
Dim EmpTernro As Long
Dim cod_ruc As String

Dim repLegal As String
Dim ternroRepLegal As Long

Dim esConceptoTope As Boolean
Dim codTope As String

Dim esConceptoFondoempleo As Boolean
Dim codFondoempleo As String

Dim ValorTope As Double
Dim ValorFondoempleo As Double

Dim Localidad As String

'inicializo las variables del confrep por si no se configura alguna columna
cod_ruc = 0
dividendos = "0"
porcentaje = "0"
diasTotales = "0"
diasEmpleado = "0"
remEmpleado = "0"
RemTotal = "0"
formulaA = "0"
formulaB = "0"
esConceptoTope = True
codTope = "0"
esConceptoFondoempleo = True
codFondoempleo = "0"
'hasta aca

'LEVANTO DEL CONFREP LOS VALORES PARA OBTENER LOS DATOS DE LA LIQUIDACION (HORAS-DIAS TRABAJADOS-FAMILIARES)
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE conftipo='UTI'"
StrSql = StrSql & " AND repnro=60"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do While Not rsConsult.EOF
        'levanto datos del confrep
        Select Case rsConsult!confnrocol
            Case 210: 'RUC  de la empresa
                cod_ruc = IIf(Not EsNulo(rsConsult!confval), rsConsult!confval, "0")
            Case 211: 'Dividendos
                dividendos = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 212: 'Porcentaje
                porcentaje = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 213: 'Dias Totales Trabajados
                diasTotales = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 214: 'Dias Empleado Trabajado
                diasEmpleado = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 215: 'Remuneracion del Empleado
                remEmpleado = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 216: 'Remuneracion Total
                RemTotal = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 217: 'Formula A
                formulaA = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 218: 'Formula B
                formulaB = IIf(Not EsNulo(rsConsult!confval2), rsConsult!confval2, "0")
            Case 219: 'tope 18 remuneraciones
                If (rsConsult!confval2 <> "0" And rsConsult!confval2 <> "" And Not EsNulo(rsConsult!confval2)) Then
                    esConceptoTope = True
                    codTope = rsConsult!confval2
                Else
                    If (rsConsult!confval <> "0" And rsConsult!confval <> "" And Not EsNulo(rsConsult!confval)) Then
                        esConceptoTope = False
                        codTope = rsConsult!confval
                    Else
                        codTope = 0
                    End If
                End If
            Case 220: 'fondoempleo
                If (rsConsult!confval2 <> "0" And rsConsult!confval2 <> "" And Not EsNulo(rsConsult!confval2)) Then
                    esConceptoFondoempleo = True
                    codFondoempleo = rsConsult!confval2
                Else
                    If (rsConsult!confval <> "0" And rsConsult!confval <> "" And Not EsNulo(rsConsult!confval)) Then
                        esConceptoFondoempleo = False
                        codFondoempleo = rsConsult!confval
                    Else
                        codFondoempleo = 0
                    End If
                End If
        End Select
    rsConsult.MoveNext
    Loop
Else
    Flog.writeline " No esta configurado el confrep"
End If
rsConsult.Close
'HASTA ACA


'BUSCO EL APELLIDO Y EL NOMBRE DEL EMPLEADO
StrSql = "SELECT ternom, terape, ternom2, terape2, empleg "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not EsNulo(rsConsult!ternom2) Then
        Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Else
        Nombre = rsConsult!ternom
    End If
    
    If Not EsNulo(rsConsult!terape2) Then
        Apellido = rsConsult!terape & " " & rsConsult!terape2
    Else
        Apellido = rsConsult!terape
    End If
    
    Legajo = rsConsult!empleg
    
Else
    Flog.writeline "No se encontro el empleado"
    GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro <=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento, tipo <= 5 "
   NroDoc = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso de liquidación."
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual de Liquidación."
   GoTo MError
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empterrepleg " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rsConsult
EmpEstrnro = 0
If rsConsult.EOF Then
    Flog.writeline "No se encontró la Empresa asociada al empleado."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = IIf(EsNulo(rsConsult!empnom), "", rsConsult!empnom)
    EmpEstrnro = IIf(EsNulo(rsConsult!Estrnro), "", rsConsult!Estrnro)
    EmpTernro = IIf(EsNulo(rsConsult!Ternro), "", rsConsult!Ternro)
    ternroRepLegal = IIf(EsNulo(rsConsult!empterrepleg), 0, rsConsult!empterrepleg)
End If
rsConsult.Close

'---------------------------------------------------------------
'BUSCO EL NOMBRE DEL REPRESENTANTE LEGAL
StrSql = " SELECT ternom, ternom2, terape, terape2 "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " WHERE ternro=" & ternroRepLegal
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not EsNulo(rsConsult!ternom2) Then
        repLegal = rsConsult!ternom & " " & rsConsult!ternom2 & ", "
    Else
        repLegal = rsConsult!ternom & ", "
    End If
    
    If Not EsNulo(rsConsult!terape2) Then
        repLegal = repLegal & rsConsult!terape & " " & rsConsult!terape2
    Else
        repLegal = repLegal & rsConsult!terape
    End If
Else
    repLegal = ""
    Flog.writeline "No se encontraron los datos del representante legal"
End If
rsConsult.Close
'---------------------------------------------------------------

'---------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
'---------------------------------------------------------------
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & cod_ruc & ")" & _
         " Where tercero.ternro =" & EmpTernro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rsConsult!NroDoc
End If
rsConsult.Close

'------------------------------------------------------
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & EmpTernro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
    Localidad = ""
Else
    EmpDire = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    Localidad = rsConsult!locdesc
    
End If
rsConsult.Close
'------------------------------------------------------

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If






'--------------------------------------------------------------------
'BUSCO LOS DIVIDENDOS
If dividendos <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & dividendos
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            Valordividendos = rsConsult!dlimonto
        Else
            Valordividendos = 0
        End If
        Flog.writeline "El valor de los dividendos es: " & Valordividendos
    Else
        Valordividendos = 0
        Flog.writeline "No se encontro valor para los dividendos"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep los dividendos "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO EL PORCENTAJE DE DISTRIBUCION
If porcentaje <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & porcentaje
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            Valorporcentaje = rsConsult!dlimonto
        Else
            Valorporcentaje = 0
        End If
        Flog.writeline "El valor de los porcentajes es: " & Valorporcentaje
    Else
        Valorporcentaje = 0
        Flog.writeline "No se encontro valor para el porcentaje"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep el porcentaje "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LOS DIAS TOTALES TRABAJADOS
If diasTotales <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & diasTotales
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValordiasTotales = rsConsult!dlimonto
        Else
            ValordiasTotales = 0
        End If
        Flog.writeline "El valor de los dias totales trabajados es: " & ValordiasTotales
    Else
        ValordiasTotales = 0
        Flog.writeline "No se encontro valor de los dias totales trabajados"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep los dias totales trabajados "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LOS DIAS TRABAJADOS POR EL EMPLEADO
If diasEmpleado <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & diasEmpleado
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValordiasEmpleado = rsConsult!dlimonto
        Else
            ValordiasEmpleado = 0
        End If
        Flog.writeline "El valor de los dias totales trabajados por el empleado es: " & ValordiasEmpleado
    Else
        ValordiasEmpleado = 0
        Flog.writeline "No se encontro valor de los dias trabajados por el empleado"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep los dias trabajados por el empleado "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LA REMUNERACION DEL EMPLEADO
If remEmpleado <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & remEmpleado
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValorremEmpleado = rsConsult!dlimonto
        Else
            ValorremEmpleado = 0
        End If
        Flog.writeline "El valor de la remuneracion del empleado es: " & ValorremEmpleado
    Else
        ValordiasEmpleado = 0
        Flog.writeline "No se encontro valor de la remuneracion del empleado"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep la remuneracion del empleado "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LA REMUNERACION TOTAL
If RemTotal <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & RemTotal
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValorremTotal = rsConsult!dlimonto
        Else
            ValorremTotal = 0
        End If
        Flog.writeline "El valor de la remuneracion total es: " & ValorremTotal
    Else
        ValorremTotal = 0
        Flog.writeline "No se encontro valor de la remuneracion total"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep la remuneracion total "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LA FORMULA A
If formulaA <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & formulaA
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValorformulaA = rsConsult!dlimonto
        Else
            ValorformulaA = 0
        End If
        Flog.writeline "El valor de la formula A es: " & ValorformulaA
    Else
        ValorformulaA = 0
        Flog.writeline "No se encontro valor de la formula A"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep la formula A "
End If
'--------------------------------------------------------------------


'--------------------------------------------------------------------
'BUSCO LA FORMULA B
If formulaB <> "0" Then
    Flog.writeline "Buscando los dividendos de la empresa "
    StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & formulaB
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not EsNulo(rsConsult!dlimonto) Then
            ValorformulaB = rsConsult!dlimonto
        Else
            ValorformulaB = 0
        End If
        Flog.writeline "El valor de la formula B es: " & ValorformulaB
    Else
        ValorformulaB = 0
        Flog.writeline "No se encontro valor de la formula B"
    End If
    rsConsult.Close
Else
    Flog.writeline " No esta configurado en el confrep la formula B "
End If
'--------------------------------------------------------------------

'--------------------------------------------------------------------
'BUSCO EL TOPE DE 18 REMUNERACIONES DEL TRABAJADOR
If esConceptoTope Then
    If (Not EsNulo(codTope)) Then
        Flog.writeline "Buscando el tope de 18 remuneraciones del empleado (CO) "
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & codTope
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!Valor) Then
                ValorTope = rsConsult!Valor
            Else
                ValorTope = 0
            End If
            Flog.writeline "El valor del tope de 18 remuneraciones es: " & ValorTope
        Else
            ValorTope = 0
            Flog.writeline "No se encontro valor del tope de 18 remuneraciones"
        End If
        rsConsult.Close
    End If
Else
    If Not esConceptoTope Then
        If (Not EsNulo(codTope)) Then
            Flog.writeline "Buscando el tope de 18 remuneraciones del empleado (AC) "
            StrSql = " SELECT acu_liq.almonto valor"
            StrSql = StrSql & " FROM cabliq "
            StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
            StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
            StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro
            StrSql = StrSql & " WHERE acu_liq.acunro=" & codTope
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                If Not EsNulo(rsConsult!Valor) Then
                    ValorTope = rsConsult!Valor
                Else
                    ValorTope = 0
                End If
                Flog.writeline "El valor del tope de 18 remuneraciones es: " & ValorTope
            Else
                ValorTope = 0
                Flog.writeline "No se encontro valor del tope de 18 remuneraciones"
            End If
            rsConsult.Close
        End If
    Else
        Flog.writeline " No esta configurado en el confrep el tope de 18 remuneraciones "
    End If
End If
'--------------------------------------------------------------------

'--------------------------------------------------------------------
'BUSCO EL FONDOEMPLEO
If esConceptoFondoempleo Then
    If (Not EsNulo(codFondoempleo)) Then
        Flog.writeline "Buscando fondoempleo del empleado (CO) "
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
        StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod =" & codFondoempleo
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!Valor) Then
                ValorFondoempleo = rsConsult!Valor
            Else
                ValorFondoempleo = 0
            End If
            Flog.writeline "El valor del fondoempleo es: " & ValorTope
        Else
            ValorFondoempleo = 0
            Flog.writeline "No se encontro el valor de fondoempleo"
        End If
        rsConsult.Close
    End If
Else
    If Not esConceptoFondoempleo Then
        If Not EsNulo(codFondoempleo) Then
            Flog.writeline "Buscando el fondoempleo del empleado (AC) "
            StrSql = " SELECT acu_liq.almonto valor"
            StrSql = StrSql & " FROM cabliq "
            StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
            StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
            StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro
            StrSql = StrSql & " WHERE acu_liq.acunro=" & codFondoempleo
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                If Not EsNulo(rsConsult!Valor) Then
                    ValorFondoempleo = rsConsult!Valor
                Else
                    ValorFondoempleo = 0
                End If
                Flog.writeline "El valor del fondoempleo es: " & ValorTope
            Else
                ValorFondoempleo = 0
                Flog.writeline "No se encontro valor del fondoempleo"
            End If
            rsConsult.Close
        End If
    Else
        Flog.writeline " No esta configurado en el confrep el fondoempleo"
    End If
End If
'--------------------------------------------------------------------

'ARMO LA SQL QUE INSERTA EN rep_recibo
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & "( bpronro, ternro, pronro, apellido, nombre, legajo "
StrSql = StrSql & " , pliqnro, pliqmes, pliqanio, cuil"
StrSql = StrSql & " , empnombre, empdire, empcuit, prodesc "
StrSql = StrSql & " , tenro1, tenro2, tenro3, estrnro1, estrnro2, estrnro3, orden, auxchar1" 'en auxchar1 meto el replegal
StrSql = StrSql & " , sueldo, auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5, auxdeci6, auxdeci7, auxdeci8, auxdeci9, auxchar2)" 'en auxchar1 meto el replegal
StrSql = StrSql & " VALUES "
StrSql = StrSql & " ("
StrSql = StrSql & NroProceso & ", "
StrSql = StrSql & Ternro & ", "
StrSql = StrSql & Pronro & ", "
StrSql = StrSql & "'" & Apellido & "',"
StrSql = StrSql & "'" & Nombre & "',"
StrSql = StrSql & "'" & Legajo & "',"
StrSql = StrSql & pliqnro & ", "
StrSql = StrSql & pliqmes & ", "
StrSql = StrSql & pliqanio & ", "
StrSql = StrSql & "'" & NroDoc & "',"
StrSql = StrSql & "'" & EmpNombre & "',"
StrSql = StrSql & "'" & EmpDire & "',"
StrSql = StrSql & "'" & EmpCuit & "',"
StrSql = StrSql & "'" & proDesc & "',"
StrSql = StrSql & tenro1 & ", "
StrSql = StrSql & tenro2 & ", "
StrSql = StrSql & tenro3 & ", "
StrSql = StrSql & estrnro1 & ", "
StrSql = StrSql & estrnro2 & ", "
StrSql = StrSql & estrnro3 & ", "
StrSql = StrSql & orden & ", "
StrSql = StrSql & "'" & repLegal & "'," 'replegal
StrSql = StrSql & Valordividendos & ", " 'dividendos campo sueldo
StrSql = StrSql & Valorporcentaje & ", " 'porcentaje campo auxdeci1
StrSql = StrSql & ValordiasTotales & ", " 'dias totales campo auxdeci2
StrSql = StrSql & ValordiasEmpleado & ", " 'dias empleado campo auxdeci3
StrSql = StrSql & ValorremEmpleado & ", " 'rem empleado campo auxdeci4
StrSql = StrSql & ValorremTotal & ", " 'rem total campo auxdeci5
StrSql = StrSql & ValorformulaA & ", " 'formula A campo auxdeci6
StrSql = StrSql & ValorformulaB & ", " 'formula B campo auxdeci7
StrSql = StrSql & ValorTope & ", " 'tope 18 remuneraciones
StrSql = StrSql & ValorFondoempleo & ", " 'vaor fondo empleo
StrSql = StrSql & "'" & Localidad & "'" 'lugar
StrSql = StrSql & " )"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords
'HASTA ACA


'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
'StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
'StrSql = StrSql & " FROM cabliq "
'StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
'StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
'StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
'
'OpenRecordset StrSql, rsConsult
'
'Do Until rsConsult.EOF
'
'    StrSql = " INSERT INTO rep_recibo_det "
'    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
'    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
'    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
'    StrSql = StrSql & " VALUES"
'    StrSql = StrSql & "(" & NroProceso
'    StrSql = StrSql & "," & Ternro
'    StrSql = StrSql & "," & Pronro
'    StrSql = StrSql & "," & rsConsult!cliqnro
'    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
'    StrSql = StrSql & ",'" & rsConsult!Conccod & "'"
'    StrSql = StrSql & "," & rsConsult!ConcNro
'    StrSql = StrSql & "," & rsConsult!tconnro
'    StrSql = StrSql & "," & rsConsult!concimp
'    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
'    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
'    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
'
'    objConn.Execute StrSql, , adExecuteNoRecords
'
'    rsConsult.MoveNext
'
'Loop

'rsConsult.Close



Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

' Recibo de Sueldo para Chacomer. En vez de mostrar el puesto, se muestra la sucursal.

Sub generarDatosRecibo143(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Sector
Dim Gerencia

Dim Sucursal
Dim EstrSuc
Dim CodSuc
Dim DireEmp

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If
'
'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE cabdom.ternro = " & Ternro


OpenRecordset StrSql, rsConsult
DireEmp = " "
If Not rsConsult.EOF Then
   DireEmp = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
Else
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

Flog.writeline "Direccion y Localidad del Empleado" & StrSql

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos de la Sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

''Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
'         " Where tercero.ternro =" & rs_estructura!Ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el CUIT de la Empresa"
'    'Exit Sub
'    EmpCuit = "  "
'Else
'    EmpCuit = rs_cuit!Nrodoc
'End If

'Consulta Sucursal
StrSql = " SELECT estructura.estrnro,sucursal.ternro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

EstrSuc = " "
CodSuc = " "
If Not rsConsult.EOF Then
   EstrSuc = rsConsult!Estrnro
   CodSuc = rsConsult!Ternro
Else
   Flog.writeline "Error al obtener los datos de la Sucursal"
'   GoTo MError
End If
Flog.writeline " Codigo de la Sucursal " & StrSql

' Consulta CUIL de Sucursal

'------------------------------------------------------------------------------
'Busco el valor de Tipo Documento de la Sucursal definido en el confrep
'------------------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 138 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
'Consulta para obtener el CUIT de la Sucursal
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & rsConsult("confval") & ")" & _
         " Where tercero.ternro =" & CodSuc
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Sucursal"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If
End If
Flog.writeline " CUIT Sucursal " & StrSql

'-----------------------------------------------------------------------
'Consulta para buscar la Localidad y Direccion de la Sucursal
'-----------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE cabdom.ternro = " & CodSuc

OpenRecordset StrSql, rsConsult
Direccion = " "
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

Flog.writeline "Direccion y Localidad de la Sucursal" & StrSql

'-----------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
'-----------------------------------------------------------------------
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco Sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=2 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline "Sector" & StrSql
Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron datos del Sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco Gerencia
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=6 AND his_estructura.ternro=" & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Gerencia" & StrSql

Gerencia = ""

If Not rsConsult.EOF Then
   Gerencia = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron datos de la Gerencia"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,auxchar5, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, auxchar3, auxchar4, puesto, auxchar6, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Gerencia & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & pliqdesde & "'"
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & Mid(DireEmp, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

' Recibo de Sueldo para Venezuela. En vez de mostrar el puesto, se muestra la sucursal.

Sub generarDatosRecibo144(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim sql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Sector
Dim Gerencia

Dim Sucursal
Dim EstrSuc

Dim Saldo1 As String
Dim Saldo2 As String
Dim TipoSueldo
Dim Saldo
Dim I
Dim salmonto
Dim listaval(20)

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_saldo As New ADODB.Recordset

Dim Valor

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = Replace(rsConsult!empremu, ",", ".")
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
Flog.writeline "Datos de la categoria" & StrSql
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
Flog.writeline "Datos de la Sucursal" & StrSql
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron los datos de la Sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
Flog.writeline "Datos del puesto" & StrSql
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!Estrnro & " " & rsConsult!estrdabr
Else
   Flog.writeline "No se encontraron datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
Flog.writeline "Datos del centro de costo" & StrSql
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!Estrnro & " " & rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
Flog.writeline "Datos de la forma de pago" & StrSql
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta Sucursal
StrSql = " SELECT estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

EstrSuc = " "

If Not rsConsult.EOF Then
   EstrSuc = rsConsult!Estrnro
Else
   Flog.writeline "Error al obtener los datos de la Sucursal"
'   GoTo MError
End If
Flog.writeline " Codigo de la Sucursal " & StrSql

' Consulta CUIL de Sucursal

'------------------------------------------------------------------------------
'Busco el valor de Tipo Documento de la Sucursal definido en el confrep
'------------------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 138 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
'Consulta para obtener el CUIT de la Sucursal
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & rsConsult("confval") & ")" & _
         " Where tercero.ternro =" & Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Sucursal"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If
End If
Flog.writeline " CUIT Sucursal " & StrSql


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If
rsConsult.Close

'Configuracion del Confrep para el Saldo
Flog.writeline "Buscando la columna Tipo SUE (Sueldos) "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  conftipo = 'SUE' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
        If rsConsult!confval = "" Or IsNull(rsConsult!confval) Then
            Valor = rsConsult!confval2
        Else
            Valor = rsConsult!confval
        End If
        StrSql = " SELECT detliq.dlimonto "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Valor
        StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            TipoSueldo = Replace(rsConsult!dlimonto, ",", ".")
        Else
            TipoSueldo = 0
        End If
rsConsult.Close
    If TipoSueldo = 0 Then
        StrSql = " SELECT almonto "
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " INNER JOIN acumulador ON acu_liq.acunro = acumulador.acunro"
        StrSql = StrSql & " Where acu_liq.acunro = " & Valor
        StrSql = StrSql & " AND acu_liq.cliqnro = " & cliqnro
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            TipoSueldo = Replace(rsConsult!almonto, ",", ".")
        End If
    rsConsult.Close
    End If
End If

'Configuracion del Confrep para Prestamos
Flog.writeline "Buscando la columna Tipo SAL (Prestamos) y guardo en una lista los codigos "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  conftipo = 'SAL' "
OpenRecordset StrSql, rsConsult

Saldo1 = "0"
Saldo2 = "0"

Do While Not rsConsult.EOF

   Saldo1 = Saldo1 & "," & rsConsult!confval
   Saldo2 = Saldo2 & "," & rsConsult!confval2

rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,auxchar5, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar3, auxchar4, auxdeci1, puesto,orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & pliqdesde & "'"
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & "," & TipoSueldo
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

' Obtengo el Saldo

lista1 = Split(Saldo1, ",")
lista2 = Split(Saldo2, ",")
I = 0
Saldo = False
Do While I <= UBound(lista1)
    StrSql = " SELECT detliq.dlimonto"
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
    StrSql = StrSql & " WHERE conccod = " & lista2(I)
        
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        listaval(I) = rsConsult!dlimonto
    Else
        listaval(I) = 0
    End If
    I = I + 1
Loop
rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    
    lista1 = Split(Saldo1, ",")
    lista2 = Split(Saldo2, ",")
    I = 0
    Saldo = False
    salmonto = 0
    Do While I <= UBound(lista1) And Not Saldo
       If CLng(rsConsult!ConcCod) = CLng(lista1(I)) Then
                salmonto = listaval(I)
                salmonto = (Replace(salmonto, ",", "."))
                Saldo = True
       End If
       I = I + 1
    Loop
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro, salmonto,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & salmonto
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo145(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim sql As String
Dim rsConsult As New ADODB.Recordset
Dim rs_confrep As New ADODB.Recordset
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'variables del insert
Dim Apellido As String
Dim Nombre As String
Dim empleg As String
Dim EmpNombre As String
Dim EmpEstrnro As String
Dim EstrSuc As String
Dim EmpCuit As String
Dim EmpDire As String
Dim empdoc As String
Dim j As Integer
Dim TipoDoc As String
Dim NroDoc As String
Dim proFecPago As String
Dim proDesc As String
Dim Banco As String
Dim cuentaAhorro As String
Dim valorHabNoImp As Double
Dim valorHabImp As Double
Dim valorDtos As Double
Dim valorNeto As Double
Dim unidad As String
Dim Direccion As String
Dim Localidad As String
Dim fechaPago As String


Dim codUnidad As Long
Dim tipodocEmpl As Long
Dim esConceptoHabNoImp As Boolean
Dim esConceptoHabImp As Boolean
Dim esConceptoDtos As Boolean
Dim esConceptoNeto As Boolean

Dim habNoImp As String
Dim habImp As String
Dim Dtos As String
Dim Neto As String
Dim CodSuc As String
Dim codEmp1 As String
Dim codEmp2 As String
Dim sucTernro As String

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'levanto campos del confrep especificos de este recibo
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60"
StrSql = StrSql & " AND confnrocol >= 193 "
OpenRecordset StrSql, rs_confrep
If Not rs_confrep.EOF Then
    Do While Not rs_confrep.EOF
        Select Case rs_confrep!confnrocol
            Case 193:
                If UCase(rs_confrep!conftipo) <> "TE" Then
                    Flog.writeline "La columna 193 debe ser del tipo TE, se aborta el proceso"
                    GoTo MError
                Else
                    codUnidad = rs_confrep!confval
                    Flog.writeline "Columna 193:" & rs_confrep!confval
                End If
            Case 194:
                If UCase(rs_confrep!conftipo) <> "DOC" Then
                    Flog.writeline "La columna 194 debe ser del tipo DOC, se aborta el proceso"
                    GoTo MError
                Else
                    tipodocEmpl = rs_confrep!confval
                    Flog.writeline "Columna 194:" & rs_confrep!confval
                End If
            Case 195:
                If ((UCase(rs_confrep!conftipo) <> "CO") And (UCase(rs_confrep!conftipo) <> "AC")) Then
                    Flog.writeline "La columna 195 debe ser del tipo AC/CO, se aborta el proceso"
                    GoTo MError
                Else
                    If rs_confrep!conftipo = "CO" Then
                        esConceptoHabNoImp = True
                        habNoImp = rs_confrep!confval2
                    Else
                        esConceptoHabNoImp = False
                        habNoImp = rs_confrep!confval
                    End If
                End If
                
            Case 196:
                If ((UCase(rs_confrep!conftipo) <> "CO") And (UCase(rs_confrep!conftipo) <> "AC")) Then
                    Flog.writeline "La columna 196 debe ser del tipo AC/CO, se aborta el proceso"
                    GoTo MError
                Else
                    If rs_confrep!conftipo = "CO" Then
                        esConceptoHabImp = True
                        habImp = rs_confrep!confval2
                    Else
                        esConceptoHabImp = False
                        habImp = rs_confrep!confval
                    End If
                End If
        
            Case 197:
                If ((UCase(rs_confrep!conftipo) <> "CO") And (UCase(rs_confrep!conftipo) <> "AC")) Then
                    Flog.writeline "La columna 197 debe ser del tipo AC/CO, se aborta el proceso"
                    GoTo MError
                Else
                    If rs_confrep!conftipo = "CO" Then
                        esConceptoDtos = True
                        Dtos = rs_confrep!confval2
                    Else
                        esConceptoDtos = False
                        Dtos = rs_confrep!confval
                    End If
                End If
            
            Case 198:
                If ((UCase(rs_confrep!conftipo) <> "CO") And (UCase(rs_confrep!conftipo) <> "AC")) Then
                    Flog.writeline "La columna 198 debe ser del tipo AC/CO, se aborta el proceso"
                    GoTo MError
                Else
                    If rs_confrep!conftipo = "CO" Then
                        esConceptoNeto = True
                        Neto = rs_confrep!confval2
                    Else
                        esConceptoNeto = False
                        Neto = rs_confrep!confval
                    End If
                End If
            Case 199:
                If UCase(rs_confrep!conftipo) <> "DOC" Then
                    Flog.writeline "La columna 199 debe ser del tipo DOC, se aborta el proceso"
                    GoTo MError
                Else
                    CodSuc = rs_confrep!confval
                    Flog.writeline "Columna 199:" & rs_confrep!confval
                End If
            
            Case 200:
                If UCase(rs_confrep!conftipo) <> "DOC" Then
                    Flog.writeline "La columna 200 debe ser del tipo DOC, se aborta el proceso"
                    'GoTo MError
                Else
                    codEmp1 = rs_confrep!confval
                    Flog.writeline "Columna 200:" & rs_confrep!confval
                End If
            
            Case 201:
                If UCase(rs_confrep!conftipo) <> "DOC" Then
                    Flog.writeline "La columna 201 debe ser del tipo DOC, se aborta el proceso"
                    'GoTo MError
                Else
                    codEmp2 = rs_confrep!confval
                    Flog.writeline "Columna 201:" & rs_confrep!confval
                End If
            
        End Select
    rs_confrep.MoveNext
    Loop
Else
    Flog.writeline "No esta configurado el confrep se aborta el proceso"
End If
rs_confrep.Close
'hasta aca


'busco la fecha de pago del proceso
StrSql = " SELECT profecpago FROM proceso "
StrSql = StrSql & " WHERE pronro=" & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    fechaPago = rsConsult!proFecPago
Else
    fechaPago = ""
End If
rsConsult.Close
'hasta aca

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close

'busco el apellido y nombre del empleado
StrSql = " SELECT terape2, terape, ternom2, ternom, empleg FROM empleado "
StrSql = StrSql & " WHERE ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If EsNulo(rsConsult!terape2) Then
        Apellido = rsConsult!terape2 & " " & rsConsult!terape
    Else
        Apellido = rsConsult!terape
    End If

    If EsNulo(rsConsult!ternom2) Then
        Nombre = rsConsult!ternom2 & " " & rsConsult!ternom
    Else
        Nombre = rsConsult!ternom
    End If
    empleg = rsConsult!empleg
    Flog.writeline "Se encontraron los datos del empleado"
Else
    Flog.writeline "No Se encontraron los datos del empleado"
End If
rsConsult.Close

'busco el documeto del empleado
StrSql = " SELECT tidnom, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & Ternro
StrSql = StrSql & " AND ter_doc.tidnro=" & tipodocEmpl
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDoc = rsConsult!tidnom
    NroDoc = rsConsult!NroDoc
Else
    TipoDoc = ""
    NroDoc = ""
End If
'hasta aca

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    EmpTernro = 0
    EmpNombre = ""
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
    EmpTernro = rs_estructura!Ternro
End If


'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, pais.paisdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN pais ON pais.paisnro = detdom.paisnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!locdesc
    End If
    
    If Not EsNulo(rs_Domicilio!paisdesc) Then
        EmpDire = EmpDire & ", " & rs_Domicilio!paisdesc
    End If
End If
rs_Domicilio.Close
'rs_estructura.Close

'Consulta Sucursal
StrSql = " SELECT estructura.estrnro, estructura.estrdabr, sucursal.ternro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
EstrSuc = " "
If Not rsConsult.EOF Then
   EstrSuc = rsConsult!Estrnro
   Sucursal = rsConsult!estrdabr
   sucTernro = rsConsult!Ternro
Else
   Sucursal = ""
   sucTernro = ""
   Flog.writeline "Error al obtener los datos de la Sucursal"
'   GoTo MError
End If
Flog.writeline " Codigo de la Sucursal " & StrSql
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad  de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " LEFT JOIN localidad ON detdom.locnro = localidad.locnro"

OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   Localidad = Direccion
   'GoTo MError
End If

'------------------------------------------------------------------------------
'Busco el valor de Tipo Documento de la Sucursal definido en el confrep
'------------------------------------------------------------------------------

StrSql = " SELECT tidsigla, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & sucTernro
StrSql = StrSql & " AND ter_doc.tidnro=" & CodSuc
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontraron los doc de la Sucursal"
    EmpCuit = ""
Else
    Do While Not rsConsult.EOF
        EmpCuit = EmpCuit & rsConsult!tidsigla & "@" & rsConsult!NroDoc & "*"
    rsConsult.MoveNext
    Loop
End If
Flog.writeline " documento empresa " & StrSql
rsConsult.Close

'BUSCO EL VALOR DEL DOCUMENTO DE LA EMPRESA
StrSql = " SELECT tidsigla, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & EmpTernro
StrSql = StrSql & " AND ter_doc.tidnro IN (" & codEmp1 & ", " & codEmp2 & ")"
OpenRecordset StrSql, rsConsult
j = 0
If rsConsult.EOF Then
    Flog.writeline "No se encontraron los doc de la Empresa"
    empdoc = ""
Else
    Do While Not rsConsult.EOF
        'ReDim Preserve empdoc(j)
        empdoc = empdoc & rsConsult!tidsigla & "@" & rsConsult!NroDoc & "*"
        
    rsConsult.MoveNext
    Loop
End If
Flog.writeline " documento Empresa " & StrSql
rsConsult.Close
'HASTA ACA

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If
rs_logo.Close

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
rs_firma.Close


'busco el campo unidad
StrSql = " SELECT estructura.estrnro, estructura.estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & codUnidad & " And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
unidad = " "
If Not rsConsult.EOF Then
   unidad = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Unidad"
End If
Flog.writeline " Codigo de la Unidad " & StrSql
rsConsult.Close
'hasta aca

'------------------------------------------------------------------
'Busco el banco de acreditacion
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        Banco = rsConsult!terrazsoc
        cuentaAhorro = rsConsult!ctabnro
        'FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
    Else
        Banco = ""
        cuentaAhorro = ""
        'FormaPago = rsConsult!fpagdescabr
    End If
Else
   Flog.writeline "Error al obtener los datos de la acreditacion"
'   GoTo MError
End If
rsConsult.Close

'BUSCO LOS DATOS DE LOS HABERES NO IMPONIBLES
If esConceptoHabNoImp Then
    StrSql = " SELECT sum(dlimonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN detliq ON detliq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND concepto.conccod=" & habNoImp
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorHabNoImp = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del concepto haberes no imponibles"
    Else
        valorHabNoImp = 0
        Flog.writeline "No se encontro el valor del concepto haberes no imponibles"
    End If
    rsConsult.Close
Else
    StrSql = " SELECT sum(almonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN acu_liq ON acu_liq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND acu_liq.acunro=" & habNoImp
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorHabNoImp = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del acumulador haberes no imponibles"
    Else
        valorHabNoImp = 0
        Flog.writeline "No se encontro el valor del acumulador haberes no imponibles"
    End If
    rsConsult.Close
End If
'HASTA ACA

'BUSCO LOS DATOS DE LOS HABERES  IMPONIBLES
If esConceptoHabImp Then
    StrSql = " SELECT sum(dlimonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN detliq ON detliq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND concepto.conccod=" & habImp
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorHabImp = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del concepto haberes imponibles"
    Else
        valorHabImp = 0
        Flog.writeline "No se encontro el valor del concepto haberes imponibles"
    End If
    rsConsult.Close
Else
    StrSql = " SELECT sum(almonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN acu_liq ON acu_liq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND acu_liq.acunro=" & habImp
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorHabImp = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del acumulador haberes imponibles"
    Else
        valorHabImp = 0
        Flog.writeline "No se encontro el valor del acumulador haberes imponibles"
    End If
    rsConsult.Close
End If
'HASTA ACA


'BUSCO LOS DATOS DE LOS DTOS
If esConceptoDtos Then
    StrSql = " SELECT sum(dlimonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN detliq ON detliq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND concepto.conccod=" & Dtos
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorDtos = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del concepto dtos"
    Else
        valorDtos = 0
        Flog.writeline "No se encontro el valor del concepto dtos"
    End If
    rsConsult.Close
Else
    StrSql = " SELECT sum(almonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN acu_liq ON acu_liq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND acu_liq.acunro=" & Dtos
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorDtos = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del acumulador dtos"
    Else
        valorDtos = 0
        Flog.writeline "No se encontro el valor del acumulador dtos"
    End If
    rsConsult.Close
End If
'HASTA ACA

'BUSCO LOS DATOS DEL NETO
If esConceptoNeto Then
    StrSql = " SELECT sum(dlimonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN detliq ON detliq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND concepto.conccod=" & Neto
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorNeto = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del concepto neto"
    Else
        valorNeto = 0
        Flog.writeline "No se encontro el valor del concepto neto"
    End If
    rsConsult.Close
Else
    StrSql = " SELECT sum(almonto) valor FROM cabliq "
    StrSql = StrSql & " INNER JOIN acu_liq ON acu_liq.cliqnro=cabliq.cliqnro "
    StrSql = StrSql & " WHERE cabliq.cliqnro =" & cliqnro & " And Pronro =" & Pronro & " And Empleado =" & Ternro
    StrSql = StrSql & " AND acu_liq.acunro=" & Neto
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        valorNeto = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
        Flog.writeline "Se encontro el valor del acumulador neto"
    Else
        valorNeto = 0
        Flog.writeline "No se encontro el valor del acumulador neto"
    End If
    rsConsult.Close
End If
'HASTA ACA


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,"
'StrSql = StrSql & " pliqdepant,"
'StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
'StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
'StrSql = StrSql & " profecpago,"
StrSql = StrSql & " empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,"
'StrSql = StrSql & " formapago,prodesc,"
StrSql = StrSql & " descripcion,"
StrSql = StrSql & " auxchar5, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, auxchar3, auxchar4, auxchar6, auxchar7,auxchar8, auxchar9, orden, auxdeci1, auxdeci2, auxdeci3, auxdeci4)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & empleg
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
'StrSql = StrSql & ",'" & pliqdepant & "'"
'StrSql = StrSql & ",'" & pliqfecdep & "'"
'StrSql = StrSql & ",'" & pliqbco & "'"
'StrSql = StrSql & ",'" & Cuil & "'"
'StrSql = StrSql & ",'" & empFecAlta & "'"
'StrSql = StrSql & "," & Sueldo
'StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
'StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
'StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
'StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
'StrSql = StrSql & ",'" & FormaPago & "'"
'StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & unidad & "'" 'auxchar5
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & TipoDoc & "'" 'auxchar1
StrSql = StrSql & ",'" & NroDoc & "'" 'auxchar2
StrSql = StrSql & ",'" & empdoc & "'" 'auxchar 3
StrSql = StrSql & ",'" & Banco & "'" 'auxchar 4
StrSql = StrSql & ",'" & cuentaAhorro & "'" 'auxchar 6
StrSql = StrSql & ",'" & Sucursal & "'" 'auxchar 7
StrSql = StrSql & ",'" & Localidad & "'" 'auxchar 8
StrSql = StrSql & ",'" & fechaPago & "'" 'auxchar 9
StrSql = StrSql & "," & orden
StrSql = StrSql & "," & valorHabNoImp 'auxdeci 1
StrSql = StrSql & "," & valorHabImp 'auxdeci 2
StrSql = StrSql & "," & valorDtos 'auxdeci 3
StrSql = StrSql & "," & valorNeto 'auxdeci 4

StrSql = StrSql & ")"
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords
Flog.writeline "SE INSERTO LA CABECERA DEL RECIBO DE SUELDO"
'HASTA ACA

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub



MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    
    
    
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para COLOMBIA NVS
'--------------------------------------------------------------------
Sub generarDatosRecibo146(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim StrSql1 As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Localidad
Dim LocDireccion
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim DescPuesto
Dim DescCentroCosto
Dim pliqdesde
Dim vivienda
Dim SalEduc
Dim PorcRet
Dim Salario
Dim Bono
Dim EPS
Dim Fondo
Dim AFC

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la localidad de la sucursal
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   LocDireccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!codigopostal & " " & rsConsult!locdesc
Else
   Localidad = "  "
   LocDireccion = "  "
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Puesto = 0
DescPuesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!Estrnro
   DescPuesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If


rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   DescCentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!Estrnro
Else
   DescCentroCosto = ""
   CentroCosto = ""
   Flog.writeline "No se encontraron datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de EPS
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

EPS = ""

If Not rsConsult.EOF Then
   EPS = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de EPS"
End If

'------------------------------------------------------------------
'Busco el valor de Fondo de Pensiones
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Fondo = ""

If Not rsConsult.EOF Then
   Fondo = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de Fondo"
End If

'------------------------------------------------------------------
'Busco el valor de AFC
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 74 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

AFC = ""

If Not rsConsult.EOF Then
   AFC = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de AFC"
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 202 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        vivienda = rsConsult!nevalor
    Else
        vivienda = 0
    End If
End If
Flog.writeline "Alivio Vivienda" & StrSql1
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 203 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        SalEduc = rsConsult!nevalor
    Else
        SalEduc = 0
    End If
End If
Flog.writeline "Alivio Sal/Educ" & StrSql1
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 204 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        PorcRet = rsConsult!nevalor
    Else
        PorcRet = 0
    End If
End If
Flog.writeline "Porc. Ret." & StrSql1
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 205 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        Salario = rsConsult!nevalor
    Else
        Salario = 0
    End If
End If
Flog.writeline "Salario" & StrSql1
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 206 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        Bono = rsConsult!nevalor
    Else
        Bono = 0
    End If
End If
Flog.writeline "Bonos Sodexho" & StrSql1
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos Configurados en el confrep
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 207 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    StrSql1 = "SELECT concabr,nevalor FROM novemp"
    StrSql1 = StrSql1 & " INNER JOIN concepto on concepto.concnro=novemp.concnro "
    StrSql1 = StrSql1 & " WHERE empleado = " & Ternro
    StrSql1 = StrSql1 & " AND nedesde >= " & pliqdesde
    StrSql1 = StrSql1 & " AND nehasta <= " & pliqhasta
    StrSql1 = StrSql1 & " AND concepto.conccod = " & rsConsult!confval2
    StrSql1 = StrSql1 & " AND novemp.tpanro = " & rsConsult!confval
    OpenRecordset StrSql1, rsConsult
    
    If Not rsConsult.EOF Then
        BonoSodexho = rsConsult!nevalor
    Else
        BonoSodexho = 0
    End If
End If
Flog.writeline "Bonos Sodexho" & StrSql1
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,centrocosto,auxchar3,auxdeci1,auxdeci2,auxdeci3, auxchar4,auxchar5,auxdeci4,auxdeci5,auxchar6,auxdeci6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Salario
StrSql = StrSql & ",'" & EPS & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & "," & Puesto
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LocDireccion, 1, 100) & "'"
StrSql = StrSql & ",'" & DescPuesto & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & DescCentroCosto & "'"
StrSql = StrSql & "," & SalEduc
StrSql = StrSql & "," & PorcRet
StrSql = StrSql & "," & Bono
StrSql = StrSql & ",'" & Fondo & "'"
StrSql = StrSql & ",'" & AFC & "'"
StrSql = StrSql & "," & BonoSodexho
StrSql = StrSql & "," & vivienda
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & nroCuenta

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Novartis a partir del 19-06-2013
'--------------------------------------------------------------------
Sub generarDatosRecibo147(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim diasHab_aux As Integer

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_pago As New ADODB.Recordset
Dim rs_formapago As New ADODB.Recordset
Dim rs_cuenta As New ADODB.Recordset

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim estrConvenio1 As Integer
Dim estrConvenio2 As Integer
Dim acumulador As Long

Dim LugarPago
Dim Banco
Dim Cuenta
Dim Documento
Dim Parametro

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 147"

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'empFecAlta = rsConsult!altfec NG - 24/05/2012
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    'empFecAlta = " " NG - 24/05/2012
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------------------------------------------------
' Calculo la antiguedad si el empleado no tiene las estructuras configuradas en el confrep,
' se calcula segun el alta, sino mediante el acumulador configurado
'------------------------------------------------------------------------------------------------------------
Antiguedad = 0

Flog.writeline "Chequeo que el empleado tenga al menos una de las 2 estructuras configuradas en el confrep"
StrSql = " SELECT estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " WHERE  ( htetdesde <= " & ConvFecha(pliqdesde) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqdesde) & ") "
StrSql = StrSql & " OR htetdesde >= " & ConvFecha(pliqdesde) & " And (htetdesde <= " & ConvFecha(pliqhasta) & "))"
StrSql = StrSql & " And tenro = 19  and ternro = " & Ternro & " And (estrnro = " & estrConvenio1 & " or estrnro = " & estrConvenio2 & ") "

       
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
    Flog.writeline "Calculo la antiguedad, por medio de la fase, el empleado no tiene estructuras configuradas en confrep"
    Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
    Fecha_aux = DateAdd("m", 1, Fecha_aux)
    Fecha_aux = DateAdd("d", -1, Fecha_aux)
    
    If Fecha_aux < empFecAlta Then
        Antiguedad = "0 año/s 0 mes/ses"
    Else
        Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
        Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
    End If
Else
    Flog.writeline "Calculo la antiguedad, por medio del acumulador configurado en confrep"
    'StrSql = " SELECT sum(acu_liq.almonto) monto "
    'StrSql = StrSql & " FROM periodo "
    'StrSql = StrSql & " INNER JOIN proceso ON periodo.pliqnro = proceso.pliqnro " ' and pronro = " & Pronro
    'StrSql = StrSql & " INNER JOIN cabliq ON proceso.pronro = cabliq.pronro"
    'StrSql = StrSql & " INNER JOIN acu_liq ON cabliq.cliqnro = acu_liq.cliqnro"
    'StrSql = StrSql & " WHERE cabliq.Empleado = " & Ternro
    'StrSql = StrSql & " AND periodo.pliqmes <= " & pliqmes
    'StrSql = StrSql & " AND periodo.pliqanio <= " & pliqanio
    'StrSql = StrSql & " AND acu_liq.acunro = " & acumulador
    StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
    StrSql = StrSql & " WHERE amanio < " & pliqanio
    StrSql = StrSql & " AND acunro = " & acumulador
    StrSql = StrSql & " AND ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    totalParcialAntiguedad = 0
    If Not rsConsult.EOF Then
       If EsNulo(rsConsult!Monto) Then
           totalParcialAntiguedad = 0
       Else
           totalParcialAntiguedad = CDbl(rsConsult!Monto)
       End If
       
       StrSql = " SELECT sum(ammonto) monto FROM acu_mes "
       StrSql = StrSql & " WHERE amanio = " & pliqanio
       StrSql = StrSql & " AND ammes <= " & pliqmes
       StrSql = StrSql & " AND acunro = " & acumulador
       StrSql = StrSql & " AND ternro = " & Ternro
       OpenRecordset StrSql, rs_aux
       If Not rs_aux.EOF Then
           If Not EsNulo(rs_aux!Monto) Then
               totalParcialAntiguedad = CDbl(totalParcialAntiguedad) + CDbl(rs_aux!Monto)
           End If
       End If
       Antiguedad = CStr(totalParcialAntiguedad) & " Días"
    Else
    '   Flog.writeline "Error al obtener los datos del cuil"
    '   GoTo MError
    End If
End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
    Sueldo = Replace(Sueldo, ",", ".")
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 53 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 53 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   Flog.writeline "No se encuentran datos de la Estructura Modalidad 53"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
StrSql = StrSql & " And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   'CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Sucursal
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
   Sucursal = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rs_pago

Flog.writeline "Lugar de Pago" & StrSql
   
If Not rs_pago.EOF Then
   LugarPago = rs_pago!estrdabr
   Flog.writeline "    los datos del Lugar de Pago OK"
Else
   Flog.writeline "Error al obtener los datos del Lugar de Pago"
'   GoTo MError
End If

rs_pago.Close
'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rs_cuenta
 
If Not rs_cuenta.EOF Then
   If Not EsNulo(rs_cuenta!ctabcbu) Then
       Banco = rs_cuenta!Bandesc
       Cuenta = "CBU " & rs_cuenta!ctabcbu
   Else
       If Not EsNulo(rs_cuenta!ctabnro) Then
            Banco = rs_cuenta!Bandesc
            Cuenta = "Cta. Nro. " & rs_cuenta!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

Flog.writeline "Banco y Cuenta" & Banco & Cuenta

rs_cuenta.Close

'------------------------------------------------------------------
'Busco Forma de Pago
'------------------------------------------------------------------
StrSql = " SELECT fpagnro "
StrSql = StrSql & " FROM pago"
StrSql = StrSql & " WHERE ternro=" & Ternro
       
OpenRecordset StrSql, rs_formapago

Flog.writeline "Forma de Pago" & StrSql

FormaPago = " "

If Not rs_formapago.EOF Then
   If rs_formapago!fpagnro = 10 Then
        FormaPago = "CA"
   Else
        If rs_formapago!fpagnro = 9 Or rs_formapago!fpagnro = 12 Then
            FormaPago = " Efectivo o Cheque"
        End If
   End If
   Flog.writeline "    los datos de Forma de Pago OK"
Else
   Flog.writeline "Error al obtener los datos de Forma de Pago"
'   GoTo MError
End If

Flog.writeline "Forma Pago" & FormaPago

rs_formapago.Close

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el Valor de Venta
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 221  "
OpenRecordset StrSql, rsConsult

Parametro = "0"

Do While Not rsConsult.EOF
    Parametro = rsConsult!confval2
    rsConsult.MoveNext
Loop
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar5, auxchar6,auxchar4,auxchar7)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & LugarPago & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & Parametro & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND (concepto.concimp = -1 OR concepto.conccod='" & Parametro & "') "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Apex Honduras
'--------------------------------------------------------------------
Sub generarDatosRecibo148(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim telefono

'Busquedas
Dim Contrato
Dim Antiguedad
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim FuturosAumentos
Dim esFuturosAumentosCon
Dim valorFutAumConf

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset
Dim t
Dim seccion
Dim calle

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim netoMensual
Dim acuNetoMensual
Dim tipoAcuNetoMensual

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult

Flog.writeline "v  Basico" & StrSql
 
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   Sueldo = 0
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


StrSql = " SELECT estrdabr FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = 2"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
 OpenRecordset StrSql, rsConsult2
 If Not rsConsult2.EOF Then
       Datos = rsConsult2!estrdabr
 End If
        
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc,telefono.telnro,detdom.codigopostal,pais.paisdesc,cpa, provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " "
StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=10 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = empresa.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN Telefono ON detdom.domnro=telefono.domnro"
StrSql = StrSql & " INNER JOIN pais ON pais.paisnro=localidad.paisnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=localidad.provnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult
Direccion = ""
If rsConsult.EOF Then
    Flog.writeline "Error al obtener los datos de la localidad"
End If
t = 1
Do While Not rsConsult.EOF
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If t < 4 Then
        If EsNulo(tel) Then
            tel = "Tel: " & rsConsult!telnro
        Else
            tel = tel & " / " & rsConsult!telnro
            t = t + 1
        End If
    End If
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & " " & rsConsult!locdesc & " "
    'tel = "Tel:" & rsConsult!telnro
    Localidad = rsConsult!cpa & "-" & rsConsult!locdesc & "-" & rsConsult!paisdesc
    Flog.writeline "Direccion" & Direccion
    Flog.writeline Localidad
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

  If esSueldoConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & acunroSueldo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

Flog.writeline "Basico" & StrSql


    Flog.writeline "Sueldo Basico" & StrSql
StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & acunroSueldo & " AND cliqnro = " & cliqnro

    If Not rsConsult.EOF Then
        Sueldo = rsConsult!Valor
        Flog.writeline Sueldo
        Flog.writeline StrSql
    Else
        Flog.writeline "Error al obtener los datos del sueldo"
        Sueldo = 0
    End If
 Flog.writeline "Basico" & StrSql & Sueldo
 

'------------------------------------------------------------------
'Busco el valor del neto mensual
'------------------------------------------------------------------
'Acumlador configurado en la columna 222 del confrep 60
netoMensual = 0
StrSql = " SELECT conftipo, confval FROM confrep WHERE confnrocol = 222 AND repnro = 60 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    acuNetoMensual = rsConsult!confval
    tipoAcuNetoMensual = rsConsult!conftipo
Else
    Flog.writeline "No esta configurado el neto mensual en la columna 222 del reporte"
End If

If UCase(tipoAcuNetoMensual) = "ACL" Then
    StrSql = " SELECT almonto FROM acu_liq " & _
             " WHERE acunro = " & acuNetoMensual & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        netoMensual = rsConsult!almonto
    Else
        Flog.writeline "No hay valor para el acumulador de la columna 222."
    End If
Else
    If UCase(tipoAcuNetoMensual) = "ACM" Then
    StrSql = " SELECT ammonto FROM acu_mes WHERE ternro = " & Ternro & " AND amanio = " & pliqanio & _
             " AND ammes = " & pliqmes & " AND acunro = " & acuNetoMensual
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        netoMensual = rsConsult!ammonto
    Else
        Flog.writeline "No hay valor para el acumulador mensual de la columna 222."
    End If
        
    Else
        Flog.writeline "Error mal configurado el tipo del acumulador de la columna 222 (ACL o ACM)."
    End If
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If

'------------------------------------------------------------------
'Busco el valor del Contratacion
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 45 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

'------------------------------------------------------------------
'Calcula la direccion del empleado
'------------------------------------------------------------------
StrSql = " SELECT calle,nro,provdesc,locdesc FROM empleado "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro=empleado.ternro "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro=cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON localidad.locnro=detdom.locnro "
StrSql = StrSql & " INNER JOIN provincia ON provincia.provnro=provincia.provnro "
StrSql = StrSql & " WHERE empleado.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    calle = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!locdesc) Then
          calle = calle & " " & rsConsult!locdesc
    End If
    If Not EsNulo(rsConsult!provdesc) Then
        'calle = calle & " " & rsConsult!provdesc
    End If
Else
    Flog.writeline "No se encontro la direccion del empleado"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del centro de costo"
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If Not EsNulo(rsConsult!ctabnro) Then
        CuentaBancaria = rsConsult!ctabnro
        If IsNull(rsConsult!terrazsoc) Then
            Banco = ""
        Else
            Banco = rsConsult!terrazsoc
        End If
    Else
        CuentaBancaria = rsConsult!ctabcbu
        Banco = "CBU"
    End If
    PagoMonto = rsConsult!PagoMonto
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
    Flog.writeline "Obra social:" & ObraSocial
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de los acumuladores
'------------------------------------------------------------------
    
'Sueldo Bruto
'StrSql = " SELECT almonto"
'StrSql = StrSql & " From acu_liq"
'StrSql = StrSql & " Where acunro = " & ValNetoTalon
'StrSql = StrSql & " AND cliqnro = " & cliqnro
'OpenRecordset StrSql, rsConsult

'Flog.writeline StrSql

  If esGratificacionConc Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & Gratificacion & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & Gratificacion & " AND cliqnro = " & cliqnro
  End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ValorAcumSueldoBruto = rsConsult!Valor
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto" & ValorAcumSueldoBruto
Else
   Flog.writeline "Error al obtener los datos del acumulador de Sueldo Bruto"
   Flog.writeline StrSql
   ValorAcumSueldoBruto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0

If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco el valor de Futuros Aumentos, definido en la columna 101 del confrep
'------------------------------------------------------------------

FuturosAumentos = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 101 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        esFuturosAumentosCon = True
       
        
            
        'Busco codigo interno del concepto
        StrSql = "SELECT concnro FROM concepto WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
        OpenRecordset StrSql, rsConsult2
        
        Flog.writeline StrSql
        Flog.writeline rsConsult2!ConcNro
        If rsConsult2.EOF Then
          valorFutAumConf = 0
        Else
          valorFutAumConf = rsConsult2!ConcNro
        End If
        rsConsult2.Close
           
        
        
    Else
        esFuturosAumentosCon = False
        valorFutAumConf = rsConsult!confval
    End If
    
    FuturosAumentos = 0

    If esFuturosAumentosCon Then
        
        StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If

    Else

        StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
        StrSql = StrSql & " FROM cabliq "
        StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
        StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
        StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & valorFutAumConf
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            FuturosAumentos = rsConsult!Valor
        End If
    End If
Else
    Flog.writeline "No esta configurado el ConfRep para el concepto A Cuenta Fututos Aumentos (col 101)."

End If



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,auxdeci3,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1, auxdeci2 "
StrSql = StrSql & " , auxdeci4, auxdeci5"
StrSql = StrSql & " )"
',auxdeci2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & calle & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
'If tel = "" Then
'    StrSql = StrSql & " ," & 0
'Else
'    StrSql = StrSql & " ," & tel
'End If
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & " ,'" & Mid(valorAntig, 1, 25) & "'" 'CentroCosto
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & Antiguedad & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & tel & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & TipoDocu & "'"
StrSql = StrSql & " ,'" & NroDocu & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & " ," & netoMensual
StrSql = StrSql & " ," & ValorAcumSueldoBruto
StrSql = StrSql & " ," & FuturosAumentos
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    'Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Raffo (basado en el modelo 125 de Paradigma)
'--------------------------------------------------------------------
Sub generarDatosRecibo149(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim regimenHor
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim l_formapago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim NroSucursal
Dim Modelo As String
Dim Parametro
Dim Piso

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 12"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   Modelo = Trim(rsConsult!tprocdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If



'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   'Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el Valor de Venta
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 221  "
OpenRecordset StrSql, rsConsult

Parametro = "0"

Do While Not rsConsult.EOF
    Parametro = rsConsult!confval2
    rsConsult.MoveNext
Loop
rsConsult.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,localidad.locdesc,provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
    
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    Piso = ""
    If IsNull(rs_Domicilio!Piso) Then
        Piso = rs_Domicilio!Piso
    End If
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & Piso & ", " & rs_Domicilio!locdesc & " - " & rs_Domicilio!provdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma

Flog.writeline StrSql

If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la sucursal
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""
NroSucursal = 0

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
    NroSucursal = rsConsult!Estrnro
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        If rsConsult!fpagnro = 10 Then
            nroCuenta = rsConsult!Bandesc & " - CTA " & rsConsult!ctabnro
        Else
        If rsConsult!fpagnro = 9 Or rsConsult!fpagnro = 12 Then
            nroCuenta = "Efectivo o Cheque" & " "
        Else
            nroCuenta = "0"
        End If
        End If
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
Else
        nroCuenta = "0"
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

Flog.writeline StrSql

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2,"
StrSql = StrSql & " auxchar3, auxchar4, auxchar5, auxchar6, auxchar7, auxchar8)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & l_formapago & "'"
StrSql = StrSql & "," & NroSucursal
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sucursal & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ",'" & Modelo & "'"
StrSql = StrSql & ",'" & Parametro & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND (concepto.concimp = -1 OR concepto.conccod = '" & Parametro & "')"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub






'--------------------------------------------------------------------
' Se encarga de generar los datos para GEMPLAST
'--------------------------------------------------------------------
Sub generarDatosRecibo150(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial As String
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpFirma As String
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim pliqdesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim CodCAT As Long
Dim CodDPTO As Long

Dim Modelo As String
Dim LugarPago As String
Dim codPago As Integer

Dim Cod80Conc
Dim Cod80Acum
Dim tipo80

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro "
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = IIf(EsNulo(rsConsult!proFecPago), "", rsConsult!proFecPago)
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Modelo = IIf(EsNulo(rsConsult!tprocdesc), "", rsConsult!tprocdesc)
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = IIf(EsNulo(rsConsult!pliqdesc), "", rsConsult!pliqdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
   Cuil = ""
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'---------------------------------------------------------------------------------------
'Busco la descripcion abreviada de la estructura configurada en el confrep columna 100
'---------------------------------------------------------------------------------------
codPago = "20" 'codigo de estructura de lugar de pago por default
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 100 "
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para la columna 100."
Else
    If rsConsult!conftipo = "TE" Then
          codPago = rsConsult!confval
    Else
          Flog.writeline " El Tipo de Columna 100 del confrep no es: TE. "
    End If
End If



StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & codPago & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""
If Not rsConsult.EOF Then
   LugarPago = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se encontro un valor para la estructura configurada en la columna 100."
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = ""
If Not rsConsult.EOF Then
   Categoria = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se encontro CAT."
End If
rsConsult.Close
'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrnro, estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rs_estructura

ObraSocial = ""

If Not rs_estructura.EOF Then
    ObraSocial = IIf(EsNulo(rs_estructura!estrdabr), "", rs_estructura!estrdabr)
Else
   Flog.writeline "Error al obtener los datos de la OS"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de ingreso
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases WHERE empleado = " & Ternro '& " AND real = -1 AND estado = -1 " &
StrSql = StrSql & " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult
empFecAlta = ""
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   'Flog.writeline "Error al obtener la fecha de ingreso. Verificar que tenga una fase marcada como REAL y ACTIVA"
   Flog.writeline "Error al obtener la fecha de ingreso."
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc Banco, ctabancaria.ctabnro Numcuenta"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
If Not rsConsult.EOF Then
    FormaPago = IIf(EsNulo(rsConsult!Numcuenta), "", rsConsult!Numcuenta)
    FormaPago = FormaPago & ", " & IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   Flog.writeline "No se encontro los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la columna 80 del confrep, IMP. ADICIONAL
'------------------------------------------------------------------
Flog.writeline "Buscando columna 80 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 80   "
OpenRecordset StrSql, rsConsult

Sueldo = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                Sueldo = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                Sueldo = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 80 Sueldo "
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = IIf(EsNulo(rsConsult!periodoant), "", rsConsult!periodoant)
   pliqfecdep = IIf(EsNulo(rsConsult!Fecha), "", rsConsult!Fecha)
   pliqbco = IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If
Flog.writeline "Cargas Sociales" & StrSql
rsConsult.Close

'Consulta para buscar la firma de la empresa
Flog.writeline "Empresa Firma"
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If
Flog.writeline "Empresa Firma" & StrSql
rs_firma.Close
        
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc,codigopostal,barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
End If
Flog.writeline "Direccion de la Empresa" & StrSql
rsConsult.Close

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rsConsult!NroDoc
End If
Flog.writeline "Cuit de la Empresa" & StrSql
rsConsult.Close



'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rsConsult!tipimdire & rsConsult!terimnombre
    EmpLogoAlto = rsConsult!tipimaltodef
    EmpLogoAncho = rsConsult!tipimanchodef
End If
Flog.writeline "Logo de la Empresa" & StrSql
rsConsult.Close
rs_estructura.Close
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, auxchar1, auxchar2, auxchar3, auxchar4, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Mid(Apellido, 1, 50) & "'"
StrSql = StrSql & ",'" & Mid(Nombre, 1, 50) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & Mid(pliqdepant, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(pliqfecdep, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(pliqbco, 1, 40) & "'"
StrSql = StrSql & ",'" & Mid(Cuil, 1, 30) & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(proFecPago, 1, 10) & "'"
StrSql = StrSql & ",'" & Mid(EmpNombre, 1, 100) & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & Mid(EmpFirma, 1, 100) & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & Mid(proDesc, 1, 60) & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Modelo, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 100) & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Brasil
'--------------------------------------------------------------------
Sub generarDatosRecibo151(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim StrSql1 As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Localidad
Dim LocDireccion
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim pliqdesde
Dim Salario
Dim EPS

Dim DatosEmp
Dim DatosDecao
Dim DatosFilial
Dim DatosSector
Dim DatosDepto
Dim DatosLocal
Dim DatosCBO

Dim Salariobase
Dim INSS
Dim BaseFGT
Dim FGTS
Dim IRRF
Dim FaixaIRRF

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsconfrep As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso Brasil
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado Brasil
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual Brasil
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqdesde = rsConsult!pliqdesde
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=1) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la localidad de la sucursal
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   LocDireccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!codigopostal & " " & rsConsult!locdesc
Else
   Localidad = "  "
   LocDireccion = "  "
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del CBO Columna 5
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 224 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosCBO = rsConsult!estrcodext
    Else
       DatosCBO = " "
       Flog.writeline "No se encontraron datos en el confrep para el CBO"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del EMP Columna 6
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 225 "

OpenRecordset StrSql, rsconfrep
Flog.writeline "ejecuto confrep col 225"
If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosEmp = rsConsult!estrcodext
    Else
       DatosEmp = ""
       Flog.writeline "No se encontraron datos en el confrep para el EMP"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del Local Columna 7
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 226 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosLocal = rsConsult!estrcodext
    Else
       DatosLocal = ""
       Flog.writeline "No se encontraron datos en el confrep para el Local"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del DEPTO Columna 8
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 227 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosDepto = rsConsult!estrcodext
    Else
       DatosDepto = ""
       Flog.writeline "No se encontraron datos en el confrep para el DEPTO"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del Sector Columna 9
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 228 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosSector = rsConsult!estrcodext
    Else
       DatosSector = ""
       Flog.writeline "No se encontraron datos en el confrep para el Sector"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del Decao Columna 10
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 229 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosDecao = rsConsult!estrcodext
    Else
       DatosDecao = ""
       Flog.writeline "No se encontraron datos en el confrep para el Decao"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el codigo en el confrep del Filial Columna 11
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 230 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    StrSql = " SELECT estrdabr,estructura.estrnro,estrcodext "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
    StrSql = StrSql & " AND his_estructura.tenro= " & rsconfrep!confval
    StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
           
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DatosFilial = rsConsult!estrcodext
    Else
       DatosFilial = ""
       Flog.writeline "No se encontraron datos en el confrep para el Filial"
    '   GoTo MError
    End If
End If
'rsConsult.Close
'rsconfrep.Close
'-------------------------------------------------------------------------------------------------------------------------------------
'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el valor de la columna 231 del confrep, Salario Base
'-------------------------------------------------------------------------------------------------------------------------------------
Flog.writeline "Buscando columna 231 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 231   "
OpenRecordset StrSql, rsConsult

Salariobase = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                Salariobase = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                Salariobase = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 231 Salario Base "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 232 del confrep, Sal. Contr. INSS
'------------------------------------------------------------------
Flog.writeline "Buscando columna 232 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 232   "
OpenRecordset StrSql, rsConsult

INSS = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                INSS = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                INSS = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 232 INSS "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 233 del confrep, Base Calc FGT
'------------------------------------------------------------------
Flog.writeline "Buscando columna 233 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 233   "
OpenRecordset StrSql, rsConsult

BaseFGT = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                BaseFGT = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                BaseFGT = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 233 Base Calc FGT "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 234 del confrep, FGTS do Mes
'------------------------------------------------------------------
Flog.writeline "Buscando columna 234 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 234   "
OpenRecordset StrSql, rsConsult

FGTS = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                FGTS = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                FGTS = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 234 FGT do Mes "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 235 del confrep, Base Calc IRRF
'------------------------------------------------------------------
Flog.writeline "Buscando columna 235 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 235   "
OpenRecordset StrSql, rsConsult

IRRF = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                IRRF = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                IRRF = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 235 IRRF "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 236 del confrep, Faixa IRRF
'------------------------------------------------------------------
Flog.writeline "Buscando columna 236 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 236   "
OpenRecordset StrSql, rsConsult

FaixaIRRF = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                FaixaIRRF = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                FaixaIRRF = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 236 FaixaIRRF "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 237 del confrep, Valor Liquido
'------------------------------------------------------------------
Flog.writeline "Buscando columna 237 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 237   "
OpenRecordset StrSql, rsConsult

ValorLiq = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                ValorLiq = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                ValorLiq = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 237 ValorLiq "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 238 del confrep, Total de Descuentos
'------------------------------------------------------------------
Flog.writeline "Buscando columna 238 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 238 "
OpenRecordset StrSql, rsConsult

TotalDesc = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                TotalDesc = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                TotalDesc = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 238 Total Descuento "
End If

'------------------------------------------------------------------
'Busco el valor de la columna 239 del confrep, Total de Vencimientos
'------------------------------------------------------------------
Flog.writeline "Buscando columna 239 del confrep para traer el tipo de concepto o Acumulador del recibo "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 239   "
OpenRecordset StrSql, rsConsult

TotalVenc = 0

If Not rsConsult.EOF Then
    If rsConsult!conftipo = "AC" Then
       tipo80 = "AC"
       Cod80Acum = rsConsult!confval
    ElseIf rsConsult!conftipo = "CO" Then
       tipo80 = "CO"
       Cod80Conc = rsConsult!confval2
    End If
    
    Select Case tipo80
        Case "CO"
            StrSql = " SELECT detliq.dlimonto "
            StrSql = StrSql & " FROM detliq "
            StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & Cod80Conc
            StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
            StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                TotalVenc = rsConsult!dlimonto
            End If
        Case "AC"
            StrSql = " SELECT almonto"
            StrSql = StrSql & " From acu_liq"
            StrSql = StrSql & " Where acunro = " & Cod80Acum
            StrSql = StrSql & " AND cliqnro = " & cliqnro
            OpenRecordset StrSql, rsConsult
            If Not rsConsult.EOF Then
                TotalVenc = rsConsult!almonto
            End If
    End Select
Else
    Flog.writeline " No se configuro el confrep para la columna 239 Total Vencimientos "
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "<br>(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero " & _
'         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
'         " Where tercero.ternro =" & rs_estructura!Ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el CUIT de la Empresa"
'    'Exit Sub
'    EmpCuit = "  "
'Else
'    EmpCuit = rs_cuit!NroDoc
'End If

'Consulta para obtener el Tipo de Documento de la empresa

'-------------------------------------------------------------------------------------------------------------------------------------
'Busco el Tipo de Documento de la Empresa Columna 240
'-------------------------------------------------------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 240 "

OpenRecordset StrSql, rsconfrep

If Not rsconfrep.EOF Then
    Tipo_Docu = rsconfrep!confval
Else
    Tipo_Docu = 1209
    response.Write ("No se configuro el Tipo de Documento de la Empresa. Se pone por defecto el 1209")
End If

StrSql = "SELECT ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " INNER JOIN ter_doc ON tercero.ternro = ter_doc.ternro"
StrSql = StrSql & " AND ter_doc.tidnro = " & Tipo_Docu
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el Tipo de Documento de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar6,auxchar7,auxchar8, "
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxdeci4,auxdeci5,auxdeci6) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(LocDireccion, 1, 100) & "'"
StrSql = StrSql & ",'" & DatosCBO & "'"
StrSql = StrSql & ",'" & DatosEmp & "'"
StrSql = StrSql & ",'" & DatosDepto & "'"
StrSql = StrSql & ",'" & DatosLocal & "'"
StrSql = StrSql & ",'" & DatosSector & "'"
StrSql = StrSql & ",'" & DatosDecao & "'"
StrSql = StrSql & ",'" & DatosFilial & "'"
StrSql = StrSql & "," & Salariobase
StrSql = StrSql & "," & INSS
StrSql = StrSql & "," & BaseFGT
StrSql = StrSql & "," & FGTS
StrSql = StrSql & "," & IRRF
StrSql = StrSql & "," & FaixaIRRF
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop
rsconfrep.Close
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'agrego modelo sebastian stremel
'--------------------------------------------------------------------
' Se encarga de generar los datos para el recibo de Kraft Chile
'--------------------------------------------------------------------
Sub generarDatosRecibo152(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim StrSql1 As String
Dim StrSql2 As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult1 As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'estructura afp y sistema de salud
Dim AFP
Dim Salud

Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Long
Dim EmpLogoAncho As Long
Dim EmpFirmaAlto As Long
Dim EmpFirmaAncho As Long
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim Documento
Dim regHorario
Dim Sector
Dim DNRP
Dim Antiguedad

Dim Dia As Long
Dim Mes As Long
Dim Anio As Long
Dim DiasHabiles As Long
Dim subTotalRemun
'Dim StrSql
Dim objRs2 As New ADODB.Recordset

Dim Bandesc
Dim ctabancaria
Dim esdtrab
Dim DiasTrab

Dim NoImponible
Dim esNoImponibleConc

Dim esAfectoImpConc
Dim acunroAfectoImp

Dim esLiqApagarConc
Dim acunroLiqApagar

Dim acunroDtosPrev
Dim esDtosPrevConc

Dim TEAfp As Long
Dim TEIsapre As Long
Dim NroEscala
Dim Porc As Long
Dim ConcPorc As Long
Dim PMonto As Long
Dim ConcPMonto As Long
Dim CantidadUf As Long
Dim ConcCantidadUf As Long

Dim NConcParam1 As Double
Dim NConcParam2 As Double
Dim NConcParam3 As Double

Dim SumPorcentaje As Double
Dim Valores

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

NConcParam1 = 0
NConcParam2 = 0
NConcParam3 = 0

SumPorcentaje = 0
AFP = ""
Salud = ""

'confrep
'agrego sebastian stremel 19/09/2011
StrSql = " SELECT * FROM confrep "
'StrSql = StrSql & " WHERE repnro = 60 and (confnrocol=12 or confnrocol=10 or confnrocol=16 or confnrocol=105 or confnrocol=106 or confnrocol=107 or confnrocol=108 or confnrocol=109)"
StrSql = StrSql & " WHERE repnro = 60 and confnrocol in (10,12,16,105,106,107,108,109,110,112,113,114,115,116)"
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep"
    Exit Sub
End If

Do Until rsConsult.EOF
    Flog.writeline "Columna " & rsConsult!confnrocol
    Select Case rsConsult!confnrocol
    Case 10
        cargo = rsConsult!confval
    Case 12
        sBase = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esSueldoBase = True
        Else
            esSueldoBase = False
        End If
    Case 16
        dtrab = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esdtrab = True
        Else
            esdtrab = False
        End If
        
    Case 105
        acunroImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esImponibleConc = True
        Else
            esImponibleConc = False
        End If
    
    Case 106
        acunroNoImponible = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esNoImponibleConc = True
        Else
            esNoImponibleConc = False
        End If
    
    Case 107
        acunroAfectoImp = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esAfectoImpConc = True
        Else
            esAfectoImpConc = False
        End If
        
    Case 108
        acunroDtosPrev = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esDtosPrevConc = True
        Else
            esDtosPrevConc = False
        End If
        
    Case 109
        acunroLiqApagar = rsConsult!confval
        If rsConsult!conftipo = "CO" Then
            esLiqApagarConc = True
        Else
            esLiqApagarConc = False
        End If
        
    ' Agregadas por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
    'Inicio
    Case 110
        If rsConsult!conftipo = "TE" Then
            TEAfp = rsConsult!confval
        Else
            Flog.writeline "La columna 110 AFP debe ser un Tipo de Estructura. "
        End If
                                   
    Case 112
        If rsConsult!conftipo = "TE" Then
            TEIsapre = rsConsult!confval
        Else
            Flog.writeline "La columna 112 ISAPRE debe ser un Tipo de Estructura. "
        End If
        
    Case 113
        If rsConsult!conftipo = "NE" Then
            NroEscala = rsConsult!confval
        Else
            Flog.writeline "La columna 113 Nro de Escala debe ser un Número de Escala. "
        End If
        
    Case 114
        If rsConsult!conftipo = "NPC" Then
            Porc = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPorc = 0
            Else
              ConcPorc = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 114 Parámetro 1 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 115
        If rsConsult!conftipo = "NPC" Then
            PMonto = rsConsult!confval
        
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcPMonto = 0
            Else
              ConcPMonto = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 115 Parámetro 2 debe ser un Parámetro de un Concepto. "
        End If
        
    Case 116
        If rsConsult!conftipo = "NPC" Then
            CantidadUf = rsConsult!confval
            
            StrSql = "SELECT concnro FROM concepto WHERE conccod = '" & rsConsult!confval2 & "'"
            OpenRecordset StrSql, objRs2
            If objRs2.EOF Then
              ConcCantidadUf = 0
            Else
              ConcCantidadUf = objRs2!ConcNro
            End If
            objRs2.Close
        Else
            Flog.writeline "La columna 116 Parámetro 3 debe ser un Parámetro de un Concepto. "
        End If
    'Fin
    End Select
    
    rsConsult.MoveNext
Loop
rsConsult.Close
'hasta aca


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro in (1,2,3,4,201)) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   'Documento = rsConsult!sigladoc & "-" & rsConsult!nrodoc
   Documento = rsConsult!sigladoc & "@" & rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regHorario = ""

If Not rsConsult.EOF Then
   regHorario = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del reg. horario"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la antiguedad del empleado
'------------------------------------------------------------------
'Call bus_Anti0(ternro, pliqanio, pliqmes, dia, mes, Anio)

Call antigfec(Ternro, pliqanio, pliqmes, Dia, Mes, Anio)

Antiguedad = " A&ntilde;os&nbsp;" & Anio & "&nbsp;Meses&nbsp;" & Mes & "&nbsp;D&iacute;as&nbsp;" & Dia

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto,detdom.barrio"
StrSql = StrSql & " FROM  cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE  cabdom.domdefault = -1 AND cabdom.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = IIf(sinDatos(rsConsult!calle), "", rsConsult!calle)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!nro), "", rsConsult!nro)
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!Piso), "", rsConsult!Piso & "P")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!oficdepto), "", """" & rsConsult!oficdepto & """")
   Direccion = Direccion & " " & IIf(sinDatos(rsConsult!barrio), "", rsConsult!barrio)
   Direccion = Direccion & "," & IIf(sinDatos(rsConsult!locdesc), "", rsConsult!locdesc)
   
Else
   Direccion = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!locdesc
   'localidad = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'busco el valor del sueldo base
'------------------------------------------------------------------
If esSueldoBase Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       StrSql = " select * from concepto where conccod=" & sBase 'cambio sebastian stremel
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        sBase = rsConsult2!ConcNro
       End If
       rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & sBase
       OpenRecordset StrSql, rsConsult2
       If Not rsConsult2.EOF Then
        Sueldo = rsConsult2!dlimonto
       Else
        Sueldo = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
Else
    Sueldo = 0
End If
Sueldo = Replace(Sueldo, ",", ".")
rsConsult2.Close

'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco el valor del Total Imponible
'------------------------------------------------------------------
If acunroImponible <> 0 And Not IsNull(acunroImponible) Then
    If esImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       Imponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total Imponible."
       Imponible = 0
    End If
Else
    Imponible = 0
End If
Imponible = Replace(Imponible, ",", ".")


'------------------------------------------------------------------
'Busco el valor del Total No Imponible
'------------------------------------------------------------------
If acunroNoImponible <> 0 And Not IsNull(acunroNoImponible) Then
    If esNoImponibleConc Then
        StrSql = " select * from concepto where conccod=" & acunroNoImponible 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroNoImponible = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroNoImponible 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroNoImponible
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       NoImponible = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total No Imponible."
       NoImponible = 0
    End If
Else
    NoImponible = 0
End If
NoImponible = Replace(NoImponible, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total afecto a impuesto
'------------------------------------------------------------------
If acunroAfectoImp <> 0 And Not IsNull(acunroAfectoImp) Then
    If esAfectoImpConc Then
        StrSql = " select * from concepto where conccod=" & acunroAfectoImp 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroAfectoImp = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroAfectoImp 'sebastian stremel
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroAfectoImp
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       afectoImp = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total afecto a impuesto."
       afectoImp = 0
    End If
Else
    afectoImp = 0
End If
'afectoImp = Replace(afectoImp, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de descuentos previsionales
'------------------------------------------------------------------
If acunroDtosPrev <> 0 And Not IsNull(acunroDtosPrev) Then
    If esDtosPrevConc Then
        StrSql = " select * from concepto where conccod=" & acunroDtosPrev 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroDtosPrev = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroDtosPrev
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroDtosPrev
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       dtosPrev = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       dtosPrev = 0
    End If
Else
    dtosPrev = 0
End If
dtosPrev = Replace(dtosPrev, ",", ".")

'------------------------------------------------------------------
'Busco el valor del Total de liquido a pagar
'------------------------------------------------------------------
If acunroLiqApagar <> 0 And Not IsNull(acunroLiqApagar) Then
    If esLiqApagarConc Then
        StrSql = " select * from concepto where conccod=" & acunroLiqApagar 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            acunroLiqApagar = rsConsult2!ConcNro
        End If
        rsConsult2.Close
        
        
        StrSql = " SELECT detliq.dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroLiqApagar
    Else
        StrSql = " SELECT almonto valor"
        StrSql = StrSql & " From acu_liq"
        StrSql = StrSql & " Where acunro = " & acunroLiqApagar
        StrSql = StrSql & " AND cliqnro = " & cliqnro
    End If
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       liqApagar = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los datos del Total descuentos previsionales."
       liqApagar = 0
    End If
Else
    liqApagar = 0
End If
liqApagar = Replace(liqApagar, ",", ".")


'------------------------------------------------------------------
'busco los dias trabajados
'------------------------------------------------------------------
If esdtrab Then
    StrSql = " SELECT * from cabliq "
    StrSql = StrSql & " where cliqnro= " & cliqnro & "and pronro= " & Pronro & " and empleado=" & Ternro
    
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        StrSql = " select * from concepto where conccod=" & dtrab 'cambio sebastian stremel
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            dtrab = rsConsult2!ConcNro
        End If
        rsConsult2.Close
       
       
       cliq = rsConsult!cliqnro
       StrSql = "select * from detliq where cliqnro= " & cliq & "and concnro=" & dtrab
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
        DiasTrab = rsConsult!dlimonto
       Else
        DiasTrab = 0
       End If
       
    Else
       Flog.writeline "Error al obtener los datos de los dias trabajados"
       DiasTrab = 0
       'GoTo MError
    End If
 Else
       StrSql = " SELECT almonto valor"
       StrSql = StrSql & " From acu_liq"
       StrSql = StrSql & " Where acunro = " & dtrab
       StrSql = StrSql & " AND cliqnro = " & cliqnro
       OpenRecordset StrSql, rsConsult
       If Not rsConsult.EOF Then
            dtrab = rsConsult!Valor
       Else
            Flog.writeline "Error al obtener los datos de los dias trabajados"
            DiasTrab = 0
       End If
    
End If

'------------------------------------------------------------------

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabancaria.ctabnro, formapago.fpagdescabr, formapago.fpagbanc, banco.bandesc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " INNER JOIN ctabancaria on pago.cbnro = ctabancaria.cbnro"
StrSql = StrSql & " INNER JOIN banco on banco.ternro=ctabancaria.banco "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
OpenRecordset StrSql, rsConsult

FormaPago = ""
'FormaPago = "Forma de Pago: Dep&oacute;sito Bancario"
If Not rsConsult.EOF Then
    'If rsConsult!fpagbanc = "-1" Then
        'FormaPago = "Forma de Pago: " & rsConsult!fpagdescabr & " - Cuenta N&deg; " & rsConsult!ctabnro
        FormaPago = FormaPago & rsConsult!Bandesc & "@" & rsConsult!ctabnro & "@"
    'End If
Else
   Flog.writeline "No se encontraron los datos de la forma de pago."
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
' busco el banco y las cuentas
'------------------------------------------------------------------
'    StrSql = "SELECT DISTINCT fpagnro from pedidopago "
'    StrSql = StrSql & " where pliqnro= " & pliqnro
'    OpenRecordset StrSql, rsConsult
'    FormaPago = ""
'    Do While Not rsConsult.EOF
'        StrSql1 = " select top 2 * from ctabancaria "
'        StrSql1 = StrSql1 & " Where fpagnro =" & rsConsult!fpagnro & ""
'        StrSql1 = StrSql1 & " and ctabestado=-1 and ternro=" & Ternro
'        OpenRecordset StrSql1, rsConsult1
'        Do While Not rsConsult1.EOF
'            ctabancaria = rsConsult1!ctabnro
'            StrSql2 = "select * from banco where ternro=" & rsConsult1!Banco
'            OpenRecordset StrSql2, rsConsult2
'            Bandesc = rsConsult2!Bandesc
'            rsConsult1.MoveNext
'            FormaPago = FormaPago & Bandesc & "@" & ctabancaria & "@"
'        Loop
  
'   rsConsult.MoveNext
'   Loop

'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If

'------------------------------------------------------------------
'Busco el valor del subtotal remunerativo
'------------------------------------------------------------------

StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = " & acumSubTotalRemun
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   subTotalRemun = rsConsult!almonto
Else
   Flog.writeline "No se encontro el subtotal remunerativo"
   subTotalRemun = 0
   'GoTo MError
End If
subTotalRemun = Replace(subTotalRemun, ",", ".")

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & cargo & "  And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   If Puesto = "" Then
    Puesto = "No Definido"
   End If
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'  If rsConsult!fpagbanc = "-1" Then
'    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
'  Else
'    FormaPago = rsConsult!fpagdescabr
'  End If
'Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
'End If

'rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 201)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco el valor del DNRP de la empresa
'------------------------------------------------------------------
StrSql = " SELECT dnrp.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc dnrp ON (tercero.ternro=dnrp.ternro and dnrp.tidnro=30) "
StrSql = StrSql & " WHERE tercero.ternro= " & rs_estructura!Ternro
       
OpenRecordset StrSql, rsConsult

DNRP = ""

If Not rsConsult.EOF Then
   DNRP = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'Agregado por Carmen Quintero 07/12/2011 para las columnas AFP, COTIZACION, ISAPRE-PLAN, UF, %, MONTO
'Inicio
Flog.writeline "Busco el nombre de la estructura AFP a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura AFP a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   AFP = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura AFP"
End If
rsConsult.Close

Flog.writeline "Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado"
'------------------------------------------------------------------
'Busco el nombre de la estructura Sistema de Salud a la cual pertenece el empleado
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEIsapre & " AND his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Salud = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la estructura Sistema de Salud"
End If
rsConsult.Close

Flog.writeline "Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep"
'------------------------------------------------------------------
'Busco la sumatoria del % de aportes  y el % de la comisión para la escala indica en el confrep
'------------------------------------------------------------------

StrSql = "SELECT sum(vgrvalor)suma"
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TEAfp & " AND his_estructura.Ternro = " & Ternro
StrSql = StrSql & " INNER JOIN valgrilla ON valgrilla.vgrcoor_1 = estructura.estrnro"
StrSql = StrSql & " WHERE cgrnro = " & NroEscala
StrSql = StrSql & " AND vgrorden in (1,2)"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not IsNull(rsConsult!suma) Then
        SumPorcentaje = rsConsult!suma
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 1 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parámetro 1 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPorc
StrSql = StrSql & " AND tpanro= " & Porc
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam1 = rsConsult!nevalor
        End If
    Else
        NConcParam1 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 2 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 2 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcPMonto
StrSql = StrSql & " AND tpanro= " & PMonto
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam2 = rsConsult!nevalor
        End If
    Else
       NConcParam2 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Flog.writeline "Busco la novedad del parámetro 3 del concepto"
'------------------------------------------------------------------
'Busco la novedad del Parametro 3 de un concepto indicado en el confrep
'------------------------------------------------------------------
StrSql = "SELECT * FROM novemp "
StrSql = StrSql & " WHERE concnro = " & ConcCantidadUf
StrSql = StrSql & " AND tpanro= " & CantidadUf
StrSql = StrSql & " AND empleado = " & Ternro
StrSql = StrSql & " ORDER BY nedesde desc "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!nevigencia = -1 Then
        If (rsConsult!nedesde <= pliqhasta And (IsNull(rsConsult!nehasta) Or rsConsult!nehasta >= pliqhasta)) Then
            NConcParam3 = rsConsult!nevalor
        End If
    Else
        NConcParam3 = rsConsult!nevalor
    End If
End If
rsConsult.Close

Valores = Valores & AFP & "@" & SumPorcentaje & "@" & Salud & "@" & NConcParam3 & "@" & NConcParam1 & "@" & NConcParam2 & "@"

'Fin
'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar3, auxchar4, auxchar5, auxdeci1,auxchar1,auxdeci2,auxdeci3,auxdeci4,auxdeci5,auxchar,auxchar2)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(AFP, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Salud, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & DNRP & "'"
StrSql = StrSql & "," & numberForSQL(subTotalRemun)
StrSql = StrSql & ",'" & DiasTrab & "'"
StrSql = StrSql & "," & Imponible
StrSql = StrSql & "," & NoImponible
StrSql = StrSql & "," & afectoImp
StrSql = StrSql & "," & dtosPrev
StrSql = StrSql & ",'" & liqApagar & "'"
StrSql = StrSql & ",'" & Valores & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub generarDatosRecibo153(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'--------------------------------------------------------------------
' Boleta de Pago - Perú CDA - Basado en el modelo 126 (se hizo más configurable)
'--------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim NroDoc

'Fechas de fases
Dim empFecAlta
Dim empFecBaja
'---------------

Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer

'Auxchar
Dim Estructuracargo As String
Dim EstructuraAFP As String

'Dim Ubicacion As String
'-----
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
 
'Auxdeci
Dim HrsTrabajadas
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
'Dim ObraSocial
Dim CarnetAFP
Dim TipoDocu

Dim EstructuraUbicacion
Dim EstructuraSede
Dim EstructuraCCosto
Dim EstructuraArea

Dim periodo_vac_desde As String
Dim periodo_vac_hasta As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valorSueldo As Double
Dim codSueldo As String
Dim cod_ruc
Dim codPago

codSueldo = "0"

On Error GoTo MError

TipoDocu = 0
codPago = 0

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'LEVANTO DEL CONFREP LOS VALORES DEL CONCEPTO SUELDO
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do While Not rsConsult.EOF
        'levanto datos del confrep
        Select Case rsConsult!confnrocol
            Case 210: 'RUC  de la empresa
                cod_ruc = IIf(Not EsNulo(rsConsult!confval), rsConsult!confval, "0")
            Case 242: 'Conceptos sueldo
                If (Not EsNulo(rsConsult!conftipo)) And (rsConsult!conftipo = "CO") Then
                    codSueldo = codSueldo & IIf(Not EsNulo(rsConsult!confval2), ", " & rsConsult!confval2, "")
                End If
            Case 49: 'Dias Trabajados
                ConcDiasTrabajados = IIf(Not EsNulo(rsConsult!confval), rsConsult!confval, "")
            Case 90: 'Cantidad de Horas
                conCantidadHoras = IIf(Not EsNulo(rsConsult!confval), rsConsult!confval, "0")
            Case 243: 'Tipo de documento del empleado
                TipoDocu = TipoDocu & IIf(Not EsNulo(rsConsult!confval), "," & rsConsult!confval, "")
            Case 245: 'Codigos de pago del período vacacional
                codPago = codPago & IIf(Not EsNulo(rsConsult!confval), "," & rsConsult!confval, "")
        End Select
    rsConsult.MoveNext
    Loop
Else
    Flog.writeline " No esta configurado el confrep"
End If
rsConsult.Close




'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidación y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de Alta y Baja de la última fase Activa
'------------------------------------------------------------------
StrSql = "SELECT empleado,altfec,bajfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   empFecBaja = rsConsult!bajfec
   
   '********************************
   'FALTA AGREGAR AL INSERT (BAJFEC)
   '********************************
Else
   Flog.writeline "No existe fase para el empleado ternro:" & Ternro
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la estructura "CARGO" desde el confrep | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=117)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   Estructuracargo = rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos de cargo. Revisar configuración de Columna 117 del confrep"
   'GoTo MError
End If
rsConsult.Close
 
 
'------------------------------------------------------------------
'Busco la estructura "AFP" desde el confrep | COLUMNA FIJA 118 (AFP)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=118)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   EstructuraAFP = rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos de AFP. Revisar configuración de Columna 118 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'BUSCO EL VALOR DEL CAMPO SUELDO DEL RECIBO
'------------------------------------------------------------------
If codSueldo <> "0" Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod IN (" & codSueldo & ")"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       valorSueldo = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener el valor del campo sueldo."
       valorSueldo = 0
    End If
    rsConsult.Close
Else
    valorSueldo = 0
End If



'------------------------------------------------------------------
'Busco el valor de los días trabajados | COLUMNA 49
'------------------------------------------------------------------
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = rsConsult!Valor
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
    rsConsult.Close
Else
    DiasTrabajados = 0
End If
 
'------------------------------------------------------------------
'Busco el valor de la cantidad de horas | COLUMNA 90
'------------------------------------------------------------------
StrSql = "SELECT detliq.dlimonto "
StrSql = StrSql & " FROM detliq "
StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
StrSql = StrSql & " AND detliq.concnro = " & conCantidadHoras
Flog.writeline StrSql
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    HrsTrabajadas = rsConsult!dlimonto
Else
    HrsTrabajadas = 0
 End If
rsConsult.Close

FormaPago = ""


'---------------------sebastian stremel 05/04/2013-----------------

'------------------------------------------------------------------
'Busco la estructura "UBICACION" desde el confrep | COLUMNA FIJA 300 (UBICACION)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=300)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    EstructuraUbicacion = rsConsult!estrdabr
Else
    EstructuraUbicacion = ""
    Flog.writeline "No se pudo obtener los datos de ubicacion. Revisar configuración de Columna 300 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "SEDE" desde el confrep | COLUMNA FIJA 301 (SEDE)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=301)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraSede = rsConsult!estrdabr
Else
    EstructuraSede = ""
    Flog.writeline "No se pudo obtener los datos de sede. Revisar configuración de Columna 301 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "CENTRO DE COSTO" desde el confrep | COLUMNA FIJA 302 (C.COSTO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=302)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraCCosto = rsConsult!estrdabr & rsConsult!estrcodext
Else
    EstructuraCCosto = ""
    Flog.writeline "No se pudo obtener los datos de centro de costo. Revisar configuración de Columna 302 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "AREA" desde el confrep | COLUMNA FIJA 303 (AREA)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=303)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraArea = rsConsult!estrdabr
Else
    EstructuraArea = ""
    Flog.writeline "No se pudo obtener los datos del area. Revisar configuración de Columna 303 del confrep"
End If
rsConsult.Close

'-----------------------HASTA ACA---------------------------------

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco Tipo de documento
'------------------------------------------------------------------
StrSql = " SELECT ter_doc.ternro,ter_doc.tidnro, ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc ON tercero.ternro=ter_doc.ternro"
StrSql = StrSql & " WHERE Tercero.Ternro = " & Ternro
StrSql = StrSql & " AND (ter_doc.tidnro in (" & TipoDocu & "))"
StrSql = StrSql & " ORDER BY tidnro ASC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Tipo de documento Columna  | CARNET AFP
'------------------------------------------------------------------
StrSql = " SELECT ter_doc.ternro,ter_doc.tidnro, ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc ON tercero.ternro=ter_doc.ternro"
StrSql = StrSql & " WHERE Tercero.Ternro = " & Ternro
StrSql = StrSql & " AND ter_doc.tidnro= (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=244)"
StrSql = StrSql & " ORDER BY tidnro ASC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CarnetAFP = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close



'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
    Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo


' ahora si tiene valor ==> lo recalcula sino deja el empremu
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
    rsConsult.Close
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto SALE DE LA COLUMNA 2 DEL CONFREP
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 304)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
    rsConsult.Close
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = ""


'------------------------------------------------------------------
'Busco el valor del puesto | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""
If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del centro de costo
''------------------------------------------------------------------
CentroCosto = ""
  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If
'rs_estructura.Close

StrSql = " SELECT * FROM ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro=ter_imag.tipimnro "
StrSql = StrSql & " WHERE ternro =" & rs_estructura!Ternro
StrSql = StrSql & " AND ter_imag.tipimnro=1"
OpenRecordset StrSql, rs_Domicilio
If Not rs_Domicilio.EOF Then
    EmpLogo = rs_Domicilio!tipimdire & rs_Domicilio!terimnombre
    EmpLogoAncho = IIf(EsNulo(rs_Domicilio!tipimanchodef), 0, rs_Domicilio!tipimanchodef)
    EmpLogoAlto = IIf(EsNulo(rs_Domicilio!tipimaltodef), 0, rs_Domicilio!tipimaltodef)
    Flog.writeline "Se encontro el logo de la empresa: " & EmpLogo
Else
    EmpLogo = ""
    EmpLogoAncho = 0
    EmpLogoAlto = 0
    Flog.writeline "No se encontro el logo de la empresa"
End If
rs_Domicilio.Close

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.torre, detdom.barrio From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & "@" & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!Piso
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!oficdepto
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    
    'Sebastian Stremel 19/07/2012
    If Not EsNulo(rs_Domicilio!torre) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!torre
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!barrio) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!barrio
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    'hasta aca
    'EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
    
End If
rs_Domicilio.Close


'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & cod_ruc & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el tipo de documento RUC de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If
rs_cuit.Close

'Consulta para buscar el logo de la empresa
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Banco = ""
nroCuenta = ""


'________________________________________________________________
'BUSCO EL PERIODO VACACIONAL
StrSql = " SELECT * FROM emp_lic "
StrSql = StrSql & " INNER JOIN vacpagdesc ON vacpagdesc.emp_licnro = emp_lic.emp_licnro "
StrSql = StrSql & " WHERE Empleado =" & Ternro & " And tdnro = 2 And pliqnro = " & pliqnro
StrSql = StrSql & " AND vacpagdesc.pronro =" & Pronro
StrSql = StrSql & " AND pago_dto in(" & codPago & ")" '1 y 3 son los codigos de pago
OpenRecordset StrSql, rs_cuit
If Not rs_cuit.EOF Then
    Flog.writeline "Se encontro el periodo vacacional"
    periodo_vac_desde = rs_cuit!elfechadesde
    periodo_vac_hasta = rs_cuit!elfechahasta
Else
    Flog.writeline "No se encontro el periodo vacacional, query: " & StrSql
    periodo_vac_desde = ""
    periodo_vac_hasta = ""
End If
rs_cuit.Close
'________________________________________________________________

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " ("
StrSql = StrSql & " bpronro,ternro,pronro"
StrSql = StrSql & " ,apellido,Nombre,direccion,Legajo"
StrSql = StrSql & " ,pliqnro,pliqmes,pliqanio,pliqdepant"
StrSql = StrSql & " ,pliqfecdep,pliqbco,cuil,empfecalta"
StrSql = StrSql & " ,sueldo,categoria,centrocosto,localidad"
StrSql = StrSql & " ,profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma"
StrSql = StrSql & " ,empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto "
StrSql = StrSql & " ,tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden"
StrSql = StrSql & " ,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
StrSql = StrSql & " ,auxdeci1,auxdeci2,auxdeci3,auxchar6"
StrSql = StrSql & " ,auxchar7,auxchar8,auxchar9, auxdeci4"
StrSql = StrSql & " ) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
'StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(EstructuraCCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

'Auxchar
StrSql = StrSql & ",'" & CarnetAFP & "'"
'StrSql = StrSql & ",'" & Banco & "'"
'StrSql = StrSql & ",'" & nroCuenta & "'"

StrSql = StrSql & ",'" & periodo_vac_desde & "'"
StrSql = StrSql & ",'" & periodo_vac_hasta & "'"


StrSql = StrSql & ",'" & EstructuraAFP & "'"   'AFP
StrSql = StrSql & ",'" & Estructuracargo & "'" ' CARGO
'Auxdeci
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & "," & DiasTrabajados
StrSql = StrSql & "," & HrsTrabajadas
StrSql = StrSql & ",'" & empFecBaja & "'" 'sebastian stremel

'auxchar
StrSql = StrSql & ",'" & EstructuraUbicacion & "'"
StrSql = StrSql & ",'" & EstructuraSede & "'"
StrSql = StrSql & ",'" & EstructuraArea & "'"
StrSql = StrSql & "," & IIf(EsNulo(valorSueldo), 0, valorSueldo)

StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Flog.writeline "----------------------------------------------------------------------------------------"
Flog.writeline ""
Flog.writeline ""

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Plusmar
'--------------------------------------------------------------------
Sub generarDatosRecibo154(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol = 44"
StrSql = StrSql & " AND conftipo = 'COP'"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Titulo = objRs2!confetiq
    
    If objRs2!confval = 1 Then
        StrSql = " SELECT estrdabr FROM his_estructura"
        StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro"
        StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
        StrSql = StrSql & " AND his_estructura.tenro = " & objRs2!confval2
        StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Datos = rsConsult2!estrdabr
        End If
    ElseIf objRs2!confval = 2 Then
            If CDate(Day(Date) & "/" & Month(Date) & "/" & Year(Date)) > CDate(Day(empFecAlta) & "/" & Month(empFecAlta) & "/" & Year(empFecAlta)) Then
                DiasAcum = 0
                Dias = 0
                YaEntro = False
                
                StrSql = "SELECT * FROM fases WHERE empleado = " & Ternro
                StrSql = StrSql & " AND real = -1"
                StrSql = StrSql & " AND NOT altfec is NULL"
                StrSql = StrSql & " AND NOT (bajfec is NULL AND estado = 0)"
                StrSql = StrSql & " AND altfec <= " & ConvFecha(Date)
                StrSql = StrSql & " ORDER BY altfec ASC"
                OpenRecordset StrSql, rs_Fases
                Do While Not rs_Fases.EOF
                    fecalta = rs_Fases!altfec
                    
                    ' Verificar si se trata de un registro completo (alta/baja) o solo de un alta
                    If rs_Fases!estado Then
                        fecbaja = Date
                    ElseIf rs_Fases!bajfec <= Date Then
                        fecbaja = rs_Fases!bajfec
                    Else
                        fecbaja = Date
                    End If
                    
                    '12/11/2010 - Stankunas Cesar - Se cambió la lógica
                    Dias = DateDiff("d", fecalta, fecbaja)
                    If YaEntro Then
                        FechaAux = DateAdd("d", -(DiasAcum), fecalta)
                        DiasAcum = DiasAcum + Dias + 1
                    Else
                        DiasAcum = Dias + 1
                        FechaAux = fecalta
                    End If
                    YaEntro = True
                    
                    rs_Fases.MoveNext
                Loop
                rs_Fases.Close
                
                Datos = FechaAux
            End If
    ElseIf objRs2!confval = 3 Then
      acunroSueldo = CInt(objRs2!confval2)
        '------------------------------------------------------------------
    'Busco el valor del sueldo basico
    '------------------------------------------------------------------
    'Se configuró que el sueldo básico sale de un acumulador por confrep
      StrSql = " SELECT almonto"
      StrSql = StrSql & " From acu_liq"
      StrSql = StrSql & " Where acunro = " & acunroSueldo
      StrSql = StrSql & " AND cliqnro = " & cliqnro
      OpenRecordset StrSql, rsConsult
      If Not rsConsult.EOF Then
        Datos = rsConsult!almonto
      Else
        Flog.writeline "Error al obtener el acumulador configurado en la columna 44 " & Err.Description
        Datos = 0
      End If
    End If
Else
    Flog.writeline "No esta configurado el campo variable en el ConfRep (Columna 44)"
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Sector = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del sector"
End If


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la categoria"
End If


'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
Puesto = ""
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos del puesto"
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'Se elimina del modelo por definición
'------------------------------------------------------------------
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
'Else
'    Flog.writeline "Error al obtener los datos del centro de costo"
'End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT pago.fpagnro, ctabcbu, bandesc, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
' Se reactiva la consulta de descripcion del Banco "bandesc", quito la opción "terrazsoc"
'StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult

Flog.writeline "Forma de Pago " & StrSql

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
    If CInt(rsConsult!fpagnro) = 10 Or CInt(rsConsult!fpagnro) = 11 Then 'Caja de ahorro, informo Nro Cuenta
        CuentaBancaria = rsConsult!ctabnro
        Flog.writeline "La forma de pago del empleado es Caja de Ahorro"
    ElseIf CInt(rsConsult!fpagnro) = 15 Then 'CBU, informo el nro
        CuentaBancaria = rsConsult!ctabcbu
        Flog.writeline "La forma de pago del empleado es CBU"
    Else
        CuentaBancaria = ""
        Flog.writeline "Mal configurada la forma de pago. Debe ser CBU o CH"
    End If
    
    'Cargo los datos de descripción del banco
    If Not EsNulo(rsConsult!Bandesc) Then
      Banco = rsConsult!Bandesc
    Else
      Banco = ""
      Flog.writeline "No encontró la descripción del banco"
    End If
    
    PagoMonto = rsConsult!PagoMonto
Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
        Flog.writeline "No se encontró la forma de pago"
'End If
'rsConsult2.Close
    
PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad," 'centrocosto, se eliminó del insert
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Categoria & "'" 'Mid(Categoria, 1, 20) se coloca el campo completo por pedido
'Se eliminó el centro de costo, se elimina el insert para que no haga problema
'StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'"
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'"
StrSql = StrSql & " ,'" & LugarDePago & "'"
StrSql = StrSql & " ,'" & Titulo & "'"
StrSql = StrSql & " ,'" & Datos & "'"
StrSql = StrSql & " ," & NetoTalon
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CDA Mexico
'--------------------------------------------------------------------
Sub generarDatosRecibo155(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim rsConsult3 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Columna
Dim ColVal
Dim IMMS
Dim SalDiario
Dim SalIMMS
Dim DiasTrab
Dim Faltas
Dim Extras
Dim Departamento
Dim RFC
Dim RegPat
Dim NroRegPat


Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   'proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columnas 305 a 311 para del confrep"
StrSql = " SELECT count(*) total FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND ((confnrocol between 305 and 311) OR (confnrocol between 328 and 329))"
OpenRecordset StrSql, rsConsult3

If (rsConsult3!Total < 9) Then
    Flog.writeline "        ---> ERROR: Faltan configurar alguna/s de las siguientes columnas 305,306,307,308,309,310,311,328,329. Revise la configuración del reporte!"
    GoTo MError
End If

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND (confnrocol in (305,306,307,308,309,310,311,328,329))"
OpenRecordset StrSql, rsConsult3

IMMS = ""
SalDiario = 0
SalIMMS = 0
DiasTrab = 0
Faltas = 0
Extras = 0
Departamento = ""
RFC = 0
RegPat = 0

Do While Not rsConsult3.EOF
    StrSql = ""
    Columna = rsConsult3!confnrocol
    ColVal = rsConsult3!confval
    Flog.writeline "Columna " & Columna & ": " & IIf(sinDatos(rsConsult3!conftipo), "", rsConsult3!conftipo) & " Alfanumerico: " & IIf(sinDatos(rsConsult3!confval2), "", rsConsult3!confval2) & " Numerico: " & IIf(sinDatos(ColVal), "", ColVal)
    If rsConsult3!conftipo = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & ColVal & "AND cliqnro = " & cliqnro
    ElseIf rsConsult3!conftipo = "CO" Then
       StrSql = " SELECT d.dlimonto valor FROM detliq d INNER JOIN concepto c ON c.conccod = " & rsConsult3!confval2 & " AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    ElseIf rsConsult3!conftipo = "TE" Then
        StrSql = " SELECT estructura.estrdabr valor FROM estructura"
        StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
        StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
        StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
        StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
        StrSql = StrSql & " WHERE estructura.tenro = " & ColVal
    ElseIf rsConsult3!conftipo = "DOC" Then
        StrSql = " SELECT nrodoc valor FROM ter_doc WHERE ternro = " & Ternro & " and tidnro = " & ColVal
    End If
     
    If StrSql <> "" Then
        If (Columna <> 328) And (Columna <> 329) Then
            OpenRecordset StrSql, rsConsult
        
            If Not rsConsult.EOF Then
                Flog.writeline "        Valor para la columna " & Columna & " encontrado"
                Select Case Columna
                    Case 305
                        IMMS = rsConsult!Valor
                    Case 306
                        SalDiario = rsConsult!Valor
                    Case 307
                        SalIMMS = rsConsult!Valor
                    Case 308
                        DiasTrab = rsConsult!Valor
                    Case 309
                        Faltas = rsConsult!Valor
                    Case 310
                        Extras = rsConsult!Valor
                    Case 311
                        Departamento = rsConsult!Valor
                End Select
            Else
                Flog.writeline "        No se encontraron valores para la columna " & Columna
            End If
                
        Else
            Select Case Columna
                Case 328
                    RFC = ColVal
                Case 329
                    RegPat = ColVal
            End Select
        End If
        
    End If
   
   rsConsult3.MoveNext
Loop
rsConsult3.Close

If RFC = 0 Or RegPat = 0 Then
    If RFC = 0 Then
        Flog.writeline "        No se encontraron valores para la columna 328"
    End If
    If RegPat = 0 Then
        Flog.writeline "        No se encontraron valores para la columna 329"
    End If
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.proDesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   proDesc = rsConsult!pliqdesc & "   " & rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'
''------------------------------------------------------------------
''Busco los datos del tipos de estructura 1
''------------------------------------------------------------------
'If tenro1 <> 0 Then
'    If estrnro1 <> 0 Then
'        EmpEstrnro1 = estrnro1
'    Else
'        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
'        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
'        OpenRecordset StrSql, rsConsult
'        If Not rsConsult.EOF Then
'            EmpEstrnro1 = rsConsult!Estrnro
'        End If
'    End If
'End If
'
''------------------------------------------------------------------
''Busco los datos del tipos de estructura 2
''------------------------------------------------------------------
'If tenro2 <> 0 Then
'    If estrnro2 <> 0 Then
'        EmpEstrnro2 = estrnro2
'    Else
'        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
'        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
'        OpenRecordset StrSql, rsConsult
'        If Not rsConsult.EOF Then
'           EmpEstrnro2 = rsConsult!Estrnro
'        End If
'    End If
'End If
'
''------------------------------------------------------------------
''Busco los datos del tipos de estructura 3
''------------------------------------------------------------------
'If tenro3 <> 0 Then
'    If estrnro3 <> 0 Then
'        EmpEstrnro3 = estrnro3
'    Else
'        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
'        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
'        OpenRecordset StrSql, rsConsult
'        If Not rsConsult.EOF Then
'           EmpEstrnro3 = rsConsult!Estrnro
'        End If
'    End If
'End If



'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento RFC
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro = " & RFC
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento RFC"
    GoTo MError
End If



'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
    GoTo MError
End If



' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal, partido.partnom From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " INNER JOIN partido ON detdom.partnro = partido.partnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & ", " & rs_Domicilio!partnom
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " C.P. " & rs_Domicilio!codigopostal
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & RFC & ")"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RFC de la Empresa"
    EmpCuit = "  "
    GoTo MError
Else
    EmpCuit = rs_cuit!NroDoc & "   "
End If

StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = " & RegPat & ")"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el Reg. Pat. de la Empresa"
    NroRegPat = " "
    GoTo MError
Else
    NroRegPat = rs_cuit!NroDoc
End If


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad," 'centrocosto, se eliminó del insert
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5, auxchar3, auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Categoria & "'" 'Mid(Categoria, 1, 20) se coloca el campo completo por pedido
'Se eliminó el centro de costo, se elimina el insert para que no haga problema
'StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & IMMS & "'"
StrSql = StrSql & " ,'" & Departamento & "'"
StrSql = StrSql & " ,'" & SalDiario & "'"
StrSql = StrSql & " ,'" & SalIMMS & "'"
StrSql = StrSql & " ,'" & DiasTrab & "'"
StrSql = StrSql & " ,'" & Faltas & "'"
StrSql = StrSql & " ,'" & Extras & "'"
StrSql = StrSql & " ,'" & NroDocu & "'"
StrSql = StrSql & " ,'" & NroRegPat & "'"
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para CDA España
'--------------------------------------------------------------------
Sub generarDatosRecibo156(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim rsConsult3 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim Dias


Dim Columna

Dim CIF
Dim CtaCotizSS
Dim Poblacion
Dim NAfiliacion
Dim PedPago
Dim RemTotal
Dim ProPagEx
Dim Total
Dim GRU
Dim RegGral
Dim Desempleo
Dim HsExtras
Dim DtoContComunes
Dim DtoAccidente
Dim TotalDevengo
Dim TotalDedu
Dim TotalPercibe


Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

CIF = ""
CtaCotizSS = ""
Poblacion = ""
NAfiliacion = ""
PedPago = ""
RemTotal = 0
ProPagEx = 0
Total = 0
GRU = ""
RegGral = 0
Desempleo = 0
HsExtras = 0
DtoContComunes = ""
DtoAccidente = ""
TotalDevengo = 0
TotalDedu = 0
TotalPercibe = 0

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   'proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, proceso.proDesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   proDesc = rsConsult!pliqdesc & "   " & rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del confrep para las dos columna config
'------------------------------------------------------------------
Flog.writeline "Buscando columnas 312 a 327 para del confrep"
StrSql = " SELECT count(*) total FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND ( " & _
        "((confnrocol in (312,313,314,316,317,318,319,320,321,322,323,325,327)) and (conftipo in ('CO', 'AC'))) or " & _
        "((confnrocol in (324,326)) and (conftipo = 'DOC')) or " & _
        "((confnrocol in (315)) and (conftipo = 'TE'))" & _
        ")"
OpenRecordset StrSql, rsConsult3

If (rsConsult3!Total < 16) Then
    Flog.writeline "        ---> ERROR: Faltan configurar alguna/s de las siguientes columnas correctamente 312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327. Revise la configuración del reporte!"
End If

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND ( " & _
        "((confnrocol in (312,313,314,316,317,318,319,320,321,322,323,325,327)) and (conftipo in ('CO', 'AC'))) or " & _
        "((confnrocol in (324,326)) and (conftipo = 'DOC')) or " & _
        "((confnrocol in (315)) and (conftipo = 'TE'))" & _
        ")"
OpenRecordset StrSql, rsConsult3




Do While Not rsConsult3.EOF
    StrSql = ""
    Columna = rsConsult3!confnrocol
    Flog.writeline "Columna " & Columna & ": " & IIf(sinDatos(rsConsult3!conftipo), "", rsConsult3!conftipo) & " Valor Numerico: " & IIf(sinDatos(rsConsult3!confval2), "", rsConsult3!confval2) & " Valor Alfanumerico: " & IIf(sinDatos(rsConsult3!confval), "", rsConsult3!confval)
    If rsConsult3!conftipo = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & rsConsult3!confval & "AND cliqnro = " & cliqnro
    ElseIf rsConsult3!conftipo = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = " & rsConsult3!confval2 & " AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    ElseIf rsConsult3!conftipo = "TE" Then
        StrSql = " SELECT estructura.estrdabr valor FROM estructura"
        StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
        StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
        StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
        StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
        StrSql = StrSql & " WHERE estructura.tenro = " & rsConsult3!confval
    ElseIf rsConsult3!conftipo = "DOC" Then
        StrSql = " SELECT nrodoc valor FROM ter_doc WHERE ternro = " & Ternro & " and tidnro = " & rsConsult3!confval
    End If
     
    If StrSql <> "" Then
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
            Flog.writeline "        Valor para la columna " & Columna & " encontrado"
            Select Case Columna
                Case 312
                    RemTotal = rsConsult!Valor
                Case 313
                    ProPagEx = rsConsult!Valor
                Case 314
                    Total = rsConsult!Valor
                Case 315
                    GRU = rsConsult!Valor
                Case 316
                    RegGral = rsConsult!Valor
                Case 317
                    Desempleo = rsConsult!Valor
                Case 318
                    HsExtras = rsConsult!Valor
                Case 319
                    DtoContComunes = rsConsult!Valor & "@" & rsConsult!valor2
                Case 320
                    DtoAccidente = rsConsult!Valor & "@" & rsConsult!valor2
                Case 321
                    TotalDevengo = rsConsult!Valor
                Case 322
                    TotalDedu = rsConsult!Valor
                Case 323
                    TotalPercibe = rsConsult!Valor
                Case 324
                    CIF = rsConsult!Valor
                Case 325
                    CtaCotizSS = rsConsult!Valor
                Case 326
                    NAfiliacion = rsConsult!Valor
                Case 327
                    Dias = rsConsult!Valor
            End Select
        Else
            Flog.writeline "        No se encontraron valores para la columna " & Columna
            'GoTo MError
        End If
        
    End If
   
   rsConsult3.MoveNext
Loop
rsConsult3.Close

'------------------------------------------------------------------
'Busco estructura Categoria (3)
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr valor FROM estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " WHERE estructura.tenro = 3"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!Valor
Else
   Flog.writeline "Error al obtener La Categoría"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco estructura Puesto (4)
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr valor FROM estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " WHERE estructura.tenro = 4"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Puesto = rsConsult!Valor
Else
   Flog.writeline "Error al obtener el Puesto"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco estructura Contrato (18)
'------------------------------------------------------------------
StrSql = " SELECT estructura.estrdabr valor FROM estructura"
StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.estrnro = estructura.estrnro"
StrSql = StrSql & "     AND htetdesde <= " & ConvFecha(fecEstr)
StrSql = StrSql & "     AND (htethasta IS NULL OR htethasta >= " & ConvFecha(fecEstr) & ")"
StrSql = StrSql & "     AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " WHERE estructura.tenro = 18"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Contrato = rsConsult!Valor
Else
   Flog.writeline "Error al obtener el Contrato"
   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la fecha de alta
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases WHERE empleado = " & Ternro & " AND estado = -1 ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   'Antiguedad = rsConsult!altfec
Else
    empFecAlta = ""
    'Antiguedad = ""
    Flog.writeline "Error al obtener la Fecha de Alta, no se encontró ninguna fase activa"
   'GoTo MError
End If

'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento DNI
'------------------------------------------------------------------
StrSql = " SELECT nrodoc FROM ter_doc WHERE ternro = " & Ternro & " and tidnro = 1"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento DNI"
End If



'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If



' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
'StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal, partido.partnom, provincia.provdesc From cabdom"
StrSql = "SELECT detdom.calle,detdom.nro, detdom.piso, detdom.oficdepto, detdom.codigopostal, provincia.provdesc From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'StrSql = StrSql & " INNER JOIN partido ON detdom.partnro = partido.partnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    'If Not EsNulo(rs_Domicilio!Piso) Then
    '    EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    'End If
    'If Not EsNulo(rs_Domicilio!oficdepto) Then
    '    EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    'End If
    'EmpDire = EmpDire & ", " & rs_Domicilio!partnom
    'If Not EsNulo(rs_Domicilio!codigopostal) Then
    '    EmpDire = EmpDire & " C.P. " & rs_Domicilio!codigopostal
    'End If
    Poblacion = rs_Domicilio!provdesc
End If

'Consulta para obtener el cuit de la empresa
'StrSql = "SELECT cuit.nrodoc FROM tercero "
'StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 306)"
'StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
'OpenRecordset StrSql, rs_cuit
'If rs_cuit.EOF Then
'    Flog.writeline "No se encontró el CUIT de la Empresa"
'    EmpCuit = "  "
'Else
'    EmpCuit = rs_cuit!Nrodoc
'End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos del Neto del Talon
'------------------------------------------------------------------
StrSql = " SELECT acu_liq.almonto AS valor"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN acu_liq  ON cabliq.cliqnro = acu_liq.cliqnro"
StrSql = StrSql & " AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & ValNetoTalon
OpenRecordset StrSql, rsConsult
NetoTalon = 0
Do Until rsConsult.EOF
    If Not IsNull(rsConsult!Valor) Then
        NetoTalon = NetoTalon + CDbl(rsConsult!Valor)
    End If
    
    NetoTalon = Replace(NetoTalon, ",", ".")
    rsConsult.MoveNext
Loop
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
' Busco la fecha del pedido de pago
'------------------------------------------------------------------
StrSql = "SELECT ppagfecped from pedidopago "
StrSql = StrSql & " where pliqnro= " & pliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    PedPago = rsConsult!ppagfecped
Else
    PedPago = ""
    Flog.writeline "No se encontraron los datos del Pedido de Pago"
End If
rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,orden,"
'StrSql = StrSql & " tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxchar6, auxchar7,"
StrSql = StrSql & " auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5, auxdeci6, auxdeci7, auxdeci8, auxdeci9)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Categoria & "'"
StrSql = StrSql & " ,'" & Mid(Poblacion, 1, 100) & "'"

StrSql = StrSql & " ,'" & PedPago & "'" 'proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & CIF & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & GRU & "'"
StrSql = StrSql & " ,'" & DtoContComunes & "'"
StrSql = StrSql & " ,'" & DtoAccidente & "'"
StrSql = StrSql & " ,'" & Contrato & "'"
StrSql = StrSql & " ,'" & NroDocu & "'"
StrSql = StrSql & " ,'" & NAfiliacion & "'"
StrSql = StrSql & " ,'" & Dias & "'"

StrSql = StrSql & " ," & TotalPercibe
StrSql = StrSql & " ," & RemTotal
StrSql = StrSql & " ," & ProPagEx
StrSql = StrSql & " ," & Total
StrSql = StrSql & " ," & RegGral
StrSql = StrSql & " ," & Desempleo
StrSql = StrSql & " ," & HsExtras
StrSql = StrSql & " ," & TotalDevengo
StrSql = StrSql & " ," & TotalDedu

'StrSql = StrSql & " ," & tenro1
'StrSql = StrSql & " ," & EmpEstrnro1
'StrSql = StrSql & " ," & tenro2
'StrSql = StrSql & " ," & EmpEstrnro2
'StrSql = StrSql & " ," & tenro3
'StrSql = StrSql & " ," & EmpEstrnro3

StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub generarDatosRecibo157(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de SGS
'Fecha Creacion: 01-10-2013
'Autor: Deluchi Ezequiel
'Modificacion: 06/06/2014 - Facundo Eggle - CAS-25848 - Cambio en Recibo de Haberes:
'              se extrae de la tabla ctabancaria el nro de cbu del empleado
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim nroCbu As String
Dim Banco As String

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim Gerencia
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 157."

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
   Flog.writeline "Datos Obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del domicilio del empleado
'------------------------------------------------------------------
StrSql = " SELECT * From cabdom "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
StrSql = StrSql & " WHERE domdefault =-1 and ternro= " & Ternro

Flog.writeline "Buscando el domicilio del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "El empleado no tiene un docimicilio marcado como principal."
   Direccion = ""
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
    Flog.writeline "Datos obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del centro de costo"
OpenRecordset StrSql, rsConsult

CentroCosto = "&nbsp;"
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
    Flog.writeline "Datos del centro de costo obtenido"
Else
   Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Centro de Costo."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la categoria"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "Datos de la Categoria Obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Categoria."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Puesto"
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
    Flog.writeline "Datos del Puesto obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Puesto."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Obra Social."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Contrato - A pedido del cliente no se busca
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Contrato = "&nbsp;"
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Contrato."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la gerencia
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 35 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
    Gerencia = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Gerencia."
    Gerencia = "&nbsp;"
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "El sueldo basico del empleado no existe, acumulador/acumulador: " & acunroSueldo
   Sueldo = 0
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCbu = rsConsult!ctabcbu
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        nroCbu = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " INNER JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = -1 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
    empFecAltaRec = ""
End If
If empFecAltaRec = "" Then
    'El empleado no tiene fecha de alta reconocida, por lo que busco la fecha desde de la primera de sus fases
    rsConsult.Close
    StrSql = " SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "Error al obtener la Fecha de Alta de la primer fase del Empleado"
        empFecAltaRec = ""
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
' Fecha de Alta Reconocida de la Fase
'------------------------------------------------------------------

StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FechaFaseRec = rsConsult!altfec
Else
    FechaFaseRec = empFecAltaRec
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la descripción del proceso de liquidación
'------------------------------------------------------------------
StrSql = " SELECT prodesc "
StrSql = StrSql & " FROM proceso "
StrSql = StrSql & " WHERE pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   DescProceso = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener la Descripción del Proceso"
   DescProceso = ""
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5,auxchar6,auxchar7)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & FechaFaseRec & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Gerencia, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(DescProceso, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCbu, 1, 100) & "'"
StrSql = StrSql & ")"

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


' Se encarga de generar los datos para BDO GE
'--------------------------------------------------------------------
Sub generarDatosRecibo158(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Sucursal
Dim TareaDesempena
Dim Antiguedad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim SueldoConformado
Dim acumSueldoConformado

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 158"
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecAlta = " "
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Antiguedad = ""
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If



'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""
Flog.writeline " Direccion y Localidad de la Sucursal " & StrSql
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & "  " & rsConsult!locdesc
   'Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = Replace(rsConsult!almonto, ",", ".")
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If


'------------------------------------------------------------------
'Busco los acumuladores asociados a la estructura
'------------------------------------------------------------------
Flog.writeline "Busco mapeo de acumuladores en confrep para SUELDO CONFORMADO"

StrSql = " SELECT confval2 "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN confrep ON (estrnro=confval AND repnro=60 AND conftipo='MAP')"
StrSql = StrSql & " WHERE  htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

acumSueldoConformado = "0"
Do While Not rsConsult.EOF
    acumSueldoConformado = acumSueldoConformado & "," & rsConsult!confval2
    rsConsult.MoveNext
Loop
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del campo configurable SUELDO CONFORMADO
'------------------------------------------------------------------
Flog.writeline "Busco el valor del SUELDO CONFORMADO"

    StrSql = " SELECT almonto"
    StrSql = StrSql & " FROM acu_liq"
    StrSql = StrSql & " WHERE acunro IN (" & acumSueldoConformado & ")"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult
    
    SueldoConformado = 0
    Do While Not rsConsult.EOF
       SueldoConformado = SueldoConformado + rsConsult!almonto
       rsConsult.MoveNext
    Loop
    SueldoConformado = Replace(SueldoConformado, ",", ".")


'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If


'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la categoria"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
'   CentroCosto = rsConsult!estrdabr
   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sector"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la obra social"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la sucursal
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Antiguedad, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Sucursal, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & "," & SueldoConformado
StrSql = StrSql & ")"


'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


Sub generarDatosRecibo159(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'Se encarga de generar los datos para CAS-21897 - BDO - Custom de Recibo de Haberes
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim objRs2 As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables Nuevas
Dim FechaAux
Dim CuentaBancaria
Dim PagoMonto
Dim Banco
Dim ObraSocial
Dim LugarDePago
'Dim NetoTalon
Dim Titulo
Dim Datos
Dim YaEntro As Boolean

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

'Busquedas
Dim Contrato
'Dim Antiguedad As Long
Dim Sector
Dim TipoDocu
Dim NroDocu
Dim Dia As Long
Dim Mes As Long
Dim Anio As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim fecalta
Dim fecbaja
Dim DiasAcum As Integer
Dim Dias
Dim profecfin As String
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset

On Error GoTo MError

Flog.writeline "Ingreso al Modelo 159"

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, proceso.profecfin FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   profecfin = rsConsult!profecfin
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   Flog.writeline "Datos del empleado obtenidos"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de ingreso y egreso - segun la fecha fin del proceso se buscan los ingresos y egresos.
'------------------------------------------------------------------
StrSql = " SELECT altfec, bajfec FROM fases WHERE empleado = " & Ternro & " AND " & _
         " (altfec <= " & ConvFecha(profecfin) & " AND (bajfec >= " & ConvFecha(profecfin) & " or bajfec is null))"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    If Not IsNull(rsConsult!bajfec) Then
        If CDate(rsConsult!bajfec) = CDate(profecfin) Then
            fecbaja = rsConsult!bajfec
        End If
    End If
Else
    'busco la fase mas cercana a la fecha hasta del proceso
    StrSql = " SELECT altfec, bajfec FROM fases WHERE empleado = " & Ternro & " AND  bajfec <= " & ConvFecha(profecfin) & _
             " ORDER BY bajfec DESC "
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAlta = rsConsult!altfec
        If Not IsNull(rsConsult!bajfec) Then
            fecbaja = rsConsult!bajfec
        Else
            fecbaja = ""
        End If
    Else
        empFecAlta = ""
        fecbaja = ""
    End If
End If
'------------------------------------------------------------------
'Busco si existe baja para el empleado
'------------------------------------------------------------------
'StrSql = " SELECT bajfec FROM fases WHERE empleado = " & Ternro & " ORDER BY altfec DESC "
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'    fecbaja = rsConsult!bajfec
'Else
'    fecbaja = ""
'End If
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el titulo con los datos configurados en ConfRep
'------------------------------------------------------------------
Dim Arr_AuxcharTE(5) As String
Dim AuxContador As Integer
Dim a As Integer
Dim TituloCol44 As String
AuxContador = 0
Titulo = ""
Datos = ""
StrSql = " SELECT * FROM confrep"
StrSql = StrSql & " WHERE repnro = 60"
StrSql = StrSql & " AND confnrocol IN (44,129,130,131,132,133,134)"
OpenRecordset StrSql, objRs2
If Not objRs2.EOF Then
    Do While Not objRs2.EOF
        Select Case Trim(objRs2!conftipo)
            Case "AC":
                'BUSCO EL ACUMULADOR CONFIGURADO EN LA COL. 44
                Titulo = objRs2!confetiq
                TituloCol44 = objRs2!confetiq
                StrSql = " SELECT almonto"
                StrSql = StrSql & " From acu_liq"
                StrSql = StrSql & " Where acunro = " & acunroSueldo
                StrSql = StrSql & " AND cliqnro = " & cliqnro
                Flog.writeline StrSql
                OpenRecordset StrSql, rsConsult
                If Not rsConsult.EOF Then
                    Sueldo = rsConsult!almonto
                Else
                    Flog.writeline "No se obtuvieron datos para el AC configurado en la columna 44"
                    Sueldo = 0
                End If
    
            Case "TE":
                '129,130,131,132,133,134
                Titulo = Trim(objRs2!confetiq)
                
                StrSql = " SELECT estrdabr "
                StrSql = StrSql & " FROM his_estructura"
                StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta)
                StrSql = StrSql & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") "
                StrSql = StrSql & " AND his_estructura.ternro=" & Ternro
                StrSql = StrSql & " AND his_estructura.tenro= " & objRs2!confval
                OpenRecordset StrSql, rsConsult
                If Not rsConsult.EOF Then
                    Arr_AuxcharTE(AuxContador) = Titulo & "@" & rsConsult!estrdabr
                Else
                    If Titulo <> "" Then
                        Arr_AuxcharTE(AuxContador) = Titulo & "@&nbsp;"
                    Else
                        Arr_AuxcharTE(AuxContador) = "&nbsp;@&nbsp;"
                    End If
                    
                    Flog.writeline "Error al obtener los datos de la estructura: " & objRs2!confnrocol & "(" & Trim(objRs2!confetiq) & ")"
                End If
                AuxContador = AuxContador + 1
            Case Else
                Flog.writeline "Error de configuración: Revisar columna " & objRs2!confnrocol
        End Select
        objRs2.MoveNext
    Loop
Else
    Flog.writeline ""
    Flog.writeline "Error de Configuración: Revisar columnas 44,127,128,129,130,131,132,133 y 134"
    Flog.writeline ""
End If

If AuxContador > 0 And AuxContador < 6 Then
    Flog.writeline ""
    Flog.writeline "Error de Configuración: Revisar columnas 44,127,128,129,130,131,132,133 y 134"
    Flog.writeline ""
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'                       Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro = cuil.ternro and cuil.tidnro = 10) "
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del cuil"
End If


'------------------------------------------------------------------
'       Busco el numero de Documento y el Tipo de Documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, docu.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc docu ON docu.ternro = tercero.ternro and docu.tidnro > 0 and docu.tidnro < 5"
StrSql = StrSql & " LEFT JOIN tipodocu     ON tipodocu.tidnro = docu.tidnro"
StrSql = StrSql & " WHERE tercero.ternro = " & Ternro
StrSql = StrSql & " ORDER BY tipodocu.tidnro ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDocu = rsConsult!tidsigla
    NroDocu = rsConsult!NroDoc
Else
    Flog.writeline "Error al obtener los datos del Tipo y Número de documento"
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
    Localidad = Direccion
Else
    Flog.writeline "Error al obtener los datos de la localidad"
End If


'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro, estrdabr From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!Estrnro = 154 Then
        Contrato = rsConsult!estrdabr
        
        StrSql = " SELECT altfec, bajfec FROM fases"
        StrSql = StrSql & " Where Empleado = 189"
        StrSql = StrSql & " ORDER BY altfec DESC"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            Contrato = Contrato & rsConsult2!altfec & " - " & rsConsult2!bajfec
        End If
    Else
        Contrato = rsConsult!estrdabr
    End If
Else
    Flog.writeline "Error al obtener los datos del contrato"
End If

Sector = ""
Categoria = ""
Puesto = ""
CentroCosto = ""

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT pedidopago.ppagnro FROM pedidopago " & _
          " INNER JOIN pago ON pago.ppagnro = pedidopago.ppagnro " & _
          " WHERE pliqnro = " & pliqnro & " AND Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ' Se modifica el campo de donde se saca la descripcion del Banco "bandesc" por "terrazsoc"
    StrSql = " SELECT pago.fpagnro, ctabcbu, pago.pagomonto, ctabnro, fpagdescabr, tercero.terrazsoc, fpagbanc From pago"
    StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
    StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
    StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = banco.ternro"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        FormaPago = rsConsult!fpagdescabr
        If Not EsNulo(rsConsult!ctabnro) Then
            CuentaBancaria = rsConsult!ctabnro
            If IsNull(rsConsult!terrazsoc) Then
                Banco = ""
            Else
                Banco = rsConsult!terrazsoc
            End If
        Else
            CuentaBancaria = rsConsult!ctabcbu
            Banco = "CBU"
        End If
        PagoMonto = rsConsult!PagoMonto
    Else
        StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
        StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
        StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = banco.ternro"
        StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
        StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
        StrSql = StrSql & " AND ctabestado = -1"
        OpenRecordset StrSql, rsConsult2
        If Not rsConsult2.EOF Then
            FormaPago = rsConsult2!fpagdescabr
            If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
                CuentaBancaria = rsConsult2!ctabnro
            Else
                CuentaBancaria = rsConsult2!ctabcbu
            End If
            Banco = rsConsult2!terrazsoc
        Else
            FormaPago = ""
            CuentaBancaria = ""
            Banco = ""
        End If
        rsConsult2.Close
        
        PagoMonto = 0
    End If
Else
    StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
    StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
    StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro = banco.ternro"
    StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
    StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
    StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            CuentaBancaria = rsConsult2!ctabnro
        Else
            CuentaBancaria = rsConsult2!ctabcbu
        End If
        Banco = rsConsult2!terrazsoc
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
    End If
    rsConsult2.Close
    
    PagoMonto = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
ObraSocial = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline "Error al obtener los datos de la obra social"
End If


'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
LugarDePago = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   LugarDePago = rsConsult!estrdabr
End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto, detdom.codigopostal From cabdom"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - "
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & "(" & rs_Domicilio!codigopostal & ") "
    End If
    EmpDire = EmpDire & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)"
StrSql = StrSql & " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If


'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef"
StrSql = StrSql & " From ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro"
StrSql = StrSql & " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " ("
StrSql = StrSql & " bpronro,ternro,pronro"
StrSql = StrSql & " ,apellido,Nombre,direccion,Legajo"
StrSql = StrSql & " ,pliqnro,pliqmes,pliqanio,pliqdepant"
StrSql = StrSql & " ,pliqfecdep,pliqbco,cuil,empfecalta"
StrSql = StrSql & " ,sueldo,categoria,centrocosto,localidad"
StrSql = StrSql & " ,profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma"
StrSql = StrSql & " ,empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto"
StrSql = StrSql & " ,tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden"

StrSql = StrSql & " ,auxchar1, auxchar2, auxchar3, auxchar4, auxchar5"

StrSql = StrSql & " ,auxchar6, auxchar7, auxchar8, auxchar9, auxchar"

StrSql = StrSql & " ,auxdeci1"

StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & " (" & NroProceso
StrSql = StrSql & " ," & Ternro
StrSql = StrSql & " ," & Pronro

StrSql = StrSql & " ,'" & Apellido & "'"
StrSql = StrSql & " ,'" & Nombre & "'"
StrSql = StrSql & " ,'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & " ," & Legajo

StrSql = StrSql & " ," & pliqnro
StrSql = StrSql & " ," & pliqmes
StrSql = StrSql & " ," & pliqanio
StrSql = StrSql & " ,'" & pliqdepant & "'"

StrSql = StrSql & " ,'" & pliqfecdep & "'"
StrSql = StrSql & " ,'" & pliqbco & "'"
StrSql = StrSql & " ,'" & Cuil & "'"
StrSql = StrSql & " ,'" & empFecAlta & "'"

StrSql = StrSql & " ," & Sueldo
StrSql = StrSql & " ,'" & Mid(fecbaja, 1, 20) & "'" 'se reutiliza la columna para fecha de baja
StrSql = StrSql & " ,'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & " ,'" & Mid(Localidad, 1, 100) & "'"

StrSql = StrSql & " ,'" & proFecPago & "'"
StrSql = StrSql & " ,'" & EmpNombre & "'"
StrSql = StrSql & " ,'" & EmpDire & "'"
StrSql = StrSql & " ,'" & EmpCuit & "'"
StrSql = StrSql & " ,'" & EmpLogo & "'"
StrSql = StrSql & " ," & EmpLogoAlto
StrSql = StrSql & " ," & EmpLogoAncho
StrSql = StrSql & " ,'" & EmpFirma & "'"

StrSql = StrSql & " ," & EmpFirmaAlto
StrSql = StrSql & " ," & EmpFirmaAncho
StrSql = StrSql & " ,'" & FormaPago & "'"
StrSql = StrSql & " ,'" & proDesc & "'"
StrSql = StrSql & " ,'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & " ,'" & Puesto & "'"

StrSql = StrSql & " ," & tenro1
StrSql = StrSql & " ," & EmpEstrnro1
StrSql = StrSql & " ," & tenro2
StrSql = StrSql & " ," & EmpEstrnro2
StrSql = StrSql & " ," & tenro3
StrSql = StrSql & " ," & EmpEstrnro3
StrSql = StrSql & " ," & orden

StrSql = StrSql & " ,'" & ObraSocial & "'" 'auxchar1
StrSql = StrSql & " ,'" & Banco & "@" & CuentaBancaria & "'" 'auxchar2
StrSql = StrSql & " ,'" & LugarDePago & "'" 'auxchar3
StrSql = StrSql & " ,'" & TituloCol44 & "'" 'auxchar4

'Auxchar 4 al 9
For a = 0 To UBound(Arr_AuxcharTE)
    If Arr_AuxcharTE(a) = "@" Or Arr_AuxcharTE(a) = "" Then
        StrSql = StrSql & " ,'&nbsp;@&nbsp;'"
    Else
        StrSql = StrSql & " ,'" & Arr_AuxcharTE(a) & "'"
    End If
Next

StrSql = StrSql & " ,0"  'auxdeci1
'StrSql = StrSql & " ," & NetoTalon 'auxdeci1
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------INSERT INTO rep_recibo  (bpronro,ternro,pronro, apellido,Nombre,direccion,Legajo, pliqnro,pliqmes,pliqanio,pliqdepant, pliqfecdep,pliqbco,cuil,empfecalta, sueldo,categoria,centrocosto,localidad, profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma, empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, tenro1, estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxdeci1) VALUES(86820,55872,188,'Pelotas ','Juan ','',3226,60,12,2008,'Diciembre','22/12/2008','','','01/01/2001',0,'','A300101','','31/12/2008','CURTIEMBRE ARLEI S.A.','Florida 234 P. 4 - CAP FED','30-52195813-4','/rhprox2/fotos/logo1.jpg',80,80,'/rhprox2/fotos/firma prueba.bmp',50,140,'','Mensuales Dic2008',' Empleados del 1 al 9999999999 - Activos e Inactivos - Al 31/12/2008','ADMINISTRATIVO',0,0,0,0,0,0,0,'ASE','','Buenos Aires',3989,9)------------------------------------------------
Flog.writeline ""
Flog.writeline "SQL INSERT: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio"
StrSql = StrSql & " FROM cabliq"
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro"
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod"
OpenRecordset StrSql, rsConsult
Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det"
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo)"
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    objConn.Execute StrSql, , adExecuteNoRecords
    rsConsult.MoveNext
    
    Flog.writeline "SQL INSERT DETALLE: " & StrSql
Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para Colombia Zoetis a partir de Medicus a partir del 21-12-2011
'--------------------------------------------------------------------
Sub generarDatosRecibo160(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Procedimiento
Dim Salud
Dim ObraSocial
Dim regimenJub
Dim MostrarEstructura
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja
Dim diasHab_aux As Integer
Dim Salario
Dim Valor
Dim ValorAlivio

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsConsultConfrep As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim acumulador As Long


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 160"

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'-----------------------------------------------------------------------------------------
'Configuracion del Confrep
'-----------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 330 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Salario"
Else
    Salario = rsConsult!confval
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & Salario
    OpenRecordset StrSql, rsConsultConfrep
    If Not rsConsultConfrep.EOF Then
       Flog.writeline " Salario " & StrSql
       Salario = rsConsultConfrep!Valor
    Else
       Flog.writeline "Error al obtener Salario"
       Salario = 0
    End If
    rsConsultConfrep.Close
End If
rsConsult.Close

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 331 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Valor %"
Else
    Valor = rsConsult!confval
    StrSql = " SELECT detliq.dlimonto FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & Valor
    OpenRecordset StrSql, rsConsultConfrep
    If Not rsConsultConfrep.EOF Then
       Flog.writeline " Valor " & StrSql
       Valor = rsConsultConfrep!dlimonto
    Else
       Flog.writeline "Error al obtener Valor"
       Valor = 0
    End If
    rsConsultConfrep.Close
End If
rsConsult.Close

StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 332 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Valor Alivio"
Else
    ValorAlivio = rsConsult!confval
    StrSql = " SELECT detliq.dlimonto FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & ValorAlivio
    OpenRecordset StrSql, rsConsultConfrep
    If Not rsConsultConfrep.EOF Then
       Flog.writeline " Valor Alivio " & StrSql
       ValorAlivio = rsConsultConfrep!dlimonto
    Else
       Flog.writeline "Error al obtener Valor Alivio"
       ValorAlivio = 0
    End If
    rsConsultConfrep.Close
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empFecBaja = rsConsult!empFecBaja
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

Flog.writeline "Busco la fecha de alta y baja"
'FGZ - 20/06/2006
'-------------------------------------------------------------------
'Modificion de la fecha de alta y baja
'Ingreso: tomar la fecha de alta de la ultima fase
'Egreso: tomar la fecha de baja de la ultima fase
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'empFecAlta = rsConsult!altfec NG - 24/05/2012
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    'empFecAlta = " " NG - 24/05/2012
    empFecBaja = " "
End If
rsConsult.Close


'-------------------------------------------------------------------
'FGZ - 20/06/2006

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"

        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

Antiguedad = 0

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
Flog.writeline "Busco el valor del cuil"
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro<7) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro

    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = Replace(rsConsult!almonto, ",", ".")
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura que se mostrara de la fecha de pago
'------------------------------------------------------------------
Flog.writeline "Busco la estructura que se mostrará entes de la fecha"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & ValNetoTalon & " And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   MostrarEstructura = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor de la estructura Salud
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la Salud"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Salud = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Salud"
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Flog.writeline "Busco el valor del puesto"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro

OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor de la estructura Procedimiento
'------------------------------------------------------------------
Flog.writeline "Busco el valor del Procedimiento"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 73 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Procedimiento = ""

If Not rsConsult.EOF Then
   Procedimiento = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del Procedimiento"
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio Pension
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, "
StrSql = StrSql & " auxchar6, auxchar7,auxdeci1,auxdeci2,auxdeci3,auxchar8)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Salud, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Procedimiento & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & Mid(MostrarEstructura, 1, 100) & "'"
StrSql = StrSql & ",'" & pliqhasta & "'"
StrSql = StrSql & ",'" & pliqdesde & "'"
StrSql = StrSql & ",'" & Salario & "'"
StrSql = StrSql & ",'" & Valor & "'"
StrSql = StrSql & ",'" & ValorAlivio & "'"
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"

    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Chile Zoetis a partir de Medicus a partir del 21-12-2011
'--------------------------------------------------------------------
Sub generarDatosRecibo161(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago

Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Procedimiento
Dim ObraSocial
Dim regimenJub
Dim Modalidad
Dim TareaDesempena
Dim Antiguedad
Dim totalParcialAntiguedad As Double
Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim diasHab_aux As Integer
Dim DiasTrab
Dim Neto
Dim Documento

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_aux As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim rsConsultConfrep As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset


Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim acumulador As Long

Dim cod335

Dim RutEmp As Integer

Dim Auxchar3 As String
Dim Auxchar4 As String
Auxchar3 = ""
Auxchar4 = ""

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 161"

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'-----------------------------------------------------------------------------------------
'Configuracion del Confrep
'-----------------------------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 330 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para Dias Trabajados"
Else
    DiasTrab = rsConsult!confval
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & DiasTrab
    OpenRecordset StrSql, rsConsultConfrep
    If Not rsConsultConfrep.EOF Then
       Flog.writeline " Dias Trabajados " & StrSql
       DiasTrab = rsConsultConfrep!Valor
    Else
       Flog.writeline "Error al obtener Dias Trabajados"
       DiasTrab = 0
    End If
    rsConsultConfrep.Close
End If
rsConsult.Close

Neto = 0
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 331"
OpenRecordset StrSql, rsConsult

If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Neto."
Else
       CodNeto = rsConsult!confval
End If
Flog.writeline " Configuracion del confrep Columna Nro 331 " & StrSql
rsConsult.Close


StrSql = " SELECT detliq.dlimonto valor"
StrSql = StrSql & " From detliq"
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
StrSql = StrSql & " Where concepto.conccod = " & CodNeto
StrSql = StrSql & " AND detliq.cliqnro = " & cliqnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Neto = rsConsult!Valor
Else
    Flog.writeline " No Existe Neto "
End If
Flog.writeline " Configuracion del Neto " & StrSql
rsConsult.Close


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
Flog.writeline "Busco los datos del empleado"

StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
Flog.writeline "Busco los datos del periodo actual"
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 1"
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 2"
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
Flog.writeline "Busco los datos del tipos de estructura 3"
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult

        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

Antiguedad = 0

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
Flog.writeline "Busco el valor de la direccion y localidad"
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
   Direccion = rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Flog.writeline "Busco el valor del sueldo basico"
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 18 (Modalidad de contratación)
'------------------------------------------------------------------
Flog.writeline "Busco la modalidad de contratación"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Modalidad = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Obtengo los datos de la estructura 4 (Tarea que Desempeña)
'------------------------------------------------------------------
Flog.writeline "Busco la tarea que desempeña"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   TareaDesempena = rsConsult!estrdabr
Else
   'Flog.writeline "Error al obtener los datos de la Estructura a Mostrar"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------
Flog.writeline "Busco el valor del centro de costo"
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio Pension
'------------------------------------------------------------------
Flog.writeline "Busco el regimen jubilatorio"
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la forma de pago"
StrSql = " SELECT cbnro, ctabestado, terrazsoc, ctabnro, fpagdescabr, ctabcbu, ctabancaria.fpagnro, ctabancaria.banco FROM ctabancaria"
StrSql = StrSql & " LEFT  JOIN banco ON ctabancaria.banco = banco.ternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
StrSql = StrSql & " INNER JOIN formapago ON ctabancaria.fpagnro = formapago.fpagnro"
StrSql = StrSql & " WHERE ctabancaria.ternro = " & Ternro
StrSql = StrSql & " AND ctabestado = -1"
    OpenRecordset StrSql, rsConsult2
    If Not rsConsult2.EOF Then
        FormaPago = rsConsult2!fpagdescabr
        If Trim(rsConsult2!ctabnro) <> "" And Not IsNull(rsConsult2!ctabnro) Then
            'ctabnro = rsConsult2!terrazsoc
            Auxchar3 = rsConsult2!terrazsoc
            Auxchar4 = rsConsult2!ctabnro
        Else
            'ctabnro = ""
            Auxchar3 = ""
            Auxchar4 = rsConsult2!ctabcbu
        End If
    Else
        FormaPago = ""
        CuentaBancaria = ""
        Banco = ""
        Auxchar3 = ""
        Auxchar4 = ""
    End If
    rsConsult2.Close


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
Flog.writeline " Busco los datos de la empresa"
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

Flog.writeline "Consulta para obtener la direccion de la empresa"
'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " " & rs_Domicilio!locdesc
End If

Flog.writeline "Consulta para obtener el cuit de la empresa"

'levanto del confrep el tipo de documento
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE confnrocol= 200 "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    RutEmp = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
Else
    RutEmp = 0
End If
rsConsult.Close

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro =" & RutEmp & ")" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

Flog.writeline "Consulta para buscar el logo de la empresa"
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

Flog.writeline "Consulta para buscar la firma de la empresa"
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = rsConsult!Bandesc
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!NroDoc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco columna 136 del confrep para traer un concepto no imprimible o un acumulador "
'------------------------------------------------------------------
Flog.writeline "Buscando columna 335 del confrep para traer un concepto no imprimible o un acumulador "
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND  confnrocol = 335 "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   'StrSql = "SELECT dlimonto FROM detliq WHERE conccod = " & IIf(EsNulo(rsConsult!confval2), "", rsConsult!confval2)
   StrSql = " SELECT detliq.dlimonto "
   StrSql = StrSql & " FROM detliq "
   StrSql = StrSql & " INNER JOIN concepto ON concepto.conccod = " & rsConsult!confval
   StrSql = StrSql & " AND concepto.concnro = detliq.concnro "
   StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
   
   OpenRecordset StrSql, rsConsult2
        
        If rsConsult2.EOF Then
          cod335 = 0
        Else
          cod335 = rsConsult2!dlimonto
        End If
        rsConsult2.Close
Else
    Flog.writeline "Debe configurar el Confrep con el Numero de Columna 335"
    GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
Flog.writeline "Armo la SQL para guardar los datos"
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3, auxchar4, auxdeci1,auxdeci2,auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(ctabnro, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(Modalidad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(TareaDesempena, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & Mid(Auxchar3, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Auxchar4, 1, 100) & "'"
StrSql = StrSql & "," & DiasTrab
StrSql = StrSql & "," & Neto
StrSql = StrSql & "," & cod335
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
Flog.writeline "Guardo los datos en la BD: " & StrSql
objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
Flog.writeline "Obtengo los datos del los conceptos del empleado"
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
'StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF

    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    If CStr(rsConsult!ConcCod) = CStr("999998") Then
        StrSql = StrSql & ",'3')"
    Else
        StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    End If
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Deloitte
'--------------------------------------------------------------------
Sub generarDatosRecibo162(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto
Dim BancoPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim AntigGrilla
Dim salir
Dim Contrato

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

Flog.writeline "Modelo 162"

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
StrSql = StrSql & " AND estado = -1 "
StrSql = StrSql & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
        empFecAlta = "&nbsp;"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = Date
If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
   Contrato = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Básico. Se debe configurar en la columna 1 del confrep."
   Sueldo = 0
'   GoTo MError
End If
    
'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
    BancoPago = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    BancoPago = "&nbsp;"
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago."
   FormaPago = "&nbsp;"
   BancoPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & Mid(BancoPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para HIRSCH
'--------------------------------------------------------------------
Sub generarDatosRecibo163(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto
Dim BancoPago

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim AntigGrilla
Dim salir
Dim Contrato
Dim area

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso de liquidación."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = Replace(rsConsult!empremu, ",", ".")
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual de Liquidación."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE fasrecofec = -1 AND empleado= " & Ternro '& " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado. Se obtiene de la fase marcada como Fecha Alta Reconocida."
    empFecAlta = "&nbsp;"
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------

'Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = CDate(pliqhasta)


If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil, tipo de documento 10."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento, tipo menor o igual a 5."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del contrato
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Contrato."
   Contrato = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Area
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 and confnrocol = 336 order by confnrocol"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    area = rsConsult("confval")
Else
    Flog.writeline "Falta configurar la columna 336 del confrep"
End If
rsConsult.Close

StrSql = " SELECT estructura.estrdabr"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & area & " And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Flog.writeline "Consulta del Tipo Estructura Area" & StrSql

If Not rsConsult.EOF Then
   area = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Estructura Area."
   area = " "
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado (Lugar de Pago)."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = Replace(rsConsult!Valor, ",", ".")
Else
   Flog.writeline "Error al obtener los datos del Básico. Se debe configurar en la columna 1 del confrep."
   Sueldo = 0
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 42
    If esSueldoRecibo Then
        StrSql = " SELECT novemp.nevalor valor "
        StrSql = StrSql & " FROM novemp "
        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           valorAntig = rsConsult!Valor
           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
        Else
           'MENSUALES
           If esGratificacionConc Then
                StrSql = " SELECT novemp.nevalor valor "
                StrSql = StrSql & " FROM novemp "
                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
                OpenRecordset StrSql, rsConsult
                
                If Not rsConsult.EOF Then
                   valorAntig = rsConsult!Valor
                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
                End If
           Else
                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
           End If
           'FIN MENSUALES
        End If
    
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
        valorAntig = 0
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!ctabnro
    BancoPago = rsConsult!terrazsoc
  Else
    FormaPago = rsConsult!fpagdescabr
    BancoPago = "&nbsp;"
  End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. Tiene que estar generado el pedido de pago previamente."
   FormaPago = "&nbsp;"
   BancoPago = "&nbsp;"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa asociada al empleado."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró la Firma de la Empresa, tipo de imagen 2."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(area, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & Mid(BancoPago, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


' Se encarga de generar los datos para el recibo de PLA S.A
'--------------------------------------------------------------------
Sub generarDatosRecibo164(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

'Codigo de forma de liq quincenal
Dim quincenal1
Dim quincenal2
Dim tequincena

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim dni
Dim empFecAlta
Dim empFecAltaRec
Dim empFecAltarec2
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim quincena As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo la configuracion de confrep del recibo
'------------------------------------------------------------------
StrSql = "SELECT  * FROM confrep WHERE repnro=60 AND ( confnrocol=341 OR confnrocol=342 )"
Flog.writeline "Buscando configuracion del reporte"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    
   Do While Not rsConsult.EOF
        tequincena = rsConsult!confval
        If rsConsult!confnrocol = 341 Then
            quincenal1 = rsConsult!confval2
            
        ElseIf rsConsult!confnrocol = 342 Then
            quincenal2 = rsConsult!confval2
        End If
        
        rsConsult.MoveNext
    
   Loop
      
   If quincenal1 = "" Or quincenal2 = "" Then
        Flog.writeline "Reporte MAL configurado!!"
        GoTo MError
   End If
      
   Flog.writeline "TE Qincenal :" & tequincena
   Flog.writeline "Estr. 1ra Qincena :" & quincenal1
   Flog.writeline "Estr. 3ra Qincena :" & quincenal2
   
Else
   Flog.writeline "Reporte NO configurado!!"
   GoTo MError
End If


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT dni.nrodoc " & _
         " FROM tercero LEFT JOIN ter_doc dni ON tercero.ternro = dni.ternro and dni.tidnro = 1 " & _
         " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   dni = rsConsult!NroDoc
Else
    dni = ""
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad del empleado
'------------------------------------------------------------------
Direccion = ""
Localidad = ""

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"

'---LOG---
Flog.writeline "Buscando datos de la direccion de la sucursal"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!locdesc
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de liquidacion del empleado para ver si es quincenal
'------------------------------------------------------------------
quincena = " "

StrSql = "SELECT his_estructura.estrnro " & _
    " From his_estructura" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = " & tequincena
    
Flog.writeline "verifico si es quincenal.... " & StrSql

OpenRecordset StrSql, rs_estructura

If Not rs_estructura.EOF Then
    
    Flog.writeline "verifico si tiene alguna de las estructuras configuradas.... " & CLng(rs_estructura!Estrnro) & " = " & CLng(quincenal1) & " Or " & CLng(rs_estructura!Estrnro) & " = " & CLng(quincenal2)
     
    If (CLng(rs_estructura!Estrnro) = CLng(quincenal1)) Or (CLng(rs_estructura!Estrnro) = CLng(quincenal2)) Then
        
       Flog.writeline " es QUINCENAL!!!"
        
        'Miro que quincena es
        StrSql = " SELECT proceso.pronro, proceso.tprocnro, tprocdesc"
        StrSql = StrSql & " From Proceso"
        StrSql = StrSql & " INNER JOIN tipoproc ON tipoproc.tprocnro = proceso.tprocnro"
        StrSql = StrSql & " Where Proceso.pronro = " & Pronro
        
        Flog.writeline "Obtengo la quincena del modelo del proceso... " & StrSql
        
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            If Not EsNulo(rsConsult!tprocdesc) Then
                quincena = Left(rsConsult!tprocdesc, 1)
            End If
        End If
        rsConsult.Close
    End If

End If

rs_estructura.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Baja Reconocida 2.
'------------------------------------------------------------------
StrSql = " SELECT bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = 0 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltarec2 = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltarec2 = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar2,auxchar3,auxchar4,auxchar5,auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 28) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & ",'" & empFecAltarec2 & "'"
StrSql = StrSql & ",'" & quincena & "'"
StrSql = StrSql & ",'" & dni & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



Sub generarDatosRecibo165(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de UTDT
'Fecha Creacion: 11/03/2014
'Autor: Mauricio Zwenger
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim Banco As String
Dim l_empimg_tipo

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim Gerencia
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim LugarPago
Dim EmpTelefono
Dim EmpWebsite

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec
Dim EmpOtrasFaces

Dim profe
Dim staff_est
Dim profe_est

Dim staff_col1_eti
Dim staff_col1_te
Dim staff_col2_eti
Dim staff_col2_te
Dim staff_col3_eti
Dim staff_col3_te
Dim staff_col4_eti
Dim staff_col4_te

Dim profe_col1_eti
Dim profe_col1_te
Dim profe_col2_eti
Dim profe_col2_te
Dim profe_col3_eti
Dim profe_col3_te
Dim profe_col4_eti
Dim profe_col4_te

Dim col1_eti
Dim col1_te
Dim col2_eti
Dim col2_te
Dim col3_eti
Dim col3_te
Dim col4_eti
Dim col4_te

Dim fechaPago

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 165."

l_empimg_tipo = ""

'------------------------------------------------------------------
'Obtengo la configuracion de confrep del recibo
'------------------------------------------------------------------
StrSql = "SELECT  * FROM confrep WHERE repnro=60 AND ( confnrocol=337 OR confnrocol=338 OR confnrocol=339 OR confnrocol=340 OR confnrocol=347)"
Flog.writeline "Buscando configuracion del reporte"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    
   Do While Not rsConsult.EOF
   
    Select Case rsConsult("confnrocol")
    
     Case 337
        If rsConsult("conftipo") = "STA" Then
            staff_est = rsConsult("confval")    'estructura que define que es del staff
            staff_col1_eti = rsConsult("confetiq")   'etiqueta a mostrar
            staff_col1_te = rsConsult("confval2")    'tipo de estructira a mostrar
        ElseIf rsConsult("conftipo") = "PRO" Then
            profe_est = rsConsult("confval")    'estructura que define que es profesor
            profe_col1_eti = rsConsult("confetiq")   'etiqueta a mostrar
            profe_col1_te = rsConsult("confval2")    'tipo de estructira a mostrar
        End If
     Case 338
        If rsConsult("conftipo") = "STA" Then
            staff_est = rsConsult("confval")    'estructura que define que es del staff
            staff_col2_eti = rsConsult("confetiq")   'etiqueta a mostrar
            staff_col2_te = rsConsult("confval2")    'tipo de estructira a mostrar
        ElseIf rsConsult("conftipo") = "PRO" Then
            profe_est = rsConsult("confval")    'estructura que define que es profesor
            profe_col2_eti = rsConsult("confetiq")   'etiqueta a mostrar
            profe_col2_te = rsConsult("confval2")    'tipo de estructira a mostrar
        End If
    
     Case 339
        If rsConsult("conftipo") = "STA" Then
            staff_est = rsConsult("confval")    'estructura que define que es del staff
            staff_col3_eti = rsConsult("confetiq")   'etiqueta a mostrar
            staff_col3_te = rsConsult("confval2")    'tipo de estructira a mostrar
        ElseIf rsConsult("conftipo") = "PRO" Then
            profe_est = rsConsult("confval")    'estructura que define que es profesor
            profe_col3_eti = rsConsult("confetiq")   'etiqueta a mostrar
            profe_col3_te = rsConsult("confval2")    'tipo de estructira a mostrar
        
        End If
     Case 340
        If rsConsult("conftipo") = "STA" Then
            staff_est = rsConsult("confval")    'estructura que define que es del staff
            staff_col4_eti = rsConsult("confetiq")   'etiqueta a mostrar
            staff_col4_te = rsConsult("confval2")    'tipo de estructira a mostrar
        ElseIf rsConsult("conftipo") = "PRO" Then
            profe_est = rsConsult("confval")    'estructura que define que es profesor
            profe_col4_eti = rsConsult("confetiq")   'etiqueta a mostrar
            profe_col4_te = rsConsult("confval2")    'tipo de estructira a mostrar
        
        End If
     Case 347
        If rsConsult("conftipo") = "IMG" Then
            l_empimg_tipo = rsConsult("confval")
        End If
     End Select
        
        rsConsult.MoveNext
    
   Loop
      
   If staff_est = "" And profe_est = "" Then
        Flog.writeline "Reporte MAL configurado!!"
        GoTo MError
   End If
   
   If l_empimg_tipo = "" Then
        Flog.writeline "No se configuró el Tipo de Imegen a mostrar en el encabezado del recibo"
        GoTo MError
   End If
       
Else
   Flog.writeline "Reporte NO configurado!!"
   GoTo MError
End If



'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
   Flog.writeline "Datos Obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If




'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
    Flog.writeline "Datos obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
    GoTo MError
End If


'------------------------------------------------------------------
'verifico si el legajo corresponde al staff o es un profesor
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And (his_estructura.estrnro = " & staff_est & " OR his_estructura.estrnro = " & profe_est & ") And his_estructura.ternro = " & Ternro
       
Flog.writeline "Verificando si es del Staff o Profesor"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If CInt(rsConsult("estrnro")) = CInt(profe_est) Then
        'es profesor
        Flog.writeline "es profesor"
        profe = -1
        
        col1_eti = profe_col1_eti
        col1_te = profe_col1_te
        col2_eti = profe_col2_eti
        col2_te = profe_col2_te
        col3_eti = profe_col3_eti
        col3_te = profe_col3_te
        col4_eti = profe_col4_eti
        col4_te = profe_col4_te

    Else
        'es del staff
        Flog.writeline "es del staff"
        profe = 0
        
        col1_eti = staff_col1_eti
        col1_te = staff_col1_te
        col2_eti = staff_col2_eti
        col2_te = staff_col2_te
        col3_eti = staff_col3_eti
        col3_te = staff_col3_te
        col4_eti = staff_col4_eti
        col4_te = staff_col4_te
    End If
Else
   'si no encuentro ninguna de las estructuras considero que no es profesor ==> es del resto del staff
   
    Flog.writeline "es del staff"
    profe = 0
        
    col1_eti = staff_col1_eti
    col1_te = staff_col1_te
    col2_eti = staff_col2_eti
    col2_te = staff_col2_te
    col3_eti = staff_col3_eti
    col3_te = staff_col3_te
    col4_eti = staff_col4_eti
    col4_te = staff_col4_te
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la estructura de columna 1 a mostrar
'------------------------------------------------------------------
Flog.writeline ""
Flog.writeline "1) busco estructura de tipo " & col1_te

If col1_te <> "" Then
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & col1_te & " And his_estructura.ternro = " & Ternro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Direccion = rsConsult("estrdabr")
    Else
       Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee estructura de tipo " & col1_te & "."
    End If
    rsConsult.Close
End If

'------------------------------------------------------------------
'Busco la estructura de columna 2 a mostrar
'------------------------------------------------------------------
Flog.writeline ""
Flog.writeline "2) busco estructura de tipo " & col2_te

If col2_te <> "" Then
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & col2_te & " And his_estructura.ternro = " & Ternro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Puesto = rsConsult("estrdabr")
    Else
       Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee estructura de tipo " & col2_te & "."
    End If
    rsConsult.Close
End If

'------------------------------------------------------------------
'Busco la estructura de columna 3 a mostrar
'------------------------------------------------------------------
Flog.writeline ""
Flog.writeline "3) busco estructura de tipo " & col3_te
If col3_te <> "" Then
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & col3_te & " And his_estructura.ternro = " & Ternro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       CentroCosto = rsConsult("estrdabr")
    Else
       Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee estructura de tipo " & col3_te & "."
    End If
    rsConsult.Close
End If

'------------------------------------------------------------------
'Busco la estructura de columna 4 a mostrar
'------------------------------------------------------------------
Flog.writeline ""
Flog.writeline "4) busco estructura de tipo " & col4_te
If col4_te <> "" Then
    
    StrSql = " SELECT estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = " & col4_te & " And his_estructura.ternro = " & Ternro
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       Categoria = rsConsult("estrdabr")
    Else
       Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee estructura de tipo " & col4_te & "."
    End If
    rsConsult.Close
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If




'------------------------------------------------------------------
'Busco el valor de la Obra Social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = "&nbsp;"
If Not rsConsult.EOF Then
    ObraSocial = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Obra Social."
End If
rsConsult.Close



'------------------------------------------------------------------
'Busco el valor del Contrato - A pedido del cliente no se busca
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult

Contrato = "&nbsp;"
If Not rsConsult.EOF Then
    Contrato = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Contrato."
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la gerencia
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 35 And his_estructura.ternro = " & Ternro

OpenRecordset StrSql, rsConsult


If Not rsConsult.EOF Then
    Gerencia = rsConsult!estrdabr
Else
    Flog.writeline Espacios(Tabulador * 1) & "El empleado no posee Gerencia."
    Gerencia = "&nbsp;"
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "El sueldo basico del empleado no existe, acumulador/acumulador: " & acunroSueldo
   Sueldo = 0
End If


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        CBU = rsConsult!ctabcbu
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        CBU = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close


'------------------------------------------------------------------
'busco la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecpago FROM proceso "
StrSql = StrSql & " WHERE pronro=" & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    fechaPago = rsConsult!proFecPago
Else
    fechaPago = ""
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

LugarPago = ""

If Not rsConsult.EOF Then
   LugarPago = rsConsult!estrdabr & ", " & _
                Format(fechaPago, "dd") & " de " & _
                UCase(Left(Format(fechaPago, "MMMM"), 1)) & _
                Mid(Format(fechaPago, "MMMM"), 2) & " de " & _
                Format(fechaPago, "yyyy")
   
Else
   Flog.writeline "Error al obtener el Lugar de Pago"
   'GoTo MError
End If


rsConsult.Close



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close



'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom, empresa.empwebsite " & _
        " From his_estructura" & _
        " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
        " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
        " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
        " AND his_estructura.ternro = " & Ternro & _
        " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
Flog.writeline StrSql
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpWebsite = rs_estructura!EmpWebsite
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc, telnro From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & " AND domdefault=-1 " & _
    " LEFT JOIN telefono ON (cabdom.domnro=telefono.domnro AND teldefault=-1)" & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    'EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & " (" & rs_Domicilio!codigopostal & "), " & rs_Domicilio!locdesc
    EmpTelefono = rs_Domicilio!telnro
    'EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    'If Not EsNulo(rs_Domicilio!Piso) Then
    '    EmpDire = EmpDire & " " & rs_Domicilio!Piso
    'End If
    'If Not EsNulo(rs_Domicilio!oficdepto) Then
    '    EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    'End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = " & l_empimg_tipo & " AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de de la Empresa."
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha de la ultima face abierta
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = -1 ORDER BY altfec DESC"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "no se pudo obtener la Fecha de la ultima fase abierta. se busca la ultima face cerrada..."
    rsConsult.Close
    
    StrSql = " SELECT top 1 altfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC"
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "NO SE ENCONTRARON FASES PARA EL EMPLEADO"
        empFecAltaRec = ""
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
' otras fases cerradas
'------------------------------------------------------------------

StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = 0 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EmpOtrasFaces = -1
Else
    EmpOtrasFaces = 0
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la descripción del proceso de liquidación
'------------------------------------------------------------------
StrSql = " SELECT prodesc "
StrSql = StrSql & " FROM proceso "
StrSql = StrSql & " WHERE pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   DescProceso = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener la Descripción del Proceso"
   DescProceso = ""
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5,auxchar6,auxchar7,auxchar8, auxchar9, auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Categoria & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(EmpTelefono, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(EmpWebsite, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(LugarPago, 1, 150) & "'"
StrSql = StrSql & ",'" & col1_eti & "'"
StrSql = StrSql & ",'" & col2_eti & "'"
StrSql = StrSql & ",'" & col3_eti & "'"
StrSql = StrSql & ",'" & col4_eti & "'"
StrSql = StrSql & ",'" & CBU & "'"
StrSql = StrSql & "," & EmpOtrasFaces
StrSql = StrSql & ")"

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub



Sub generarDatosRecibo166(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de MEGATLON
'Fecha Creacion: 19/03/2014
'Autor: Carlos Masson
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim rsConsult2 As New ADODB.Recordset
Dim rsConsult3 As New ADODB.Recordset
Dim rs_estructura As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables que van en el insert final
Dim EmpNombre As String
Dim EmpEstrnro
Dim Direccion As String
Dim Localidad As String
Dim EmpCuit As String
Dim Nombre As String
Dim Apellido As String
Dim Legajo
Dim Convenio As String
Dim Categoria As String
Dim Tarea As String
Dim RemTotal
Dim empFecAltaRec
Dim Cuil
Dim empFecBaja
Dim empAntiguedad
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqhasta
Dim pliqdesc As String
Dim nroCuenta
Dim Banco As String
Dim CentroCosto As String
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proFecPago
Dim proDesc

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = IIf(EsNulo(rsConsult!pliqdesc), "", rsConsult!pliqdesc)
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro"
StrSql = StrSql & " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND"
StrSql = StrSql & " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)"
StrSql = StrSql & " AND his_estructura.ternro = " & Ternro
StrSql = StrSql & " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
EmpEstrnro = 0
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If


'------------------------------------------------------------------
'           Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " left JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    If Not EsNulo(rsConsult!locdesc) Then
        Direccion = Direccion & ", " & rsConsult!locdesc
    End If
Else
    Flog.writeline "Error al obtener los datos de la localidad"
    GoTo MError
End If


'------------------------------------------------------------------
'Buesco el CUIT
'------------------------------------------------------------------
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
    GoTo MError
Else
    EmpCuit = rsConsult!NroDoc
End If
Flog.writeline "Cuit de la Empresa" & StrSql
rsConsult.Close



'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del Convenio
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Convenio"
OpenRecordset StrSql, rsConsult

Convenio = "&nbsp;"
If Not rsConsult.EOF Then
   Convenio = rsConsult!estrdabr
'   Flog.writeline "Datos del Convenio obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio."
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la tarea
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Tarea = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Tarea"
   GoTo MError
End If

'------------------------------------------------------------------
'Remuneración
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND ( " & _
        "((confnrocol = 343) and (conftipo in ('CO', 'AC'))))"
OpenRecordset StrSql, rsConsult3

If Not rsConsult3.EOF Then
    If rsConsult3!conftipo = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & rsConsult3!confval & "AND cliqnro = " & cliqnro
    ElseIf rsConsult3!conftipo = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = " & rsConsult3!confval2 & " AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        Flog.writeline "        Valor para la columna " & Columna & " encontrado"
        RemTotal = rsConsult!Valor
    Else
        Flog.writeline "        No se encontro el acumulador o concepto para el sueldo remunerativo (columna 343)"
        RemTotal = 0
    End If
Else
    Flog.writeline "        Falta configurar la columna 343"
    GoTo MError
End If




'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha de la ultima face abierta
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = -1 ORDER BY altfec DESC"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de la ultima fase abierta."
    empFecAltaRec = ""
    GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el Egreso: tomar la fecha de baja de la ultima fase
'------------------------------------------------------------------
StrSql = " SELECT bajfec FROM fases WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = CStr(rsConsult!bajfec)
   Else
      empFecBaja = " "
   End If
Else
    Flog.writeline "No se encontraron fases"
    empFecBaja = " "
    GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la antigüedad reconocida del empleado
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases"
StrSql = StrSql & " LEFT JOIN empant ON fases.empantnro = empant.empantnro"
StrSql = StrSql & " LEFT JOIN causa ON fases.caunro = causa.caunro"
StrSql = StrSql & " Where fases.empleado = " & Ternro
StrSql = StrSql & " AND fasrecofec = -1"
StrSql = StrSql & " ORDER BY altfec ASC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    empAntiguedad = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la antigüedad reconocida del empleado"
    'GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc Banco, ctabancaria.ctabnro Numcuenta"
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " inner join formapago on formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " left join banco on banco.ternro = ctabancaria.banco"
StrSql = StrSql & " Where ctabancaria.ctabestado = -1"
StrSql = StrSql & " AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

nroCuenta = ""
Banco = ""
If Not rsConsult.EOF Then
    nroCuenta = IIf(EsNulo(rsConsult!Numcuenta), "", rsConsult!Numcuenta)
    Banco = IIf(EsNulo(rsConsult!Banco), "", rsConsult!Banco)
Else
   Flog.writeline "No se encontro los datos de la forma de pago Banco - Nº Cuenta"
   'GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrcodext
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
Flog.writeline "Busco los datos de la cargas sociales"
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
   'GoTo MError
End If


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rsConsult!tipimdire & rsConsult!terimnombre
    EmpLogoAlto = rsConsult!tipimaltodef
    EmpLogoAncho = rsConsult!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rsConsult!tipimdire & rsConsult!terimnombre
    EmpFirmaAlto = rsConsult!tipimaltodef
    EmpFirmaAncho = rsConsult!tipimanchodef
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3,auxchar4,auxchar5,auxchar6,auxchar7)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",''"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & RemTotal
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & CentroCosto & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & Direccion & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & ",'" & tenro1 & "'"
StrSql = StrSql & ",'" & EmpEstrnro1 & "'"
StrSql = StrSql & ",'" & tenro2 & "'"
StrSql = StrSql & ",'" & EmpEstrnro2 & "'"
StrSql = StrSql & ",'" & tenro3 & "'"
StrSql = StrSql & ",'" & EmpEstrnro3 & "'"
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & Tarea & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & pliqdesc & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & empAntiguedad & "'"
StrSql = StrSql & ")"

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo167(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de 5CA
'Fecha Creacion: 13/05/2014
'Autor: Facundo Eggle
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Sector
Dim ObraSocial
Dim regimenJub

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim empFecBaja

Dim AntigDias As Integer
Dim AntigMeses As Integer
Dim AntigAnios As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu,empfecbaja "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'empFecBaja = rsConsult!empFecBaja
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la fecha baja
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = "'" & rsConsult!bajfec & "'"
   Else
      empFecBaja = "null"
   End If
Else
   empFecBaja = "null"
End If

rsConsult.Close

'------------------------------------------------------------------
'Calculo la antiguedad correspondiente según el mes de liquidación
'------------------------------------------------------------------

Call bus_Anti0(Ternro, pliqanio, pliqmes, AntigDias, AntigMeses, AntigAnios)

'antig= AntigAnios & "&nbsp;a&ntilde;o/s" & AntigMeses & "&nbsp;mes/es" & AntigDias "&nbsp;d&iacute;a/s"
'Antiguedad = ""
'Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
'Fecha_aux = DateAdd("m", 1, Fecha_aux)
'Fecha_aux = DateAdd("d", -1, Fecha_aux)

'If Fecha_aux < empFecAlta Then
'    Antiguedad = "0 año/s 0 mes/ses"
'    AntigAnios = 0
'    AntigMeses = 0
'    AntigDias = 0
'Else
'    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    'Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
'    AntigAnios = anios_aux
'    AntigMeses = meses_aux
'    AntigDias = diasHab_aux
'End If


'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,provincia.provdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN provincia ON detdom.provnro = provincia.provnro"
       
OpenRecordset StrSql, rsConsult

Direccion = ""
Localidad = ""

If Not rsConsult.EOF Then
   Direccion = rsConsult!provdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pafo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del lugar de pago"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

CentroCosto = ""
If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
'   CentroCosto = rsConsult!estrcodext
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la sucursal"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 24 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el regimen jubilatorio
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 15 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenJub = ""

If Not rsConsult.EOF Then
   regimenJub = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1, auxchar2, auxchar3, auxchar4, "
StrSql = StrSql & " auxdeci1, auxdeci2, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & regimenJub & "'"
StrSql = StrSql & "," & empFecBaja
StrSql = StrSql & "," & AntigAnios
StrSql = StrSql & "," & AntigMeses
StrSql = StrSql & "," & AntigDias
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo168(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de PUIG
'Fecha Creacion: 21/05/2014
'Autor: Facundo Eggle
' Modificacion: Facundo Eggle - CAS-25506 - PUIG - Reporte de Recibo de Haberes - modificación
'               Se eliminan las búsquedas de "neto en pesos", "sueldo basico" y "neto en bonos"
'-----------------------------------------------------------------

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim empFecRec

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Long
Dim CtaNro As String
Dim CtaBanco As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
   tprocdesc = rsConsult!tprocdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco la Fecha de Baja del empleado.
'------------------------------------------------------------------
empFecBaja = "&nbsp;"
If Not empest Then
    StrSql = " SELECT bajfec "
    StrSql = StrSql & " FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        empFecBaja = rsConsult!bajfec
    Else
        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Baja del Empleado"
    End If
End If

'------------------------------------------------------------------
'Busco la fecha de Alta Reconocida
'------------------------------------------------------------------

StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " and fasrecofec=-1 "

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecRec = rsConsult!altfec
Else
   empFecRec = ""
   Flog.writeline "No se encontro la fecha de alta reconocida"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la obra social elegida"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor de la Forma de Liquidacion
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!estrcodext = 2 Or rsConsult!estrcodext = 4 Then
        pliqdesc = Mid(tprocdesc, 1, 12) & "    " & FormatNumber(pliqmes, 2) & "-" & FormatNumber(pliqanio, 4)
    End If
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, banco.bandesc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

FormaPago = "&nbsp;"
CtaNro = "&nbsp;"
CtaBanco = "&nbsp;"
If Not rsConsult.EOF Then
    CtaNro = IIf(EsNulo(rsConsult!ctabnro), "&nbsp;", rsConsult!ctabnro)
    StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & Ternro & " AND tidnro = 23"
    OpenRecordset StrSql, rs_cuit
    If Not rs_cuit.EOF Then
        CtaNro = IIf(EsNulo(rs_cuit!NroDoc), "&nbsp;", rs_cuit!NroDoc)
    Else
        StrSql = " SELECT nrodoc FROM ter_doc WHERE ter_doc.ternro = " & Ternro & " AND tidnro = 12"
        OpenRecordset StrSql, rs_cuit
        If Not rs_cuit.EOF Then
            CtaNro = IIf(EsNulo(rs_cuit!NroDoc), "&nbsp;", rs_cuit!NroDoc)
        End If
    End If
    
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
        CtaBanco = IIf(EsNulo(rsConsult!terrazsoc), "&nbsp;", rsConsult!terrazsoc)
    Else
        FormaPago = IIf(EsNulo(rsConsult!fpagdescabr), "&nbsp;", rsConsult!fpagdescabr)
    End If
Else
   Flog.writeline "Error al obtener los datos de la forma de pago. No se creo el Pedido de Pago para el empleado"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = "&nbsp;"
Localidad = "&nbsp;"
If Not rsConsult.EOF Then
    Direccion = rsConsult!calle & " " & rsConsult!nro
    Localidad = Direccion
Else
   Flog.writeline "Error al obtener los datos de la localidad"
   'GoTo MError
End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " " & rs_Domicilio!locdesc
    End If
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " CP. " & rs_Domicilio!codigopostal
    End If
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Mid(pliqdesc, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaNro, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CtaBanco, 1, 100) & "'"
StrSql = StrSql & ",'" & empFecRec & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True

End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para Punto Farma
'--------------------------------------------------------------------
Sub generarDatosRecibo169(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc,detdom.piso,detdom.oficdepto"
StrSql = StrSql & " From tercero "
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = tercero.ternro AND tercero.ternro = " & Ternro
StrSql = StrSql & " AND cabdom.domdefault = -1 "
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
'05/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir
If Not rsConsult.EOF Then
    'Direccion = rsConsult!calle & " " & rsConsult!Nro & ", " & rsConsult!locdesc
    Direccion = rsConsult!calle & " " & rsConsult!nro
    
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Localidad = ""
If Not rsConsult.EOF Then
   Localidad = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Sector
'------------------------------------------------------------------

If Len(TipoEstrConf) = 0 Then
    TipoEstrConf = 4
End If

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & TipoEstrConf
StrSql = StrSql & " And his_estructura.Ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
  If rsConsult!fpagbanc = "-1" Then
    FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
  Else
    FormaPago = rsConsult!fpagdescabr
  End If
Else
'   Flog.writeline "Error al obtener los datos de la forma de pago"
'   GoTo MError
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo de Clarin
'--------------------------------------------------------------------
Sub generarDatosRecibo170(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAltaRec
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim profecfin

Dim empFecBaja
Dim empFecAlta
Dim regimenHor
Dim os_eleg
Dim reportaa
Dim empreporta
Dim grupoSeguridad

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Sucursal

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu, empfecbaja, empreporta "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
'   empFecAlta = rsConsult!empfaltagr
'   empFecBaja = rsConsult!empFecBaja
   empreporta = rsConsult!empreporta
    
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta y Baja del empleado. Corresponde a la fecha desde de la ultima fase.
'------------------------------------------------------------------
StrSql = " SELECT altfec, bajfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   empFecBaja = rsConsult!bajfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta y Baja del Empleado"
   empFecAlta = ""
   empFecBaja = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAltaRec = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAltaRec = ""
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del reporta a
'------------------------------------------------------------------
If IsNull(empreporta) Then
    reportaa = ""
Else
    StrSql = " SELECT empleg,terape,terape2,ternom,ternom2 "
    StrSql = StrSql & " FROM empleado "
    StrSql = StrSql & " WHERE ternro= " & empreporta
           
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
       reportaa = rsConsult!terape & " " & rsConsult!terape2
       reportaa = reportaa & ", " & rsConsult!ternom & " " & rsConsult!ternom2
    Else
       reportaa = ""
    End If

End If

'------------------------------------------------------------------
'Busco la Fecha Fin del proceso
'------------------------------------------------------------------
StrSql = " SELECT profecfin FROM proceso "
StrSql = StrSql & " WHERE proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   profecfin = rsConsult!profecfin
Else
   Flog.writeline "Error al obtener la fecha fin del Proceso " & Pronro
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del grupo de seguridad
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 7 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

grupoSeguridad = ""

If Not rsConsult.EOF Then
   grupoSeguridad = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del grupo de seguridad"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del regimen horario
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 21 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

regimenHor = ""

If Not rsConsult.EOF Then
   regimenHor = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la OS Elegida
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

os_eleg = ""

If Not rsConsult.EOF Then
   os_eleg = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(profecfin) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(profecfin) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT * FROM ctabancaria WHERE ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then

  If rsConsult.RecordCount = 1 Then
     
     'La forma de pago la saca de ctabancaria, por que sino cuando es cheque no la encuentra
     StrSql = "SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc "
     StrSql = StrSql & " From ctabancaria "
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
     StrSql = StrSql & " LEFT JOIN tercero ON tercero.ternro =  ctabancaria.banco"
     StrSql = StrSql & " WHERE ctabancaria.ternro=" & Ternro
  
  Else
     
     StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
     StrSql = StrSql & " From pago"
     StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
     StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
     StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
  
  End If
  
  rsConsult.Close
       
  OpenRecordset StrSql, rsConsult

  If Not rsConsult.EOF Then
     If CBool(rsConsult!fpagbanc) Then
        FormaPago = rsConsult!fpagdescabr & " " & rsConsult!terrazsoc & " Cuenta:" & rsConsult!ctabnro
     Else
        FormaPago = rsConsult!fpagdescabr
     End If
  Else
     Flog.writeline "Error, no se encuentra la forma de pago del empleado"
  End If

Else
   Flog.writeline "Error, el empleado no tiene cuentas bancarias"
End If

rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(profecfin) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(profecfin) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpEstrnro = rs_estructura!Estrnro
    EmpNombre = rs_estructura!empnom
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If


'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco la sucursaal
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(profecfin) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(profecfin) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Sucursal = ""

If Not rsConsult.EOF Then
    Sucursal = rsConsult!estrdabr
Else
    Sucursal = ""
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden, auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(empFecBaja, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(regimenHor, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(os_eleg, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(reportaa, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(grupoSeguridad, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(empFecAlta, 1, 100) & "'"
StrSql = StrSql & ")"
'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo CAS-26571 - VSO - Interpack - Modelo 1
'--------------------------------------------------------------------
Sub generarDatosRecibo171(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim te1 As Long
Dim te2 As Long
Dim te3 As Long
Dim te4 As Long

Dim ObraSocial

Dim LugarDePago

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Dim te1_estnro As String
Dim te2_estnro As String
Dim te3_estnro As String
Dim te4_estnro As String

Dim te1_eti As String
Dim te2_eti As String
Dim te3_eti As String
Dim te4_eti As String
Dim l_soj_tipo As String
Dim l_soj_nro As String
Dim l_soj_importe As Double
Dim l_pag_tipo As Long

Dim Antiguedad As String
Dim dias_aux As Integer
Dim meses_aux As Integer
Dim anios_aux As Integer
Dim diasHab_aux As Integer

Dim SalarioNeto As Double
Dim modeloDesc As String

te1_estnro = ""
te2_estnro = ""
te3_estnro = ""
te4_estnro = ""
Sueldo = 0
l_soj_tipo = ""
l_soj_importe = 0
l_pag_tipo = 0

'------------------------------------------------------------------
'Busco los campos de tipo EST a mostrar en el modelo
'------------------------------------------------------------------
StrSql = "SELECT * from confrep where repnro=60 and confnrocol IN (359, 360, 361, 362, 363, 366, 365)"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    Select Case rsConsult("confnrocol")
    Case 359
        te1 = rsConsult("confval")
        te1_eti = rsConsult("confetiq")
    Case 360
        te2 = rsConsult("confval")
        te2_eti = rsConsult("confetiq")
    Case 361
        te3 = rsConsult("confval")
        te3_eti = rsConsult("confetiq")
    Case 362
        te4 = rsConsult("confval")
        te4_eti = rsConsult("confetiq")
    Case 363
        l_soj_tipo = rsConsult("conftipo")
        l_soj_nro = rsConsult("confval2")
    
    Case 365
        l_pag_tipo = rsConsult("confval")
    
    End Select
    
    rsConsult.MoveNext
Loop




'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc, periodo.pliqdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = proceso.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!pliqdesc
   modeloDesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Obtengo importe para el campo Sueldo o Jornal
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_soj_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_soj_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "SUELDO : " & UCase(l_soj_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        Sueldo = rsConsult("valor")
    End If
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec,bajfec,fasrecofec "
StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    empFecBaja = rsConsult!bajfec
    Do While Not rsConsult.EOF
        If rsConsult!fasrecofec = -1 Then
            empFecAlta = rsConsult!altfec
            empFecBaja = rsConsult!bajfec
            Exit Do
        End If
        rsConsult.MoveNext
    Loop
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If
'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If te1 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te1
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te1_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If te2 <> 0 Then
    StrSql = "SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te2
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te2_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If te3 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te3
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te3_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 4
'------------------------------------------------------------------
If te4 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te4
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te4_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del lugar de pago
'------------------------------------------------------------------
If l_pag_tipo <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & l_pag_tipo
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        LugarDePago = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
If CDate(pliqhasta) < empFecAlta Then
    Antiguedad = "0 - 0"
Else
    Call bus_AntiguedadReconocida(Ternro, "REAL", CDate(pliqhasta), dias_aux, meses_aux, anios_aux, diasHab_aux)
    
    Antiguedad = CStr(anios_aux) & " - " & CStr(meses_aux)
    
End If
'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

StrSql = "SELECT * "
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
    FormaPago = " "
    Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
'LugarDePago = ""
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   LugarDePago = rsConsult!estrdabr
'End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la sucursal
StrSql = "SELECT calle,nro,piso, oficdepto, locdesc " & _
            "From his_estructura " & _
            "INNER JOIN sucursal ON sucursal.estrnro = his_estructura.estrnro " & _
            "INNER JOIN cabdom ON cabdom.ternro=sucursal.ternro " & _
            "INNER JOIN detdom ON detdom.domnro = cabdom.domnro " & _
            "INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            "WHERE his_estructura.htetdesde <= " & ConvFecha(pliqhasta) & " AND " & _
            "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL) " & _
            "AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro  = 1"

OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la sucursal"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        'TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        'TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    'TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar la leyenda configurada
'------------------------------------------------------------------

StrSql = "SELECT confval, confval2 from confrep where repnro=60 and conftipo = 'TX1'"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    StrSql = " SELECT estrnro FROM his_estructura WHERE ternro = " & Ternro & " AND his_estructura.estrnro = " & rsConsult("confval")
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rs_estructura
    If Not rs_estructura.EOF Then
        'si tiene la estructura le inserto la leyenda
        
        StrSql = "INSERT INTO rep_recibo_leyenda (bpronro, ternro, pronro, leyenda) VALUES (" & NroProceso & "," & Ternro & "," & Pronro & ",'" & rsConsult("confval2") & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
        
    End If
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   SalarioNeto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
   SalarioNeto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxdeci1, auxchar3, auxchar4, auxchar5, auxchar6, auxchar7, auxchar8, auxchar9, auxchar10, auxchar11, auxdeci5, auxchar12)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Banco, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarDePago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ",'" & te1_estnro & "'"
StrSql = StrSql & ",'" & te1_eti & "'"
StrSql = StrSql & ",'" & te2_estnro & "'"
StrSql = StrSql & ",'" & te2_eti & "'"
StrSql = StrSql & ",'" & te3_estnro & "'"
StrSql = StrSql & ",'" & te3_eti & "'"
StrSql = StrSql & ",'" & te4_estnro & "'"
StrSql = StrSql & ",'" & te4_eti & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ",'" & modeloDesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, confrep.conftipo "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro  AND concepto.concimp = -1 "
StrSql = StrSql & " INNER JOIN confrep ON concepto.tconnro=confrep.confval AND (confrep.repnro=60 AND (confrep.conftipo='HA1' or confrep.conftipo='DE1'))"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
Flog.writeline "<br/>" & StrSql & "<br/>"

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & rsConsult!conftipo & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo CAS-26571 - VSO - Interpack - Modelo 2
'--------------------------------------------------------------------
Sub generarDatosRecibo172(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim modeloDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim te1 As Long
Dim te2 As Long
Dim te3 As Long
Dim te4 As Long

Dim ObraSocial

Dim LugarDePago

Dim SalarioNeto As Double

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Dim te1_estnro As String
Dim te2_estnro As String
Dim te3_estnro As String
Dim te4_estnro As String

Dim te1_eti As String
Dim te2_eti As String
Dim te3_eti As String
Dim te4_eti As String
Dim l_soj_tipo As String
Dim l_soj_nro As String
Dim l_acfa_tipo As String
Dim l_acfa_nro As String
Dim l_soj_importe As Double

Dim Antiguedad As String
Dim dias_aux As Integer
Dim meses_aux As Integer
Dim anios_aux As Integer
Dim diasHab_aux As Integer
Dim l_pag_tipo As Long
te1_estnro = ""
te2_estnro = ""
te3_estnro = ""
te4_estnro = ""
Sueldo = 0
l_soj_tipo = ""
l_pag_tipo = 0
l_soj_importe = 0
l_acfa = 0

'------------------------------------------------------------------
'Busco los campos de tipo EST a mostrar en el modelo
'------------------------------------------------------------------
StrSql = "SELECT * from confrep where repnro=60 and confnrocol IN (359, 360, 361, 362, 379, 366, 365)"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    Select Case rsConsult("confnrocol")
    Case 359
        te1 = rsConsult("confval")
        te1_eti = rsConsult("confetiq")
    Case 360
        te2 = rsConsult("confval")
        te2_eti = rsConsult("confetiq")
    Case 361
        te3 = rsConsult("confval")
        te3_eti = rsConsult("confetiq")
    Case 362
        te4 = rsConsult("confval")
        te4_eti = rsConsult("confetiq")
    Case 379  'sueldo
        l_soj_tipo = rsConsult("conftipo")
        l_soj_nro = rsConsult("confval2")
        
    Case 366  'acfa
        l_acfa_tipo = rsConsult("conftipo")
        l_acfa_nro = rsConsult("confval2")
    
    Case 365
        l_pag_tipo = rsConsult("confval")
        
    End Select
    
    rsConsult.MoveNext
Loop




'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc, periodo.pliqdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = proceso.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!pliqdesc
   modeloDesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If



'------------------------------------------------------------------
'Obtengo importe para el campo Sueldo o Jornal
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_soj_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_soj_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "SUELDO : " & UCase(l_soj_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        Sueldo = rsConsult("valor")
    End If
End If


'------------------------------------------------------------------
'Obtengo importe para el campo ACFA
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_acfa_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_acfa_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "ACFA : " & UCase(l_acfa_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        l_acfa = rsConsult("valor")
    End If
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec,bajfec,fasrecofec "
StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    empFecBaja = rsConsult!bajfec
    Do While Not rsConsult.EOF
        If rsConsult!fasrecofec = -1 Then
            empFecAlta = rsConsult!altfec
            empFecBaja = rsConsult!bajfec
            Exit Do
        End If
        rsConsult.MoveNext
    Loop
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If
'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If te1 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te1
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te1_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If te2 <> 0 Then
    StrSql = "SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te2
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te2_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If te3 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te3
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te3_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 4
'------------------------------------------------------------------
If te4 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te4
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te4_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del lugar de pago
'------------------------------------------------------------------
If l_pag_tipo <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & l_pag_tipo
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        LugarDePago = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
If CDate(pliqhasta) < empFecAlta Then
    Antiguedad = "0 - 0"
Else
    Call bus_AntiguedadReconocida(Ternro, "REAL", CDate(pliqhasta), dias_aux, meses_aux, anios_aux, diasHab_aux)
    
    Antiguedad = CStr(anios_aux) & " - " & CStr(meses_aux)
    
End If
'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

StrSql = "SELECT * "
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
    FormaPago = " "
    Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
'LugarDePago = ""
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   LugarDePago = rsConsult!estrdabr
'End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la sucursal
StrSql = "SELECT calle,nro,piso, oficdepto, locdesc " & _
            "From his_estructura " & _
            "INNER JOIN sucursal ON sucursal.estrnro = his_estructura.estrnro " & _
            "INNER JOIN cabdom ON cabdom.ternro=sucursal.ternro " & _
            "INNER JOIN detdom ON detdom.domnro = cabdom.domnro " & _
            "INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            "WHERE his_estructura.htetdesde <= " & ConvFecha(pliqhasta) & " AND " & _
            "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL) " & _
            "AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro  = 1"

OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la sucursal"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If



'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Buscando los datos de la cuenta del empleado."

'StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'        Banco = rsConsult!Bandesc
'        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
'  Else
'        Banco = ""
'        nroCuenta = ""
'        Flog.writeline "El empleado no tiene cuentas bancarias activas"
'End If


'rsConsult.Close

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        'TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        'TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    'TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close



'------------------------------------------------------------------
'Armo la SQL para guardar la leyenda configurada
'------------------------------------------------------------------

StrSql = "SELECT confval, confval2 from confrep where repnro=60 and conftipo = 'TX2'"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    StrSql = " SELECT estrnro FROM his_estructura WHERE ternro = " & Ternro & " AND his_estructura.estrnro = " & rsConsult("confval")
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rs_estructura
    If Not rs_estructura.EOF Then
        'si tiene la estructura le inserto la leyenda
        
        StrSql = "INSERT INTO rep_recibo_leyenda (bpronro, ternro, pronro, leyenda) VALUES (" & NroProceso & "," & Ternro & "," & Pronro & ",'" & rsConsult("confval2") & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
        
    End If
    
    rsConsult.MoveNext
Loop

'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   SalarioNeto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
   SalarioNeto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxdeci1, auxchar3, auxchar4, auxchar5, auxchar6, auxchar7, auxchar8, auxchar9, auxchar10, auxchar11, auxdeci2, auxdeci5, auxchar12)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Banco, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarDePago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ",'" & te1_estnro & "'"
StrSql = StrSql & ",'" & te1_eti & "'"
StrSql = StrSql & ",'" & te2_estnro & "'"
StrSql = StrSql & ",'" & te2_eti & "'"
StrSql = StrSql & ",'" & te3_estnro & "'"
StrSql = StrSql & ",'" & te3_eti & "'"
StrSql = StrSql & ",'" & te4_estnro & "'"
StrSql = StrSql & ",'" & te4_eti & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & "," & l_acfa
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ",'" & modeloDesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, confrep.conftipo "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " INNER JOIN confrep ON concepto.tconnro=confrep.confval AND (confrep.repnro=60 AND confrep.conftipo='HA2' or confrep.conftipo='DE2')"
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
'Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & rsConsult!conftipo & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo CAS-26571 - VSO - Interpack - Modelo 3
'--------------------------------------------------------------------
Sub generarDatosRecibo173(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim modeloDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim te1 As Long
Dim te2 As Long
Dim te3 As Long
Dim te4 As Long

Dim ObraSocial

Dim LugarDePago

Dim SalarioNeto As Double

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Dim te1_estnro As String
Dim te2_estnro As String
Dim te3_estnro As String
Dim te4_estnro As String

Dim te1_eti As String
Dim te2_eti As String
Dim te3_eti As String
Dim te4_eti As String
Dim l_soj_tipo As String
Dim l_soj_nro As String
Dim l_acfa_tipo As String
Dim l_acfa_nro As String
Dim l_soj_importe As Double

Dim Antiguedad As String
Dim dias_aux As Integer
Dim meses_aux As Integer
Dim anios_aux As Integer
Dim diasHab_aux As Integer
Dim l_pag_tipo As Long
te1_estnro = ""
te2_estnro = ""
te3_estnro = ""
te4_estnro = ""
Sueldo = 0
l_soj_tipo = ""
l_pag_tipo = 0
l_soj_importe = 0
l_acfa = 0

'------------------------------------------------------------------
'Busco los campos de tipo EST a mostrar en el modelo
'------------------------------------------------------------------
StrSql = "SELECT * from confrep where repnro=60 and confnrocol IN (359, 360, 361, 362, 380, 366, 365)"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    Select Case rsConsult("confnrocol")
    Case 359
        te1 = rsConsult("confval")
        te1_eti = rsConsult("confetiq")
    Case 360
        te2 = rsConsult("confval")
        te2_eti = rsConsult("confetiq")
    Case 361
        te3 = rsConsult("confval")
        te3_eti = rsConsult("confetiq")
    Case 362
        te4 = rsConsult("confval")
        te4_eti = rsConsult("confetiq")
    Case 380  'sueldo
        l_soj_tipo = rsConsult("conftipo")
        l_soj_nro = rsConsult("confval2")
        
    Case 366  'acfa
        l_acfa_tipo = rsConsult("conftipo")
        l_acfa_nro = rsConsult("confval2")
    
    Case 365
        l_pag_tipo = rsConsult("confval")
        
    End Select
    
    rsConsult.MoveNext
Loop




'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc, periodo.pliqdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = proceso.pliqnro "
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!pliqdesc
   modeloDesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If



'------------------------------------------------------------------
'Obtengo importe para el campo Sueldo o Jornal
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_soj_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_soj_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "SUELDO : " & UCase(l_soj_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        Sueldo = rsConsult("valor")
    End If
End If


'------------------------------------------------------------------
'Obtengo importe para el campo ACFA
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_acfa_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_acfa_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "ACFA : " & UCase(l_acfa_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        l_acfa = rsConsult("valor")
    End If
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec,bajfec,fasrecofec "
StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    empFecBaja = rsConsult!bajfec
    Do While Not rsConsult.EOF
        If rsConsult!fasrecofec = -1 Then
            empFecAlta = rsConsult!altfec
            empFecBaja = rsConsult!bajfec
            Exit Do
        End If
        rsConsult.MoveNext
    Loop
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If
'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If te1 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te1
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te1_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If te2 <> 0 Then
    StrSql = "SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te2
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te2_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If te3 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te3
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te3_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 4
'------------------------------------------------------------------
If te4 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te4
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te4_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del lugar de pago
'------------------------------------------------------------------
If l_pag_tipo <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & l_pag_tipo
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        LugarDePago = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
If CDate(pliqhasta) < empFecAlta Then
    Antiguedad = "0 - 0"
Else
    Call bus_AntiguedadReconocida(Ternro, "REAL", CDate(pliqhasta), dias_aux, meses_aux, anios_aux, diasHab_aux)
    
    Antiguedad = CStr(anios_aux) & " - " & CStr(meses_aux)
    
End If
'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

StrSql = "SELECT * "
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
    FormaPago = " "
    Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
'LugarDePago = ""
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   LugarDePago = rsConsult!estrdabr
'End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la sucursal
StrSql = "SELECT calle,nro,piso, oficdepto, locdesc " & _
            "From his_estructura " & _
            "INNER JOIN sucursal ON sucursal.estrnro = his_estructura.estrnro " & _
            "INNER JOIN cabdom ON cabdom.ternro=sucursal.ternro " & _
            "INNER JOIN detdom ON detdom.domnro = cabdom.domnro " & _
            "INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            "WHERE his_estructura.htetdesde <= " & ConvFecha(pliqhasta) & " AND " & _
            "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL) " & _
            "AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro  = 1"

OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la sucursal"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If




'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Buscando los datos de la cuenta del empleado."

'StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'        Banco = rsConsult!Bandesc
'        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
'  Else
'        Banco = ""
'        nroCuenta = ""
'        Flog.writeline "El empleado no tiene cuentas bancarias activas"
'End If


'rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        'TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        'TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    'TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar la leyenda configurada
'------------------------------------------------------------------
StrSql = "SELECT confval, confval2 from confrep where repnro=60 and conftipo = 'TX3'"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    StrSql = " SELECT estrnro FROM his_estructura WHERE ternro = " & Ternro & " AND his_estructura.estrnro = " & rsConsult("confval")
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rs_estructura
    If Not rs_estructura.EOF Then
        'si tiene la estructura le inserto la leyenda
        
        StrSql = "INSERT INTO rep_recibo_leyenda (bpronro, ternro, pronro, leyenda) VALUES (" & NroProceso & "," & Ternro & "," & Pronro & ",'" & rsConsult("confval2") & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
        
    End If
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   SalarioNeto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
   SalarioNeto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxdeci1, auxchar3, auxchar4, auxchar5, auxchar6, auxchar7, auxchar8, auxchar9, auxchar10, auxchar11, auxdeci2, auxdeci5, auxchar12)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Banco, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarDePago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ",'" & te1_estnro & "'"
StrSql = StrSql & ",'" & te1_eti & "'"
StrSql = StrSql & ",'" & te2_estnro & "'"
StrSql = StrSql & ",'" & te2_eti & "'"
StrSql = StrSql & ",'" & te3_estnro & "'"
StrSql = StrSql & ",'" & te3_eti & "'"
StrSql = StrSql & ",'" & te4_estnro & "'"
StrSql = StrSql & ",'" & te4_eti & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & "," & l_acfa
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ",'" & modeloDesc & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, confrep.conftipo, adi.conftipo AD "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro    AND concepto.concimp = -1 "
StrSql = StrSql & " LEFT JOIN confrep  ON concepto.tconnro=confrep.confval AND (confrep.repnro=60 AND confrep.conftipo='HA3' or confrep.conftipo='DE3')"
StrSql = StrSql & " LEFT JOIN confrep adi ON concepto.conccod=adi.confval2 AND (adi.repnro=60 AND adi.conftipo='AD3')"
StrSql = StrSql & " WHERE confrep.conftipo Is Not Null Or adi.conftipo Is Not Null "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
Flog.writeline ""
Flog.writeline StrSql
Flog.writeline ""

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    If IsNull(rsConsult!AD) Then
        StrSql = StrSql & ",'" & rsConsult!conftipo & "')"
    Else
        StrSql = StrSql & ",'" & rsConsult!AD & "')"
    End If
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo CAS-26571 - VSO - Interpack - Modelo 4 Celomat
'--------------------------------------------------------------------
Sub generarDatosRecibo174(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim modeloDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim te1 As Long
Dim te2 As Long
Dim te3 As Long
Dim te4 As Long


Dim SalarioNeto As Double

Dim ObraSocial

Dim LugarDePago

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Dim te1_estnro As String
Dim te2_estnro As String
Dim te3_estnro As String
Dim te4_estnro As String

Dim te1_eti As String
Dim te2_eti As String
Dim te3_eti As String
Dim te4_eti As String
Dim l_soj_tipo As String
Dim l_soj_nro As String
Dim l_acfa_tipo As String
Dim l_acfa_nro As String
Dim l_soj_importe As Double

Dim Antiguedad As String
Dim dias_aux As Integer
Dim meses_aux As Integer
Dim anios_aux As Integer
Dim diasHab_aux As Integer
Dim l_pag_tipo As Long
te1_estnro = ""
te2_estnro = ""
te3_estnro = ""
te4_estnro = ""
Sueldo = 0
l_soj_tipo = ""
l_pag_tipo = 0
l_soj_importe = 0
l_acfa = 0

'------------------------------------------------------------------
'Busco los campos de tipo EST a mostrar en el modelo
'------------------------------------------------------------------
Flog.writeline "Buscando las estructuras y conceptos configurados en confrep..."
StrSql = "SELECT * from confrep where repnro=60 and confnrocol IN (359, 360, 361, 362, 381,364, 365, 366, 367)"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    Select Case rsConsult("confnrocol")
    Case 359   'AFJP
        te1 = rsConsult("confval")
        te1_eti = rsConsult("confetiq")
    Case 360   'OBRA SOCIAL
        te2 = rsConsult("confval")
        te2_eti = rsConsult("confetiq")
    Case 361   'CARGO
        te3 = rsConsult("confval")
        te3_eti = rsConsult("confetiq")
    Case 362  'CATEGORIA
        te4 = rsConsult("confval")
        te4_eti = rsConsult("confetiq")
    Case 364  'area
        te5 = rsConsult("confval")
        te5_eti = rsConsult("confetiq")
    Case 367  'ocupacion
        te6 = rsConsult("confval")
        te6_eti = rsConsult("confetiq")
        
    Case 365
        l_pag_tipo = rsConsult("confval")
        
    Case 366  'acfa
        l_acfa_tipo = rsConsult("conftipo")
        l_acfa_nro = rsConsult("confval2")
    Case 381  'sueldo
        l_soj_tipo = rsConsult("conftipo")
        l_soj_nro = rsConsult("confval2")
        
    End Select
    
    rsConsult.MoveNext
Loop




'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini, tipoproc.tprocdesc, periodo.pliqdesc FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "
StrSql = StrSql & " INNER JOIN periodo ON periodo.pliqnro = proceso.pliqnro "
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!pliqdesc
   modeloDesc = rsConsult!tprocdesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If



'------------------------------------------------------------------
'Obtengo importe para el campo Sueldo o Jornal
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_soj_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_soj_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "SUELDO : " & UCase(l_soj_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        Sueldo = rsConsult("valor")
    End If
End If


'------------------------------------------------------------------
'Obtengo importe para el campo ACFA
'------------------------------------------------------------------
If l_soj_tipo <> "" Then
    If UCase(l_soj_tipo) = "AC" Then
        StrSql = " SELECT almonto valor From acu_liq Where acunro = " & l_acfa_nro & " AND cliqnro = " & cliqnro
    ElseIf UCase(l_soj_tipo) = "CO" Then
       StrSql = " SELECT d.dlimonto valor, d.dlicant valor2 FROM detliq d INNER JOIN concepto c ON c.conccod = '" & l_acfa_nro & "' AND c.concnro = d.concnro  WHERE d.cliqnro = " & cliqnro
    End If
    
    'Flog.writeline "ACFA : " & UCase(l_acfa_tipo) & StrSql
    
    OpenRecordset StrSql, rsConsult
    
    If Not rsConsult.EOF Then
        l_acfa = rsConsult("valor")
    End If
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec,bajfec,fasrecofec "
StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!altfec
    empFecBaja = rsConsult!bajfec
    Do While Not rsConsult.EOF
        If rsConsult!fasrecofec = -1 Then
            empFecAlta = rsConsult!altfec
            empFecBaja = rsConsult!bajfec
            Exit Do
        End If
        rsConsult.MoveNext
    Loop
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If
'------------------------------------------------------------------



'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------

StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
'    StrSql = " SELECT almonto"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acunroSueldo
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
'    OpenRecordset StrSql, rsConsult

'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!almonto
'    Else
'       Flog.writeline "Error al obtener los datos del sueldo"
'       Sueldo = 0
       'GoTo MError
'    End If
'End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1 (AFJP)
'------------------------------------------------------------------
If te1 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te1
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te1_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2 (OBRA SOCIAL)
'------------------------------------------------------------------
If te2 <> 0 Then
    StrSql = "SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te2
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te2_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3 (CARGO)
'------------------------------------------------------------------
If te3 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te3
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te3_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 4 (CATEGORIA)
'------------------------------------------------------------------
If te4 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te4
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te4_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del lugar de pago
'------------------------------------------------------------------
If l_pag_tipo <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & l_pag_tipo
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        LugarDePago = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 5 (AREA)
'------------------------------------------------------------------
If te5 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te5
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te5_estnro = rsConsult!estrdabr
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 6 (OCUPACION)
'------------------------------------------------------------------
If te6 <> 0 Then
    StrSql = " SELECT estrdabr FROM his_estructura inner join estructura on (his_estructura.estrnro=estructura.estrnro) WHERE ternro = " & Ternro & " AND his_estructura.tenro = " & te6
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        te6_estnro = rsConsult!estrdabr
    End If
End If


'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
If CDate(pliqhasta) < empFecAlta Then
    Antiguedad = "0 - 0"
Else
    Call bus_AntiguedadReconocida(Ternro, "REAL", CDate(pliqhasta), dias_aux, meses_aux, anios_aux, diasHab_aux)
    
    Antiguedad = CStr(anios_aux) & " - " & CStr(meses_aux)
    
End If
'------------------------------------------------------------------


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc"
'StrSql = StrSql & " From pago"
'StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro AND pago.pagorigen=" & cliqnro
'StrSql = StrSql & " LEFT JOIN banco     ON banco.ternro = pago.banternro"
'StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

StrSql = "SELECT * "
StrSql = StrSql & " From ctabancaria"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = ctabancaria.fpagnro"
StrSql = StrSql & " WHERE ctabestado=-1 AND ctabancaria.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FormaPago = rsConsult!fpagdescabr
Else
    FormaPago = " "
    Flog.writeline "Error al obtener los datos de la forma de pago"
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
'LugarDePago = ""
'StrSql = " SELECT estrdabr "
'StrSql = StrSql & " From his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult
'If Not rsConsult.EOF Then
'   LugarDePago = rsConsult!estrdabr
'End If


' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la sucursal
StrSql = "SELECT calle,nro,piso, oficdepto, locdesc " & _
            "From his_estructura " & _
            "INNER JOIN sucursal ON sucursal.estrnro = his_estructura.estrnro " & _
            "INNER JOIN cabdom ON cabdom.ternro=sucursal.ternro " & _
            "INNER JOIN detdom ON detdom.domnro = cabdom.domnro " & _
            "INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
            "WHERE his_estructura.htetdesde <= " & ConvFecha(pliqhasta) & " AND " & _
            "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL) " & _
            "AND his_estructura.ternro = " & Ternro & " AND his_estructura.tenro  = 1"

OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la sucursal"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If




'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Buscando los datos de la cuenta del empleado."

'StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'        Banco = rsConsult!Bandesc
'        nroCuenta = rsConsult!ctabnro
'        Flog.writeline "Datos de la cuenta bancaria obtenidos"
'  Else
'        Banco = ""
'        nroCuenta = ""
'        Flog.writeline "El empleado no tiene cuentas bancarias activas"
'End If


'rsConsult.Close


'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"

       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        'TipoCuenta = rsConsult!fpagdescabr ' & " " & rsConsult!terrazsoc & " " & rsConsult!ctabnro
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        'TipoCuenta = ""
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    'TipoCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar la leyenda configurada
'------------------------------------------------------------------

StrSql = "SELECT confval, confval2 from confrep where repnro=60 and conftipo = 'TX4'"
OpenRecordset StrSql, rsConsult
Do While Not rsConsult.EOF

    StrSql = " SELECT estrnro FROM his_estructura WHERE ternro = " & Ternro & " AND his_estructura.estrnro = " & rsConsult("confval")
    StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(pliqhasta) & " AND (htethasta is null or htethasta>=" & ConvFecha(pliqhasta) & "))"
    OpenRecordset StrSql, rs_estructura
    If Not rs_estructura.EOF Then
        'si tiene la estructura le inserto la leyenda
        
        StrSql = "INSERT INTO rep_recibo_leyenda (bpronro, ternro, pronro, leyenda) VALUES (" & NroProceso & "," & Ternro & "," & Pronro & ",'" & rsConsult("confval2") & "')"
        objConn.Execute StrSql, , adExecuteNoRecords
        
    End If
    
    rsConsult.MoveNext
Loop


'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
StrSql = " SELECT almonto"
StrSql = StrSql & " From acu_liq"
StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
StrSql = StrSql & " AND cliqnro = " & cliqnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   SalarioNeto = rsConsult!almonto
Else
   Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
   SalarioNeto = 0
   'GoTo MError
End If


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxdeci1, auxchar3, auxchar4, auxchar5, auxchar6, auxchar7, auxchar8, auxchar9, auxchar10, auxchar, auxdeci2, auxchar11, auxchar12, auxchar13, auxchar14, auxdeci5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Banco, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(LugarDePago, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
'StrSql = StrSql & ",'" & LugarDePago & "'"
StrSql = StrSql & ",'" & modeloDesc & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & "," & 0
StrSql = StrSql & ",'" & te1_estnro & "'"
StrSql = StrSql & ",'" & te1_eti & "'"
StrSql = StrSql & ",'" & te2_estnro & "'"
StrSql = StrSql & ",'" & te2_eti & "'"
StrSql = StrSql & ",'" & te3_estnro & "'"
StrSql = StrSql & ",'" & te3_eti & "'"
StrSql = StrSql & ",'" & te4_estnro & "'"
StrSql = StrSql & ",'" & te4_eti & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & "," & l_acfa
StrSql = StrSql & ",'" & te5_estnro & "'"
StrSql = StrSql & ",'" & te5_eti & "'"
StrSql = StrSql & ",'" & te6_estnro & "'"
StrSql = StrSql & ",'" & te6_eti & "'"
StrSql = StrSql & "," & SalarioNeto
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
'Flog.writeline StrSql

OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para Ingenio La Esperanza
' Basado en el modelo 55 de CCU
'--------------------------------------------------------------------
Sub generarDatosRecibo175(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Neto
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto
Dim aux1 As Long
Dim aux2 As Long
Dim aux3 As Long

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig
Dim Estructura As String
Dim fechaEstructura

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim esDiasConcepto As Boolean
Dim DiasCodCo As String
Dim DiasCodAC As Integer
Dim valorDiasTrab As Integer
On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0


'-------------------------------------------------------------------
'LEVANTO DEL CONFREP UNA COLUMNA ESPECIFICA DE ELLOS DIAS TRABAJADOS 12/05/2015
StrSql = "SELECT * FROM confrep "
StrSql = StrSql & " WHERE confnrocol=61 AND repnro=60"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If UCase(rsConsult!conftipo) = "CO" Then
        esDiasConcepto = True
        DiasCodCo = rsConsult!confval2
        Flog.writeline "Los dias trabajados se configuraron como concepto, valor: " & esDiasCod
    Else
        If UCase(rsConsult!conftipo) = "AC" Then
            esDiasConcepto = False
            DiasCodAC = rsConsult!confval
            Flog.writeline "Los dias trabajados se configuraron como Acumulador, valor: " & esDiasCod
        End If
    End If
Else
    Flog.writeline "No se configuro la columna 61 para el modelo 175"
End If
rsConsult.Close
'-------------------------------------------------------------------

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde
'Del tipo de estructura 31 (Condición Sicoss).
'------------------------------------------------------------------

StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = 31"
StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAlta = rsConsult!htetdesde
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
    empFecAlta = "&nbsp;"
End If

'------------------------------------------------------------------
'Calculo la nueva antiguedad sebastian stremel 28/04/2015
'------------------------------------------------------------------
'Dim l_texto
'Dim l_dia As String
'Dim l_mes As String
'Dim l_anio As String
'Dim l_hab As Integer
'
'Call antigfec2(Ternro, Date, l_dia, l_mes, l_anio, l_hab)
'
'If l_anio = "" Or l_anio = 0 Then
'    If l_mes = "" Or l_mes = 0 Then
'        l_texto = l_dia & " " & "día/s" & "."
'    Else
'        l_texto = l_mes & " " & "mes/es" & " " & l_dia & " " & "día/s" & "."
'    End If
'Else
'    l_texto = l_anio & " " & "año/s" & " " & l_mes & " " & "mes/es" & " " & l_dia & " " & "día/s" & "."
'End If
'Antiguedad = l_texto
'-----------------------------------------------------------------

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0"
Else
    'Call bus_Antiguedad(Ternro, "REAL", empFecAlta, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Call DIF_FECHAS2(empFecAlta, Fecha_aux, aux1, aux2, aux3)
    
    Antiguedad = "Años: " & aux3 & " Meses: " & aux2

End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco la descripcion y fecha de alta de la estructura configurada en la columna 42 (Tickets)
'------------------------------------------------------------------
Estructura = "&nbsp;"
fechaEstructura = "&nbsp;"
If Tickets <> 0 Then
    'Columna 42
    StrSql = " SELECT htetdesde, estrdabr FROM his_estructura "
    StrSql = StrSql & " INNER JOIN estructura ON his_estructura.estrnro = estructura.estrnro "
    StrSql = StrSql & " Where his_estructura.Ternro = " & Ternro & " And his_estructura.Tenro = " & Tickets
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") "
               
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
        Estructura = rsConsult!estrdabr
        fechaEstructura = rsConsult!htetdesde
    Else
        Flog.writeline Espacios(Tabulador * 1) & "El empleado no tiene la estructura configurada en la columna 42 del confrep a la fecha Hasta del periodo."
    End If
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " LEFT JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " LEFT JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " LEFT JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    Localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    Localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
'If Tickets <> 0 Then
'    'Columna 42
'    If esTicketsConc Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Tickets & " AND novemp.tpanro = 1"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           Sueldo = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Tickets & ") y parámetro 1."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 1"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   Sueldo = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 1."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor del Básico. La columna 43 del confrep debe ser un concepto, de tipo 'CO'."
'           End If
'           'FIN MENSUALES
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor del Básico. La columna 42 del confrep debe ser un concepto, de tipo 'CO'."
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor del Básico. No esta configurado el concepto en la columna 42 del confrep."
'End If
    
    
'If Sueldo = 0 Then
'    'Buscar en la escala de Básicos
'
'    'Determinar la sucursal del empleado. Ya la tengo
'    If SucursalNro = 0 Then
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Sucursal para determinar la escala del Básico."
'    End If
'
'    'Determinar el Convenio del empleado.
'    StrSql = " SELECT his_estructura.estrnro "
'    StrSql = StrSql & " From his_estructura"
'    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       ConvenioNro = rsConsult!Estrnro
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
'       ConvenioNro = 0
'    '   GoTo MError
'    End If
'
'    'Determinar la categoria del empleado. Ya la tengo
'    If CategoriaNro = 0 Then
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría para determinar la escala del Básico."
'    End If
'
'    'Determinar la Forma de Liquidacion
'    StrSql = " SELECT his_estructura.estrnro "
'    StrSql = StrSql & " From his_estructura"
'    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       FormaLiqNro = rsConsult!Estrnro
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidación para determinar la escala del Básico."
'       FormaLiqNro = 0
'    '   GoTo MError
'    End If
'
'    StrSql = " SELECT vgrvalor FROM valgrilla "
'    StrSql = StrSql & " WHERE cgrnro = 4 "
'    StrSql = StrSql & " AND vgrcoor_1 = " & SucursalNro
'    StrSql = StrSql & " AND vgrcoor_2 = " & ConvenioNro
'    StrSql = StrSql & " AND vgrcoor_3 = " & CategoriaNro
'    StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!vgrvalor
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Básico. No se encontro. SQL --> " & StrSql
'    End If
'
'End If

If Sueldo = 0 And acumHaberesConAp <> 0 Then
    'Columna 60
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acumHaberesConAp
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!Valor
       Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo del acumulador " & acumHaberesConAp
    End If
End If

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Neto = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Neto = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto a ensobrar. Se debe configurar en la columna 1 del confrep."
   Neto = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If


'------------------------------------------------------------------
'Busco el valor de los dias trabajados 12/05/2015
'------------------------------------------------------------------

'Columna 61
If esDiasConcepto Then
    StrSql = " SELECT dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto C ON C.concnro = detliq.concnro "
    StrSql = StrSql & " WHERE conccod = '" & DiasCodCo & "' AND cliqnro = " & cliqnro
Else
    StrSql = " SELECT almonto valor "
    StrSql = StrSql & " FROM acu_liq "
    StrSql = StrSql & " WHERE acunro = " & DiasCodAC & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    valorDiasTrab = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
    Flog.writeline Espacios(Tabulador * 1) & "---> El valor de los dias trabajados es: " & valorDiasTrab
Else
    valorDiasTrab = 0
    Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
End If



''------------------------------------------------------------------
''Busco el valor de la Antigüedad
''------------------------------------------------------------------
'valorAntig = 0
'If SueldoRecibo <> 0 Then
'    'Columna 42
'    If esSueldoRecibo Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           valorAntig = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   valorAntig = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
'           End If
'           'FIN MENSUALES
'
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
'        valorAntig = 0
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
'    valorAntig = 0
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1, auxdeci2, auxchar4, auxchar5, auxdeci3)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & "," & Neto
StrSql = StrSql & ",'" & Estructura & "'"
StrSql = StrSql & ",'" & fechaEstructura & "'"
StrSql = StrSql & "," & valorDiasTrab
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

'--------------------------------------------------------------------
' Se encarga de generar los datos para el Recibo CAS-23881 - Telefax - Santander URU- Recibo de Sueldos
'--------------------------------------------------------------------
Sub generarDatosRecibo176(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo As Double
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim MontoTicketBruto As Double
Dim MontoTicketNeto As Double
Dim ModeloLiq
Dim ImpIRPF
Dim ImpDescuentoIRPF

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim CodRUC As Integer
Dim CodBPS As Integer
Dim EmpMTSS As String
Dim EmpBPS As String
Dim EmpRUC As String
Dim EmpBSE As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim GrupoActividad As Double
Dim SubGrupoActividad As Double

Dim CodMTSS As Long
Dim CodBSE  As Long

Dim codCargo As Long
Dim codSector As Long

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim esConcTotal As Boolean
Dim concTotal As String
Dim valorTotal As Double

Dim Banco As String
Dim nroCuenta As String

Dim CodDocBPS As Integer
Dim EmpDocBPS As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

codCargo = 0
codSector = 0

'------------------------------------------------------------------------------'
'  Buscar la configuracion del confrep, para los Tipo de Documentos RUC y BPS  '
'------------------------------------------------------------------------------'
Flog.writeline "Obtengo los datos del confrep para los Tipo de Documentos RUC y BPS."
CodRUC = 0
CodBPS = 0

CodMTSS = 0
CodBSE = 0
CodDocBPS = 0

'RUC
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 110 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento RUC (col 110)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodRUC = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 110 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 111 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
   Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento BPS (col 111)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 111 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'MTSS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 112 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Documento MTSS (col 112)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodMTSS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 112 del confrep no es:Tipo Documento (DOC). "
    End If
End If
rsConsult.Close

'BSE
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 113 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura BSE (col 113)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodBSE = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 113 del confrep no es:Tipo DOC (DOC). "
    End If
End If
rsConsult.Close

'NUEVO DOC BPS
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 374 "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura B.P.S. (col 374)."
Else
    If rsConsult!conftipo = "DOC" Then
        CodDocBPS = rsConsult!confval
    Else
        Flog.writeline " El Tipo de Columna 374 del confrep no es:Tipo DOC (doc). "
    End If
End If
rsConsult.Close


StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol IN (2,134,228) "
OpenRecordset StrSql, rsConsult
If rsConsult.EOF Then
    Flog.writeline "No esta configurado el ConfRep para el Tipo de Estructura SECTOR Y CARGO"
Else
    Do While Not rsConsult.EOF
        Select Case rsConsult!confnrocol
            Case 2:
                If UCase(rsConsult!conftipo) = "CO" Then
                    esConcTotal = True
                    concTotal = rsConsult!confval2
                Else
                    If UCase(rsConsult!conftipo) = "AC" Then
                        esConcTotal = False
                        concTotal = rsConsult!confval
                    Else
                        Flog.writeline "La columna 2 debe ser de tipo CO o AC "
                        concTotal = 0
                    End If
                End If
            Case 134:
                If UCase(rsConsult!conftipo) = "TE" Then
                    codCargo = rsConsult!confval
                Else
                    codCargo = 0
                End If
            Case 228:
                If UCase(rsConsult!conftipo) = "TE" Then
                    codSector = rsConsult!confval
                Else
                    codSector = 0
                End If
        End Select
    rsConsult.MoveNext
    Loop
End If
rsConsult.Close
'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    cliqnro = rsConsult!cliqnro
    proFecPago = rsConsult!proFecPago
    profecini = rsConsult!profecini
    proDesc = rsConsult!proDesc
Else
    Flog.writeline "Error al obtener los datos del proceso"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Nombre = rsConsult!ternom & " " & rsConsult!ternom2
    Apellido = rsConsult!terape & " " & rsConsult!terape2
    Legajo = rsConsult!empleg
Else
    Flog.writeline "Error al obtener los datos del empleado"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'esta activa.
'------------------------------------------------------------------
StrSql = " SELECT altfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND estado = -1 ORDER BY altfec DESC" 'FB - CAS-35449
'StrSql = StrSql & " Where Empleado = " & Ternro & " And fasrecofec = -1" 'MDF
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
Else
    Flog.writeline "Error al obtener los datos del periodo actual"
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        If Not rsConsult.EOF Then
            EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor de la cedula de identidad
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro <= 5) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
StrSql = StrSql & " ORDER BY cuil.tidnro ASC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Cuil = rsConsult!NroDoc
Else
    Cuil = " "
    Flog.writeline "Error al obtener los datos del cuil"
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=10 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = empresa.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
OpenRecordset StrSql, rsConsult
Direccion = ""
Localidad = ""
If Not rsConsult.EOF Then
    'Direccion = rsConsult!calle & " " & rsConsult!nro & ", " & rsConsult!locdesc
    Direccion = rsConsult!calle & " " & rsConsult!nro
    'localidad = Direccion
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsNeto <> "" And Not IsNull(TicketsNeto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsNeto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketNeto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketNeto = 0
    End If
Else
    MontoTicketNeto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Ticket Bruto
'------------------------------------------------------------------
If TicketsBruto <> "" And Not IsNull(TicketsBruto) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & TicketsBruto & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        MontoTicketBruto = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Ticket Bruto."
        MontoTicketBruto = 0
    End If
Else
    MontoTicketBruto = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para IRPF
'------------------------------------------------------------------
If ConcImpIRPF <> "" And Not IsNull(ConcImpIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para IRPF."
        ImpIRPF = 0
    End If
Else
    ImpIRPF = 0
End If

'------------------------------------------------------------------
'Busco el valor del Monto Imponible para Descuento de IRPF
'------------------------------------------------------------------
If ConcImpDescuentoIRPF <> "" And Not IsNull(ConcImpDescuentoIRPF) Then
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & ConcImpDescuentoIRPF
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        ImpDescuentoIRPF = rsConsult!Valor
    Else
        Flog.writeline "Error al obtener el Monto Imponible para Descuento de IRPF."
        ImpDescuentoIRPF = 0
    End If
Else
    ImpDescuentoIRPF = 0
End If

'------------------------------------------------------------------
' Busco VHora definido en la columna 44 del confrep
'Se cambio -- se usa col 44 para el Sueldo.
'------------------------------------------------------------------
Sueldo = 0

If esSueldoRecibo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & SueldoRecibo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & SueldoRecibo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Sueldo = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos de de SUELDO/JORNAL. (col44)"
    Sueldo = 0
    'GoTo MError
End If
rsConsult.Close

'BUSCO EL CAMPO PESOS NETO

If esConcTotal Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro =  detliq.concnro AND concepto.conccod=  '" & concTotal & "'"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & concTotal
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    valorTotal = rsConsult!Valor
Else
    Flog.writeline " No se encontraron datos del campo pesos neto (col 2)"
    valorTotal = 0
    'GoTo MError
End If
rsConsult.Close
'HASTA ACA

'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación
'------------------------------------------------------------------
ModeloLiq = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ModeloLiq = rsConsult!tprocdesc
End If

'------------------------------------------------------------------
'Busco el valor del cargo
'------------------------------------------------------------------
Categoria = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro =" & codCargo & " And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Categoria = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
Puesto = ""

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco el valor del centro de costo, en realidad se busca el Sector del empleado
'------------------------------------------------------------------
CentroCosto = " "

StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=" & codSector & " AND his_estructura.ternro=" & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    CentroCosto = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
StrSql = " SELECT ctabnro,fpagdescabr,tercero.terrazsoc,fpagbanc, fpagbanc "
StrSql = StrSql & " From pago"
StrSql = StrSql & " INNER JOIN formapago ON formapago.fpagnro = pago.fpagnro  AND pago.pagorigen=" & cliqnro
StrSql = StrSql & " LEFT JOIN banco ON banco.ternro = pago.banternro"
StrSql = StrSql & " INNER JOIN tercero ON tercero.ternro = banco.ternro"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If rsConsult!fpagbanc = "-1" Then
        FormaPago = "Banco"
        nroCuenta = rsConsult!ctabnro
        Banco = rsConsult!terrazsoc
    Else
        FormaPago = "Efectivo"
        nroCuenta = ""
        Banco = ""
    End If
   
Else
    FormaPago = "" 'banco - efectivo
    Banco = ""
    nroCuenta = ""
    Flog.writeline "Error al obtener los datos de la forma de pago "
End If
rsConsult.Close

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
EmpEstrnro = 0
EmpNombre = " "

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura
If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If


' -------------------------------------------------------------------------
'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If
rs_cuit.Close

' -------------------------------------------------------------------------
'Consulta para obtener el BSE de la empresa
Flog.writeline "Buscando estructura BSE tipo " & CodBSE
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBSE & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BSE de la empresa"
    EmpBSE = " "
Else
    Flog.writeline "BSE = " & rs_cuit!NroDoc
    EmpBSE = rs_cuit!NroDoc
End If
rs_cuit.Close

' -------------------------------------------------------------------------
'Consulta para obtener el DOCUMENTO BPS DE LA EMPRESA 07/10/2014
Flog.writeline "Buscando doc BPS tipo " & CodDocBPS
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodDocBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el doc BPS de la empresa"
    EmpDocBPS = " "
Else
    Flog.writeline "Doc BPS = " & rs_cuit!NroDoc
    EmpDocBPS = rs_cuit!NroDoc
End If
rs_cuit.Close



' -------------------------------------------------------------------------
'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

' -------------------------------------------------------------------------
'Consulta para obtener el MTSS de la empresa
Flog.writeline "Buscando el MTSS tipo de doc " & CodMTSS
StrSql = " SELECT *"
StrSql = StrSql & " From ter_doc"
StrSql = StrSql & " Where ter_doc.ternro = " & rs_estructura!Ternro & " And ter_doc.tidnro = " & CodMTSS
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el MTSS"
    EmpMTSS = "  "
Else
    Flog.writeline "MTSS = " & rs_cuit!NroDoc
    EmpMTSS = IIf(EsNulo(rs_cuit!NroDoc), " ", rs_cuit!NroDoc)
End If
rs_cuit.Close
' -------------------------------------------------------------------------
'Consulta para obtener el BPS de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodBPS & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el BPS de la Empresa"
    EmpBPS = "  "
Else
    EmpBPS = rs_cuit!NroDoc
End If
rs_cuit.Close
' -------------------------------------------------------------------------
'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = " & CodRUC & ")"
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el RUC de la Empresa"
    EmpRUC = "  "
Else
    EmpRUC = rs_cuit!NroDoc
End If
rs_cuit.Close



'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    pliqdepant = rsConsult!periodoant
    pliqfecdep = rsConsult!Fecha
    pliqbco = rsConsult!Banco
Else
    pliqdepant = ""
    pliqfecdep = ""
    pliqbco = ""
    Flog.writeline "No se encontraron los datos de las cargas sociales"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Grupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del grupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 38)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        GrupoActividad = 0
    Else
        GrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del Grupo de actividad "
    GrupoActividad = 0
End If

'------------------------------------------------------------------
'Busco el valor del Subgrupo de actividad
'------------------------------------------------------------------
'Stankunas Cesar - 18/03/2011 - Se o modificó la query ya que traía el codigo externo de la estructura
Flog.writeline "  Busco el valor del Subgrupo de actividad "

StrSql = " SELECT nrocod FROM estr_cod"
StrSql = StrSql & " INNER JOIN tipocod ON tipocod.tcodnro = estr_cod.tcodnro"
StrSql = StrSql & " WHERE (tipocod.tcodnro = 39)"
StrSql = StrSql & " AND estrnro = " & EmpEstrnro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If IsNull(rsConsult!nrocod) Then
        SubGrupoActividad = 0
    Else
        SubGrupoActividad = rsConsult!nrocod
    End If
Else
    Flog.writeline "No se encontraron los datos del SubGrupo de actividad "
    SubGrupoActividad = 0
End If
'-----------------------------------------------------------------------------------------


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxchar4, auxchar5,"
StrSql = StrSql & " auxdeci1, auxdeci2, auxdeci3, auxdeci4, auxdeci5, auxdeci6,auxchar, auxchar6, auxchar7"
StrSql = StrSql & ")"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & numberForSQL(Sueldo)
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & ImpIRPF & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

StrSql = StrSql & ",'" & EmpMTSS & "'"
StrSql = StrSql & ",'" & EmpBPS & "'"
StrSql = StrSql & ",'" & EmpRUC & "'"
StrSql = StrSql & ",'" & EmpBSE & "'"
StrSql = StrSql & ",'" & ModeloLiq & "'"

StrSql = StrSql & "," & numberForSQL(MontoTicketNeto)
StrSql = StrSql & "," & numberForSQL(MontoTicketBruto)
StrSql = StrSql & "," & numberForSQL(GrupoActividad)
StrSql = StrSql & "," & numberForSQL(SubGrupoActividad)
StrSql = StrSql & "," & numberForSQL(ImpDescuentoIRPF)
StrSql = StrSql & "," & numberForSQL(valorTotal)
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & EmpDocBPS & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------
objConn.Execute StrSql, , adExecuteNoRecords


'Flog.Writeline "======================================================================================================================================="
'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords

    rsConsult.MoveNext

Loop

rsConsult.Close

'Flog.writeline " Se sale del procedimiento de generarDatosRecibo50. "

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo177(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'-----------------------------------------------------------------
'Recibo de Festo
'Fecha Creacion: 29-10-2014
'Autor: Fernando Favre
' Se utilizo el modelo 117 como base
'-----------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim Sueldo
Dim Categoria
Dim CentroCosto
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim empFecBaja
Dim nroCuenta As String
Dim Banco As String



Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim tprocdesc As String
Dim empest As Integer
Dim CtaNro As String
Dim CtaBanco As String
Dim EmpLocalidad As String
Dim Contrato
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim Sector

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset
Dim DescProceso
Dim empFecAltaRec

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline Espacios(Tabulador * 1) & "Modelo 177."

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
Flog.writeline "Buscando los datos del proceso"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "Datos del proceso obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empest,empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro

Flog.writeline "Buscando los datos del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   empest = rsConsult!empest
'   Flog.writeline "Datos del empleado obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del domicilio del empleado
'------------------------------------------------------------------
'StrSql = " SELECT * From cabdom "
'StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro "
'StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
'StrSql = StrSql & " WHERE domdefault =-1 and ternro= " & Ternro

'Flog.writeline "Buscando el domicilio del empleado"
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'   Direccion = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
'Else
'   Flog.writeline Espacios(Tabulador * 1) & "Error el empleado no tiene un domicilio marcado como principal"
'   Direccion = ""
''   GoTo MError
'End If


'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.*, tipoproc.tprocdesc FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro "

Flog.writeline "Buscando los datos del periodo actual"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    pliqnro = rsConsult!pliqnro
    pliqmes = rsConsult!pliqmes
    pliqanio = rsConsult!pliqanio
    pliqhasta = rsConsult!pliqhasta
    pliqdesc = rsConsult!pliqdesc
    proDesc = Mid(rsConsult!tprocdesc, 1, 12) & "    " & Format(pliqmes, "00") & "-" & Format(pliqanio, "0000")
'    Flog.writeline "Datos del periodo de liquidacion obtenidos"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período de liquidación actual."
    GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
Flog.writeline "Buscando el numero de cuil del empleado"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
'   Flog.writeline "Numero de cuil obtenido."
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil del empleado."
   Cuil = "&nbsp;"
End If

'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Sector"
OpenRecordset StrSql, rsConsult

Sector = "&nbsp;"
If Not rsConsult.EOF Then
    Sector = rsConsult!estrdabr
'    Flog.writeline "Datos del centro de costo obtenido"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del sector al cual pertenece el empleado."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del Categoria
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos de la Categoria"
OpenRecordset StrSql, rsConsult

Categoria = "&nbsp;"
If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
'   Flog.writeline "Datos de Departamento obtenidos"
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoria."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Puesto"
OpenRecordset StrSql, rsConsult

Puesto = "&nbsp;"
If Not rsConsult.EOF Then
    Puesto = rsConsult!estrdabr
'    Flog.writeline "Datos del Puesto obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el Lugar de Pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 20 And his_estructura.ternro = " & Ternro
       
Flog.writeline "Buscando los datos del Lugar de Pago"
OpenRecordset StrSql, rsConsult

FormaPago = "&nbsp;"
If Not rsConsult.EOF Then
    FormaPago = rsConsult!estrdabr
'    Flog.writeline "Datos del Puesto obtenido"
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Lugar de Pago."
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
Sueldo = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Sueldo = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Sueldo Basico. Verificar la columna 1 del confrep"
   Sueldo = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
'Flog.writeline "Buscando los datos de la cuenta del empleado."

'StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
'OpenRecordset StrSql, rsConsult

'If Not rsConsult.EOF Then
'        Banco = rsConsult!Bandesc
'        nroCuenta = rsConsult!ctabnro
''        Flog.writeline "Datos de la cuenta bancaria obtenidos"
'  Else
'        Banco = ""
'        nroCuenta = ""
'        Flog.writeline "El empleado no tiene cuentas bancarias activas"
'End If

'rsConsult.Close


'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"

Flog.writeline "Buscando los Datos de la empresa"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,detdom.codigopostal," & _
    " localidad.locdesc, provincia.provdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " LEFT JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN provincia ON detdom.provnro = provincia.provnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
    EmpLocalidad = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    EmpLocalidad = rs_Domicilio!codigopostal & " - " & rs_Domicilio!locdesc & " (" & rs_Domicilio!provdesc & ")"
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    If Not EsNulo(rs_Domicilio!codigopostal) Then
        EmpDire = EmpDire & " CP " & rs_Domicilio!codigopostal
    End If
    If Not EsNulo(rs_Domicilio!locdesc) Then
        EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    End If
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró la Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " AND fasrecofec = -1 "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    empFecAltaRec = rsConsult!altfec
Else
    Flog.writeline "Error al obtener la Fecha de Alta del Empleado de la fase marcada como Fecha Alta Reconocida"
    empFecAltaRec = ""
    'GoTo MError
End If
If empFecAltaRec = "" Then
    'El empleado no tiene fecha de alta reconocida, por lo que busco la fecha desde
    'de la primera de sus fases
    rsConsult.Close
    StrSql = " SELECT altfec FROM fases "
    StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        empFecAltaRec = rsConsult!altfec
    Else
        Flog.writeline "Error al obtener la Fecha de Alta de la primer fase del Empleado"
        empFecAltaRec = ""
        'GoTo MError
    End If
End If
rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1,auxchar2, auxchar3, auxchar4, auxchar5)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAltaRec & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(FormaPago, 1, 200) & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(Contrato, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Banco, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(nroCuenta, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Sector, 1, 100) & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close
Flog.writeline "-------------------------------------------------"
Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub


'--------------------------------------------------------------------
' Se encarga de generar los datos para San Miguel (NGA)
'--------------------------------------------------------------------
Sub generarDatosRecibo178(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdesc
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim NroDoc
Dim empFecAlta
Dim FechaInicio
Dim Sueldo
Dim Neto
Dim Categoria
Dim Sector
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim Puesto
Dim ObraSocial
Dim CabliqNumero
Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim Antiguedad
Dim CentroCosto

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
    
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim ConvenioNro As Integer
Dim Convenio As String
Dim SucursalNro As Integer
Dim CategoriaNro As Integer
Dim FormaLiqNro As Integer
Dim valorAntig

Dim Contrato
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim concPVL
Dim PromedioLicencias

Dim Banco
Dim nroCuenta

Dim acumuladorBasico As Integer
Dim conceptoBasico As String
Dim ModeloLiq As String

Dim FechaAntRec

Dim esConcSueldo As Boolean
On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del proceso."
   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del Modelo de Liquidación
'------------------------------------------------------------------
ModeloLiq = " "

StrSql = " SELECT tipoproc.tprocdesc FROM proceso"
StrSql = StrSql & " INNER JOIN tipoproc ON proceso.tprocnro = tipoproc.tprocnro"
StrSql = StrSql & " AND proceso.pronro = " & Pronro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    ModeloLiq = rsConsult!tprocdesc
End If


'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   'FB empFecAlta = rsConsult!empfaltagr
   'If IsNull(rsConsult!empremu) Then
   '   Sueldo = 0
   'Else
   '   Sueldo = rsConsult!empremu
   'End If
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del empleado."
   GoTo MError
End If

'FB 21/08/2015
'------------------------------------------------------------------
'Busco la fecha de inicio del empleado.
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!empfaltagr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la fecha de inicio del empleado."
   empFecAlta = ""
End If

'------------------------------------------------------------------
'Busco la fecha de Ingreso del empleado (Fecha de inicio de la ultima fase activa)
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro & " "
StrSql = StrSql & " AND bajfec is null"
StrSql = StrSql & " ORDER BY altfec "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    FechaInicio = rsConsult!altfec
Else
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Ingreso del Empleado"
    FechaInicio = ""
End If

'FB 21/08/2015
'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesc = rsConsult!pliqdesc
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Período actual."
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la Fecha de Alta del empleado. Corresponde a la fecha desde de la fase que
'contiene la marca de fecha de Alta Reconocida.
'------------------------------------------------------------------
'StrSql = " SELECT altfec "
'StrSql = StrSql & " FROM fases "
'StrSql = StrSql & " WHERE empleado= " & Ternro & " ORDER BY altfec "
'OpenRecordset StrSql, rsConsult
'
'If Not rsConsult.EOF Then
'    empFecAlta = rsConsult!altfec
'
'    rsConsult.MoveLast
'    FechaInicio = rsConsult!altfec
'Else
''    rsConsult.Close
''    StrSql = " SELECT altfec "
''    StrSql = StrSql & " FROM fases "
''    StrSql = StrSql & " WHERE empleado= " & ternro & " ORDER BY altfec DESC "
''    OpenRecordset StrSql, rsConsult
''    If Not rsConsult.EOF Then
''        empFecAlta = rsConsult!altfec
''    Else
'        Flog.writeline Espacios(Tabulador * 1) & "Error al obtener la Fecha de Alta del Empleado"
'        empFecAlta = ""
''    End If
'    FechaInicio = ""
'End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)

If Fecha_aux < empFecAlta Then
    Antiguedad = "Años: 0 Meses: 0"
Else
'CAS-02416 - Rotacion empresa
    Call bus_Antiguedad(Ternro, "REAL", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    
'    anios_aux = DateDiff("yyyy", empFecAlta, Fecha_aux)
'    If Month(empFecAlta) > Month(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        anios_aux = anios_aux - 1
'    End If
'    meses_aux = DateDiff("m", empFecAlta, Fecha_aux) - (anios_aux * 12)
'    If Day(empFecAlta) > Day(Fecha_aux) Or (Month(empFecAlta) = Month(Fecha_aux) And Day(empFecAlta) > Day(Fecha_aux)) Then
'        meses_aux = meses_aux - 1
'    End If
    Antiguedad = "Años: " & anios_aux & " Meses: " & meses_aux
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------
If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------
If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, cuil.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = cuil.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Cuil."
   Cuil = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del nro documento
'------------------------------------------------------------------
StrSql = " SELECT tipodocu.tidsigla, ter_doc.nrodoc "
StrSql = StrSql & " FROM tercero INNER JOIN ter_doc ON (tercero.ternro=ter_doc.ternro and ter_doc.tidnro<=5) "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   NroDoc = rsConsult!tidsigla & "-" & rsConsult!NroDoc
Else
   Flog.writeline Espacios(Tabulador * 1) & "No se encontraron los datos del Nro documento."
   NroDoc = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   CategoriaNro = rsConsult!Estrnro
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría."
   Categoria = "&nbsp;"
   CategoriaNro = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Centro de Costo
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 5 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Centro Costo."
   CentroCosto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Puesto
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Puesto."
   Puesto = "&nbsp;"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   ObraSocial = "&nbsp;"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el contrato
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
Else
   Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Obra Social."
   Contrato = ""
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el domicilio de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT his_estructura.estrnro,detdom.calle,detdom.nro,localidad.locdesc "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 1 And his_estructura.ternro = " & Ternro
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro = estructura.estrnro "
StrSql = StrSql & " LEFT JOIN cabdom ON cabdom.ternro = sucursal.ternro AND cabdom.tidonro = 5 "
StrSql = StrSql & " LEFT JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " LEFT JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    'localidad = rsConsult!calle & " " & rsConsult!nro & " - " & rsConsult!locdesc
    SucursalNro = rsConsult!Estrnro
Else
    'localidad = "&nbsp;"
    SucursalNro = 0
    Flog.writeline Espacios(Tabulador * 1) & "Error al obtener el Domicilio de la sucursal del empleado."
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------
StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Localidad = rsConsult!estrdabr
   Flog.writeline "    los datos de la localidad OK"
Else
   Localidad = ""
   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
rsConsult.Close

'HASTA ACA


'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Sueldo = 0
'If Tickets <> 0 Then
'    'Columna 42
'    If esTicketsConc Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Tickets & " AND novemp.tpanro = 1"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           Sueldo = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Tickets & ") y parámetro 1."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & Ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 1"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   Sueldo = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 1."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor del Básico. La columna 43 del confrep debe ser un concepto, de tipo 'CO'."
'           End If
'           'FIN MENSUALES
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor del Básico. La columna 42 del confrep debe ser un concepto, de tipo 'CO'."
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor del Básico. No esta configurado el concepto en la columna 42 del confrep."
'End If
    
    
'If Sueldo = 0 Then
'    'Buscar en la escala de Básicos
'
'    'Determinar la sucursal del empleado. Ya la tengo
'    If SucursalNro = 0 Then
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Sucursal para determinar la escala del Básico."
'    End If
'
'    'Determinar el Convenio del empleado.
'    StrSql = " SELECT his_estructura.estrnro, estrdabr "
'    StrSql = StrSql & " From his_estructura"
'    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       ConvenioNro = rsConsult!Estrnro
'       Convenio = rsConsult!estrdabr
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
'       ConvenioNro = 0
'       Convenio = ""
'    '   GoTo MError
'    End If
'
'    'Determinar la categoria del empleado. Ya la tengo
'    If CategoriaNro = 0 Then
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Categoría para determinar la escala del Básico."
'    End If
'
'    'Determinar la Forma de Liquidacion
'    StrSql = " SELECT his_estructura.estrnro "
'    StrSql = StrSql & " From his_estructura"
'    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
'    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 22 And his_estructura.ternro = " & Ternro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       FormaLiqNro = rsConsult!Estrnro
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la Forma de Liquidación para determinar la escala del Básico."
'       FormaLiqNro = 0
'    '   GoTo MError
'    End If
'
'    StrSql = " SELECT vgrvalor FROM valgrilla "
'    StrSql = StrSql & " WHERE cgrnro = 4 "
'    StrSql = StrSql & " AND vgrcoor_1 = " & SucursalNro
'    StrSql = StrSql & " AND vgrcoor_2 = " & ConvenioNro
'    StrSql = StrSql & " AND vgrcoor_3 = " & CategoriaNro
'    StrSql = StrSql & " AND vgrcoor_4 = " & FormaLiqNro
'    OpenRecordset StrSql, rsConsult
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!vgrvalor
'    Else
'       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos de la escala del Básico. No se encontro. SQL --> " & StrSql
'    End If
'
'End If

'If Sueldo = 0 And acumHaberesConAp <> 0 Then
'    'Columna 60
'    StrSql = " SELECT almonto valor"
'    StrSql = StrSql & " From acu_liq"
'    StrSql = StrSql & " Where acunro = " & acumHaberesConAp
'    StrSql = StrSql & " AND cliqnro = " & cliqnro
'    OpenRecordset StrSql, rsConsult
'
'    If Not rsConsult.EOF Then
'       Sueldo = rsConsult!Valor
'       Flog.writeline Espacios(Tabulador * 1) & "---> El valor del Básico se obtuvo del acumulador " & acumHaberesConAp
'    End If
'End If

    'Determinar el Convenio del empleado.
    StrSql = " SELECT his_estructura.estrnro, estrdabr "
    StrSql = StrSql & " From his_estructura"
    StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
    StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 19 And his_estructura.ternro = " & Ternro
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       ConvenioNro = rsConsult!Estrnro
       Convenio = rsConsult!estrdabr
    Else
       Flog.writeline Espacios(Tabulador * 1) & "Error al obtener los datos del Convenio para determinar la escala del Básico."
       ConvenioNro = 0
       Convenio = ""
    '   GoTo MError
    End If



'------------------------------------------------------------------
'Busco el campo Básico
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60"
StrSql = StrSql & " AND confnrocol=375"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If UCase(rsConsult!conftipo) = "CO" Then
        esConcSueldo = True
        conceptoBasico = IIf(EsNulo(rsConsult!confval2), 0, rsConsult!confval2)
    Else
        If UCase(rsConsult!conftipo) = "AC" Then
            esConcSueldo = False
            acumuladorBasico = IIf(EsNulo(rsConsult!confval), 0, rsConsult!confval)
        Else
            Flog.writeline "La columna 375 del confrep se encuentra mal configurada, debe ser tipo CO o AC "
            esConcSueldo = True
            conceptoBasico = 0
        End If
    End If
Else
    Flog.writeline "La columna 375 del confrep no se configuro "
    esConcSueldo = True
    conceptoBasico = 0
End If
rsConsult.Close
Sueldo = 0

If esConcSueldo Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = " & conceptoBasico
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acumuladorBasico
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   Sueldo = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
Else
   Flog.writeline "Error al obtener los datos del Neto a ensobrar. Se debe configurar en la columna 1 del confrep."
   Sueldo = 0
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de Básico
'------------------------------------------------------------------
Neto = 0
If esSueldoConc Then
    StrSql = " SELECT detliq.dlimonto valor "
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And detliq.concnro = " & acunroSueldo
Else
    StrSql = " SELECT almonto valor"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Neto = rsConsult!Valor
Else
   Flog.writeline "Error al obtener los datos del Neto a ensobrar. Se debe configurar en la columna 1 del confrep."
   Neto = 0
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la Antigüedad
'------------------------------------------------------------------
valorAntig = 0
If SueldoRecibo <> 0 Then
    'Columna 44
    If esSueldoRecibo Then
        StrSql = " SELECT dlimonto valor "
        StrSql = StrSql & " FROM detliq "
        StrSql = StrSql & " WHERE concnro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    Else
        StrSql = " SELECT almonto valor "
        StrSql = StrSql & " FROM acu_liq "
        StrSql = StrSql & " WHERE acunro = " & SueldoRecibo & " AND cliqnro = " & cliqnro
    End If
    
    OpenRecordset StrSql, rsConsult
        
    If Not rsConsult.EOF Then
        valorAntig = rsConsult!Valor
        Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo del concepto (concnro=" & SueldoRecibo & ") liquidado en el período."
    Else
        Flog.writeline "Error al obtener el valor de la Antigüedad. El concepto (concnro=" & SueldoRecibo & ") NO esta liquidado."
    End If
    
Else
    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
    valorAntig = 0
End If

''------------------------------------------------------------------
''Busco el valor de la Antigüedad
''------------------------------------------------------------------
'valorAntig = 0
'If SueldoRecibo <> 0 Then
'    'Columna 42
'    If esSueldoRecibo Then
'        StrSql = " SELECT novemp.nevalor valor "
'        StrSql = StrSql & " FROM novemp "
'        StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & SueldoRecibo & " AND novemp.tpanro = 35"
'        OpenRecordset StrSql, rsConsult
'
'        If Not rsConsult.EOF Then
'           valorAntig = rsConsult!Valor
'           Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & SueldoRecibo & ") y parámetro 35."
'        Else
'           'MENSUALES
'           If esGratificacionConc Then
'                StrSql = " SELECT novemp.nevalor valor "
'                StrSql = StrSql & " FROM novemp "
'                StrSql = StrSql & " WHERE novemp.empleado = " & ternro & " And novemp.concnro = " & Gratificacion & " AND novemp.tpanro = 35"
'                OpenRecordset StrSql, rsConsult
'
'                If Not rsConsult.EOF Then
'                   valorAntig = rsConsult!Valor
'                   Flog.writeline Espacios(Tabulador * 1) & "---> El valor de la Antigüedad se obtuvo de la novedad para el concepto (concnro=" & Gratificacion & ") y parámetro 35."
'                End If
'           Else
'                Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 43 del confrep debe ser un concepto."
'           End If
'           'FIN MENSUALES
'
'        End If
'
'    Else
'        Flog.writeline "Error al obtener el valor de la Antigüedad. La columna 44 del confrep debe ser un concepto, de tipo 'CO'."
'        valorAntig = 0
'    End If
'
'Else
'    Flog.writeline "Error al obtener el valor de la Antigüedad. No esta configurado el concepto en la columna 44 del confrep."
'    valorAntig = 0
'End If

'-------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------
StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la Empresa."
    EmpNombre = "&nbsp;"
    GoTo MError
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,detdom.codigopostal,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el Domicilio de la Empresa."
    'Exit Sub
    EmpDire = "&nbsp;"
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & "(" & rs_Domicilio!codigopostal & ") " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa."
    'Exit Sub
    EmpCuit = "&nbsp;"
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa."
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = "&nbsp;"
   pliqfecdep = "&nbsp;"
   pliqbco = "&nbsp;"
   Flog.writeline "No se encontraron los datos de las Cargas Sociales."
'   GoTo MError
End If

rsConsult.Close


'------------------------------------------------------------------
'promedio licencias variables
'------------------------------------------------------------------
concPVL = ""
PromedioLicencias = "0"
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro = 60 AND confnrocol = 59 AND conftipo = 'PVL'"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If Not IsNull(rsConsult("confval2")) Then
        concPVL = rsConsult("confval2")
    End If
End If
rsConsult.Close

If Len(concPVL) <> 0 Then
    StrSql = " SELECT detliq.dlimonto "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.conccod = '" & concPVL & "'"
    
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        If Not IsNull(rsConsult("dlimonto")) Then
            PromedioLicencias = rsConsult("dlimonto")
        End If
    End If
    rsConsult.Close
End If
    
    
    
'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabnro) Then
       Banco = rsConsult!Bandesc
       nroCuenta = "Cta. Nro. " & rsConsult!ctabnro
   Else
       If Not EsNulo(rsConsult!ctabcbu) Then
            Banco = rsConsult!Bandesc
            nroCuenta = "CBU " & rsConsult!ctabnro
       Else
            Banco = ""
            nroCuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    nroCuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If
    
'------------------------------------------------------------------
'Busco la Fecha Antig Rec
'------------------------------------------------------------------
StrSql = " SELECT fecvtodoc"
StrSql = StrSql & " From ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro "
StrSql = StrSql & " WHERE ter_doc.ternro= " & Ternro
StrSql = StrSql & " AND tipodocu.tidnro = 39"

OpenRecordset StrSql, rsConsult

FechaAntRec = ""

If Not rsConsult.EOF Then
    FechaAntRec = rsConsult!fecvtodoc
End If
    

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------
StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,profecpago,empnombre,"
StrSql = StrSql & " empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,"
StrSql = StrSql & " auxchar1, auxchar2, auxchar3, auxdeci1, auxdeci2, auxchar4, auxchar5, auxdeci3, auxchar6, auxchar7, auxchar8)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & FechaInicio & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FechaAntRec & "'" 'FechaAntigRec va en el campo Formapago
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Mid(Puesto, 1, 60) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & "," & valorAntig
StrSql = StrSql & "," & Neto
StrSql = StrSql & ",'" & Convenio & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & PromedioLicencias
StrSql = StrSql & ",'" & Banco & " " & nroCuenta & "'"
StrSql = StrSql & ",'" & Contrato & "'"
StrSql = StrSql & ",'" & ModeloLiq & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:

    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo179(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
'--------------------------------------------------------------------
' Boleta de Pago - Perú - IMECON
'--------------------------------------------------------------------
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim NroDoc

'Fechas de fases
Dim empFecAlta
Dim empFecBaja
'---------------

Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim pliqdesde
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer

'Auxchar
Dim Estructuracargo As String
Dim EstructuraAFP As String

'Dim Ubicacion As String
'-----
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
 
'Auxdeci
Dim HrsTrabajadas
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
'Dim ObraSocial
Dim CarnetAFP

Dim EstructuraUbicacion
Dim EstructuraSede
Dim EstructuraCCosto
Dim EstructuraArea

Dim periodo_vac_desde As String
Dim periodo_vac_hasta As String

Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim valorSueldo As Double
Dim codSueldo As String
Dim codAfp As Long
Dim TipoDocRegPat
Dim RegPat
Dim Doc113
Dim TipoDoc113
Dim canthoras
Dim esconcepto
Dim AporteEmp
Dim AporteEmpDesc
Dim NroConcepto
Dim EmpTernro

Dim usaPagoDto As Boolean
Dim usadiasseparados As Boolean
Dim licVac As Integer
Dim CantDiasVac
Dim codConcVac

codSueldo = "0"

Dim moneda As String


On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

Flog.writeline "Modelo 179"

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL VALOR DE CARNET AFP
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 243"
StrSql = StrSql & " AND conftipo = 'DOC' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    codAfp = rsConsult!confval
Else
    codAfp = 0
    Flog.writeline " No se configuro la columna 243 como tipo de DOC, es necesaria para obtener el carnet afp "
End If
rsConsult.Close

'------------------------------------------------------------------
'LEVANTO DEL CONFREP LOS VALORES DEL CONCEPTO SUELDO
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 242"
StrSql = StrSql & " AND conftipo = 'CO' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Do While Not rsConsult.EOF
        codSueldo = codSueldo & ", " & rsConsult!confval2
    rsConsult.MoveNext
    Loop
Else
    Flog.writeline " No se configuro la columna 242 como tipo de concepto, es necesaria para obtener el suedo "
End If
rsConsult.Close

'------------------------------------------------------------------
'LEVANTO DEL CONFREP LOS VALORES PARA SABER SI USA concepto para vacaciones
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 390"
StrSql = StrSql & " AND upper(conftipo) = 'VAC' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
      codConcVac = IIf(EsNulo(rsConsult!confval2), 0, rsConsult!confval2)
        Flog.writeline "Concepto vacaciones.: " & codConcVac
Else
      codConcVac = 0
        Flog.writeline "Concepto vacaciones.: " & codConcVac
End If
rsConsult.Close



'------------------------------------------------------------------
'LEVANTO DEL CONFREP LOS VALORES PARA SABER SI USA PAGO/DTO
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 390"
StrSql = StrSql & " AND upper(conftipo) = 'LIC' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!confval = 1 Then
        usaPagoDto = True
        Flog.writeline "Usa pago/dto."
    Else
        usaPagoDto = False
        licVac = IIf(EsNulo(rsConsult!confval2), 0, rsConsult!confval2)
        Flog.writeline "No usa pago/dto, usa licencia de vacaciones. Tipo configurado: " & licVac
        
    End If
Else
    Flog.writeline " No se configuro la columna 242 como tipo de concepto, es necesaria para obtener el suedo "
End If
rsConsult.Close

'------------------------------------------------------------------
'Obtengo el nro de cabecera de liquidación y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   pliqdesde = rsConsult!pliqdesde
   proDesc = proDesc & " - " & rsConsult!pliqdesde & " - " & pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & IIf(EsNulo(rsConsult!ternom2), "", rsConsult!ternom2)
   Apellido = rsConsult!terape & " " & IIf(EsNulo(rsConsult!terape2), "", rsConsult!terape2)
   Legajo = rsConsult!empleg
   'empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la fecha de Alta y Baja de la última fase Activa
'------------------------------------------------------------------
StrSql = "SELECT empleado,altfec,bajfec FROM fases "
StrSql = StrSql & " WHERE empleado= " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   empFecBaja = IIf(EsNulo(rsConsult!bajfec), "", rsConsult!bajfec)
   
   '********************************
   'FALTA AGREGAR AL INSERT (BAJFEC)
   '********************************
Else
   Flog.writeline "No existe fase para el empleado ternro:" & Ternro
   GoTo MError
End If
rsConsult.Close


'------------------------------------------------------------------
'Busco la estructura "CARGO" desde el confrep | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=117)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   Estructuracargo = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se pudo obtener los datos de cargo. Revisar configuración de Columna 117 del confrep"
   'GoTo MError
End If
rsConsult.Close
 
'------------------------------------------------------------------
'Busco la estructura "Tipo de trabajador" desde el confrep | COLUMNA FIJA 376 (Tipo de trabajador)
'------------------------------------------------------------------
EstructuraTipotrabajador = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=376)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   EstructuraTipotrabajador = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se pudo obtener los datos de la estructura Tipo de trabajador. Revisar configuración de Columna 376 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "Tipo de trabajador" desde el confrep | COLUMNA FIJA 377 (Ocupación)
'------------------------------------------------------------------
EstructuraOcupacion = ""
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=377)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   EstructuraOcupacion = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se pudo obtener los datos de la estructura Ocupación. Revisar configuración de Columna 377 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "AFP" desde el confrep | COLUMNA FIJA 118 (AFP)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=118)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
   'Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
   EstructuraAFP = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
   Flog.writeline "No se pudo obtener los datos de AFP. Revisar configuración de Columna 118 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'BUSCO EL VALOR DEL CAMPO SUELDO DEL RECIBO
'------------------------------------------------------------------
If codSueldo <> "0" Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod IN (" & codSueldo & ")"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       valorSueldo = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
    Else
       Flog.writeline "Error al obtener el valor del campo sueldo."
       valorSueldo = 0
    End If
    rsConsult.Close
Else
    valorSueldo = 0
End If
 

'------------------------------------------------------------------
'Busco el valor de los días trabajados | COLUMNA 49
'------------------------------------------------------------------
If ConcDiasTrabajados <> "" And Not IsNull(ConcDiasTrabajados) Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod = '" & ConcDiasTrabajados & "'"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
       DiasTrabajados = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
    Else
       Flog.writeline "Error al obtener los dias trabajados."
       DiasTrabajados = 0
    End If
    rsConsult.Close
Else
    DiasTrabajados = 0
End If
 
'------------------------------------------------------------------
'Busco el valor de la cantidad de horas | COLUMNA 90
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND confnrocol = 90 "
Flog.writeline "Horas Trabajadas" & StrSql
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    If rsConsult!conftipo = "CO" Then
        canthoras = rsConsult!confval
        esconcepto = True
    Else
        canthoras = rsConsult!confval2
        esconcepto = False
    End If
End If
rsConsult.Close

If esconcepto Then
    StrSql = "SELECT detliq.dlimonto valor"
    StrSql = StrSql & " FROM detliq "
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
    StrSql = StrSql & " AND concepto.conccod = " & canthoras
Else
     StrSql = " SELECT almonto valor"
     StrSql = StrSql & " From acu_liq"
     StrSql = StrSql & " Where acunro = " & canthoras
     StrSql = StrSql & " AND cliqnro = " & cliqnro
End If
OpenRecordset StrSql, rsConsult
Flog.writeline "Horas Trabajadas" & StrSql
If Not rsConsult.EOF Then
    HrsTrabajadas = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
Else
    HrsTrabajadas = 0
 End If
rsConsult.Close

FormaPago = ""

'---------------------sebastian stremel 05/04/2013-----------------

'------------------------------------------------------------------
'Busco la estructura "UBICACION" desde el confrep | COLUMNA FIJA 300 (UBICACION)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=300)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    EstructuraUbicacion = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    EstructuraUbicacion = ""
    Flog.writeline "No se pudo obtener los datos de ubicacion. Revisar configuración de Columna 300 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "SEDE" desde el confrep | COLUMNA FIJA 301 (SEDE)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=301)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraSede = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    EstructuraSede = ""
    Flog.writeline "No se pudo obtener los datos de sede. Revisar configuración de Columna 301 del confrep"
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "CENTRO DE COSTO" desde el confrep | COLUMNA FIJA 302 (C.COSTO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=302)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraCCosto = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    EstructuraCCosto = ""
    Flog.writeline "No se pudo obtener los datos de centro de costo. Revisar configuración de Columna 302 del confrep"
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco la estructura "AREA" desde el confrep | COLUMNA FIJA 303 (AREA)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr,estrcodext "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=303)  And his_estructura.Ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    EstructuraArea = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    EstructuraArea = ""
    Flog.writeline "No se pudo obtener los datos del area. Revisar configuración de Columna 303 del confrep"
End If
rsConsult.Close

'-----------------------HASTA ACA---------------------------------

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = IIf(EsNulo(rsConsult!Estrnro), "", rsConsult!Estrnro)
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = IIf(EsNulo(rsConsult!Estrnro), "", rsConsult!Estrnro)
        End If
        rsConsult.Close
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = IIf(EsNulo(rsConsult!Estrnro), "", rsConsult!Estrnro)
        End If
        rsConsult.Close
    End If
End If

'------------------------------------------------------------------
'Busco Tipo de documento 1 ó 3
'------------------------------------------------------------------
StrSql = "SELECT doc.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc doc ON tercero.ternro = doc.ternro "
StrSql = StrSql & " INNER JOIN tipodocu_pais td ON td.tidnro = doc.tidnro  and td.tidcod <= 5 "
StrSql = StrSql & " WHERE tercero.ternro =" & Ternro
StrSql = StrSql & " ORDER BY tidcod ASC "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    NroDoc = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco Tipo de documento tipo 7 | CARNET AFP
'------------------------------------------------------------------
StrSql = " SELECT ter_doc.ternro,ter_doc.tidnro, ter_doc.nrodoc FROM tercero"
StrSql = StrSql & " LEFT JOIN ter_doc ON tercero.ternro=ter_doc.ternro"
StrSql = StrSql & " WHERE Tercero.Ternro = " & Ternro
StrSql = StrSql & " AND ter_doc.tidnro=" & codAfp
StrSql = StrSql & " ORDER BY tidnro ASC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    CarnetAFP = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
    CarnetAFP = ""
    Flog.writeline "Error al obtener los datos del Documento para el Legajo: " & Legajo
   'GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad de la sucursal
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
    Direccion = IIf(EsNulo(rsConsult!calle), "", rsConsult!calle) & " - " & IIf(EsNulo(rsConsult!nro), "", rsConsult!nro)
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & IIf(EsNulo(rsConsult!Piso), "", rsConsult!Piso)
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & IIf(EsNulo(rsConsult!oficdepto), "", rsConsult!oficdepto)
    End If
    
    Direccion = Direccion & ", " & IIf(EsNulo(rsConsult!locdesc), "", rsConsult!locdesc)
   
    Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

' ahora si tiene valor ==> lo recalcula sino deja el empremu
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = IIf(EsNulo(rsConsult!almonto), 0, rsConsult!almonto)
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
    rsConsult.Close
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto SALE DE LA COLUMNA 2 DEL CONFREP
'------------------------------------------------------------------
'Busco la configuracion del confrep
Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = IIf(EsNulo(rsConsult!almonto), 0, rsConsult!almonto)
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
    rsConsult.Close
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------
Categoria = ""

'------------------------------------------------------------------
'Busco el valor del puesto | COLUMNA FIJA 117 (CARGO)
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

Puesto = ""
If Not rsConsult.EOF Then
   Puesto = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
'   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el valor del centro de costo
''------------------------------------------------------------------
CentroCosto = ""
  
'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------
Banco = ""
nroCuenta = ""

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    If Not EsNulo(rsConsult!ctabnro) Then
       Banco = rsConsult!Bandesc
       nroCuenta = rsConsult!ctabnro
    End If
Else
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = IIf(EsNulo(rs_estructura!empnom), "", rs_estructura!empnom)
    EmpEstrnro = IIf(EsNulo(rs_estructura!Estrnro), "", rs_estructura!Estrnro)
    EmpTernro = IIf(EsNulo(rs_estructura!Ternro), 0, rs_estructura!Ternro)
End If
'rs_estructura.Close

StrSql = " SELECT * FROM ter_imag "
StrSql = StrSql & " INNER JOIN tipoimag ON tipoimag.tipimnro=ter_imag.tipimnro "
StrSql = StrSql & " WHERE ternro =" & rs_estructura!Ternro
StrSql = StrSql & " AND ter_imag.tipimnro=1"
OpenRecordset StrSql, rs_Domicilio
If Not rs_Domicilio.EOF Then
    EmpLogo = IIf(EsNulo(rs_Domicilio!tipimdire), "", rs_Domicilio!tipimdire) & IIf(EsNulo(rs_Domicilio!terimnombre), "", rs_Domicilio!terimnombre)
    EmpLogoAncho = IIf(EsNulo(rs_Domicilio!tipimanchodef), 0, rs_Domicilio!tipimanchodef)
    EmpLogoAlto = IIf(EsNulo(rs_Domicilio!tipimaltodef), 0, rs_Domicilio!tipimaltodef)
    Flog.writeline "Se encontro el logo de la empresa: " & EmpLogo
Else
    EmpLogo = ""
    EmpLogoAncho = 0
    EmpLogoAlto = 0
    Flog.writeline "No se encontro el logo de la empresa"
End If
rs_Domicilio.Close

'Consulta para obtener la direccion de la empresa
'Direccion + Numero + Piso + Mza + Lote + Nombre de zona + Distrito
' se cambia el formato de la direccion de la empresa
'Via + Direccion + Numero + Piso + Mza + Lote + Block + Nombre de zona + Distrito + Departamento + Provincia
StrSql = "SELECT via.viadesc, detdom.calle, detdom.nro , detdom.piso,  detdom.manzana, detdom.lote " & _
    " ,detdom.bloque,   detdom.auxchr4, localidad.locdesc, provincia.provdesc,partido.partnom  From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.domdefault = -1 AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN partido ON detdom.partnro = partido.partnro " & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro " & _
    " LEFT JOIN via ON detdom.vianro = via.vianro " & _
    " LEFT JOIN provincia ON detdom.provnro = provincia.provnro "
 Flog.writeline "domicilio empresa: " & StrSql
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    EmpDire = "   "
Else
    If Not EsNulo(rs_Domicilio!viadesc) Then
        EmpDire = rs_Domicilio!viadesc
    Else
        EmpDire = ""
    End If

    EmpDire = EmpDire & "@" & IIf(EsNulo(rs_Domicilio!calle), "", rs_Domicilio!calle) & "@" & IIf(EsNulo(rs_Domicilio!nro), "", rs_Domicilio!nro)
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!Piso
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!manzana) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!manzana
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!lote) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!lote
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
     If Not EsNulo(rs_Domicilio!bloque) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!bloque
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!auxchr4) Then
        EmpDire = EmpDire & "@" & rs_Domicilio!auxchr4
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!locdesc) Then
       EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!provdesc) Then
       EmpDire = EmpDire & "@" & rs_Domicilio!provdesc
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    If Not EsNulo(rs_Domicilio!partnom) Then
       EmpDire = EmpDire & "@" & rs_Domicilio!partnom
    Else
        EmpDire = EmpDire & "@" & ""
    End If
    
    'Sebastian Stremel 19/07/2012
    'If Not EsNulo(rs_Domicilio!torre) Then
    '    EmpDire = EmpDire & "@" & rs_Domicilio!torre
    'Else
    '    EmpDire = EmpDire & "@" & ""
    'End If
    
    'If Not EsNulo(rs_Domicilio!barrio) Then
    '    EmpDire = EmpDire & "@" & rs_Domicilio!barrio
    'Else
    '    EmpDire = EmpDire & "@" & ""
    'End If
    
    'If Not EsNulo(rs_Domicilio!locdesc) Then
    '    EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
    'Else
    '    EmpDire = EmpDire & "@" & ""
    'End If
    
    'hasta aca
    'EmpDire = EmpDire & "@" & rs_Domicilio!locdesc
End If
rs_Domicilio.Close

'Consulta para obtener el RUC de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero "
StrSql = StrSql & " INNER JOIN ter_doc cuit ON tercero.ternro = cuit.ternro "
StrSql = StrSql & " INNER JOIN tipodocu_pais td ON td.tidnro = cuit.tidnro  and td.tidcod = 6 "
StrSql = StrSql & " WHERE tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el tipo de documento RUC de la Empresa"
    EmpCuit = ""
Else
    EmpCuit = IIf(EsNulo(rs_cuit!NroDoc), "", rs_cuit!NroDoc)
End If
rs_cuit.Close

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa."
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = IIf(EsNulo(rs_firma!tipimdire), "", rs_firma!tipimdire) & IIf(EsNulo(rs_firma!terimnombre), "", rs_firma!terimnombre)
    EmpFirmaAlto = IIf(EsNulo(rs_firma!tipimaltodef), "", rs_firma!tipimaltodef)
    EmpFirmaAncho = IIf(EsNulo(rs_firma!tipimanchodef), "", rs_firma!tipimanchodef)
End If
Flog.writeline "Cierro Firma"
rs_estructura.Close
rs_firma.Close

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""

'________________________________________________________________
'BUSCO EL PERIODO VACACIONAL
If usaPagoDto Then
    StrSql = " SELECT min(elfechadesde) desde, max(elfechahasta) hasta  FROM emp_lic "
    StrSql = StrSql & " INNER JOIN vacpagdesc ON vacpagdesc.emp_licnro = emp_lic.emp_licnro "
    StrSql = StrSql & " WHERE Empleado =" & Ternro & " And tdnro = 2 And pliqnro = " & pliqnro
    StrSql = StrSql & " AND vacpagdesc.pronro =" & Pronro
    StrSql = StrSql & " AND pago_dto in(1,3)" '1 y 3 son los codigos de pago
    OpenRecordset StrSql, rs_cuit
    If Not rs_cuit.EOF Then
        Flog.writeline "Se encontro el periodo vacacional"
        periodo_vac_desde = IIf(EsNulo(rs_cuit!Desde), "", rs_cuit!Desde)
        periodo_vac_hasta = IIf(EsNulo(rs_cuit!Hasta), "", rs_cuit!Hasta)
    Else
        Flog.writeline "No se encontro el periodo vacacional, query: " & StrSql
        periodo_vac_desde = ""
        periodo_vac_hasta = ""
    End If
    Flog.writeline "Cierro Periodo Vacacional"
    rs_cuit.Close
Else
  StrSql = " SELECT min(elfechadesde) desde, max(elfechahasta) hasta ,SUM(elcantdias) dias"
    StrSql = StrSql & " FROM emp_lic "
    StrSql = StrSql & " WHERE Empleado = " & Ternro
    StrSql = StrSql & " AND tdnro = " & licVac
    StrSql = StrSql & " AND pronro = " & Pronro
    'StrSql = StrSql & " WHERE ("
    'StrSql = StrSql & " (elfechadesde <= " & ConvFecha(pliqdesde) & " AND (elfechahasta is null or elfechahasta >= " & ConvFecha(pliqhasta)
    'StrSql = StrSql & " or elfechahasta >= " & ConvFecha(pliqdesde) & " )) OR"
    'StrSql = StrSql & " (elfechadesde >= " & ConvFecha(pliqdesde) & " AND (elfechadesde <= " & ConvFecha(pliqhasta) & "))"
    'StrSql = StrSql & " )"
    OpenRecordset StrSql, rs_cuit
    If Not rs_cuit.EOF Then
        Flog.writeline "Se encontro el periodo vacacional"
        periodo_vac_desde = IIf(EsNulo(rs_cuit!Desde), "", rs_cuit!Desde)
        periodo_vac_hasta = IIf(EsNulo(rs_cuit!Hasta), "", rs_cuit!Hasta)
        
    Else
        Flog.writeline "No se encontro el periodo vacacional, query: " & StrSql
        periodo_vac_desde = ""
        periodo_vac_hasta = ""
    End If
    rs_cuit.Close
End If


'------------------------------------------------------------------
'BUSCO EL VALOR DEL Concepto de vacaciones
'------------------------------------------------------------------
If codConcVac <> "0" Then
    StrSql = " SELECT detliq.dlimonto valor FROM detliq"
    StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro"
    StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro & " And concepto.conccod IN (" & codConcVac & ")"
    OpenRecordset StrSql, rsConsult
    If Not rsConsult.EOF Then
        
       CantDiasVac = IIf(EsNulo(rsConsult!Valor), 0, rsConsult!Valor)
       periodo_vac_desde = pliqdesde
       periodo_vac_hasta = DateAdd("d", CantDiasVac, periodo_vac_desde)
       periodo_vac_hasta = DateAdd("d", -1, periodo_vac_hasta)
    
       Flog.writeline "periodo vacacional desde: " & periodo_vac_desde
       Flog.writeline "periodo vacacional hasta: " & periodo_vac_hasta
    End If
    rsConsult.Close
End If
 

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL TIPO DOCUMENTO REG. PAT.
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo = 'REG' "
OpenRecordset StrSql, rsConsult
Flog.writeline " REG: PAT. " & StrSql
If Not rsConsult.EOF Then
    TipoDocRegPat = rsConsult!confval
Else
    TipoDocRegPat = 0
    Flog.writeline " No se configuro el tipo de DOC Reg Pat"
End If
rsConsult.Close

'Busco el Tipo de Documento REG. PAT
StrSql = " SELECT tidnom, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & EmpTernro
StrSql = StrSql & " AND ter_doc.tidnro=" & TipoDocRegPat
OpenRecordset StrSql, rsConsult
Flog.writeline " REG: PAT. " & StrSql
If Not rsConsult.EOF Then
    RegPat = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
    RegPat = 0
End If

'------------------------------------------------------------------
'LEVANTO DEL CONFREP EL TIPO DOCUMENTO 113
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo = 'SUP' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    TipoDoc113 = rsConsult!confval
Else
    TipoDoc113 = 0
    Flog.writeline " No se configuro el tipo de DOC 113"
End If
rsConsult.Close

'Busco el Tipo de Documento 113
StrSql = " SELECT tidnom, nrodoc FROM ter_doc "
StrSql = StrSql & " INNER JOIN tipodocu ON tipodocu.tidnro = ter_doc.tidnro"
StrSql = StrSql & " WHERE ternro=" & EmpTernro
StrSql = StrSql & " AND ter_doc.tidnro=" & TipoDoc113
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    Doc113 = IIf(EsNulo(rsConsult!NroDoc), "", rsConsult!NroDoc)
Else
    Doc113 = 0
End If

'------------------------------------------------------------------
'Busco el valor de los Aportes del Empleador
'------------------------------------------------------------------
StrSql = " SELECT * FROM confrep "
StrSql = StrSql & " WHERE repnro=60 "
StrSql = StrSql & " AND conftipo= 'EMP' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
        NroConcepto = rsConsult!confval
Else
    NroConcepto = 0
End If
rsConsult.Close

StrSql = "SELECT detliq.dlimonto valor, concabr"
StrSql = StrSql & " FROM detliq "
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro "
StrSql = StrSql & " WHERE detliq.cliqnro = " & cliqnro
StrSql = StrSql & " AND concepto.conccod = " & NroConcepto
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    AporteEmp = Replace(rsConsult!Valor, ",", ".")
    AporteEmpDesc = rsConsult!concabr
Else
    AporteEmp = 0
    AporteEmpDesc = ""
End If
rsConsult.Close
'________________________________________________________________

'_____________________Busco la estructura moneda_________________
StrSql = " SELECT estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " INNER JOIN confrep c ON c.confval = his_estructura.tenro and c.repnro=60 and c.confnrocol=397 and c.conftipo='TE' "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = c.confval And his_estructura.ternro = " & Ternro
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    moneda = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
Else
    Flog.writeline "No se encontro la estructura moneda."
    moneda = ""
End If
rsConsult.Close
'________________________________________________________________

'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " ("
StrSql = StrSql & " bpronro,ternro,pronro"
StrSql = StrSql & " ,apellido,Nombre,direccion,Legajo"
StrSql = StrSql & " ,pliqnro,pliqmes,pliqanio,pliqdepant"
StrSql = StrSql & " ,pliqfecdep,pliqbco,cuil,empfecalta"
StrSql = StrSql & " ,sueldo,categoria,centrocosto,localidad"
StrSql = StrSql & " ,profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma"
StrSql = StrSql & " ,empfirmaalto,empfirmaancho,formapago,prodesc,descripcion "
StrSql = StrSql & " ,tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden"
StrSql = StrSql & " ,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5"
StrSql = StrSql & " ,auxdeci1,auxdeci2,auxdeci3,auxchar6"
StrSql = StrSql & " ,auxchar7,auxchar8,auxchar9,auxchar10,auxchar11,auxchar12,auxchar13, auxdeci4,auxdeci7,puesto,auxchar"
StrSql = StrSql & " ) "
StrSql = StrSql & " VALUES "
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & NroDoc & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Replace(Sueldo, ",", ".")
StrSql = StrSql & ",'" & Doc113 & "'" 'Categoria
StrSql = StrSql & ",'" & Mid(EstructuraCCosto, 1, 100) & "'"
StrSql = StrSql & ",'" & RegPat & "'" ' Localidad
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden

'Auxchar
StrSql = StrSql & ",'" & CarnetAFP & "'"

StrSql = StrSql & ",'" & periodo_vac_desde & "'"
StrSql = StrSql & ",'" & periodo_vac_hasta & "'"

StrSql = StrSql & ",'" & EstructuraAFP & "'"   'AFP
StrSql = StrSql & ",'" & Estructuracargo & "'" ' CARGO

'Auxdeci
StrSql = StrSql & "," & Replace(SalarioNeto, ",", ".")
StrSql = StrSql & "," & DiasTrabajados
StrSql = StrSql & "," & HrsTrabajadas
StrSql = StrSql & ",'" & IIf(EsNulo(empFecBaja), "", empFecBaja) & "'" 'sebastian stremel

'auxchar
StrSql = StrSql & ",'" & EstructuraUbicacion & "'"
StrSql = StrSql & ",'" & EstructuraSede & "'"
StrSql = StrSql & ",'" & EstructuraArea & "'"
'auxchar10 y auxchar11, 12 y 13
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & EstructuraTipotrabajador & "'"
StrSql = StrSql & ",'" & EstructuraOcupacion & "'"
'Auxdeci
StrSql = StrSql & "," & IIf(EsNulo(valorSueldo), 0, valorSueldo)
StrSql = StrSql & "," & AporteEmp
StrSql = StrSql & ",'" & AporteEmpDesc & "'"
StrSql = StrSql & ",'" & moneda & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

'Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Flog.writeline "----------------------------------------------------------------------------------------"
Flog.writeline ""
Flog.writeline ""

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub

Sub generarDatosRecibo180(Pronro, Ternro, acunroSueldo, tituloReporte, orden)
Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SueldoRemu
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim LugarPago
Dim ProcDesc
Dim ObraSocial
Dim FechaIngreso
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Contrato
Dim Condicion
Dim MontoTickets As Double
Dim MontoGratificacion As Double
Dim CabliqNumero As Integer
Dim Banco
Dim Cuenta
Dim Sector
Dim Antiguedad
Dim Documento
Dim empFecBaja

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String

Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3

Dim Dia As Integer
Dim Mes As Integer
Dim Anio As Integer

Dim Fecha_aux As Date
Dim anios_aux As Integer
Dim meses_aux As Integer
Dim dias_aux As Integer
Dim diasHab_aux As Integer
Dim codResolucion As String
Dim tidnroRST As String

Dim rs_confrep As New ADODB.Recordset
Dim rs_resolucion As New ADODB.Recordset
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0


'------------------------------------------------------------------
'Obtengo la configuracion del tipo de documento resolucion
'------------------------------------------------------------------
StrSql = " SELECT confval FROM confrep WHERE repnro = 60 AND confnrocol = 358 "
OpenRecordset StrSql, rs_confrep
If Not rs_confrep.EOF Then
    tidnroRST = rs_confrep!confval
    Flog.writeline "Codigo de tipo de documento Resolucion encontrado."
Else
    tidnroRST = 0
    Flog.writeline "Codigo de tipo de documento Resolucion No encontrado."
End If


'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecplan, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecplan
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
   Flog.writeline "   Datos del PROCESO OK"
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

SueldoRemu = 0
If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   If Not IsNull(rsConsult!empremu) Then
      SueldoRemu = rsConsult!empremu
   End If
   Flog.writeline "   los datos del empleado generados OK"
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la ultima Fecha de Alta del empleado de la fase
'------------------------------------------------------------------
StrSql = " SELECT altfec "
StrSql = StrSql & " FROM fases "
StrSql = StrSql & " WHERE empleado = " & Ternro
StrSql = StrSql & " ORDER BY altfec DESC"
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   empFecAlta = rsConsult!altfec
   Flog.writeline "    la Fecha de Alta del Empleado OK"
Else
   Flog.writeline "Error al obtener la Fecha de Alta del Empleado"
   empFecAlta = ""
   'GoTo MError
End If


'------------------------------------------------------------------
'Busco los datos del periodo actual y la descripción del proceso
'------------------------------------------------------------------
StrSql = " SELECT * FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
   ProcDesc = rsConsult!proDesc
   Flog.writeline "    los datos del periodo actual OK"
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la fecha de baja
'------------------------------------------------------------------
empFecBaja = ""
StrSql = " SELECT * FROM fases WHERE empleado = " & Ternro & _
         " ORDER BY altfec DESC "
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not IsNull(rsConsult!bajfec) Then
      empFecBaja = rsConsult!bajfec
   End If
End If


'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------
StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = IIf(EsNulo(rsConsult!estrdabr), "", rsConsult!estrdabr)
End If

'------------------------------------------------------------------
'Calculo la antiguedad
'------------------------------------------------------------------
Fecha_aux = CDate("01" & "/" & pliqmes & "/" & pliqanio)
Fecha_aux = DateAdd("m", 1, Fecha_aux)
Fecha_aux = DateAdd("d", -1, Fecha_aux)

If Fecha_aux < empFecAlta Then
    Antiguedad = "0 año/s 0 mes/ses"
Else
    Call bus_Antiguedad(Ternro, "SUELDO", Fecha_aux, dias_aux, meses_aux, anios_aux, diasHab_aux)
    Antiguedad = anios_aux & " año/s " & meses_aux & " mes/es"
End If

Antiguedad = Antiguedad & " (al " & Fecha_aux & ")"


'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------

If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If

'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
      Flog.writeline "    los datos del cuil OK"
Else
   Cuil = ""
   Flog.writeline "Error al obtener los datos del cuil"
   'GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del tipo
'------------------------------------------------------------------
Direccion = ""
StrSql = " SELECT estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 57 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Direccion = rsConsult!estrcodext
End If


'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'If Sueldo = 0 Then
    
    Sueldo = 0
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
       Flog.writeline "    los datos del sueldo OK"
    Else
       Flog.writeline "Error al obtener los datos del sueldo"
       Sueldo = 0
       'GoTo MError
    End If
'End If

'Si no encuentra el sueldo asigno el del tablero del empleado
If Sueldo = 0 Then Sueldo = SueldoRemu
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
   Flog.writeline "    los datos de la categoria OK"
Else
   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del doc y tipo doc
'------------------------------------------------------------------

StrSql = " SELECT docu.nrodoc AS nrodoc, tipodocu.tidsigla AS sigladoc "
StrSql = StrSql & " FROM tercero "
StrSql = StrSql & " LEFT JOIN ter_doc docu ON (docu.ternro= tercero.ternro and docu.tidnro>0 and docu.tidnro<5) "
StrSql = StrSql & " LEFT JOIN tipodocu ON tipodocu.tidnro= docu.tidnro "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro

OpenRecordset StrSql, rsConsult

Documento = ""

If Not rsConsult.EOF Then
   Documento = rsConsult!sigladoc & "-" & rsConsult!NroDoc
      Flog.writeline "    los datos de la Documento Ok"
Else
      Flog.writeline "Error al obtener los datos de la Documento"
End If

rsConsult.Close


'------------------------------------------------------------------
'Busco el valor del sector
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 2 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Sector = ""

If Not rsConsult.EOF Then
   Sector = rsConsult!estrdabr
   Flog.writeline "    los datos del sector OK"
Else
   Flog.writeline "Error al obtener los datos del sector"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 4 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = ""

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "    los datos del puesto OK"
Else
   Flog.writeline "Error al obtener los datos del puesto"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del Contrato
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 18 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Contrato = ""

If Not rsConsult.EOF Then
   Contrato = rsConsult!estrdabr
   Flog.writeline "    los datos del contrato OK"
Else
   Flog.writeline "Error al obtener los datos del contrato"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del lugar de pago
'------------------------------------------------------------------

StrSql = " SELECT estrdabr, estrcodext "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=20 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
   Flog.writeline "    los datos del centro de costo OK"
Else
   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If
rsConsult.Close

'------------------------------------------------------------------
'Busco el banco y la cuenta del empleado
'------------------------------------------------------------------

StrSql = " SELECT banco.bandesc, ctabancaria.ctabnro, ctabancaria.ctabcbu "
StrSql = StrSql & " From ctabancaria "
StrSql = StrSql & " INNER JOIN banco ON ctabancaria.banco = banco.ternro "
StrSql = StrSql & " WHERE ctabancaria.ternro= " & Ternro
StrSql = StrSql & " AND ctabancaria.ctabestado = -1"

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   If Not EsNulo(rsConsult!ctabcbu) Then
       Banco = ""
       Cuenta = "CBU " & rsConsult!ctabcbu
   Else
       If Not EsNulo(rsConsult!ctabnro) Then
            Banco = rsConsult!Bandesc
            Cuenta = "Cta. Nro. " & rsConsult!ctabnro
       Else
            Banco = ""
            Cuenta = ""
       End If
   End If
Flog.writeline "    los datos de Cuenta + Banco (OK)"
Else
    Banco = ""
    Cuenta = ""
    Flog.writeline "Error al obtener los datos de Cuenta + Banco"
End If

' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    "(his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    "AND his_estructura.ternro = " & Ternro & _
    "AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    generoRecibo = False
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro & ", " & rs_Domicilio!locdesc
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para buscar el numero de resolucion de la empresa
StrSql = "SELECT nrodoc FROM ter_doc " & _
         " Where ternro =" & rs_estructura!Ternro & " AND ter_doc.tidnro = " & tidnroRST
OpenRecordset StrSql, rs_resolucion
If rs_resolucion.EOF Then
    Flog.writeline "No se encontró nro de resolucion de la empresa"
    'Exit Sub
    codResolucion = 0
Else
    codResolucion = rs_resolucion!NroDoc
End If



'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
   Flog.writeline "    los datos de las cargas sociales OK"
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de tickets
'------------------------------------------------------------------
If esTicketsConc Then

    StrSql = " SELECT detliq.dlimonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Tickets
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor,cabliq.cliqnro "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Tickets

End If
    
OpenRecordset StrSql, rsConsult

MontoTickets = 0

Do Until rsConsult.EOF
  
    CabliqNumero = rsConsult!cliqnro
    If Not IsNull(rsConsult!Valor) Then
       MontoTickets = MontoTickets + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close

'------------------------------------------------------------------
'Obtengo los datos del los conceptos de gratificacion
'------------------------------------------------------------------

If esGratificacionConc Then

    StrSql = " SELECT detliq.dlimonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro & " AND detliq.concnro = " & Gratificacion
    
Else

    StrSql = " SELECT acu_liq.almonto AS valor "
    StrSql = StrSql & " FROM cabliq "
    StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
    StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
    StrSql = StrSql & " INNER JOIN acu_liq   ON cabliq.cliqnro = acu_liq.cliqnro  AND cabliq.empleado = " & Ternro & " AND acu_liq.acunro = " & Gratificacion

End If

OpenRecordset StrSql, rsConsult

MontoGratificacion = 0

Do Until rsConsult.EOF
    
    If Not IsNull(rsConsult!Valor) Then
       MontoGratificacion = MontoGratificacion + CDbl(rsConsult!Valor)
    End If
    
    rsConsult.MoveNext
Loop

rsConsult.Close


'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto,"
StrSql = StrSql & " tenro1,estrnro1,tenro2,estrnro2,tenro3,estrnro3,orden,auxchar1,auxchar2,auxchar3,"
StrSql = StrSql & " auxdeci1,auxdeci2,auxdeci3,auxchar4,auxchar5,auxchar6)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 20) & "'"
StrSql = StrSql & ",'" & empFecBaja & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & Mid(ObraSocial, 1, 100) & "'"
StrSql = StrSql & ",'" & ProcDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & Antiguedad & "'"
StrSql = StrSql & ",'" & Sector & "'"
StrSql = StrSql & ",'" & Documento & "'"
StrSql = StrSql & "," & CabliqNumero
StrSql = StrSql & "," & MontoTickets
StrSql = StrSql & "," & MontoGratificacion
StrSql = StrSql & ",'" & Cuenta & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & codResolucion & "'"
StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio, conctexto, concext "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    If Not IsNull(rsConsult!Conctexto) Then
       If (Mid(rsConsult!Conctexto, 1, 1) = "*") Then
           StrSql = " INSERT INTO rep_recibo_leyenda "
           StrSql = StrSql & " (bpronro, ternro, pronro, leyenda) "
           StrSql = StrSql & " VALUES"
           StrSql = StrSql & "(" & NroProceso
           StrSql = StrSql & "," & Ternro
           StrSql = StrSql & "," & Pronro
           StrSql = StrSql & ",'" & rsConsult!concext & "'"
           StrSql = StrSql & ")"
           
           objConn.Execute StrSql, , adExecuteNoRecords
       End If
    End If
    
    rsConsult.MoveNext

Loop
rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
    generoRecibo = False
End Sub
'--------------------------------------------------------------------
' Se encarga de generar los datos para Apex El Salvador
'--------------------------------------------------------------------
Sub generarDatosRecibo181(Pronro, Ternro, acunroSueldo, tituloReporte, orden)

Dim StrSql As String
Dim rsConsult As New ADODB.Recordset
Dim cliqnro
Dim profecini As String

'Variables donde se guardan los datos del INSERT final
Dim Apellido
Dim Nombre
Dim Direccion
Dim Legajo
Dim pliqnro
Dim pliqmes
Dim pliqanio
Dim pliqdepant
Dim pliqfecdep
Dim pliqbco
Dim Cuil
Dim empFecAlta
Dim Sueldo
Dim SalarioNeto
Dim Categoria
Dim CentroCosto
Dim Localidad
Dim proFecPago
Dim pliqhasta
Dim FormaPago
Dim Puesto
Dim Banco
Dim nroCuenta

Dim EmpEstrnro
Dim EmpNombre As String
Dim EmpDire As String
Dim EmpCuit As String
Dim EmpLogo As String
Dim EmpFirma As String
Dim EmpLogoAlto As Integer
Dim EmpLogoAncho As Integer
Dim EmpFirmaAlto As Integer
Dim EmpFirmaAncho As Integer
Dim proDesc As String
Dim UbicacionCod As Integer
Dim Ubicacion As String
Dim Departamento As String
Dim EtiquetaFormaPago As String
Dim CodFormaPago As Integer
 
Dim EmpEstrnro1
Dim EmpEstrnro2
Dim EmpEstrnro3
Dim ObraSocial
Dim rs_estructura As New ADODB.Recordset
Dim rs_Domicilio As New ADODB.Recordset
Dim rs_cuit As New ADODB.Recordset
Dim rs_Nit As New ADODB.Recordset
Dim rs_logo As New ADODB.Recordset
Dim rs_firma As New ADODB.Recordset

Dim EmpNit
Dim NroPuesto

On Error GoTo MError

EmpEstrnro1 = 0
EmpEstrnro2 = 0
EmpEstrnro3 = 0

'------------------------------------------------------------------
'Obtengo el nro de cabezera de liquidacion y la fecha de pago del proceso
'------------------------------------------------------------------
StrSql = " SELECT cabliq.cliqnro, proceso.profecpago, proceso.prodesc, proceso.profecini FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso ON cabliq.pronro = proceso.pronro AND proceso.pronro = " & Pronro
StrSql = StrSql & " WHERE cabliq.empleado=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   cliqnro = rsConsult!cliqnro
   proFecPago = rsConsult!proFecPago
   profecini = rsConsult!profecini
   proDesc = rsConsult!proDesc
Else
   Flog.writeline "Error al obtener los datos del proceso"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del empleado
'------------------------------------------------------------------
StrSql = " SELECT empleg,terape,terape2,ternom,ternom2,empfaltagr,empremu "
StrSql = StrSql & " FROM empleado "
StrSql = StrSql & " WHERE ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Nombre = rsConsult!ternom & " " & rsConsult!ternom2
   Apellido = rsConsult!terape & " " & rsConsult!terape2
   Legajo = rsConsult!empleg
   empFecAlta = rsConsult!empfaltagr
   If IsNull(rsConsult!empremu) Then
      Sueldo = 0
   Else
      Sueldo = rsConsult!empremu
   End If
Else
   Flog.writeline "Error al obtener los datos del empleado"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco los datos del periodo actual
'------------------------------------------------------------------
StrSql = " SELECT periodo.* FROM periodo "
StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " AND proceso.pronro= " & Pronro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqnro = rsConsult!pliqnro
   pliqmes = rsConsult!pliqmes
   pliqanio = rsConsult!pliqanio
   pliqhasta = rsConsult!pliqhasta
Else
   Flog.writeline "Error al obtener los datos del periodo actual"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la estructura "Ubicacion" desde el confrep
'------------------------------------------------------------------
 
'StrSql = " select estrnro,estrdabr from estructura "
'StrSql = StrSql & " where tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=33) "
'StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
'StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=33)) "
'StrSql = StrSql & " INNER JOIN proceso ON proceso.pliqnro = periodo.pliqnro "
'StrSql = StrSql & " AND proceso.pronro= " & Pronro
'FB
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=33)"
StrSql = StrSql & " AND his_estructura.Ternro = " & Ternro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Ubicacion = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
Else
   Flog.writeline "Error al obtener los datos de la Ubicacion"
   GoTo MError
End If

'------------------------------------------------------------------
'Busco la estructura "Departamento" desde el confrep
'------------------------------------------------------------------
 
'StrSql = " select estrnro,estrdabr from estructura "
'StrSql = StrSql & " where tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=34) "
'StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
'StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=34)) "
'FB
StrSql = " SELECT estructura.estrnro,estrdabr "
StrSql = StrSql & " FROM his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " AND his_estructura.tenro = (SELECT confval from confrep WHERE repnro = 60 and  confnrocol=34)"
StrSql = StrSql & " AND his_estructura.Ternro = " & Ternro
        
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Departamento = rsConsult!Estrnro & "@@" & rsConsult!estrdabr
Else
   Flog.writeline "No se pudo obtener los datos del Departamento"
   'GoTo MError
End If
 
'------------------------------------------------------------------
'Busco los datos de la Forma de Pago  desde el confrep
'------------------------------------------------------------------

'StrSql = "SELECT estrdabr FROM his_estructura"
'StrSql = StrSql & " INNER JOIN estructura ON estructura.tenro = his_estructura.tenro "
'StrSql = StrSql & " AND  estructura.estrnro = his_estructura.estrnro "
'StrSql = StrSql & " WHERE his_estructura.Ternro = " & Ternro & " And his_estructura.tenro = 22"
       
StrSql = " SELECT estrnro,estrdabr FROM estructura "
StrSql = StrSql & " WHERE tenro = (select confval from confrep WHERE repnro = 60 and  confnrocol=35) "
StrSql = StrSql & " AND estrnro IN  (select estrnro from his_estructura "
StrSql = StrSql & "    where ternro= " & Ternro & " AND tenro=(select confval from confrep WHERE repnro = 60 and  confnrocol=35)) "
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
    CodFormaPago = rsConsult!Estrnro
    FormaPago = rsConsult!estrdabr
Else
   CodFormaPago = 0
   FormaPago = ""
   Flog.writeline "Error al obtener los datos de la forma de pago"
'  GoTo MError
End If

rsConsult.Close


'-----------------------------------------------------------------
'Busco el tipo "M" desde el confrep para definir la etiqueta de la forma de pago
'-----------------------------------------------------------------
StrSql = " SELECT confetiq  FROM confrep WHERE conftipo = 'M' AND confval = " & CodFormaPago
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   EtiquetaFormaPago = rsConsult!confetiq
Else
   EtiquetaFormaPago = "Salario"
   Flog.writeline "Error al obtener los datos desde el confrep (tipo=M)"
End If

FormaPago = FormaPago & "@@" & EtiquetaFormaPago

rsConsult.Close

'------------------------------------------------------------------
'Busco los datos del tipos de estructura 1
'------------------------------------------------------------------

If tenro1 <> 0 Then
    If estrnro1 <> 0 Then
        EmpEstrnro1 = estrnro1
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro1
        StrSql = StrSql & " AND (htetdesde<=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro1 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 2
'------------------------------------------------------------------

If tenro2 <> 0 Then
    If estrnro2 <> 0 Then
        EmpEstrnro2 = estrnro2
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro2
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro2 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco los datos del tipos de estructura 3
'------------------------------------------------------------------
If tenro3 <> 0 Then
    If estrnro3 <> 0 Then
        EmpEstrnro3 = estrnro3
    Else
        StrSql = " SELECT * FROM his_estructura WHERE ternro = " & Ternro & " AND tenro = " & tenro3
        StrSql = StrSql & " AND (htetdesde <=" & ConvFecha(fecEstr) & " AND (htethasta is null or htethasta>=" & ConvFecha(fecEstr) & "))"
               
        OpenRecordset StrSql, rsConsult
        
        If Not rsConsult.EOF Then
           EmpEstrnro3 = rsConsult!Estrnro
        End If
    End If
End If
'------------------------------------------------------------------
'Busco el valor del cuil
'------------------------------------------------------------------
StrSql = " SELECT cuil.nrodoc "
StrSql = StrSql & " FROM tercero LEFT JOIN ter_doc cuil ON (tercero.ternro=cuil.ternro and cuil.tidnro=10) "
StrSql = StrSql & " WHERE tercero.ternro= " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Cuil = rsConsult!NroDoc
Else
'   Flog.writeline "Error al obtener los datos del cuil"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la direccion y localidad
'------------------------------------------------------------------
StrSql = " SELECT detdom.calle,detdom.nro,detdom.piso,detdom.oficdepto,localidad.locdesc"
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN sucursal ON sucursal.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(proFecPago) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(proFecPago) & ") AND tenro=1 AND his_estructura.ternro=" & Ternro
StrSql = StrSql & " INNER JOIN cabdom ON cabdom.ternro = sucursal.ternro"
StrSql = StrSql & " INNER JOIN detdom ON detdom.domnro = cabdom.domnro"
StrSql = StrSql & " INNER JOIN localidad ON detdom.locnro = localidad.locnro"
       
OpenRecordset StrSql, rsConsult
Direccion = ""
If Not rsConsult.EOF Then
   Direccion = rsConsult!calle & " " & rsConsult!nro
    
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rsConsult!Piso) Then
        Direccion = Direccion & " P. " & rsConsult!Piso
    End If
    If Not EsNulo(rsConsult!oficdepto) Then
        Direccion = Direccion & " Dpto. " & rsConsult!oficdepto
    End If
    
    Direccion = Direccion & ", " & rsConsult!locdesc
   
   Localidad = Direccion
Else
'   Flog.writeline "Error al obtener los datos de la localidad"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del sueldo basico
'------------------------------------------------------------------
'si el valor sueldo es cero en los datos del empleado entonces tengo que
'buscar el valor del sueldo

'FGZ - 25/08/2011 ------------
' se cambio la logica (ahora si tiene valor ==> lo recalcula sino deja el empremu
'If Sueldo = 0 Then
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = " & acunroSueldo
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       Sueldo = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del sueldo. Se queda con el valor de la remuneracion cargada en ADP."
       'Sueldo = 0
       'GoTo MError
    End If
'End If
'------------------------------------------------------------------
'Busco el valor del acumulador Salario Neto
'------------------------------------------------------------------
'Busco la configuracion del confrep
 Flog.writeline "Obtengo el acumulador neto desde el confrep"
       
    StrSql = " SELECT almonto"
    StrSql = StrSql & " From acu_liq"
    StrSql = StrSql & " Where acunro = (select confval from confrep WHERE repnro = 60 and  confnrocol = 2)"
    StrSql = StrSql & " AND cliqnro = " & cliqnro
    
    OpenRecordset StrSql, rsConsult

    If Not rsConsult.EOF Then
       SalarioNeto = rsConsult!almonto
    Else
       Flog.writeline "Error al obtener los datos del acumulador Salario Neto"
       SalarioNeto = 0
       'GoTo MError
    End If
'------------------------------------------------------------------
'Busco el valor de la categoria
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 3 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   Categoria = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos de la categoria"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor del puesto
'------------------------------------------------------------------
StrSql = " SELECT confval from confrep WHERE repnro = 60 and  conftipo='PUE' "
OpenRecordset StrSql, rsConsult
If Not rsConsult.EOF Then
    NroPuesto = rsConsult!confval
Else
    Flog.writeline "No esta configurado el Puesto en el Confrep"
    NroPuesto = 0
End If

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ")"
StrSql = StrSql & " And his_estructura.tenro = " & NroPuesto
StrSql = StrSql & " And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

Puesto = " "

If Not rsConsult.EOF Then
   Puesto = rsConsult!estrdabr
   Flog.writeline "Query del Puesto " & StrSql
Else
   Flog.writeline "No Existe el Puesto"
'   GoTo MError
End If


'------------------------------------------------------------------
'Busco el valor del centro de costo
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro AND htetdesde <= " & ConvFecha(pliqhasta) & " AND (htethasta IS NULL OR htethasta >= " & ConvFecha(pliqhasta) & ") AND his_estructura.tenro=5 AND his_estructura.ternro=" & Ternro
       
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   CentroCosto = rsConsult!estrdabr
Else
'   Flog.writeline "Error al obtener los datos del centro de costo"
'   GoTo MError
End If

  
' -------------------------------------------------------------------------
' Busco los datos de la empresa
'--------------------------------------------------------------------------

StrSql = "SELECT his_estructura.estrnro, empresa.ternro, empresa.empnom " & _
    " From his_estructura" & _
    " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro" & _
    " WHERE his_estructura.htetdesde <=" & ConvFecha(pliqhasta) & " AND " & _
    " (his_estructura.htethasta >= " & ConvFecha(pliqhasta) & " OR his_estructura.htethasta IS NULL)" & _
    " AND his_estructura.ternro = " & Ternro & _
    " AND his_estructura.tenro  = 10"
OpenRecordset StrSql, rs_estructura

EmpEstrnro = 0

If rs_estructura.EOF Then
    Flog.writeline "No se encontró la empresa"
    Exit Sub
Else
    EmpNombre = rs_estructura!empnom
    EmpEstrnro = rs_estructura!Estrnro
End If

'Consulta para obtener la direccion de la empresa
StrSql = "SELECT detdom.calle,detdom.nro,localidad.locdesc, detdom.piso, detdom.oficdepto From cabdom " & _
    " INNER JOIN detdom ON detdom.domnro = cabdom.domnro AND cabdom.ternro =" & rs_estructura!Ternro & _
    " INNER JOIN localidad ON detdom.locnro = localidad.locnro "
OpenRecordset StrSql, rs_Domicilio
If rs_Domicilio.EOF Then
    Flog.writeline "No se encontró el domicilio de la empresa"
    'Exit Sub
    EmpDire = "   "
Else
    EmpDire = rs_Domicilio!calle & " " & rs_Domicilio!nro
    '02/10/2006 - Martin Ferraro - Se agrego piso y dpto a la dir del la empresa
    If Not EsNulo(rs_Domicilio!Piso) Then
        EmpDire = EmpDire & " P. " & rs_Domicilio!Piso
    End If
    If Not EsNulo(rs_Domicilio!oficdepto) Then
        EmpDire = EmpDire & " Dpto. " & rs_Domicilio!oficdepto
    End If
    EmpDire = EmpDire & " - " & rs_Domicilio!locdesc
    
End If

'Consulta para obtener el cuit de la empresa
StrSql = "SELECT cuit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro and cuit.tidnro = 6)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_cuit
If rs_cuit.EOF Then
    Flog.writeline "No se encontró el CUIT de la Empresa"
    'Exit Sub
    EmpCuit = "  "
Else
    EmpCuit = rs_cuit!NroDoc
End If

'Consulta para obtener el NIT de la empresa
StrSql = "SELECT nit.nrodoc FROM tercero " & _
         " INNER JOIN ter_doc nit ON (tercero.ternro = nit.ternro and nit.tidnro = 1106)" & _
         " Where tercero.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_Nit
If rs_Nit.EOF Then
    Flog.writeline "No se encontró el NIT de la Empresa"
    'Exit Sub
    EmpNit = "  "
Else
    EmpNit = rs_Nit!NroDoc
    Flog.writeline "Query del NIT de la Empresa " & StrSql
End If


'Consulta para buscar el logo de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 1 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_logo
If rs_logo.EOF Then
    Flog.writeline "No se encontró el Logo de la Empresa"
    'Exit Sub
    EmpLogo = ""
    EmpLogoAlto = 0
    EmpLogoAncho = 0
Else
    EmpLogo = rs_logo!tipimdire & rs_logo!terimnombre
    EmpLogoAlto = rs_logo!tipimaltodef
    EmpLogoAncho = rs_logo!tipimanchodef
End If

'Consulta para buscar la firma de la empresa
StrSql = "SELECT ter_imag.terimnombre, tipoimag.tipimdire, tipoimag.tipimanchodef, tipoimag.tipimaltodef" & _
    " From ter_imag " & _
    " INNER JOIN tipoimag ON tipoimag.tipimnro = 2 AND tipoimag.tipimnro = ter_imag.tipimnro" & _
    " AND ter_imag.ternro =" & rs_estructura!Ternro
OpenRecordset StrSql, rs_firma
If rs_firma.EOF Then
    Flog.writeline "No se encontró el Firma de la Empresa"
    'Exit Sub
    EmpFirma = ""
    EmpFirmaAlto = 0
    EmpFirmaAncho = 0
Else
    EmpFirma = rs_firma!tipimdire & rs_firma!terimnombre
    EmpFirmaAlto = rs_firma!tipimaltodef
    EmpFirmaAncho = rs_firma!tipimanchodef
End If

'------------------------------------------------------------------
'Busco los datos de la cargas sociales
'------------------------------------------------------------------
StrSql = " SELECT * FROM peri_ccss "
StrSql = StrSql & " WHERE "
StrSql = StrSql & " pliqnro = " & pliqnro
StrSql = StrSql & " AND estrnro = " & EmpEstrnro

OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
   pliqdepant = rsConsult!periodoant
   pliqfecdep = rsConsult!Fecha
   pliqbco = rsConsult!Banco
Else
   pliqdepant = ""
   pliqfecdep = ""
   pliqbco = ""
   Flog.writeline "No se encontraron los datos de las cargas sociales"
'   GoTo MError
End If

'------------------------------------------------------------------
'Busco el valor de la obra social
'------------------------------------------------------------------

StrSql = " SELECT estrdabr "
StrSql = StrSql & " From his_estructura"
StrSql = StrSql & " INNER JOIN estructura ON estructura.estrnro=his_estructura.estrnro "
StrSql = StrSql & " AND htetdesde <= " & ConvFecha(pliqhasta) & " And (htethasta Is Null Or htethasta >= " & ConvFecha(pliqhasta) & ") And his_estructura.tenro = 17 And his_estructura.ternro = " & Ternro
       
OpenRecordset StrSql, rsConsult

ObraSocial = ""

If Not rsConsult.EOF Then
   ObraSocial = rsConsult!estrdabr
End If

'------------------------------------------------------------------
'Busco los datos de la forma de pago
'------------------------------------------------------------------
Flog.writeline "Buscando los datos de la cuenta del empleado."

StrSql = " SELECT * FROM ctabancaria LEFT JOIN banco ON banco.ternro = ctabancaria.banco WHERE ctabestado=-1 AND ctabancaria.ternro = " & Ternro
OpenRecordset StrSql, rsConsult

If Not rsConsult.EOF Then
        Banco = rsConsult!Bandesc
        nroCuenta = rsConsult!ctabnro
        Flog.writeline "Datos de la cuenta bancaria obtenidos"
  Else
        Banco = ""
        nroCuenta = ""
        Flog.writeline "El empleado no tiene cuentas bancarias activas"
End If

rsConsult.Close




'------------------------------------------------------------------
'Armo la SQL para guardar los datos
'------------------------------------------------------------------

StrSql = " INSERT INTO rep_recibo "
StrSql = StrSql & " (bpronro,ternro,pronro,"
StrSql = StrSql & " apellido,Nombre,direccion,Legajo,"
StrSql = StrSql & " pliqnro,pliqmes,pliqanio,pliqdepant,"
StrSql = StrSql & " pliqfecdep,pliqbco,cuil,empfecalta,"
StrSql = StrSql & " sueldo,categoria,centrocosto,localidad,"
StrSql = StrSql & " profecpago,empnombre,empdire,empcuit,emplogo,emplogoalto,emplogoancho,empfirma,"
StrSql = StrSql & " empfirmaalto,empfirmaancho,formapago,prodesc,descripcion,puesto, "
StrSql = StrSql & " tenro1 , estrnro1, tenro2, estrnro2, tenro3, estrnro3, orden,auxchar1,auxchar2,auxchar3,auxchar4,auxchar5,auxchar6,auxdeci1)"
StrSql = StrSql & " VALUES"
StrSql = StrSql & "(" & NroProceso
StrSql = StrSql & "," & Ternro
StrSql = StrSql & "," & Pronro
StrSql = StrSql & ",'" & Apellido & "'"
StrSql = StrSql & ",'" & Nombre & "'"
StrSql = StrSql & ",'" & Mid(Direccion, 1, 100) & "'"
StrSql = StrSql & "," & Legajo
StrSql = StrSql & "," & pliqnro
StrSql = StrSql & "," & pliqmes
StrSql = StrSql & "," & pliqanio
StrSql = StrSql & ",'" & pliqdepant & "'"
StrSql = StrSql & ",'" & pliqfecdep & "'"
StrSql = StrSql & ",'" & pliqbco & "'"
StrSql = StrSql & ",'" & Cuil & "'"
StrSql = StrSql & ",'" & empFecAlta & "'"
StrSql = StrSql & "," & Sueldo
StrSql = StrSql & ",'" & Mid(Categoria, 1, 20) & "'"
StrSql = StrSql & ",'" & Mid(CentroCosto, 1, 25) & "'"
StrSql = StrSql & ",'" & Mid(Localidad, 1, 100) & "'"
StrSql = StrSql & ",'" & proFecPago & "'"
StrSql = StrSql & ",'" & EmpNombre & "'"
StrSql = StrSql & ",'" & EmpDire & "'"
StrSql = StrSql & ",'" & EmpCuit & "'"
StrSql = StrSql & ",'" & EmpLogo & "'"
StrSql = StrSql & "," & EmpLogoAlto
StrSql = StrSql & "," & EmpLogoAncho
StrSql = StrSql & ",'" & EmpFirma & "'"
StrSql = StrSql & "," & EmpFirmaAlto
StrSql = StrSql & "," & EmpFirmaAncho
StrSql = StrSql & ",'" & FormaPago & "'"
StrSql = StrSql & ",'" & proDesc & "'"
StrSql = StrSql & ",'" & Mid(tituloReporte, 1, 100) & "'"
StrSql = StrSql & ",'" & Puesto & "'"
StrSql = StrSql & "," & tenro1
StrSql = StrSql & "," & EmpEstrnro1
StrSql = StrSql & "," & tenro2
StrSql = StrSql & "," & EmpEstrnro2
StrSql = StrSql & "," & tenro3
StrSql = StrSql & "," & EmpEstrnro3
StrSql = StrSql & "," & orden
StrSql = StrSql & ",'" & ObraSocial & "'"
StrSql = StrSql & ",'" & Banco & "'"
StrSql = StrSql & ",'" & nroCuenta & "'"
StrSql = StrSql & ",'" & Ubicacion & "'"
StrSql = StrSql & ",'" & Departamento & "'"
StrSql = StrSql & ",'" & EmpNit & "'"
StrSql = StrSql & "," & SalarioNeto


StrSql = StrSql & ")"

'------------------------------------------------------------------
'Guardo los datos en la BD
'------------------------------------------------------------------

Flog.writeline "SQL INSERT: " & StrSql

objConn.Execute StrSql, , adExecuteNoRecords

'------------------------------------------------------------------
'Obtengo los datos del los conceptos del empleado
'------------------------------------------------------------------

StrSql = " SELECT cabliq.cliqnro, concepto.concabr, concepto.conccod, concepto.concnro, concepto.tconnro, concepto.concimp, detliq.dlicant, detliq.dlimonto,cabliq.pronro,proceso.prodesc, periodo.pliqdesc, periodo.pliqnro,periodo.pliqmes,periodo.pliqanio "
StrSql = StrSql & " FROM cabliq "
StrSql = StrSql & " INNER JOIN proceso  ON proceso.pronro = cabliq.pronro AND cabliq.pronro = " & Pronro
StrSql = StrSql & " INNER JOIN periodo  ON proceso.pliqnro = periodo.pliqnro "
StrSql = StrSql & " INNER JOIN detliq   ON cabliq.cliqnro = detliq.cliqnro  AND cabliq.empleado = " & Ternro
StrSql = StrSql & " INNER JOIN concepto ON concepto.concnro = detliq.concnro AND concepto.concimp = -1 "
StrSql = StrSql & " ORDER BY periodo.pliqnro,cabliq.pronro, concepto.conccod "
    
OpenRecordset StrSql, rsConsult

Do Until rsConsult.EOF
  
    StrSql = " INSERT INTO rep_recibo_det "
    StrSql = StrSql & " (bpronro, ternro, pronro, cliqnro,"
    StrSql = StrSql & " concabr, conccod, concnro, tconnro,"
    StrSql = StrSql & " concimp , dlicant, dlimonto,conctipo) "
    StrSql = StrSql & " VALUES"
    StrSql = StrSql & "(" & NroProceso
    StrSql = StrSql & "," & Ternro
    StrSql = StrSql & "," & Pronro
    StrSql = StrSql & "," & rsConsult!cliqnro
    StrSql = StrSql & ",'" & rsConsult!concabr & "'"
    StrSql = StrSql & ",'" & rsConsult!ConcCod & "'"
    StrSql = StrSql & "," & rsConsult!ConcNro
    StrSql = StrSql & "," & rsConsult!tconnro
    StrSql = StrSql & "," & rsConsult!concimp
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlicant)
    StrSql = StrSql & "," & numberForSQL(rsConsult!dlimonto)
    StrSql = StrSql & ",'" & arrTipoConc(rsConsult!tconnro) & "')"
    
    objConn.Execute StrSql, , adExecuteNoRecords
    
    rsConsult.MoveNext

Loop

rsConsult.Close

Exit Sub

MError:
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    Flog.writeline Espacios(Tabulador * 1) & "Error en empleado: " & Legajo & " Error: " & Err.Description
    Flog.writeline Espacios(Tabulador * 1) & "Última SQL ejecutada: " & StrSql
    Flog.writeline Espacios(Tabulador * 1) & "************************************************************"
    HuboErrores = True
    EmpErrores = True
End Sub




Public Sub antigfec2(ByVal Ternro As Long, ByVal fechafin As String, ByRef antdia As String, ByRef antmes As String, ByRef antanio As String, ByVal diashab As Integer)

Dim fecalta
Dim fecbaja
Dim seguir
Dim q
Dim StrSql As String
Dim rs As New ADODB.Recordset
Dim a1
Dim m1
Dim ultima
Dim auxiliar
Dim Anio As Integer
Dim Mes As Integer
Dim Dia As Integer
Dim anioT As Integer
Dim mesT As Integer
Dim diaT As Integer

StrSql = " SELECT * FROM fases "
StrSql = StrSql & " WHERE fases.empleado = " & Ternro & " AND fases.real = -1 "
OpenRecordset StrSql, rs
Do Until rs.EOF
    fecalta = rs("altfec")
    fecbaja = rs("bajfec") ' se trata de un registro completo
    If fecbaja <> "" Then
       'FASES CERRADAS --------------------------------------------
         Call DiferenciaFase(fecalta, fecbaja, Dia, Mes, Anio)
         m1 = Month(fecalta)
         a1 = Year(fecalta)
         Call SumarFases(m1, a1, Dia, Mes, Anio, diaT, mesT, anioT)
        'response.write("antdia cerrada")
        'response.write(antdia)
    Else
       'FASES ABIERTAS --------------------------------------------
        Call DiferenciaFase(fecalta, fechafin, Dia, Mes, Anio)
        m1 = Month(fecalta)
        a1 = Year(fecalta)
        Call SumarFases(m1, a1, Dia, Mes, Anio, diaT, mesT, anioT)
        'response.write("antdia abierta")
        'response.write(antdia)
    End If
    ultima = fecbaja
    rs.MoveNext
Loop
antdia = diaT
antmes = mesT
antanio = anioT

rs.Close
Set rs = Nothing


End Sub


'----------------------------------------------------------------------------------
'-- Calcula la antiguedad de la fase
'----------------------------------------------------------------------------------
Sub DiferenciaFase(ByVal fechaalta As String, ByVal fechabaja As String, ByRef diaF As Integer, ByRef mesF As Integer, ByRef anioF As Integer)
    Dim dia1, Mes1, Anio1, dia2, Mes2, Anio2, diames
    
    dia1 = Day(fechaalta)
    Mes1 = Month(fechaalta)
    Anio1 = Year(fechaalta)
    dia2 = Day(fechabaja)
    Mes2 = Month(fechabaja)
    Anio2 = Year(fechabaja)
    
    anioF = Anio2 - Anio1
    
    If Mes2 > Mes1 Then
                   mesF = Mes2 - Mes1 - 1
    End If
    
    If Mes2 < Mes1 Then
                        mesF = 12 + Mes2 - Mes1 - 1
                        anioF = anioF - 1
    End If
    
    If Mes2 = Mes1 Then
              mesF = -1
    End If
    
    If (Mes1 = 2) And ((Anio1 Mod 4) = 0) Then
               diames = 29
    End If
    
    If (Mes1 = 2) And ((Anio1 Mod 4) > 0) Then
               diames = 28
    End If
    
    If (Mes1 = 4) Or (Mes1 = 6) Or (Mes1 = 9) Or (Mes1 = 11) Then
               diames = 30
    End If
                
    If (Mes1 = 1) Or (Mes1 = 3) Or (Mes1 = 5) Or (Mes1 = 7) Or (Mes1 = 8) Or (Mes1 = 10) Or (Mes1 = 12) Then
               diames = 31
    End If
    
    If (Mes2 = 2) And ((Anio2 Mod 4) = 0) And (dia2 = 29) Then
               dia2 = 0
               mesF = mesF + 1
    End If
    
    If (Mes2 = 2) And ((Anio2 Mod 4) > 0) And (dia2 = 28) Then
               dia2 = 0
               mesF = mesF + 1
    End If
    
    If ((Mes2 = 4) Or (Mes2 = 6) Or (Mes2 = 9) Or (Mes2 = 11)) And (dia2 = 30) Then
               dia2 = 0
               mesF = mesF + 1
    End If
                
    If ((Mes2 = 1) Or (Mes2 = 3) Or (Mes2 = 5) Or (Mes2 = 7) Or (Mes2 = 8) Or (Mes2 = 10) Or (Mes2 = 12)) And (dia2 = 31) Then
               dia2 = 0
               mesF = mesF + 1
    End If
    
    
    diaF = dia2 + diames - dia1 + 1
    
    
    If (diaF >= 29) And (diames = 29) Then
                        mesF = mesF + 1
                diaF = diaF - 29
    End If
    If (diaF >= 28) And (diames = 28) Then
                        mesF = mesF + 1
                diaF = diaF - 28
    End If
    If (diames = 30) And (diaF >= 30) Then
                        mesF = mesF + 1
                diaF = diaF - 30
    End If
    If (diames = 31) And (diaF >= 31) Then
                        mesF = mesF + 1
                        diaF = diaF - 31
    End If
    If mesF >= 12 Then
                 mesF = mesF - 12
             anioF = anioF + 1
    End If
    If mesF = -1 Then
                 mesF = 11
                 anioF = anioF - 1
    End If
End Sub


'----------------------------------------------------------------------------------
'-- Calcula la suma de dos fases
'----------------------------------------------------------------------------------
Sub SumarFases(ByVal Mes As Integer, ByVal Anio As Integer, ByVal dia1 As Integer, ByVal Mes1 As Integer, ByVal Anio1 As Integer, ByRef dia2 As Integer, ByRef Mes2 As Integer, ByRef Anio2 As Integer)
    Anio2 = Anio2 + Anio1
    Mes2 = Mes2 + Mes1
    dia2 = dia2 + dia1
    
    
    If (dia2 >= 30) And ((Mes = 4) Or (Mes = 6) Or (Mes = 9) Or (Mes = 11)) Then
                 dia2 = dia2 - 30
                 Mes2 = Mes2 + 1
    Else
       If (dia2 >= 31) And ((Mes = 1) Or (Mes = 3) Or (Mes = 5) Or (Mes = 7) Or (Mes = 8) Or (Mes = 10) Or (Mes = 12)) Then
                 dia2 = dia2 - 31
                 Mes2 = Mes2 + 1
       Else
         If (dia2 >= 28) And (Mes = 2) And (Anio Mod 4 > 0) Then
                 dia2 = dia2 - 28
                 Mes2 = Mes2 + 1
         Else
            If (dia2 >= 29) And (Mes = 2) And (Anio Mod 4 = 0) Then
                 dia2 = dia2 - 29
                 Mes2 = Mes2 + 1
            End If
         End If
       End If
    End If
    
    If Mes2 >= 12 Then
                 Mes2 = Mes2 - 12
                 Anio2 = Anio2 + 1
    End If
End Sub
