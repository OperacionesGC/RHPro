Attribute VB_Name = "MdlRepCertificadoAnsses"
Option Explicit

'Version: 1.01
' Correccion en el rango del calculo de los anios
'Const Version = 1.01
'Const FechaVersion = "12/09/2005"

'Const Version = 1.02    'Modificacion fechas / fases hiostoricos
'Const FechaVersion = "13/10/2005"

'Const Version = 1.03    'Modificacion sobre la cantidad de fases e historicos de estructuras
'Const FechaVersion = "31/10/2005"

'Const Version = 1.04    'Modificacion sobre la cantidad de fases e historicos de estructuras, permite varias paginas
'Const FechaVersion = "10/11/2005"

'Const Version = 1.05    'Modificacion se saca los puntos al documento(certificante) y se puso que salga el piso en domicilio radicacion
'Const FechaVersion = "11/11/2005"

'Const Version = 1.06    'Si la fecha de generacion del reporte es mayor a la fecha de baja de empleado ==>
'                        ' tomo como fecha hasta la fecha de baja
'Const FechaVersion = "28/11/2005"

'Const Version = 1.07    'Cambio en el formato del domicilio
'Const FechaVersion = "05/12/2005"

'Const Version = 1.08    'Cambio en el calculo de los trabajados
'Const FechaVersion = "12/12/2005"

'Const Version = 1.09    'Cambio en el calculo de los trabajados. Se agregó una columna configurable Opcional en el confep para restar 1 dia en el ultimo dia de cada fase
'Const FechaVersion = "07/03/2006"

Const Version = 1.1      'Martin Ferraro - Cambio en el formato de fecha de al insertar en base en Aux_Empleado_FechaNacimiento y Aux_Extincion_Fecha
Const FechaVersion = "17/43/2006"

'------------------------------------------------------------
'------------------------------------------------------------
'------------------------------------------------------------
Global IdUser As String
Global Fecha As Date
Global Hora As String

Global Aux_Autoriz_Apenom As String
Global Aux_Autoriz_Docu As String
Global Aux_Autoriz_Prov_Emis As String

Global Aux_Certifi_Corresponde As String
Global Aux_Certifi_Doc_Tipo As String
Global Aux_Certifi_Doc_Nro As String
Global Aux_Certifi_Expedida As String



Public Sub Main()
' ---------------------------------------------------------------------------------------------
' Descripcion: Procedimiento inicial del Generador de Reportes.
' Autor      : FGZ
' Fecha      : 17/02/2004
' Ultima Mod.:
' Descripcion:
' ---------------------------------------------------------------------------------------------
Dim objconnMain As New ADODB.Connection
Dim strCmdLine
Dim Nombre_Arch As String
Dim HuboError As Boolean
Dim rs_batch_proceso As New ADODB.Recordset
Dim bprcparam As String
Dim PID As String
Dim ArrParametros

    strCmdLine = Command()
    ArrParametros = Split(strCmdLine, " ", -1)
    If UBound(ArrParametros) > 0 Then
        If IsNumeric(ArrParametros(0)) Then
            NroProcesoBatch = ArrParametros(0)
            Etiqueta = ArrParametros(1)
        Else
            Exit Sub
        End If
    Else
        If IsNumeric(strCmdLine) Then
            NroProcesoBatch = strCmdLine
        Else
            Exit Sub
        End If
    End If
    
    ' carga las configuraciones basicas, formato de fecha, string de conexion,
    ' tipo de BD y ubicacion del archivo de log
    Call CargarConfiguracionesBasicas

    'Abro la conexion
    OpenConnection strconexion, objConn
    
    Nombre_Arch = PathFLog & "Certificados_Anses" & "-" & NroProcesoBatch & ".log"
    
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set Flog = fs.CreateTextFile(Nombre_Arch, True)
    
    ' Obtengo el Process ID
    PID = GetCurrentProcessId
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline "Version = " & Version
    Flog.writeline "Fecha   = " & FechaVersion
    Flog.writeline "-----------------------------------------------------------------"
    Flog.writeline
    Flog.writeline "PID = " & PID
    
    
    'Cambio el estado del proceso a Procesando y el PID
    StrSql = "UPDATE batch_proceso SET bprchorainicioej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecinicioej = " & ConvFecha(Date) & ", bprcestado = 'Procesando', bprcpid = " & PID & " WHERE bpronro = " & NroProcesoBatch
    objConn.Execute StrSql, , adExecuteNoRecords
    
    'Obtengo los datos del proceso
    StrSql = "SELECT * FROM batch_proceso WHERE (btprcnro = 40 ) AND bpronro =" & NroProcesoBatch
    OpenRecordset StrSql, rs_batch_proceso
    
    TiempoInicialProceso = GetTickCount
    
    If Not rs_batch_proceso.EOF Then
        IdUser = rs_batch_proceso!IdUser
        Fecha = rs_batch_proceso!bprcfecha
        Hora = rs_batch_proceso!bprchora
        bprcparam = rs_batch_proceso!bprcparam
        
        rs_batch_proceso.Close
        Set rs_batch_proceso = Nothing
        
        Call LevantarParamteros(NroProcesoBatch, bprcparam)
    End If
    
    TiempoFinalProceso = GetTickCount
    Flog.writeline "Tiempo del proceso (milisegundos): " & (TiempoFinalProceso - TiempoInicialProceso)
    
    If Not HuboError Then
        StrSql = "UPDATE batch_proceso SET bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Procesado' WHERE bpronro = " & NroProcesoBatch
    Else
        StrSql = "UPDATE batch_proceso SET bprchorafinej = '" & Format(Now, "hh:mm:ss ") & "', bprcfecfinej = " & ConvFecha(Date) & ", bprcestado = 'Error' WHERE bpronro = " & NroProcesoBatch
    End If
    objConn.Execute StrSql, , adExecuteNoRecords

    Flog.Close
    objConn.Close
    
End Sub

Public Sub Generar_Reporte(ByVal bpronro As Long, ByVal Empresa As Long, ByVal HFecha As Date)
' --------------------------------------------------------------------------------------------
' Descripcion: Procedimiento de generacion del Reporte de Certificado Anses de Servicios
' Autor      : FGZ
' Fecha      : 15/07/2004
' Ult. Mod   : FGZ - 10/11/2005
' Desc       : agrupa en hojas de hasta 5 movimientos de empresas por c/u.
' --------------------------------------------------------------------------------------------
'Variables auxiliares
'Empresa
Dim Aux_Empresa_Certificante As String
Dim Aux_Empresa_Domicilio As String
Dim Aux_Empresa_CodPostal As String
Dim Aux_Empresa_Cuit As String
Dim Aux_Empresa_Actividad As String
Dim Aux_Empresa_Telefono As String
Dim Aux_Empresa_Nro_Inscripcion As String
'Empleado
Dim Aux_Empleado_Cuil As String
Dim Aux_Empleado_Doc As String
Dim Aux_Empleado_Afiliado As String
Dim Aux_Empleado_Apenom As String
Dim Aux_Empleado_FechaNacimiento As String

Dim Aux_Tarea(1 To 100) As String
Dim Aux_Tarea_Desde(1 To 100) As Date
Dim Aux_Tarea_Hasta(1 To 100) As Date
Dim Aux_Tarea_Dias(1 To 100) As Long
Dim Aux_Tarea_Meses(1 To 100) As Long
Dim Aux_Tarea_Anios(1 To 100) As Long

Dim Aux_Total_Tiempo_Dias As Long
Dim Aux_Total_Tiempo_Meses As Long
Dim Aux_Total_Tiempo_Anios As Long
Dim Aux_Extincion As Boolean
Dim Aux_Extincion_Fecha As String
Dim Aux_Extincion_Nro As String
Dim Aux_Puesto As String

Dim Aux_Lic_Desde(1 To 100) As Date
Dim Aux_Lic_Hasta(1 To 100) As Date
Dim Aux_Lic_Dias(1 To 100) As Long
Dim Aux_Lic_Meses(1 To 100) As Long
Dim Aux_Lic_Anios(1 To 100) As Long
Dim Aux_Total_Lic_Dias As Long
Dim Aux_Total_Lic_Meses As Long
Dim Aux_Total_Lic_Anios As Long

Dim Aux_FD_Calle As String
Dim Aux_FD_Nro As String
Dim Aux_FD_Piso As String
Dim Aux_FD_Dpto As String
Dim Aux_FD_CodPostal As String
Dim Aux_FD_Localidad As String
Dim Aux_FD_Provincia As String
Dim Aux_FD_Telefono As String
Dim Aux_FD_Observaciones As String

'Generales
Dim Aux_Fuente_Doc As String
Dim Aux_Caracter As String
Dim Aux_CI_Nro As String
Dim Aux_Expedido_por As String

Dim Lista_Licencias As String
Dim Acum_Remu As Long
Dim Acum_Sac As Long
Dim Encontro1 As Boolean
Dim Encontro2 As Boolean
Dim Primera As Boolean

Dim i As Integer
Dim J As Integer
Dim Aux_Indice As Integer
Dim CantidadTareas As Integer
Dim Indice_Inicio As Integer
Dim Indice_Fin As Integer
Dim CantidadPaginas As Integer

Dim Continuar As Boolean
Dim Aux_Acum_Remu As Single
Dim Aux_Acum_Sac As Single

Dim MesActual As Integer
Dim AnioActual As Integer

Dim Aux_Meses As Integer
Dim Aux_Dias As Integer
Dim Aux_Horas As Integer
Dim Aux_Licencias As Integer

Dim Aux_RepNro As Long
Dim AuxFecha_inicio As Date
Dim AuxFecha As Date
Dim Aux_Anio As Integer
Dim Ultimo_Anio_Insertado As Integer
Dim Contempla As Boolean

Dim Aux_HFecha As Date
Dim primerDetalle As Boolean

Dim Resta_Uno_Configurado As Boolean
Dim Resta_Uno As Boolean

'Registros
Dim rs_Confrep As New ADODB.Recordset
Dim rs_Acu_Mes As New ADODB.Recordset
Dim rs_Empleados As New ADODB.Recordset
Dim rs_Fases As New ADODB.Recordset
Dim rs_Cuil As New ADODB.Recordset
Dim rs_Doc As New ADODB.Recordset
Dim rs_Cuit As New ADODB.Recordset
Dim rs_Estructura As New ADODB.Recordset
Dim rs_Tercero As New ADODB.Recordset
Dim rs_Empresa As New ADODB.Recordset
Dim rs_Zona As New ADODB.Recordset
Dim rs_Provincia As New ADODB.Recordset
Dim rs_Telefono As New ADODB.Recordset
Dim rs_Estr_Cod As New ADODB.Recordset
Dim rs_HisEstructura As New ADODB.Recordset
Dim rs_Licencias As New ADODB.Recordset
Dim rs_rep_PS62 As New ADODB.Recordset


On Error GoTo CE
'Configuracion del Reporte
StrSql = "SELECT * FROM reporte INNER JOIN confrep ON  reporte.repnro = confrep.repnro WHERE reporte.repnro = 16"
OpenRecordset StrSql, rs_Confrep
If rs_Confrep.EOF Then
    Flog.writeline "No se encontró la configuración del Reporte 16"
    Exit Sub
End If

Encontro1 = False
Encontro2 = False
Primera = True
Resta_Uno = False
Resta_Uno_Configurado = False
Do While Not rs_Confrep.EOF
    Select Case rs_Confrep!conftipo
    Case "TD":
        If Primera Then
            Primera = False
            Lista_Licencias = CStr(rs_Confrep!confval)
        Else
            Lista_Licencias = Lista_Licencias & "," & rs_Confrep!confval
        End If
    Case "REM":
        Acum_Remu = rs_Confrep!confval
        Encontro1 = True
    Case "SAC":
        Acum_Sac = rs_Confrep!confval
        Encontro2 = True
    Case "DIA": 'FGZ - 07/03/2006 Se agregó esta columna configurable Opcional
        'Resta_Uno = True
        Resta_Uno_Configurado = True
    End Select
    
    rs_Confrep.MoveNext
Loop

If Not Encontro1 Then
    Acum_Remu = 0
End If
If Not Encontro2 Then
    Acum_Sac = 0
End If


' Comienzo la transaccion
MyBeginTrans

    'Cargo los valores fijos
    Aux_Fuente_Doc = "Registros Rubricados"
    Aux_Caracter = "Comunes"
    Aux_CI_Nro = " "
    Aux_Expedido_por = " "
    
    Aux_FD_Calle = " "
    Aux_FD_Nro = " "
    Aux_FD_Piso = " "
    Aux_FD_Dpto = " "
    Aux_FD_CodPostal = " "
    Aux_FD_Localidad = " "
    Aux_FD_Provincia = " "
    Aux_FD_Telefono = " "
    Aux_FD_Observaciones = " "
    
    'Busco los datos de la empresa
    StrSql = "SELECT * FROM empresa WHERE empresa.empnro = " & Empresa
    OpenRecordset StrSql, rs_Empresa
    
    If Not rs_Empresa.EOF Then
        Aux_Empresa_Certificante = rs_Empresa!empnom
        Aux_Empresa_Actividad = IIf(Not IsNull(rs_Empresa!empactiv), rs_Empresa!empactiv, " ")
    Else
        Flog.writeline "No se encontró la empresa" & Empresa
        Exit Sub
    End If
    
    'Domicilio y codigo postal
    StrSql = " SELECT * FROM detdom " & _
             " INNER JOIN cabdom ON detdom.domnro = cabdom.domnro " & _
             " INNER JOIN localidad ON localidad.locnro = detdom.locnro " & _
             " WHERE cabdom.ternro = " & rs_Empresa!ternro
    OpenRecordset StrSql, rs_Zona
    If Not rs_Zona.EOF Then
        Aux_Empresa_Domicilio = rs_Zona!calle
        Aux_Empresa_Domicilio = Aux_Empresa_Domicilio & " " & IIf(Not IsNull(rs_Zona!nro), rs_Zona!nro, " ")
        Aux_Empresa_Domicilio = Aux_Empresa_Domicilio & IIf(Not IsNull(rs_Zona!piso), " Piso " & rs_Zona!piso, " ")
        Aux_Empresa_Domicilio = Aux_Empresa_Domicilio & " " & IIf(Not IsNull(rs_Zona!oficdepto), rs_Zona!oficdepto, " ")
        
        Aux_Empresa_CodPostal = IIf(Not IsNull(rs_Zona!codigopostal), rs_Zona!codigopostal, " ")
        
        Aux_FD_Calle = IIf(Not IsNull(rs_Zona!calle), rs_Zona!calle, " ")
        Aux_FD_Nro = IIf(Not IsNull(rs_Zona!nro), rs_Zona!nro, " ")
        Aux_FD_Piso = IIf(Not IsNull(rs_Zona!piso), rs_Zona!piso, " ")
        Aux_FD_Dpto = IIf(Not IsNull(rs_Zona!oficdepto), rs_Zona!oficdepto, " ")
        Aux_FD_CodPostal = IIf(Not IsNull(rs_Zona!codigopostal), rs_Zona!codigopostal, " ")
        Aux_FD_Localidad = IIf(Not IsNull(rs_Zona!locdesc), rs_Zona!locdesc, " ")
    Else
        Flog.writeline "No se encontró el domicilio y la localidad para la empresa"
        Aux_Empresa_Domicilio = " "
        Aux_Empresa_CodPostal = " "
    End If

    'Busco la provincia
    StrSql = " SELECT * FROM detdom " & _
             " INNER JOIN cabdom ON detdom.domnro = cabdom.domnro " & _
             " INNER JOIN provincia ON provincia.provnro = detdom.provnro " & _
             " WHERE cabdom.ternro = " & rs_Empresa!ternro
    OpenRecordset StrSql, rs_Provincia
    If Not rs_Provincia.EOF Then
        Aux_FD_Provincia = IIf(Not IsNull(rs_Provincia!provcodext), rs_Provincia!provcodext, " ")
    End If

    'CUIT
    StrSql = " SELECT cuit.nrodoc FROM tercero " & _
             " INNER JOIN ter_doc cuit ON (tercero.ternro = cuit.ternro AND cuit.tidnro = 6) " & _
             " WHERE tercero.ternro= " & rs_Empresa!ternro
    OpenRecordset StrSql, rs_Cuit
    If Not rs_Cuit.EOF Then
        Aux_Empresa_Cuit = Left(CStr(rs_Cuit!nrodoc), 13)
    Else
        Flog.writeline "No se encontró el cuit para la empresa"
        Aux_Empresa_Cuit = " "
    End If

    'Telefono
    StrSql = " SELECT * FROM telefono WHERE telefono.domnro = " & rs_Zona!domnro & _
             " AND telefono.teldefault = -1 "
    If rs_Telefono.State = adStateOpen Then rs_Telefono.Close
    OpenRecordset StrSql, rs_Telefono
    If Not rs_Telefono.EOF Then
        Aux_Empresa_Telefono = rs_Telefono!telnro
        Aux_FD_Telefono = rs_Telefono!telnro
    Else
        Flog.writeline "No se encontró el telefono para la empresa"
        Aux_Empresa_Telefono = " "
    End If

    'nro de inscripcion
    StrSql = "SELECT * FROM estr_cod WHERE estrnro =" & rs_Empresa!estrnro
    StrSql = StrSql & " AND tcodnro = 18"
    OpenRecordset StrSql, rs_Estr_Cod
    If Not rs_Estr_Cod.EOF Then
        Aux_Empresa_Nro_Inscripcion = CStr(rs_Estr_Cod!nrocod)
    Else
        Flog.writeline "No se encontró el codigo interno 18 para la inscripcion para la empresa"
        Aux_Empresa_Nro_Inscripcion = " "
    End If
    
    
    
    
    
Flog.writeline "Busco los empleados a procesar"
'---------------------------------------------------------------
'Busco los empleados a procesar
StrSql = "SELECT DISTINCT empleado.* FROM  empleado "
StrSql = StrSql & " INNER JOIN batch_empleado ON batch_empleado.ternro = empleado.ternro "
StrSql = StrSql & " INNER JOIN his_estructura ON his_estructura.ternro = empleado.ternro and his_estructura.tenro = 10 "
StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = his_estructura.estrnro AND empresa.empnro =" & Empresa
StrSql = StrSql & " WHERE batch_empleado.bpronro = " & NroProcesoBatch
Flog.writeline "SQL " & StrSql
OpenRecordset StrSql, rs_Empleados

'Seteo el progreso
Progreso = 0
CEmpleadosAProc = rs_Empleados.RecordCount
If CEmpleadosAProc = 0 Then
    Flog.writeline "No hay empleados que procesar "
   CEmpleadosAProc = 1
End If
IncPorc = (100 / CEmpleadosAProc)


Do While Not rs_Empleados.EOF
    primerDetalle = True
    Flog.writeline "Empleado " & rs_Empleados!empleg
    
    Flog.writeline "Depuracion del Temporario"
    ''Depuracion del Temporario
    StrSql = "SELECT * FROM rep_ps62 "
    StrSql = StrSql & " WHERE empresa = " & Empresa
    StrSql = StrSql & " AND iduser = '" & IdUser & "'"
    StrSql = StrSql & " AND ternro = " & rs_Empleados!ternro
    'StrSql = StrSql & " AND hfecha = " & ConvFecha(HFecha)
    'FGZ - 28/11/2005
    StrSql = StrSql & " AND fecha = " & ConvFecha(HFecha)
    OpenRecordset StrSql, rs_rep_PS62
    
    Do While Not rs_rep_PS62.EOF
        Flog.writeline "Detalles"
        'Detalles
        StrSql = "DELETE FROM rep_ps62_det "
        StrSql = StrSql & " WHERE empresa = " & Empresa
        StrSql = StrSql & " AND iduser = '" & IdUser & "'"
        StrSql = StrSql & " AND repnro = " & rs_rep_PS62!repnro
        objConn.Execute StrSql, , adExecuteNoRecords
    
        rs_rep_PS62.MoveNext
    Loop
    
    Flog.writeline "Encabezados"
    'Encabezados
    StrSql = "DELETE FROM rep_ps62 "
    StrSql = StrSql & " WHERE empresa = " & Empresa
    StrSql = StrSql & " AND iduser = '" & IdUser & "'"
    StrSql = StrSql & " AND ternro = " & rs_Empleados!ternro
    'StrSql = StrSql & " AND hfecha = " & ConvFecha(HFecha)
    'FGZ - 28/11/2005
    StrSql = StrSql & " AND fecha = " & ConvFecha(HFecha)
    objConn.Execute StrSql, , adExecuteNoRecords

    StrSql = "SELECT * FROM  tercero "
    StrSql = StrSql & " WHERE ternro =" & rs_Empleados!ternro
    OpenRecordset StrSql, rs_Tercero

    If Not rs_Tercero.EOF Then
        'buscar el documento ppal del empleado, dde. el documento se de sistema (ppal)
        Flog.writeline "buscar el documento ppal del empleado, dde. el documento se de sistema (ppal)"
        StrSql = " SELECT * FROM ter_doc "
        StrSql = StrSql & " INNER JOIN tipodocu ON ter_doc.tidnro = tipodocu.tidnro "
        StrSql = StrSql & " WHERE ternro = " & rs_Tercero!ternro
        StrSql = StrSql & " AND ter_doc.tidnro <= 4"
        Flog.writeline "SQL " & StrSql
        OpenRecordset StrSql, rs_Doc
        If Not rs_Doc.EOF Then
            Aux_Empleado_Doc = IIf(IsNull(rs_Doc!tidsigla), "X", rs_Doc!tidsigla) & "-" & IIf(IsNull(rs_Doc!nrodoc), "00000000", rs_Doc!nrodoc)
        Else
            Flog.writeline "no se encontró ningun documento disponible"
            Aux_Empleado_Doc = ""
        End If
        'Buscar el CUIL
        Flog.writeline "Buscar el CUIL"
        StrSql = " SELECT * from ter_doc WHERE ternro = " & rs_Tercero!ternro
        StrSql = StrSql & " AND tidnro = 10"
        OpenRecordset StrSql, rs_Cuil
        If Not rs_Cuil.EOF Then
            Aux_Empleado_Cuil = rs_Cuil!nrodoc
            Aux_Empleado_Afiliado = rs_Cuil!nrodoc
        Else
            Flog.writeline "El Registro de C.U.I.L. no est  disponible"
            Aux_Empleado_Cuil = ""
            Aux_Empleado_Afiliado = ""
        End If
        Aux_Empleado_Apenom = rs_Tercero!terape & " " & IIf(Not IsNull(rs_Tercero!terape2), rs_Tercero!terape2, "") & " " & rs_Tercero!ternom & " " & IIf(Not IsNull(rs_Tercero!ternom2), rs_Tercero!ternom2, "")
        Aux_Empleado_FechaNacimiento = rs_Tercero!terfecnac
        
        'busco la empresa del empleado
        Flog.writeline "busco la empresa del empleado"
        StrSql = " SELECT * FROM his_estructura "
        StrSql = StrSql & " INNER JOIN estructura emp ON emp.estrnro = his_estructura.estrnro "
        StrSql = StrSql & " INNER JOIN empresa ON empresa.estrnro = emp.estrnro AND empresa.empnro =" & Empresa
        StrSql = StrSql & " WHERE his_estructura.ternro = " & rs_Empleados!ternro & " AND "
        StrSql = StrSql & " his_estructura.tenro = 10 "
        StrSql = StrSql & " ORDER BY his_estructura.htetdesde"
        If rs_HisEstructura.State = adStateOpen Then rs_HisEstructura.Close
        OpenRecordset StrSql, rs_HisEstructura
        
        'Inicializo
        Flog.writeline "Inicializo"
        For i = 1 To 100
            Aux_Tarea_Dias(i) = 0
            Aux_Tarea_Meses(i) = 0
            Aux_Tarea_Anios(i) = 0
        Next i
        
        
        i = 1
        CantidadTareas = 0
        
        'FGZ - Se calcula a la fecha de baja del empleado salvo que sea mayor que la fecha hasta pasada por parametro
        'Busco la ultima fase del empleado y comparo las fechas
        Aux_HFecha = HFecha
        StrSql = "SELECT * FROM fases "
        StrSql = StrSql & " WHERE real = -1 "
        StrSql = StrSql & " AND empleado = " & rs_Empleados!ternro
        StrSql = StrSql & " AND altfec <= " & ConvFecha(HFecha)
        StrSql = StrSql & " ORDER BY altfec "
        If rs_Fases.State = adStateOpen Then rs_Fases.Close
        OpenRecordset StrSql, rs_Fases
        If Not rs_Fases.EOF Then
            rs_Fases.MoveLast
            If Not EsNulo(rs_Fases!bajfec) Then
                HFecha = IIf(rs_Fases!bajfec < HFecha, rs_Fases!bajfec, HFecha)
            End If
        Else
            Flog.writeline "No se encontraron fases reales anteriores a la fecha hasta " & HFecha
        End If
        
        
        Do While Not rs_HisEstructura.EOF
            
            Contempla = True
            If IsNull(rs_HisEstructura!htethasta) Then
                If rs_HisEstructura!htetdesde > HFecha Then
                    Contempla = False
                Else
                    Aux_Tarea(i) = " "
                    Aux_Tarea_Desde(i) = rs_HisEstructura!htetdesde
                    'Aux_Tarea_Hasta(i) = HFecha
                    
                    StrSql = "SELECT * FROM fases "
                    StrSql = StrSql & " WHERE real = -1 "
                    StrSql = StrSql & " AND empleado = " & rs_Empleados!ternro
                    StrSql = StrSql & " AND ( bajfec <= " & ConvFecha(HFecha)
                    StrSql = StrSql & " OR bajfec is null) "
                    OpenRecordset StrSql, rs_Fases
                    If Not rs_Fases.EOF Then
                        rs_Fases.MoveFirst
                        Aux_Tarea_Desde(i) = rs_Fases!altfec
                    
                        rs_Fases.MoveLast
                        Aux_Extincion = True
                        Aux_Extincion_Fecha = IIf(Not EsNulo(rs_Fases!bajfec), rs_Fases!bajfec, HFecha)
                        Aux_Tarea_Hasta(i) = IIf(Not EsNulo(rs_Fases!bajfec), rs_Fases!bajfec, HFecha)
                        
                        'FGZ - 07/03/2006
                        If Resta_Uno_Configurado Then
                            ' la fecha hasta esta seteado con el fin de la fases y esta configurado Resta_Uno(columna tipo DIA en confrep)
                            ' ==> debo restar un dia al final
                            If Not EsNulo(rs_Fases!bajfec) Then
                                Resta_Uno = True
                            End If
                        End If
                        
                        Aux_Extincion_Nro = " "
                    Else
                        'no se extingio el contrato
                        Aux_Extincion = False
                        Aux_Extincion_Fecha = ""
                        Aux_Extincion_Nro = " "
                    End If
                End If
            Else
                If rs_HisEstructura!htetdesde > HFecha Then
                    Contempla = False
                Else
                    StrSql = "SELECT * FROM fases "
                    StrSql = StrSql & " WHERE real = -1 "
                    StrSql = StrSql & " AND empleado = " & rs_Empleados!ternro
                    StrSql = StrSql & " AND ( bajfec <= " & ConvFecha(rs_HisEstructura!htethasta)
                    StrSql = StrSql & " OR bajfec is null) "
                    StrSql = StrSql & " ORDER BY bajfec desc "
                    OpenRecordset StrSql, rs_Fases
                    
                    If rs_Fases.EOF Then
                        Contempla = False
                    Else
                        Aux_Tarea(i) = " "
                        Aux_Tarea_Desde(i) = rs_HisEstructura!htetdesde
                        Aux_Tarea_Hasta(i) = IIf(Not EsNulo(rs_Fases!bajfec), rs_Fases!bajfec, rs_HisEstructura!htethasta)
                        Aux_Extincion_Fecha = IIf(Not EsNulo(rs_Fases!bajfec), rs_Fases!bajfec, rs_HisEstructura!htethasta)
                        
                        'FGZ - 07/03/2006
                        If Resta_Uno_Configurado Then
                            ' la fecha hasta esta seteado con el fin de la fases y esta configurado Resta_Uno(columna tipo DIA en confrep)
                            ' ==> debo restar un dia al final
                            If Not EsNulo(rs_Fases!bajfec) Then
                                Resta_Uno = True
                            End If
                        End If
                        
                    End If
                End If
                
                'Buscar si se extingio el contrato y poner la fecha
                Aux_Extincion = True
                Aux_Extincion_Nro = " "
            End If
            
            If Contempla Then
                'FGZ - 28/11/2005
                If Aux_Tarea_Hasta(i) > HFecha Then
                    Aux_Tarea_Hasta(i) = HFecha
                End If
                'FGZ - 07/03/2006 - Resta un dia
                CantidadTareas = CantidadTareas + 1
                
                'Calcular la antiguedad
                'Call DIF_FECHAS3(Aux_Tarea_Desde(i), Aux_Tarea_Hasta(i), Aux_Tarea_Dias(i), Aux_Tarea_Meses(i), Aux_Tarea_Anios(i))
                
                'FGZ - 07/03/2006 - Resta un dia si esta configurado la columna de tipo DIA en el confrep
                Call DIF_FECHAS3(Aux_Tarea_Desde(i), IIf(Resta_Uno, Aux_Tarea_Hasta(i) - 1, Aux_Tarea_Hasta(i)), Aux_Tarea_Dias(i), Aux_Tarea_Meses(i), Aux_Tarea_Anios(i))
                
                i = i + 1
            End If
                
            rs_HisEstructura.MoveNext
        Loop
        
        
        'Inicio = 0
        Indice_Inicio = 1
        Indice_Fin = 5
        If Indice_Fin > CantidadTareas Then
            Indice_Fin = CantidadTareas
        End If
        If (CantidadTareas / 5) > Fix(CantidadTareas / 5) Then
            CantidadPaginas = Fix(CantidadTareas / 5) + 1
        Else
            CantidadPaginas = Fix(CantidadTareas / 5)
        End If
        
        
        For J = 1 To CantidadPaginas
        
            'Inicializo
            Aux_Total_Lic_Dias = 0
            Aux_Total_Lic_Meses = 0
            Aux_Total_Lic_Anios = 0
            
            For i = 1 To 5
                Aux_Lic_Dias(i) = 0
                Aux_Lic_Meses(i) = 0
                Aux_Lic_Anios(i) = 0
            Next i
        
            'Inicializo El total de dias, meses y años de las tareas
            Aux_Total_Tiempo_Dias = 0
            Aux_Total_Tiempo_Meses = 0
            Aux_Total_Tiempo_Anios = 0
        
            'calculo el total de tiempo
            For i = Indice_Inicio To Indice_Fin 'indice_inicio + 5
                Aux_Total_Tiempo_Dias = Aux_Total_Tiempo_Dias + Aux_Tarea_Dias(i)
                Aux_Total_Tiempo_Meses = Aux_Total_Tiempo_Meses + Aux_Tarea_Meses(i)
                Aux_Total_Tiempo_Anios = Aux_Total_Tiempo_Anios + Aux_Tarea_Anios(i)
            'Next i
                If Aux_Total_Tiempo_Dias >= 30 Then
                    Aux_Total_Tiempo_Dias = Aux_Total_Tiempo_Dias - 30
                    Aux_Total_Tiempo_Meses = Aux_Total_Tiempo_Meses + 1
                End If
                If Aux_Total_Tiempo_Meses >= 12 Then
                    Aux_Total_Tiempo_Anios = Aux_Total_Tiempo_Anios + 1
                    Aux_Total_Tiempo_Meses = Aux_Total_Tiempo_Meses - 12
                End If
            Next i
            
            'Buscar las licencias en los rangos de las tareas
            StrSql = "SELECT * FROM emp_lic "
            StrSql = StrSql & " WHERE empleado = " & rs_Empleados!ternro
            StrSql = StrSql & " AND tdnro in ( " & Lista_Licencias & ") "
            StrSql = StrSql & " AND ( (elfechadesde >=" & ConvFecha(Aux_Tarea_Desde(Indice_Inicio))
            StrSql = StrSql & " AND elfechahasta <=" & ConvFecha(Aux_Tarea_Hasta(Indice_Inicio)) & ")"
            For i = Indice_Inicio + 1 To Indice_Fin
                If Not IsNull(Aux_Tarea(i)) And Aux_Tarea(i) = " " Then
                    StrSql = StrSql & " OR (elfechadesde >=" & ConvFecha(Aux_Tarea_Desde(i))
                    StrSql = StrSql & " AND elfechahasta <=" & ConvFecha(Aux_Tarea_Hasta(i)) & ")"
                End If
            Next i
            StrSql = StrSql & ")"
            StrSql = StrSql & " ORDER BY elfechadesde "
            OpenRecordset StrSql, rs_Licencias
            
            i = 1
            Do While Not rs_Licencias.EOF And (i <= 5)
                Aux_Lic_Desde(i) = rs_Licencias!elfechadesde
                Aux_Lic_Hasta(i) = rs_Licencias!elfechahasta
                    
                    'Calcular la antiguedad
                    Call DIF_FECHAS3(Aux_Lic_Desde(i), Aux_Lic_Hasta(i), Aux_Lic_Dias(i), Aux_Lic_Meses(i), Aux_Lic_Anios(i))
                    i = i + 1
                    
                rs_Licencias.MoveNext
            Loop
            
            'calculo el total de tiempo
            For i = 1 To 5
                Aux_Total_Lic_Dias = Aux_Total_Lic_Dias + Aux_Lic_Dias(i)
                Aux_Total_Lic_Meses = Aux_Total_Lic_Meses + Aux_Lic_Meses(i)
                Aux_Total_Lic_Anios = Aux_Total_Lic_Anios + Aux_Lic_Anios(i)
            Next i
            If Aux_Total_Lic_Dias >= 30 Then
                Aux_Total_Lic_Dias = Aux_Total_Lic_Dias - 30
                Aux_Total_Lic_Meses = Aux_Total_Lic_Meses + 1
            End If
            If Aux_Total_Lic_Meses >= 12 Then
                Aux_Total_Lic_Anios = Aux_Total_Lic_Anios + 1
                Aux_Total_Lic_Meses = Aux_Total_Lic_Meses - 12
            End If
        
        
        
            'FGZ - 28/11/2005
            'chequeo la fecha de extinsion
            'esta fecha > fecha hasta ==> pongo la fecha hasta
            If Not EsNulo(Aux_Extincion_Fecha) Then
                If Aux_Extincion_Fecha > HFecha Then
                    Aux_Extincion_Fecha = HFecha
                End If
            End If
        
            '-----------------------------------------------------------------------------
            'Inserto en Rep_PS62
            StrSql = "INSERT INTO rep_PS62 (bpronro,empresa,iduser,fecha,hfecha,hora,"
            StrSql = StrSql & " certificante, Domicilio,codpostal,cuit,nro_inscrip,empactiv,emptelef,fuente_doc,"
            StrSql = StrSql & " cuil,ternro,empleapenom,fechanac,nro_afiliado,ci_nro,expedido_por,empleDocumento,"
            StrSql = StrSql & " extincion,"
            If Not EsNulo(Aux_Extincion_Fecha) Then
                StrSql = StrSql & " extincion_fecha,"
            End If
            StrSql = StrSql & "extincion_nro,"
            'Tareas
            StrSql = StrSql & " tarea1,tar1_desde,tar1_hasta,tar1_dias,tar1_meses,tar1_anios,"
            Aux_Indice = 1
            For i = Indice_Inicio + 1 To Indice_Fin
                Aux_Indice = Aux_Indice + 1
                If Not IsNull(Aux_Tarea(i)) And Aux_Tarea(i) = " " Then
                    StrSql = StrSql & " tarea" & Aux_Indice & ",tar" & Aux_Indice & "_desde,tar" & Aux_Indice & "_hasta,tar" & Aux_Indice & "_dias,tar" & Aux_Indice & "_meses,tar" & Aux_Indice & "_anios,"
                End If
            Next i
            StrSql = StrSql & " total_tiempo_dias,total_tiempo_meses,total_tiempo_anios,"
            'Licencias
            Aux_Indice = 0
            For i = Indice_Inicio To Indice_Fin
                Aux_Indice = Aux_Indice + 1
                If Not IsNull(Aux_Lic_Desde(i)) And Aux_Lic_Desde(i) <> "00:00:00" Then
                    StrSql = StrSql & " lic" & Aux_Indice & "_desde,lic" & Aux_Indice & "_hasta,lic" & Aux_Indice & "_ded_dias,lic" & Aux_Indice & "_ded_meses,lic" & Aux_Indice & "_ded_anios,"
                End If
            Next i
            StrSql = StrSql & " total_lic_ded_dias,total_lic_ded_mes,total_lic_ded_anio,"
            StrSql = StrSql & " fd_calle,fd_nro,fd_piso,fd_depto,fd_codpostal,fd_localidad,fd_provincia,fd_telefono,fd_observaciones,"
            StrSql = StrSql & " autoriz_apenom,autoriz_docu,autoriz_prov_emis,"
            StrSql = StrSql & " certifi_correponde,certifi_doc_tipo,certifi_doc_nro,certifi_expedida"
            StrSql = StrSql & " ) VALUES ("
            
            StrSql = StrSql & bpronro & ","
            StrSql = StrSql & Empresa & ","
            StrSql = StrSql & "'" & Left(IdUser, 20) & "',"
            'StrSql = StrSql & ConvFecha(Fecha) & ","
            'FGZ - 28/11/2005
            StrSql = StrSql & ConvFecha(Aux_HFecha) & ","
            StrSql = StrSql & ConvFecha(HFecha) & ","
            StrSql = StrSql & "'" & Left(Hora, 10) & "',"
            
            StrSql = StrSql & "'" & Left(Aux_Empresa_Certificante, 60) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_Domicilio, 100) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_CodPostal, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_Cuit, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_Nro_Inscripcion, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_Actividad, 60) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empresa_Telefono, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Fuente_Doc, 60) & "',"
            
            StrSql = StrSql & "'" & Left(Aux_Empleado_Cuil, 30) & "',"
            StrSql = StrSql & rs_Empleados!ternro & ","
            StrSql = StrSql & "'" & Left(Aux_Empleado_Apenom, 60) & "',"
            'StrSql = StrSql & "'" & Aux_Empleado_FechaNacimiento & "',"
            'StrSql = StrSql & "" & ConvFecha(Aux_Empleado_FechaNacimiento) & ","
            StrSql = StrSql & "'" & Format(Aux_Empleado_FechaNacimiento, "yyyy-mm-dd") & "',"
            StrSql = StrSql & "'" & Left(Aux_Empleado_Afiliado, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_CI_Nro, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Expedido_por, 20) & "',"
            StrSql = StrSql & "'" & Left(Aux_Empleado_Doc, 30) & "',"
            
            StrSql = StrSql & CInt(Aux_Extincion) & ","
            'StrSql = StrSql & "'" & Aux_Extincion_Fecha & "',"
            If Not EsNulo(Aux_Extincion_Fecha) Then
                'StrSql = StrSql & ConvFecha(C_Date(Aux_Extincion_Fecha)) & ","
                StrSql = StrSql & "'" & Format(Aux_Extincion_Fecha, "yyyy-mm-dd") & "',"
            End If
            'StrSql = StrSql & "" & IIf(Not EsNulo(Aux_Extincion_Fecha), ConvFecha(CDate(Aux_Extincion_Fecha)), "NULL") & ","
            StrSql = StrSql & "'" & Left(Aux_Extincion_Nro, 10) & "',"
            
            'tareas
            StrSql = StrSql & "'" & Left(Aux_Tarea(Indice_Inicio), 100) & "',"
            StrSql = StrSql & "'" & Format(Aux_Tarea_Desde(Indice_Inicio), "yyyy-mm-dd") & "',"
            StrSql = StrSql & "'" & Format(Aux_Tarea_Hasta(Indice_Inicio), "yyyy-mm-dd") & "',"
            StrSql = StrSql & "" & Left(Aux_Tarea_Dias(Indice_Inicio), 2) & ","
            StrSql = StrSql & "" & Left(Aux_Tarea_Meses(Indice_Inicio), 2) & ","
            StrSql = StrSql & "" & Left(Aux_Tarea_Anios(Indice_Inicio), 2) & ","
            
            For i = Indice_Inicio + 1 To Indice_Fin
                If Not IsNull(Aux_Tarea(i)) And Aux_Tarea(i) = " " Then
                    StrSql = StrSql & "'" & Left(Aux_Tarea(i), 100) & "',"
                    StrSql = StrSql & "'" & Format(Aux_Tarea_Desde(i), "yyyy-mm-dd") & "',"
                    StrSql = StrSql & "'" & Format(Aux_Tarea_Hasta(i), "yyyy-mm-dd") & "',"
                    StrSql = StrSql & "" & Left(Aux_Tarea_Dias(i), 2) & ","
                    StrSql = StrSql & "" & Left(Aux_Tarea_Meses(i), 2) & ","
                    StrSql = StrSql & "" & Left(Aux_Tarea_Anios(i), 2) & ","
                End If
            Next i
            'Totales
            StrSql = StrSql & "" & Left(Aux_Total_Tiempo_Dias, 2) & ","
            StrSql = StrSql & "" & Left(Aux_Total_Tiempo_Meses, 2) & ","
            StrSql = StrSql & "" & Left(Aux_Total_Tiempo_Anios, 2) & ","
            
            'Licencias
            For i = Indice_Inicio To Indice_Fin
                If Not IsNull(Aux_Lic_Desde(i)) And Aux_Lic_Desde(i) <> "00:00:00" Then
                    StrSql = StrSql & "'" & Format(Aux_Lic_Desde(i), "yyyy-mm-dd") & "',"
                    StrSql = StrSql & "'" & Format(Aux_Lic_Hasta(i), "yyyy-mm-dd") & "',"
                    StrSql = StrSql & "" & Left(Aux_Lic_Dias(i), 2) & ","
                    StrSql = StrSql & "" & Left(Aux_Lic_Meses(i), 2) & ","
                    StrSql = StrSql & "" & Left(Aux_Lic_Anios(i), 2) & ","
                End If
            Next i
            'Totales
            StrSql = StrSql & "" & Left(Aux_Total_Lic_Dias, 2) & ","
            StrSql = StrSql & "" & Left(Aux_Total_Lic_Meses, 2) & ","
            StrSql = StrSql & "" & Left(Aux_Total_Lic_Anios, 2) & ","
            
            StrSql = StrSql & "'" & Left(Aux_FD_Calle, 60) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Nro, 5) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Piso, 5) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Dpto, 3) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_CodPostal, 10) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Localidad, 60) & "',"
            StrSql = StrSql & "'" & Left$(Aux_FD_Provincia, 2) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Telefono, 20) & "',"
            StrSql = StrSql & "'" & Left(Aux_FD_Observaciones, 100) & "',"
            
            StrSql = StrSql & "'" & Left(Aux_Autoriz_Apenom, 60) & "',"
            StrSql = StrSql & "'" & Left(Aux_Autoriz_Docu, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Autoriz_Prov_Emis, 3) & "',"
            
            StrSql = StrSql & "'" & Left(Aux_Certifi_Corresponde, 30) & "',"
            StrSql = StrSql & "'" & Left(Aux_Certifi_Doc_Tipo, 3) & "',"
            StrSql = StrSql & "'" & Left(Aux_Certifi_Doc_Nro, 8) & "',"
            StrSql = StrSql & "'" & Left(Aux_Certifi_Expedida, 3) & "'"
            
            StrSql = StrSql & ")"
            Flog.writeline "SQL ==> " & StrSql
            objConn.Execute StrSql, , adExecuteNoRecords
            Aux_RepNro = getLastIdentity(objConn, "rep_PS62")
            Flog.writeline "LastIdentity " & Aux_RepNro
        
        
            'Correccion en el calculo del intervalo
            Aux_Anio = (11 - (Aux_Total_Tiempo_Anios))
            'Lleno los detalles
            For i = Indice_Inicio To Indice_Fin
                If Not IsNull(Aux_Tarea(i)) And Aux_Tarea(i) = " " Then
                    MesActual = Month(Aux_Tarea_Desde(i))
                    AnioActual = Year(Aux_Tarea_Desde(i))
                    Continuar = True
                    Do While Continuar
                        'Remuneracion
                        Aux_Acum_Remu = 0
                        StrSql = " SELECT * FROM acu_mes "
                        StrSql = StrSql & " WHERE ternro =" & rs_Empleados!ternro
                        StrSql = StrSql & " AND acunro =" & Acum_Remu
                        StrSql = StrSql & " AND amanio =" & AnioActual
                        StrSql = StrSql & " AND ammes =" & MesActual
                        OpenRecordset StrSql, rs_Acu_Mes
                        If Not rs_Acu_Mes.EOF Then
                            Aux_Acum_Remu = rs_Acu_Mes!ammonto
                        End If
                        'SAC
                        Aux_Acum_Sac = 0
                        StrSql = " SELECT * FROM acu_mes "
                        StrSql = StrSql & " WHERE ternro =" & rs_Empleados!ternro
                        StrSql = StrSql & " AND acunro =" & Acum_Sac
                        StrSql = StrSql & " AND amanio =" & AnioActual
                        StrSql = StrSql & " AND ammes =" & MesActual
                        OpenRecordset StrSql, rs_Acu_Mes
                        If Not rs_Acu_Mes.EOF Then
                            Aux_Acum_Sac = rs_Acu_Mes!ammonto
                        End If
                        
                        Aux_Licencias = 0
                        AuxFecha_inicio = CDate("01/" & MesActual & "/" & AnioActual)
                        If AuxFecha_inicio < Aux_Tarea_Desde(i) Then
                            Aux_Licencias = Day(Aux_Tarea_Desde(i))
                            AuxFecha_inicio = Aux_Tarea_Desde(i)
                        End If
                        
                        If MesActual <> 12 Then
                            AuxFecha = CDate("01/" & MesActual + 1 & "/" & AnioActual) - 1
                        Else
                            AuxFecha = CDate("31/12/" & AnioActual)
                        End If
                        If AuxFecha > Aux_Tarea_Hasta(i) Then
                            AuxFecha = Aux_Tarea_Hasta(i)
                            Aux_Licencias = 30 - Day(Aux_Tarea_Hasta(i))
                        End If
                                    
                        'Puesto
                        StrSql = " SELECT * FROM his_estructura " & _
                                 " INNER JOIN estructura ON estructura.estrnro = his_estructura.estrnro " & _
                                 " WHERE his_estructura.ternro = " & rs_Empleados!ternro & " AND " & _
                                 " his_estructura.tenro = 4 AND " & _
                                 " (his_estructura.htetdesde <= " & ConvFecha(AuxFecha) & ") AND " & _
                                 " ((" & ConvFecha(AuxFecha) & " <= his_estructura.htethasta) or (his_estructura.htethasta is null))" & _
                                 " ORDER BY his_estructura.htetdesde"
                        If rs_Estructura.State = adStateOpen Then rs_Estructura.Close
                        OpenRecordset StrSql, rs_Estructura
                        If Not rs_Estructura.EOF Then
                            Aux_Puesto = rs_Estructura!estrdabr
                        End If
                        
                        'Buscar las licencias en el mes y anño actual
                        StrSql = "SELECT * FROM emp_lic "
                        StrSql = StrSql & " WHERE empleado = " & rs_Empleados!ternro
                        StrSql = StrSql & " AND tdnro in ( " & Lista_Licencias & ") "
                        StrSql = StrSql & " AND (elfechadesde >=" & ConvFecha(AuxFecha_inicio)
                        StrSql = StrSql & " AND elfechadesde <=" & ConvFecha(AuxFecha) & ")"
                        StrSql = StrSql & " ORDER BY elfechadesde "
                        OpenRecordset StrSql, rs_Licencias
                        
                        Do While Not rs_Licencias.EOF
                            Aux_Licencias = Aux_Licencias + CantidadDeDias(rs_Licencias!elfechadesde, rs_Licencias!elfechahasta, AuxFecha_inicio, AuxFecha) - 1
                        
                            rs_Licencias.MoveNext
                        Loop
                        
                        Aux_Horas = 0
                        If Aux_Licencias = 0 Then
                            Aux_Meses = 1
                            Aux_Dias = 0
                        Else
                            Aux_Meses = 0
                            If MesActual = 2 Then 'Febrero
                                If Biciesto(AnioActual) Then
                                    If Aux_Licencias >= 29 Then
                                        Aux_Dias = 0
                                    Else
                                        Aux_Dias = 29 - Aux_Licencias
                                    End If
                                Else
                                    If Aux_Licencias >= 28 Then
                                        Aux_Dias = 0
                                    Else
                                        Aux_Dias = 28 - Aux_Licencias
                                    End If
                                End If
                            Else
                                If Aux_Licencias > 30 Then
                                    Aux_Dias = 0
                                Else
                                    Aux_Dias = 30 - Aux_Licencias
                                End If
                            End If
                        End If
                        
                        'correccion para que cuente el primer dia trabajado
                        If (primerDetalle) And (Aux_Dias <> 0) Then
                            Aux_Dias = Aux_Dias + 1
                        End If
                        primerDetalle = Not primerDetalle
                        
                        If (Aux_Meses = 0) And (Aux_Dias = 0) Then
                            Aux_Dias = 1
                        End If
                        
                        
                        'FGZ - 07/03/2006
                        If Resta_Uno Then
                            ' si es el ultimo mes deberia restarle 1 dia
                            If (MesActual = Month(Aux_Tarea_Hasta(i)) And AnioActual = Year(Aux_Tarea_Hasta(i))) Then
                                If Aux_Meses = 1 Then
                                    Aux_Dias = 29
                                    Aux_Meses = 0
                                Else
                                    Aux_Dias = Aux_Dias - 1
                                End If
                                
                            End If
                        End If
                        ' ---------------------------------------------------------------
                        ' Detalle
                        'Inserto en Rep_PS62_det
                        StrSql = "INSERT INTO rep_PS62_det (repnro,anio,bpronro,empresa,iduser,fecha,hora,"
                        StrSql = StrSql & " ternro,pliqanio,pliqmes,remuneracion,sac,"
                        StrSql = StrSql & " puesto,caracter,antmeses,antdias,anthoras"
                        StrSql = StrSql & " ) VALUES ("
                        StrSql = StrSql & Aux_RepNro & ","
                        StrSql = StrSql & Aux_Anio & ","
                        StrSql = StrSql & bpronro & ","
                        StrSql = StrSql & Empresa & ","
                        StrSql = StrSql & "'" & IdUser & "',"
                        'StrSql = StrSql & ConvFecha(Fecha) & ","
                        'FGZ - 28/11/2005
                        StrSql = StrSql & ConvFecha(Aux_HFecha) & ","
                        StrSql = StrSql & "'" & Hora & "',"
                        
                        StrSql = StrSql & rs_Empleados!ternro & ","
                        StrSql = StrSql & AnioActual & ","
                        StrSql = StrSql & MesActual & ","
                        StrSql = StrSql & Aux_Acum_Remu & ","
                        StrSql = StrSql & Aux_Acum_Sac & ","
                        
                        StrSql = StrSql & "'" & Aux_Puesto & "',"
                        StrSql = StrSql & "'" & Aux_Caracter & "',"
                        StrSql = StrSql & Aux_Meses & ","
                        StrSql = StrSql & Aux_Dias & ","
                        StrSql = StrSql & Aux_Horas
                        
                        StrSql = StrSql & ")"
                        Flog.writeline "SQL ==> " & StrSql
                        objConn.Execute StrSql, , adExecuteNoRecords
                        
                        '02/12/2005 - Fapi
                        'cambio en el metodo de calcular los años que se borran
                        Ultimo_Anio_Insertado = Aux_Anio
                        
                        If MesActual <> 12 Then
                            MesActual = MesActual + 1
                        Else
                            MesActual = 1
                            Aux_Anio = Aux_Anio + 1
                            AnioActual = AnioActual + 1
                        End If
                        
                        If (MesActual > Month(Aux_Tarea_Hasta(i)) And AnioActual = Year(Aux_Tarea_Hasta(i))) Or AnioActual > Year(Aux_Tarea_Hasta(i)) Then
                            Continuar = False
                        Else
                            Flog.writeline "Mes Actual " & MesActual
                            Flog.writeline "Año Actual " & AnioActual
                            Flog.writeline "Tarea " & i & " desde " & Aux_Tarea_Desde(i) & " hasta " & Aux_Tarea_Hasta(i)
                            Flog.writeline "LOOP -----------------------------------------"
                        End If
                    Loop
                End If
            Next i
        
            'Actualizo el progreso del Proceso
            Progreso = Progreso + IncPorc
            TiempoAcumulado = GetTickCount
            StrSql = "UPDATE batch_proceso SET bprcprogreso = " & Progreso & _
                     ", bprctiempo ='" & CStr((TiempoAcumulado - TiempoInicialProceso)) & _
                     "' WHERE bpronro = " & NroProcesoBatch
            objConn.Execute StrSql, , adExecuteNoRecords
            
            
            'Calculo los indices inicio y fin siguientes
            Indice_Inicio = Indice_Fin + 1
            Indice_Fin = Indice_Fin + 5
            If Indice_Fin > CantidadTareas Then
                Indice_Fin = CantidadTareas
            End If
            
        'siguiente grupo
        Next J
    Else
        Flog.writeline "No se encontró el registro del tercero " & rs_Empleados!ternro
    End If
    
    rs_Empleados.MoveNext
Loop

'Reviso que queden los datos de los ultimos 10 años
StrSql = "DELETE FROM rep_ps62_det "
StrSql = StrSql & " WHERE empresa = " & Empresa
StrSql = StrSql & " AND iduser = '" & IdUser & "'"
StrSql = StrSql & " AND repnro = " & Aux_RepNro
StrSql = StrSql & " AND anio <= " & (Ultimo_Anio_Insertado - 11) 'deja los ultimos 11 años
objConn.Execute StrSql, , adExecuteNoRecords


'Fin de la transaccion
MyCommitTrans

If rs_Confrep.State = adStateOpen Then rs_Confrep.Close
If rs_Acu_Mes.State = adStateOpen Then rs_Acu_Mes.Close
If rs_Empleados.State = adStateOpen Then rs_Empleados.Close
If rs_Fases.State = adStateOpen Then rs_Fases.Close
If rs_Cuil.State = adStateOpen Then rs_Cuil.Close
If rs_Estructura.State = adStateOpen Then rs_Estructura.Close
If rs_Tercero.State = adStateOpen Then rs_Tercero.Close
If rs_Doc.State = adStateOpen Then rs_Doc.Close
If rs_Cuit.State = adStateOpen Then rs_Cuit.Close
If rs_Empresa.State = adStateOpen Then rs_Empresa.Close
If rs_Zona.State = adStateOpen Then rs_Zona.Close
If rs_Provincia.State = adStateOpen Then rs_Provincia.Close
If rs_Telefono.State = adStateOpen Then rs_Telefono.Close
If rs_Estr_Cod.State = adStateOpen Then rs_Estr_Cod.Close
If rs_HisEstructura.State = adStateOpen Then rs_HisEstructura.Close
If rs_Licencias.State = adStateOpen Then rs_Licencias.Close
If rs_rep_PS62.State = adStateOpen Then rs_rep_PS62.Close

Set rs_Confrep = Nothing
Set rs_Acu_Mes = Nothing
Set rs_Empleados = Nothing
Set rs_Fases = Nothing
Set rs_Cuil = Nothing
Set rs_Doc = Nothing
Set rs_Tercero = Nothing
Set rs_Estructura = Nothing
Set rs_Tercero = Nothing
Set rs_Doc = Nothing
Set rs_Cuit = Nothing
Set rs_Empresa = Nothing
Set rs_Zona = Nothing
Set rs_Provincia = Nothing
Set rs_Telefono = Nothing
Set rs_Estr_Cod = Nothing
Set rs_HisEstructura = Nothing
Set rs_Licencias = Nothing
Set rs_rep_PS62 = Nothing

Exit Sub
CE:
    HuboError = True
    Flog.writeline "Error: " & Err.Description
    Flog.writeline "Ultimo sql Ejecutado: " & StrSql
    MyRollbackTrans
End Sub







Public Sub LevantarParamteros(ByVal bpronro As Long, ByVal parametros As String)
' --------------------------------------------------------------------------------------------
' Descripcion: Procedimiento para levantar los parametros pasados en batch_proceso en bprcparam
' Autor      : FGZ
' Fecha      :
' Ult. Mod   :
' Fecha      :
' --------------------------------------------------------------------------------------------
Dim pos1 As Integer
Dim pos2 As Integer
Dim aux As String

Dim Empresa As Long
Dim HFecha As Date
Dim Aux_Separador As String

Aux_Separador = "@"
' Levanto cada parametro por separado, el separador de parametros es Aux_Separador
If Not IsNull(parametros) Then
    If Len(parametros) >= 1 Then
        pos1 = 1
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        Empresa = Mid(parametros, pos1, pos2 - pos1 + 1)
        
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        HFecha = CDate(Mid(parametros, pos1, pos2 - pos1 + 1))
        
        'nombre
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        aux = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Autoriz_Apenom = aux
        'apellido
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        aux = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Autoriz_Apenom = aux & " " & Aux_Autoriz_Apenom
        Aux_Autoriz_Apenom = IIf(Not IsNull(Aux_Autoriz_Apenom), Aux_Autoriz_Apenom, " ")
        
        'Tipo doc
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        aux = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Autoriz_Docu = aux
        'nro de doc
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        aux = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Autoriz_Docu = Aux_Autoriz_Docu & "-" & aux
        Aux_Autoriz_Docu = IIf(Not IsNull(Aux_Autoriz_Docu), Aux_Autoriz_Docu, " ")
        
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        Aux_Autoriz_Prov_Emis = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Autoriz_Prov_Emis = IIf(Not IsNull(Aux_Autoriz_Prov_Emis), Aux_Autoriz_Prov_Emis, " ")
        
        'Autoriza
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        Aux_Certifi_Corresponde = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Certifi_Corresponde = IIf(Not IsNull(Aux_Certifi_Corresponde), Aux_Certifi_Corresponde, " ")
        
        'Tipo doc
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        Aux_Certifi_Doc_Tipo = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Certifi_Doc_Tipo = IIf(Not IsNull(Aux_Certifi_Doc_Tipo), Aux_Certifi_Doc_Tipo, " ")
        
        'nro de doc
        pos1 = pos2 + 2
        pos2 = InStr(pos1, parametros, Aux_Separador) - 1
        Aux_Certifi_Doc_Nro = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Certifi_Doc_Nro = IIf(Not IsNull(Aux_Certifi_Doc_Nro), Aux_Certifi_Doc_Nro, " ")
        Aux_Certifi_Doc_Nro = Replace(Aux_Certifi_Doc_Nro, ".", "")
        
        pos1 = pos2 + 2
        pos2 = Len(parametros)
        Aux_Certifi_Expedida = Mid(parametros, pos1, pos2 - pos1 + 1)
        Aux_Certifi_Expedida = IIf(Not IsNull(Aux_Certifi_Expedida), Aux_Certifi_Expedida, " ")
        
    End If
End If

'Certificado Ansses de Servicios
Call Generar_Reporte(bpronro, Empresa, HFecha)
End Sub


Public Function EsElUltimoEmpleado(ByVal rs As ADODB.Recordset, ByVal Anterior As Long) As Boolean
' --------------------------------------------------------------------------------------------
' Descripcion: Procedimiento para saber si es el ultimo empleado de la secuencia
' Autor      : FGZ
' Fecha      :
' Ult. Mod   :
' Fecha      :
' --------------------------------------------------------------------------------------------
    
    rs.MoveNext
    If rs.EOF Then
        EsElUltimoEmpleado = True
    Else
        If rs!Empleado <> Anterior Then
            EsElUltimoEmpleado = True
        Else
            EsElUltimoEmpleado = False
        End If
    End If
    rs.MovePrevious
End Function



Public Function Antiguedad(ByRef dia As Integer, ByRef mes As Integer, ByRef Anio As Integer, ByRef DiasHabiles As Integer) As Integer
' -----------------------------------------------------------------------------------
' Descripcion: Antigued.p. Calcula la antiguedad al dia de hoy de un empleado en :
'               dias hábiles(si es menor que un año) o en dias, meses y años en caso contrario.
'               Retorna 0 si no hubo error y <> 0 en caso contrario
' Autor: FGZ
' Fecha: 31/07/2003
' Ultima Modificacion:
' -----------------------------------------------------------------------------------
Dim aux1 As Long
Dim aux2 As Long
Dim aux3 As Long
Dim fecalta As Date
Dim fecbaja As Date
Dim seguir As Date
Dim q As Long
Dim NombreCampo As String
Dim rs_Fases As New ADODB.Recordset

DiasHabiles = 0

StrSql = "SELECT * FROM fases WHERE empleado = " & buliq_empleado!ternro
OpenRecordset StrSql, rs_Fases

If rs_Fases.EOF Then
    ' ERROR. El empleado no tiene fecha de alta en fases
    Antiguedad = 1
    Exit Function
Else
        fecalta = rs_Fases!altfec
        ' verificar si se trata de un registro completo(alta/baja) o solo de un alta
        If CBool(rs_Fases!estado) Then
            fecbaja = Date  ' solo es un alta ==> tomar el Today (Date)
        Else
            fecbaja = rs_Fases!bajfec   'se trata de un registro completo
        End If
        
        Call Dif_Fechas(fecalta, fecbaja, aux1, aux2, aux3)
        dia = dia + aux1
        mes = mes + aux2 + Int(dia / 30)
        Anio = Anio + aux3 + Int(mes / 12)
        dia = dia Mod 30
        mes = mes Mod 12
        
        If Anio = 0 Then
            Call DiasTrab(fecalta, fecbaja, aux1)
            DiasHabiles = DiasHabiles + aux1
        End If
        Antiguedad = 0
End If

If Anio <> 0 Then
    DiasHabiles = 0
End If

' Cierro todo y Libero
If rs_Fases.State = adStateOpen Then rs_Fases.Close
Set rs_Fases = Nothing

End Function



Public Sub DiasTrab(ByVal Desde As Date, ByVal Hasta As Date, ByRef DiasH As Long)
' ---------------------------------------------------------------------------------------------
' Descripcion: Calcula la cantidad de dias trabajados de acuerdo al turno en que se trabaja y
'              de acuerdo a los dias que figuran como feriados en la tabla de feriados.
' Autor      : FGZ
' Fecha      :
' Ultima Mod.:
' Descripcion:
' ---------------------------------------------------------------------------------------------

Dim d1 As Integer
Dim d2 As Integer
Dim aux As Integer
Dim aux2 As Integer
Dim dxsem As Integer

Dim rs_pais As New ADODB.Recordset
Dim rs_feriados As New ADODB.Recordset

    dxsem = 5
    
    d1 = Weekday(Desde)
    d2 = Weekday(Hasta)
    
    aux = DateDiff("d", Desde, Hasta) + 1
    If aux < 7 Then
        DiasH = Minimo(aux, dxsem)
    Else
        If aux = 7 Then
            DiasH = dxsem
        Else
            aux2 = 8 - d1 + d2
            If aux2 < 7 Then
                aux2 = Minimo(aux2, dxsem)
            Else
                If aux2 = 7 Then
                    aux2 = dxsem
                End If
            End If
            
            If aux2 >= 7 Then
                aux2 = Abs(aux2 - 7) + Int(aux2 / 7) * dxsem
            Else
                aux2 = aux2 + Int((aux2 - aux2) / 7) * dxsem
            End If
        End If
    End If
    
    aux = 0
    
    StrSql = "SELECT * FROM pais INNER JOIN tercero ON tercero.paisnro = pais.paisnro WHERE tercero.ternro = " & buliq_empleado!ternro
    OpenRecordset StrSql, rs_pais
    
    If Not rs_pais.EOF Then
        ' Resto los Feriados Nacionales
        StrSql = "SELECT * FROM feriado WHERE tipferinro = 2 " & _
                 " AND fericodext = " & rs_pais!paisnro & _
                 " AND ferifecha >= " & ConvFecha(Desde) & _
                 " AND ferifecha < " & ConvFecha(Hasta)
        OpenRecordset StrSql, rs_feriados
        
        Do While Not rs_feriados.EOF
            If Weekday(rs_feriados!ferifecha) > 1 Then
                DiasH = DiasH - 1
            End If
            
            ' Siguiente Feriado
            rs_feriados.MoveNext
        Loop
    End If


    ' Resto los feriados por Convenio
    StrSql = "SELECT * FROM empleado INNER JOIN his_estructura ON empleado.ternro = his_estructura.ternro " & _
             " INNER JOIN fer_estr ON fer_estr.tenro = his_estructura.tenro " & _
             " INNER JOIN feriado ON fer_estr.ferinro = feriado.ferinro " & _
             " WHERE empleado.ternro = " & buliq_empleado!ternro & _
             " AND feriado.tipferinro = 2" & _
             " AND feriado.ferifecha >= " & ConvFecha(Desde) & _
             " AND feriado.ferifecha < " & ConvFecha(Hasta)
    OpenRecordset StrSql, rs_feriados
    
    Do While Not rs_feriados.EOF
        If Weekday(rs_feriados!ferifecha) > 1 Then
            DiasH = DiasH - 1
        End If
        
        ' Siguiente Feriado
        rs_feriados.MoveNext
    Loop
    
    
    ' cierro todo y libero
    If rs_pais.State = adStateOpen Then rs_pais.Close
    If rs_feriados.State = adStateOpen Then rs_feriados.Close
        
    Set rs_feriados = Nothing
    Set rs_pais = Nothing

End Sub


